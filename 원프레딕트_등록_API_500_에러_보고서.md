# ì›í”„ë ˆë”•íŠ¸ ë“±ë¡ API 500 ì—ëŸ¬ ë³´ê³ ì„œ

## ğŸ“‹ ë¬¸ì œ ê°œìš”

**ë°œìƒ ì¼ì‹œ**: 2026-01-28  
**ì—ëŸ¬ ìœ í˜•**: HTTP 500 Internal Server Error  
**API ì—”ë“œí¬ì¸íŠ¸**: `POST /api/public/event-survey/[campaignId]/register`  
**ì›¨ë¹„ë‚˜ ID**: `7cde90e7-a6db-4c42-8d72-572102f9fc5c` (ì›í”„ë ˆë”•íŠ¸ ì›¨ë¹„ë‚˜, slug: 426307)

## ğŸ”´ ì—ëŸ¬ ìƒì„¸

### í´ë¼ì´ì–¸íŠ¸ ì—ëŸ¬
```
POST http://localhost:3000/api/public/event-survey/7cde90e7-a6db-4c42-8d72-572102f9fc5c/register 500 (Internal Server Error)
```

### ë°œìƒ ìœ„ì¹˜
- **ì»´í¬ë„ŒíŠ¸**: `OnePredictRegistrationPage.tsx`
- **ë¼ì¸**: 245
- **í•¨ìˆ˜**: `handleRegistration`

### ë¸Œë¼ìš°ì € ì½˜ì†” ì—ëŸ¬
```
Unchecked runtime.lastError: The message port closed before a response was received.
```

## ğŸ” ë¬¸ì œ ë¶„ì„

### ìš”êµ¬ì‚¬í•­
1. ì›í”„ë ˆë”•íŠ¸ ì›¨ë¹„ë‚˜(`/426307`)ëŠ” ì›¨ë¹„ë‚˜ IDë¥¼ ì§ì ‘ `campaignId`ë¡œ ì‚¬ìš©
2. `event_survey_campaigns` í…Œì´ë¸”ì— ë³„ë„ ìº í˜ì¸ ì—†ì´ ì›¨ë¹„ë‚˜ë§Œ ì¡´ì¬
3. ë“±ë¡ ë°ì´í„°ëŠ” `registrations` í…Œì´ë¸”ì—ë§Œ ì €ì¥ (`event_survey_entries`ì—ëŠ” ì €ì¥í•˜ì§€ ì•ŠìŒ)
4. OnePredictRegistrationPageì˜ ëª¨ë“  í¼ í•„ë“œë¥¼ `registration_data` JSONBì— ì €ì¥

### êµ¬í˜„ëœ ë¡œì§
1. `campaignId`ê°€ ì›¨ë¹„ë‚˜ IDì¸ì§€ í™•ì¸ (`webinars` í…Œì´ë¸” ì¡°íšŒ)
2. ì›¨ë¹„ë‚˜ IDì¸ ê²½ìš°:
   - `email` í•„ìˆ˜ ê²€ì¦
   - `profiles` í…Œì´ë¸”ì—ì„œ ì‚¬ìš©ì ì¡°íšŒ
   - `registrations` í…Œì´ë¸”ì—ë§Œ ì €ì¥
   - `registration_data`ì— ëª¨ë“  í¼ ë°ì´í„° ì €ì¥

## ğŸ› ï¸ ì‹œë„í•œ í•´ê²° ë°©ë²•

### 1. ì›¨ë¹„ë‚˜ ID í™•ì¸ ë¡œì§ ê°œì„ 
- **ë³€ê²½ ì „**: `slug === '426307'` í•˜ë“œì½”ë”©
- **ë³€ê²½ í›„**: `campaignId`ê°€ ì›¨ë¹„ë‚˜ IDì¸ì§€ë§Œ í™•ì¸ (í•˜ë“œì½”ë”© ì œê±°)

### 2. í•„ìˆ˜ í•„ë“œ ê²€ì¦ ìˆœì„œ ë³€ê²½
- **ë³€ê²½ ì „**: `name`, `phone`, `phone_norm` í•„ìˆ˜ ê²€ì¦ í›„ ì›¨ë¹„ë‚˜ ID í™•ì¸
- **ë³€ê²½ í›„**: ì›¨ë¹„ë‚˜ ID í™•ì¸ í›„, ì›¨ë¹„ë‚˜ê°€ ì•„ë‹Œ ê²½ìš°ì—ë§Œ í•„ìˆ˜ í•„ë“œ ê²€ì¦

### 3. `name` ì•ˆì „ ì²˜ë¦¬
- **ë³€ê²½ ì „**: `name.trim()` ì§ì ‘ í˜¸ì¶œ
- **ë³€ê²½ í›„**: `name ? name.trim() || null : null` ì•ˆì „ ì²˜ë¦¬

### 4. `registration_data` ì²˜ë¦¬ ê°œì„ 
- **ë³€ê²½ ì „**: `registration_data` ê·¸ëŒ€ë¡œ ì €ì¥
- **ë³€ê²½ í›„**: 
  - `phone`, `phone_norm` ì •ë³´ ì¶”ê°€
  - ë¹ˆ ê°’ ì œê±° (ë°°ì—´, booleanì€ ìœ ì§€)
  - ì•ˆì „í•œ ê°ì²´ ì²˜ë¦¬

### 5. ì—ëŸ¬ ë¡œê¹… ê°•í™”
- ìƒì„¸í•œ ì—ëŸ¬ ì •ë³´ ì½˜ì†” ì¶œë ¥
- ë°ì´í„°ë² ì´ìŠ¤ ì—ëŸ¬ ì½”ë“œ, íŒíŠ¸, ë©”ì‹œì§€ í¬í•¨

## ğŸ¯ ê°€ëŠ¥í•œ ì›ì¸

### 1. ë°ì´í„°ë² ì´ìŠ¤ ì œì•½ ì¡°ê±´ ìœ„ë°˜
- `registrations` í…Œì´ë¸”ì˜ NOT NULL ì œì•½ ì¡°ê±´ ìœ„ë°˜ ê°€ëŠ¥ì„±
- ì™¸ë˜ í‚¤ ì œì•½ ì¡°ê±´ ìœ„ë°˜ ê°€ëŠ¥ì„± (`webinar_id`, `user_id`)

### 2. ë°ì´í„° íƒ€ì… ë¶ˆì¼ì¹˜
- `registration_data` JSONB í˜•ì‹ ì˜¤ë¥˜
- í•„ë“œ íƒ€ì… ë¶ˆì¼ì¹˜

### 3. ê¶Œí•œ ë¬¸ì œ
- Supabase Admin í´ë¼ì´ì–¸íŠ¸ ê¶Œí•œ ë¬¸ì œ
- RLS (Row Level Security) ì •ì±… ë¬¸ì œ

### 4. ë°ì´í„° ëˆ„ë½
- í•„ìˆ˜ í•„ë“œ ëˆ„ë½ (`email`, `user_id`, `webinar_id` ë“±)
- `registration_data`ê°€ ì˜ˆìƒê³¼ ë‹¤ë¥¸ í˜•ì‹

### 5. ë™ì‹œì„± ë¬¸ì œ
- ì¤‘ë³µ ë“±ë¡ ì²´í¬ ë¡œì§ ë¬¸ì œ
- íŠ¸ëœì­ì…˜ ì²˜ë¦¬ ë¬¸ì œ

## ğŸ“Š í˜„ì¬ ì½”ë“œ ìƒíƒœ

### ì£¼ìš” ë¡œì§ íë¦„
```typescript
1. campaignIdë¡œ ì›¨ë¹„ë‚˜ ì¡°íšŒ
2. ì›¨ë¹„ë‚˜ IDì¸ ê²½ìš° (isWebinarId = true):
   - email í•„ìˆ˜ ê²€ì¦
   - profilesì—ì„œ ì‚¬ìš©ì ì¡°íšŒ
   - ì¤‘ë³µ ë“±ë¡ ì²´í¬
   - registration_data ì •ë¦¬ ë° phone ì •ë³´ ì¶”ê°€
   - registrations í…Œì´ë¸”ì— ì €ì¥
```

### ì €ì¥ë˜ëŠ” ë°ì´í„° êµ¬ì¡°
```json
{
  "webinar_id": "7cde90e7-a6db-4c42-8d72-572102f9fc5c",
  "user_id": "<profile.id>",
  "role": "attendee",
  "nickname": "<name>",
  "registered_via": "registration_page",
  "registration_data": {
    "email": "...",
    "name": "...",
    "company": "...",
    "phone": "...",
    "phone_norm": "...",
    "position": "...",
    "industry": "...",
    "address": "...",
    "country": "...",
    "interestedProducts": [...],
    "message": "...",
    "phoneCountryCode": "+82",
    "privacyConsent": true,
    "consentEmail": false,
    "consentPhone": false
  }
}
```

## ğŸ”§ ë‹¤ìŒ ë‹¨ê³„ ì œì•ˆ

### 1. ì„œë²„ ë¡œê·¸ í™•ì¸ (ìµœìš°ì„ )
ì„œë²„ ì½˜ì†”(í„°ë¯¸ë„)ì—ì„œ ë‹¤ìŒ ë¡œê·¸ í™•ì¸:
- `[register] ë“±ë¡ ìš”ì²­ ì‹œì‘:`
- `[register] ìš”ì²­ ë°ì´í„°:`
- `[register] ì €ì¥í•  registration_data:`
- `[register] registrations ì €ì¥ ì˜¤ë¥˜:` (ì—ëŸ¬ ë°œìƒ ì‹œ)
- `[register] ì›¨ë¹„ë‚˜ ë“±ë¡ ì˜¤ë¥˜:` (ì˜ˆì™¸ ë°œìƒ ì‹œ)

### 2. ë°ì´í„°ë² ì´ìŠ¤ ì§ì ‘ í™•ì¸
```sql
-- ì›¨ë¹„ë‚˜ ì¡´ì¬ í™•ì¸
SELECT id, slug, title, access_policy 
FROM webinars 
WHERE id = '7cde90e7-a6db-4c42-8d72-572102f9fc5c';

-- registrations í…Œì´ë¸” ìŠ¤í‚¤ë§ˆ í™•ì¸
SELECT column_name, data_type, is_nullable, column_default
FROM information_schema.columns
WHERE table_schema = 'public' 
  AND table_name = 'registrations'
ORDER BY ordinal_position;

-- ì œì•½ ì¡°ê±´ í™•ì¸
SELECT conname, contype, pg_get_constraintdef(oid)
FROM pg_constraint
WHERE conrelid = 'registrations'::regclass;
```

### 3. í…ŒìŠ¤íŠ¸ ë°ì´í„°ë¡œ ì§ì ‘ í…ŒìŠ¤íŠ¸
```typescript
// ê°„ë‹¨í•œ í…ŒìŠ¤íŠ¸ ìš”ì²­
const testData = {
  name: "í…ŒìŠ¤íŠ¸",
  company: "í…ŒìŠ¤íŠ¸íšŒì‚¬",
  phone: "010-1234-5678",
  phone_norm: "01012345678",
  registration_data: {
    email: "test@example.com",
    name: "í…ŒìŠ¤íŠ¸",
    company: "í…ŒìŠ¤íŠ¸íšŒì‚¬"
  }
};
```

### 4. ë‹¨ê³„ë³„ ë””ë²„ê¹…
1. ì›¨ë¹„ë‚˜ ì¡°íšŒ ì„±ê³µ ì—¬ë¶€ í™•ì¸
2. ì‚¬ìš©ì í”„ë¡œí•„ ì¡°íšŒ ì„±ê³µ ì—¬ë¶€ í™•ì¸
3. `registration_data` ì •ë¦¬ ë¡œì§ í™•ì¸
4. ë°ì´í„°ë² ì´ìŠ¤ INSERT ì „ ë°ì´í„° í˜•ì‹ í™•ì¸

### 5. ì„ì‹œ í•´ê²°ì±…: ë” ìƒì„¸í•œ ì—ëŸ¬ ì‘ë‹µ
```typescript
// catch ë¸”ë¡ì—ì„œ ë” ìì„¸í•œ ì •ë³´ ë°˜í™˜
catch (error: any) {
  console.error('[register] ì›¨ë¹„ë‚˜ ë“±ë¡ ì˜¤ë¥˜:', {
    error,
    message: error?.message,
    stack: error?.stack,
    campaignId,
    registration_data,
    name,
    phone,
    phone_norm
  })
  
  // í´ë¼ì´ì–¸íŠ¸ì— ë” ìì„¸í•œ ì •ë³´ ë°˜í™˜ (ê°œë°œ í™˜ê²½ì—ì„œë§Œ)
  return NextResponse.json(
    { 
      error: error?.message || 'Internal server error',
      details: process.env.NODE_ENV === 'development' ? {
        stack: error?.stack,
        campaignId,
        hasRegistrationData: !!registration_data,
        hasName: !!name,
        hasPhone: !!phone
      } : undefined
    },
    { status: 500 }
  )
}
```

## ğŸ“ ê´€ë ¨ íŒŒì¼

- `app/api/public/event-survey/[campaignId]/register/route.ts` - API ë¼ìš°íŠ¸
- `app/event/[...path]/components/OnePredictRegistrationPage.tsx` - í´ë¼ì´ì–¸íŠ¸ ì»´í¬ë„ŒíŠ¸
- `supabase/migrations/073_add_registration_data_to_registrations.sql` - DB ë§ˆì´ê·¸ë ˆì´ì…˜

## ğŸ¯ ìš°ì„ ìˆœìœ„

1. **ë†’ìŒ**: ì„œë²„ ì½˜ì†” ë¡œê·¸ í™•ì¸í•˜ì—¬ ì •í™•í•œ ì—ëŸ¬ ë©”ì‹œì§€ íŒŒì•…
2. **ë†’ìŒ**: ë°ì´í„°ë² ì´ìŠ¤ ì œì•½ ì¡°ê±´ ë° ìŠ¤í‚¤ë§ˆ í™•ì¸
3. **ì¤‘ê°„**: ë‹¨ê³„ë³„ ë””ë²„ê¹…ìœ¼ë¡œ ì–´ëŠ ë‹¨ê³„ì—ì„œ ì‹¤íŒ¨í•˜ëŠ”ì§€ í™•ì¸
4. **ë‚®ìŒ**: ì„ì‹œ í•´ê²°ì±… ì ìš© (ë” ìƒì„¸í•œ ì—ëŸ¬ ì‘ë‹µ)

## ğŸ’¡ ì¶”ê°€ ê³ ë ¤ì‚¬í•­

1. **í™˜ê²½ ë³€ìˆ˜ í™•ì¸**: Supabase ì—°ê²° ì •ë³´ê°€ ì˜¬ë°”ë¥¸ì§€ í™•ì¸
2. **ë„¤íŠ¸ì›Œí¬ ë¬¸ì œ**: Supabase ì—°ê²° íƒ€ì„ì•„ì›ƒ ê°€ëŠ¥ì„±
3. **ë°ì´í„° í¬ê¸°**: `registration_data` JSONB í¬ê¸° ì œí•œ í™•ì¸
4. **ì¸ë±ìŠ¤ ë¬¸ì œ**: GIN ì¸ë±ìŠ¤ ìƒì„± ì—¬ë¶€ í™•ì¸

---

**ì‘ì„±ì¼**: 2026-01-28  
**ìƒíƒœ**: ì§„í–‰ ì¤‘ (ì„œë²„ ë¡œê·¸ í™•ì¸ í•„ìš”)
