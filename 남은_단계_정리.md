# 남은 단계 정리

## ✅ 완료된 작업

1. ✅ **RLS 정책 단순화 적용**
   - JWT 기반 슈퍼어드민 판정 함수 생성
   - messages 테이블 RLS 정책 단순화
   - registrations 테이블 인덱스 추가

---

## 🔴 우선순위 높음: 프론트엔드 Realtime 연결 안정성 개선

### 1. 재연결 로직 개선 (setTimeout cleanup) ⭐ **최우선**

**문제**: `setTimeout`이 cleanup되지 않아 메모리 누수 및 경쟁 상태 발생

**위치**: `components/webinar/Chat.tsx` (라인 787-815)

**수정 사항**:
- `reconnectTimeoutRef`, `fallbackReconnectTimeoutRef` 추가
- cleanup 함수에서 모든 타이머 취소
- `setTimeout` 내부에서 채널 정리 제거 (cleanup이 처리)

**예상 효과**: Realtime 연결 끊김 문제 해결

---

### 2. 기존 채널 정리 개선

**문제**: 비동기 처리로 인한 중복 구독 가능성

**위치**: `components/webinar/Chat.tsx` (라인 437-446)

**수정 사항**:
- `await`를 사용하여 기존 채널 정리 완료 대기
- 약간의 지연 추가 (100ms)

**예상 효과**: 중복 구독 방지

---

### 3. Chat 컴포넌트 중복 렌더링 방지

**문제**: 모바일/데스크톱에서 각각 Chat 컴포넌트가 렌더링되어 중복 구독 가능

**위치**: `app/(webinar)/webinar/[id]/components/WebinarView.tsx` (라인 727-791)

**수정 사항**:
- Chat 컴포넌트를 한 번만 렌더링하고 레이아웃만 변경
- 또는 `key` prop으로 인스턴스 분리

**예상 효과**: 중복 구독 방지

---

## 🟡 우선순위 중간: 테스트 및 모니터링

### 1. RLS 정책 변경 후 테스트

**확인 사항**:
- ✅ Realtime 연결 안정성 확인
- ✅ 메시지 전송 성능 확인
- ✅ 슈퍼어드민 메시지 관리 기능 확인
- ✅ 에러 로그 확인

**방법**:
- 실제 웨비나에서 테스트
- 브라우저 콘솔 로그 확인
- Supabase 로그 확인

---

### 2. JWT 함수 테스트

**확인 사항**:
- `jwt_is_super_admin()` 함수가 정상 작동하는지 확인
- 슈퍼어드민 권한 확인이 올바르게 동작하는지 확인

**방법**:
```sql
-- 슈퍼어드민으로 로그인한 후 테스트
SELECT public.jwt_is_super_admin();
```

---

## 🟢 우선순위 낮음: 추가 최적화

### 1. 클라이언트 관리자 권한 추가 (선택 사항)

**현재**: UPDATE/DELETE 정책에서 클라이언트 관리자 권한 제외

**필요 시 추가**:
```sql
-- UPDATE/DELETE 정책에 클라이언트 관리자 추가
using (
  user_id = auth.uid()
  or public.jwt_is_super_admin()
  or exists (
    select 1 from client_members cm
    where cm.user_id = auth.uid()
    and cm.client_id = messages.client_id
    and cm.role in ('owner', 'admin', 'operator')
  )
)
```

**주의**: 성능 고려 필요 (테이블 조회 추가)

---

## 📋 적용 순서 권장

### 1단계: 프론트엔드 Realtime 안정성 개선 (즉시)
1. 재연결 로직 개선 (setTimeout cleanup)
2. 기존 채널 정리 개선
3. Chat 컴포넌트 중복 렌더링 방지

### 2단계: 테스트 및 검증 (1-2일)
1. RLS 정책 변경 후 테스트
2. JWT 함수 테스트
3. 성능 모니터링

### 3단계: 추가 최적화 (선택)
1. 클라이언트 관리자 권한 추가 (필요 시)

---

## 🎯 기대 효과

### 프론트엔드 개선 후
- ✅ Realtime 연결 끊김 문제 해결
- ✅ 메모리 누수 방지
- ✅ 중복 구독 방지
- ✅ 안정적인 Realtime 연결 유지

### 전체 개선 후
- ✅ Realtime 성능 향상 (RLS 정책 단순화)
- ✅ 안정적인 연결 유지 (프론트엔드 개선)
- ✅ 빠른 메시지 전송 및 수신
- ✅ 사용자 경험 향상

---

## 📝 참고 문서

- `Realtime_연결_끊김_문제_분석_보고서.md`: 프론트엔드 문제 상세 분석
- `해결책_최종_검토_보고서.md`: RLS 정책 단순화 검토
- `해결책.md`: 원본 제안 문서

