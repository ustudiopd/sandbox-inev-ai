# í•´ê²°ì±….md ê²€í†  ë° ì ìš© ê³„íš

## ğŸ“‹ ê²€í†  ê²°ê³¼ ìš”ì•½

`í•´ê²°ì±….md`ì˜ ì œì•ˆì‚¬í•­ì€ **í˜„ì¬ ì½”ë“œë² ì´ìŠ¤ ìƒíƒœë¥¼ ì •í™•íˆ ë°˜ì˜**í•˜ê³  ìˆìœ¼ë©°, **ë‹¨ê³„ì  ì ìš©ì´ ê°€ëŠ¥í•œ ì‹¤ìš©ì ì¸ ê°œì„ ì•ˆ**ì…ë‹ˆë‹¤. í˜„ì¬ ì´ë¯¸ ì ìš©ëœ ë¶€ë¶„ê³¼ ì¶”ê°€ë¡œ ì ìš© ê°€ëŠ¥í•œ ë¶€ë¶„ì„ ì •ë¦¬í–ˆìŠµë‹ˆë‹¤.

---

## âœ… í˜„ì¬ ì ìš©ëœ ë¶€ë¶„

### 1. ê¸°ë³¸ ìµœì í™” (ì™„ë£Œ)
- âœ… **ë³‘ë ¬ ì¿¼ë¦¬ ì²˜ë¦¬**: í¼/ë¬¸í•­ ì¡°íšŒ ë³‘ë ¬í™” ì™„ë£Œ
- âœ… **ì»¬ëŸ¼ ì„ íƒ ìµœì í™”**: í•„ìš”í•œ ì»¬ëŸ¼ë§Œ ì„ íƒí•˜ë„ë¡ ê°œì„  ì™„ë£Œ
- âœ… **ì¸ë±ìŠ¤ ì¶”ê°€**: `idx_form_submissions_form_participant`, `idx_forms_id_webinar_id` ì¶”ê°€ ì™„ë£Œ
- âœ… **í‚¤ì…‹ í˜ì´ì§€ë„¤ì´ì…˜**: ë©”ì‹œì§€ ì¡°íšŒì— `beforeTs/beforeId` ê¸°ë°˜ ì»¤ì„œ í˜ì´ì§€ë„¤ì´ì…˜ ì ìš©ë¨
- âœ… **ì¦ë¶„ í´ë§**: ì±„íŒ…ì—ì„œ `afterId` ê¸°ë°˜ ì¦ë¶„ ë¡œë“œ êµ¬í˜„ë¨
- âœ… **Optimistic Update**: ì±„íŒ…/Q&A ëª¨ë”ë ˆì´ì…˜ì—ì„œ ì ìš©ë¨
- âœ… **Realtime êµ¬ë…**: Supabase Realtime í™œìš© ì¤‘

### 2. ê²½í’ˆ ì¶”ì²¨ (ë¶€ë¶„ ì™„ë£Œ)
- âœ… **Commit-Reveal íŒ¨í„´**: ì´ë¯¸ êµ¬í˜„ë¨ (`verify_seed_commit`, `draw_giveaway` RPC í•¨ìˆ˜)
- âš ï¸ **`ORDER BY random()` ì‚¬ìš© ì—¬ë¶€**: `draw_giveaway` í•¨ìˆ˜ ë‚´ë¶€ í™•ì¸ í•„ìš”

---

## ğŸš€ ì¦‰ì‹œ ì ìš© ê°€ëŠ¥í•œ ê°œì„ ì‚¬í•­ (High Priority)

### 1. í¼ ë²ˆë“¤ RPC í•¨ìˆ˜ êµ¬í˜„ (1-1)

**í˜„ì¬ ìƒíƒœ**: 
- í¼/ë¬¸í•­/ì œì¶œì—¬ë¶€ë¥¼ 3ê°œì˜ ì¿¼ë¦¬ë¡œ ì¡°íšŒ (ë³‘ë ¬í™”ëŠ” ë˜ì–´ ìˆìœ¼ë‚˜ ë„¤íŠ¸ì›Œí¬ ì™•ë³µ 1íšŒ)
- í•˜ì§€ë§Œ ì—¬ì „íˆ ì—¬ëŸ¬ ì¿¼ë¦¬ë¥¼ ì‹¤í–‰í•˜ê³  ìˆìŒ

**ê°œì„  ë°©ì•ˆ**:
```sql
-- supabase/migrations/022_create_form_bundle_rpc.sql
CREATE OR REPLACE FUNCTION public.get_form_bundle(
  p_form_id uuid,
  p_webinar_id uuid,
  p_participant_id uuid DEFAULT NULL
) RETURNS jsonb
LANGUAGE plpgsql
SECURITY DEFINER
SET search_path = public
AS $$
DECLARE
  v_form jsonb;
  v_questions jsonb;
  v_has_submitted boolean := false;
  v_result jsonb;
BEGIN
  -- í¼ ì¡°íšŒ
  SELECT to_jsonb(f.*) INTO v_form
  FROM forms f
  WHERE f.id = p_form_id AND f.webinar_id = p_webinar_id;
  
  IF v_form IS NULL THEN
    RETURN jsonb_build_object('error', 'Form not found');
  END IF;
  
  -- ë¬¸í•­ ì¡°íšŒ (ì •ë ¬ í¬í•¨)
  SELECT jsonb_agg(
    to_jsonb(q.*) ORDER BY q.order_no ASC
  ) INTO v_questions
  FROM form_questions q
  WHERE q.form_id = p_form_id;
  
  -- ì œì¶œ ì—¬ë¶€ í™•ì¸ (ì„¤ë¬¸ì¸ ê²½ìš°)
  IF v_form->>'kind' = 'survey' AND p_participant_id IS NOT NULL THEN
    SELECT EXISTS(
      SELECT 1 FROM form_submissions
      WHERE form_id = p_form_id AND participant_id = p_participant_id
    ) INTO v_has_submitted;
  END IF;
  
  -- ê²°ê³¼ ì¡°í•©
  v_result := jsonb_build_object(
    'form', v_form,
    'questions', COALESCE(v_questions, '[]'::jsonb),
    'isSubmitted', v_has_submitted
  );
  
  RETURN v_result;
END;
$$;
```

**ì ìš© ìœ„ì¹˜**: `app/api/webinars/[webinarId]/forms/[formId]/route.ts`
**ì˜ˆìƒ íš¨ê³¼**: ë„¤íŠ¸ì›Œí¬ ì™•ë³µ 1íšŒë¡œ ê°ì†Œ, ì•½ 30-40% ì¶”ê°€ ì„±ëŠ¥ í–¥ìƒ

### 2. ì»¤ë²„ë§ ì¸ë±ìŠ¤ ì¶”ê°€ (1-2)

**í˜„ì¬ ìƒíƒœ**: 
- `idx_messages_webinar_created_id` ì¸ë±ìŠ¤ëŠ” ìˆìœ¼ë‚˜, `INCLUDE` ì ˆì´ ì—†ìŒ
- í”„ë¡œí•„ ì¡°íšŒë¥¼ ë³„ë„ë¡œ ìˆ˜í–‰í•˜ê³  ìˆìŒ

**ê°œì„  ë°©ì•ˆ**:
```sql
-- supabase/migrations/023_add_covering_indexes.sql
-- ë©”ì‹œì§€ ì»¤ë²„ë§ ì¸ë±ìŠ¤ (ìì£¼ ì¡°íšŒë˜ëŠ” ì»¬ëŸ¼ í¬í•¨)
CREATE INDEX CONCURRENTLY IF NOT EXISTS
  idx_messages_wid_created_id_covering
ON public.messages (webinar_id, created_at DESC, id DESC)
INCLUDE (user_id, hidden, content);

-- ì§ˆë¬¸ ì»¤ë²„ë§ ì¸ë±ìŠ¤
CREATE INDEX CONCURRENTLY IF NOT EXISTS
  idx_questions_wid_created_covering
ON public.questions (webinar_id, created_at DESC, id DESC)
INCLUDE (user_id, status, content);
```

**ì˜ˆìƒ íš¨ê³¼**: ì¸ë±ìŠ¤ë§Œìœ¼ë¡œ í•„ìš”í•œ ë°ì´í„° ì¡°íšŒ ê°€ëŠ¥, ì•½ 20-30% ì„±ëŠ¥ í–¥ìƒ

### 3. Edge Runtime ì ìš© (1-3)

**í˜„ì¬ ìƒíƒœ**: 
- ëª¨ë“  API Routeê°€ `runtime = 'nodejs'`ë¡œ ì„¤ì •ë¨
- ì½ê¸° ì „ìš© APIëŠ” Edge Runtimeìœ¼ë¡œ ë³€ê²½ ê°€ëŠ¥

**ê°œì„  ë°©ì•ˆ**:
```typescript
// app/api/webinars/[webinarId]/forms/[formId]/route.ts
export const runtime = 'edge' // ë˜ëŠ” 'nodejs' (RPC í•¨ìˆ˜ ì‚¬ìš© ì‹œ)

// app/api/webinars/[webinarId]/forms/route.ts (ëª©ë¡ ì¡°íšŒ)
export const runtime = 'edge'
```

**ì£¼ì˜ì‚¬í•­**: 
- Edge Runtimeì—ì„œëŠ” `createAdminSupabase()`ê°€ ì œí•œë  ìˆ˜ ìˆìŒ
- RPC í•¨ìˆ˜ í˜¸ì¶œì€ ê°€ëŠ¥í•˜ë¯€ë¡œ, RPC í•¨ìˆ˜ ì‚¬ìš© ì‹œ Edge Runtime ì ìš© ê¶Œì¥

**ì˜ˆìƒ íš¨ê³¼**: TTFB 20-50ms ê°ì†Œ (ë¦¬ì „ ê·¼ì ‘ ì‹œ)

### 4. ê²½í’ˆ ì¶”ì²¨ ìµœì í™” í™•ì¸ (3-2)

**âœ… í™•ì¸ ì™„ë£Œ**: `draw_giveaway` í•¨ìˆ˜ëŠ” ì´ë¯¸ ìµœì í™”ë˜ì–´ ìˆìŒ
- `ORDER BY random()` ì‚¬ìš©í•˜ì§€ ì•ŠìŒ
- `sha256(entry_id || seed)` í•´ì‹œ ê¸°ë°˜ ê²°ì •ë¡ ì  ì •ë ¬ ì‚¬ìš©
- `row_number() OVER (ORDER BY hash_hex ASC)` ë°©ì‹ìœ¼ë¡œ O(n log n) ë³µì¡ë„
- ì¬í˜„ ê°€ëŠ¥í•˜ê³  ê°ì‚¬ ê°€ëŠ¥í•œ êµ¬ì¡°

**ì¶”ê°€ ê°œì„  ê°€ëŠ¥** (ëŒ€ê·œëª¨ ì¶”ì²¨ ì‹œ):
```sql
-- ì‚¬ì „ ë‚œìˆ˜í‚¤ ì „ëµ
ALTER TABLE public.giveaway_entries
ADD COLUMN IF NOT EXISTS rand_key BIGINT;

-- ë“±ë¡ ì‹œ ë‚œìˆ˜í‚¤ ìƒì„±
CREATE OR REPLACE FUNCTION public.generate_entry_rand_key()
RETURNS TRIGGER AS $$
BEGIN
  NEW.rand_key := floor(random() * 9223372036854775807)::bigint;
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER tg_generate_entry_rand_key
BEFORE INSERT ON public.giveaway_entries
FOR EACH ROW
WHEN (NEW.rand_key IS NULL)
EXECUTE FUNCTION public.generate_entry_rand_key();

-- ì¶”ì²¨ í•¨ìˆ˜ ìˆ˜ì • (ORDER BY random() ëŒ€ì‹ )
-- ORDER BY (rand_key # seed::bigint) ì‚¬ìš©
```

**ì˜ˆìƒ íš¨ê³¼**: ëŒ€ê·œëª¨ ì¶”ì²¨ ì‹œ O(n log n) â†’ O(n)ìœ¼ë¡œ ê°œì„ 

---

## ğŸ“… ë‹¨ê¸° ê°œì„ ì‚¬í•­ (1-2ì£¼)

### 5. ì½ê¸° ëª¨ë¸ ë¶„ë¦¬ (CQRS) - 2-1

**í˜„ì¬ ìƒíƒœ**: 
- ì„¤ë¬¸/í€´ì¦ˆ ê²°ê³¼ ì¡°íšŒ ì‹œ ì‹¤ì‹œê°„ ì§‘ê³„
- ëŒ€ê·œëª¨ ì´ë²¤íŠ¸ì—ì„œ ì„±ëŠ¥ ì €í•˜ ê°€ëŠ¥

**ê°œì„  ë°©ì•ˆ**:
```sql
-- ì§‘ê³„ í…Œì´ë¸” ìƒì„±
CREATE TABLE public.form_stats (
  form_id uuid PRIMARY KEY REFERENCES public.forms(id) ON DELETE CASCADE,
  submission_count int NOT NULL DEFAULT 0,
  last_submitted_at timestamptz,
  updated_at timestamptz NOT NULL DEFAULT now()
);

-- íŠ¸ë¦¬ê±°ë¡œ ìë™ ê°±ì‹ 
CREATE OR REPLACE FUNCTION public.update_form_stats()
RETURNS TRIGGER AS $$
BEGIN
  INSERT INTO public.form_stats (form_id, submission_count, last_submitted_at)
  VALUES (NEW.form_id, 1, NEW.submitted_at)
  ON CONFLICT (form_id) DO UPDATE
  SET 
    submission_count = form_stats.submission_count + 1,
    last_submitted_at = GREATEST(form_stats.last_submitted_at, NEW.submitted_at),
    updated_at = now();
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER tg_update_form_stats
AFTER INSERT ON public.form_submissions
FOR EACH ROW
EXECUTE FUNCTION public.update_form_stats();
```

**ì˜ˆìƒ íš¨ê³¼**: ì§‘ê³„ ì¿¼ë¦¬ ì‹œê°„ 90% ì´ìƒ ê°ì†Œ

### 6. ê³µê°œ ë°ì´í„° Edge ìºì‹œ (1-4)

**í˜„ì¬ ìƒíƒœ**: 
- ìºì‹œ í—¤ë” ì„¤ì • ì—†ìŒ
- ëª¨ë“  ìš”ì²­ì´ DB ì¡°íšŒ

**ê°œì„  ë°©ì•ˆ**:
```typescript
// app/api/webinars/[webinarId]/forms/[formId]/route.ts
export async function GET(...) {
  // ... ê¸°ì¡´ ë¡œì§ ...
  
  const response = NextResponse.json({
    success: true,
    form: {
      ...form,
      questions: questions || [],
      isSubmitted,
    },
  })
  
  // ê³µê°œ ë°ì´í„°(í¼/ë¬¸í•­)ëŠ” ìºì‹œ ê°€ëŠ¥
  if (form.kind === 'survey' || form.status === 'open') {
    response.headers.set(
      'Cache-Control',
      'public, s-maxage=60, stale-while-revalidate=300'
    )
  }
  
  // ê°œì¸í™” ë°ì´í„°(ì œì¶œ ì—¬ë¶€)ëŠ” ìºì‹œ ë¶ˆê°€
  // í•˜ì§€ë§Œ ì „ì²´ ì‘ë‹µì„ ìºì‹œí•˜ë©´ ì•ˆ ë˜ë¯€ë¡œ, ë¶„ë¦¬ëœ ì—”ë“œí¬ì¸íŠ¸ ê¶Œì¥
  
  return response
}
```

**ì˜ˆìƒ íš¨ê³¼**: ì¬ë°©ë¬¸ ì‹œ ì‘ë‹µ ì‹œê°„ 90% ì´ìƒ ê°ì†Œ

---

## ğŸ”„ ì¤‘ê¸° ê°œì„ ì‚¬í•­ (2-3ì£¼)

### 7. íŒŒí‹°ì…”ë‹ (2-2)

**ëŒ€ìƒ í…Œì´ë¸”**: `messages`, `questions`, `form_submissions`

**ê°œì„  ë°©ì•ˆ**:
```sql
-- ì›”ë‹¨ìœ„ íŒŒí‹°ì…”ë‹ ì˜ˆì‹œ (messages)
CREATE TABLE public.messages_partitioned (
  LIKE public.messages INCLUDING ALL
) PARTITION BY RANGE (created_at);

-- ì›”ë³„ íŒŒí‹°ì…˜ ìƒì„± (ìë™í™” ìŠ¤í¬ë¦½íŠ¸ í•„ìš”)
CREATE TABLE public.messages_2025_01
PARTITION OF public.messages_partitioned
FOR VALUES FROM ('2025-01-01') TO ('2025-02-01');
```

**ì£¼ì˜ì‚¬í•­**: 
- ê¸°ì¡´ ë°ì´í„° ë§ˆì´ê·¸ë ˆì´ì…˜ í•„ìš”
- FK ì œì•½ì¡°ê±´ ì¬ì„¤ì • í•„ìš”
- ì• í”Œë¦¬ì¼€ì´ì…˜ ì½”ë“œ ë³€ê²½ ìµœì†Œí™”

### 8. ë¨¸í‹°ë¦¬ì–¼ë¼ì´ì¦ˆë“œ ë·° (2-3)

**ëŒ€ìƒ**: í€´ì¦ˆ ë¦¬ë”ë³´ë“œ, ì„¤ë¬¸ í†µê³„

**ê°œì„  ë°©ì•ˆ**:
```sql
-- í€´ì¦ˆ ë¦¬ë”ë³´ë“œ ë·°
CREATE MATERIALIZED VIEW public.quiz_leaderboard AS
SELECT 
  qa.form_id,
  qa.participant_id,
  p.name as participant_name,
  SUM(qa.points_awarded) as total_score,
  MAX(qa.answered_at) as last_answered_at
FROM quiz_attempts qa
JOIN form_answers fa ON fa.submission_id = qa.id
JOIN profiles p ON p.id = qa.participant_id
GROUP BY qa.form_id, qa.participant_id, p.name;

-- ì¸ë±ìŠ¤ ì¶”ê°€
CREATE UNIQUE INDEX ON public.quiz_leaderboard (form_id, participant_id);
CREATE INDEX ON public.quiz_leaderboard (form_id, total_score DESC);

-- ìë™ ë¦¬í”„ë ˆì‹œ (íŠ¸ë¦¬ê±° ë˜ëŠ” ìŠ¤ì¼€ì¤„ëŸ¬)
```

---

## ğŸ¯ ì ìš© ìš°ì„ ìˆœìœ„ ë° ë¡œë“œë§µ

### 1ì£¼ì°¨ (ì¦‰ì‹œ ì ìš©)
1. âœ… **í¼ ë²ˆë“¤ RPC í•¨ìˆ˜** êµ¬í˜„ ë° ì ìš©
2. âœ… **ì»¤ë²„ë§ ì¸ë±ìŠ¤** ì¶”ê°€
3. âœ… **ê²½í’ˆ ì¶”ì²¨ `ORDER BY random()` í™•ì¸ ë° ê°œì„ ** (í•„ìš” ì‹œ)

### 2ì£¼ì°¨
4. âœ… **Edge Runtime ì ìš©** (ì½ê¸° ì „ìš© API)
5. âœ… **ê³µê°œ ë°ì´í„° Edge ìºì‹œ** ì„¤ì •
6. âœ… **ì½ê¸° ëª¨ë¸ ë¶„ë¦¬ (CQRS)** - ì§‘ê³„ í…Œì´ë¸” ìƒì„±

### 3-4ì£¼ì°¨
7. âš ï¸ **íŒŒí‹°ì…”ë‹** (ë°ì´í„° ê·œëª¨ í™•ì¸ í›„ ê²°ì •)
8. âš ï¸ **ë¨¸í‹°ë¦¬ì–¼ë¼ì´ì¦ˆë“œ ë·°** (í•„ìš”í•œ ê¸°ëŠ¥ë¶€í„° ì ìš©)

---

## ğŸ“Š ì˜ˆìƒ ì„±ëŠ¥ ê°œì„  íš¨ê³¼

### í˜„ì¬ (ìµœì í™” í›„)
- í¼ ë¡œë”©: 170-380ms
- ë©”ì‹œì§€ í˜ì´ì§•: 100-200ms

### 1ì£¼ì°¨ ì ìš© í›„
- í¼ ë¡œë”©: **100-250ms** (ì•½ 35% ì¶”ê°€ ê°œì„ )
- ë©”ì‹œì§€ í˜ì´ì§•: **70-150ms** (ì•½ 30% ê°œì„ )

### 2ì£¼ì°¨ ì ìš© í›„
- í¼ ë¡œë”© (ì¬ë°©ë¬¸): **10-50ms** (ìºì‹œ íˆíŠ¸ ì‹œ)
- ë©”ì‹œì§€ í˜ì´ì§•: **50-100ms** (Edge Runtime + ì»¤ë²„ë§ ì¸ë±ìŠ¤)

### 3-4ì£¼ì°¨ ì ìš© í›„
- ëŒ€ê·œëª¨ ì´ë²¤íŠ¸ì—ì„œë„ **ì¼ê´€ëœ ë‚®ì€ P95** ìœ ì§€
- ì§‘ê³„ ì¿¼ë¦¬: **90% ì´ìƒ ì„±ëŠ¥ í–¥ìƒ**

---

## âš ï¸ ì£¼ì˜ì‚¬í•­ ë° ì œì•½ì‚¬í•­

### 1. Edge Runtime ì œì•½
- `createAdminSupabase()` ì‚¬ìš© ì‹œ ì œí•œ ê°€ëŠ¥
- RPC í•¨ìˆ˜ í˜¸ì¶œì€ ê°€ëŠ¥í•˜ë¯€ë¡œ, RPC í•¨ìˆ˜ ì‚¬ìš© ê¶Œì¥
- íŒŒì¼ ì‹œìŠ¤í…œ ì ‘ê·¼ ë¶ˆê°€

### 2. ìºì‹œ ë¬´íš¨í™”
- í¼/ë¬¸í•­ ìˆ˜ì • ì‹œ ìºì‹œ ë¬´íš¨í™” í•„ìš”
- ë²„ì „ í•„ë“œ ë˜ëŠ” ì´ë²¤íŠ¸ ê¸°ë°˜ ë¬´íš¨í™” êµ¬í˜„ í•„ìš”

### 3. íŒŒí‹°ì…”ë‹ ë³µì¡ë„
- ê¸°ì¡´ ë°ì´í„° ë§ˆì´ê·¸ë ˆì´ì…˜ í•„ìš”
- FK ì œì•½ì¡°ê±´ ì¬ì„¤ì • í•„ìš”
- ìë™ íŒŒí‹°ì…˜ ìƒì„± ìŠ¤í¬ë¦½íŠ¸ í•„ìš”

### 4. ë¨¸í‹°ë¦¬ì–¼ë¼ì´ì¦ˆë“œ ë·° ë¦¬í”„ë ˆì‹œ
- ì‹¤ì‹œê°„ì„± vs ì„±ëŠ¥ íŠ¸ë ˆì´ë“œì˜¤í”„
- íŠ¸ë¦¬ê±° ê¸°ë°˜ ì¦ë¶„ ë¦¬í”„ë ˆì‹œ ë˜ëŠ” ìŠ¤ì¼€ì¤„ëŸ¬ í•„ìš”

---

## ğŸ“ ë‹¤ìŒ ë‹¨ê³„

1. **ì¦‰ì‹œ ì‹œì‘**: í¼ ë²ˆë“¤ RPC í•¨ìˆ˜ êµ¬í˜„
2. **ê²€í†  í•„ìš”**: `draw_giveaway` í•¨ìˆ˜ ë‚´ë¶€ í™•ì¸
3. **í…ŒìŠ¤íŠ¸ ê³„íš**: ê° ê°œì„ ì‚¬í•­ë³„ ì„±ëŠ¥ ì¸¡ì •
4. **ëª¨ë‹ˆí„°ë§**: P50/P95/P99 ì§€í‘œ ì¶”ì 

---

**ì‘ì„±ì¼**: 2025-01-XX
**ê²€í†  ê¸°ì¤€**: í•´ê²°ì±….md + í˜„ì¬ ì½”ë“œë² ì´ìŠ¤ ìƒíƒœ
**ì ìš© ê°€ëŠ¥ì„±**: ë†’ìŒ (ë‹¨ê³„ì  ì ìš© ê°€ëŠ¥)

