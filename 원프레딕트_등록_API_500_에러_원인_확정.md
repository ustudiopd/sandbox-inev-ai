# ì›í”„ë ˆë”•íŠ¸ ë“±ë¡ API 500 ì—ëŸ¬ ì›ì¸ í™•ì • ë³´ê³ ì„œ

## ğŸ¯ ì›ì¸ í™•ì •

**ì—ëŸ¬ ì›ì¸**: `registrations.registered_via` CHECK ì œì•½ ì¡°ê±´ ìœ„ë°˜

### ë¬¸ì œ ìƒì„¸

#### DB ì œì•½ ì¡°ê±´
```sql
CHECK (registered_via = ANY (ARRAY['email'::text, 'manual'::text, 'invite'::text]))
```

**í—ˆìš©ë˜ëŠ” ê°’**: `'email'`, `'manual'`, `'invite'` **3ê°œë§Œ**

#### í˜„ì¬ ì½”ë“œì—ì„œ ì‚¬ìš©í•˜ëŠ” ê°’
```typescript
registered_via: 'registration_page'  // âŒ ì œì•½ ì¡°ê±´ ìœ„ë°˜!
```

### registrations í…Œì´ë¸” ìŠ¤í‚¤ë§ˆ í™•ì¸ ê²°ê³¼

| ì»¬ëŸ¼ëª… | íƒ€ì… | NULL í—ˆìš© | ê¸°ë³¸ê°’ | ì œì•½ ì¡°ê±´ |
|--------|------|-----------|--------|-----------|
| `webinar_id` | uuid | âŒ NO | - | FK â†’ webinars(id), PK ì¼ë¶€ |
| `user_id` | uuid | âŒ NO | - | FK â†’ profiles(id), PK ì¼ë¶€ |
| `role` | text | âŒ NO | `'attendee'` | CHECK: 'attendee', 'host', 'moderator', 'ê´€ë¦¬ì', 'ìš´ì˜ì', 'ë¶„ì„ê°€' |
| `created_at` | timestamptz | âœ… YES | `now()` | - |
| `nickname` | text | âœ… YES | - | - |
| `registered_via` | text | âœ… YES | `'manual'` | **CHECK: 'email', 'manual', 'invite'ë§Œ í—ˆìš©** |
| `registration_data` | jsonb | âœ… YES | - | - |

### ì œì•½ ì¡°ê±´ ì „ì²´ ëª©ë¡

1. **PRIMARY KEY**: `(webinar_id, user_id)`
2. **registered_via CHECK**: `'email'`, `'manual'`, `'invite'`ë§Œ í—ˆìš©
3. **role CHECK**: `'attendee'`, `'host'`, `'moderator'`, `'ê´€ë¦¬ì'`, `'ìš´ì˜ì'`, `'ë¶„ì„ê°€'`ë§Œ í—ˆìš©
4. **FK user_id**: `profiles(id)` ì°¸ì¡°
5. **FK webinar_id**: `webinars(id)` ì°¸ì¡°

## âœ… í™•ì¸ ì™„ë£Œëœ ì‚¬í•­

### 1. NOT NULL + DEFAULT ì—†ëŠ” ì»¬ëŸ¼
- âŒ **ì—†ìŒ** - ëª¨ë“  í•„ìˆ˜ ì»¬ëŸ¼ì— ê¸°ë³¸ê°’ ë˜ëŠ” nullable ì„¤ì •ë¨
- `role`: DEFAULT `'attendee'` âœ…
- `registered_via`: DEFAULT `'manual'` âœ…
- `created_at`: DEFAULT `now()` âœ…

### 2. FK/RLS í†µê³¼
- `user_id` â†’ `profiles(id)`: FK ì¡´ì¬, í†µê³¼ ê°€ëŠ¥ âœ…
- `webinar_id` â†’ `webinars(id)`: FK ì¡´ì¬, í†µê³¼ ê°€ëŠ¥ âœ…
- ì›¨ë¹„ë‚˜ ì¡´ì¬ í™•ì¸: `7cde90e7-a6db-4c42-8d72-572102f9fc5c` âœ…

### 3. ì¤‘ë³µ ë“±ë¡ ì²´í¬
- PRIMARY KEY: `(webinar_id, user_id)` - ì •ìƒ ë™ì‘ âœ…

## ğŸ”§ í•´ê²° ë°©ë²•

### ì˜µì…˜ 1: `registered_via` ê°’ì„ í—ˆìš©ëœ ê°’ìœ¼ë¡œ ë³€ê²½ (ê¶Œì¥)

**ë³€ê²½ ì „**:
```typescript
registered_via: 'registration_page'
```

**ë³€ê²½ í›„** (ì˜µì…˜ A - 'manual' ì‚¬ìš©):
```typescript
registered_via: 'manual'
```

**ë³€ê²½ í›„** (ì˜µì…˜ B - 'email' ì‚¬ìš©):
```typescript
registered_via: 'email'  // ì´ë©”ì¼ ê¸°ë°˜ ë“±ë¡ í˜ì´ì§€ì´ë¯€ë¡œ
```

### ì˜µì…˜ 2: DB ì œì•½ ì¡°ê±´ í™•ì¥ (ë¹„ê¶Œì¥)

```sql
ALTER TABLE registrations
DROP CONSTRAINT registrations_registered_via_check;

ALTER TABLE registrations
ADD CONSTRAINT registrations_registered_via_check
CHECK (registered_via = ANY (ARRAY['email'::text, 'manual'::text, 'invite'::text, 'registration_page'::text]));
```

**ë¹„ê¶Œì¥ ì´ìœ **: 
- ê¸°ì¡´ ë°ì´í„°ì™€ì˜ í˜¸í™˜ì„± ë¬¸ì œ ê°€ëŠ¥
- ë‹¤ë¥¸ ê³³ì—ì„œë„ ë™ì¼í•œ ì œì•½ ì¡°ê±´ ì‚¬ìš© ê°€ëŠ¥ì„±
- ë‹¨ìˆœíˆ ì½”ë“œ ìˆ˜ì •ìœ¼ë¡œ í•´ê²° ê°€ëŠ¥

## ğŸ“‹ ìˆ˜ì • ëŒ€ìƒ íŒŒì¼

1. `app/api/public/event-survey/[campaignId]/register/route.ts`
   - ì›¨ë¹„ë‚˜ IDì¸ ê²½ìš°: `registered_via: 'registration_page'` â†’ `'manual'` ë˜ëŠ” `'email'`
   - ì›í”„ë ˆë”•íŠ¸ ì›¨ë¹„ë‚˜ì¸ ê²½ìš°: ë™ì¼í•˜ê²Œ ìˆ˜ì •

## ğŸ¯ ê¶Œì¥ ìˆ˜ì • ë°©í–¥

**`'manual'` ì‚¬ìš© ê¶Œì¥**:
- ë“±ë¡ í˜ì´ì§€ë¥¼ í†µí•œ ë“±ë¡ì€ "ìˆ˜ë™ ë“±ë¡"ì˜ ë²”ì£¼ì— í¬í•¨
- ê¸°ì¡´ ê¸°ë³¸ê°’ê³¼ ì¼ì¹˜
- ì˜ë¯¸ì ìœ¼ë¡œ ì í•©

**ìˆ˜ì • ìœ„ì¹˜**:
- ë¼ì¸ ~220: ì›¨ë¹„ë‚˜ IDì¸ ê²½ìš°
- ë¼ì¸ ~378: ì›í”„ë ˆë”•íŠ¸ ì›¨ë¹„ë‚˜ì¸ ê²½ìš°

## âœ… DoD (Definition of Done)

- [x] DB ì œì•½ ì¡°ê±´ í™•ì¸ ì™„ë£Œ
- [x] ì›ì¸ í™•ì •: `registered_via` CHECK ì œì•½ ìœ„ë°˜
- [ ] ì½”ë“œ ìˆ˜ì •: `'registration_page'` â†’ `'manual'` ë˜ëŠ” `'email'`
- [ ] í…ŒìŠ¤íŠ¸: ë“±ë¡ ì„±ê³µ í™•ì¸
- [ ] ì„œë²„ ë¡œê·¸ í™•ì¸: ì—ëŸ¬ ì—†ìŒ í™•ì¸

---

**í™•ì¸ ì¼ì‹œ**: 2026-01-28  
**í™•ì¸ ë°©ë²•**: Supabase MCPë¥¼ í†µí•œ ì§ì ‘ DB ì¿¼ë¦¬  
**ìƒíƒœ**: ì›ì¸ í™•ì • ì™„ë£Œ, ì½”ë“œ ìˆ˜ì • ëŒ€ê¸°
