# 웨비나 6자리 슬러그 보안 정책

**작성일**: 2026-01-14  
**상태**: 확정

---

## 결정 포인트 A: 6자리 슬러그의 보안 의미

### 선택된 정책: **슬러그는 식별자일 뿐, 접근 정책은 별개**

6자리 숫자 슬러그(예: `884372`)는 웨비나를 식별하는 **URL 친화적인 식별자**일 뿐이며, **접근 권한을 결정하지 않습니다**.

---

## 보안 모델

### 1. 슬러그의 역할

- **목적**: UUID 대신 사용자 친화적인 URL 제공
- **예시**: `/webinar/884372` (UUID 대신)
- **특성**: 
  - 6자리 숫자 (100000 ~ 999999)
  - 추측 가능 (브루트포스 위험)
  - 고유성 보장 (DB 제약 조건)

### 2. 접근 정책 (Access Policy)

웨비나의 실제 접근 제어는 `webinars.access_policy` 필드로 결정됩니다:

- `auth`: 로그인 필수
- `email_auth`: 등록된 이메일만 접근 가능
- `guest_allowed`: 게스트 허용 (미구현)
- `invite_only`: 초대 전용 (미구현)

### 3. RLS (Row Level Security) 정책

Supabase RLS 정책에 따라 웨비나 조회는 다음 조건 중 하나를 만족해야 합니다:

1. 슈퍼어드민
2. 소속 에이전시/클라이언트 멤버
3. 웨비나 등록자
4. `is_public = true AND access_policy = 'guest_allowed'`

---

## 구현 패턴

### 서버 사이드 (SSR)

```typescript
// app/(webinar)/webinar/[id]/page.tsx
const admin = createAdminSupabase() // Service Role Key 사용 → RLS 우회

// Admin Supabase로 조회 (RLS 우회)
const { data: webinar } = await admin
  .from('webinars')
  .select('id, slug, title, ...')
  .eq('slug', slug)
  .single()

// 결정 포인트 A: Admin으로 조회했으므로 RLS 우회됨
// 실제 접근 제어는 클라이언트 컴포넌트에서 access_policy에 따라 처리
return <WebinarEntry webinar={webinarData} />
```

**중요 사항**:
- Admin Supabase는 **서버 전용** (절대 클라이언트 번들에 포함 금지)
- Service Role Key를 사용하여 RLS 우회
- 노출 필드는 최소화 (보안 고려)

### 클라이언트 사이드 (CSR)

```typescript
// app/(webinar)/webinar/[id]/components/WebinarEntry.tsx
// access_policy에 따라 UI/접근 제어 처리
if (webinar.access_policy === 'email_auth') {
  // 이메일 인증 화면 표시
} else if (webinar.access_policy === 'auth') {
  // 로그인 화면 표시
}
```

---

## 보안 고려사항

### 1. 브루트포스 공격 방지

6자리 슬러그는 추측 가능하므로 다음 조치 필요:

- **레이트 리밋**: 동일 IP에서 반복 요청 제한
- **모니터링**: 비정상적인 접근 패턴 탐지
- **존재 여부 노출 최소화**: 404 응답을 일관되게 유지

### 2. 데이터 노출 최소화

Admin Supabase로 조회하더라도, 클라이언트에 노출하는 필드는 최소화:

- **공개 가능**: 제목, 일정, 설명 (일부)
- **인증 후 노출**: YouTube URL, 민감한 설정
- **관리자 전용**: 통계, 등록자 목록 등

### 3. 멀티테넌시 보안

- Admin Supabase로 조회한 뒤에도 **앱 레벨 권한 체크** 필수
- 타 테넌트 데이터 노출 방지
- 프로젝트 표준 패턴 준수

---

## 운영 규칙

### 슬러그 발급 기준

슬러그는 모든 웨비나에 발급 가능하지만, **접근 정책은 별도로 설정**:

- 슬러그 발급: 자동 (웨비나 생성 시)
- 접근 정책 설정: 웨비나 생성/수정 시 관리자가 선택
- 공개 웨비나: `is_public = true AND access_policy = 'guest_allowed'`

### 접근 정책별 동작

| access_policy | 비로그인 사용자 | 로그인 사용자 | 등록자 |
|--------------|--------------|------------|--------|
| `auth` | 로그인 요구 | 접근 가능 | 접근 가능 |
| `email_auth` | 이메일 인증 요구 | 이메일 인증 요구 | 접근 가능 |
| `guest_allowed` | 접근 가능 | 접근 가능 | 접근 가능 |
| `invite_only` | 초대 링크 필요 | 초대 링크 필요 | 접근 가능 |

---

## 관련 파일

- `app/(webinar)/webinar/[id]/page.tsx`: 서버 사이드 웨비나 조회
- `app/(webinar)/webinar/[id]/components/WebinarEntry.tsx`: 클라이언트 사이드 접근 제어
- `lib/supabase/admin.ts`: Admin Supabase 클라이언트
- `lib/utils/webinar.ts`: 슬러그/UUID 판별 유틸리티

---

## 변경 이력

- 2026-01-14: 초안 작성 (결정 포인트 A 확정)

---

**참고**: 이 정책은 프로젝트의 멀티테넌시/RLS/권한 패턴을 따르며, 향후 변경 시 이 문서를 업데이트해야 합니다.
