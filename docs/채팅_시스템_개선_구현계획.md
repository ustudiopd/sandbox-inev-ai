# ì±„íŒ… ì‹œìŠ¤í…œ ê°œì„  êµ¬í˜„ ê³„íš

## ğŸ“‹ ë¬¸ì„œ ì •ë³´
- **ì‘ì„±ì¼**: 2025-01-13
- **ë²„ì „**: 1.0.0
- **ëª©ì **: í¬ë¡¬ í™˜ê²½ì—ì„œì˜ "ì „ì†¡ ì¤‘..." ê³ ì°© ë¬¸ì œ ë° Realtime ì•ˆì •ì„± ê°œì„ 
- **ê¸°ë°˜ ë¬¸ì„œ**: `í•´ê²°ì±….md` ê²€í†  ê²°ê³¼

---

## 1. ê°œìš”

### 1.1 ëª©í‘œ
1. **í¬ë¡¬ í™˜ê²½ì—ì„œ "ì „ì†¡ ì¤‘..." ê³ ì°© ë¬¸ì œ í•´ê²°**
   - API ì„±ê³µ ì¦‰ì‹œ UI ë°˜ì˜ (Realtime ëŒ€ê¸° ì—†ì´)
   - ì •í™•í•œ Optimistic ë©”ì‹œì§€ ë§¤ì¹­ (`client_msg_id` ë„ì…)

2. **Realtime ì•ˆì •ì„± í–¥ìƒ**
   - Realtime í† í° ì£¼ì… ë³´ì¥
   - ê³ ì • ì±„ë„ëª…ìœ¼ë¡œ ì¤‘ë³µ êµ¬ë… ë°©ì§€
   - ì¡°ê±´ë¶€ í´ë°± í´ë§ êµ¬í˜„

3. **ì—ëŸ¬ ì²˜ë¦¬ ë° ë³µêµ¬ ê°•í™”**
   - íƒ€ì„ì•„ì›ƒ ì²˜ë¦¬
   - ìë™ ì¬ì—°ê²° ë¡œì§
   - ìƒì„¸ ë¡œê¹…

### 1.2 í˜„ì¬ ìƒíƒœ ë¶„ì„

#### âœ… ì´ë¯¸ êµ¬í˜„ëœ ë¶€ë¶„
- API ë¼ìš°íŠ¸ì— `runtime = 'nodejs'` ì„¤ì •ë¨
- Optimistic Update íŒ¨í„´ ì‚¬ìš© ì¤‘
- Realtime êµ¬ë… ê¸°ë³¸ êµ¬ì¡° ì¡´ì¬
- í”„ë¡œí•„ ì •ë³´ ì¡°íšŒ API (`/api/profiles/[userId]`)

#### âŒ ê°œì„ ì´ í•„ìš”í•œ ë¶€ë¶„
1. **API ì„±ê³µ í›„ ì¦‰ì‹œ UI êµì²´ ë¯¸êµ¬í˜„**
   - í˜„ì¬: API ì„±ê³µ í›„ Realtime INSERTë¥¼ ê¸°ë‹¤ë¦¼
   - ë¬¸ì œ: WS ì°¨ë‹¨ ì‹œ "ì „ì†¡ ì¤‘..." ê³ ì°©

2. **Optimistic ë©”ì‹œì§€ ë§¤ì¹­ ë¶ˆì •í™•**
   - í˜„ì¬: `user_id + content`ë¡œ ë§¤ì¹­
   - ë¬¸ì œ: ë™ì¼ ë‚´ìš© ë©”ì‹œì§€ ì¶©ëŒ ê°€ëŠ¥

3. **ì±„ë„ëª… ì¤‘ë³µ êµ¬ë… ê°€ëŠ¥ì„±**
   - í˜„ì¬: íƒ€ì„ìŠ¤íƒ¬í”„ í¬í•¨ (`webinar-${webinarId}-messages-${Date.now()}`)
   - ë¬¸ì œ: ì»´í¬ë„ŒíŠ¸ ì¬ë Œë”ë§ ì‹œ ì¤‘ë³µ êµ¬ë…

4. **Realtime í† í° ì£¼ì… ëˆ„ë½**
   - í˜„ì¬: `supabase.realtime.setAuth()` í˜¸ì¶œ ì—†ìŒ
   - ë¬¸ì œ: Chromeì—ì„œ ì¸ì¦ ì‹¤íŒ¨ ê°€ëŠ¥

5. **í´ë°± í´ë§ ë¯¸êµ¬í˜„**
   - í˜„ì¬: WS ì°¨ë‹¨ ì‹œ ë³µêµ¬ ë¶ˆê°€
   - ë¬¸ì œ: íŠ¹ìˆ˜ í™˜ê²½ì—ì„œ ë©”ì‹œì§€ ìˆ˜ì‹  ë¶ˆê°€

6. **íƒ€ì„ì•„ì›ƒ ì²˜ë¦¬ ë¯¸êµ¬í˜„**
   - í˜„ì¬: API í˜¸ì¶œì— íƒ€ì„ì•„ì›ƒ ì—†ìŒ
   - ë¬¸ì œ: ë„¤íŠ¸ì›Œí¬ ì§€ì—° ì‹œ ë¬´í•œ ëŒ€ê¸°

7. **ì—ëŸ¬ ë³µêµ¬ ë¡œì§ ë¶€ì¡±**
   - í˜„ì¬: WS ì‹¤íŒ¨ ì‹œ ì¬ì—°ê²° ì—†ìŒ
   - ë¬¸ì œ: ì¼ì‹œì  ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ ì‹œ ë³µêµ¬ ë¶ˆê°€

---

## 2. ìš°ì„ ìˆœìœ„ë³„ ê°œì„  ì‚¬í•­

### ğŸ”´ ë†’ì€ ìš°ì„ ìˆœìœ„ (ì¦‰ì‹œ êµ¬í˜„)

#### 2.1 `client_msg_id` ì¹¼ëŸ¼ ì¶”ê°€ ë° ì—°ë™
- **ëª©ì **: Optimistic ë©”ì‹œì§€ì™€ ì‹¤ì œ ë©”ì‹œì§€ì˜ ì •í™•í•œ 1:1 ë§¤ì¹­
- **ì˜í–¥**: í•µì‹¬ ê¸°ëŠ¥ ì•ˆì •ì„±
- **ì˜ˆìƒ ì‘ì—… ì‹œê°„**: 2ì‹œê°„

#### 2.2 API ì„±ê³µ ì¦‰ì‹œ UI êµì²´ ë¡œì§
- **ëª©ì **: "ì „ì†¡ ì¤‘..." ê³ ì°© ë¬¸ì œ í•´ê²°
- **ì˜í–¥**: ì‚¬ìš©ì ê²½í—˜ ê°œì„ 
- **ì˜ˆìƒ ì‘ì—… ì‹œê°„**: 1ì‹œê°„

#### 2.3 Realtime í† í° ì£¼ì…
- **ëª©ì **: Chrome í™˜ê²½ì—ì„œì˜ ì¸ì¦ ë³´ì¥
- **ì˜í–¥**: í¬ë¡¬ í˜¸í™˜ì„±
- **ì˜ˆìƒ ì‘ì—… ì‹œê°„**: 30ë¶„

### ğŸŸ¡ ì¤‘ê°„ ìš°ì„ ìˆœìœ„ (ë‹¨ê¸° êµ¬í˜„)

#### 2.4 ê³ ì • ì±„ë„ëª… ì‚¬ìš©
- **ëª©ì **: ì¤‘ë³µ êµ¬ë… ë°©ì§€
- **ì˜í–¥**: ì„±ëŠ¥ ë° ì•ˆì •ì„±
- **ì˜ˆìƒ ì‘ì—… ì‹œê°„**: 1ì‹œê°„

#### 2.5 ì¡°ê±´ë¶€ í´ë°± í´ë§
- **ëª©ì **: WS ì°¨ë‹¨ í™˜ê²½ì—ì„œì˜ ë³µêµ¬
- **ì˜í–¥**: íŠ¹ìˆ˜ í™˜ê²½ í˜¸í™˜ì„±
- **ì˜ˆìƒ ì‘ì—… ì‹œê°„**: 3ì‹œê°„

### ğŸŸ¢ ë‚®ì€ ìš°ì„ ìˆœìœ„ (ì¤‘ê¸° êµ¬í˜„)

#### 2.6 íƒ€ì„ì•„ì›ƒ ì²˜ë¦¬ ê°•í™”
- **ëª©ì **: ë„¤íŠ¸ì›Œí¬ ì§€ì—° ëŒ€ì‘
- **ì˜í–¥**: ì‚¬ìš©ì ê²½í—˜
- **ì˜ˆìƒ ì‘ì—… ì‹œê°„**: 1ì‹œê°„

#### 2.7 ì—ëŸ¬ ë³µêµ¬ ë¡œì§ ê°•í™”
- **ëª©ì **: ì¼ì‹œì  ì˜¤ë¥˜ ìë™ ë³µêµ¬
- **ì˜í–¥**: ì•ˆì •ì„±
- **ì˜ˆìƒ ì‘ì—… ì‹œê°„**: 2ì‹œê°„

#### 2.8 ìƒì„¸ ë¡œê¹… ì¶”ê°€
- **ëª©ì **: ë””ë²„ê¹… ìš©ì´ì„±
- **ì˜í–¥**: ìœ ì§€ë³´ìˆ˜ì„±
- **ì˜ˆìƒ ì‘ì—… ì‹œê°„**: 1ì‹œê°„

#### 2.9 CSP ì„¤ì • (ì»¤ìŠ¤í…€ ë„ë©”ì¸ ì‚¬ìš© ì‹œ)
- **ëª©ì **: ë³´ì•ˆ ì •ì±… ì¤€ìˆ˜
- **ì˜í–¥**: ë³´ì•ˆ
- **ì˜ˆìƒ ì‘ì—… ì‹œê°„**: 30ë¶„

#### 2.10 ì¶”ê°€ ìµœì í™” ì‚¬í•­ (ë³´ì™„)
- **2.10.1**: ì¦ë¶„ í´ë§ ì¸ë±ìŠ¤ ìµœì í™” (ë³µí•© ì¸ë±ìŠ¤ ì¶”ê°€)
- **2.10.2**: ì¤‘ë³µ ì „ì†¡ ë°©ì§€ (ë”ë¸” í´ë¦­/Enter ë°”ìš´ìŠ¤)
- **2.10.3**: í´ë§ ì§€í„° ì ìš© (ë–¼ì°½ ë°©ì§€)
- **2.10.4**: ê°€ì‹œì„±/ì˜¤í”„ë¼ì¸ ê³ ë ¤ (í´ë§ ì¼ì‹œ ì •ì§€)
- **2.10.5**: DELETE/UPDATE ì•ˆì • ìˆ˜ì‹  (payload ê²€ì¦)
- **2.10.6**: ì „ì†¡ ë¼ìš°íŠ¸ ì‘ë‹µ ì¼ê´€í™” (ìŠ¤í‚¤ë§ˆ í†µì¼)
- **2.10.7**: ìš´ì˜ì§€í‘œ ì¶”ê°€ (í´ë°± íŠ¸ë¦¬ê±°ìœ¨ ë“±)

---

## 3. ìƒì„¸ êµ¬í˜„ ê³„íš

### 3.1 `client_msg_id` ì¹¼ëŸ¼ ì¶”ê°€ ë° ì—°ë™

#### 3.1.1 ë°ì´í„°ë² ì´ìŠ¤ ë§ˆì´ê·¸ë ˆì´ì…˜

**íŒŒì¼**: `supabase/migrations/012_add_client_msg_id_to_messages.sql`

```sql
-- client_msg_id ì¹¼ëŸ¼ ì¶”ê°€
ALTER TABLE public.messages 
ADD COLUMN client_msg_id UUID;

-- ì¸ë±ìŠ¤ ìƒì„± (ì¡°íšŒ ì„±ëŠ¥ í–¥ìƒ)
CREATE INDEX idx_messages_client_msg_id 
ON public.messages(client_msg_id);

-- ì¦ë¶„ í´ë§ ìµœì í™”ë¥¼ ìœ„í•œ ë³µí•© ì¸ë±ìŠ¤ (webinar_id, id)
CREATE INDEX IF NOT EXISTS idx_messages_webinar_id_id
ON public.messages (webinar_id, id);

-- ê³ ìœ  ì œì•½ ì¡°ê±´ ì¶”ê°€ (ê°™ì€ ì›¨ë¹„ë‚˜/ì‚¬ìš©ìì—ì„œ ë™ì¼ client_msg_id ì¤‘ë³µ ë°©ì§€)
ALTER TABLE public.messages
ADD CONSTRAINT messages_client_msg_unique 
UNIQUE (webinar_id, user_id, client_msg_id);

-- ê¸°ì¡´ ë©”ì‹œì§€ì˜ client_msg_idëŠ” NULLë¡œ ìœ ì§€ (í˜¸í™˜ì„±)
```

**ê²€ì¦ ì¿¼ë¦¬**:
```sql
-- ë§ˆì´ê·¸ë ˆì´ì…˜ í™•ì¸
SELECT column_name, data_type, is_nullable 
FROM information_schema.columns 
WHERE table_name = 'messages' AND column_name = 'client_msg_id';

-- ì¸ë±ìŠ¤ í™•ì¸
SELECT indexname, indexdef 
FROM pg_indexes 
WHERE tablename = 'messages' 
AND indexname IN ('idx_messages_client_msg_id', 'idx_messages_webinar_id_id');
```

#### 3.1.2 API ë¼ìš°íŠ¸ ìˆ˜ì •

**íŒŒì¼**: `app/api/messages/create/route.ts`

**ë³€ê²½ ì‚¬í•­**:
```typescript
export async function POST(req: Request) {
  try {
    const { webinarId, content, clientMsgId } = await req.json()
    
    // clientMsgId ê²€ì¦ (UUID í˜•ì‹)
    if (clientMsgId && !/^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i.test(clientMsgId)) {
      return NextResponse.json(
        { success: false, error: 'Invalid client_msg_id format' },
        { status: 400 }
      )
    }
    
    // ... ê¸°ì¡´ ì¸ì¦ ë° ê²€ì¦ ë¡œì§ ...
    
    // ë©”ì‹œì§€ ìƒì„± (client_msg_id í¬í•¨)
    const { data: message, error: messageError } = await admin
      .from('messages')
      .insert({
        agency_id: webinar.agency_id,
        client_id: webinar.client_id,
        webinar_id: webinarId,
        user_id: user.id,
        content: trimmedContent,
        client_msg_id: clientMsgId || null, // í´ë¼ì´ì–¸íŠ¸ì—ì„œ ì „ë‹¬ë°›ì€ UUID
      })
      .select('id, webinar_id, user_id, content, created_at, hidden, client_msg_id')
      .single()
    
    if (messageError) {
      // ì¤‘ë³µ client_msg_id ì—ëŸ¬ ì²˜ë¦¬
      if (messageError.code === '23505' && messageError.message.includes('messages_client_msg_unique')) {
        return NextResponse.json(
          { success: false, error: 'Duplicate message detected' },
          { status: 409 }
        )
      }
      return NextResponse.json(
        { success: false, error: messageError.message },
        { status: 500 }
      )
    }
    
    // ì„±ê³µ ì‘ë‹µ (ì¼ê´€ëœ ìŠ¤í‚¤ë§ˆ)
    return NextResponse.json({ 
      success: true, 
      message 
    })
  } catch (error: any) {
    // ... ê¸°ì¡´ ì—ëŸ¬ ì²˜ë¦¬ ...
  }
}
```

**í…ŒìŠ¤íŠ¸ ì¼€ì´ìŠ¤**:
- âœ… `clientMsgId`ê°€ ì œê³µëœ ê²½ìš° ì •ìƒ ì €ì¥
- âœ… `clientMsgId`ê°€ ì—†ëŠ” ê²½ìš° NULL ì €ì¥ (í•˜ìœ„ í˜¸í™˜ì„±)
- âœ… ì˜ëª»ëœ UUID í˜•ì‹ ê±°ë¶€
- âœ… ë™ì¼ `client_msg_id` ì¤‘ë³µ ì €ì¥ ë°©ì§€ (ì œì•½ ì¡°ê±´)
- âœ… ì‘ë‹µ ìŠ¤í‚¤ë§ˆ ì¼ê´€ì„± í™•ì¸ (`success`, `message`, `error`)
- âœ… ì¤‘ë³µ ë©”ì‹œì§€ ê°ì§€ ì‹œ 409 ì‘ë‹µ

#### 3.1.3 Chat ì»´í¬ë„ŒíŠ¸ ìˆ˜ì •

**íŒŒì¼**: `components/webinar/Chat.tsx`

**ë³€ê²½ ì‚¬í•­**:

1. **Optimistic ë©”ì‹œì§€ ìƒì„± ì‹œ `client_msg_id` í¬í•¨**:
```typescript
const handleSend = async (e: React.FormEvent) => {
  e.preventDefault()
  if (!newMessage.trim() || sending || !canSend) return
  
  // ê³ ìœ  client_msg_id ìƒì„±
  const clientMsgId = crypto.randomUUID()
  const tempId = `temp-${clientMsgId}` // client_msg_idë¥¼ IDì— í¬í•¨
  const now = new Date().toISOString()
  
  // ... í”„ë¡œí•„ ì •ë³´ ë¡œë“œ ...
  
  // Optimistic ë©”ì‹œì§€ ìƒì„±
  const optimisticMessage: Message = {
    id: tempId,
    user_id: currentUser.id,
    content: messageContent,
    created_at: now,
    hidden: false,
    user: userProfile,
    isOptimistic: true,
    client_msg_id: clientMsgId, // ìƒˆë¡œ ì¶”ê°€
  }
  
  setMessages((prev) => [...prev, optimisticMessage])
  setNewMessage('')
  setSending(true)
  
  try {
    const response = await fetch('/api/messages/create', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        webinarId,
        content: messageContent,
        clientMsgId, // APIì— ì „ë‹¬
      }),
    })
    
    // ... ê¸°ì¡´ ì²˜ë¦¬ ...
  } catch (error: any) {
    // ... ê¸°ì¡´ ì—ëŸ¬ ì²˜ë¦¬ ...
  }
}
```

2. **Message ì¸í„°í˜ì´ìŠ¤ í™•ì¥**:
```typescript
interface Message {
  id: number | string
  user_id: string
  content: string
  created_at: string
  hidden?: boolean
  user?: {
    display_name?: string
    email?: string
  }
  isOptimistic?: boolean
  client_msg_id?: string // ìƒˆë¡œ ì¶”ê°€
}
```

3. **Realtime INSERT í•¸ë“¤ëŸ¬ ìˆ˜ì •**:
```typescript
if (payload.eventType === 'INSERT') {
  const newMsg = payload.new as any
  if (newMsg && !newMsg.hidden) {
    // client_msg_idë¡œ optimistic ë©”ì‹œì§€ ì •í™• êµì²´
    setMessages((prev) => {
      // client_msg_idë¡œ ë§¤ì¹­
      const optimisticIndex = prev.findIndex(m => {
        if (!m.isOptimistic) return false
        if (newMsg.client_msg_id) {
          // client_msg_idê°€ ìˆìœ¼ë©´ ì •í™• ë§¤ì¹­
          return m.client_msg_id === newMsg.client_msg_id
        }
        // í•˜ìœ„ í˜¸í™˜ì„±: client_msg_idê°€ ì—†ìœ¼ë©´ ê¸°ì¡´ ë°©ì‹ ì‚¬ìš©
        return m.user_id === newMsg.user_id && m.content === newMsg.content
      })
      
      if (optimisticIndex !== -1) {
        // Optimistic ë©”ì‹œì§€ë¥¼ ì‹¤ì œ ë©”ì‹œì§€ë¡œ êµì²´
        const updated = [...prev]
        updated[optimisticIndex] = {
          ...newMsg,
          user: profile || prev[optimisticIndex].user,
          isOptimistic: false,
        }
        return updated
      }
      
      // ìƒˆ ë©”ì‹œì§€ ì¶”ê°€ (ì¤‘ë³µ ë°©ì§€)
      if (prev.some(m => m.id === newMsg.id)) return prev
      
      return [...prev, {
        id: newMsg.id,
        user_id: newMsg.user_id,
        content: newMsg.content,
        created_at: newMsg.created_at,
        hidden: newMsg.hidden,
        user: profile,
        client_msg_id: newMsg.client_msg_id,
      }].sort((a, b) => 
        new Date(a.created_at).getTime() - new Date(b.created_at).getTime()
      )
    })
    
    // ë‚´ê°€ ë³´ë‚¸ ë©”ì‹œì§€ë©´ ìŠ¤í”¼ë„ˆ ë„ê¸° (ì´ì¤‘ ì•ˆì „ì¥ì¹˜)
    if (newMsg.user_id === currentUser?.id) {
      setSending(false)
    }
  }
} else if (payload.eventType === 'UPDATE') {
  // ì—…ë°ì´íŠ¸ëœ ë©”ì‹œì§€ ë°˜ì˜ (id í•„ìˆ˜ í™•ì¸)
  const updatedMsg = payload.new as any
  if (!updatedMsg?.id) {
    console.warn('UPDATE ì´ë²¤íŠ¸ì— idê°€ ì—†ìŠµë‹ˆë‹¤:', payload)
    return
  }
  setMessages((prev) =>
    prev.map((msg) =>
      msg.id === updatedMsg.id
        ? { ...msg, ...updatedMsg, hidden: updatedMsg.hidden }
        : msg
    ).filter(msg => !msg.hidden)
  )
} else if (payload.eventType === 'DELETE') {
  // ì‚­ì œëœ ë©”ì‹œì§€ ì œê±° (id í•„ìˆ˜ í™•ì¸)
  const deletedMsg = payload.old as any
  if (!deletedMsg?.id) {
    console.warn('DELETE ì´ë²¤íŠ¸ì— idê°€ ì—†ìŠµë‹ˆë‹¤:', payload)
    return
  }
  setMessages((prev) => prev.filter((msg) => msg.id !== deletedMsg.id))
}
```

**í…ŒìŠ¤íŠ¸ ì¼€ì´ìŠ¤**:
- âœ… `client_msg_id`ë¡œ ì •í™•í•œ ë§¤ì¹­
- âœ… `client_msg_id`ê°€ ì—†ëŠ” ê¸°ì¡´ ë©”ì‹œì§€ì™€ì˜ í˜¸í™˜ì„±
- âœ… ì¤‘ë³µ ë©”ì‹œì§€ ë°©ì§€
- âœ… ìŠ¤í”¼ë„ˆ ìë™ í•´ì œ
- âœ… UPDATE ì´ë²¤íŠ¸ payload ê²€ì¦ (id í•„ìˆ˜)
- âœ… DELETE ì´ë²¤íŠ¸ payload ê²€ì¦ (id í•„ìˆ˜)

---

### 3.2 API ì„±ê³µ ì¦‰ì‹œ UI êµì²´ ë¡œì§

#### 3.2.1 Chat ì»´í¬ë„ŒíŠ¸ ìˆ˜ì •

**íŒŒì¼**: `components/webinar/Chat.tsx`

**ë³€ê²½ ì‚¬í•­**:

```typescript
// ì¤‘ë³µ ì „ì†¡ ë°©ì§€ë¥¼ ìœ„í•œ ref
const sendingClientMsgIdRef = useRef<string | null>(null)

const handleSend = async (e: React.FormEvent) => {
  e.preventDefault()
  if (!newMessage.trim() || sending || !canSend) return
  
  const clientMsgId = crypto.randomUUID()
  
  // ì¤‘ë³µ ì „ì†¡ ë°©ì§€: ë™ì¼ client_msg_idë¡œ ì´ë¯¸ ì „ì†¡ ì¤‘ì´ë©´ ì°¨ë‹¨
  if (sendingClientMsgIdRef.current === clientMsgId) {
    return
  }
  
  const tempId = `temp-${clientMsgId}`
  const messageContent = newMessage.trim()
  const now = new Date().toISOString()
  
  // ì „ì†¡ ì‹œì‘ í‘œì‹œ
  sendingClientMsgIdRef.current = clientMsgId
  
  // ... í”„ë¡œí•„ ì •ë³´ ë¡œë“œ ...
  
  // Optimistic ë©”ì‹œì§€ ìƒì„±
  const optimisticMessage: Message = {
    id: tempId,
    user_id: currentUser.id,
    content: messageContent,
    created_at: now,
    hidden: false,
    user: userProfile,
    isOptimistic: true,
    client_msg_id: clientMsgId,
  }
  
  setMessages((prev) => [...prev, optimisticMessage])
  setNewMessage('')
  setSending(true)
  
  // ì „ì†¡ ë²„íŠ¼ 1-2ì´ˆ ë¹„í™œì„±í™” (ë”ë¸” í´ë¦­ ë°©ì§€)
  const disableTimeout = setTimeout(() => {
    // 1ì´ˆ í›„ ë²„íŠ¼ ë‹¤ì‹œ í™œì„±í™” ê°€ëŠ¥
  }, 1000)
  
  // íƒ€ì„ì•„ì›ƒ ì„¤ì •
  const controller = new AbortController()
  const timeout = setTimeout(() => controller.abort(), 10000) // 10ì´ˆ íƒ€ì„ì•„ì›ƒ
  
  try {
    const response = await fetch('/api/messages/create', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        webinarId,
        content: messageContent,
        clientMsgId,
      }),
      signal: controller.signal,
    })
    
    const result = await response.json().catch(() => ({}))
    
    if (!response.ok || result?.error) {
      // ì‹¤íŒ¨: Optimistic ë©”ì‹œì§€ ì œê±° ë° ì…ë ¥ ë³µì›
      setMessages((prev) => prev.filter((msg) => msg.id !== tempId))
      setNewMessage(messageContent)
      throw new Error(result?.error || `HTTP ${response.status}`)
    }
    
    // âœ… API ì„±ê³µ ì¦‰ì‹œ UI êµì²´ (Realtime ëŒ€ê¸° ì—†ì´)
    const serverMsg = result.message
    setMessages((prev) => prev.map((msg) => {
      if (msg.id === tempId) {
        return {
          ...serverMsg,
          user: userProfile || msg.user,
          isOptimistic: false,
        }
      }
      return msg
    }))
    
    // ìŠ¤í”¼ë„ˆ ì¦‰ì‹œ ë„ê¸°
    setSending(false)
    sendingClientMsgIdRef.current = null // ì „ì†¡ ì™„ë£Œ
    
    // ì½œë°± í˜¸ì¶œ
    onMessageSent?.(serverMsg)
    
  } catch (error: any) {
    if (error.name === 'AbortError') {
      // íƒ€ì„ì•„ì›ƒ: Optimistic ë©”ì‹œì§€ ìœ ì§€ (ë‚˜ì¤‘ì— Realtime INSERTë¡œ êµì²´ë  ìˆ˜ ìˆìŒ)
      console.warn('ë©”ì‹œì§€ ì „ì†¡ íƒ€ì„ì•„ì›ƒ, Realtimeì„ ê¸°ë‹¤ë¦½ë‹ˆë‹¤')
      // ìŠ¤í”¼ë„ˆëŠ” ë„ì§€ë§Œ ë©”ì‹œì§€ëŠ” ìœ ì§€
      setSending(false)
      sendingClientMsgIdRef.current = null // íƒ€ì„ì•„ì›ƒ ì‹œì—ë„ í•´ì œ
    } else {
      // ë‹¤ë¥¸ ì—ëŸ¬: Optimistic ë©”ì‹œì§€ ì œê±° ë° ì…ë ¥ ë³µì›
      setMessages((prev) => prev.filter((msg) => msg.id !== tempId))
      setNewMessage(messageContent)
      alert(error.message || 'ë©”ì‹œì§€ ì „ì†¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤')
      setSending(false)
      sendingClientMsgIdRef.current = null // ì—ëŸ¬ ì‹œ í•´ì œ
    }
  } finally {
    clearTimeout(timeout)
    clearTimeout(disableTimeout)
  }
}
```

**ì£¼ìš” ë³€ê²½ì **:
1. âœ… API ì„±ê³µ ì‹œ ì¦‰ì‹œ Optimistic ë©”ì‹œì§€ë¥¼ ì„œë²„ ì‘ë‹µìœ¼ë¡œ êµì²´
2. âœ… `AbortController`ë¡œ íƒ€ì„ì•„ì›ƒ ì²˜ë¦¬ (10ì´ˆ)
3. âœ… íƒ€ì„ì•„ì›ƒ ì‹œ Optimistic ë©”ì‹œì§€ ìœ ì§€ (Realtime ëŒ€ê¸°)
4. âœ… ì—ëŸ¬ ì‹œ ì¦‰ì‹œ ë¡¤ë°± ë° ì…ë ¥ ë³µì›

**í…ŒìŠ¤íŠ¸ ì¼€ì´ìŠ¤**:
- âœ… API ì„±ê³µ ì‹œ ì¦‰ì‹œ UI ì—…ë°ì´íŠ¸
- âœ… íƒ€ì„ì•„ì›ƒ ì‹œ Optimistic ë©”ì‹œì§€ ìœ ì§€
- âœ… ë„¤íŠ¸ì›Œí¬ ì—ëŸ¬ ì‹œ ë¡¤ë°±
- âœ… Realtime INSERTì™€ì˜ ì¤‘ë³µ ë°©ì§€
- âœ… ë”ë¸” í´ë¦­/Enter ë°”ìš´ìŠ¤ ë°©ì§€ (1-2ì´ˆ ë¹„í™œì„±í™”)
- âœ… ë™ì¼ `client_msg_id` ì¬ì „ì†¡ ì°¨ë‹¨

---

### 3.3 Realtime í† í° ì£¼ì…

#### 3.3.1 Supabase í´ë¼ì´ì–¸íŠ¸ ìˆ˜ì •

**íŒŒì¼**: `lib/supabase/client.ts`

**ë³€ê²½ ì‚¬í•­**:

```typescript
import { createBrowserClient } from '@supabase/ssr'

export function createClientSupabase() {
  const supabase = createBrowserClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!
  )
  
  // Realtime í† í° ì£¼ì… (ì„¸ì…˜ì´ ìˆì„ ë•Œ)
  supabase.auth.onAuthStateChange((event, session) => {
    if (session?.access_token) {
      supabase.realtime.setAuth(session.access_token)
    } else {
      supabase.realtime.setAuth(null)
    }
  })
  
  // ì´ˆê¸° ì„¸ì…˜ í™•ì¸ ë° í† í° ì£¼ì…
  supabase.auth.getSession().then(({ data: { session } }) => {
    if (session?.access_token) {
      supabase.realtime.setAuth(session.access_token)
    }
  })
  
  return supabase
}
```

**ë˜ëŠ” Chat ì»´í¬ë„ŒíŠ¸ì—ì„œ ì§ì ‘ ì£¼ì…**:

**íŒŒì¼**: `components/webinar/Chat.tsx`

```typescript
useEffect(() => {
  // Realtime í† í° ì£¼ì…
  const setupRealtimeAuth = async () => {
    const { data: { session } } = await supabase.auth.getSession()
    if (session?.access_token) {
      supabase.realtime.setAuth(session.access_token)
    }
  }
  
  setupRealtimeAuth()
  
  // ì„¸ì…˜ ë³€ê²½ ê°ì§€
  const { data: { subscription } } = supabase.auth.onAuthStateChange((event, session) => {
    if (session?.access_token) {
      supabase.realtime.setAuth(session.access_token)
    } else {
      supabase.realtime.setAuth(null)
    }
  })
  
  return () => {
    subscription.unsubscribe()
  }
}, [supabase])
```

**ê¶Œì¥ ë°©ë²•**: `lib/supabase/client.ts`ì—ì„œ ì „ì—­ ì„¤ì • (ëª¨ë“  ì»´í¬ë„ŒíŠ¸ì—ì„œ ìë™ ì ìš©)

**í…ŒìŠ¤íŠ¸ ì¼€ì´ìŠ¤**:
- âœ… ë¡œê·¸ì¸ ì‹œ í† í° ì£¼ì… í™•ì¸
- âœ… ë¡œê·¸ì•„ì›ƒ ì‹œ í† í° ì œê±° í™•ì¸
- âœ… ì„¸ì…˜ ê°±ì‹  ì‹œ í† í° ì—…ë°ì´íŠ¸ í™•ì¸
- âœ… Chrome DevToolsì—ì„œ Realtime ì—°ê²° í™•ì¸

---

### 3.4 ê³ ì • ì±„ë„ëª… ì‚¬ìš©

#### 3.4.1 Chat ì»´í¬ë„ŒíŠ¸ ìˆ˜ì •

**íŒŒì¼**: `components/webinar/Chat.tsx`

**ë³€ê²½ ì‚¬í•­**:

```typescript
useEffect(() => {
  loadMessages()
  
  // ê³ ì • ì±„ë„ëª… ì‚¬ìš© (ì¤‘ë³µ êµ¬ë… ë°©ì§€)
  const channelName = `webinar:${webinarId}:messages`
  
  // ê¸°ì¡´ ì±„ë„ í™•ì¸ ë° ì œê±° (ì•ˆì „ì¥ì¹˜)
  const existingChannel = supabase.getChannels().find(
    ch => ch.topic === `realtime:${channelName}`
  )
  if (existingChannel) {
    console.warn('ê¸°ì¡´ ì±„ë„ ë°œê²¬, ì œê±° ì¤‘:', channelName)
    existingChannel.unsubscribe().then(() => {
      supabase.removeChannel(existingChannel)
    })
  }
  
  // ì‹¤ì‹œê°„ êµ¬ë…
  const channel = supabase
    .channel(channelName, {
      config: {
        broadcast: { self: false },
      },
    })
    .on(
      'postgres_changes',
      {
        event: '*',
        schema: 'public',
        table: 'messages',
        filter: `webinar_id=eq.${webinarId}`,
      },
      (payload) => {
        // ... ê¸°ì¡´ ì´ë²¤íŠ¸ ì²˜ë¦¬ ...
      }
    )
    .subscribe((status, err) => {
      console.log('ì‹¤ì‹œê°„ êµ¬ë… ìƒíƒœ:', status, err)
      if (status === 'SUBSCRIBED') {
        console.log('âœ… ì‹¤ì‹œê°„ êµ¬ë… ì„±ê³µ:', channelName)
      } else if (status === 'CHANNEL_ERROR') {
        console.error('âŒ ì‹¤ì‹œê°„ êµ¬ë… ì˜¤ë¥˜:', err)
      } else if (status === 'TIMED_OUT') {
        console.warn('â±ï¸ ì‹¤ì‹œê°„ êµ¬ë… íƒ€ì„ì•„ì›ƒ')
      } else if (status === 'CLOSED') {
        console.log('ğŸ”’ ì‹¤ì‹œê°„ êµ¬ë… ì¢…ë£Œ')
      }
    })
  
  return () => {
    console.log('ì‹¤ì‹œê°„ êµ¬ë… í•´ì œ:', channelName)
    channel.unsubscribe().then(() => {
      supabase.removeChannel(channel)
    }).catch((err) => {
      console.warn('ì±„ë„ êµ¬ë… í•´ì œ ì˜¤ë¥˜:', err)
    })
  }
}, [webinarId, supabase])
```

**ì£¼ìš” ë³€ê²½ì **:
1. âœ… ê³ ì • ì±„ë„ëª…: `webinar:${webinarId}:messages`
2. âœ… ê¸°ì¡´ ì±„ë„ í™•ì¸ ë° ì œê±° ë¡œì§ ì¶”ê°€
3. âœ… ì˜ì¡´ì„± ë°°ì—´ì— `supabase` ì¶”ê°€

**í…ŒìŠ¤íŠ¸ ì¼€ì´ìŠ¤**:
- âœ… ì»´í¬ë„ŒíŠ¸ ì¬ë Œë”ë§ ì‹œ ì¤‘ë³µ êµ¬ë… ë°©ì§€
- âœ… ì—¬ëŸ¬ ì»´í¬ë„ŒíŠ¸ì—ì„œ ë™ì¼ ì±„ë„ ì‚¬ìš© ì‹œ ì •ìƒ ë™ì‘
- âœ… ì–¸ë§ˆìš´íŠ¸ ì‹œ ì±„ë„ ì •ë¦¬ í™•ì¸

---

### 3.5 ì¡°ê±´ë¶€ í´ë°± í´ë§

#### 3.5.1 Chat ì»´í¬ë„ŒíŠ¸ ìˆ˜ì •

**íŒŒì¼**: `components/webinar/Chat.tsx`

**ë³€ê²½ ì‚¬í•­**:

```typescript
const [fallbackOn, setFallbackOn] = useState(false)
const lastEventAt = useRef<number>(Date.now())
const lastMessageIdRef = useRef<number>(0)
const reconnectTriesRef = useRef<number>(0)

useEffect(() => {
  loadMessages()
  
  const channelName = `webinar:${webinarId}:messages`
  
  // ê¸°ì¡´ ì±„ë„ í™•ì¸ ë° ì œê±°
  const existingChannel = supabase.getChannels().find(
    ch => ch.topic === `realtime:${channelName}`
  )
  if (existingChannel) {
    existingChannel.unsubscribe().then(() => {
      supabase.removeChannel(existingChannel)
    })
  }
  
  // ì‹¤ì‹œê°„ êµ¬ë…
  const channel = supabase
    .channel(channelName, {
      config: {
        broadcast: { self: false },
      },
    })
    .on(
      'postgres_changes',
      {
        event: '*',
        schema: 'public',
        table: 'messages',
        filter: `webinar_id=eq.${webinarId}`,
      },
      (payload) => {
        lastEventAt.current = Date.now() // ì´ë²¤íŠ¸ ìˆ˜ì‹  ì‹œê°„ ì—…ë°ì´íŠ¸
        reconnectTriesRef.current = 0 // ì¬ì—°ê²° ì‹œë„ íšŸìˆ˜ ë¦¬ì…‹
        
        // ì´ë²¤íŠ¸ ìˆ˜ì‹  ì‹œ í´ë°± ë„ê¸°
        if (fallbackOn) {
          setFallbackOn(false)
        }
        
        // ... ê¸°ì¡´ ì´ë²¤íŠ¸ ì²˜ë¦¬ ë¡œì§ ...
      }
    )
    .subscribe((status, err) => {
      console.log('ì‹¤ì‹œê°„ êµ¬ë… ìƒíƒœ:', status, err)
      
      if (status === 'SUBSCRIBED') {
        reconnectTriesRef.current = 0
        setFallbackOn(false)
        console.log('âœ… ì‹¤ì‹œê°„ êµ¬ë… ì„±ê³µ:', channelName)
      } else if (['CHANNEL_ERROR', 'TIMED_OUT', 'CLOSED'].includes(status)) {
        reconnectTriesRef.current++
        const delay = Math.min(500 * Math.pow(2, reconnectTriesRef.current - 1), 15000)
        
        console.warn(`âš ï¸ ì‹¤ì‹œê°„ êµ¬ë… ì‹¤íŒ¨ (${status}), ${delay}ms í›„ ì¬ì‹œë„...`)
        
        // 3íšŒ ì‹¤íŒ¨ ì‹œ í´ë°± í™œì„±í™”
        if (reconnectTriesRef.current >= 3) {
          console.warn('ğŸ”´ ì‹¤ì‹œê°„ êµ¬ë… 3íšŒ ì‹¤íŒ¨, í´ë°± í´ë§ í™œì„±í™”')
          setFallbackOn(true)
        }
        
        // ì¬ì—°ê²° ì‹œë„
        setTimeout(() => {
          channel.unsubscribe().then(() => {
            supabase.removeChannel(channel)
            // ì¬êµ¬ë…ì€ useEffect ì¬ì‹¤í–‰ìœ¼ë¡œ ì²˜ë¦¬ë¨
          })
        }, delay)
      }
    })
  
  return () => {
    channel.unsubscribe().then(() => {
      supabase.removeChannel(channel)
    }).catch((err) => {
      console.warn('ì±„ë„ êµ¬ë… í•´ì œ ì˜¤ë¥˜:', err)
    })
  }
}, [webinarId, supabase, fallbackOn])

// í—¬ìŠ¤ì²´í¬: 10ì´ˆ ë™ì•ˆ ì´ë²¤íŠ¸ê°€ ì—†ìœ¼ë©´ í´ë°± í™œì„±í™”
useEffect(() => {
  const healthCheckInterval = setInterval(() => {
    const timeSinceLastEvent = Date.now() - lastEventAt.current
    if (timeSinceLastEvent > 10000 && !fallbackOn) {
      console.warn('âš ï¸ 10ì´ˆ ë™ì•ˆ ì´ë²¤íŠ¸ ì—†ìŒ, í´ë°± í´ë§ í™œì„±í™”')
      setFallbackOn(true)
    }
  }, 5000) // 5ì´ˆë§ˆë‹¤ ì²´í¬
  
  return () => clearInterval(healthCheckInterval)
}, [fallbackOn])

// ì¡°ê±´ë¶€ í´ë°± í´ë§ (ì¦ë¶„ í´ë§ + ì§€í„° + ê°€ì‹œì„±/ì˜¤í”„ë¼ì¸ ê³ ë ¤)
useEffect(() => {
  if (!fallbackOn) return
  
  // ê°€ì‹œì„± ë° ì˜¨ë¼ì¸ ìƒíƒœ í™•ì¸
  const isVisible = document.visibilityState === 'visible'
  const isOnline = navigator.onLine
  
  if (!isVisible || !isOnline) {
    console.log('â¸ï¸ í´ë°± í´ë§ ì¼ì‹œ ì •ì§€ (ê°€ì‹œì„±/ì˜¤í”„ë¼ì¸)')
    return
  }
  
  console.log('ğŸ”„ í´ë°± í´ë§ ì‹œì‘')
  
  // ì§€í„°ê°€ í¬í•¨ëœ í´ë§ í•¨ìˆ˜
  const pollWithJitter = async () => {
    try {
      const response = await fetch(
        `/api/webinars/${webinarId}/messages?after=${lastMessageIdRef.current}`
      )
      
      if (response.ok) {
        const { messages } = await response.json()
        
        if (messages && messages.length > 0) {
          console.log(`ğŸ“¥ í´ë°± í´ë§: ${messages.length}ê°œ ë©”ì‹œì§€ ìˆ˜ì‹ `)
          
          setMessages((prev) => {
            const existingIds = new Set(prev.map(m => m.id))
            const newMessages = messages.filter((m: Message) => !existingIds.has(m.id))
            
            if (newMessages.length === 0) return prev
            
            const merged = [...prev, ...newMessages]
            const sorted = merged.sort(
              (a, b) => new Date(a.created_at).getTime() - new Date(b.created_at).getTime()
            )
            
            // ë§ˆì§€ë§‰ ë©”ì‹œì§€ ID ì—…ë°ì´íŠ¸
            lastMessageIdRef.current = Math.max(
              ...sorted.map(m => typeof m.id === 'number' ? m.id : 0)
            )
            
            return sorted
          })
          
          // ì´ë²¤íŠ¸ ìˆ˜ì‹  ì‹œê°„ ì—…ë°ì´íŠ¸
          lastEventAt.current = Date.now()
        }
      }
    } catch (error) {
      console.error('í´ë°± í´ë§ ì˜¤ë¥˜:', error)
    }
    
    // ì§€í„° ì ìš©: ê¸°ë³¸ 3ì´ˆ Â± 400ms ëœë¤
    const base = 3000
    const jitter = 400 - Math.random() * 800 // -400 ~ +400ms
    const nextDelay = base + jitter
    
    setTimeout(pollWithJitter, nextDelay)
  }
  
  // ì´ˆê¸° í´ë§ ì‹œì‘
  const timeoutId = setTimeout(pollWithJitter, 0)
  
  // ê°€ì‹œì„±/ì˜¨ë¼ì¸ ìƒíƒœ ë³€ê²½ ê°ì§€
  const handleVisibilityChange = () => {
    if (document.visibilityState === 'visible' && navigator.onLine) {
      // ë³µê·€ ì‹œ ì¦‰ì‹œ 1íšŒ í´ë§
      pollWithJitter()
    }
  }
  
  const handleOnline = () => {
    if (document.visibilityState === 'visible') {
      // ì˜¨ë¼ì¸ ë³µê·€ ì‹œ ì¦‰ì‹œ 1íšŒ í´ë§
      pollWithJitter()
    }
  }
  
  document.addEventListener('visibilitychange', handleVisibilityChange)
  window.addEventListener('online', handleOnline)
  
  return () => {
    console.log('ğŸ›‘ í´ë°± í´ë§ ì¤‘ì§€')
    clearTimeout(timeoutId)
    document.removeEventListener('visibilitychange', handleVisibilityChange)
    window.removeEventListener('online', handleOnline)
  }
}, [fallbackOn, webinarId])
```

#### 3.5.2 API ë¼ìš°íŠ¸ ìˆ˜ì • (ì¦ë¶„ í´ë§ ì§€ì›)

**íŒŒì¼**: `app/api/webinars/[webinarId]/messages/route.ts`

**ë³€ê²½ ì‚¬í•­**:

```typescript
export async function GET(
  req: Request,
  { params }: { params: Promise<{ webinarId: string }> }
) {
  try {
    const { webinarId } = await params
    const { searchParams } = new URL(req.url)
    const afterId = searchParams.get('after') // ì¦ë¶„ í´ë§ì„ ìœ„í•œ íŒŒë¼ë¯¸í„°
    
    const { user } = await requireAuth()
    const admin = createAdminSupabase()
    
    // ... ê¸°ì¡´ ì›¨ë¹„ë‚˜ í™•ì¸ ë° ë“±ë¡ ë¡œì§ ...
    
    // ë©”ì‹œì§€ ì¡°íšŒ ì¿¼ë¦¬ êµ¬ì„±
    let query = admin
      .from('messages')
      .select(`
        id,
        user_id,
        content,
        created_at,
        hidden,
        client_msg_id,
        profiles:user_id (
          display_name,
          email
        )
      `)
      .eq('webinar_id', webinarId)
      .eq('hidden', false)
    
    // ì¦ë¶„ í´ë§: afterIdê°€ ìˆìœ¼ë©´ í•´ë‹¹ ID ì´í›„ ë©”ì‹œì§€ë§Œ ì¡°íšŒ
    if (afterId) {
      query = query.gt('id', parseInt(afterId, 10))
    }
    
    query = query
      .order('created_at', { ascending: false })
      .limit(100)
    
    const { data: messages, error: messagesError } = await query
    
    // ... ê¸°ì¡´ ì—ëŸ¬ ì²˜ë¦¬ ë° ì‘ë‹µ ...
  } catch (error: any) {
    // ... ê¸°ì¡´ ì—ëŸ¬ ì²˜ë¦¬ ...
  }
}
```

**í…ŒìŠ¤íŠ¸ ì¼€ì´ìŠ¤**:
- âœ… WS 3íšŒ ì‹¤íŒ¨ ì‹œ í´ë°± í™œì„±í™”
- âœ… 10ì´ˆ ë¬´ì´ë²¤íŠ¸ ì‹œ í´ë°± í™œì„±í™”
- âœ… WS ë³µêµ¬ ì‹œ í´ë°± ìë™ ë¹„í™œì„±í™”
- âœ… ì¦ë¶„ í´ë§ìœ¼ë¡œ ì¤‘ë³µ ë©”ì‹œì§€ ë°©ì§€
- âœ… í´ë°± í´ë§ ì¤‘ì—ë„ ìƒˆ ë©”ì‹œì§€ ìˆ˜ì‹  í™•ì¸
- âœ… í´ë§ ì§€í„° ì ìš© í™•ì¸ (Â±400ms ëœë¤)
- âœ… íƒ­ ìˆ¨ê¹€ ì‹œ í´ë§ ì¼ì‹œ ì •ì§€
- âœ… ì˜¤í”„ë¼ì¸ ì‹œ í´ë§ ì¼ì‹œ ì •ì§€
- âœ… ë³µê·€ ì‹œ ì¦‰ì‹œ 1íšŒ í´ë§ í™•ì¸

---

### 3.6 íƒ€ì„ì•„ì›ƒ ì²˜ë¦¬ ê°•í™”

#### 3.6.1 Chat ì»´í¬ë„ŒíŠ¸ ìˆ˜ì •

**íŒŒì¼**: `components/webinar/Chat.tsx`

**ë³€ê²½ ì‚¬í•­** (ì´ë¯¸ 3.2ì—ì„œ ì¼ë¶€ êµ¬í˜„ë¨):

```typescript
// íƒ€ì„ì•„ì›ƒ ìƒìˆ˜ ì •ì˜
const API_TIMEOUT_MS = 10000 // 10ì´ˆ
const REALTIME_TIMEOUT_MS = 30000 // 30ì´ˆ

const handleSend = async (e: React.FormEvent) => {
  // ... ê¸°ì¡´ ì½”ë“œ ...
  
  const controller = new AbortController()
  const timeout = setTimeout(() => {
    controller.abort()
    console.warn('ë©”ì‹œì§€ ì „ì†¡ íƒ€ì„ì•„ì›ƒ')
  }, API_TIMEOUT_MS)
  
  try {
    const response = await fetch('/api/messages/create', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        webinarId,
        content: messageContent,
        clientMsgId,
      }),
      signal: controller.signal,
    })
    
    // ... ê¸°ì¡´ ì²˜ë¦¬ ...
  } catch (error: any) {
    if (error.name === 'AbortError') {
      // íƒ€ì„ì•„ì›ƒ ì²˜ë¦¬
      console.warn('ë©”ì‹œì§€ ì „ì†¡ íƒ€ì„ì•„ì›ƒ, Realtimeì„ ê¸°ë‹¤ë¦½ë‹ˆë‹¤')
      setSending(false)
      // Optimistic ë©”ì‹œì§€ëŠ” ìœ ì§€ (Realtimeìœ¼ë¡œ êµì²´ë  ìˆ˜ ìˆìŒ)
    } else {
      // ... ê¸°ì¡´ ì—ëŸ¬ ì²˜ë¦¬ ...
    }
  } finally {
    clearTimeout(timeout)
  }
}
```

**í…ŒìŠ¤íŠ¸ ì¼€ì´ìŠ¤**:
- âœ… 10ì´ˆ íƒ€ì„ì•„ì›ƒ ì •ìƒ ë™ì‘
- âœ… íƒ€ì„ì•„ì›ƒ ì‹œ Optimistic ë©”ì‹œì§€ ìœ ì§€
- âœ… íƒ€ì„ì•„ì›ƒ í›„ Realtimeìœ¼ë¡œ êµì²´ í™•ì¸

---

### 3.7 ì—ëŸ¬ ë³µêµ¬ ë¡œì§ ê°•í™”

#### 3.7.1 Chat ì»´í¬ë„ŒíŠ¸ ìˆ˜ì •

**íŒŒì¼**: `components/webinar/Chat.tsx`

**ë³€ê²½ ì‚¬í•­** (3.5ì—ì„œ ì¼ë¶€ êµ¬í˜„ë¨, ì¶”ê°€ ë³´ê°•):

```typescript
// ì¬ì—°ê²° ë¡œì§ ê°œì„ 
useEffect(() => {
  // ... ê¸°ì¡´ êµ¬ë… ì„¤ì • ...
  
  const channel = supabase
    .channel(channelName, {
      config: {
        broadcast: { self: false },
      },
    })
    .on('postgres_changes', { /* ... */ }, (payload) => {
      lastEventAt.current = Date.now()
      reconnectTriesRef.current = 0
      // ... ê¸°ì¡´ ì²˜ë¦¬ ...
    })
    .subscribe((status, err) => {
      if (status === 'SUBSCRIBED') {
        reconnectTriesRef.current = 0
        setFallbackOn(false)
        console.log('âœ… ì‹¤ì‹œê°„ êµ¬ë… ì„±ê³µ')
      } else if (['CHANNEL_ERROR', 'TIMED_OUT', 'CLOSED'].includes(status)) {
        reconnectTriesRef.current++
        
        // ì§€ìˆ˜ ë°±ì˜¤í”„ ì¬ì—°ê²°
        const delay = Math.min(
          500 * Math.pow(2, reconnectTriesRef.current - 1),
          15000
        )
        
        console.warn(`âš ï¸ ì‹¤ì‹œê°„ êµ¬ë… ì‹¤íŒ¨ (${status}), ${delay}ms í›„ ì¬ì‹œë„...`)
        
        if (reconnectTriesRef.current >= 3) {
          setFallbackOn(true)
        }
        
        // ì¬ì—°ê²° ì‹œë„
        setTimeout(() => {
          channel.unsubscribe().then(() => {
            supabase.removeChannel(channel)
            // useEffect ì¬ì‹¤í–‰ìœ¼ë¡œ ì¬êµ¬ë…
          })
        }, delay)
      }
    })
  
  return () => {
    channel.unsubscribe().then(() => {
      supabase.removeChannel(channel)
    })
  }
}, [webinarId, supabase, fallbackOn])
```

**í…ŒìŠ¤íŠ¸ ì¼€ì´ìŠ¤**:
- âœ… ì¼ì‹œì  ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ ì‹œ ìë™ ì¬ì—°ê²°
- âœ… ì§€ìˆ˜ ë°±ì˜¤í”„ë¡œ ì„œë²„ ë¶€í•˜ ë°©ì§€
- âœ… ì¬ì—°ê²° ì„±ê³µ ì‹œ í´ë°± ë¹„í™œì„±í™”

---

### 3.8 ìƒì„¸ ë¡œê¹… ì¶”ê°€

#### 3.8.1 ë¡œê¹… ìœ í‹¸ë¦¬í‹° ìƒì„±

**íŒŒì¼**: `lib/utils/logger.ts`

```typescript
type LogLevel = 'debug' | 'info' | 'warn' | 'error'

interface LogContext {
  component?: string
  webinarId?: string
  userId?: string
  [key: string]: any
}

class Logger {
  private isDevelopment = process.env.NODE_ENV === 'development'
  
  log(level: LogLevel, message: string, context?: LogContext) {
    if (!this.isDevelopment && level === 'debug') return
    
    const timestamp = new Date().toISOString()
    const contextStr = context ? ` [${JSON.stringify(context)}]` : ''
    
    const logMessage = `[${timestamp}] [${level.toUpperCase()}] ${message}${contextStr}`
    
    switch (level) {
      case 'debug':
        console.debug(logMessage)
        break
      case 'info':
        console.info(logMessage)
        break
      case 'warn':
        console.warn(logMessage)
        break
      case 'error':
        console.error(logMessage)
        break
    }
  }
  
  debug(message: string, context?: LogContext) {
    this.log('debug', message, context)
  }
  
  info(message: string, context?: LogContext) {
    this.log('info', message, context)
  }
  
  warn(message: string, context?: LogContext) {
    this.log('warn', message, context)
  }
  
  error(message: string, context?: LogContext) {
    this.log('error', message, context)
  }
}

export const logger = new Logger()
```

#### 3.8.2 Chat ì»´í¬ë„ŒíŠ¸ì— ë¡œê¹… ì ìš©

**íŒŒì¼**: `components/webinar/Chat.tsx`

```typescript
import { logger } from '@/lib/utils/logger'

// ì‚¬ìš© ì˜ˆì‹œ:
logger.info('ë©”ì‹œì§€ ì „ì†¡ ì‹œì‘', { webinarId, clientMsgId })
logger.warn('Realtime êµ¬ë… ì‹¤íŒ¨', { status, error })
logger.error('ë©”ì‹œì§€ ì „ì†¡ ì‹¤íŒ¨', { error: error.message })
```

**í…ŒìŠ¤íŠ¸ ì¼€ì´ìŠ¤**:
- âœ… ê°œë°œ í™˜ê²½ì—ì„œë§Œ ìƒì„¸ ë¡œê·¸ ì¶œë ¥
- âœ… í”„ë¡œë•ì…˜ í™˜ê²½ì—ì„œ ì—ëŸ¬ë§Œ ë¡œê¹…
- âœ… ì»¨í…ìŠ¤íŠ¸ ì •ë³´ í¬í•¨ í™•ì¸

---

### 3.9 CSP ì„¤ì • (ì»¤ìŠ¤í…€ ë„ë©”ì¸ ì‚¬ìš© ì‹œ)

#### 3.9.1 Next.js ì„¤ì • ìˆ˜ì •

**íŒŒì¼**: `next.config.ts`

**ë³€ê²½ ì‚¬í•­**:

```typescript
import type { NextConfig } from 'next'

const nextConfig: NextConfig = {
  async headers() {
    const customDomain = process.env.NEXT_PUBLIC_SUPABASE_URL?.includes('api.eventlive.ai')
      ? 'https://api.eventlive.ai'
      : null
    
    if (!customDomain) {
      return []
    }
    
    return [
      {
        source: '/:path*',
        headers: [
          {
            key: 'Content-Security-Policy',
            value: [
              "default-src 'self'",
              `connect-src 'self' ${customDomain} wss://${customDomain.replace('https://', '')} https://*.supabase.co wss://*.supabase.co`,
              "script-src 'self' 'unsafe-eval' 'unsafe-inline'",
              "style-src 'self' 'unsafe-inline'",
              "img-src 'self' data: https:",
              "font-src 'self' data:",
            ].join('; '),
          },
        ],
      },
    ]
  },
  async rewrites() {
    // ... ê¸°ì¡´ rewrites ...
  },
}

export default nextConfig
```

**í…ŒìŠ¤íŠ¸ ì¼€ì´ìŠ¤**:
- âœ… ì»¤ìŠ¤í…€ ë„ë©”ì¸ ì‚¬ìš© ì‹œ CSP ì ìš© í™•ì¸
- âœ… Realtime WebSocket ì—°ê²° í—ˆìš© í™•ì¸
- âœ… ì¼ë°˜ Supabase ë„ë©”ì¸ ì‚¬ìš© ì‹œ CSP ë¯¸ì ìš© í™•ì¸

---

## 4. í…ŒìŠ¤íŠ¸ ê³„íš

### 4.1 ë‹¨ìœ„ í…ŒìŠ¤íŠ¸

#### 4.1.1 `client_msg_id` ë§¤ì¹­ ë¡œì§
- âœ… ë™ì¼ `client_msg_id`ë¡œ ì •í™•í•œ ë§¤ì¹­
- âœ… `client_msg_id` ì—†ëŠ” ê¸°ì¡´ ë©”ì‹œì§€ì™€ì˜ í˜¸í™˜ì„±
- âœ… ì¤‘ë³µ ë©”ì‹œì§€ ë°©ì§€

#### 4.1.2 API ì¦‰ì‹œ êµì²´ ë¡œì§
- âœ… API ì„±ê³µ ì‹œ ì¦‰ì‹œ UI ì—…ë°ì´íŠ¸
- âœ… íƒ€ì„ì•„ì›ƒ ì‹œ Optimistic ë©”ì‹œì§€ ìœ ì§€
- âœ… ì—ëŸ¬ ì‹œ ë¡¤ë°± í™•ì¸

#### 4.1.3 í´ë°± í´ë§ ë¡œì§
- âœ… WS ì‹¤íŒ¨ ì‹œ í´ë°± í™œì„±í™”
- âœ… WS ë³µêµ¬ ì‹œ í´ë°± ë¹„í™œì„±í™”
- âœ… ì¦ë¶„ í´ë§ìœ¼ë¡œ ì¤‘ë³µ ë°©ì§€

### 4.2 í†µí•© í…ŒìŠ¤íŠ¸

#### 4.2.1 ë©”ì‹œì§€ ì „ì†¡ í”Œë¡œìš°
1. ë©”ì‹œì§€ ì…ë ¥ â†’ Optimistic ë©”ì‹œì§€ í‘œì‹œ
2. API í˜¸ì¶œ â†’ ì„±ê³µ ì‹œ ì¦‰ì‹œ êµì²´
3. Realtime INSERT â†’ ì¤‘ë³µ ë°©ì§€ í™•ì¸

#### 4.2.2 Realtime êµ¬ë… í”Œë¡œìš°
1. ì±„ë„ êµ¬ë… â†’ ì„±ê³µ í™•ì¸
2. ë©”ì‹œì§€ ìˆ˜ì‹  â†’ UI ì—…ë°ì´íŠ¸ í™•ì¸
3. êµ¬ë… ì‹¤íŒ¨ â†’ í´ë°± í™œì„±í™” í™•ì¸

### 4.3 E2E í…ŒìŠ¤íŠ¸

#### 4.3.1 í¬ë¡¬ í™˜ê²½ í…ŒìŠ¤íŠ¸
- âœ… ì‹œí¬ë¦¿ ëª¨ë“œì—ì„œ ì •ìƒ ë™ì‘ í™•ì¸
- âœ… í™•ì¥í”„ë¡œê·¸ë¨ ì°¨ë‹¨ í™˜ê²½ í…ŒìŠ¤íŠ¸
- âœ… "ì „ì†¡ ì¤‘..." ê³ ì°© ì—†ìŒ í™•ì¸

#### 4.3.2 ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ ì‹œë‚˜ë¦¬ì˜¤
- âœ… ë„¤íŠ¸ì›Œí¬ ëŠê¹€ â†’ í´ë°± í™œì„±í™”
- âœ… ë„¤íŠ¸ì›Œí¬ ë³µêµ¬ â†’ ìë™ ì¬ì—°ê²°
- âœ… íƒ€ì„ì•„ì›ƒ â†’ Optimistic ë©”ì‹œì§€ ìœ ì§€

### 4.4 ì„±ëŠ¥ í…ŒìŠ¤íŠ¸

#### 4.4.1 ë©”ì‹œì§€ ì „ì†¡ ì„±ëŠ¥
- âœ… API ì‘ë‹µ ì‹œê°„ ì¸¡ì •
- âœ… UI ì—…ë°ì´íŠ¸ ì§€ì—° ì‹œê°„ ì¸¡ì •
- âœ… Realtime ìˆ˜ì‹  ì§€ì—° ì‹œê°„ ì¸¡ì •

#### 4.4.2 í´ë°± í´ë§ ë¶€í•˜
- âœ… í´ë°± í™œì„±í™” ì‹œ ì„œë²„ ë¶€í•˜ ì¸¡ì •
- âœ… í´ë°± ë¹„í™œì„±í™” ì‹œ ë¶€í•˜ ê°ì†Œ í™•ì¸

---

## 5. ë°°í¬ ê³„íš

### 5.1 ë‹¨ê³„ë³„ ë°°í¬

#### Phase 1: ë°ì´í„°ë² ì´ìŠ¤ ë§ˆì´ê·¸ë ˆì´ì…˜ (í•„ìˆ˜)
1. `client_msg_id` ì¹¼ëŸ¼ ì¶”ê°€ ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹¤í–‰
2. ì¸ë±ìŠ¤ ë° ì œì•½ ì¡°ê±´ ìƒì„± í™•ì¸
3. ê¸°ì¡´ ë°ì´í„° í˜¸í™˜ì„± í™•ì¸

#### Phase 2: ë°±ì—”ë“œ API ì—…ë°ì´íŠ¸
1. `/api/messages/create` ë¼ìš°íŠ¸ ì—…ë°ì´íŠ¸
2. `/api/webinars/[webinarId]/messages` ë¼ìš°íŠ¸ ì—…ë°ì´íŠ¸ (ì¦ë¶„ í´ë§)
3. API í…ŒìŠ¤íŠ¸ ë° ê²€ì¦

#### Phase 3: í”„ë¡ íŠ¸ì—”ë“œ ì—…ë°ì´íŠ¸
1. `Chat.tsx` ì»´í¬ë„ŒíŠ¸ ì—…ë°ì´íŠ¸
2. `lib/supabase/client.ts` ì—…ë°ì´íŠ¸ (í† í° ì£¼ì…)
3. ë¡œì»¬ í…ŒìŠ¤íŠ¸ ë° ê²€ì¦

#### Phase 4: í†µí•© í…ŒìŠ¤íŠ¸
1. ì „ì²´ í”Œë¡œìš° í…ŒìŠ¤íŠ¸
2. í¬ë¡¬ í™˜ê²½ í…ŒìŠ¤íŠ¸
3. ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ ì‹œë‚˜ë¦¬ì˜¤ í…ŒìŠ¤íŠ¸

#### Phase 5: í”„ë¡œë•ì…˜ ë°°í¬
1. Vercelì— ë°°í¬
2. ëª¨ë‹ˆí„°ë§ ë° ë¡œê·¸ í™•ì¸
3. ì‚¬ìš©ì í”¼ë“œë°± ìˆ˜ì§‘

### 5.2 ë¡¤ë°± ê³„íš

#### ë¡¤ë°± ì¡°ê±´
- ì‹¬ê°í•œ ë²„ê·¸ ë°œê²¬
- ì„±ëŠ¥ ì €í•˜ ë°œìƒ
- ì‚¬ìš©ì ë¶ˆë§Œ ì¦ê°€

#### ë¡¤ë°± ì ˆì°¨
1. ì´ì „ ë²„ì „ìœ¼ë¡œ ì¦‰ì‹œ ë¡¤ë°±
2. ë¬¸ì œ ì›ì¸ ë¶„ì„
3. ìˆ˜ì • í›„ ì¬ë°°í¬

### 5.3 ëª¨ë‹ˆí„°ë§

#### ëª¨ë‹ˆí„°ë§ ì§€í‘œ
- ë©”ì‹œì§€ ì „ì†¡ ì„±ê³µë¥ 
- Realtime êµ¬ë… ì„±ê³µë¥ 
- í´ë°± í´ë§ í™œì„±í™” ë¹ˆë„
- API ì‘ë‹µ ì‹œê°„
- ì—ëŸ¬ ë°œìƒë¥ 
- **í´ë°± íŠ¸ë¦¬ê±°ìœ¨** (ë¶„ë‹¹/ì„¸ì…˜ë‹¹ í™œì„±í™” íšŸìˆ˜)
- **WS ì¬ì—°ê²° ì‹œë„ íšŸìˆ˜** (í‰ê· /ìµœëŒ€)
- **ì „ì†¡ íƒ€ì„ì•„ì›ƒë¥ ** (íƒ€ì„ì•„ì›ƒ ë°œìƒ ë¹„ìœ¨)

#### ëª¨ë‹ˆí„°ë§ ì´ë²¤íŠ¸ ìŠ¤í‚¤ë§ˆ
```typescript
interface MonitoringEvent {
  type: 'fallback_activated' | 'reconnect_attempt' | 'send_timeout' | 'send_success' | 'send_error'
  timestamp: number
  webinarId?: string
  userId?: string
  metadata?: {
    reconnectTries?: number
    timeSinceLastEvent?: number
    errorMessage?: string
  }
}
```

#### ì•Œë¦¼ ì„¤ì •
- ì—ëŸ¬ìœ¨ ì„ê³„ê°’ ì´ˆê³¼ ì‹œ ì•Œë¦¼
- í´ë°± í´ë§ ë¹ˆë²ˆ í™œì„±í™” ì‹œ ì•Œë¦¼ (ì˜ˆ: ë¶„ë‹¹ 3íšŒ ì´ìƒ)
- WS ì¬ì—°ê²° ì‹œë„ ê³¼ë‹¤ ì‹œ ì•Œë¦¼ (ì˜ˆ: ì„¸ì…˜ë‹¹ 10íšŒ ì´ìƒ)
- ì „ì†¡ íƒ€ì„ì•„ì›ƒë¥  ì„ê³„ê°’ ì´ˆê³¼ ì‹œ ì•Œë¦¼ (ì˜ˆ: 5% ì´ìƒ)
- ì„±ëŠ¥ ì €í•˜ ì‹œ ì•Œë¦¼

---

## 6. ì¼ì • ë° ë§ˆì¼ìŠ¤í†¤

### 6.1 ê°œë°œ ì¼ì •

#### Week 1: í•µì‹¬ ê¸°ëŠ¥ êµ¬í˜„
- **Day 1-2**: `client_msg_id` ì¹¼ëŸ¼ ì¶”ê°€ ë° ì—°ë™
- **Day 3**: API ì¦‰ì‹œ êµì²´ ë¡œì§ êµ¬í˜„
- **Day 4**: Realtime í† í° ì£¼ì… êµ¬í˜„
- **Day 5**: í…ŒìŠ¤íŠ¸ ë° ë²„ê·¸ ìˆ˜ì •

#### Week 2: ì•ˆì •ì„± ê°œì„ 
- **Day 1-2**: ê³ ì • ì±„ë„ëª… ë° ì¤‘ë³µ êµ¬ë… ë°©ì§€
- **Day 3-4**: ì¡°ê±´ë¶€ í´ë°± í´ë§ êµ¬í˜„
- **Day 5**: í†µí•© í…ŒìŠ¤íŠ¸ ë° ë²„ê·¸ ìˆ˜ì •

#### Week 3: ì¶”ê°€ ê°œì„  ë° ë°°í¬
- **Day 1**: íƒ€ì„ì•„ì›ƒ ì²˜ë¦¬ ê°•í™”
- **Day 2**: ì—ëŸ¬ ë³µêµ¬ ë¡œì§ ê°•í™”
- **Day 3**: ìƒì„¸ ë¡œê¹… ì¶”ê°€
- **Day 4**: CSP ì„¤ì • (í•„ìš” ì‹œ)
- **Day 5**: ìµœì¢… í…ŒìŠ¤íŠ¸ ë° ë°°í¬

### 6.2 ë§ˆì¼ìŠ¤í†¤

#### Milestone 1: í•µì‹¬ ê¸°ëŠ¥ ì™„ì„± (Week 1 ì¢…ë£Œ)
- âœ… `client_msg_id` êµ¬í˜„ ì™„ë£Œ
- âœ… API ì¦‰ì‹œ êµì²´ ë¡œì§ ì™„ë£Œ
- âœ… Realtime í† í° ì£¼ì… ì™„ë£Œ

#### Milestone 2: ì•ˆì •ì„± ê°œì„  ì™„ì„± (Week 2 ì¢…ë£Œ)
- âœ… ê³ ì • ì±„ë„ëª… êµ¬í˜„ ì™„ë£Œ
- âœ… ì¡°ê±´ë¶€ í´ë°± í´ë§ êµ¬í˜„ ì™„ë£Œ
- âœ… í†µí•© í…ŒìŠ¤íŠ¸ ì™„ë£Œ

#### Milestone 3: ìµœì¢… ë°°í¬ (Week 3 ì¢…ë£Œ)
- âœ… ëª¨ë“  ê°œì„  ì‚¬í•­ ì™„ë£Œ
- âœ… í”„ë¡œë•ì…˜ ë°°í¬ ì™„ë£Œ
- âœ… ëª¨ë‹ˆí„°ë§ ì„¤ì • ì™„ë£Œ

---

## 7. ë¦¬ìŠ¤í¬ ê´€ë¦¬

### 7.1 ê¸°ìˆ ì  ë¦¬ìŠ¤í¬

#### ë¦¬ìŠ¤í¬ 1: ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹¤íŒ¨
- **í™•ë¥ **: ë‚®ìŒ
- **ì˜í–¥**: ë†’ìŒ
- **ëŒ€ì‘**: ë°±ì—… í›„ ë§ˆì´ê·¸ë ˆì´ì…˜, ë¡¤ë°± ê³„íš ìˆ˜ë¦½

#### ë¦¬ìŠ¤í¬ 2: í•˜ìœ„ í˜¸í™˜ì„± ë¬¸ì œ
- **í™•ë¥ **: ì¤‘ê°„
- **ì˜í–¥**: ì¤‘ê°„
- **ëŒ€ì‘**: ê¸°ì¡´ ë°ì´í„° í˜¸í™˜ì„± í…ŒìŠ¤íŠ¸, ì ì§„ì  ë°°í¬

#### ë¦¬ìŠ¤í¬ 3: ì„±ëŠ¥ ì €í•˜
- **í™•ë¥ **: ë‚®ìŒ
- **ì˜í–¥**: ì¤‘ê°„
- **ëŒ€ì‘**: ì„±ëŠ¥ í…ŒìŠ¤íŠ¸, ëª¨ë‹ˆí„°ë§ ê°•í™”

### 7.2 ìš´ì˜ ë¦¬ìŠ¤í¬

#### ë¦¬ìŠ¤í¬ 4: ì‚¬ìš©ì ë¶ˆë§Œ
- **í™•ë¥ **: ë‚®ìŒ
- **ì˜í–¥**: ë†’ìŒ
- **ëŒ€ì‘**: ì ì§„ì  ë°°í¬, í”¼ë“œë°± ìˆ˜ì§‘, ë¹ ë¥¸ ëŒ€ì‘

#### ë¦¬ìŠ¤í¬ 5: ì„œë²„ ë¶€í•˜ ì¦ê°€
- **í™•ë¥ **: ë‚®ìŒ
- **ì˜í–¥**: ì¤‘ê°„
- **ëŒ€ì‘**: í´ë°± í´ë§ ìµœì í™”, ì„œë²„ ëª¨ë‹ˆí„°ë§

---

## 8. ì°¸ê³  ìë£Œ

### 8.1 ê´€ë ¨ ë¬¸ì„œ
- `í•´ê²°ì±….md`: ì›ë³¸ í•´ê²°ì±… ë¬¸ì„œ
- `docs/chat-implementation.md`: ì±„íŒ… ì‹œìŠ¤í…œ êµ¬í˜„ ë¬¸ì„œ
- `memory_bank/systemPatterns.md`: ì‹œìŠ¤í…œ íŒ¨í„´ ë¬¸ì„œ

### 8.2 ì™¸ë¶€ ìë£Œ
- [Supabase Realtime ë¬¸ì„œ](https://supabase.com/docs/guides/realtime)
- [Next.js App Router ë¬¸ì„œ](https://nextjs.org/docs/app)
- [React Optimistic Updates íŒ¨í„´](https://react.dev/reference/react/useOptimistic)

---

## 9. ì²´í¬ë¦¬ìŠ¤íŠ¸

### 9.1 ê°œë°œ ì²´í¬ë¦¬ìŠ¤íŠ¸

#### ë°ì´í„°ë² ì´ìŠ¤
- [ ] `client_msg_id` ì¹¼ëŸ¼ ì¶”ê°€ ë§ˆì´ê·¸ë ˆì´ì…˜ ì‘ì„±
- [ ] ì¸ë±ìŠ¤ ë° ì œì•½ ì¡°ê±´ ìƒì„± (`idx_messages_client_msg_id`, `idx_messages_webinar_id_id`)
- [ ] ë§ˆì´ê·¸ë ˆì´ì…˜ í…ŒìŠ¤íŠ¸

#### ë°±ì—”ë“œ
- [ ] `/api/messages/create` ë¼ìš°íŠ¸ ìˆ˜ì •
  - [ ] ì‘ë‹µ ìŠ¤í‚¤ë§ˆ ì¼ê´€í™” (`success`, `message`, `error`)
  - [ ] ì¤‘ë³µ ë©”ì‹œì§€ 409 ì‘ë‹µ ì²˜ë¦¬
- [ ] `/api/webinars/[webinarId]/messages` ë¼ìš°íŠ¸ ìˆ˜ì • (ì¦ë¶„ í´ë§)
- [ ] API í…ŒìŠ¤íŠ¸ ì‘ì„±

#### í”„ë¡ íŠ¸ì—”ë“œ
- [ ] `Chat.tsx` ì»´í¬ë„ŒíŠ¸ ìˆ˜ì •
  - [ ] ì¤‘ë³µ ì „ì†¡ ë°©ì§€ ë¡œì§ ì¶”ê°€
  - [ ] í´ë§ ì§€í„° ì ìš©
  - [ ] ê°€ì‹œì„±/ì˜¤í”„ë¼ì¸ ì²˜ë¦¬
  - [ ] DELETE/UPDATE payload ê²€ì¦
- [ ] `lib/supabase/client.ts` ìˆ˜ì • (í† í° ì£¼ì…)
- [ ] `lib/utils/logger.ts` ìƒì„±
- [ ] ëª¨ë‹ˆí„°ë§ ì´ë²¤íŠ¸ ìˆ˜ì§‘ ë¡œì§ ì¶”ê°€
- [ ] ì»´í¬ë„ŒíŠ¸ í…ŒìŠ¤íŠ¸ ì‘ì„±

### 9.2 í…ŒìŠ¤íŠ¸ ì²´í¬ë¦¬ìŠ¤íŠ¸

#### ë‹¨ìœ„ í…ŒìŠ¤íŠ¸
- [ ] `client_msg_id` ë§¤ì¹­ ë¡œì§ í…ŒìŠ¤íŠ¸
- [ ] API ì¦‰ì‹œ êµì²´ ë¡œì§ í…ŒìŠ¤íŠ¸
- [ ] í´ë°± í´ë§ ë¡œì§ í…ŒìŠ¤íŠ¸

#### í†µí•© í…ŒìŠ¤íŠ¸
- [ ] ë©”ì‹œì§€ ì „ì†¡ í”Œë¡œìš° í…ŒìŠ¤íŠ¸
- [ ] Realtime êµ¬ë… í”Œë¡œìš° í…ŒìŠ¤íŠ¸

#### E2E í…ŒìŠ¤íŠ¸
- [ ] í¬ë¡¬ í™˜ê²½ í…ŒìŠ¤íŠ¸
- [ ] ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ ì‹œë‚˜ë¦¬ì˜¤ í…ŒìŠ¤íŠ¸

### 9.3 ë°°í¬ ì²´í¬ë¦¬ìŠ¤íŠ¸

#### ë°°í¬ ì „
- [ ] ëª¨ë“  í…ŒìŠ¤íŠ¸ í†µê³¼ í™•ì¸
- [ ] ì½”ë“œ ë¦¬ë·° ì™„ë£Œ
- [ ] ë¬¸ì„œ ì—…ë°ì´íŠ¸ ì™„ë£Œ

#### ë°°í¬ ì¤‘
- [ ] ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹¤í–‰
- [ ] API ë°°í¬
- [ ] í”„ë¡ íŠ¸ì—”ë“œ ë°°í¬

#### ë°°í¬ í›„
- [ ] ëª¨ë‹ˆí„°ë§ ì„¤ì • í™•ì¸
  - [ ] í´ë°± íŠ¸ë¦¬ê±°ìœ¨ ìˆ˜ì§‘ í™•ì¸
  - [ ] WS ì¬ì—°ê²° ì‹œë„ íšŸìˆ˜ ìˆ˜ì§‘ í™•ì¸
  - [ ] ì „ì†¡ íƒ€ì„ì•„ì›ƒë¥  ìˆ˜ì§‘ í™•ì¸
- [ ] ì‚¬ìš©ì í”¼ë“œë°± ìˆ˜ì§‘
- [ ] ì„±ëŠ¥ ì§€í‘œ í™•ì¸

---

## 10. ê²°ë¡ 

ì´ êµ¬í˜„ ê³„íšì€ í¬ë¡¬ í™˜ê²½ì—ì„œì˜ "ì „ì†¡ ì¤‘..." ê³ ì°© ë¬¸ì œë¥¼ í•´ê²°í•˜ê³ , Realtime ì•ˆì •ì„±ì„ í–¥ìƒì‹œí‚¤ê¸° ìœ„í•œ ì¢…í•©ì ì¸ ê°œì„  ë°©ì•ˆì„ ì œì‹œí•©ë‹ˆë‹¤. ìš°ì„ ìˆœìœ„ë³„ë¡œ ë‹¨ê³„ì  êµ¬í˜„ì„ í†µí•´ ë¦¬ìŠ¤í¬ë¥¼ ìµœì†Œí™”í•˜ê³ , ì² ì €í•œ í…ŒìŠ¤íŠ¸ì™€ ëª¨ë‹ˆí„°ë§ì„ í†µí•´ ì•ˆì •ì ì¸ ë°°í¬ë¥¼ ë³´ì¥í•©ë‹ˆë‹¤.

**í•µì‹¬ ê°œì„  ì‚¬í•­ ìš”ì•½**:
1. âœ… `client_msg_id`ë¡œ ì •í™•í•œ ë©”ì‹œì§€ ë§¤ì¹­
2. âœ… API ì„±ê³µ ì¦‰ì‹œ UI êµì²´ë¡œ ê³ ì°© ë¬¸ì œ í•´ê²°
3. âœ… Realtime í† í° ì£¼ì…ìœ¼ë¡œ í¬ë¡¬ í˜¸í™˜ì„± ë³´ì¥
4. âœ… ì¡°ê±´ë¶€ í´ë°± í´ë§ìœ¼ë¡œ íŠ¹ìˆ˜ í™˜ê²½ ëŒ€ì‘
5. âœ… ê°•í™”ëœ ì—ëŸ¬ ì²˜ë¦¬ ë° ë³µêµ¬ ë¡œì§

**ì˜ˆìƒ íš¨ê³¼**:
- í¬ë¡¬ í™˜ê²½ì—ì„œ "ì „ì†¡ ì¤‘..." ê³ ì°© ë¬¸ì œ ì™„ì „ í•´ê²°
- Realtime ì•ˆì •ì„± í–¥ìƒ (ìë™ ì¬ì—°ê²°, í´ë°± í´ë§)
- ì‚¬ìš©ì ê²½í—˜ ê°œì„  (ì¦‰ê°ì ì¸ í”¼ë“œë°±)
- ë””ë²„ê¹… ìš©ì´ì„± í–¥ìƒ (ìƒì„¸ ë¡œê¹…)

---

---

## 11. ì¶”ê°€ ë³´ì™„ ì‚¬í•­ (í•´ê²°ì±….md ê²€í†  ë°˜ì˜)

### 11.1 ì¦ë¶„ í´ë§ ì¸ë±ìŠ¤ ìµœì í™”

**ëª©ì **: ëŒ€í˜• ì›¨ë¹„ë‚˜ì—ì„œ ì¦ë¶„ í´ë§ ì¿¼ë¦¬ ì„±ëŠ¥ í–¥ìƒ

**êµ¬í˜„**: 
- ë³µí•© ì¸ë±ìŠ¤ `(webinar_id, id)` ì¶”ê°€
- `WHERE webinar_id = $1 AND id > $2` ì¿¼ë¦¬ ìµœì í™”

**íŒŒì¼**: `supabase/migrations/012_add_client_msg_id_to_messages.sql`

```sql
CREATE INDEX IF NOT EXISTS idx_messages_webinar_id_id
ON public.messages (webinar_id, id);
```

**íš¨ê³¼**: ë²”ìœ„ ìŠ¤ìº” ë¹„ìš© ê°ì†Œ, ëŒ€ëŸ‰ ë©”ì‹œì§€ í™˜ê²½ì—ì„œ ì„±ëŠ¥ í–¥ìƒ

---

### 11.2 ì¤‘ë³µ ì „ì†¡ ë°©ì§€

**ëª©ì **: ë”ë¸” í´ë¦­/Enter ë°”ìš´ìŠ¤ë¡œ ì¸í•œ ì¤‘ë³µ ë©”ì‹œì§€ ì „ì†¡ ë°©ì§€

**êµ¬í˜„**:
- `client_msg_id` ê¸°ë°˜ ì¤‘ë³µ ì „ì†¡ ì°¨ë‹¨
- ì „ì†¡ ë²„íŠ¼ 1-2ì´ˆ ë¹„í™œì„±í™”
- DB ìœ ë‹ˆí¬ ì œì•½ ì¡°ê±´ê³¼ ì—°ê³„

**íš¨ê³¼**: UX ì•ˆì •ì„± í–¥ìƒ, ë¶ˆí•„ìš”í•œ API í˜¸ì¶œ ê°ì†Œ

---

### 11.3 í´ë§ ì§€í„° ì ìš©

**ëª©ì **: ë™ì‹œ ì ‘ì† ì‹œ ì„œë²„ ìŠ¤íŒŒì´í¬ ë°©ì§€

**êµ¬í˜„**:
- ê¸°ë³¸ 3ì´ˆ ê°„ê²©ì— Â±400ms ëœë¤ ì§€í„° ì¶”ê°€
- `setTimeout` ê¸°ë°˜ ë¹„ë™ê¸° í´ë§

**íš¨ê³¼**: ì„œë²„ ë¶€í•˜ ë¶„ì‚°, "ë–¼ì°½" í˜„ìƒ ë°©ì§€

---

### 11.4 ê°€ì‹œì„±/ì˜¤í”„ë¼ì¸ ê³ ë ¤

**ëª©ì **: ë¶ˆí•„ìš”í•œ í´ë§ íŠ¸ë˜í”½ ê°ì†Œ ë° ë°°í„°ë¦¬ ì ˆì•½

**êµ¬í˜„**:
- `document.visibilityState` ì²´í¬
- `navigator.onLine` ì²´í¬
- ë³µê·€ ì‹œ ì¦‰ì‹œ 1íšŒ í´ë§

**íš¨ê³¼**: ë¦¬ì†ŒìŠ¤ íš¨ìœ¨ì„± í–¥ìƒ, ì‚¬ìš©ì ê²½í—˜ ê°œì„ 

---

### 11.5 DELETE/UPDATE ì•ˆì • ìˆ˜ì‹ 

**ëª©ì **: Realtime ì´ë²¤íŠ¸ payload ê²€ì¦ ê°•í™”

**êµ¬í˜„**:
- UPDATE/DELETE ì´ë²¤íŠ¸ì—ì„œ `id` í•„ìˆ˜ í™•ì¸
- payload ëˆ„ë½ ì‹œ ê²½ê³  ë¡œê·¸ ë° ë¬´ì‹œ

**íš¨ê³¼**: ì˜ˆì™¸ ìƒí™© ì²˜ë¦¬ ì•ˆì •ì„± í–¥ìƒ

---

### 11.6 ì „ì†¡ ë¼ìš°íŠ¸ ì‘ë‹µ ì¼ê´€í™”

**ëª©ì **: í”„ë¡ íŠ¸ì—”ë“œ ì—ëŸ¬ ì²˜ë¦¬ ë‹¨ìˆœí™”

**êµ¬í˜„**:
- ëª¨ë“  ë¶„ê¸°ì—ì„œ `{ success: boolean, message?: ..., error?: string }` ìŠ¤í‚¤ë§ˆ í†µì¼
- 2xx/4xx/5xx ëª¨ë‘ ì¦‰ì‹œ JSON ì¢…ë£Œ ë³´ì¥

**íš¨ê³¼**: ì½”ë“œ ë‹¨ìˆœí™”, ì—ëŸ¬ ì²˜ë¦¬ ì¼ê´€ì„± í–¥ìƒ

---

### 11.7 ìš´ì˜ì§€í‘œ ì¶”ê°€

**ëª©ì **: í¬ë¡¬/ê¸°ì—…ë§ ì´ìŠˆ ë¹ˆë„ ì¸¡ì • ë° ì˜ì‚¬ê²°ì • ê·¼ê±° í™•ë³´

**êµ¬í˜„**:
- í´ë°± íŠ¸ë¦¬ê±°ìœ¨ (ë¶„ë‹¹/ì„¸ì…˜ë‹¹)
- WS ì¬ì—°ê²° ì‹œë„ íšŸìˆ˜
- ì „ì†¡ íƒ€ì„ì•„ì›ƒë¥ 

**ëª¨ë‹ˆí„°ë§ ì´ë²¤íŠ¸ ìŠ¤í‚¤ë§ˆ**:
```typescript
interface MonitoringEvent {
  type: 'fallback_activated' | 'reconnect_attempt' | 'send_timeout' | 'send_success' | 'send_error'
  timestamp: number
  webinarId?: string
  userId?: string
  metadata?: {
    reconnectTries?: number
    timeSinceLastEvent?: number
    errorMessage?: string
  }
}
```

**íš¨ê³¼**: ë¬¸ì œ ë°œìƒ ë¹ˆë„ ì •ëŸ‰í™”, ê°œì„  ìš°ì„ ìˆœìœ„ ê²°ì • ê·¼ê±° ì œê³µ

---

**ì‘ì„±ì¼**: 2025-01-13  
**ìµœì¢… ìˆ˜ì •ì¼**: 2025-01-13  
**ë²„ì „**: 1.1.0 (ë³´ì™„ ì‚¬í•­ ë°˜ì˜)  
**ì‘ì„±ì**: AI Assistant

