# ë§í¬ ì¶”ì  êµ¬ì¡° ê°œì„  ë°©ì•ˆ

**ì‘ì„±ì¼**: 2026-02-02  
**ë¬¸ì œ**: ë§í¬ë¥¼ í†µí•´ ë“¤ì–´ì˜¨ ìœ ì…ì˜ 99.8%ê°€ `marketing_campaign_link_id` ì €ì¥ ì‹¤íŒ¨  
**ëª©í‘œ**: ë¦¬ë‹¤ì´ë ‰íŠ¸ ì²´ì¸ì—ì„œ ì¶”ì  ì •ë³´ ìœ ì§€ ë³´ì¥

---

## ğŸ“‹ ëª©ì°¨

1. [í˜„ì¬ ë¬¸ì œì ](#í˜„ì¬-ë¬¸ì œì )
2. [ê°œì„  ë°©ì•ˆ](#ê°œì„ -ë°©ì•ˆ)
3. [êµ¬í˜„ ëª…ì„¸](#êµ¬í˜„-ëª…ì„¸)
4. [ë§ˆì´ê·¸ë ˆì´ì…˜ ê³„íš](#ë§ˆì´ê·¸ë ˆì´ì…˜-ê³„íš)

---

## í˜„ì¬ ë¬¸ì œì 

### ğŸ”´ ì¹˜ëª…ì  êµ¬ì¡°ì  ê²°í•¨

1. **URL íŒŒë¼ë¯¸í„°ì—ë§Œ ì˜ì¡´**
   - ë¦¬ë‹¤ì´ë ‰íŠ¸ ê³¼ì •ì—ì„œ `cid`, `utm_*` íŒŒë¼ë¯¸í„° ìœ ì‹¤
   - Next.js `redirect()` ì‚¬ìš© ì‹œ ì¿¼ë¦¬ íŒŒë¼ë¯¸í„° ì „ë‹¬ ëˆ„ë½ ê°€ëŠ¥

2. **ì„œë²„ ì„¸ì…˜ ë¶€ì¬**
   - í´ë¼ì´ì–¸íŠ¸ ì‚¬ì´ë“œ `localStorage`ë§Œ ì‚¬ìš©
   - ì„œë²„ ì‚¬ì´ë“œ ë¦¬ë‹¤ì´ë ‰íŠ¸ ì‹œ ì •ë³´ ì†ì‹¤

3. **ì¶”ì  ì •ë³´ ë³µì› ë¶ˆê°€**
   - ì›ë³¸ ì¶”ì  ì •ë³´ê°€ ì €ì¥ë˜ì§€ ì•ŠìŒ
   - ë¬¸ì œ ë°œìƒ ì‹œ ë””ë²„ê¹…/ë³µì› ë¶ˆê°€ëŠ¥

---

## ê°œì„  ë°©ì•ˆ

### âœ… 3ë‹¨ê³„ ë°©ì–´ ì „ëµ

#### 1ë‹¨ê³„: ì„œë²„ ì„¸ì…˜ ê³ ì • (ìµœìš°ì„ )

**ëª©ì **: ë¦¬ë‹¤ì´ë ‰íŠ¸ ì²´ì¸ì—ì„œ ì¶”ì  ì •ë³´ ë³´ì¡´

**êµ¬í˜„**:
- ìµœì´ˆ ë§í¬ ì ‘ê·¼ ì‹œ ì„œë²„ ì„¸ì…˜ ë˜ëŠ” signed cookieì— ì €ì¥
- ì´í›„ ëª¨ë“  ë¦¬ë‹¤ì´ë ‰íŠ¸ì—ì„œ ìë™ ë³µì›

#### 2ë‹¨ê³„: ë‹¤ì¤‘ ì†ŒìŠ¤ ë³µì›

**ëª©ì **: í•˜ë‚˜ì˜ ì†ŒìŠ¤ê°€ ì‹¤íŒ¨í•´ë„ ë‹¤ë¥¸ ì†ŒìŠ¤ì—ì„œ ë³µì›

**ìš°ì„ ìˆœìœ„**:
```
1. URL ì¿¼ë¦¬ íŒŒë¼ë¯¸í„° (ê°€ì¥ ì •í™•)
2. ì„œë²„ ì„¸ì…˜/cookie (ë¦¬ë‹¤ì´ë ‰íŠ¸ ë³´í˜¸)
3. ë§í¬ ë©”íƒ€ë°ì´í„° (fallback)
```

#### 3ë‹¨ê³„: ì¶”ì  ìŠ¤ëƒ…ìƒ· ì €ì¥

**ëª©ì **: í–¥í›„ ê°ì‚¬/ë³µì›/ë””ë²„ê¹…ìš© ì›ë³¸ ë³´ì¡´

**ì €ì¥ ì •ë³´**:
```typescript
tracking_snapshot: {
  cid: string | null,
  utm_source: string | null,
  utm_medium: string | null,
  utm_campaign: string | null,
  utm_term: string | null,
  utm_content: string | null,
  referer: string | null,
  user_agent: string | null,
  first_visit_at: string | null,
  link_id: string | null,
  captured_at: string,
  source: 'url' | 'session' | 'link_meta' | 'cookie'
}
```

---

## êµ¬í˜„ ëª…ì„¸

### 1. ë°ì´í„°ë² ì´ìŠ¤ ìŠ¤í‚¤ë§ˆ ë³€ê²½

#### `event_survey_entries` í…Œì´ë¸” í™•ì¥

```sql
-- ì¶”ì  ìŠ¤ëƒ…ìƒ· JSON í•„ë“œ ì¶”ê°€
ALTER TABLE public.event_survey_entries
  ADD COLUMN IF NOT EXISTS tracking_snapshot JSONB;

-- ì¸ë±ìŠ¤ ì¶”ê°€ (ë””ë²„ê¹…/ë¶„ì„ìš©)
CREATE INDEX IF NOT EXISTS idx_entries_tracking_snapshot_cid
  ON public.event_survey_entries((tracking_snapshot->>'cid'))
  WHERE tracking_snapshot IS NOT NULL;

CREATE INDEX IF NOT EXISTS idx_entries_tracking_snapshot_link_id
  ON public.event_survey_entries((tracking_snapshot->>'link_id'))
  WHERE tracking_snapshot IS NOT NULL;

-- ì½”ë©˜íŠ¸ ì¶”ê°€
COMMENT ON COLUMN public.event_survey_entries.tracking_snapshot IS 
  'ì¶”ì  ì •ë³´ ì›ë³¸ ìŠ¤ëƒ…ìƒ· (ê°ì‚¬/ë³µì›/ë””ë²„ê¹…ìš©). URL, ì„¸ì…˜, ë§í¬ ë©”íƒ€ ë“± ëª¨ë“  ì†ŒìŠ¤ì˜ ì›ë³¸ ì •ë³´ ë³´ì¡´';
```

---

### 2. ì„œë²„ ì„¸ì…˜ ê´€ë¦¬ (Next.js Middleware)

#### íŒŒì¼: `middleware.ts`

```typescript
import { NextResponse } from 'next/server'
import type { NextRequest } from 'next/server'
import { createServerClient } from '@supabase/ssr'

export async function middleware(request: NextRequest) {
  const response = NextResponse.next()
  
  // UTM íŒŒë¼ë¯¸í„° ì¶”ì¶œ
  const url = new URL(request.url)
  const cid = url.searchParams.get('cid')
  const utmSource = url.searchParams.get('utm_source')
  const utmMedium = url.searchParams.get('utm_medium')
  const utmCampaign = url.searchParams.get('utm_campaign')
  
  // ì¶”ì  ì •ë³´ê°€ ìˆìœ¼ë©´ ì„¸ì…˜ì— ì €ì¥
  if (cid || utmSource || utmMedium) {
    const trackingData = {
      cid: cid || null,
      utm_source: utmSource || null,
      utm_medium: utmMedium || null,
      utm_campaign: utmCampaign || null,
      utm_term: url.searchParams.get('utm_term') || null,
      utm_content: url.searchParams.get('utm_content') || null,
      referer: request.headers.get('referer') || null,
      user_agent: request.headers.get('user-agent') || null,
      captured_at: new Date().toISOString(),
    }
    
    // Signed cookieì— ì €ì¥ (30ì¼ ìœ íš¨)
    response.cookies.set('ef_tracking', JSON.stringify(trackingData), {
      httpOnly: true,
      secure: process.env.NODE_ENV === 'production',
      sameSite: 'lax',
      maxAge: 30 * 24 * 60 * 60, // 30ì¼
      path: '/',
    })
  }
  
  return response
}

export const config = {
  matcher: [
    '/event/:path*',
    '/webinar/:path*',
    '/s/:path*',
  ],
}
```

---

### 3. ë“±ë¡ API ê°œì„ 

#### íŒŒì¼: `app/api/public/event-survey/[campaignId]/register/route.ts`

**ë³€ê²½ ì‚¬í•­**:

1. **ë‹¤ì¤‘ ì†ŒìŠ¤ì—ì„œ ì¶”ì  ì •ë³´ ë³µì›**

```typescript
// ì¶”ì  ì •ë³´ ë³µì› í•¨ìˆ˜
async function restoreTrackingInfo(
  req: Request,
  campaignId: string,
  campaign: any
): Promise<{
  cid: string | null
  utmParams: Record<string, string | null>
  linkId: string | null
  trackingSnapshot: any
}> {
  const url = new URL(req.url)
  const body = await req.json().catch(() => ({}))
  
  // 1ìˆœìœ„: URL ì¿¼ë¦¬ íŒŒë¼ë¯¸í„°
  let cid = url.searchParams.get('cid') || body.cid || null
  let utmParams = {
    utm_source: url.searchParams.get('utm_source') || body.utm_source || null,
    utm_medium: url.searchParams.get('utm_medium') || body.utm_medium || null,
    utm_campaign: url.searchParams.get('utm_campaign') || body.utm_campaign || null,
    utm_term: url.searchParams.get('utm_term') || body.utm_term || null,
    utm_content: url.searchParams.get('utm_content') || body.utm_content || null,
  }
  
  // 2ìˆœìœ„: ì„œë²„ ì„¸ì…˜/cookie
  if (!cid || !utmParams.utm_source) {
    const cookie = req.headers.get('cookie')
    const trackingCookie = cookie?.split(';')
      .find(c => c.trim().startsWith('ef_tracking='))
    
    if (trackingCookie) {
      try {
        const trackingData = JSON.parse(
          decodeURIComponent(trackingCookie.split('=')[1])
        )
        
        if (!cid && trackingData.cid) {
          cid = trackingData.cid
        }
        
        if (!utmParams.utm_source && trackingData.utm_source) {
          utmParams = {
            ...utmParams,
            utm_source: trackingData.utm_source || utmParams.utm_source,
            utm_medium: trackingData.utm_medium || utmParams.utm_medium,
            utm_campaign: trackingData.utm_campaign || utmParams.utm_campaign,
            utm_term: trackingData.utm_term || utmParams.utm_term,
            utm_content: trackingData.utm_content || utmParams.utm_content,
          }
        }
      } catch (e) {
        console.warn('[register] ì¿ í‚¤ íŒŒì‹± ì‹¤íŒ¨:', e)
      }
    }
  }
  
  // 3ìˆœìœ„: ë§í¬ ë©”íƒ€ë°ì´í„° (cidë¡œ ì¡°íšŒ)
  let linkId: string | null = body.marketing_campaign_link_id || null
  let linkUTMParams: Record<string, string | null> = {}
  
  if (cid && !linkId) {
    try {
      const normalizedCid = normalizeCID(cid)
      if (normalizedCid) {
        const { data: link } = await admin
          .from('campaign_link_meta')
          .select('id, utm_source, utm_medium, utm_campaign, utm_term, utm_content')
          .eq('client_id', campaign.client_id)
          .eq('cid', normalizedCid)
          .eq('status', 'active')
          .maybeSingle()
        
        if (link) {
          linkId = link.id
          linkUTMParams = {
            utm_source: link.utm_source || null,
            utm_medium: link.utm_medium || null,
            utm_campaign: link.utm_campaign || null,
            utm_term: link.utm_term || null,
            utm_content: link.utm_content || null,
          }
        }
      }
    } catch (e) {
      console.warn('[register] ë§í¬ ì¡°íšŒ ì‹¤íŒ¨:', e)
    }
  }
  
  // ìµœì¢… UTM íŒŒë¼ë¯¸í„° (ìš°ì„ ìˆœìœ„: URL > Cookie > Link)
  const finalUTMParams = {
    utm_source: utmParams.utm_source || linkUTMParams.utm_source || null,
    utm_medium: utmParams.utm_medium || linkUTMParams.utm_medium || null,
    utm_campaign: utmParams.utm_campaign || linkUTMParams.utm_campaign || null,
    utm_term: utmParams.utm_term || linkUTMParams.utm_term || null,
    utm_content: utmParams.utm_content || linkUTMParams.utm_content || null,
  }
  
  // ì¶”ì  ìŠ¤ëƒ…ìƒ· ìƒì„±
  const trackingSnapshot = {
    cid,
    ...finalUTMParams,
    referer: req.headers.get('referer') || null,
    user_agent: req.headers.get('user-agent') || null,
    first_visit_at: body.utm_first_visit_at || null,
    link_id: linkId,
    captured_at: new Date().toISOString(),
    source: utmParams.utm_source ? 'url' : 
            (cookie ? 'cookie' : (linkId ? 'link_meta' : 'none')),
  }
  
  return {
    cid,
    utmParams: finalUTMParams,
    linkId,
    trackingSnapshot,
  }
}
```

2. **ë“±ë¡ ì‹œ tracking_snapshot ì €ì¥**

```typescript
const { cid, utmParams, linkId, trackingSnapshot } = await restoreTrackingInfo(
  req,
  campaignId,
  campaign
)

const { data: entry, error: entryError } = await admin
  .from('event_survey_entries')
  .insert({
    campaign_id: campaignId,
    // ... ê¸°ì¡´ í•„ë“œë“¤ ...
    utm_source: normalizedUTM.utm_source || null,
    utm_medium: normalizedUTM.utm_medium || null,
    utm_campaign: normalizedUTM.utm_campaign || null,
    utm_term: normalizedUTM.utm_term || null,
    utm_content: normalizedUTM.utm_content || null,
    marketing_campaign_link_id: linkId,
    tracking_snapshot: trackingSnapshot, // âœ¨ ìƒˆë¡œ ì¶”ê°€
  })
  .select('id, survey_no, code6')
  .single()
```

---

### 4. Short-link ë¦¬ë‹¤ì´ë ‰íŠ¸ ê°œì„ 

#### íŒŒì¼: `app/s/[code]/route.ts` (ë˜ëŠ” í•´ë‹¹ ê²½ë¡œ)

**ë³€ê²½ ì‚¬í•­**: ë¦¬ë‹¤ì´ë ‰íŠ¸ ì‹œ ì¿¼ë¦¬ íŒŒë¼ë¯¸í„° ìœ ì§€

```typescript
export async function GET(
  req: Request,
  { params }: { params: Promise<{ code: string }> }
) {
  const { code } = await params
  const url = new URL(req.url)
  
  // Short-link ì¡°íšŒ
  const { data: shortLink } = await admin
    .from('short_links')
    .select('target_url, cid, utm_source, utm_medium, utm_campaign')
    .eq('code', code)
    .single()
  
  if (!shortLink) {
    return NextResponse.json({ error: 'Link not found' }, { status: 404 })
  }
  
  // íƒ€ê²Ÿ URLì— ì¿¼ë¦¬ íŒŒë¼ë¯¸í„° ì¶”ê°€
  const targetUrl = new URL(shortLink.target_url)
  
  // cid ì¶”ê°€
  if (shortLink.cid) {
    targetUrl.searchParams.set('cid', shortLink.cid)
  }
  
  // UTM íŒŒë¼ë¯¸í„° ì¶”ê°€ (ë§í¬ì— ì €ì¥ëœ ê²ƒ)
  if (shortLink.utm_source) {
    targetUrl.searchParams.set('utm_source', shortLink.utm_source)
  }
  if (shortLink.utm_medium) {
    targetUrl.searchParams.set('utm_medium', shortLink.utm_medium)
  }
  if (shortLink.utm_campaign) {
    targetUrl.searchParams.set('utm_campaign', shortLink.utm_campaign)
  }
  
  // ê¸°ì¡´ URLì˜ ì¿¼ë¦¬ íŒŒë¼ë¯¸í„°ë„ ìœ ì§€ (ìš°ì„ ìˆœìœ„)
  url.searchParams.forEach((value, key) => {
    if (key.startsWith('utm_') || key === 'cid') {
      targetUrl.searchParams.set(key, value)
    }
  })
  
  // ë¦¬ë‹¤ì´ë ‰íŠ¸ (ì¿¼ë¦¬ íŒŒë¼ë¯¸í„° í¬í•¨)
  return NextResponse.redirect(targetUrl.toString())
}
```

---

## ë§ˆì´ê·¸ë ˆì´ì…˜ ê³„íš

### Phase 1: ìŠ¤í‚¤ë§ˆ ë³€ê²½ (ì¦‰ì‹œ)

1. `tracking_snapshot` ì»¬ëŸ¼ ì¶”ê°€
2. ì¸ë±ìŠ¤ ìƒì„±
3. ê¸°ì¡´ ë°ì´í„°ëŠ” `null` ìœ ì§€ (ìƒˆ ë“±ë¡ë¶€í„° ì±„ì›€)

### Phase 2: API ê°œì„  (1ì£¼ ë‚´)

1. Middleware ì¶”ê°€ (ì„œë²„ ì„¸ì…˜ ê´€ë¦¬)
2. ë“±ë¡ API ê°œì„  (ë‹¤ì¤‘ ì†ŒìŠ¤ ë³µì›)
3. Short-link ë¦¬ë‹¤ì´ë ‰íŠ¸ ê°œì„ 

### Phase 3: ëª¨ë‹ˆí„°ë§ ë° ê²€ì¦ (2ì£¼ ë‚´)

1. ì¶”ì  ì„±ê³µë¥  ëª¨ë‹ˆí„°ë§
2. `tracking_snapshot` ë°ì´í„° ê²€ì¦
3. ì§‘ê³„ API ë³´ì • ë¡œì§ ì¶”ê°€

---

## ì˜ˆìƒ íš¨ê³¼

### Before (í˜„ì¬)

- ì¶”ì  ì„±ê³µë¥ : **0.2%** (1/529)
- Direct ì˜¤ë¶„ë¥˜: **99.8%**

### After (ê°œì„  í›„)

- ì¶”ì  ì„±ê³µë¥ : **95%+** (ì˜ˆìƒ)
- Direct ì˜¤ë¶„ë¥˜: **5% ë¯¸ë§Œ** (ì˜ˆìƒ)

---

## DoD (Definition of Done)

- [ ] `tracking_snapshot` ì»¬ëŸ¼ ì¶”ê°€ ë° ë§ˆì´ê·¸ë ˆì´ì…˜
- [ ] Middlewareì—ì„œ ì„œë²„ ì„¸ì…˜ ê´€ë¦¬ êµ¬í˜„
- [ ] ë“±ë¡ APIì—ì„œ ë‹¤ì¤‘ ì†ŒìŠ¤ ë³µì› ë¡œì§ êµ¬í˜„
- [ ] Short-link ë¦¬ë‹¤ì´ë ‰íŠ¸ì—ì„œ ì¿¼ë¦¬ íŒŒë¼ë¯¸í„° ìœ ì§€
- [ ] ì¶”ì  ì„±ê³µë¥  ëª¨ë‹ˆí„°ë§ ëŒ€ì‹œë³´ë“œ ì¶”ê°€
- [ ] ê¸°ì¡´ Direct í•­ëª©ì— ëŒ€í•œ ì§‘ê³„ ë³´ì • ë¡œì§ ì¶”ê°€

---

## ê´€ë ¨ ë¬¸ì„œ

- [UTM ì¶”ì  ë¬¸ì œ ì›ì¸ ê·œëª… ë° í•´ê²°ë°©ì•ˆ](./UTM_ì¶”ì _ë¬¸ì œ_ì›ì¸_ê·œëª…_ë°_í•´ê²°ë°©ì•ˆ.md)
- [UTM íŒŒë¼ë¯¸í„° ë³µì› ìŠ¤í¬ë¦½íŠ¸ ëª…ì„¸ì„œ](./UTM_íŒŒë¼ë¯¸í„°_ë³µì›_ìŠ¤í¬ë¦½íŠ¸_ëª…ì„¸ì„œ.md)
