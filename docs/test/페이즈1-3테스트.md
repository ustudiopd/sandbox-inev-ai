아래는 **Phase 1~3 전용 “RLS / Tenant Isolation Negative Test” 체크리스트**(문서 그대로 붙여넣기용)야.
기존 DoD 스크립트(Phase1~4)에서 **Phase4(이메일)** 를 빼고, 대신 **의도적 침투(다른 client_id / 다른 eventId / 다른 slug)** 를 때려서 **403/404로 막히는지** 확인하는 구성으로 만들었어. 

---

# inev Phase 1~3 — RLS / Tenant Isolation Negative Test Checklist (v1)

## 목적

* “관리자 계정이 여러 client에 가입되어도” 데이터가 섞이거나 새지 않는지 검증
* “한 client에만 속한 계정”이 다른 client 데이터에 **절대 접근 못 하는지** 검증
* “event_id 직접 지정(IDOR)”로 우회 접근이 **절대 성공하지 않는지** 검증

---

## 전제 (테스트 데이터 준비)

### Clients

* `wert` (Wert Intelligence)
* `modoolecture` (모두의특강)

### 계정 / 멤버십

* `pd@ustudio.co.kr` : **wert + modoolecture 둘 다 admin**
* `ad@ustudio.co.kr` : **wert만 admin** (modoolecture 멤버십 없음)

### Events (각 client 최소 2개)

* wert: `wert-e1`, `wert-e2`
* modoo: `modoo-e1`, `modoo-e2`

### 데이터 시드(최소)

각 이벤트에:

* 등록 2명 (동일 이메일 1개를 양쪽 이벤트에 일부러 섞어도 OK: `same@company.com`)
* visit 3건 (utm_source 서로 다르게)
* (선택) 설문 1건

---

## 확인 규칙 (합격/불합격)

* **합격:** 403 또는 404로 차단 (정책에 맞는 쪽)
* **불합격(중요):**

  * `200 + 빈 배열([])` 로 응답하는 케이스도 “누수 위험”으로 간주 → **실패 처리 권장**
  * 특히 다른 client의 eventId를 넣었는데 200이 나오면 위험

> 정책 선택 팁: “존재를 숨기려면 404”, “권한 없음이면 403”.
> 무엇을 쓰든 **일관성**이 핵심.

---

## 테스트 0 — 스모크(Phase 1~3 정상 동작)

기존 스크립트에서 Phase 1~3에 해당하는 것만 확인: 

* `GET /api/inev/clients`
* `GET /api/inev/events?client_id=...`
* `POST /api/inev/register`
* `POST /api/inev/visits`
* `GET /api/inev/events/[eventId]/leads`
* `GET /api/inev/events/[eventId]/visits?aggregate=true`

---

## 테스트 1 — “한 클라이언트 only 계정(ad@) 차단” (필수)

### 1-1. modoo 클라이언트 이벤트 목록 조회 시도

* **세션:** `ad@ustudio.co.kr` (wert only)
* **요청:** `GET /api/inev/events?client_id={modooClientId}`
* **기대:** 403/404

### 1-2. modoo 이벤트의 leads 접근 시도 (IDOR)

* **세션:** ad@
* **요청:** `GET /api/inev/events/{modooEventId}/leads`
* **기대:** 403/404

### 1-3. modoo 이벤트의 visits 집계 접근 시도 (IDOR)

* **세션:** ad@
* **요청:** `GET /api/inev/events/{modooEventId}/visits?aggregate=true`
* **기대:** 403/404

---

## 테스트 2 — “겹친 계정(pd@)도 컨텍스트가 섞이지 않음” (필수)

### 2-1. client_id 바꿔가며 event list가 분리되는지

* **세션:** `pd@ustudio.co.kr` (둘 다 admin)
* **요청 A:** `GET /api/inev/events?client_id={wertClientId}`
* **요청 B:** `GET /api/inev/events?client_id={modooClientId}`
* **기대:** A에는 wert 이벤트만, B에는 modoo 이벤트만

### 2-2. 이벤트 단위 leads 섞임 방지

* **세션:** pd@
* **요청:**

  * `GET /api/inev/events/{wert-e1}/leads`
  * `GET /api/inev/events/{wert-e2}/leads`
* **기대:** e1 데이터가 e2에 섞이지 않음(0건 교차)

### 2-3. 이벤트 단위 visits/utm 섞임 방지

* **세션:** pd@
* **요청:**

  * `GET /api/inev/events/{wert-e1}/visits?aggregate=true`
  * `GET /api/inev/events/{wert-e2}/visits?aggregate=true`
* **기대:** e1에는 e1 utm만, e2에는 e2 utm만

---

## 테스트 3 — “Cross-tenant write 차단” (필수)

**의도:** ad@가 modoo 쪽에 등록/visit “쓰기”를 시도했을 때 막히는지

### 3-1. modoo 이벤트 slug로 register 시도

* **세션:** ad@
* **요청:** `POST /api/inev/register` (body: `slug=modoo-e1`, email, name)
* **기대:** 403/404 (또는 명시적 에러)

### 3-2. modoo 이벤트 slug로 visits 기록 시도

* **세션:** ad@
* **요청:** `POST /api/inev/visits` (body: `slug=modoo-e1`, utm_*)
* **기대:** 403/404

---

## 테스트 4 — “client_id 파라미터 변조” (권장)

**의도:** API가 “요청 파라미터로 넘어온 client_id”를 신뢰하면 터짐 → 서버에서 멤버십으로 검증해야 함

* **세션:** pd@ 또는 ad@
* **요청:** `GET /api/inev/events?client_id={존재하지만 내가 접근하면 안 되는 client_id}`
* **기대:** 403/404 (내 멤버십과 불일치면 무조건 차단)

---

## 결과 기록 포맷 (권장)

각 테스트에 대해:

* 요청자(계정):
* 요청 URL:
* 응답 코드:
* 응답 바디(요약):
* 판정: PASS/FAIL
* FAIL이면: “어느 정책(RLS/API 가드/쿼리 조건)에서 새는지” 메모

---

## 최소 통과 기준(Minimum Gate)

* 테스트 1,2,3 **전부 PASS**
* 특히 **IDOR (다른 eventId 직접 넣기)** 에서 200 나오면 즉시 중단/수정

---

원하면, 위 체크리스트를 기반으로 **“Phase 1~3 전용 DoD 스크립트 실행 흐름(명령어/환경변수/결과 예시)”**까지 문서에 붙일 수 있게 확장해줄게.
