# 설문 폼 관리 및 미리보기 통합 명세서 (Survey Form Management & Inline Preview Specification)

## 1. 개요

### 목표
폼 관리 탭과 미리보기를 통합하여 **데이터 형식 관리와 인라인 텍스트 편집**을 제공합니다. 사용자는 폼 관리 탭에서 구조적 설정을 하고, 미리보기에서 실제 보이는 텍스트를 직접 편집할 수 있습니다.

### 범위
- **폼 관리 탭**: 데이터 형식 관리 (기본 필드 설정, 개인정보 동의 설정, 문항 추가/수정/삭제)
- **미리보기**: 인라인 텍스트 편집 (제목, 라벨, 문항 내용, 선택지 텍스트 등)
- **실시간 반영**: 편집한 내용이 즉시 미리보기에 반영

### 비범위 (v1에서 제외)
- 드래그 앤 드롭으로 문항 순서 변경 (향후 추가 가능)
- 조건부 로직 (특정 답변에 따라 다음 문항 분기)
- 이미지/파일 업로드 문항
- 행렬형 문항 (표 형식)
- 설문 로직 검증 (예: "최소 3개 선택" 등)

---

## 2. 화면 구성 (UI/UX)

### 2.1 전체 레이아웃

```
┌─────────────────────────────────────────────────────────────┐
│  폼 관리 탭                                                    │
├──────────────────────┬──────────────────────────────────────┤
│                      │                                      │
│  왼쪽: 데이터 형식 관리 │  오른쪽: 미리보기 (인라인 편집)    │
│  (Form Settings)     │  (Inline Preview Editor)            │
│                      │                                      │
│  - 기본 필드 설정     │  - 실시간 미리보기                   │
│  - 동의 항목 설정     │  - 텍스트 클릭 시 편집 모드          │
│  - 문항 관리          │  - 스크롤 가능한 컨테이너            │
│  - 문항 추가/수정     │  - 새 탭에서 열기 버튼              │
│                      │                                      │
└──────────────────────┴──────────────────────────────────────┘
```

### 2.2 왼쪽: 데이터 형식 관리 영역 (Form Settings)

#### 2.2.1 기본 필드 설정 섹션
- **회사명**
  - 사용 여부 체크박스
  - 필수 여부 체크박스
  - 라벨 입력 필드
- **이름**
  - 사용 여부 체크박스
  - 필수 여부 체크박스
  - 라벨 입력 필드
- **휴대전화번호**
  - 사용 여부 체크박스
  - 필수 여부 체크박스
  - 라벨 입력 필드

#### 2.2.2 개인정보 동의 설정 섹션
- **동의 항목 목록**
  - 각 항목별:
    - 사용 여부 체크박스
    - 필수 여부 체크박스
    - 제목 입력 필드
    - 내용 텍스트 영역
  - **항목 추가** 버튼 (최대 10개)
  - **항목 삭제** 버튼

#### 2.2.3 문항 관리 섹션
- **문항 목록**
  - 각 문항 카드:
    - 문항 번호
    - 문항 유형 아이콘 (단일 선택, 다중 선택, 텍스트)
    - 문항 내용 미리보기 (최대 50자)
    - 수정 버튼 (모달 열기)
    - 삭제 버튼
- **문항 추가 버튼**
  - 클릭 시 문항 추가 모달 열기
  - 문항 유형 선택 (단일 선택, 다중 선택, 텍스트)

#### 2.2.4 문항 추가/수정 모달
- **문항 유형 선택** (라디오 버튼)
  - 단일 선택
  - 다중 선택
  - 텍스트
- **문항 내용 입력**
  - 문항 제목 (필수)
- **선택지 관리** (단일/다중 선택인 경우)
  - 선택지 목록
  - 각 선택지:
    - 텍스트 입력 필드
    - 삭제 버튼
  - **선택지 추가** 버튼
- **저장/취소 버튼**

### 2.3 오른쪽: 미리보기 영역 (Inline Preview Editor)

#### 2.3.1 미리보기 헤더
- **미리보기 제목**: "설문 페이지 미리보기"
- **편집 모드 토글** 버튼 ("편집 모드 ON/OFF")
- **새 탭에서 열기** 버튼 (실제 공개 페이지)
- **저장하기** 버튼 (변경사항 저장)

#### 2.3.2 미리보기 컨테이너
- **스크롤 가능한 영역**
  - 최대 높이: 80vh
  - 오버플로우: auto
- **인라인 편집 모드**
  - 편집 모드가 켜져 있을 때:
    - 편집 가능한 텍스트에 호버 시 배경색 변경 (회색)
    - 클릭 시 입력 필드로 전환
    - Enter 또는 클릭 외부 영역 클릭 시 저장
    - Esc 키로 취소
  - 편집 모드가 꺼져 있을 때:
    - 일반 미리보기로 표시 (읽기 전용)

#### 2.3.3 편집 가능한 요소
- **폼 제목** (`form.title`)
- **폼 설명** (`form.description`)
- **기본 필드 라벨** (`config.basicFields.company.label`, `name.label`, `phone.label`)
- **개인정보 동의 항목 제목** (`config.consentFields[].title`)
- **개인정보 동의 항목 내용** (`config.consentFields[].content`)
- **문항 내용** (`questions[].body`)
- **선택지 텍스트** (`questions[].options[].text`)

#### 2.3.4 실시간 반영
- 왼쪽 데이터 형식 관리 영역의 변경사항 즉시 반영
- 미리보기에서 편집한 텍스트는 즉시 상태에 반영
- 디바운싱 적용 (500ms) - 성능 최적화
- 미리보기 모드 표시
  - 상단에 "미리보기 모드" 배지 표시
  - 제출 버튼 비활성화 또는 "미리보기 모드에서는 제출할 수 없습니다" 메시지

---

## 3. 기능 명세

### 3.1 데이터 형식 관리 기능 (왼쪽 영역)

#### 3.1.1 기본 필드 설정
- **트리거**: 체크박스 및 입력 필드 변경
- **동작**:
  1. 사용 여부 체크박스 토글
  2. 필수 여부 체크박스 토글 (사용 여부가 켜져 있을 때만 활성화)
  3. 라벨 입력 필드 변경
  4. 변경사항 즉시 미리보기에 반영

#### 3.1.2 개인정보 동의 항목 설정
- **트리거**: 체크박스 및 입력 필드 변경
- **동작**:
  1. 사용 여부 체크박스 토글
  2. 필수 여부 체크박스 토글 (사용 여부가 켜져 있을 때만 활성화)
  3. 제목/내용 입력 필드 변경
  4. 항목 추가/삭제 버튼
  5. 변경사항 즉시 미리보기에 반영

#### 3.1.3 문항 추가
- **트리거**: "문항 추가" 버튼 클릭
- **동작**:
  1. 문항 추가 모달 열기
  2. 기본값으로 "단일 선택" 선택
  3. 사용자가 문항 유형 선택
  4. 기본 문항 내용 입력 (예: "문항 1")
  5. 선택지 추가 (단일/다중 선택인 경우, 기본 2개)
  6. "저장" 클릭 시 문항 목록에 추가
  7. 자동으로 `order_no` 할당 (현재 최대값 + 1)
  8. 미리보기 즉시 업데이트

#### 3.1.4 문항 수정 (모달)
- **트리거**: 문항 카드의 "수정" 버튼 클릭
- **동작**:
  1. 문항 수정 모달 열기
  2. 기존 문항 데이터 로드
  3. 사용자가 문항 유형 변경 (선택사항)
  4. 선택지 추가/삭제 (단일/다중 선택인 경우)
  5. "저장" 클릭 시 문항 업데이트
  6. 미리보기 즉시 업데이트

#### 3.1.5 문항 삭제
- **트리거**: 문항 카드의 "삭제" 버튼 클릭
- **동작**:
  1. 확인 다이얼로그 표시
  2. 확인 시 문항 목록에서 제거
  3. 남은 문항의 `order_no` 재정렬
  4. 미리보기 즉시 업데이트

### 3.2 인라인 텍스트 편집 기능 (오른쪽 미리보기)

#### 3.2.1 편집 모드 토글
- **트리거**: "편집 모드 ON/OFF" 버튼 클릭
- **동작**:
  1. 편집 모드 상태 토글
  2. 편집 모드가 켜지면 편집 가능한 요소에 호버 효과 표시
  3. 편집 모드가 꺼지면 일반 미리보기로 표시

#### 3.2.2 텍스트 편집 시작
- **트리거**: 편집 모드가 켜진 상태에서 편집 가능한 텍스트 클릭
- **동작**:
  1. 해당 텍스트를 입력 필드로 전환
  2. 기존 텍스트 선택 상태로 표시
  3. 포커스 자동 설정
  4. 편집 중인 요소에 강조 표시 (예: 파란색 테두리)

#### 3.2.3 텍스트 편집 완료
- **트리거**: Enter 키 또는 클릭 외부 영역 클릭
- **동작**:
  1. 입력 필드의 값을 상태에 반영
  2. 입력 필드를 텍스트로 전환
  3. 변경사항 즉시 미리보기에 반영
  4. 디바운싱 적용 (500ms) - 성능 최적화

#### 3.2.4 텍스트 편집 취소
- **트리거**: Esc 키
- **동작**:
  1. 입력 필드를 원래 텍스트로 복원
  2. 변경사항 저장하지 않음

#### 3.2.5 편집 가능한 요소별 동작
- **폼 제목**: `contentEditable` 또는 `input` 요소로 전환
- **폼 설명**: `textarea` 요소로 전환 (여러 줄)
- **기본 필드 라벨**: `input` 요소로 전환
- **개인정보 동의 제목**: `input` 요소로 전환
- **개인정보 동의 내용**: `textarea` 요소로 전환 (여러 줄)
- **문항 내용**: `textarea` 요소로 전환 (여러 줄 가능)
- **선택지 텍스트**: `input` 요소로 전환

### 3.3 실시간 반영 기능

#### 3.3.1 데이터 흐름
- **왼쪽 → 오른쪽**: 데이터 형식 관리 영역의 변경사항이 미리보기에 즉시 반영
- **오른쪽 → 왼쪽**: 미리보기에서 편집한 텍스트가 상태에 즉시 반영
- **양방향 동기화**: 두 영역의 데이터가 항상 일치하도록 유지

#### 3.3.2 디바운싱
- 텍스트 입력 시 디바운싱 적용 (500ms)
- 빠른 타이핑 시 불필요한 리렌더링 방지
- Enter 키 또는 포커스 아웃 시 즉시 반영

### 3.4 저장 기능

#### 3.4.1 수동 저장
- **트리거**: "저장하기" 버튼 클릭 (미리보기 헤더 또는 하단)
- **동작**:
  1. 폼 제목 필수 검증
  2. 모든 변경사항 수집 (왼쪽 설정 + 오른쪽 텍스트 편집)
  3. API 호출 (`PUT /api/event-survey/campaigns/[campaignId]/forms/[formId]`)
  4. 성공 시 "저장되었습니다" 토스트 메시지
  5. 실패 시 에러 메시지 표시

#### 3.4.2 저장 상태 표시
- **저장되지 않음**: "저장되지 않음" 배지 표시 (빨간색)
- **저장 중**: "저장 중..." 배지 표시 (파란색)
- **저장됨**: "저장됨" 배지 표시 (초록색)

---

## 4. 데이터 모델

### 4.1 폼 데이터 구조

```typescript
interface Form {
  id: string
  title: string
  description?: string
  config?: {
    basicFields?: {
      company?: { enabled: boolean; required: boolean; label: string }
      name?: { enabled: boolean; required: boolean; label: string }
      phone?: { enabled: boolean; required: boolean; label: string }
    }
    consentFields?: Array<{
      id: string
      enabled: boolean
      required: boolean
      title: string
      content: string
    }>
    headerImage?: {
      url?: string
      enabled: boolean
    }
  }
  questions: Array<{
    id: string
    order_no: number
    type: 'single' | 'multiple' | 'text'
    body: string
    options?: Array<{ id: string; text: string }> | string[]
  }>
}
```

### 4.2 문항 데이터 구조

```typescript
interface FormQuestion {
  id: string
  form_id: string
  order_no: number
  type: 'single' | 'multiple' | 'text'
  body: string
  options?: Array<{ id: string; text: string }> | string[]
}
```

---

## 5. API 명세

### 5.1 폼 조회
- **엔드포인트**: `GET /api/event-survey/campaigns/[campaignId]/forms/[formId]`
- **응답**: 폼 데이터 및 문항 목록

### 5.2 폼 수정
- **엔드포인트**: `PUT /api/event-survey/campaigns/[campaignId]/forms/[formId]`
- **요청 본문**:
  ```json
  {
    "title": "폼 제목",
    "description": "폼 설명",
    "config": {
      "basicFields": { ... },
      "consentFields": [ ... ]
    },
    "questions": [
      {
        "type": "single",
        "body": "문항 내용",
        "options": [ ... ]
      }
    ]
  }
  ```
- **응답**: 업데이트된 폼 데이터

### 5.3 문항 추가 (폼 수정 API 내부 처리)
- 폼 수정 API에서 `questions` 배열을 받아 처리
- 기존 문항 삭제 후 새 문항 생성
- `order_no` 자동 할당

---

## 6. 구현 단계

### Phase 1: 기본 레이아웃 및 데이터 형식 관리
1. ✅ 왼쪽/오른쪽 분할 레이아웃 구현
2. ✅ 기본 필드 설정 섹션 구현
3. ✅ 개인정보 동의 설정 섹션 구현
4. ✅ 문항 목록 표시 구현
5. ✅ 문항 추가/수정/삭제 모달 구현

### Phase 2: 인라인 텍스트 편집 기능
1. ⏳ 편집 모드 토글 버튼 구현
2. ⏳ 편집 가능한 요소 식별 및 호버 효과
3. ⏳ 텍스트 클릭 시 입력 필드로 전환
4. ⏳ Enter/Esc 키 처리
5. ⏳ 클릭 외부 영역 처리
6. ⏳ 각 요소별 적절한 입력 필드 타입 (input/textarea)

### Phase 3: 실시간 반영 및 동기화
1. ✅ 미리보기 영역 구현
2. ✅ 실시간 데이터 전달 구현
3. ⏳ 양방향 데이터 동기화 구현
4. ⏳ 디바운싱 적용 (500ms)
5. ⏳ 변경사항 추적 및 저장 상태 표시

### Phase 4: 저장 및 최적화
1. ✅ 수동 저장 기능 구현
2. ⏳ 저장 상태 표시 (저장됨/저장 중/저장되지 않음)
3. ⏳ 성능 최적화 (메모이제이션, 디바운싱)
4. ⏳ 에러 처리 및 사용자 피드백 개선

---

## 7. 기술 스택

### 프론트엔드
- **상태 관리**: React `useState`, `useEffect`
- **인라인 편집**: `contentEditable` 또는 조건부 렌더링 (`input`/`textarea`)
- **디바운싱**: `lodash.debounce` 또는 커스텀 훅
- **이벤트 처리**: `onClick`, `onBlur`, `onKeyDown` (Enter/Esc)

### 백엔드
- **API**: Next.js Route Handlers
- **데이터베이스**: Supabase PostgreSQL
- **인증**: Supabase Auth (기존 Guard 시스템)

---

## 8. 사용자 시나리오

### 시나리오 1: 새 설문 폼 만들기
1. 설문조사 콘솔 → "폼 관리" 탭 접근
2. "샘플 폼 생성하기" 클릭 또는 수동으로 폼 생성
3. 폼 관리 화면 표시 (왼쪽: 데이터 형식 관리, 오른쪽: 미리보기)
4. 왼쪽에서 기본 필드 설정 (회사명, 이름, 전화번호 사용/필수 여부)
5. 왼쪽에서 개인정보 동의 항목 설정 (사용/필수 여부)
6. 왼쪽에서 문항 추가 버튼 클릭
7. 문항 유형 선택 및 기본 내용 입력
8. 선택지 추가 (단일/다중 선택인 경우)
9. 저장 클릭
10. 오른쪽 미리보기에서 즉시 확인
11. "편집 모드 ON" 버튼 클릭
12. 미리보기에서 제목, 라벨, 문항 내용 등을 직접 클릭하여 수정
13. Enter 키 또는 외부 클릭으로 편집 완료
14. "저장하기" 클릭하여 최종 저장

### 시나리오 2: 기존 폼 텍스트 수정
1. 설문조사 콘솔 → "폼 관리" 탭 접근
2. 기존 폼 로드
3. "편집 모드 ON" 버튼 클릭
4. 미리보기에서 수정하고 싶은 텍스트 클릭 (예: "회사명" 라벨)
5. 입력 필드로 전환되어 편집 가능
6. 텍스트 수정 (예: "회사명" → "소속 회사")
7. Enter 키 또는 외부 클릭으로 편집 완료
8. 변경사항이 즉시 미리보기에 반영
9. "저장하기" 클릭하여 최종 저장

### 시나리오 3: 문항 구조 변경 및 텍스트 수정
1. 설문조사 콘솔 → "폼 관리" 탭 접근
2. 기존 폼 로드
3. 왼쪽에서 문항 카드의 "수정" 버튼 클릭
4. 문항 유형 변경 (예: 단일 선택 → 다중 선택)
5. 선택지 추가/삭제
6. 저장 클릭
7. 오른쪽 미리보기에서 변경사항 확인
8. "편집 모드 ON" 버튼 클릭
9. 미리보기에서 문항 내용 및 선택지 텍스트 직접 수정
10. "저장하기" 클릭하여 최종 저장

---

## 9. 고려사항

### 9.1 성능
- **디바운싱**: 미리보기 업데이트에 디바운싱 적용 (500ms)
- **메모이제이션**: `React.memo`로 불필요한 리렌더링 방지
- **가상화**: 문항이 많을 경우 가상 스크롤 적용 (선택사항)

### 9.2 사용자 경험
- **자동 저장**: 일정 시간마다 자동 저장 (선택사항)
- **저장 상태 표시**: "저장됨" / "저장 중..." / "저장되지 않음" 표시
- **키보드 단축키**: Ctrl+S로 저장 (선택사항)

### 9.3 데이터 검증
- **클라이언트 검증**: 필수 필드 검증
- **서버 검증**: API에서 추가 검증
- **에러 처리**: 명확한 에러 메시지 표시

### 9.4 접근성
- **키보드 네비게이션**: 모든 기능을 키보드로 접근 가능
- **스크린 리더 지원**: ARIA 레이블 추가
- **색상 대비**: WCAG AA 기준 준수

---

## 10. 향후 확장 계획

### Phase 2 기능 (향후)
- 드래그 앤 드롭으로 문항 순서 변경
- 조건부 로직 (답변에 따른 문항 분기)
- 이미지/파일 업로드 문항
- 행렬형 문항
- 설문 로직 검증
- 템플릿 시스템 (자주 사용하는 문항 조합 저장/불러오기)
- 문항 복사 기능
- 문항 그룹화 (섹션 나누기)
- 자동 저장 기능 (일정 시간마다)

---

## 11. 참고 자료

- 기존 설문조사 명세서: `설문조사.md`
- 폼 시스템 마이그레이션: `035_modify_forms_for_campaigns.sql`
- 폼 설정 마이그레이션: `038_add_form_config_for_survey_fields.sql`
- SurveyForm 컴포넌트: `app/event/[...path]/components/SurveyForm.tsx`
- FormManagementTab 컴포넌트: `app/(client)/client/[clientId]/surveys/[campaignId]/components/tabs/FormManagementTab.tsx`

