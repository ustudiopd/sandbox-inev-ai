# 이메일 발송 시스템 명세서

## 개요

EventLive 프로젝트의 이메일 발송 시스템은 **Gmail SMTP**를 사용하여 웨비나 등록 확인 이메일을 발송합니다. 발신자는 **모두의특강 (admin@modoolecture.com)** 계정을 사용합니다.

---

## 1. 시스템 구성

### 1.1 기술 스택

- **이메일 라이브러리**: `nodemailer` (v7.0.11)
- **SMTP 서버**: Gmail SMTP (`smtp.gmail.com`)
- **포트**: 587 (TLS)
- **발신자 계정**: `admin@modoolecture.com`
- **발신자 표시명**: "모두의특강"

### 1.2 핵심 파일

- **이메일 발송 로직**: `lib/email.ts`
- **웨비나 등록 API**: `app/api/webinars/[webinarId]/register-request/route.ts`
- **수동 이메일 발송 스크립트**: `scripts/send-webinar-email.ts`
- **엑셀 일괄 등록 스크립트**: `scripts/register-participants-from-excel.ts`

---

## 2. 환경 변수 설정

### 2.1 필수 환경 변수

```env
# SMTP 설정 (Gmail)
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_USER=admin@modoolecture.com
SMTP_PASS="앱_비밀번호_16자리"

# 앱 URL (이메일 링크에 사용)
NEXT_PUBLIC_APP_URL=https://eventflow.kr
```

### 2.2 환경 변수 기본값

- `SMTP_HOST`: 기본값 `smtp.gmail.com`
- `SMTP_PORT`: 기본값 `587`
- `SMTP_USER`: 기본값 `admin@modoolecture.com`
- `SMTP_PASS`: **필수** (설정되지 않으면 이메일 발송 불가)

### 2.3 Gmail 앱 비밀번호 생성 방법

1. Google 계정 설정 페이지 접속: https://myaccount.google.com/
2. 보안 탭 클릭
3. **2단계 인증 활성화** (필수)
4. "앱 비밀번호" 섹션으로 이동
5. "앱 선택" → "메일" 선택
6. "기기 선택" → "기타(맞춤 이름)" 선택 후 "EventLive" 입력
7. 생성된 16자리 앱 비밀번호 복사
8. `.env.local` 파일의 `SMTP_PASS`에 붙여넣기 (따옴표로 묶기 권장)

---

## 3. 이메일 발송 기능

### 3.1 주요 함수

#### `sendWebinarRegistrationEmail()`

**위치**: `lib/email.ts`

**기능**: 웨비나 등록 확인 이메일 발송

**파라미터**:
- `to: string` - 수신자 이메일 주소
- `displayName: string` - 수신자 이름
- `webinarTitle: string` - 웨비나 제목
- `webinarIdOrSlug: string` - 웨비나 ID (UUID) 또는 slug
- `startTime?: string | null` - 웨비나 시작 시간 (선택)

**반환값**: `Promise<boolean>` - 발송 성공 여부

**동작 흐름**:
1. SMTP transporter 생성 (환경 변수 기반)
2. 웨비나 ID/Slug 확인 및 변환
3. 웨비나 설정에서 이메일 템플릿 및 썸네일 조회
4. 이메일 HTML/텍스트 생성
5. nodemailer를 통한 이메일 발송

### 3.2 이메일 내용 구성

#### 발신자 정보
- **From**: `"모두의특강" <admin@modoolecture.com>`
- **Subject**: `[모두의특강] 웨비나 등록이 완료되었습니다: {웨비나 제목}`

#### 이메일 본문 포함 내용
1. **웨비나 썸네일 이미지** (설정된 경우)
   - 기본값: Supabase Storage의 `webinar-thumbnails/0114.jpg`
   - 웨비나 설정에서 `email_thumbnail_url`로 커스터마이징 가능

2. **이메일 템플릿 문구**
   - 웨비나 설정의 `email_template_text` 사용 (설정된 경우)
   - 특정 웨비나(slug: `884372`) 커스텀 템플릿 지원
   - 기본 템플릿: 웨비나 제목, 시작 시간 포함

3. **웨비나 입장 링크**
   - 형식: `{NEXT_PUBLIC_APP_URL}/webinar/{slug 또는 UUID}?email={수신자 이메일}`
   - slug가 있으면 slug 사용, 없으면 UUID 사용

4. **푸터**
   - "본 이메일은 모두의특강 웨비나 등록 확인을 위해 발송되었습니다."
   - "(주)유스튜디오 | 모두의특강"

### 3.3 이메일 형식

- **HTML 형식**: 반응형 디자인, 그라데이션 헤더, 버튼 스타일링
- **텍스트 형식**: HTML을 읽을 수 없는 클라이언트용 대체 텍스트

---

## 4. 이메일 발송 트리거

### 4.1 자동 발송 (현재 비활성화됨)

**위치**: `app/api/webinars/[webinarId]/register-request/route.ts`

**상태**: ⚠️ **현재 주석 처리되어 비활성화됨**

```typescript
// 이메일 발송 비활성화
// try {
//   await sendWebinarRegistrationEmail(
//     email.trim(),
//     displayName.trim(),
//     webinar.title || '웨비나',
//     webinarSlug,
//     webinar.start_time
//   )
// } catch (emailError) {
//   console.error('이메일 발송 실패 (등록은 성공):', emailError)
// }
```

**활성화 방법**: 위 주석을 제거하고 import 문의 주석도 제거

### 4.2 수동 발송 스크립트

#### `scripts/send-webinar-email.ts`

**사용법**:
```bash
npx tsx scripts/send-webinar-email.ts <webinarIdOrSlug> <email> [displayName]
```

**예시**:
```bash
npx tsx scripts/send-webinar-email.ts 884372 jubileo@naver.com "주빌레오"
```

**기능**:
- 웨비나 ID 또는 slug로 웨비나 조회
- 이메일이 이미 등록되어 있으면 이메일만 재발송
- 등록되어 있지 않으면 등록 후 이메일 발송

#### `scripts/register-participants-from-excel.ts`

**기능**: 엑셀 파일에서 일괄 등록 및 이메일 발송

**동작**:
- 엑셀 파일에서 참가자 정보 읽기
- 각 참가자 등록 및 이메일 발송
- 이메일 발송 실패 시에도 등록은 성공 처리

---

## 5. 웨비나 설정 연동

### 5.1 데이터베이스 필드

웨비나 테이블(`webinars`)의 다음 필드가 이메일 발송에 사용됩니다:

- `email_template_text`: 이메일 본문 템플릿 문구
- `email_thumbnail_url`: 이메일 썸네일 이미지 URL
- `start_time`: 웨비나 시작 시간 (이메일 본문에 표시)
- `slug`: 웨비나 slug (입장 링크에 사용)

### 5.2 웨비나 설정 UI

**위치**: `app/(webinar)/webinar/[id]/console/components/SettingsTab.tsx`

**기능**:
- "등록 이메일 문구" 텍스트 영역에서 `email_template_text` 설정
- "이메일 썸네일 이미지" 업로드로 `email_thumbnail_url` 설정

---

## 6. 에러 처리

### 6.1 SMTP 연결 실패

- `SMTP_PASS` 환경 변수가 없으면 transporter 생성 실패
- 콘솔에 경고 메시지 출력: `"SMTP_PASS 환경 변수가 설정되지 않았습니다. 이메일 발송이 불가능합니다."`
- 함수는 `null` 반환, 이메일 발송 함수는 `false` 반환

### 6.2 이메일 발송 실패

- try-catch로 에러 캐치
- 콘솔에 에러 로그 출력: `"이메일 발송 실패: {error}"`
- 함수는 `false` 반환
- **중요**: 이메일 발송 실패해도 웨비나 등록은 성공 처리 (에러 핸들링에서 명시)

### 6.3 웨비나 조회 실패

- UUID 또는 slug로 웨비나를 찾을 수 없으면 에러 로그 출력
- 함수는 `false` 반환

---

## 7. 보안 고려사항

### 7.1 환경 변수 보안

- `SMTP_PASS`는 절대 Git에 커밋하지 않음 (`.env.local`은 `.gitignore`에 포함)
- 프로덕션 환경에서는 Vercel 등의 환경 변수 설정 사용

### 7.2 Gmail 앱 비밀번호

- 일반 비밀번호와 다름
- 2단계 인증 필수
- 한 번만 표시되므로 안전한 곳에 보관 필요

### 7.3 이메일 주소 검증

- 이메일 주소는 소문자로 변환하여 저장 (`toLowerCase()`)
- 트림 처리로 공백 제거

---

## 8. 현재 상태 및 제한사항

### 8.1 현재 상태

✅ **작동 중인 기능**:
- 수동 이메일 발송 스크립트 (`scripts/send-webinar-email.ts`)
- 엑셀 일괄 등록 및 이메일 발송 (`scripts/register-participants-from-excel.ts`)
- 이메일 발송 함수 (`lib/email.ts`)

⚠️ **비활성화된 기능**:
- 웨비나 등록 API의 자동 이메일 발송 (`app/api/webinars/[webinarId]/register-request/route.ts`)
- 이벤트 설문 등록 API의 이메일 발송 (`app/api/public/event-survey/[campaignId]/register/route.ts`)

### 8.2 제한사항

- Gmail 일일 발송 한도: 약 500통/일 (계정 상태에 따라 다름)
- 대량 발송 시 Gmail 제한에 걸릴 수 있음
- 이메일 발송 실패 시 재시도 로직 없음

---

## 9. 향후 개선 방향

### 9.1 제안 사항

1. **이메일 발송 서비스 전환**
   - Gmail 대신 SendGrid, AWS SES, Mailgun 등 전문 이메일 서비스 고려
   - 대량 발송 및 전송률 향상

2. **자동 발송 활성화**
   - 웨비나 등록 API의 자동 이메일 발송 기능 재활성화 검토

3. **재시도 로직 추가**
   - 이메일 발송 실패 시 자동 재시도 메커니즘 구현

4. **발송 로그 관리**
   - 이메일 발송 이력 데이터베이스 저장
   - 발송 상태 추적 및 모니터링

5. **템플릿 관리 개선**
   - 더 다양한 이메일 템플릿 지원
   - 템플릿 미리보기 기능

---

## 10. 참고 문서

- [이메일 발송 설정 가이드](./EMAIL_SETUP.md)
- [환경 변수 설정 가이드](./ENV_SETUP.md)
- [nodemailer 공식 문서](https://nodemailer.com/)

---

**작성일**: 2026-01-29  
**최종 수정일**: 2026-01-29  
**작성자**: AI Assistant
