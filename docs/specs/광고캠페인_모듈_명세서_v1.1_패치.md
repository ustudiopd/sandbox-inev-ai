# 광고/캠페인(마케팅 성과) 모듈 명세서 v1.1 패치

**패치일**: 2026-01-27  
**기반 명세서**: v1.0 (4가지 보완사항 포함)  
**패치 목적**: 최종 결정 잠금(D1-D7) 반영 및 Phase 1 착수 준비

---

## 패치 개요

본 패치는 원본 명세서에 **7가지 결정 잠금(D1-D7)**을 추가하고, **숏링크 미사용 전략**을 명확히 하여 Phase 1 구현 착수를 가능하게 합니다.

---

## 결정 잠금 추가 사항 (D1-D7)

### D1. Visit 정의(고정) [기존 유지]

**내용**: Visit = 익명 `session_id` 기반 dedup 방문 수
- session TTL(예: 30분/24시간)은 config로 관리
- IP/UA는 기본 미수집(옵션으로만)

**변경 없음** - 원본 명세서 Section 6 그대로 유지

---

### D2. Querystring pass-through 규칙(고정) [기존 유지]

**내용**: 서버/라우트/리다이렉트가 발생하는 모든 지점에서 기존 searchParams(utm_*)를 다음 URL에 그대로 전달

**변경 없음** - 원본 명세서 Section 6 그대로 유지

---

### D3. 캠페인 링크 메타데이터는 short_links와 분리(고정) [수정]

**원본 명세서 내용**:
- `campaign_link_meta.short_link_id → short_links.id (FK)` 관계
- Phase 2에서 "short link 리다이렉트 엔진을 재사용"한다고 명시

**변경 사항**:
- ❌ **숏링크 기능은 사용하지 않음**
- ✅ `campaign_link_meta` 테이블은 `short_link_id` 없이 독립적으로 설계
- ✅ `campaign_link_meta.id` (UUID)를 `marketing_campaign_link_id`로 사용
- ✅ `short_links` 테이블과의 FK 관계 제거

**Phase 2 설계 변경**:
```sql
-- 기존 (명세서 Section 7.2)
create table public.campaign_link_meta (
  id uuid primary key,
  short_link_id bigint references short_links(id), -- 제거
  ...
);

-- 변경 후
create table public.campaign_link_meta (
  id uuid primary key default gen_random_uuid(), -- marketing_campaign_link_id로 사용
  -- short_link_id 제거
  agency_id uuid,
  client_id uuid,
  name text, -- 운영자 이름
  target_campaign_id uuid references event_survey_campaigns(id),
  landing_variant text, -- welcome/register/survey
  utm_source text,
  utm_medium text,
  utm_campaign text,
  utm_term text,
  utm_content text,
  status text, -- active/paused/archived
  created_by uuid,
  created_at timestamptz,
  updated_at timestamptz
);
```

---

### D4. 집계는 RPC + DB group-by로 시작, Rollup은 옵션(고정) [기존 유지]

**내용**: 통계는 DB에서 group-by로 계산(RPC/뷰), Rollup(일 단위 요약 테이블)은 성능 이슈 시점에 옵션으로 추가

**변경 없음** - 원본 명세서 Section 6 그대로 유지

---

### D5. UTM querystring pass-through 고정 (신규 추가)

**문제**: 리다이렉트 시 UTM 파라미터 유실 가능성 확인됨

**결정 문장**:
> "리다이렉트가 발생하는 모든 경로에서 `utm_*` querystring은 반드시 pass-through 한다."

**구현 요구사항**:
- 서버 리다이렉트든 클라이언트 네비게이션이든 무조건 유지
- 유틸리티 함수 제공:
  - `extractUTMParams(searchParams)`: UTM 파라미터 추출
  - `appendUTMToURL(url, utmParams)`: URL에 UTM 추가
  - `normalizeUTM(utmParams)`: 정규화(trim + lowercase + length 제한)

**구현 지점**:
1. 클라이언트 리다이렉트: `WebinarEntry.tsx`의 `handleNameEmailAuth` 함수
2. 서버 사이드 리다이렉트: `app/(webinar)/webinar/[id]/page.tsx` 등

**DoD**:
- `/webinar/149402?utm_source=...` 로 들어온 뒤 등록정보 없어서 `/event/149403`로 가도 utm이 유지된다.

---

### D6. 캠페인 추적의 단일 진실 확정 (신규 추가)

**문제**: `tracking_link_id` / `short_link_id` 혼재

**결정**:
- `event_survey_entries`에는 **`marketing_campaign_link_id (UUID, nullable)` 하나만 저장**
- `short_link_id`는 사용하지 않음
- `campaign_link_meta.id`를 `marketing_campaign_link_id`로 사용

**필드명 변경**:
- 기존 명세서의 `tracking_link_id(또는 short_link_id)` 표현은 **전부 제거**
- Phase 1에서는 `marketing_campaign_link_id`만 사용 (nullable, Phase 2에서 값 채움)

**결과**:
- 운영자 이름(name) ↔ 전환 데이터 1:1 매핑
- 나중에 구조 변경돼도 전환 데이터 안 깨짐

---

### D7. UTM 캡처의 서버/클라이언트 책임 분리 (신규 추가)

**문제**: Next.js App Router에서 하이드레이션 이슈 가능성

**결정 문장**:
> "UTM 파싱은 서버에서 1차 수행하고, 클라이언트는 전달받은 값으로 localStorage 저장만 담당한다."

**구현 패턴**:
1. **서버 컴포넌트**: `searchParams`에서 UTM 추출 → `extractUTMParams()` 사용
2. **클라이언트 컴포넌트**: props로 받은 UTM을 localStorage에 저장
3. **보조 경로**: 클라이언트의 `useSearchParams()` 재파싱은 보조로만 사용

**구현 예시**:
```typescript
// 서버 컴포넌트 (app/event/[...path]/page.tsx)
export default async function SurveyPublicPage({
  searchParams,
}: {
  searchParams: Promise<{ [key: string]: string | string[] | undefined }>
}) {
  const searchParamsData = await searchParams
  const utmParams = extractUTMParams(searchParamsData)
  
  return <RegistrationPage campaign={campaign} utmParams={utmParams} />
}

// 클라이언트 컴포넌트
'use client'
export default function RegistrationPage({ campaign, utmParams }: Props) {
  useEffect(() => {
    if (Object.keys(utmParams).length > 0) {
      localStorage.setItem(`utm:${campaign.id}`, JSON.stringify({
        ...utmParams,
        captured_at: new Date().toISOString(),
        first_visit_at: new Date().toISOString(),
      }))
    }
  }, [campaign.id, utmParams])
}
```

---

## 명세서 Section별 수정 사항

### Section 7.1: 전환 테이블 확장

**변경 사항**:
- `tracking_link_id(또는 short_link_id)` → **`marketing_campaign_link_id (UUID, nullable)`**로 변경
- Phase 1에서는 nullable로 두고, Phase 2에서 값 채움

**수정된 필드 목록**:
```sql
ALTER TABLE public.event_survey_entries
  ADD COLUMN utm_source text,
  ADD COLUMN utm_medium text,
  ADD COLUMN utm_campaign text,
  ADD COLUMN utm_term text,
  ADD COLUMN utm_content text,
  ADD COLUMN utm_first_visit_at timestamptz,
  ADD COLUMN utm_referrer text,
  ADD COLUMN marketing_campaign_link_id uuid; -- Phase 1에서는 nullable
```

---

### Section 7.2: 캠페인 링크 메타 테이블 (Phase 2)

**변경 사항**:
- ❌ `short_link_id` 필드 제거
- ❌ `short_links` 테이블과의 FK 관계 제거
- ✅ `campaign_link_meta.id`를 `marketing_campaign_link_id`로 사용

**수정된 테이블 설계**:
```sql
create table public.campaign_link_meta (
  id uuid primary key default gen_random_uuid(), -- marketing_campaign_link_id로 사용
  agency_id uuid,
  client_id uuid not null,
  name text not null, -- 운영자 이름: "26년 1월 뉴스레터", "문자_리마인드"
  target_campaign_id uuid not null references event_survey_campaigns(id),
  landing_variant text, -- welcome/register/survey
  utm_source text,
  utm_medium text,
  utm_campaign text,
  utm_term text,
  utm_content text,
  status text default 'active', -- active/paused/archived
  created_by uuid references public.profiles(id),
  created_at timestamptz not null default now(),
  updated_at timestamptz not null default now()
);

-- 인덱스
create index idx_campaign_link_meta_client_target 
  on public.campaign_link_meta(client_id, target_campaign_id, status);
create unique index uniq_campaign_link_meta_name_client 
  on public.campaign_link_meta(client_id, name); -- 동일 클라이언트 내 이름 유니크
```

---

### Section 8.2: 클라이언트 저장소(브라우저) 규칙

**변경 사항**:
- 서버에서 파싱한 UTM을 props로 전달받아 저장
- `useSearchParams()` 재파싱은 보조 경로로만 사용

**수정된 저장 로직**:
```typescript
// 서버에서 파싱한 UTM을 props로 받음
const utmData = {
  ...utmParams, // 서버에서 전달받은 값
  captured_at: new Date().toISOString(),
  first_visit_at: new Date().toISOString(),
  referrer_domain: extractDomain(referrer),
}

// localStorage에 저장
localStorage.setItem(`utm:${campaignId}`, JSON.stringify(utmData))
```

---

### Section 8.4: 워트(WERT) 특수 흐름에서의 UTM 유지

**변경 사항**:
- 구체적 구현 지점 명시
- 유틸리티 함수 사용 명시

**수정된 구현 요구사항**:
```typescript
// WebinarEntry.tsx의 handleNameEmailAuth 함수
const redirectToRegistration = () => {
  const searchParams = new URLSearchParams(window.location.search)
  const utmParams = extractUTMParams(searchParams)
  const redirectUrl = appendUTMToURL('/event/149403', utmParams)
  window.location.href = redirectUrl
}

// 서버 사이드 리다이렉트
const redirectWithUTM = (url: string, searchParams: URLSearchParams) => {
  const utmParams = extractUTMParams(searchParams)
  const redirectUrl = appendUTMToURL(url, utmParams)
  redirect(redirectUrl)
}
```

---

### Section 10.3: 탭 B: 캠페인 링크(운영)

**변경 사항**:
- ❌ 단축 URL 생성 기능 제거
- ✅ UTM 링크만 생성

**수정된 링크 생성기**:
- 링크 이름(name)
- 전환 타겟 선택
- 랜딩 위치 선택(welcome/register/survey)
- UTM 입력(표준 5종)
- 생성 결과로:
  - 원본 URL(UTM 포함)만 제공
  - 복사 버튼

**생성된 URL 예시**:
```
https://eventflow.kr/event/149403?utm_source=newsletter&utm_medium=email&utm_campaign=january_2026
```

---

## Phase 1 구현 범위 명확화

### 포함 사항
- ✅ UTM querystring pass-through 구현
- ✅ `event_survey_entries`에 UTM 저장
- ✅ 광고/캠페인 페이지 탭 A 구현 (Conversions 중심)
- ✅ RPC 집계 함수 2개 (Summary, Breakdown)

### 제외 사항
- ❌ 숏링크 기능 (`/s`, `short_links` 테이블)
- ❌ 캠페인 링크 메타 테이블 (Phase 2로 이동)
- ❌ 유입 로그 테이블 (`event_access_logs`) (Phase 3로 이동)
- ❌ Visits/CVR 집계 (Phase 3로 이동)

---

## Go 조건 체크리스트

Phase 1 착수 전 필수 확인 사항:

- [x] **D1-D7 결정 잠금이 명세서에 반영됨** (본 패치 문서로 완료)
- [ ] **UTM pass-through 유틸리티 함수 설계 완료**
  - [ ] `extractUTMParams` 함수 시그니처 확정
  - [ ] `appendUTMToURL` 함수 시그니처 확정
  - [ ] `normalizeUTM` 함수 시그니처 확정
- [ ] **워트 리다이렉트 지점 확인 완료**
  - [x] `/webinar/149402` → `/event/149403` 리다이렉트 지점 확인
  - [ ] UTM pass-through 구현 계획 수립
- [ ] **데이터베이스 스키마 확정**
  - [ ] `event_survey_entries`에 UTM 컬럼 추가 계획
  - [x] `marketing_campaign_link_id` 필드명 확정
  - [ ] 인덱스 전략 확정
- [ ] **서버/클라이언트 UTM 전달 패턴 확정**
  - [x] 서버 컴포넌트에서 UTM 추출 패턴
  - [x] 클라이언트 컴포넌트로 전달 방법
  - [x] localStorage 저장 로직
- [ ] **RPC 함수 시그니처 확정** (권장)
  - [ ] `get_marketing_summary` 시그니처
  - [ ] `get_marketing_breakdown` 시그니처

---

## 다음 단계

1. ✅ **명세서 v1.1 패치 작성 완료** (본 문서)
2. ⏭️ **Phase 1 실행 체크리스트 작성** (별도 문서)
3. ⏭️ **UTM 유틸리티 함수 구현** (Phase 1 Step A)

---

**패치 작성일**: 2026-01-27  
**적용 대상**: 광고/캠페인(마케팅 성과) 모듈 전체 명세서 v1.0
