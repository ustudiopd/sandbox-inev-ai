# 웨비나 통계 집계 및 수집 명세서

**작성일**: 2026년 2월 5일  
**버전**: 1.0

---

## 목차

1. [개요](#개요)
2. [수집 방법](#수집-방법)
3. [집계 통계 종류](#집계-통계-종류)
4. [데이터베이스 구조](#데이터베이스-구조)
5. [API 엔드포인트](#api-엔드포인트)
6. [데이터 흐름](#데이터-흐름)
7. [크론 작업 상세](#크론-작업-상세)

---

## 개요

### 목적
웨비나 운영 및 성과 분석을 위한 통계 데이터를 실시간으로 수집하고 집계합니다.

### 핵심 원칙
- ✅ **실시간 웨비나 경험을 방해하지 않는 수준**으로 수집
- ✅ 라이브 참가자 화면에서는 **가벼운 ping만** 수행
- ✅ 집계는 **서버 크론**에서 수행
- ✅ 통계 조회는 **관리자 화면에서만** 사용

---

## 수집 방법

### 1. 실시간 Presence 수집

#### 1.1 Presence Ping API
**엔드포인트**: `POST /api/webinars/[webinarId]/presence/ping`

**호출 주기**: 
- 라이브 웨비나 시청 중: **2분마다** (권장)
- Jitter: ±10초 (동시 폭주 방지)

**동작**:
1. 인증된 사용자가 웨비나 시청 중 주기적으로 호출
2. `webinar_live_presence` 테이블에 upsert 수행
3. `last_seen_at` 필드만 업데이트 (60초 이내 중복 업데이트 억제)

**저장 데이터**:
- `webinar_id`: 웨비나 ID
- `user_id`: 사용자 ID
- `joined_at`: 최초 입장 시간 (첫 ping 시)
- `last_seen_at`: 마지막 활동 시간 (매 ping마다 갱신)
- `agency_id`, `client_id`: 조직 정보

**부하**: 매우 낮음 (단일 upsert만 수행)

---

### 2. 웨비나 접속 페이지 수집

#### 2.1 Access Track API
**엔드포인트**: `POST /api/webinars/[webinarId]/access/track`

**호출 시점**: 
- 웨비나 접속 페이지(`/webinar/[id]`) 로드 시
- 5분마다 세션 갱신

**동작**:
1. 세션 ID 생성 또는 기존 세션 ID 사용
2. 로그인한 사용자인 경우:
   - `webinar_live_presence`에 기록
   - 자동 등록 (등록되지 않은 경우)
3. 세션 정보 반환

**저장 데이터**:
- `webinar_live_presence` 테이블에 기록
- 세션 ID는 클라이언트 localStorage에 저장

---

### 3. 마케팅 캠페인 방문 수집

#### 3.1 Visit API
**엔드포인트**: `POST /api/public/campaigns/[campaignId]/visit`

**호출 시점**: 
- 캠페인 랜딩 페이지 접속 시
- 웨비나 시청 페이지 접속 시 (registration_campaign_id가 있는 경우)

**동작**:
1. 세션 ID 생성 또는 기존 세션 ID 사용
2. UTM 파라미터 추출 및 저장
3. `event_access_logs` 테이블에 방문 기록 저장

**저장 데이터**:
- `campaign_id`: 캠페인 ID (또는 `webinar_id`)
- `session_id`: 세션 ID
- `utm_source`, `utm_medium`, `utm_campaign`, `utm_term`, `utm_content`: UTM 파라미터
- `referrer`: 리퍼러
- `user_agent`: User Agent
- `cid`: Campaign Identifier
- `accessed_at`: 접속 시간
- `converted_at`: 전환 시간 (등록 완료 시)

---

## 집계 통계 종류

### 1. 웨비나 접속 통계

#### 1.1 현재 접속자 수
**수집 방법**: `webinar_live_presence` 테이블 실시간 조회  
**활성 기준**: `last_seen_at >= now() - 3분`

**통계 항목**:
- `currentParticipants`: 현재 접속자 수
- `activePresences`: 활성 사용자 목록

#### 1.2 시간대별 접속자 수
**수집 방법**: 크론 작업 (`webinar-access-snapshot`)  
**집계 주기**: 1분마다 수집, 5분 버킷으로 저장

**통계 항목**:
- `min_participants`: 최소 접속자 수 (5분 버킷 내)
- `max_participants`: 최대 접속자 수 (5분 버킷 내)
- `last_participants`: 마지막 샘플의 접속자 수
- `avg_participants`: 평균 접속자 수 (sum_participants / sample_count)

**저장 테이블**: `webinar_access_logs`

---

### 2. 등록자 통계

#### 2.1 등록자 수
**수집 방법**: `registrations` 테이블 직접 조회

**통계 항목**:
- `totalRegistrants`: 총 등록자 수
- `registrationSources`: 등록 경로별 통계 (manual, email_auth, name_email_auth 등)

#### 2.2 최대 동시 접속자
**수집 방법**: `webinar_access_logs` 테이블에서 `max_participants` 최대값 조회

**통계 항목**:
- `maxConcurrentParticipants`: 최대 동시 접속자 수

---

### 3. 마케팅 통계

#### 3.1 방문/전환 통계
**수집 방법**: 크론 작업 (`aggregate-marketing-stats`)  
**집계 주기**: 5분마다 실행, 일별로 집계

**통계 항목**:
- `visits`: 방문 수 (고유 session_id 기준)
- `conversions`: 전환 수 (등록 완료)
- `cvr`: 전환율 (conversions / visits)

**집계 단위**:
- 일별 (`bucket_date`)
- 캠페인별 (`campaign_id`)
- 마케팅 링크별 (`marketing_campaign_link_id`)
- UTM 파라미터별 (`utm_source`, `utm_medium`, `utm_campaign`)

**저장 테이블**: `marketing_stats_daily`

---

### 4. 기타 통계

#### 4.1 채팅 통계
- 총 메시지 수
- 시간대별 메시지 수
- 사용자별 메시지 수

#### 4.2 Q&A 통계
- 총 질문 수
- 답변 완료 질문 수
- 시간대별 질문 수

#### 4.3 폼/퀴즈 통계
- 제출 수
- 완료율
- 평균 점수 (퀴즈)

#### 4.4 추첨 통계
- 참여자 수
- 당첨자 수
- 당첨률

#### 4.5 파일 다운로드 통계
- 다운로드 수
- 파일별 다운로드 수
- 사용자별 다운로드 수

---

## 데이터베이스 구조

### 1. 실시간 Presence 테이블

#### `webinar_live_presence`
**목적**: 현재 접속 중인 사용자 추적

```sql
CREATE TABLE webinar_live_presence (
  webinar_id UUID NOT NULL REFERENCES webinars(id) ON DELETE CASCADE,
  user_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
  
  joined_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  last_seen_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  
  agency_id UUID,
  client_id UUID,
  
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  
  PRIMARY KEY (webinar_id, user_id)
);

-- 인덱스
CREATE INDEX idx_wlp_webinar_last_seen 
  ON webinar_live_presence(webinar_id, last_seen_at DESC);
CREATE INDEX idx_wlp_last_seen 
  ON webinar_live_presence(last_seen_at DESC);
```

**특징**:
- Upsert 방식 (같은 사용자가 여러 번 입장해도 1행만 유지)
- 마지막 입장 시간만 기록됨 (입장 횟수 추적 불가)

---

### 2. 접속 로그 집계 테이블

#### `webinar_access_logs`
**목적**: 시간대별 접속자 수 집계 (5분 버킷)

```sql
CREATE TABLE webinar_access_logs (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  
  webinar_id UUID NOT NULL REFERENCES webinars(id) ON DELETE CASCADE,
  
  -- 5분 버킷 시작 시각
  time_bucket TIMESTAMPTZ NOT NULL,
  
  -- 버킷 내 샘플 누적 (크론이 1분마다 찍으면 sample_count는 최대 5)
  sample_count INT NOT NULL DEFAULT 0,
  sum_participants INT NOT NULL DEFAULT 0,
  min_participants INT NOT NULL DEFAULT 0,
  max_participants INT NOT NULL DEFAULT 0,
  last_participants INT NOT NULL DEFAULT 0,
  
  first_sample_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  last_sample_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  
  agency_id UUID,
  client_id UUID,
  
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

-- 유니크 인덱스
CREATE UNIQUE INDEX uq_wal_webinar_bucket 
  ON webinar_access_logs(webinar_id, time_bucket);
CREATE INDEX idx_wal_webinar_bucket_desc 
  ON webinar_access_logs(webinar_id, time_bucket DESC);
```

**집계 방식**:
- 크론이 1분마다 실행하여 `webinar_live_presence`에서 접속자 수 집계
- 5분 버킷으로 누적 (upsert 방식)
- 같은 버킷 내 여러 샘플이 있으면 통계 누적

**평균 계산**:
```sql
avg_participants = sum_participants::float / NULLIF(sample_count, 0)
```

---

### 3. 방문 로그 테이블

#### `event_access_logs`
**목적**: 캠페인/웨비나 방문 기록

```sql
CREATE TABLE event_access_logs (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  
  -- 캠페인 또는 웨비나 (둘 중 하나는 필수)
  campaign_id UUID REFERENCES event_survey_campaigns(id) ON DELETE CASCADE,
  webinar_id UUID REFERENCES webinars(id) ON DELETE CASCADE,
  
  session_id TEXT NOT NULL,
  entry_id UUID REFERENCES event_survey_entries(id) ON DELETE SET NULL,
  converted_at TIMESTAMPTZ,
  
  -- UTM 파라미터
  utm_source TEXT,
  utm_medium TEXT,
  utm_campaign TEXT,
  utm_term TEXT,
  utm_content TEXT,
  
  -- 추적 정보
  cid TEXT,
  referrer TEXT,
  user_agent TEXT,
  ip_address TEXT,
  marketing_campaign_link_id UUID REFERENCES campaign_link_meta(id) ON DELETE SET NULL,
  
  accessed_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

-- 인덱스
CREATE INDEX idx_event_access_logs_campaign_session 
  ON event_access_logs(campaign_id, session_id);
CREATE INDEX idx_event_access_logs_webinar_session 
  ON event_access_logs(webinar_id, session_id) 
  WHERE webinar_id IS NOT NULL;
CREATE INDEX idx_event_access_logs_accessed 
  ON event_access_logs(campaign_id, accessed_at);
```

**제약조건**:
- `campaign_id` 또는 `webinar_id` 중 하나는 필수

---

### 4. 마케팅 통계 집계 테이블

#### `marketing_stats_daily`
**목적**: 일별 마케팅 통계 사전 집계

```sql
CREATE TABLE marketing_stats_daily (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  
  client_id UUID NOT NULL REFERENCES clients(id) ON DELETE CASCADE,
  bucket_date DATE NOT NULL, -- YYYY-MM-DD
  
  campaign_id UUID REFERENCES event_survey_campaigns(id) ON DELETE CASCADE,
  marketing_campaign_link_id UUID REFERENCES campaign_link_meta(id) ON DELETE SET NULL,
  
  -- UTM 파라미터
  utm_source TEXT,
  utm_medium TEXT,
  utm_campaign TEXT,
  
  -- 집계 통계
  visits INT NOT NULL DEFAULT 0, -- 고유 session_id 기준
  conversions INT NOT NULL DEFAULT 0,
  cvr NUMERIC(5, 2) GENERATED ALWAYS AS (
    CASE 
      WHEN visits > 0 THEN (conversions::NUMERIC / visits::NUMERIC * 100)
      ELSE 0
    END
  ) STORED,
  
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

-- 유니크 인덱스
CREATE UNIQUE INDEX uq_marketing_stats_daily 
  ON marketing_stats_daily(
    client_id, 
    bucket_date, 
    campaign_id, 
    marketing_campaign_link_id, 
    utm_source, 
    utm_medium, 
    utm_campaign
  );
```

**집계 방식**:
- `event_access_logs`에서 Visits 집계 (고유 session_id 기준)
- `event_survey_entries`에서 Conversions 집계
- 일별로 그룹핑하여 upsert

---

## API 엔드포인트

### 1. 통합 통계 API

#### `GET /api/webinars/[webinarId]/stats`
**목적**: 웨비나의 모든 통계를 한 번에 조회

**쿼리 파라미터**:
- `sections`: 조회할 섹션 목록 (쉼표로 구분)
  - `chat`: 채팅 통계
  - `qa`: Q&A 통계
  - `forms`: 폼/퀴즈 통계
  - `giveaways`: 추첨 통계
  - `files`: 파일 통계
  - `registrants`: 등록자 통계
  - `access`: 접속 통계
  - `survey`: 설문조사 통계
- `from`: 시작 날짜 (ISO 8601)
- `to`: 종료 날짜 (ISO 8601)
- `interval`: 집계 간격 (`hour`, `day`, `week`, `month`)

**응답 예시**:
```json
{
  "success": true,
  "data": {
    "chat": { ... },
    "qa": { ... },
    "access": { ... },
    ...
  }
}
```

---

### 2. 접속 통계 API

#### `GET /api/webinars/[webinarId]/stats/access`
**목적**: 웨비나 접속 통계 조회

**쿼리 파라미터**:
- `from`: 시작 날짜
- `to`: 종료 날짜
- `interval`: 집계 간격

**응답 예시**:
```json
{
  "success": true,
  "data": {
    "currentParticipants": 5,
    "activePresences": [
      {
        "user_id": "...",
        "joined_at": "2026-02-04T05:26:16Z",
        "last_seen_at": "2026-02-04T05:26:16Z"
      }
    ],
    "timeSeries": [
      {
        "time": "2026-02-04T05:30:00Z",
        "min_participants": 1,
        "max_participants": 1,
        "avg_participants": 1
      }
    ],
    "summary": {
      "maxConcurrentParticipants": 1,
      "totalSamples": 10
    }
  }
}
```

---

### 3. 등록자 통계 API

#### `GET /api/webinars/[webinarId]/stats/registrants`
**목적**: 등록자 통계 조회

**응답 예시**:
```json
{
  "success": true,
  "data": {
    "totalRegistrants": 10,
    "registrationSources": {
      "manual": 5,
      "email_auth": 3,
      "name_email_auth": 2
    },
    "maxConcurrentParticipants": 1
  }
}
```

---

## 데이터 흐름

### 1. 실시간 Presence 수집 흐름

```
[라이브 웨비나 시청 페이지]
    ↓ (2분마다)
[POST /api/webinars/[webinarId]/presence/ping]
    ↓
[webinar_live_presence 테이블 upsert]
    ↓
[last_seen_at 업데이트]
```

---

### 2. 접속 통계 집계 흐름

```
[크론 작업: webinar-access-snapshot]
    ↓ (1분마다 실행)
[get_active_webinar_participant_counts RPC 호출]
    ↓
[webinar_live_presence에서 활성 사용자 집계]
    ↓ (활성 기준: last_seen_at >= now() - 3분)
[record_webinar_access_snapshot_batch RPC 호출]
    ↓
[webinar_access_logs 테이블에 5분 버킷으로 저장]
    ↓ (upsert 방식)
[통계 API에서 조회]
```

---

### 3. 마케팅 통계 집계 흐름

```
[크론 작업: aggregate-marketing-stats]
    ↓ (5분마다 실행)
[event_access_logs에서 Visits 집계]
    ↓
[event_survey_entries에서 Conversions 집계]
    ↓
[일별 버킷으로 그룹핑]
    ↓
[marketing_stats_daily 테이블에 upsert]
    ↓
[통계 API에서 조회]
```

---

## 크론 작업 상세

### 1. 웨비나 접속 스냅샷 수집

#### 설정
- **경로**: `/api/cron/webinar-access-snapshot`
- **스케줄**: `*/1 * * * *` (1분마다)
- **인증**: `CRON_SECRET` 환경 변수

#### 동작 과정

1. **활성 사용자 판정**
   ```typescript
   const cutoff = new Date(Date.now() - 3 * 60 * 1000).toISOString()
   // now() - 3분 이내에 활동한 사용자만 활성으로 판정
   ```

2. **접속자 수 집계**
   ```sql
   SELECT webinar_id, COUNT(*)::int as participant_count
   FROM webinar_live_presence
   WHERE last_seen_at >= _active_since
   GROUP BY webinar_id
   ```

3. **5분 버킷으로 저장**
   ```sql
   -- 버킷 시간 계산: 5분 단위로 내림
   bucket = bucket_time(sampled_at, 300)
   
   -- upsert 수행
   INSERT INTO webinar_access_logs (...)
   ON CONFLICT (webinar_id, time_bucket) DO UPDATE
     SET sample_count = sample_count + 1,
         sum_participants = sum_participants + excluded.sum_participants,
         ...
   ```

#### 성능
- 활성 웨비나가 없으면 조기 종료 (204 No Content)
- DB 작업: RPC 호출 2회 (read 1회, write 1회)
- 부하: 매우 낮음 (활성 웨비나 수에 비례)

---

### 2. 마케팅 통계 일별 집계

#### 설정
- **경로**: `/api/cron/aggregate-marketing-stats`
- **스케줄**: `*/5 * * * *` (5분마다)
- **인증**: `CRON_SECRET` 환경 변수

#### 동작 과정

1. **Visits 집계**
   ```typescript
   // event_access_logs에서 최근 24시간 데이터 조회
   // campaign_id가 있는 레코드만 집계
   // session_id 기준으로 고유 방문 수 계산
   ```

2. **Conversions 집계**
   ```typescript
   // event_survey_entries에서 최근 24시간 데이터 조회
   // 등록 완료된 레코드 집계
   ```

3. **일별 버킷으로 그룹핑**
   ```typescript
   // client_id, bucket_date, campaign_id, UTM 파라미터별로 그룹핑
   // visits와 conversions 집계
   ```

4. **Upsert 수행**
   ```typescript
   // marketing_stats_daily 테이블에 upsert
   // 각 행을 개별적으로 처리 (함수 기반 인덱스 대응)
   ```

#### 집계 범위
- 기본값: 최근 24시간
- 백필 모드: 쿼리 파라미터로 날짜 범위 지정 가능
  - `?from=2026-01-01&to=2026-02-05`

#### 성능
- 집계할 데이터가 없으면 조기 종료
- DB 작업: 여러 쿼리 실행 (visits 조회, conversions 조회, 캠페인 조회, upsert)
- 부하: 중간 (데이터량에 비례)

---

## 제한사항 및 개선 방향

### 현재 제한사항

1. **개별 사용자 입장 횟수 추적 불가**
   - `webinar_live_presence`는 upsert 방식
   - 마지막 입장 시간만 기록됨
   - 총 입장 횟수는 알 수 없음

2. **시청 시간 집계 불가**
   - 입장 시간만 있고 퇴장 시간이 없음
   - 체류 시간 계산 불가능

3. **상세 입장 이력 없음**
   - 각 입장마다의 시간 기록 없음
   - 통계 분석에 제한적

### 개선 방향

1. **`webinar_user_sessions` 테이블 추가**
   - 각 입장 세션별 기록
   - 입장 시간, 퇴장 시간, 체류 시간 기록
   - 입장 횟수 집계 가능

2. **퇴장 로그 API 추가**
   - 페이지 언로드 시 호출
   - 시청 시간 집계 가능

---

## 참고 자료

- [이벤트라이브 통계기능 전체명세서 v2](./이벤트라이브_통계기능_전체명세서_v2.md)
- [웨비나 입장 기록 및 시청 시간 집계 분석](./webinar-session-tracking-analysis.md)
- [크론 에러 해결 가이드](./크론_에러_해결_가이드.md)
