# 이메일 발송 시스템 명세서 (미리보기·편집·예약·테스트)

**작성일**: 2026-02-08  
**대상**: 클라이언트 캠페인 이메일 (Resend 기반)  
**UI**: `EmailCampaignTab` (웨비나 콘솔 / 설문 캠페인 상세에서 사용)

---

## 1. 개요

### 1.1 범위

- **클라이언트 이메일 캠페인**: 웨비나 또는 등록/설문 캠페인 단위로 이메일 초안 생성·편집·미리보기·테스트 발송·실제 발송·예약 설정
- **발송 엔진**: Resend API (`lib/email/resend.ts`), 환경 변수 `RESEND_API_KEY`
- **웨비나 등록 확인 메일**(Gmail SMTP, `lib/email.ts`)은 별도 — 본 명세서에서는 **클라이언트 캠페인 이메일**만 다룸

### 1.2 노출 위치

- 웨비나 콘솔: `/webinar/[id]/console` → "이메일" 탭 (`EmailCampaignTab`, scopeType: webinar, scopeId: webinar.id)
- 설문 캠페인 상세: `/client/[clientId]/surveys/[campaignId]` → "이메일" 탭 (scopeType: registration_campaign, scopeId: campaignId)

---

## 2. 데이터 구조

### 2.1 email_campaigns

| 컬럼 | 타입 | 설명 |
|------|------|------|
| id | uuid | PK |
| client_id | uuid | 클라이언트 |
| scope_type | text | 'webinar' \| 'registration_campaign' \| 'survey_campaign' |
| scope_id | uuid | 웨비나 ID 또는 캠페인 ID |
| campaign_type | text | 'reminder_d1' \| 'reminder_h1' \| 'confirmation' \| 'custom' |
| status | text | 'draft' \| 'ready' \| 'sending' \| 'sent' \| 'failed' \| 'canceled' |
| subject | text | 제목 (템플릿 변수 지원) |
| preheader | text | 프리헤더(선택) |
| body_md | text | 본문 마크다운 |
| variables_json | jsonb | 치환 변수 (title, url, datetime 등) |
| audience_query_json | jsonb | 수신자 쿼리 (type, webinar_id/campaign_id, selected_emails 등) |
| scheduled_send_at | timestamptz | 예약 발송 시각 (저장만, 자동 실행 크론 없음) |
| approved_at, approved_by | timestamptz, uuid | 승인 시각/담당자 |
| sending_started_at | timestamptz | 발송 시작 시각 |
| sent_at | timestamptz | 발송 완료 시각 |
| from_domain, from_localpart, from_name | text | 발신 정보 (정책 보조) |
| reply_to | text | 회신 주소 |
| header_image_url | text | 상단 헤더 이미지 URL |
| footer_text | text | 푸터 마크다운 |
| created_by, created_at, updated_at | uuid, timestamptz | 생성/수정 |

### 2.2 상태 전이

- **draft** → (승인) → **ready** → (발송) → **sending** → **sent** / **failed**
- **draft** / **ready** → (취소) → **canceled**
- **ready** → (승인 취소) → **draft**
- **failed** → (승인) → **ready** (재발송용)

### 2.3 기타 테이블

- **email_runs**: 캠페인별 실행 로그 (run_type: generate \| test_send \| send, status, meta_json, error)
- **email_send_logs**: 수신자별 발송 결과 (recipient_email, status: queued \| sent \| failed, dedupe_key)
- **client_email_policies**: 클라이언트별 발신 정책 (reply_to_default, from_name_default, from_domain 등)

---

## 3. 미리보기

### 3.1 동작

- **구현 위치**: `components/email/EmailCampaignTab.tsx`
- **표시**: 편집 폼에서 "미리보기" 버튼 클릭 시 모달로 HTML 미리보기
- **생성 흐름**:
  1. 현재 편집 중인 값: `subject`, `preheader`, `body_md`, `header_image_url`, `footer_text`
  2. `campaignDetail.variables_json`(또는 기본 변수)으로 **템플릿 변수 치환** (`processTemplate`, `lib/email/template-processor.ts`)
  3. **마크다운 → HTML** (`markdownToHtml`, `lib/email/markdown-to-html.ts`) — 헤더 이미지·푸터 포함
  4. `previewHtml` state에 넣어 모달에 렌더링

### 3.2 변수 치환

- **형식**: `{{변수명}}` (예: `{{title}}`, `{{entry_url}}`, `{{datetime}}`)
- **처리**: `processTemplate(template, variables)` — HTML escape 적용
- **실제 발송 시**: 수신자별로 `name`, `recipient_name`, `email`, `entry_url` 등 개인화 변수 주입

### 3.3 API

- 미리보기는 **전부 클라이언트 측**에서 처리. 별도 미리보기 전용 API 없음.

---

## 4. 편집

### 4.1 편집 가능 필드

- 제목(subject), 프리헤더(preheader), 본문(body_md), 헤더 이미지 URL(header_image_url), 푸터(footer_text), 회신 주소(reply_to)
- 예약 발송 시: scheduled_send_at, 선택 수신자(selected_emails → audience_query_json 내 메타데이터)

### 4.2 편집 가능 상태

- **draft**, **ready** 상태에서만 수정 가능. sending/sent/failed/canceled 는 수정 불가.

### 4.3 API

- **GET /api/client/emails/[id]**  
  - 캠페인 상세 조회 (subject, preheader, body_md, status, variables_json, header_image_url, footer_text, reply_to 등)
- **PUT /api/client/emails/[id]**  
  - Body: subject, preheader, body_md, header_image_url, footer_text, scheduled_send_at, selected_emails, reply_to  
  - 선택된 수신자(selected_emails)는 audience_query_json.selected_emails 로 저장

### 4.4 UI 동작

- 캠페인 선택 시 상세 로드 → 편집 폼에 반영
- 저장 시 PUT 호출 후 목록/상세 갱신
- 본문/푸터는 마크다운 텍스트 영역, 변수 도움말(showVariableHelp) 제공
- 헤더 이미지는 URL 입력 또는 이미지 갤러리(showImageGallery)에서 선택

---

## 5. 예약 발송

### 5.1 동작

- **설정**: "예약 발송" 버튼 → 모달에서 날짜/시간(scheduledSendAt) 선택 및 수신자 선택(selectedRecipients)
- **저장**: PUT `/api/client/emails/[id]` 로 `scheduled_send_at`, `selected_emails` 전달
- **표시**: UI에 "예약된 시간에 자동으로 발송됩니다" 문구 존재

### 5.2 자동 실행 여부

- **현재**: `scheduled_send_at` 은 DB에만 저장됨. **예약 시각에 자동으로 발송을 수행하는 크론/스케줄러는 구현되어 있지 않음.**
- 예약은 "발송 시각·수신자 범위를 미리 저장해 두는 기능"이며, 실제 발송은 별도 수단(추후 크론 연동 등)이 필요함.

---

## 6. 테스트 발송

### 6.1 API

- **POST /api/client/emails/[id]/test-send**
- **Body**: `{ "testEmails": ["a@example.com", "b@example.com"] }`
- **제한**: testEmails 배열 최대 **10개**
- **허용 상태**: **ready** 만 테스트 발송 가능

### 6.2 처리 흐름

1. 캠페인·발송 정책 조회
2. 각 테스트 이메일별로:
   - audience_query에서 등록 정보 조회해 name 등 개인화 변수 구성
   - `processTemplate` 로 제목·본문·푸터 치환
   - `markdownToHtml` 로 HTML 생성
   - Resend로 발송 (`sendEmailViaResend`)
3. 성공/실패 건수 집계
4. `email_runs` 에 run_type: 'test_send' 로 로그 저장
5. audit_logs 에 EMAIL_CAMPAIGN_TEST_SEND 기록

### 6.3 UI

- "테스트 발송" 버튼 → 모달에서 이메일 주소 입력(쉼표 등 구분, 최대 10개) → 전송

---

## 7. 승인·취소·발송

### 7.1 승인 (draft / failed → ready)

- **POST /api/client/emails/[id]/approve**
- draft 또는 failed 상태에서만 호출 가능
- status → 'ready', approved_at / approved_by 설정

### 7.2 승인 취소 (ready → draft)

- **POST /api/client/emails/[id]/cancel-approval**
- ready 상태에서만 호출 가능
- status → 'draft', approved_at / approved_by null

### 7.3 캠페인 취소 (ready → canceled)

- **POST /api/client/emails/[id]/cancel**
- ready 상태에서만 호출 가능

### 7.4 실제 발송

- **POST /api/client/emails/[id]/send**
- **Body**: `{ "selectedEmails": string[] | undefined, "resendFailedOnly": boolean | undefined }`
- **동작**:
  - 기본: status === 'ready' 일 때만 발송. 대상자는 `getAudience(audience_query_json)` 로 조회.
  - `selectedEmails` 가 있으면 해당 이메일만 필터링하여 발송.
  - `resendFailedOnly === true` 이고 캠페인 상태가 sent/failed 이면, 실패 수신자만 재발송(selectedEmails 필수).
- **진행**: status → 'sending', sending_started_at 설정 후 `sendCampaignBatch` 호출. 완료 후 sent/failed 로 전이, sent_at 갱신, email_runs / email_send_logs 기록.

### 7.5 기타

- **PATCH /api/client/emails/[id]/mark-sent**: failed 상태를 수동으로 'sent' 로 변경(재발송 완료 후 등)
- **POST /api/client/emails/[id]/reset-stuck**: status === 'sending' 이고 sending_started_at 기준 1분 이상 경과 시 'failed' 로 전이(고착 복구)

---

## 8. 대상자(수신자)

### 8.1 대상자 타입 (audience_query_json)

- **webinar_registrants**: webinar_id 필수. `registrations` 에서 email, display_name 조회.
- **registration_campaign_registrants** / **survey_campaign_registrants**: campaign_id 필수. `event_survey_entries` 에서 registration_data->email, name 조회.

### 8.2 API

- **GET /api/client/emails/[id]/audience-preview**  
  - 전체 대상자 수(totalCount) + 샘플 최대 10건(samples)
- **GET /api/client/emails/[id]/audience-list**  
  - 전체 수신자 목록(recipients, totalCount)
- **GET /api/client/emails/[id]/failed-recipients**  
  - email_send_logs 기준 발송 실패 수신자 목록(recipient_email, error_message)

---

## 9. 초안 생성(Generate)

### 9.1 API

- **POST /api/client/emails/generate**
- **Body**: clientId, scopeType('webinar' | 'registration_campaign'), scopeId, campaignType('reminder_d1' | 'reminder_h1' | 'confirmation' | 'custom'), scheduledSendAt(선택)

### 9.2 동작

- scopeType/scopeId 로 웨비나 또는 캠페인 조회 후, campaign_type 에 맞는 **제목·본문 템플릿** 및 variables_json 생성
- audience_query_json 은 scope 에 맞게 설정(webinar_id 또는 campaign_id)
- 새 행을 email_campaigns 에 INSERT (status: 'draft')
- email_runs 에 run_type: 'generate' 로 로그

### 9.3 캠페인 타입별 예시

- **reminder_d1**: "내일 {{title}}이 시작됩니다" 등
- **reminder_h1**: "1시간 후 {{title}}이 시작됩니다" 등
- **confirmation**: "웨비나 등록이 완료되었습니다: {{title}}" 등
- **custom**: 빈 제목/본문 또는 최소 템플릿

---

## 10. 발송 정책

### 10.1 API

- **GET /api/client/emails/policy?clientId=...**
- **응답**: client_email_policies 의 reply_to_default, from_name_default 등
- UI에서 회신 주소 기본값·발신자명 등에 사용

### 10.2 정책 적용

- 실제 발송 시 `getCampaignEmailPolicy(client_id, campaign의 from_* 등)` 로 from, replyTo 결정
- Resend 발송 시 해당 값 사용

---

## 11. API 요약

| 메서드 | 경로 | 설명 |
|--------|------|------|
| GET | /api/client/emails | 목록 (clientId, scopeType, scopeId, status 필터) |
| GET | /api/client/emails/[id] | 상세 |
| PUT | /api/client/emails/[id] | 수정(제목·본문·푸터·예약·선택 수신자 등) |
| DELETE | /api/client/emails/[id] | 삭제(draft/ready/canceled만) |
| POST | /api/client/emails/generate | 초안 생성 |
| GET | /api/client/emails/policy | 클라이언트 이메일 정책 |
| POST | /api/client/emails/[id]/approve | 승인(draft/failed→ready) |
| POST | /api/client/emails/[id]/cancel-approval | 승인 취소(ready→draft) |
| POST | /api/client/emails/[id]/cancel | 캠페인 취소(ready→canceled) |
| POST | /api/client/emails/[id]/test-send | 테스트 발송(최대 10주소) |
| POST | /api/client/emails/[id]/send | 실제 발송(선택 수신자/실패만 재발송 옵션) |
| GET | /api/client/emails/[id]/audience-preview | 대상자 미리보기(건수+샘플) |
| GET | /api/client/emails/[id]/audience-list | 대상자 전체 목록 |
| GET | /api/client/emails/[id]/failed-recipients | 실패 수신자 목록 |
| PATCH | /api/client/emails/[id]/mark-sent | failed→sent 수동 변경 |
| POST | /api/client/emails/[id]/reset-stuck | sending 고착 시 failed 전이 |

---

## 12. 핵심 파일

| 구분 | 경로 |
|------|------|
| UI | components/email/EmailCampaignTab.tsx |
| 발송 | lib/email/resend.ts |
| 마크다운→HTML | lib/email/markdown-to-html.ts |
| 변수 치환 | lib/email/template-processor.ts |
| 대상자 조회 | lib/email/audience-query.ts |
| 배치 발송/정책 | lib/email/send-campaign.ts |
| API | app/api/client/emails/... |

---

## 13. 이메일 로그인(입장) 링크 규칙 — “매직링크” 실제 동작

코드/문서에 “Magic Link 방식”이라고 되어 있으나, **진짜 일회용 토큰 매직링크(예: Supabase `signInWithOtp`)는 사용하지 않습니다.**  
이메일에 들어가는 링크는 **입장 URL + 쿼리 파라미터(email, name)** 이고, 입장 페이지에서 해당 이메일로 **임시 비밀번호 로그인**을 수행하는 구조입니다.

### 13.1 이메일별 링크 형식

| 발송처 | 링크 형식 | 쿼리 파라미터 | 비고 |
|--------|-----------|----------------|------|
| **웨비나 등록 확인 메일** (`lib/email.ts`, Gmail SMTP) | `{NEXT_PUBLIC_APP_URL}/webinar/{slug 또는 uuid}?email={수신자 이메일}` | `email` 만 | `sendWebinarRegistrationEmail()` |
| **캠페인 이메일** (Resend, `entry_url` 변수) | `{variables.url 또는 entryUrl}?name={이름}&email={이메일}` | `name`, `email` | `send-campaign.ts` / test-send 에서 개인화 |

- 등록 확인 메일: `email` 하나만 붙음 (이름 없음).
- 캠페인 이메일: `variables.url`(또는 `entryUrl`)에 `?name=...&email=...` 를 **추가**해서 `entry_url` 로 넣음.  
  (base URL에 이미 `?` 가 있으면 의도에 따라 보정이 필요할 수 있음 — 현재는 base 뒤에 `?` 붙여서 name/email 추가.)

### 13.2 입장 페이지에서의 처리 (`WebinarEntry.tsx`)

- **정책**: `access_policy === 'email_auth'` 또는 `'name_email_auth'` 인 웨비나만 이메일 파라미터로 자동 로그인 시도.
- **이메일 추출**  
  - `email` 쿼리 있음 → 그대로 사용.  
  - 없으면 `e` 쿼리(Base64 인코딩 이메일, 다이렉트샌드 호환) 디코딩 후 사용.
- **자동 로그인 흐름**  
  1. 위에서 구한 이메일로 `POST /api/auth/email-signup` 호출 (body: `email`, `webinarId` 등).  
  2. 서버는 **매직링크/OTP를 보내지 않고**,  
     - 해당 이메일이 허용된 이메일인지 확인(`webinar_allowed_emails` 또는 등록 캠페인) 후  
     - **임시 비밀번호**를 생성·설정하고  
     - **JSON으로 `email` + `password`(임시 비밀번호) 반환.**  
  3. 클라이언트는 `supabase.auth.signInWithPassword({ email, password })` 로 로그인.  
  4. 성공 시 `/webinar/{slug 또는 id}/live` 로 리다이렉트.
- **`type`·`token`·`verified`**  
  - URL에 `type=signup|email_auth|name_email_auth` 이고 `token` 이 있으면, “이미 세션 있음” 가정하고 live 로 이동하는 분기 있음.  
  - 현재 email-signup API는 **sessionUrl 또는 토큰을 반환하지 않으므로**, 이 분기는 Supabase 매직링크 등 다른 경로에서 리다이렉트된 경우용으로 보는 것이 맞음.

### 13.3 정리

- **이메일에 심어지는 “로그인” 링크**:  
  - **등록 확인 메일**: `?email=수신자이메일`  
  - **캠페인 이메일**: `?name=이름&email=이메일` (둘 다 URL 인코딩)
- **실제 로그인 방식**:  
  - 링크 클릭 → 입장 페이지 로드 → 이메일(및 이름)로 **email-signup API** 호출 → **임시 비밀번호** 수신 → **이메일+비밀번호 로그인** → live 리다이렉트.  
  - 즉, “이메일에 심어진 링크 = 매직링크(일회용 토큰)”가 아니라 **“입장 URL + 식별용 쿼리 → 서버가 임시 비밀번호 내려줌 → 그걸로 로그인”** 규칙입니다.

---

**문서 버전**: 1.1  
**최종 업데이트**: 2026-02-08
