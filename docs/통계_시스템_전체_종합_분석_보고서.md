# EventFlow 통계 시스템 전체 종합 분석 보고서

**작성일**: 2026-02-02  
**분석 기준 시각**: 2026-02-02 18:46 (KST)  
**상태**: 🔴 **심각한 문제 다수 발견**

---

## 📊 실행 결과 요약

### 현재 데이터 현황

| 항목 | 수치 | 비고 |
|------|------|------|
| **전체 Visit** | 10건 | 매우 적음 |
| **오늘 Visit** | 0건 | ❌ 문제 |
| **전체 등록/전환** | 546건 | 정상 |
| **오늘 등록/전환** | 90건 | 정상 |
| **UTM 추적률** | 1.8% | ❌ 매우 낮음 |
| **Visit-등록 연결률** | 0.0% (오늘) | ❌ 문제 |
| **최근 Visit** | 2026-01-28 (5일 전) | ❌ 멈춤 |

---

## 🔴 발견된 문제점

### 1. Visit 추적이 거의 동작하지 않음

**현상**:
- 전체 Visit: 10건 (등록 546건 대비 1.8%)
- 오늘 Visit: 0건 (등록 90건 대비 0%)
- 최근 Visit: 5일 전 (2026-01-28)

**원인 분석**:
1. **Visit API 호출 누락**
   - 워트 랜딩 페이지(`/event/149403`)에 Visit API 호출이 없었음 → **수정 완료**
   - 다른 커스텀 랜딩 페이지에도 Visit API 호출이 없을 가능성
   - 등록 페이지(`/register`)에만 Visit API가 있고, 랜딩 페이지에는 없음

2. **Visit API 호출은 되지만 저장 실패**
   - 서버 로그에서 `[VisitTrackFail]` 확인 필요
   - DB 제약 조건 위반 (FK, NOT NULL 등)
   - 권한 문제 (RLS 정책)

3. **Visit API가 호출되지 않는 경로**
   - 직접 URL 입력으로 등록 페이지로 바로 이동
   - 리다이렉트 경로에서 Visit API 호출 누락
   - 모바일/특정 브라우저에서 JavaScript 실행 실패

**영향**:
- **CVR(전환율) 계산 불가**: Visits가 없으면 전환율을 계산할 수 없음
- **퍼널 분석 불가**: 방문 → 등록 전환율 분석 불가
- **마케팅 채널 성과 측정 제한**: Visit 기반 분석 불가

---

### 2. UTM 추적률이 매우 낮음 (1.8%)

**현상**:
- 전체 등록 546건 중 UTM/링크 추적 성공: 10건 (1.8%)
- 추적 실패: 536건 (98.2%)
- UTM Source 분포: 대부분 null

**원인 분석**:
1. **UTM 파라미터가 URL에서 사라짐**
   - 리다이렉트 구간에서 UTM 파라미터 유실
   - 메일/광고 클릭 → 중간 리다이렉트 → 최종 페이지에 UTM 없음
   - 짧은 링크(`/s/[code]`) 경유 시 UTM 보존은 구현되어 있으나, 실제 사용 시 유실 가능

2. **쿠키/세션 문제**
   - 쿠키 Trust Window(24시간) 초과로 복원 실패
   - 도메인/서브도메인 간 쿠키 공유 실패
   - 브라우저 쿠키 차단

3. **등록 시 UTM 전달 누락**
   - 등록 API body에 UTM 파라미터가 포함되지 않음
   - `restoreTrackingInfo()` 복원 실패
   - localStorage에서 UTM 읽기 실패

4. **링크 생성/사용 문제**
   - 링크는 생성되었지만 실제 사용되지 않음
   - 링크에 UTM이 포함되지 않음
   - cid 파라미터만 있고 UTM이 없음

**영향**:
- **마케팅 채널 성과 측정 불가**: 어떤 채널에서 유입되었는지 알 수 없음
- **ROI 분석 불가**: 채널별 투자 대비 성과 측정 불가
- **최적화 불가**: 효과적인 채널 식별 및 예산 배분 불가

---

### 3. Visit-등록 연결이 거의 안 됨 (0%)

**현상**:
- 오늘 등록 90건 중 Visit 연결: 0건 (0%)
- 전체 Visit-등록 연결: 1건 (전체 등록 546건 대비 0.2%)

**원인 분석**:
1. **session_id 전달 누락**
   - 등록 API body에 `session_id`가 포함되지 않음
   - Visit API와 등록 API에서 다른 session_id 사용
   - session_id 생성/관리 로직 불일치

2. **Visit이 없어서 연결 불가**
   - Visit 자체가 없으면 연결할 수 없음 (정상 케이스)
   - 하지만 Visit이 있어도 연결이 안 되는 경우가 문제

3. **연결 로직 문제**
   - `campaign_id` + `session_id` 매칭 실패
   - 웨비나 ID vs 캠페인 ID 불일치
   - `converted_at`이 이미 설정되어 업데이트 실패

**영향**:
- **전환 추적 불가**: Visit → 등록 전환 여정 추적 불가
- **퍼널 분석 불가**: 단계별 이탈률 분석 불가

---

### 4. 집계 함수 SQL 오류로 동작하지 않음

**현상**:
- 클라이언트별 집계 테스트 결과 모두 오류: `aggregate function calls cannot be nested`
- `get_marketing_summary` RPC 함수가 실행되지 않음

**원인 분석**:
1. **SQL 문법 오류** (확정)
   - `jsonb_agg(... order by count(*) desc)` 구문에서 `count(*)`가 집계 함수인데, 이것이 `jsonb_agg` 안에서 중첩되어 사용됨
   - PostgreSQL에서는 집계 함수를 중첩할 수 없음
   - 서브쿼리나 CTE를 사용해야 함

2. **수정 필요**
   - 서브쿼리로 먼저 집계한 후 `jsonb_agg` 적용
   - 마이그레이션 파일 생성: `078_fix_marketing_summary_rpc.sql`

**영향**:
- **대시보드가 비어 있음**: 통계 대시보드에 데이터가 표시되지 않음
- **성과 측정 불가**: 마케팅 성과를 확인할 수 없음
- **API가 오류 반환**: `/api/clients/[clientId]/campaigns/summary` 엔드포인트가 오류 발생

---

## 🔍 상세 원인 분석

### Visit API 호출 지점 확인

**구현된 곳**:
- ✅ `RegistrationPage` (`/event/{path}/register`)
- ✅ `SurveyPage` (`/event/{path}/survey`)
- ✅ `OnePredictRegistrationPage` (`/event/426307/register`)
- ✅ `WebinarFormWertPage` (`/event/149403`) - **방금 추가됨**

**누락 가능성**:
- ❓ 다른 커스텀 랜딩 페이지
- ❓ 웨비나 라이브 페이지
- ❓ 직접 등록 페이지로 이동하는 경우

### UTM 전달 경로 확인

**구현된 경로**:
1. **URL 쿼리 파라미터** → `extractUTMParams()` → localStorage → 등록 API body
2. **쿠키** (`ef_tracking`) → `restoreTrackingInfo()` → 등록 API body
3. **cid** → 링크 메타 조회 → UTM 복원 → 등록 API body

**문제 가능 지점**:
- 리다이렉트에서 UTM 유실
- 쿠키 Trust Window 초과
- localStorage 접근 실패
- cid로 링크 조회 실패

### Visit-등록 연결 로직 확인

**구현된 로직**:
```typescript
// 등록 API에서
if (session_id && entry?.id) {
  await admin
    .from('event_access_logs')
    .update({
      converted_at: new Date().toISOString(),
      entry_id: entry.id,
    })
    .eq('campaign_id', campaignId)
    .eq('session_id', session_id)
    .is('converted_at', null)
}
```

**문제 가능 지점**:
- `session_id`가 등록 API body에 없음
- `campaign_id` 불일치 (웨비나 ID vs 캠페인 ID)
- Visit이 이미 `converted_at`이 설정되어 있음

---

## ✅ 해결 방안

### 즉시 조치 (긴급)

1. **집계 함수 SQL 오류 수정** ✅ **완료**
   - `get_marketing_summary` RPC 함수 수정 마이그레이션 생성
   - 서브쿼리로 집계 함수 중첩 문제 해결
   - 파일: `supabase/migrations/078_fix_marketing_summary_rpc.sql`
   - **다음 단계**: 마이그레이션 실행 필요

2. **Visit API 호출 확인 및 추가**
   - ✅ 워트 랜딩 페이지 Visit API 추가 완료
   - 다른 랜딩/등록 페이지에서 Visit API 호출 확인 필요
   - 브라우저 네트워크 탭으로 실제 호출 여부 확인 필요

3. **서버 로그 확인**
   - Vercel/서버 로그에서 `[VisitTrackFail]` 검색
   - 실패 원인 파악 및 수정
   - `[VisitMissingOnConvert]` 로그 확인

4. **UTM 전달 경로 점검**
   - 등록 API body에 UTM이 포함되는지 확인
   - `restoreTrackingInfo()` 동작 확인
   - localStorage 저장/읽기 확인

### 중기 조치 (1-2주)

4. **리다이렉트 경로 개선**
   - 모든 리다이렉트에서 UTM 파라미터 보존 확인
   - 짧은 링크(`/s/[code]`) 경유 시 UTM 보존 강화

5. **쿠키/세션 관리 개선**
   - Trust Window 조정 검토
   - 세션 ID 일관성 보장
   - 도메인 간 쿠키 공유 문제 해결

6. **집계 함수 수정 완료** ✅
   - `get_marketing_summary` RPC 함수 SQL 오류 수정 완료
   - 마이그레이션 실행 후 테스트 필요

### 장기 개선 (1개월)

7. **모니터링 시스템 구축**
   - Visit API 호출률 모니터링
   - UTM 추적률 모니터링
   - Visit-등록 연결률 모니터링
   - 알림 시스템 구축

8. **문서화 및 가이드**
   - 통계 시스템 사용 가이드 작성
   - 문제 해결 가이드 작성
   - 운영자 교육 자료 작성

---

## 📋 체크리스트

### Visit 추적

- [ ] 모든 랜딩 페이지에서 Visit API 호출 확인
- [ ] 서버 로그에서 Visit 실패 원인 확인
- [ ] 브라우저 네트워크 탭으로 실제 호출 확인
- [ ] Visit 저장 성공률 모니터링

### UTM 추적

- [ ] 등록 API body에 UTM 포함 확인
- [ ] `restoreTrackingInfo()` 동작 확인
- [ ] 리다이렉트 경로에서 UTM 보존 확인
- [ ] 쿠키 Trust Window 적정성 검토

### Visit-등록 연결

- [ ] `session_id` 전달 확인
- [ ] `campaign_id` 일치 확인
- [ ] 연결 로직 동작 확인

### 집계 함수

- [x] `get_marketing_summary` RPC 함수 SQL 오류 수정 (마이그레이션 생성 완료)
- [ ] 마이그레이션 실행 및 테스트
- [ ] 대시보드 데이터 표시 확인

---

## 🎯 우선순위

1. **최우선**: 집계 함수 마이그레이션 실행 (SQL 오류 수정 완료, 실행 필요)
2. **최우선**: Visit API 호출 확인 및 추가 (워트 랜딩은 완료, 다른 페이지 확인 필요)
3. **긴급**: 서버 로그 확인 및 실패 원인 파악
4. **긴급**: UTM 전달 경로 점검
5. **중요**: Visit-등록 연결 로직 개선

---

## 📊 예상 효과

### 개선 후 예상 수치

| 항목 | 현재 | 목표 | 개선율 |
|------|------|------|--------|
| Visit 추적률 | 1.8% | 80%+ | +78%p |
| UTM 추적률 | 1.8% | 60%+ | +58%p |
| Visit-등록 연결률 | 0% | 50%+ | +50%p |
| 집계 함수 정상 동작 | 0% | 100% | +100%p |

---

---

## 🔧 수정 완료 항목

1. ✅ **워트 랜딩 페이지 Visit API 추가** (`app/webinarform/wert/page.tsx`)
2. ✅ **집계 함수 SQL 오류 수정** (`supabase/migrations/078_fix_marketing_summary_rpc.sql`)

---

## 📝 추가 발견 사항

### 상세 진단 결과

1. **최근 등록 20건 모두 Visit 없음**
   - Visit API가 전혀 호출되지 않고 있음
   - 등록 페이지에 도달하기 전에 Visit이 기록되어야 하는데, 랜딩 페이지에서 Visit이 없음

2. **링크 사용률이 매우 낮음**
   - 활성 링크 18개 중 실제 사용: 3개 (16.7%)
   - 대부분의 링크가 생성만 되고 실제 사용되지 않음

3. **워트 캠페인**
   - 등록 20건 (최근), Visit 10건 (오래된 것)
   - 최근 등록에는 Visit이 없음 → 랜딩 페이지 Visit API 추가로 해결 예상

---

**작성자**: AI Assistant  
**검토 필요**: 개발팀, 운영팀  
**다음 단계**: 
1. 마이그레이션 실행 (`078_fix_marketing_summary_rpc.sql`)
2. 서버 로그 확인 (`[VisitTrackFail]`, `[VisitMissingOnConvert]`)
3. 브라우저 네트워크 탭으로 실제 Visit API 호출 확인
