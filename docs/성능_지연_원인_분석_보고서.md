# 성능 지연 원인 분석 보고서

**작성일**: 2026-02-06  
**문제 발생 시점**: 행사 중 (접속자 다수)  
**영향 범위**: 
- 워트인텔리전스 관리자 계정 대시보드 접속 지연
- 가입 프로세스 튕김 현상

---

## 1. 문제 현상

### 1.1 대시보드 접속 지연
- **증상**: 워트인텔리전스 관리자 계정(`pd@ustudio.co.kr`)의 대시보드 접속이 느려짐
- **영향**: 관리자 업무 지연
- **실제 통계**:
  - 총 등록자: 845명
  - 입장한 사람: 478명
  - 현재 접속자: 265명
  - 평균 동시 접속자: 79명

### 1.2 가입 프로세스 튕김
- **증상**: 가입 중 튕김 현상 발생
- **영향**: 사용자 가입 실패, 사용자 경험 저하

### 1.3 등록 페이지 로그인 실패
- **증상**: "등록 페이지에서 먼저 등록해주세요" 메시지 후 로그인 실패
- **영향**: 등록된 사용자도 접속 불가

---

## 2. 원인 분석

### 2.1 대시보드 접속자 목록 개별 프로필 조회 (심각도: 매우 높음) ⚠️

**파일**: `app/(admin)/webinar/[id]/console/components/DashboardTab.tsx`

**문제점**:
```typescript
// 298-313줄: 각 사용자마다 개별 API 호출
const profilePromises = allUserIds.map(async (userId) => {
  const response = await fetch(`/api/profiles/${userId}`)  // 개별 호출!
  // ...
})
const profileResults = await Promise.all(profilePromises)
```

**성능 영향**:
- 현재 접속자 265명 × 개별 API 호출 = **265번의 HTTP 요청**
- 각 요청마다 네트워크 왕복 시간: 약 100ms
- **예상 지연**: 265 × 100ms = **26.5초 이상** ⚠️
- 브라우저 동시 연결 제한으로 인해 실제로는 더 오래 걸릴 수 있음

**개선 방안**:
1. 배치 조회 API 생성: `/api/profiles/batch` (여러 userId를 한 번에 조회)
2. 또는 `profiles` 테이블에서 `IN` 쿼리로 한 번에 조회
3. **예상 개선 효과**: 26.5초 → 200ms (130배 이상 개선)

---

### 2.2 등록 확인 API 이름 매칭 실패 (심각도: 높음) ⚠️

**파일**: `app/api/webinars/[webinarId]/check-registration/route.ts`

**문제점**:
```typescript
// 106-149줄: 이름 매칭 로직
// 여러 형식의 이름 조합을 시도하지만, 모든 경우를 커버하지 못할 수 있음
const nameVariations = [
  `${lastName}${firstName}`,      // "양승철"
  `${firstName}${lastName}`,     // "승철양"
  `${lastName} ${firstName}`,     // "양 승철"
  `${firstName} ${lastName}`,     // "승철 양"
  firstName,                       // "승철"
  lastName,                        // "양"
]
```

**성능 영향**:
- 이름 형식이 예상과 다르면 매칭 실패
- 등록은 되어 있지만 "등록 페이지에서 먼저 등록해주세요" 메시지 표시
- 사용자가 로그인 불가

**가능한 원인**:
1. 등록 시 저장된 이름 형식과 입력한 이름 형식 불일치
2. 공백, 특수문자, 띄어쓰기 차이
3. 한글/영문 혼용 이름 처리 문제

**개선 방안**:
1. 이름 매칭 로직 개선 (더 많은 변형 시도)
2. 디버깅 로그 강화 (어떤 이름 형식이 매칭 실패했는지 확인)
3. 등록 정보가 있으면 이메일만으로도 통과하도록 옵션 추가 (이름은 경고만)

---

### 2.3 가입 API 성능 문제 (심각도: 높음)

**파일**: `app/api/auth/email-signup/route.ts`

**문제점**:
```typescript
// 기존 코드 (137-160줄)
while (!foundUser && page <= 10) { // 최대 10페이지까지 검색
  const { data: usersData, error: listError } = await admin.auth.admin.listUsers({
    page,
    perPage: 1000, // 페이지당 1000명
  })
  // ...
  page++
}
```

**성능 영향**:
- 최대 10,000명의 사용자 목록을 순차적으로 조회
- 각 페이지 조회마다 네트워크 왕복 시간 발생
- 사용자가 많을수록 검색 시간이 선형적으로 증가
- **예상 지연**: 10페이지 × 500ms = 최대 5초 이상

**개선 방안**:
1. `profiles` 테이블에서 먼저 이메일로 조회 (인덱스 활용, O(1))
2. `profiles`에 없을 경우에만 `auth.users` 검색
3. 검색 범위를 최대 3페이지로 제한

**예상 개선 효과**: 
- 기존: 최대 5초+ → 개선 후: 100ms 이내 (50배 이상 개선)

---

### 2.4 대시보드 API 순차 쿼리 (심각도: 중간)

**파일**: `app/api/auth/dashboard/route.ts`

**문제점**:
```typescript
// 순차적 실행
const { data: profile } = await admin.from('profiles')...  // 쿼리 1
const { data: agencyMember } = await admin.from('agency_members')...  // 쿼리 2 (쿼리 1 완료 후)
const { data: clientMember } = await admin.from('client_members')...  // 쿼리 3 (쿼리 2 완료 후)
```

**성능 영향**:
- 3개의 쿼리가 순차적으로 실행됨
- 각 쿼리 응답 시간이 누적됨
- **예상 지연**: 3 × 200ms = 600ms

**개선 방안**:
- `Promise.all()` 또는 `Promise.allSettled()`로 병렬 실행
- **예상 개선 효과**: 600ms → 200ms (3배 개선)

---

### 2.5 하트비트 Throttle 체크 (심각도: 낮음)

**파일**: `app/api/webinars/[webinarId]/presence/ping/route.ts`

**현재 구조**:
1. `check_heartbeat_throttle` RPC 호출 (SELECT 쿼리)
2. `update_session_heartbeat` RPC 호출 (UPDATE 쿼리)

**성능 영향**:
- 매 ping마다 2번의 DB 쿼리 실행
- 500명 동시 접속 시: 약 4.17 RPS
- 각 요청마다 SELECT + UPDATE = 2번의 쿼리

**개선 방안** (선택적):
- Throttle 체크를 UPDATE 쿼리 내부로 통합
- SELECT 쿼리 제거 → DB 부하 50% 감소

**참고**: 현재 구조도 인덱스가 있어 일반적으로 문제 없지만, 접속자가 매우 많을 때(5000명 이상) 고려 필요

---

### 2.6 클라이언트 대시보드 다중 쿼리 (심각도: 중간)

**파일**: `app/(client)/client/[clientId]/dashboard/page.tsx`

**문제점**:
```typescript
// 순차적 실행
const { data: webinars } = await admin.from('webinars')...  // 쿼리 1
const { data: ondemands } = await admin.from('webinars')...  // 쿼리 2
const { data: campaigns } = await admin.from('event_survey_campaigns')...  // 쿼리 3
```

**성능 영향**:
- 3개의 쿼리가 순차적으로 실행
- **예상 지연**: 3 × 300ms = 900ms

**개선 방안**:
- `Promise.all()`로 병렬 실행
- **예상 개선 효과**: 900ms → 300ms (3배 개선)

---

## 3. 우선순위별 개선 방안

### 🔴 긴급 (즉시 적용 필요)

#### 1. 대시보드 접속자 목록 배치 조회로 변경
- **파일**: `app/(admin)/webinar/[id]/console/components/DashboardTab.tsx`
- **변경사항**: 
  - 개별 프로필 조회를 배치 조회로 변경
  - `/api/profiles/batch` API 생성 또는 `profiles` 테이블에서 `IN` 쿼리 사용
- **예상 효과**: 26.5초 → 200ms (130배 이상 개선)
- **영향**: 대시보드 접속 지연 해결

#### 2. 등록 확인 API 이름 매칭 개선
- **파일**: `app/api/webinars/[webinarId]/check-registration/route.ts`
- **변경사항**: 
  - 이름 매칭 로직 개선 (더 많은 변형 시도)
  - 디버깅 로그 강화
  - 이메일만으로도 통과 옵션 추가 (이름은 경고만)
- **예상 효과**: 등록된 사용자의 로그인 실패 문제 해결

#### 3. 가입 API 사용자 검색 최적화
- **파일**: `app/api/auth/email-signup/route.ts`
- **변경사항**: 
  - `profiles` 테이블에서 먼저 조회
  - `auth.users` 검색 범위를 3페이지로 제한
- **예상 효과**: 가입 튕김 현상 해결, 응답 시간 50배 이상 개선

### 🟡 중요 (빠른 시일 내 적용)

#### 2. 대시보드 API 병렬 쿼리
- **파일**: `app/api/auth/dashboard/route.ts`
- **변경사항**: 순차 쿼리를 `Promise.all()`로 병렬 실행
- **예상 효과**: 응답 시간 3배 개선

#### 3. 클라이언트 대시보드 병렬 쿼리
- **파일**: `app/(client)/client/[clientId]/dashboard/page.tsx`
- **변경사항**: 순차 쿼리를 `Promise.all()`로 병렬 실행
- **예상 효과**: 응답 시간 3배 개선

### 🟢 선택적 (장기적 개선)

#### 4. 하트비트 Throttle 최적화
- **파일**: `app/api/webinars/[webinarId]/presence/ping/route.ts`
- **변경사항**: Throttle 체크를 UPDATE 쿼리 내부로 통합
- **예상 효과**: DB 부하 50% 감소 (접속자 5000명 이상 시 유의미)

---

## 4. 예상 개선 효과

### 4.1 대시보드 접속자 목록 조회
- **현재**: 26.5초+ (265명 × 개별 API 호출)
- **개선 후**: 200ms (배치 조회)
- **개선율**: **130배 이상** ⚠️ 가장 심각한 문제

### 4.2 등록 확인 API
- **현재**: 이름 매칭 실패 시 로그인 불가
- **개선 후**: 더 유연한 이름 매칭 또는 이메일만으로 통과
- **개선율**: 로그인 실패 문제 해결

### 4.3 가입 API
- **현재**: 최대 5초+ (10페이지 검색)
- **개선 후**: 100ms 이내 (profiles 테이블 조회)
- **개선율**: **50배 이상**

### 4.4 대시보드 API
- **현재**: 600ms (순차 쿼리)
- **개선 후**: 200ms (병렬 쿼리)
- **개선율**: **3배**

### 4.5 클라이언트 대시보드
- **현재**: 900ms (순차 쿼리)
- **개선 후**: 300ms (병렬 쿼리)
- **개선율**: **3배**

---

## 5. 추가 확인 사항

### 5.1 데이터베이스 인덱스 확인 필요
- `profiles.email` 컬럼에 인덱스가 있는지 확인
- `agency_members.user_id` 컬럼에 인덱스가 있는지 확인
- `client_members.user_id` 컬럼에 인덱스가 있는지 확인

### 5.2 Vercel 배포 상태 확인
- 현재 배포 중인지 확인
- 빌드/배포로 인한 일시적 지연 가능성

### 5.3 Supabase 연결 풀 확인
- 동시 연결 수 제한 확인
- 연결 풀 설정 확인

---

## 6. 권장 조치사항

### 즉시 조치 (행사 종료 후)
1. ✅ 대시보드 접속자 목록 배치 조회로 변경 (가장 우선)
2. ✅ 등록 확인 API 이름 매칭 개선
3. ✅ 가입 API 사용자 검색 최적화 적용
4. ✅ 대시보드 API 병렬 쿼리 적용
5. ✅ 클라이언트 대시보드 병렬 쿼리 적용

### 모니터링
1. Supabase 대시보드에서 쿼리 성능 모니터링
2. Vercel 대시보드에서 API 응답 시간 모니터링
3. 에러 로그 확인

### 장기 개선
1. 하트비트 Throttle 최적화 검토
2. 데이터베이스 인덱스 최적화
3. 캐싱 전략 도입 검토

---

## 7. 참고 자료

- 대시보드 접속자 목록: `app/(admin)/webinar/[id]/console/components/DashboardTab.tsx`
- 등록 확인 API: `app/api/webinars/[webinarId]/check-registration/route.ts`
- 가입 API: `app/api/auth/email-signup/route.ts`
- 대시보드 API: `app/api/auth/dashboard/route.ts`
- 클라이언트 대시보드: `app/(client)/client/[clientId]/dashboard/page.tsx`
- 하트비트 API: `app/api/webinars/[webinarId]/presence/ping/route.ts`
