# 이메일 안내 접속 시 채팅 표시명 검토

**작성일**: 2026-02-08  
**대상 사례**: 이메일 안내로 접속한 참가자(이름: 양승철, 이메일: jubileo@naver.com)가 채팅창에 **"jubileo"**로 표시된 현상

---

## 1. 현상

- 참가자: **양승철** (jubileo@naver.com)
- 이메일 안내 링크로 웨비나 접속
- 채팅창에는 **"양승철"이 아닌 "jubileo"**로 표시됨

---

## 2. 원인

### 2.1 채팅 표시명 결정 순서

채팅 컴포넌트(`components/webinar/Chat.tsx`)에서 표시명(displayName)은 아래 **우선순위**로 결정됩니다.

1. **registrations.nickname** (웨비나별 등록 시 입력한 닉네임)
2. **profiles.nickname**
3. **profiles.display_name**
4. **profiles.email** (전체 이메일 주소)
5. 없으면 **"익명"**

### 2.2 이메일 링크 자동 로그인 시 저장되는 값

- 입장 경로: 이메일 안내 링크 클릭 → `/webinar/{slug 또는 id}?email=...` (또는 캠페인 이메일이면 `?name=양승철&email=...`)
- **자동 로그인** 시 `WebinarEntry.tsx`에서 호출하는 API:
  - `POST /api/auth/email-signup`
  - **전달 body**: `{ email, webinarId }` 만 전달됨. **이름(nickname, displayName)은 전달하지 않음.**

### 2.3 서버에서 display_name 설정

`app/api/auth/email-signup/route.ts` 에서:

- 요청에서 `nickname` / `displayName` 이 **없으면** 다음처럼 설정함.
  - `display_name` = `nickname?.trim() || email.trim().split('@')[0]`
  - 즉 **이메일 @ 앞부분("jubileo")** 이 display_name 으로 들어감.
- `profiles` 테이블에 `display_name: "jubileo"`, `nickname: null` 등으로 저장됨.

### 2.4 정리

| 구분 | 내용 |
|------|------|
| **직접 원인** | 이메일 링크로 입장할 때 **URL의 name(양승철)을 email-signup API에 보내지 않음** |
| **결과** | 서버가 이름을 모르므로 **이메일 로컬 파트("jubileo")를 display_name**으로 사용 |
| **채팅 표시** | registrations.nickname 없음 → profiles.nickname 없음 → **profiles.display_name "jubileo"** 사용 → 채팅에 "jubileo" 표시 |

---

## 3. 현재 플로우 요약

1. **등록 확인 메일** (`lib/email.ts`): 입장 링크에 `?email=수신자이메일` 만 포함. **이름 없음.**
2. **캠페인 이메일** (Resend): `entry_url` 에 `?name=이름&email=이메일` 포함 가능하나, **자동 로그인 요청 시 name 을 API에 넘기지 않음.**
3. **email-signup**: nickname/displayName 이 없으면 `email.split('@')[0]` 로 display_name 설정.
4. **채팅**: profiles.display_name → "jubileo" 표시.

---

## 4. 개선 방안 (검토용, 미적용)

- **방안 A**: 이메일 링크 자동 로그인 시 **URL의 `name` 쿼리**가 있으면 `email-signup` 에 `nickname` / `displayName` 으로 전달.  
  - 캠페인 이메일(`?name=양승철&email=...`)로 들어온 경우 채팅에 "양승철" 표시 가능.
- **방안 B**: 등록 확인 메일 발송 시 **등록자 이름**이 있으면 링크에 `?name=...&email=...` 포함.  
  - 단, 현재 `sendWebinarRegistrationEmail` 호출부에서 이름을 넘기고 있는지, 등록 데이터에 이름이 있는지 확인 필요.
- **방안 C**: email-signup 에서 **등록/설문 데이터**(registrations, event_survey_entries 등)에 해당 이메일의 이름이 있으면 그걸로 display_name/nickname 설정.  
  - DB 조회 추가, 기존 사용자 업데이트 정책(덮어쓸지 여부) 검토 필요.

현재는 **시스템 확인 단계**이므로 위 방안은 검토용으로만 두고, 코드 변경은 하지 않음.

---

## 5. 이메일로 접속한 사람의 등록자·참석자 통계 (어떻게 찾고 있었는지)

이메일 안내 링크로 들어온 사용자(예: 양승철 jubileo@naver.com)가 **등록자 수**와 **참석자 수**에서 어떻게 집계되는지 정리한다.

### 5.1 흐름 요약

1. **이메일 링크 클릭** → 입장 페이지에서 `email-signup` 호출 → 로그인(임시 비밀번호) → **라이브 페이지(`/webinar/.../live`)로 리다이렉트**
2. **라이브 페이지 로드** 시 `WebinarView` 등에서 **`POST /api/webinars/[webinarId]/access/track`** 호출
3. **access/track** 에서:
   - `registrations` 에 해당 user 있는지 확인
   - **없으면** → `registrations` 에 **자동 등록**(upsert, `registered_via: 'manual'`)
   - **`webinar_live_presence`** 에 행 추가·갱신 (**`joined_at`**, `last_seen_at` 설정)
   - **`webinar_user_sessions`** 에 접속 세션 기록(entered_at 등)
4. 별도로 **입장 직후** `WebinarEntry` 또는 라이브 측에서 **`POST /api/webinars/[webinarId]/register`** 를 호출할 수도 있음(이미 등록돼 있으면 무시).

즉, **이메일로만 들어온 사람**은 **라이브 페이지에 한 번이라도 들어오면** access/track 을 통해 `registrations` 와 `webinar_live_presence` 에 들어가므로, **등록자·참석자 통계에 포함**된다.

### 5.2 등록자(총 등록자 수) — 어떻게 찾는지

- **API**: `GET /api/webinars/[webinarId]/stats/registrants`  
- **집계 기준**:
  - **등록 캠페인이 있는 웨비나** (`registration_campaign_id` 있음):  
    **`event_survey_entries`** 에서 `campaign_id = registration_campaign_id` 인 **행 수** = 총 등록자 수.  
    (설문/등록 폼 제출한 사람 수. 이메일로 나중에 접속한 사람도, **먼저 설문/등록으로 제출한 이메일이면** 이 수에 포함됨.)
  - **등록 캠페인 없음** (또는 slug `426307` 원프레딕트 전용):  
    **`registrations`** 테이블에서 `webinar_id` 일치하는 **행 수** = 총 등록자 수.  
    이메일로 접속한 사람은 **access/track 또는 register** 에서 자동으로 `registrations` 에 들어가므로 **이 수에 포함**된다.

정리하면, **이메일로 접속한 사람**은  
- 등록 캠페인 웨비나: **등록자 수**에는 **설문/등록 제출 이력(event_survey_entries)** 으로만 포함되고,  
- 등록 캠페인 없는 웨비나: **등록자 수**는 **registrations** 기준이므로 **라이브 접속 시 자동 등록**으로 포함된다.

### 5.3 참석자(입장한 사람 수) — 어떻게 찾는지

- **API**: `GET /api/webinars/[webinarId]/stats/access` (또는 통합 stats 의 `sections=access`)  
- **집계 기준**:  
  **`webinar_live_presence`** 테이블에서  
  `webinar_id` 일치하고 **`joined_at` 이 NOT NULL** 인 행에 대한 **고유 `user_id` 수** = **총 참석자 수** (`totalAttendees`).

access/track 이 **로그인 사용자**에 대해 `webinar_live_presence` 를 upsert 할 때 **`joined_at`** 을 설정하므로, 이메일로 로그인 후 라이브에 한 번이라도 들어온 사람은 **참석자 수에 포함**된다.

### 5.4 등록자 목록(이름·이메일·접속 시각 등) — 어떻게 찾는지

- **API**: `GET /api/webinars/[webinarId]/registrants`  
- **목록 출처**:
  - **등록 캠페인 있는 웨비나**: **`event_survey_entries`** 만 사용.  
    이름·이메일·회사 등은 등록/설문 제출 데이터.  
    **첫 접속 시각(`first_accessed_at`)** 은 등록 이메일과 **profiles** 의 이메일로 **user_id** 를 맞춘 뒤, **`webinar_user_sessions`** 에서 해당 user 의 최초 `entered_at` 으로 채운다.  
    → 이메일로 접속한 사람은 **같은 이메일**로 auth 되어 있으므로, **세션 기록이 있으면** 등록자 목록에서도 “접속함”으로 나온다.
  - **등록 캠페인 없는 웨비나**: **`registrations`** 기준.  
    이름은 `registrations.nickname` → `profiles.display_name` → `profiles.email` 순.  
    이메일로 접속한 사람은 access/track 으로 **registrations** 에 들어가므로 **등록자 목록에 한 명으로** 나오고, **first_accessed_at** 은 **webinar_user_sessions** 기준으로 채워진다.

### 5.5 요약 표

| 구분 | 데이터 소스 | 이메일로 접속한 사람이 포함되는 조건 |
|------|-------------|--------------------------------------|
| **등록자 수** (캠페인 있음) | `event_survey_entries` (campaign_id) | 설문/등록 폼에서 **해당 이메일로 이미 제출한 경우** 에만 수에 포함 |
| **등록자 수** (캠페인 없음) | `registrations` | 라이브 접속 시 **access/track** (또는 register)에서 **자동 등록**되므로 포함 |
| **참석자 수** | `webinar_live_presence` (joined_at NOT NULL, 고유 user_id) | 라이브 접속 시 **access/track** 에서 **joined_at** 이 설정되므로 포함 |
| **등록자 목록** (캠페인 있음) | `event_survey_entries` + `webinar_user_sessions` 등 | 등록 이메일과 동일한 **auth user** 가 세션을 남기면 **first_accessed_at** 등으로 표시 |
| **등록자 목록** (캠페인 없음) | `registrations` + `webinar_user_sessions` 등 | access/track 으로 **registrations** 에 들어가므로 **한 명으로 목록에 표시** |

---

**문서 버전**: 1.1  
**최종 업데이트**: 2026-02-08
