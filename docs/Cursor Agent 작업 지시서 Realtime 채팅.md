옵션은 **2번(Realtime 테스트 스크립트 생성)**으로 가는 게 맞고, 너가 말한 “200명이 1~2개씩 채팅 + 응답 받는 테스트”는 **Playwright가 딱 맞는 케이스**야. 수동으로는 절대 재현/비교가 안 돼.

아래를 그대로 Cursor Agent에게 던지면, **코드 직접 작성 지시 없이도**(=판단 기준/명세/DoD 중심으로) Playwright 테스트를 체계적으로 만들 수 있어.

---

## Cursor Agent 작업 지시서: S2(200명) Realtime 채팅/Q&A 자동 테스트 구축

### 목적

* S2(200명) 규모에서 **Realtime 채팅 + Q&A 생성/반영**이

  1. 연결/구독이 안정적인지
  2. 메시지/질문이 **누락 없이** 다른 클라이언트에 **전파되는지**
  3. 지연(p95)이 목표 범위 내인지
     를 자동으로 검증한다.

### 왜 필요한가

* 입장 테스트는 API/SSR만 검증하며, **Supabase Realtime Broadcast(웹소켓) 계층의 안정성**은 검증하지 못함.
* 재연결 루프, subscribe 실패, 수신 누락, UI 반영 지연은 **브라우저 기반 자동화**가 아니면 재현 불가.

---

## 전제 조건

* 웨비나: `149400` (또는 테스트용 webinarId)
* 입장 URL/enter API는 이미 검증됨
* 채팅/Q&A는 Realtime Broadcast 기반(구독 성공/수신 이벤트가 핵심)

---

## 구현 범위 (이번 스프린트는 “A+B+C 최소세트”)

### 시나리오 A: Realtime 연결/구독 내구성 (S2=200명)

**목표**

* 200명 모두 `webinar:{id}` 채널 **SUBSCRIBED** 성공

**측정**

* subscribe 성공률(%)
* subscribe까지 걸린 시간 p50/p95
* `CHANNEL_ERROR`, `CLOSED` 발생 횟수

**DoD**

* subscribe 성공률 ≥ 99%
* `SUBSCRIBED→CLOSED` 루프 0

---

### 시나리오 B: 채팅 fan-out + 수신 확인 (200명, 1~2개씩)

**목표**

* 200명 중 100명은 2개, 100명은 1개 전송(총 300msg)
* 모든 클라이언트가 최소 “타인 메시지 N개 이상” 수신(수신 누락 검출)

**핵심 포인트**

* “보냈다”가 아니라 **다른 브라우저 세션에서 수신했는지**를 검증해야 함

**측정**

* 전송 성공률(%)
* 수신 누락률(받아야 하는 메시지 대비)
* 전송→수신 지연 p95
* 중복 수신률(같은 메시지 2번 이상 반영)

**DoD(초기 목표)**

* 전송 성공률 99.9%+
* 수신 누락률 ≤ 0.5% (초기 목표, 안정화 후 0.1%로 강화)
* 지연 p95 ≤ 2초

---

### 시나리오 C: Q&A 생성 + 관리자 반영(최소)

**목표**

* 50명이 질문 1개씩 등록(총 50)
* 관리자 1명이 그중 10개에 답변/고정/숨김(상태 변경 이벤트)

**측정**

* 질문 등록 성공률
* 상태 변경 성공률
* 참여자 화면에서 상태 변화 반영 지연 p95

**DoD**

* 참여자 화면과 관리자 화면 간 상태 불일치 0
* 지연 p95 ≤ 3초(초기)

---

## 테스트 설계 디테일 (중요한 결정 기준)

### 1) “채널 구독 완료 게이트”를 반드시 둔다

* 모든 사용자는 “SUBSCRIBED 확인” 전에는 메시지/질문 전송을 시작하지 않음
* 구독 실패 사용자는 “실패 집계”로 남기고, 재시도는 최대 2회까지만(무한 재시도 금지)

### 2) 메시지 식별자는 “테스트용 고유 ID”를 포함해야 한다

* 각 메시지/질문 내용에 `TEST_RUN_ID` + `USER_SEQ` + `MSG_SEQ` 포함
* 그래야 “누락/중복”을 정확히 측정 가능

### 3) 부하를 ‘한꺼번에 폭발’시키지 말고, 현실적 러시를 흉내 낸다

* 200명이 동시에 전송하면 그 자체가 비현실적인 스파이크
* 전송은 30~60초 창에서 랜덤 분산(지터)
* 1인당 1~2개로 제한(요청한 조건)

### 4) 측정은 “브라우저 내부 이벤트 기준”으로 한다

* 단순히 API 응답 200만으로는 fan-out을 검증 못함
* 브라우저에서 수신 이벤트를 카운트하고, 특정 메시지 ID가 도달했는지로 판정

---

## 산출물 (Cursor가 만들어야 할 것)

1. `docs/loadtest/realtime-s2-report.md`

* A/B/C 결과 요약(성공률/지연/누락률/에러)
* DoD PASS/FAIL 결론
* 실패 시 “어디가 병목인지” 추정(구독/전송/API/수신)

2. `docs/loadtest/realtime-s2-runbook.md`

* 실행 커맨드(로컬/CI)
* 필요한 env 목록
* 테스트 대상 webinarId, URL, 계정/토큰 준비 방식

3. (선택) `docs/loadtest/realtime-scenarios.md`

* 추후 S3(500), S4(1000) 확장 시 파라미터만 바꿔 재실행 가능하게

---

## 완료 조건(Definition of Done)

* S2(200명)에서 시나리오 A/B/C를 자동 실행할 수 있다.
* 결과 리포트에 아래 수치가 모두 포함된다:

  * subscribe 성공률, p95
  * 메시지 전송 성공률
  * 메시지 수신 누락률/중복률
  * 전송→수신 지연 p95
  * Q&A 상태 반영 지연 p95
* PASS면 “S3(500)”로 올릴 수 있는 근거가 된다.

---

## “지금 결정”

✅ **Realtime 테스트 스크립트 생성으로 진행**
그리고 너가 원하는 **“200명이 1~2개씩 채팅하고 응답받는 테스트”**는 위 시나리오 B로 정확히 충족됨.

---

원하면, “채팅”만 먼저(A+B) 만들고 1차로 S2를 돌린 뒤, Q&A(C)를 2차로 붙이는 **2단계 플랜**으로 더 빠르게 갈 수도 있어.
