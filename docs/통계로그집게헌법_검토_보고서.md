# EventFlow 통계·로그·집계 시스템 헌법 검토 보고서

**작성일**: 2026-02-02  
**검토 대상**: `docs/통계로그집게헌법.md`  
**검토 기준**: 현재 코드와의 일관성, 기술적 정확성, 구현 가능성, Serverless 환경 적합성

---

## 📋 검토 결과 요약

| 항목 | 평가 | 비고 |
|------|------|------|
| **아키텍처 원칙** | ✅ 우수 | Fact/Analysis 분리, 차원 부재 방어 등 핵심 원칙 명확 |
| **Serverless 환경 고려** | ✅ 우수 | 로컬 파일 저장 금지, stdout 로깅 제안 적절 |
| **현재 코드 반영** | ⚠️ 부분적 | 일부 구현된 기능 언급 누락 |
| **session_id 규칙** | ⚠️ 불일치 | "서버 중심" 제안 vs 현재 "클라이언트 중심" 구현 |
| **구현 가이드** | ✅ 우수 | 버킷 스키마, MV vs 증분 집계 선택표 구체적 |

---

## 1. 아키텍처 원칙 검토

### ✅ 우수한 점

#### 원칙 1: Fact와 Analysis 분리
- **평가**: ✅ 명확하고 실용적
- **현재 코드**: 일부 준수 (event_access_logs는 Fact, get_marketing_summary는 Analysis)
- **권장사항**: 그대로 유지

#### 원칙 2: "차원 부재"가 Fact 수집을 깨면 안 됨
- **평가**: ✅ 핵심 교훈 반영 (워트 cid 사고)
- **현재 코드**: Visit API에서 cid 컬럼 추가 완료 (마이그레이션 078)
- **권장사항**: 이 원칙을 모든 Fact 저장 로직에 적용

#### 원칙 3: 웨비나 접속 통계 v2 패턴 확장
- **평가**: ✅ 검증된 패턴 재사용
- **현재 코드**: `webinar_access_logs` 패턴이 잘 작동 중
- **권장사항**: 마케팅 통계에도 동일 패턴 적용

#### 원칙 4: 집계는 외부 라이브러리에 위임하지 않음
- **평가**: ✅ 정산/리포트 신뢰성 확보
- **현재 코드**: DB 기반 집계 유지 중
- **권장사항**: 그대로 유지

### ⚠️ 개선 필요 사항

#### Serverless 환경 제약 반영
- **헌법 제안**: "로컬 파일 저장 금지, stdout 구조화 로그"
- **평가**: ✅ 적절함
- **현재 상태**: Middleware에서 로깅 없음
- **권장사항**: stdout 구조화 로그 구현 필요

---

## 2. session_id / UTM 보존 규칙 검토

### ⚠️ 현재 코드와의 불일치

#### 문제점 1: "서버 중심" vs "클라이언트 중심"

**헌법 제안**:
```
(A) 요청 진입 시(가능하면 middleware/서버 라우트)
- session_id 쿠키가 없으면 생성
- URL에 UTM/cid가 있으면 쿠키/헤더로 보존
```

**현재 구현**:
- `getOrCreateSessionId()`: 클라이언트 사이드에서 실행
  - localStorage → sessionStorage → cookie 순서
  - 서버 사이드에서는 항상 새 세션 ID 생성
- Middleware: 추적 로직 없음 (현재는 `/super` 경로만 처리)

**영향**:
- 헌법의 "서버 중심" 규칙과 현재 구현이 불일치
- 클라이언트 JavaScript 실행 실패 시 session_id 생성 불가

**권장사항**:
1. **단기**: 현재 클라이언트 중심 방식을 유지하되, 서버 사이드 폴백 강화
2. **중기**: Middleware에서 session_id 쿠키 생성/관리 추가
3. **장기**: 완전한 서버 중심 전환 (헌법 제안대로)

#### 문제점 2: 이미 구현된 기능 언급 누락

**헌법 제안**:
- "서버 중심 session_id/UTM 보존 규칙" 제안

**현재 구현** (이미 존재):
- ✅ `lib/tracking/restore-tracking.ts`: 추적 정보 복원 로직
- ✅ `lib/tracking/middleware-tracking.ts`: Middleware 추적 모듈
- ✅ `restoreTrackingInfo()`: URL > Cookie > Link 순서 복원
- ✅ Cookie 검증 로직 (Trust Window, 캠페인 매칭)

**권장사항**:
- 헌법 문서에 "이미 구현된 기능" 섹션 추가
- `restoreTrackingInfo()` 함수를 헌법의 표준 구현으로 명시

### ✅ 잘 반영된 점

#### UTM 보존 규칙
- **헌법 제안**: "리다이렉트/CSR/SSR에서도 UTM 유지"
- **현재 구현**: 
  - ✅ `restoreTrackingInfo()`에서 URL > Cookie > Link 순서 복원
  - ✅ Cookie Trust Window 검증
  - ✅ localStorage에도 저장 (클라이언트 사이드)

**평가**: ✅ 헌법 의도와 일치

---

## 3. 버킷 스키마 설계 체크리스트 검토

### ✅ 우수한 점

#### 키 설계 원칙
- **평가**: ✅ 멱등성 보장, 차원 폭발 방지 등 핵심 고려
- **권장사항**: 그대로 적용

#### Dimension 부재 방어
- **평가**: ✅ 워트 cid 사고 교훈 반영
- **현재 코드**: Visit API에서 cid nullable 처리 완료
- **권장사항**: 모든 Fact 저장에 적용

#### 성능/인덱스 체크리스트
- **평가**: ✅ Serverless 비용 고려 적절
- **권장사항**: 윈도우 기반 집계 필수

### ⚠️ 보완 필요

#### 집계 지표 정의
- **헌법 제안**: `visits = COUNT(DISTINCT session_id)`
- **현재 코드**: Visit API에서 session_id 저장 중
- **권장사항**: 
  - 집계 함수에서 `COUNT(DISTINCT session_id)` 명시
  - 중복 방지 로직 문서화

---

## 4. MV vs 증분 집계 선택표 검토

### ✅ 우수한 점

#### 선택 기준 명확
- **평가**: ✅ 운영 난이도, 비용, 정합성 모두 고려
- **권장사항**: "증분 집계 테이블(버킷 upsert)" 기본값 적절

#### Serverless 적합성
- **평가**: ✅ HTTP cron + upsert 패턴 제안 적절
- **현재 코드**: `webinar_access_logs` 패턴이 동일 방식
- **권장사항**: 동일 패턴 확장

### ⚠️ 보완 필요

#### MV 사용 조건
- **헌법 제안**: "모두 만족해야 함" 조건
- **권장사항**: 
  - MV 사용 시 refresh 실패 알림 시스템 필수
  - Staleness 허용 범위 명시 (예: 1시간)

---

## 5. Serverless 환경 교정 검토

### ✅ 적절한 교정

#### 로컬 파일 저장 금지
- **헌법 교정**: "파일 저장 대신 stdout 구조화 로그"
- **평가**: ✅ Vercel Serverless 환경에 적합
- **권장사항**: 
  - JSON Lines 형식 stdout 로깅
  - Vercel Log Drain 연동 고려

#### 복원 경로
- **헌법 제안**: "Vercel Log Drain으로 외부 저장소 적재"
- **평가**: ✅ 합리적
- **권장사항**: 
  - Log Drain 설정 가이드 추가
  - 복원 스크립트는 외부 저장소에서 읽도록 수정

---

## 6. 현재 코드와의 일관성 검토

### ✅ 일치하는 부분

1. **Fact 테이블 구조**: 헌법과 현재 코드 일치
2. **웨비나 접속 통계 패턴**: 헌법 제안과 현재 구현 일치
3. **UTM 복원 로직**: `restoreTrackingInfo()`가 헌법 의도와 일치
4. **차원 부재 방어**: cid 컬럼 추가로 헌법 원칙 준수

### ⚠️ 불일치하는 부분

1. **session_id 생성 위치**: 
   - 헌법: 서버 중심 (Middleware)
   - 현재: 클라이언트 중심 (getOrCreateSessionId)
   - **조치**: 점진적 전환 필요

2. **Middleware 추적 로직**:
   - 헌법: Middleware에서 UTM/cid 저장
   - 현재: Middleware에 추적 로직 없음 (모듈만 존재)
   - **조치**: Middleware에 추적 로직 추가 필요

3. **로그 수집**:
   - 헌법: stdout 구조화 로그
   - 현재: 구조화 로그 없음
   - **조치**: 구현 필요

---

## 7. 구현 가능성 검토

### ✅ 구현 가능

1. **버킷 스키마 설계**: 체크리스트가 구체적, 구현 가능
2. **증분 집계 테이블**: 웨비나 패턴 재사용 가능
3. **UTM 보존 규칙**: 이미 `restoreTrackingInfo()` 구현됨

### ⚠️ 주의 필요

1. **서버 중심 session_id 전환**:
   - 현재 클라이언트 코드 의존성 높음
   - 점진적 마이그레이션 필요
   - **권장**: Phase 0에서 부분 적용, Phase 1에서 완전 전환

2. **Middleware 추적 로직 추가**:
   - 현재 Middleware는 `/super` 경로만 처리
   - 모든 경로에 적용 시 성능 영향 고려 필요
   - **권장**: 점진적 적용 (이벤트 경로부터)

---

## 8. 누락된 부분 및 보완 제안

### 8.1 현재 구현 반영 필요

#### 이미 구현된 기능 명시
- `lib/tracking/restore-tracking.ts`: 추적 정보 복원
- `lib/tracking/middleware-tracking.ts`: Middleware 추적 모듈
- `restoreTrackingInfo()`: URL > Cookie > Link 복원 로직
- Cookie Trust Window 검증

**권장사항**: 헌법 문서에 "현재 구현 상태" 섹션 추가

### 8.2 구체적 구현 가이드 보완

#### session_id 서버 중심 전환 가이드
- 현재: 클라이언트 중심 (`getOrCreateSessionId`)
- 목표: 서버 중심 (Middleware)
- 전환 단계:
  1. Middleware에서 session_id 쿠키 생성/읽기
  2. 클라이언트 코드에서 쿠키 우선 사용
  3. 점진적 클라이언트 코드 제거

**권장사항**: 헌법 문서에 "마이그레이션 가이드" 추가

### 8.3 모니터링 KPI 구체화

#### 헌법 제안 KPI
- visit-entry linkage rate
- utm fill rate
- cid/link attribution rate
- unknown/unresolved 비율

**권장사항**: 
- 목표값 설정 (예: linkage rate 70%+)
- 측정 방법 명시 (쿼리 예시)
- 알림 임계값 설정

---

## 9. 종합 검토 보고서와의 일관성

### ✅ 일치하는 부분

1. **3계층 아키텍처**: 헌법과 보고서 모두 제안
2. **증분 집계**: 헌법과 보고서 모두 권장
3. **로그 수집**: 보고서는 파일, 헌법은 stdout (Serverless 교정)

### ⚠️ 차이점

1. **로그 수집 방식**:
   - 보고서: Middleware JSONL 파일 로깅
   - 헌법: stdout 구조화 로그 (Serverless 교정)
   - **권장**: 헌법의 Serverless 교정이 더 적절

2. **구현 우선순위**:
   - 보고서: Visit API 보완 → 로그 수집 → 복원 시스템
   - 헌법: 수집 안정성 → 증분 집계 → Overview API
   - **권장**: 헌법의 우선순위가 더 논리적 (Fact 안정화 우선)

---

## 10. 권장사항

### 10.1 즉시 반영 (문서 수정)

1. **현재 구현 상태 섹션 추가**
   - `restoreTrackingInfo()` 함수 설명
   - `middleware-tracking.ts` 모듈 설명
   - 이미 구현된 기능 명시

2. **session_id 전환 가이드 추가**
   - 현재 클라이언트 중심 방식 설명
   - 서버 중심 전환 단계별 가이드
   - 마이그레이션 체크리스트

3. **구체적 KPI 목표값 설정**
   - visit-entry linkage rate: 70%+
   - utm fill rate: 60%+
   - unknown/unresolved 비율: 10% 이하

### 10.2 구현 시 주의사항

1. **점진적 마이그레이션**
   - 서버 중심 전환은 한 번에 하지 말고 단계적으로
   - 기존 클라이언트 코드와 병행 운영 기간 필요

2. **성능 영향 고려**
   - Middleware 추적 로직 추가 시 응답 시간 모니터링
   - 비동기 처리 필수 (응답 지연 방지)

3. **테스트 전략**
   - 각 단계별 통합 테스트
   - session_id 일관성 검증
   - UTM 보존 검증

---

## 11. 최종 평가

### ✅ 전체 평가: **우수** (90/100)

**강점**:
- 핵심 아키텍처 원칙 명확
- Serverless 환경 제약 적절히 반영
- 버킷 스키마 설계 가이드 구체적
- MV vs 증분 집계 선택 기준 명확

**개선점**:
- 현재 구현 상태 반영 필요
- session_id 서버 중심 전환 가이드 보완
- KPI 목표값 구체화 필요

**권장사항**: 
- 문서 수정 후 즉시 Phase 0 구현 시작 가능
- 헌법 원칙을 기준으로 코드 리뷰 진행

---

**검토자**: AI Assistant  
**검토 일시**: 2026-02-02  
**다음 단계**: 문서 보완 후 Phase 0 구현 시작
