# 서버 로그 기반 Source 추정 분석 결과

**작성일**: 2026-02-02  
**목적**: UTM이 없는 등록 데이터를 서버 로그로 추정 가능한지 검증

---

## 📌 핵심 결론

> **현재 서버에 저장된 정보만으로는 추정이 불가능합니다.**
> 
> 이유:
> - `utm_referrer`가 저장된 항목: **0개**
> - Visit 로그: **10개** (528개 등록 대비 1.9%)
> - 매칭 가능한 데이터: **거의 없음**

---

## 🔍 분석 결과

### 1. 데이터 현황

#### 추정 대상
- **Direct 항목**: 528개
- **UTM 있는 항목**: 1개

#### 서버에 저장된 정보
- `utm_referrer`가 있는 항목: **0개**
- Visit 로그 (`event_access_logs`): **10개**
- Visit 로그 매칭률: **1.9%** (10/528)

### 2. 추정 시도 결과

#### 시도한 방법
1. ✅ Visit 로그에서 session_id 매칭
2. ✅ Visit 로그에서 시간 상관관계 매칭 (±5분)
3. ✅ Entry의 `utm_referrer` 사용
4. ✅ Referer 기반 추정 룰셋 적용
5. ✅ User-Agent 기반 추정 룰셋 적용

#### 결과
- **추정 성공**: 0개
- **추정 실패**: 528개 (100%)
- **추정 불가 이유**: `insufficient_data` (데이터 부족)

---

## 💡 왜 추정이 안 되나?

### 문제점

1. **Visit 로그 부재**
   - Visit 추적이 제대로 작동하지 않았거나
   - 대부분의 유입이 Visit 로그 없이 등록으로 바로 전환됨

2. **Referer 정보 미저장**
   - `utm_referrer` 컬럼은 있지만 실제로 저장된 데이터가 없음
   - 등록 API에서 referer를 받지 않았거나 저장하지 않았을 가능성

3. **세션 추적 미흡**
   - `session_id`가 등록 데이터에 저장되지 않음
   - Visit과 등록을 연결할 수 없음

---

## ✅ 추정이 가능하려면 필요한 것

### 현재 구조에서 가능한 방법

#### 1. Vercel 로그 파싱 (가능)

**전제 조건**:
- Vercel 대시보드에서 서버 로그 접근 가능
- 로그에 Referer, User-Agent 정보 포함

**방법**:
```bash
# Vercel CLI로 로그 다운로드
vercel logs --follow

# 또는 Vercel 대시보드에서 로그 확인
# → register API 호출 시점의 Referer 확인
```

**장점**:
- 실제 HTTP 요청의 Referer 확인 가능
- User-Agent 확인 가능

**단점**:
- 로그 보관 기간 제한 (보통 7-30일)
- 과거 데이터는 이미 삭제되었을 수 있음

#### 2. 시간대 패턴 분석 (가능)

**전제 조건**:
- 캠페인 발송 시간 정보 필요
- 뉴스레터 발송 시간, 광고 집행 시간 등

**방법**:
```sql
-- 특정 시간대에 몰린 Direct 유입 확인
SELECT 
  DATE_TRUNC('hour', created_at) AS hour,
  COUNT(*) AS direct_count
FROM event_survey_entries
WHERE utm_source IS NULL
  AND created_at BETWEEN '2026-01-30 10:00' AND '2026-01-30 11:00'
GROUP BY 1
ORDER BY 1;
```

**예시**:
- 뉴스레터 발송: 2026-01-30 10:00
- Direct 유입 폭증: 2026-01-30 10:02 ~ 10:40
- → 이 구간 Direct는 사실상 Email 유입 가능성 높음

**장점**:
- 추가 데이터 없이도 분석 가능
- 시간 상관관계로 추정 가능

**단점**:
- 정확도가 낮음 (추정일 뿐)
- 여러 캠페인이 동시에 발송되면 구분 불가

#### 3. Short-link 접근 로그 (가능)

**전제 조건**:
- `/s/[code]` 접근 로그가 있어야 함
- Short-link 코드와 등록 시간 매칭 가능해야 함

**방법**:
```sql
-- Short-link 접근 로그와 등록 시간 매칭
-- (현재 구조에서는 이 로그가 별도로 저장되지 않음)
```

**필요한 작업**:
- Short-link 접근 시 로그 저장 기능 추가
- 등록 시간과 ±5분 이내 매칭

---

## 🎯 실무적 해결 방안

### 옵션 1: 현재 데이터로 설명 (권장)

**메시지**:
> "해당 기간 등록 데이터 중 일부는 링크를 통해 유입되었지만,
> 추적 정보가 저장되지 않아 'Direct'로 분류되었습니다.
> 
> 실제 Direct 유입보다 과대 계상되어 있으며,
> 향후 구조적 개선을 통해 추적 성공률을 95% 이상으로 향상시킬 예정입니다."

**장점**:
- 사실에 기반한 설명
- 향후 개선 계획 제시

**단점**:
- 정확한 수치 제공 불가

### 옵션 2: 시간대 패턴 분석 추가

**방법**:
1. 캠페인 발송 시간 정보 수집
2. 시간대별 Direct 유입 패턴 분석
3. 발송 시간과 유입 시간 상관관계 확인

**예시 리포트**:
```
시간대별 Direct 유입 분석

2026-01-30 10:00-11:00: 40개
  → 뉴스레터 발송 시간(10:00)과 일치
  → 추정: Email 유입 가능성 높음

2026-01-30 14:00-15:00: 25개
  → 광고 집행 시간(14:00)과 일치
  → 추정: 광고 유입 가능성 높음
```

**장점**:
- 시간 상관관계로 추정 가능
- 어느 정도 신뢰도 있는 분석

**단점**:
- 정확한 Source는 알 수 없음
- 여러 캠페인이 겹치면 구분 불가

### 옵션 3: 향후 개선 후 재분석

**방법**:
1. 구조적 개선 완료 (서버 세션, 추적 스냅샷 등)
2. 새로운 등록부터 정확한 추적 시작
3. 과거 데이터는 "추적 실패"로 명확히 표시

**장점**:
- 향후 데이터는 정확하게 추적
- 과거 데이터는 명확히 구분

**단점**:
- 과거 데이터는 여전히 추정 불가

---

## 📋 향후 개선 사항

### 즉시 개선 가능

1. **등록 API에서 Referer 저장**
   ```typescript
   utm_referrer: req.headers.get('referer') || null
   ```

2. **Visit 로그 확대**
   - 모든 페이지 접근 시 Visit 로그 저장
   - 등록 페이지 접근도 Visit 로그로 기록

3. **세션 추적 강화**
   - 등록 시 `session_id` 저장
   - Visit과 등록 연결

### 구조적 개선

1. **서버 세션 관리** (Middleware)
   - 추적 정보를 서버 세션에 저장
   - 리다이렉트 후에도 유지

2. **추적 스냅샷 저장**
   - 원본 추적 정보 보존
   - 향후 분석/복원 가능

3. **Short-link 접근 로그**
   - `/s/[code]` 접근 시 로그 저장
   - 등록과 매칭 가능

---

## 🎯 권장 사항

### 현재 상황

1. ✅ **현재 데이터로는 추정 불가능** 인정
2. ✅ **명확한 설명 제공**: "추적 실패로 인한 Direct 오분류"
3. ✅ **향후 개선 계획 제시**: 구조적 개선으로 재발 방지

### 향후 개선

1. ✅ **구조적 개선 우선**: 서버 세션, 추적 스냅샷 등
2. ✅ **새 데이터부터 정확히 추적**: 과거는 과거로
3. ✅ **모니터링 강화**: 추적 성공률 95%+ 목표

---

## 관련 문서

- [UTM 추적 문제 원인 규명 및 해결방안](./UTM_추적_문제_원인_규명_및_해결방안.md)
- [링크 추적 구조 개선 방안](./링크_추적_구조_개선_방안.md)
- [집계 API 보정 로직 명세](./집계_API_보정_로직_명세.md)
