# 페이지뷰 로그 수집 시스템 구상

**작성일**: 2026-02-02  
**목적**: Visit API 실패/버그 시에도 복원 가능한 페이지뷰 로그 수집 시스템

---

## 🎯 목표

1. **모든 페이지에서 페이지뷰 기록**
   - 이벤트/캠페인 페이지
   - 웨비나 페이지 (입장, 라이브, 등록)
   - 짧은 링크 경유 페이지
   - 관리자/클라이언트 페이지 (선택적)

2. **이중화 로그 수집**
   - **1차**: DB 저장 (`event_access_logs`) - 정상 동작 시
   - **2차**: 구조화된 로그 파일 저장 - DB 실패 시 복원용

3. **복원 가능성**
   - 로그 파일에서 페이지뷰 복원
   - UTM 파라미터 복원
   - 세션 추적 복원

---

## 📋 시스템 아키텍처

### 1. Middleware 레벨 로깅 (서버 사이드)

**장점**:
- 클라이언트 JavaScript 실행 여부와 무관
- 모든 요청에 대해 로깅 가능
- 서버 사이드에서 안정적

**구현 위치**: `middleware.ts`

```typescript
// 모든 페이지뷰를 로그 파일에 기록
// DB 저장은 별도 API로 (비동기)
```

### 2. 클라이언트 사이드 Visit API (기존)

**역할**: 정상 동작 시 DB에 저장

**구현 위치**: 각 페이지 컴포넌트

---

## 🔧 구현 방안

### Phase 1: Middleware 레벨 페이지뷰 로깅

#### 1.1 구조화된 로그 파일 저장

**파일 위치**: `logs/pageviews/YYYY-MM-DD.jsonl` (JSON Lines 형식)

**로그 형식**:
```json
{
  "timestamp": "2026-02-02T18:46:00.000Z",
  "path": "/event/149403",
  "method": "GET",
  "query": {
    "utm_source": "email",
    "utm_medium": "newsletter",
    "cid": "ABC12345"
  },
  "referrer": "https://example.com",
  "user_agent": "Mozilla/5.0...",
  "ip": "1.2.3.4",
  "session_id": "session-xxx",
  "campaign_id": "3a88682e-...",
  "webinar_id": null,
  "client_id": "55317496-...",
  "status": "logged" | "db_saved" | "db_failed"
}
```

#### 1.2 Middleware 수정

**파일**: `middleware.ts`

**추가 기능**:
- 모든 공개 페이지 (`/event/*`, `/webinar/*`, `/s/*`) 요청 로깅
- 구조화된 로그 파일에 저장
- 비동기로 Visit API 호출 시도 (실패해도 로그는 남음)

---

### Phase 2: 웨비나 페이지 Visit API 추가

#### 2.1 웨비나 입장 페이지 (`/webinar/[id]`)

**파일**: `app/(webinar)/webinar/[id]/components/WebinarEntry.tsx`

**추가**: Visit API 호출 (웨비나 ID 또는 registration_campaign_id 사용)

#### 2.2 웨비나 라이브 페이지 (`/webinar/[id]/live`)

**파일**: `app/(webinar)/webinar/[id]/components/WebinarView.tsx`

**추가**: Visit API 호출

---

### Phase 3: 로그 파싱 및 복원 스크립트

#### 3.1 로그 파일 파싱

**스크립트**: `scripts/restore-pageviews-from-logs.ts`

**기능**:
- JSON Lines 로그 파일 읽기
- 중복 제거 (session_id + path + 시간 기준)
- `event_access_logs`에 복원

#### 3.2 UTM 복원

**스크립트**: `scripts/restore-utm-from-logs.ts`

**기능**:
- 로그에서 UTM 파라미터 추출
- 등록 시 UTM이 없는 경우 로그에서 복원

---

## 📝 구현 상세

### 1. 로그 파일 저장 모듈

**파일**: `lib/logging/pageview-logger.ts`

**기능**:
- 구조화된 로그 파일에 페이지뷰 기록
- 날짜별 파일 분리
- 비동기 쓰기 (성능 영향 최소화)

### 2. Middleware 로깅

**파일**: `middleware.ts` (수정)

**추가 로직**:
- 페이지뷰 로그 파일에 기록
- 비동기로 Visit API 호출 시도
- 실패해도 로그는 남음

### 3. 웨비나 페이지 Visit API

**파일들**:
- `app/(webinar)/webinar/[id]/components/WebinarEntry.tsx`
- `app/(webinar)/webinar/[id]/components/WebinarView.tsx`

**추가**: Visit API 호출 로직

---

## 🔄 복원 프로세스

### 시나리오 1: Visit API 실패

1. **로그 파일에 기록됨** ✅
2. **DB 저장 실패** ❌
3. **복원**: 로그 파일 파싱 → `event_access_logs`에 복원

### 시나리오 2: UTM 파라미터 유실

1. **로그 파일에 UTM 기록됨** ✅
2. **등록 시 UTM 없음** ❌
3. **복원**: 로그 파일에서 UTM 추출 → 등록 데이터 업데이트

### 시나리오 3: 세션 추적 실패

1. **로그 파일에 세션 ID 기록됨** ✅
2. **Visit-등록 연결 실패** ❌
3. **복원**: 로그 파일에서 세션 매칭 → 연결 복원

---

## 📊 예상 효과

| 항목 | 현재 | 개선 후 |
|------|------|---------|
| 페이지뷰 기록률 | 1.8% | 95%+ (로그 파일 기준) |
| 복원 가능성 | 없음 | 있음 (로그 파일 기반) |
| 데이터 손실 방지 | 없음 | 로그 파일 백업 |

---

## ⚠️ 고려사항

1. **로그 파일 크기 관리**
   - 날짜별 파일 분리
   - 오래된 로그 자동 아카이빙
   - 로그 로테이션 정책

2. **성능 영향**
   - 비동기 로깅 (메인 스레드 블로킹 없음)
   - 배치 쓰기 (여러 요청을 모아서 쓰기)

3. **보안**
   - IP 주소 마스킹 (GDPR 준수)
   - 개인정보 제외

4. **스토리지**
   - 로컬 파일 시스템 (개발)
   - 클라우드 스토리지 (운영) - S3, GCS 등

---

## 🎯 구현 우선순위

1. **최우선**: Middleware 레벨 로깅 모듈 생성
2. **최우선**: 웨비나 페이지 Visit API 추가
3. **중요**: 로그 파싱 및 복원 스크립트
4. **중요**: 로그 파일 관리 (로테이션, 아카이빙)

---

**다음 단계**: Phase 1 구현 시작
