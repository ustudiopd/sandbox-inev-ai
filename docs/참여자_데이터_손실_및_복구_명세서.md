# 참여자 데이터 손실 및 복구 명세서

**작성일**: 2026-02-03  
**사건 발생일**: 2026-02-03 새벽 (KST)  
**복구 완료일**: 2026-02-03  
**상태**: ✅ 복구 완료, 예방 조치 완료

---

## 📌 사건 요약

### 핵심 사실
- **작업 내용**: 177명 참여자 데이터에 UTM 데이터를 추가하는 작업
- **발생 문제**: 작업 중 기존 참여자 데이터 84개(survey_no 91-174)가 삭제됨
- **복구 방법**: Supabase Point-in-Time Recovery를 통한 물리적 백업 복구
- **복구 결과**: 175명 복구 성공, 2명(survey_no 176-177)은 수동 복구 후 삭제
- **최종 상태**: 175명의 실제 참여자 데이터 보존

### 교훈
> **데이터 수정 작업 전에 반드시 CSV 백업을 받아야 한다**

---

## 🔍 1. 사건 발생 과정

### 1.1 작업 배경
- **목적**: `event_survey_entries` 테이블의 177명 참여자 데이터에 `marketing_campaign_link_id` 및 UTM 파라미터 추가
- **작업 방식**: 스크립트를 통한 일괄 데이터 수정
- **예상 결과**: 기존 데이터에 UTM 정보만 추가되어야 함

### 1.2 문제 발생
- **발생 시점**: 2026-02-03 새벽 (KST)
- **작업 내용**: 
  - `event_survey_entries` 테이블에서 2026-02-02 데이터를 삭제
  - 87개의 전환 데이터를 재생성하는 과정에서 기존 데이터가 덮어쓰기됨
- **손실 내용**:
  - `survey_no` 91-174 범위의 실제 참여자 데이터 **84개 삭제**
  - 삭제된 데이터의 개인정보(이름, 이메일, 전화번호, 회사명 등) 모두 손실

### 1.3 발견 시점
- **발견**: 작업 완료 후 참여자 관리 페이지에서 더미 데이터(`[보정]` 표시)가 보임
- **확인**: 실제 참여자 데이터가 93개로 감소 (기대값: 177개)
- **조사 결과**: 
  - `survey_no` 1-90: 정상 (90개)
  - `survey_no` 91-174: **삭제됨 (84개)**
  - `survey_no` 175-177: 정상 (3개)

---

## 🚨 2. 손실 데이터 상세 분석

### 2.1 손실 범위
```
survey_no 범위: 91 ~ 174
손실 개수: 84개
날짜 범위: 2026-01-31, 2026-02-01 (KST 기준)
```

### 2.2 손실된 데이터 특성
- **실제 참여자 데이터**: 개인정보(이름, 이메일, 전화번호, 회사명) 포함
- **UTM 정보**: 대부분 `marketing_campaign_link_id`가 없었음
- **복구 불가능한 정보**: 
  - 개인정보 (이메일, 전화번호, 회사명 등)
  - 실제 참여 시각 (`completed_at`)
  - 기타 등록 시 입력한 정보

### 2.3 복구 시도 (실패)
1. **다른 테이블 확인**: `registrations`, `form_submissions`, `event_access_logs` 확인
   - 결과: 관련 데이터 없음
2. **더미 데이터 확인**: 생성된 더미 데이터에 실제 정보 포함 여부 확인
   - 결과: 모두 더미 데이터, 실제 정보 없음
3. **CSV 파일 확인**: 프로젝트 내 CSV 파일 확인
   - 결과: 해당 날짜 범위의 CSV 파일 없음

---

## ✅ 3. 복구 과정

### 3.1 Supabase 백업 확인
- **백업 유형**: Physical Restore (물리적 백업)
- **사용 가능한 백업 시점**:
  - `2026-02-02 16:11:04 UTC` (2026-02-03 01:11:04 KST)
  - `2026-02-01 16:07:10 UTC` (2026-02-02 01:07:10 KST)
  - 기타 이전 백업들

### 3.2 백업 시점 선택
- **선택한 백업**: `2026-02-02 16:11:04 UTC`
- **선택 이유**: 
  - 삭제 작업이 "새벽에" 발생했다고 사용자 확인
  - 해당 백업 시점이 삭제 작업 이전일 가능성 높음
  - 가장 최근 백업 중 하나

### 3.3 복구 실행
1. **Supabase 대시보드 접속**
   - Database → Backups 메뉴
   - Physical Restore 선택
   - `2026-02-02 16:11:04 UTC` 시점 선택
   - 복구 시작

2. **복구 진행**
   - 복구 시간: 수 분 ~ 수 시간 (데이터베이스 크기에 따라)
   - 상태: "Restoration in progress"
   - 완료: "Restoration complete! Your project has been successfully restored"

### 3.4 복구 결과 확인
- **복구된 데이터**: 175명의 실제 참여자 데이터
- **복구 범위**: `survey_no` 1-175
- **여전히 누락**: `survey_no` 176-177 (2개)

### 3.5 추가 복구 (survey_no 176-177)
- **상황**: 백업 시점 이후에 생성된 데이터로 추정
- **조치**: 사용자가 제공한 정보로 수동 생성
  - 이름, 회사명, 전화번호, 완료 시각 정보 제공
  - 스크립트로 `survey_no` 176-177 생성
- **후속 조치**: 이메일/전화번호가 없어 의미가 없다고 판단하여 삭제
- **최종 상태**: 175명의 실제 참여자 데이터 보존

---

## 📊 4. 복구 전후 비교

### 4.1 복구 전 (손실 후)
```
총 참여자: 93명
- survey_no 1-90: 90개 (정상)
- survey_no 91-174: 0개 (삭제됨)
- survey_no 175-177: 3개 (정상)
더미 데이터: 다수 존재 ([보정] 표시)
```

### 4.2 복구 후
```
총 참여자: 175명
- survey_no 1-175: 175개 (모두 실제 데이터)
- survey_no 176-177: 삭제됨 (이메일/전화번호 없음)
더미 데이터: 0개 (모두 필터링됨)
```

### 4.3 복구율
- **목표**: 177명 복구
- **실제 복구**: 175명 복구
- **복구율**: 98.9% (175/177)
- **손실**: 2명 (백업 시점 이후 생성된 데이터)

---

## 🛡️ 5. 예방 조치

### 5.1 `.cursorrules` 규칙 추가
데이터베이스 작업 규칙에 다음 내용 추가:

#### CSV 백업 필수
- **데이터 수정/삭제 작업 전에 반드시 CSV 백업을 받아야 함**
- 예: 177명 참여자 데이터에 UTM 데이터를 추가하는 작업 전에 해당 데이터를 CSV로 다운로드
- CSV 다운로드 방법:
  1. Supabase 대시보드에서 테이블 선택
  2. Export → CSV 다운로드
  3. 또는 스크립트로 `SELECT * FROM table_name` 쿼리 결과를 CSV로 저장

#### 데이터 수정 스크립트 작성 규칙
- 스크립트 시작 부분에 CSV 백업을 먼저 받도록 명시적으로 안내
- 수정할 데이터를 CSV로 다운로드 받았는지 확인
- CSV 백업 파일명과 저장 위치를 명시

#### 데이터 복구 원칙
- CSV 백업에서 복구 (최우선)
- Supabase 백업에서 복구 (물리적 백업)
- CSV 백업은 작업 전에 반드시 받아야 하며, 작업 후에도 보관해야 함

### 5.2 더미 데이터 생성 방지
- 모든 더미 데이터 생성 스크립트 비활성화 (`.disabled.ts`로 변경)
- 더미 데이터 생성 금지 규칙 명시

### 5.3 UI 필터링
- 참여자 관리 페이지에서 더미 데이터(`[보정]`, `[복구]` 등) 자동 필터링
- API 엔드포인트에 `.not('name', 'ilike', '%[보정]%')` 필터 추가

---

## 📝 6. 교훈 및 권장사항

### 6.1 핵심 교훈
1. **데이터 수정 작업 전 CSV 백업 필수**
   - Supabase 백업만으로는 부족할 수 있음
   - CSV 백업은 빠르고 간단하며, 특정 데이터만 선택적으로 백업 가능

2. **작업 전 현재 상태 확인**
   - 수정할 데이터의 현재 상태를 먼저 확인
   - 수정/삭제할 데이터 범위를 명확히 지정

3. **점진적 작업**
   - 대량 데이터를 한 번에 삭제/재생성하지 말고, 작은 단위로 나누어 작업
   - 각 단계마다 검증

4. **더미 데이터 생성 금지**
   - 통계 목적으로도 더미 데이터를 생성하지 않음
   - 실제 데이터만 사용

### 6.2 권장 작업 절차
```
1. CSV 백업 다운로드
   ↓
2. Supabase 백업 확인
   ↓
3. 현재 데이터 상태 확인 (스크립트로 검증)
   ↓
4. 수정 범위 명확히 지정
   ↓
5. --execute 플래그 없이 스크립트 실행 (Dry-run)
   ↓
6. 결과 검증
   ↓
7. --execute 플래그로 실제 실행
   ↓
8. 최종 검증
```

### 6.3 복구 불가능한 경우 대응
- **Supabase 백업**: Point-in-Time Recovery 활용
- **CSV 백업**: 작업 전에 받은 CSV에서 복구
- **수동 입력**: 최후의 수단 (더미 데이터 생성 금지)

---

## 🔗 7. 관련 문서 및 스크립트

### 7.1 관련 문서
- `docs/데이터_복구_가이드.md`: 데이터 복구 방법 가이드
- `docs/백업_복구_가이드.md`: Supabase 백업 사용 가이드
- `.cursorrules`: 데이터베이스 작업 규칙

### 7.2 관련 스크립트 (비활성화됨)
- `scripts/restore-87-conversions-final.disabled.ts`
- `scripts/restore-87-conversions.disabled.ts`
- `scripts/create-87-conversions-clean.disabled.ts`
- `scripts/force-recover-entries.disabled.ts`
- 기타 더미 데이터 생성 스크립트들

### 7.3 검증 스크립트
- `scripts/check-all-entries.ts`: 전체 참여자 데이터 확인
- `scripts/check-missing-entries.ts`: 누락된 데이터 확인
- `scripts/final-check-no-dummy.ts`: 더미 데이터 확인

---

## ✅ 8. 결론

### 8.1 복구 성공
- **175명의 실제 참여자 데이터 복구 성공**
- **복구율: 98.9%** (175/177)
- **2명 손실**: 백업 시점 이후 생성된 데이터로 복구 불가

### 8.2 예방 조치 완료
- **CSV 백업 필수 규칙 추가**
- **더미 데이터 생성 금지 규칙 명시**
- **데이터 수정 스크립트 작성 규칙 강화**

### 8.3 향후 개선사항
- 데이터 수정 작업 시 자동 CSV 백업 생성 기능 고려
- 작업 전 자동 검증 스크립트 실행
- 롤백 기능 내장

---

**작성자**: AI Assistant  
**검토자**: (사용자)  
**최종 업데이트**: 2026-02-03
