# 최초 메시지 누락 문제 해결책 검토 보고서

## 📋 검토 개요

`해결책.md`에서 제시한 최초 메시지 누락 문제 해결 방안을 현재 `Chat.tsx` 구현과 비교하여 검토했습니다.

---

## ✅ 이미 구현된 항목

### 1. 초기 로드 중 이벤트 버퍼링
- ✅ `pendingEventsRef` 구현됨 (83번 라인)
- ✅ 초기 로드 전 이벤트를 버퍼에 저장 (584-587번 라인)
- ✅ 초기 로드 완료 후 버퍼링된 이벤트 처리 (296-302번 라인)

### 2. 시간 기반 필터링 개선
- ✅ `created_at` 비교를 `<`로 변경 (716, 786번 라인) - 동일 시각 허용
- ✅ 초기 로드 후 2초 이내에는 시간 비교 비활성화 (706, 776번 라인)

### 3. 중복 체크 우선순위
- ✅ 중복 체크가 "과거 판정"보다 먼저 수행됨 (660-670, 764-772번 라인)

### 4. lastMessageIdRef 갱신
- ✅ 실시간 메시지 추가 시 `lastMessageIdRef` 갱신 (696-698, 739-741번 라인)

---

## ❌ 아직 구현되지 않은 항목 (최초 메시지 누락의 주요 원인)

### 1. **`prev.length === 0` 가드 제거 (필수) ⚠️**

**현재 상태:**
```typescript
// 656번 라인
if (prev.length === 0) {
  return prev
}

// 760번 라인 (프로필 오류 경로)
if (prev.length === 0) {
  return prev
}
```

**문제점:**
- 빈 채팅방에서 첫 메시지가 실시간으로 들어올 때, `prev.length === 0`이므로 메시지가 무시됩니다.
- 초기 로드가 완료되었지만 메시지가 없는 경우(빈 채팅방)에도 첫 메시지가 드랍됩니다.

**해결책:**
- 이 가드를 **완전히 제거**해야 합니다.
- `pendingEventsRef` 버퍼링과 `initialLoadTimeRef` 체크로 이미 초기 로드 전 메시지는 처리되고 있으므로, 이 가드는 불필요합니다.

**수정 위치:**
- 656-658번 라인 제거
- 760-762번 라인 제거

---

### 2. **Envelope 단위 중복 제거 (`seenMid`) (필수) ⚠️**

**현재 상태:**
- `seenMidRef`가 없음
- 동일 `mid`(envelope ID)를 가진 이벤트가 여러 번 처리될 수 있음

**문제점:**
- 같은 브로드캐스트 이벤트가 두 번 들어오면 중복 처리됨
- 메시지 단위 중복 체크만 있고, envelope 단위 중복 체크가 없음

**해결책:**
```typescript
// 상단 선언부에 추가
const seenMidRef = useRef<Set<string>>(new Set())

// broadcast 핸들러 시작 부분에 추가
.on('broadcast', { event: '*' }, (payload: any) => {
  const env = (payload?.payload || payload)
  if (!isValidBroadcastEnvelope(env)) return

  // 1) mid 단위 de-dup
  if (env?.mid) {
    const seen = seenMidRef.current
    if (seen.has(env.mid)) {
      console.log('중복 envelope(mid) 무시:', env.mid)
      return
    }
    seen.add(env.mid)
    // 메모리 보호 (최대 2000개만 유지)
    if (seen.size > 2000) {
      const first = seen.values().next().value
      seen.delete(first)
    }
  }
  // ... 기존 로직
})
```

**수정 위치:**
- 상단 ref 선언부 (83번 라인 근처)
- broadcast 핸들러 시작 부분 (약 570번 라인 근처)

---

### 3. **ID 기반 과거 판정 (권장) ⚠️**

**현재 상태:**
- `created_at`만 사용하여 과거 판정
- `id` 기반 판정이 없음

**문제점:**
- DB/서버 정밀도로 인해 동일 `created_at`을 가진 메시지가 있을 수 있음
- `id`가 단조 증가하는 경우, `id` 기반 판정이 더 정확함

**해결책:**
```typescript
// 과거 판정 로직 수정
// B. "과거" 판정은 id 우선, 그다음 created_at
const prevMaxId = prev.reduce((acc, m) => 
  typeof m.id === 'number' ? Math.max(acc, m.id) : acc, 
  lastMessageIdRef.current
)

// id가 있으면 id 기준
if (typeof newMsg.id === 'number') {
  if (newMsg.id <= prevMaxId) {
    console.log('과거 메시지(SEQ) 무시:', newMsg.id, '<=', prevMaxId)
    return prev
  }
} else {
  // id 없을 때만 created_at 보조 비교 (strict < 만 과거로 간주)
  const latestTime = prev.length ? new Date(prev[prev.length - 1].created_at).getTime() : 0
  const newTime = new Date(newMsg.created_at).getTime()
  if (newTime < latestTime) {
    console.log('과거 메시지(TS) 무시:', newMsg.created_at, '<', prev[prev.length - 1].created_at)
    return prev
  }
}
```

**수정 위치:**
- 703-721번 라인 (정상 경로)
- 774-791번 라인 (프로필 오류 경로)

---

### 4. **헬스체크 임계치 완화 (권장)**

**현재 상태:**
- 초기 로드 후 3초 이내에는 헬스체크 비활성화 (1156번 라인)
- 헬스체크 주기: 3초 (1173번 라인)

**문제점:**
- 해결책.md에서는 30초 권장
- 3초는 너무 공격적이라 유휴 시간에도 폴백이 자주 켜질 수 있음

**해결책:**
- 초기 로드 후 비활성화 시간: 3초 → 10초 (또는 제거)
- 헬스체크 주기: 3초 → 5초

**수정 위치:**
- 1156번 라인: `3000` → `10000` (또는 제거)
- 1173번 라인: `3000` → `5000`

---

### 5. **CLOSED 분류 조정 (권장)**

**현재 상태:**
- `CLOSED` 상태를 모두 실패로 취급
- 정상 종료와 실패를 구분하지 않음

**문제점:**
- 우리가 명시적으로 `unsubscribe/removeChannel`을 호출한 경우도 실패로 카운팅됨
- 불필요한 재시도 및 폴백 전환 발생

**해결책:**
```typescript
// 상단에 추가
const closingByUsRef = useRef<boolean>(false)

// unsubscribe/removeChannel 호출 시
closingByUsRef.current = true
await channel.unsubscribe()
await supabase.removeChannel(channel)
closingByUsRef.current = false

// subscribe 콜백에서
if (status === 'CLOSED') {
  if (closingByUsRef.current) {
    // 정상 종료, 재시도 카운트 증가하지 않음
    return
  }
  // 실패로 처리
}
```

**수정 위치:**
- 상단 ref 선언부
- 채널 정리 로직 (약 500번 라인 근처)
- subscribe 콜백 (약 900번 라인 근처)

---

## 📊 우선순위별 수정 계획

### Phase 1: 최초 메시지 누락 해결 (필수)
1. ✅ `prev.length === 0` 가드 제거 (656, 760번 라인)
2. ✅ `seenMid` 중복 제거 로직 추가

### Phase 2: 정확도 향상 (권장)
3. ✅ ID 기반 과거 판정 추가
4. ✅ 헬스체크 임계치 완화

### Phase 3: 안정성 향상 (선택)
5. ✅ CLOSED 분류 조정

---

## 🔍 검증 체크리스트

수정 후 다음을 확인해야 합니다:

1. ✅ **빈 채팅방**에서 첫 메시지 수신: 실시간으로 즉시 표시되는지 (누락 없음)
2. ✅ **동일 시각 다건** (한꺼번에 2~3건 전송) 수신: 모두 표시되는지 (동시각 드랍 없음)
3. ✅ **중복 이벤트**: 같은 `mid` 로그가 와도 1회만 처리되는지
4. ✅ **유휴 1~2분** 후에도 폴백이 켜지지 않는지 (헬스체크 완화)
5. ✅ 관리자(Chrome)와 참가자(Edge) 교차 송수신: **순서 뒤바뀜/누락/중복 없음**

---

## 📝 결론

**가장 중요한 수정사항:**
1. **`prev.length === 0` 가드 제거** - 이것이 최초 메시지 누락의 주요 원인입니다.
2. **`seenMid` 중복 제거** - 중복 이벤트 처리 방지

이 두 가지를 수정하면 최초 메시지 누락 문제가 대부분 해결될 것으로 예상됩니다.

