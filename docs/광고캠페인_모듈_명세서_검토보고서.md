# 광고/캠페인(마케팅 성과) 모듈 명세서 검토 보고서

**검토일**: 2026-01-27  
**검토자**: Cursor Agent  
**명세서 버전**: v1.0 (4가지 보완사항 포함)

---

## 1. 전체 평가

### 1.1 명세서 완성도: ⭐⭐⭐⭐⭐ (5/5)

명세서는 **구현 착수 가능한 수준**으로 매우 잘 작성되어 있습니다:
- ✅ 목적과 비목표가 명확함
- ✅ 핵심 원칙(멀티테넌시, 하드코딩 금지, UX 안정성)이 구체적
- ✅ 4가지 보완사항(D1-D4)이 명확히 정의됨
- ✅ 데이터 모델 설계가 상세함
- ✅ 단계별 구현 로드맵이 현실적
- ✅ DoD(Definition of Done)가 구체적

### 1.2 기존 시스템과의 호환성: ⭐⭐⭐⭐ (4/5)

대부분 호환 가능하나, 일부 조정 필요:
- ✅ `event_survey_entries` 테이블 확장 가능 (기존 `registration_data` JSONB 활용 가능)
- ✅ 클라이언트 대시보드 구조 존재 (`/client/[clientId]` 경로)
- ⚠️ `short_links` 테이블이 웨비나 전용으로 설계됨 (캠페인 링크 확장 필요)
- ⚠️ 기존 UTM 관련 문서 존재 (`docs/UTM_파라미터_추적_적용_방안_보고서.md`) - 통합 필요

---

## 2. 세부 검토 사항

### 2.1 데이터 모델 설계 (Section 7)

#### ✅ 강점
- **방안 A(별도 컬럼) 선택이 적절**: 기존 `registration_data` JSONB와 병행 사용 가능
- **First-touch 스냅샷 보관**: 마케팅 분석에 유용
- **인덱스 전략이 보수적**: 성능 이슈 발생 시 확장 가능

#### ⚠️ 보완 필요 사항

**1. `short_links` 테이블 확장**
```sql
-- 현재 구조: webinar_id만 참조
-- 필요: campaign_id도 참조 가능하도록 확장
ALTER TABLE public.short_links
  ADD COLUMN campaign_id uuid REFERENCES event_survey_campaigns(id),
  ADD CONSTRAINT check_target CHECK (
    (webinar_id IS NOT NULL AND campaign_id IS NULL) OR
    (webinar_id IS NULL AND campaign_id IS NOT NULL)
  );
```

**2. `event_survey_entries` 마이그레이션 계획**
- 기존 데이터 마이그레이션 전략 필요
- UTM 필드가 NULL인 기존 레코드 처리 방안 명시 필요

**3. `tracking_link_id` 필드 타입**
- `short_link_id` (bigint) vs `campaign_link_meta.id` (uuid) 중 선택 필요
- 명세서에는 "또는"으로 표기되어 있으나, 실제 구현 시 하나로 통일 필요

---

### 2.2 수집 플로우 설계 (Section 8)

#### ✅ 강점
- **UTM 캡처 위치 명확**: `/event/{public_path}` 진입 시점
- **localStorage 네임스페이스**: 캠페인 단위로 격리
- **graceful 실패 정책**: 전환 실패로 이어지지 않음

#### ⚠️ 보완 필요 사항

**1. 워트(WERT) 리다이렉트 흐름에서의 UTM 유지 (D2)**

현재 코드 확인 결과:
- `app/(webinar)/webinar/[id]/components/WebinarEntry.tsx`에서 `/event/149403`으로 리다이렉트 시
- **querystring이 유실될 가능성 있음**

**필수 수정 사항**:
```typescript
// WebinarEntry.tsx의 handleNameEmailAuth 함수
// 등록 정보 없을 때 리다이렉트 시 UTM 파라미터 전달 필요

const redirectToRegistration = () => {
  const searchParams = new URLSearchParams(window.location.search)
  const utmParams = ['utm_source', 'utm_medium', 'utm_campaign', 'utm_term', 'utm_content']
  const utmQuery = new URLSearchParams()
  
  utmParams.forEach(param => {
    const value = searchParams.get(param)
    if (value) utmQuery.set(param, value)
  })
  
  const queryString = utmQuery.toString()
  window.location.href = `/event/149403${queryString ? `?${queryString}` : ''}`
}
```

**2. 클라이언트 사이드 UTM 캡처 타이밍**

명세서에는 "진입 시 즉시 캡처"라고 되어 있으나, Next.js App Router의 경우:
- 서버 컴포넌트에서 `searchParams`로 접근 가능
- 클라이언트 컴포넌트에서는 `useSearchParams()` 훅 사용 필요
- **하이드레이션 이슈 방지를 위한 전략 필요**

**권장 구현**:
```typescript
// app/event/[...path]/page.tsx (서버 컴포넌트)
export default async function SurveyPublicPage({
  params,
  searchParams, // 서버에서 UTM 캡처
}: {
  params: Promise<{ path: string[] }>
  searchParams: Promise<{ [key: string]: string | string[] | undefined }>
}) {
  const searchParamsData = await searchParams
  const utmParams = extractUTMParams(searchParamsData)
  
  // UTM을 클라이언트 컴포넌트에 전달
  return <RegistrationPage campaign={campaign} utmParams={utmParams} />
}
```

---

### 2.3 집계/통계 설계 (Section 9)

#### ✅ 강점
- **DB group-by 원칙**: JS 루프 금지가 명확
- **RPC 기반 집계**: Supabase RPC 활용 적절
- **Rollup 옵션**: 성능 이슈 시 확장 가능

#### ⚠️ 보완 필요 사항

**1. RPC 함수 시그니처 명시 필요**

명세서에는 "개념"으로만 표기되어 있으나, 실제 구현을 위해 다음이 필요:

```sql
-- 예시: Summary RPC
CREATE OR REPLACE FUNCTION get_campaign_summary(
  p_client_id uuid,
  p_campaign_id uuid DEFAULT NULL,
  p_date_from timestamptz DEFAULT NULL,
  p_date_to timestamptz DEFAULT NULL
)
RETURNS TABLE (
  visits bigint,
  conversions bigint,
  cvr numeric,
  top_source text,
  top_medium text,
  top_campaign text,
  direct_conversions bigint
) AS $$
BEGIN
  -- 구현 로직
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;
```

**2. 집계 성능 임계값**

명세서에는 "성능 지표 기반"이라고 되어 있으나:
- 구체적인 임계값(예: 쿼리 시간 2초 초과 시 rollup 활성화) 명시 필요
- 또는 운영자가 설정 가능한 config 테이블 필요

---

### 2.4 UI/UX 설계 (Section 10)

#### ✅ 강점
- **3탭 구조**: 성과 요약 / 캠페인 링크 / 분석이 직관적
- **필터 구조**: 기간, 전환 타겟, 집계 기준이 명확
- **KPI 카드**: Visits/Conversions/CVR이 핵심 지표

#### ⚠️ 보완 필요 사항

**1. 클라이언트 대시보드 메뉴 위치**

명세서에는 "클라이언트 대시보드 액션 영역 다음에 독립 메뉴"라고 되어 있으나:

현재 코드 확인 결과:
- `app/(client)/client/[clientId]/dashboard/page.tsx`에 액션 버튼들이 있음
- `components/layout/SidebarTree.tsx`에 클라이언트 메뉴 구조가 있음

**권장 구현 위치**:
```typescript
// SidebarTree.tsx의 클라이언트 노드 children에 추가
{
  id: `client-${client.id}-campaigns`,
  label: '광고/캠페인',
  type: 'page',
  href: `/client/${client.id}/campaigns`,
  icon: '📈',
  active: pathname === `/client/${client.id}/campaigns`
}
```

**2. "UTM 없음" 처리 UI**

명세서에는 "direct/unknown" 표기가 언급되어 있으나:
- UI에서 어떻게 표시할지 구체적 예시 필요
- 예: "Direct (UTM 없음)" vs "Unknown" vs "Organic"

---

### 2.5 권한/보안 설계 (Section 11)

#### ✅ 강점
- **멀티테넌시 스코프 강제**: client_id 기반 필터링
- **RLS 정책**: 기존 패턴과 일치
- **공개 insert 정책**: abuse 방지 고려

#### ⚠️ 보완 필요 사항

**1. 공개 insert 정책의 구체적 구현**

명세서에는 "service role insert 정책"이라고 되어 있으나:
- 공개 API 엔드포인트 설계 필요
- Rate limiting 전략 필요
- 예: `/api/public/campaigns/{campaignId}/visit` 엔드포인트

**2. dedup 규칙의 구체적 구현**

D1에서 "session_id + campaign_id + (utm_signature) + time_bucket 기준 dedup"이라고 되어 있으나:
- `utm_signature` 계산 방법 명시 필요
- 예: `md5(utm_source || utm_medium || utm_campaign)` 또는 단순 조합

---

## 3. 기존 시스템과의 통합 이슈

### 3.1 기존 UTM 문서와의 통합

**발견 사항**:
- `docs/UTM_파라미터_추적_적용_방안_보고서.md` 파일이 이미 존재
- 이 문서는 "방안 A(별도 컬럼)"을 권장하고 있음
- 명세서와 일치하나, **통합/정리 필요**

**권장 조치**:
1. 기존 문서를 참고 문서로 명시
2. 또는 기존 문서를 이 명세서로 대체

### 3.2 `short_links` 테이블 확장

**현재 구조**:
```sql
-- 현재: webinar_id만 참조
create table public.short_links (
  id bigserial primary key,
  code varchar(6) not null unique,
  webinar_id uuid not null references public.webinars(id),
  ...
);
```

**필요한 변경**:
- `campaign_id` 필드 추가 (nullable)
- 제약 조건: `webinar_id` 또는 `campaign_id` 중 하나는 필수
- 기존 데이터 마이그레이션 전략 필요

### 3.3 워트(WERT) 특수 흐름

**현재 확인된 리다이렉트 지점**:
1. `/webinar/149402` → `/event/149403` (등록 정보 없을 때)
2. `/event/149403/register` → `/webinar/149402` (등록 완료 후)

**필수 수정 사항**:
- 두 지점 모두 querystring pass-through 구현 필요
- UTM 파라미터만 선별적으로 전달하는 유틸리티 함수 필요

---

## 4. 구현 전 체크리스트 보완

명세서 Section 15의 체크리스트에 다음 항목 추가 권장:

### 추가 체크리스트 항목

6. **기존 `short_links` 테이블 확장 전략**
   - [ ] `campaign_id` 필드 추가 및 제약 조건 설정
   - [ ] 기존 웨비나 링크 데이터 마이그레이션 계획
   - [ ] RLS 정책 업데이트 (campaign 소유자도 접근 가능하도록)

7. **UTM 캡처 클라이언트/서버 분리 전략**
   - [ ] 서버 컴포넌트에서 UTM 추출 함수 (`extractUTMParams`)
   - [ ] 클라이언트 컴포넌트에서 localStorage 저장 로직
   - [ ] 하이드레이션 이슈 방지 전략

8. **기존 UTM 문서 통합**
   - [ ] `docs/UTM_파라미터_추적_적용_방안_보고서.md` 검토 및 통합
   - [ ] 중복 내용 정리 및 단일 소스로 통합

9. **공개 API 엔드포인트 설계**
   - [ ] `/api/public/campaigns/{campaignId}/visit` 엔드포인트 설계
   - [ ] Rate limiting 전략 (예: IP당 분당 10회)
   - [ ] Abuse 방지 검증 로직 (campaign_id 유효성 등)

10. **세션 관리 전략**
    - [ ] `session_id` 생성 방법 (UUID v4 vs 기타)
    - [ ] 세션 TTL 설정값 (기본값 30분, config로 관리)
    - [ ] 세션 연장 로직 (활동 시 TTL 갱신 여부)

---

## 5. Phase별 구현 우선순위 조정 제안

### Phase 1 (필수) - 수정 제안

**원래 계획**:
- event_survey_entries에 UTM 저장
- 광고/캠페인 탭 A 구현 (Conversions 기준)

**추가 권장 사항**:
1. **UTM 캡처 인프라 먼저 구축**
   - UTM 추출/저장 유틸리티 함수
   - localStorage 관리 로직
   - querystring pass-through 유틸리티

2. **워트(WERT) 리다이렉트 수정**
   - D2 보완사항 즉시 반영
   - 기존 플로우에서 UTM 유실 방지

### Phase 2 (권장) - 수정 제안

**원래 계획**:
- 캠페인 링크 메타 테이블 + short_links 연동

**추가 권장 사항**:
1. **short_links 테이블 확장을 Phase 2로 이동**
   - Phase 1에서 UTM 저장만 하고
   - Phase 2에서 링크 관리 기능 추가 시 확장

---

## 6. 기술적 구현 고려사항

### 6.1 Next.js App Router 호환성

**이슈**:
- 서버 컴포넌트와 클라이언트 컴포넌트 간 UTM 전달
- `searchParams`는 서버 컴포넌트에서만 접근 가능

**해결 방안**:
```typescript
// 서버 컴포넌트에서 UTM 추출
const utmParams = {
  source: searchParams.utm_source,
  medium: searchParams.utm_medium,
  // ...
}

// 클라이언트 컴포넌트에 props로 전달
<ClientComponent utmParams={utmParams} />

// 또는 쿠키/세션에 저장 후 클라이언트에서 읽기
```

### 6.2 Supabase RPC 보안

**이슈**:
- RPC 함수가 `SECURITY DEFINER`로 실행되면 RLS 우회 가능
- client_id 스코프 강제가 중요

**해결 방안**:
```sql
-- RPC 함수 내부에서 client_id 검증
CREATE OR REPLACE FUNCTION get_campaign_summary(...)
RETURNS TABLE (...) AS $$
BEGIN
  -- client_id 스코프 검증
  IF NOT EXISTS (
    SELECT 1 FROM event_survey_campaigns 
    WHERE id = p_campaign_id AND client_id = p_client_id
  ) THEN
    RAISE EXCEPTION 'Campaign not found or access denied';
  END IF;
  
  -- 집계 로직
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;
```

### 6.3 성능 최적화

**이슈**:
- 대규모 데이터 집계 시 성능 저하 가능
- 공개 페이지에서 집계 호출 금지 원칙

**해결 방안**:
1. **인덱스 전략**: 명세서의 최소 세트부터 시작
2. **캐싱**: 집계 결과를 Redis 또는 메모리 캐시에 저장 (TTL: 5분)
3. **점진적 로딩**: 대시보드에서 "최근 7일" 기본값으로 시작

---

## 7. 최종 권장 사항

### 7.1 즉시 반영 권장 사항

1. **워트(WERT) 리다이렉트 수정** (D2)
   - 우선순위: 높음
   - 영향도: 기존 플로우에서 UTM 유실 방지

2. **UTM 캡처 인프라 구축**
   - 우선순위: 높음
   - 영향도: 모든 Phase의 기반

3. **기존 UTM 문서 통합**
   - 우선순위: 중간
   - 영향도: 문서 일관성

### 7.2 Phase 1 구현 전 필수 작업

1. **데이터베이스 마이그레이션 계획 수립**
   - `event_survey_entries` 테이블에 UTM 컬럼 추가
   - 기존 데이터 마이그레이션 전략
   - 롤백 계획

2. **RPC 함수 시그니처 확정**
   - 입력 파라미터 타입 및 제약 조건
   - 출력 스키마 정의
   - 에러 처리 규칙

3. **공개 API 엔드포인트 설계**
   - 엔드포인트 경로 및 메서드
   - 요청/응답 스키마
   - Rate limiting 정책

---

## 8. 결론

### 8.1 명세서 평가

명세서는 **구현 착수 가능한 수준**으로 매우 잘 작성되어 있습니다. 특히:
- ✅ 4가지 보완사항(D1-D4)이 명확히 정의됨
- ✅ 단계별 구현 로드맵이 현실적
- ✅ DoD가 구체적

### 8.2 보완 필요 사항

다음 사항들을 보완하면 구현이 더욱 원활해질 것입니다:
1. 워트(WERT) 리다이렉트에서의 UTM 유지 로직 구체화
2. RPC 함수 시그니처 명시
3. 공개 API 엔드포인트 설계
4. 세션 관리 전략 구체화

### 8.3 다음 단계

명세서 작성자가 제안한 대로, **Phase 1 구현 패키지**를 작성하는 것이 좋겠습니다:
- DB 변경 체크리스트
- API 변경 계약
- RPC 함수 계약
- 워트 케이스 E2E 시나리오

이 패키지까지 있으면 Cursor Agent가 "한 번에" 구현에 착수하기 좋습니다.

---

**검토 완료일**: 2026-01-27  
**다음 검토 필요 시점**: Phase 1 구현 패키지 작성 후
