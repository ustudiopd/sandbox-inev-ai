# 해결책.md 검토 보고서

## 📋 검토 개요

`해결책.md`에서 제시한 5가지 수정안(A~E)을 현재 코드와 비교하여 적용 가능성과 효과를 검토했습니다.

---

## ✅ 검토 결과 요약

**전체 평가: 매우 유효하고 즉시 적용 가능**

모든 제안사항이 현재 코드의 실제 문제점을 정확히 지적하고 있으며, 각 수정안은 독립적으로 적용 가능하며 누적 효과가 큽니다.

---

## 🔍 각 수정안별 상세 검토

### A. `CLOSED`를 실패로 세지 않기 (수동 해제 구분)

**현재 상태:**
- `components/webinar/Chat.tsx:826`에서 `status === 'CLOSED'`일 때 `reconnectTriesRef.current++`로 실패로 카운팅
- cleanup에서 `unsubscribe()` 호출 시 발생하는 정상적인 `CLOSED`도 실패로 집계됨

**문제점:**
```typescript
// 현재 코드 (826줄 근처)
if (status === 'CLOSED') {
  reconnectTriesRef.current++
  // 실패로 카운팅
}
```

**제안된 해결책:**
- `manualCloseRef` 플래그로 수동 종료 구분
- cleanup 직전에 플래그를 `true`로 설정하고, `CLOSED` 콜백에서 플래그가 `true`면 실패로 카운팅하지 않음

**적용 가능성: ⭐⭐⭐⭐⭐ (즉시 적용 가능)**
- 코드 변경이 간단하고 안전함
- 기존 로직에 최소한의 수정만 필요

**예상 효과:**
- "SUBSCRIBED → (정상 cleanup) → CLOSED" 패턴이 실패로 누적되지 않음
- 불필요한 재연결 시도 감소
- 폴백 모드로 전환되는 빈도 대폭 감소

---

### B. 구독 이펙트 의존성에서 `currentUser?.id` 제거

**현재 상태:**
- `components/webinar/Chat.tsx:967`에서 `useEffect` 의존성 배열에 `currentUser?.id` 포함
- `presence: { key: currentUser.id }` 설정 때문에 포함되어 있음

**문제점:**
```typescript
// 현재 코드 (967줄)
}, [webinarId, currentUser?.id, reconnectKey])
```

- 사용자 로딩 완료 시(`null → userId`) useEffect가 재실행되어 기존 채널이 cleanup되고 재구독됨
- 이 과정에서 정상적인 `CLOSED`가 발생하고, 이것이 실패로 카운팅됨

**제안된 해결책:**
- 의존성 배열에서 `currentUser?.id` 제거
- presence가 필요하면 채널 생성 후 `channel.track()`으로 별도 처리

**적용 가능성: ⭐⭐⭐⭐⭐ (즉시 적용 가능)**
- 현재 presence는 채팅 기능에 필수 아님
- 제거해도 기능상 문제 없음

**예상 효과:**
- 의도치 않은 재구독 방지
- `CLOSED` 발생 빈도 대폭 감소
- 가장 큰 효과를 기대할 수 있는 수정안

---

### C. 헬스체크 조건을 "이벤트 부재" → "채널 상태"로 변경

**현재 상태:**
- `components/webinar/Chat.tsx:969-991`에서 "3초 동안 이벤트 없음" 기준으로 폴백 활성화
- 연결이 정상이어도 조용한 시간대에 폴백이 켜짐

**문제점:**
```typescript
// 현재 코드 (980줄)
if (timeSinceLastEvent > 3000 && !fallbackOn) {
  setFallbackOn(true) // 이벤트 없으면 폴백
}
```

**제안된 해결책:**
- 채널 상태(`channel.state === 'joined'`)로 판단
- `'joined'`가 아니거나 에러/타임아웃이 연속 발생할 때만 폴백 활성화

**적용 가능성: ⭐⭐⭐⭐ (적용 가능, 약간의 수정 필요)**
- Supabase Realtime SDK의 채널 상태 확인 방법 확인 필요
- `channelRef.current?.state` 또는 `channel.state` 사용 가능 여부 확인 필요

**예상 효과:**
- 조용한 시간대에 불필요하게 폴백이 켜지는 문제 해소
- 실제 연결 문제만 감지하여 폴백 활성화

---

### D. 폴백 폴링에서 증분(after) 요청에는 ETag 제거

**현재 상태:**
- `components/webinar/Chat.tsx:1038-1054`에서 증분 조회(`after=lastMessageId`)에도 ETag 사용
- 서버가 쿼리 스트링을 고려하지 않고 ETag를 계산하면 304가 잘못 반환될 수 있음

**문제점:**
```typescript
// 현재 코드 (1043-1046줄)
if (etagRef.current) {
  headers['If-None-Match'] = etagRef.current
}
// afterParam이 있어도 ETag를 보냄
```

**제안된 해결책:**
- `after=lastMessageId`가 있으면 ETag를 보내지 않음
- 증분 조회는 항상 최신 데이터를 가져오도록 보장

**적용 가능성: ⭐⭐⭐⭐⭐ (즉시 적용 가능)**
- 간단한 조건문 추가만으로 해결 가능
- 안전하고 효과적인 수정

**예상 효과:**
- 304로 인한 가짜 "변경 없음" 방지
- 폴백 시에도 최대한 빨리 새 메시지 수신

---

### E. 기존 채널 정리 로직 간소화

**현재 상태:**
- `components/webinar/Chat.tsx:466-475`에서 `getChannels()`로 모든 채널을 검색하여 제거
- 다른 컴포넌트의 채널을 실수로 닫을 가능성

**문제점:**
```typescript
// 현재 코드 (466-475줄)
const existingChannel = supabase.getChannels().find(
  ch => ch.topic === `realtime:${channelName}`
)
if (existingChannel) {
  await existingChannel.unsubscribe()
  supabase.removeChannel(existingChannel)
}
```

**제안된 해결책:**
- `channelRef.current`만 확인하여 정리
- 우리가 만든 채널만 대상으로 처리

**적용 가능성: ⭐⭐⭐⭐⭐ (즉시 적용 가능)**
- 이미 `channelRef`를 사용하고 있으므로 간단히 수정 가능
- 더 안전하고 명확한 로직

**예상 효과:**
- 경합 상황 감소
- 다른 채널을 실수로 닫는 일 방지
- 코드 가독성 향상

---

## 📊 우선순위 및 적용 순서 권장

### 즉시 적용 (높은 효과, 낮은 리스크)
1. **B. `currentUser?.id` 제거** - 가장 큰 효과 기대
2. **A. 수동 종료 플래그** - CLOSED 오인 방지
3. **D. 증분 조회 ETag 제거** - 간단하고 효과적
4. **E. 채널 정리 간소화** - 안전성 향상

### 추가 검토 후 적용 (중간 효과, 약간의 수정 필요)
5. **C. 헬스체크 채널 상태 기준** - Supabase SDK API 확인 필요

---

## 🎯 예상 종합 효과

위 5가지 수정안을 모두 적용하면:

1. **"SUBSCRIBED → 바로 CLOSED" 루프 완전 해소**
   - B (의존성 제거) + A (수동 종료 구분)로 해결

2. **불필요한 폴백 활성화 방지**
   - C (채널 상태 기준) + A (실패 카운팅 정확화)로 해결

3. **폴백 시 지연 최소화**
   - D (ETag 제거)로 증분 조회 최적화

4. **코드 안정성 향상**
   - E (채널 정리 간소화)로 경합 방지

**최종 결과: 실시간 연결 안정화 및 10~15초 지연 문제 해소**

---

## ⚠️ 주의사항

1. **Supabase SDK API 확인 필요 (C번)**
   - `channel.state` 또는 `channelRef.current?.state` 사용 가능 여부 확인
   - Phoenix 채널 상태 값 확인 (`'joined'`, `'joining'`, `'closed'` 등)

2. **테스트 시나리오**
   - 사용자 로그인/로그아웃 시나리오
   - 웨비나 전환 시나리오
   - 네트워크 불안정 시나리오

3. **점진적 적용 권장**
   - A, B, D, E를 먼저 적용하고 테스트
   - C는 SDK API 확인 후 적용

---

## ✅ 결론

`해결책.md`의 모든 제안사항이 **유효하고 즉시 적용 가능**합니다. 특히 **B번(의존성 제거)**과 **A번(수동 종료 플래그)**은 가장 큰 효과를 기대할 수 있으며, 이 두 가지만 적용해도 문제의 대부분이 해소될 것으로 예상됩니다.

**권장 조치:**
1. A, B, D, E 수정안 즉시 적용
2. C 수정안은 SDK API 확인 후 적용
3. 테스트 후 추가 최적화 진행
