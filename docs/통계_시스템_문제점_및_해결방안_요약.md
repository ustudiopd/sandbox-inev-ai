# EventFlow 통계 시스템 문제점 및 해결방안 요약

**작성일**: 2026-02-02  
**상태**: 🔴 **심각한 문제 다수 발견, 일부 수정 완료**

---

## 🚨 핵심 문제 요약

### 1. Visit 추적이 거의 동작하지 않음

- **현황**: 전체 Visit 10건 vs 등록 546건 (1.8%)
- **오늘**: Visit 0건 vs 등록 90건 (0%)
- **최근 Visit**: 5일 전 (2026-01-28)

**원인**:
- 랜딩 페이지에서 Visit API 호출 누락 (워트는 수정 완료)
- 등록 페이지에만 Visit API가 있고, 랜딩에는 없음

**해결**:
- ✅ 워트 랜딩 페이지 Visit API 추가 완료
- ⏳ 다른 랜딩 페이지 확인 필요

---

### 2. UTM 추적률이 매우 낮음 (1.8%)

- **현황**: 전체 등록 546건 중 추적 성공 10건 (1.8%)
- **원인**: UTM 파라미터가 URL에서 사라지거나 등록 API에 전달되지 않음

**해결**:
- 리다이렉트 경로에서 UTM 보존 확인
- 등록 API body에 UTM 포함 확인
- 쿠키/세션 관리 개선

---

### 3. Visit-등록 연결이 안 됨 (0%)

- **현황**: 오늘 등록 90건 중 Visit 연결 0건
- **원인**: Visit 자체가 없거나, session_id 전달 문제

**해결**:
- Visit API 호출 문제 해결 후 자연스럽게 개선될 것으로 예상

---

### 4. 집계 함수 SQL 오류

- **현황**: `aggregate function calls cannot be nested` 오류
- **원인**: `jsonb_agg` 안에서 `count(*)` 중첩 사용
- **해결**: ✅ 마이그레이션 생성 완료 (`078_fix_marketing_summary_rpc.sql`)

---

## ✅ 완료된 수정

1. **워트 랜딩 페이지 Visit API 추가**
   - 파일: `app/webinarform/wert/page.tsx`
   - 랜딩 시 방문 기록 저장

2. **집계 함수 SQL 오류 수정**
   - 파일: `supabase/migrations/078_fix_marketing_summary_rpc.sql`
   - 서브쿼리로 집계 함수 중첩 문제 해결

---

## ⏳ 즉시 조치 필요

1. **마이그레이션 실행**
   ```sql
   -- supabase/migrations/078_fix_marketing_summary_rpc.sql 실행
   ```

2. **서버 로그 확인**
   - Vercel/서버 로그에서 `[VisitTrackFail]` 검색
   - Visit API 실패 원인 파악

3. **브라우저 테스트**
   - 실제 페이지에서 네트워크 탭으로 Visit API 호출 확인
   - 등록 시 UTM이 body에 포함되는지 확인

---

## 📊 예상 개선 효과

| 항목 | 현재 | 목표 | 상태 |
|------|------|------|------|
| Visit 추적률 | 1.8% | 80%+ | ⏳ 진행 중 |
| UTM 추적률 | 1.8% | 60%+ | ⏳ 조사 필요 |
| Visit-등록 연결률 | 0% | 50%+ | ⏳ Visit 해결 후 개선 예상 |
| 집계 함수 동작 | 오류 | 정상 | ✅ 수정 완료 (실행 필요) |

---

## 📁 관련 파일

- **분석 스크립트**: `scripts/analyze-statistics-system.ts`, `scripts/diagnose-statistics-issues.ts`
- **종합 보고서**: `docs/통계_시스템_전체_종합_분석_보고서.md`
- **수정 마이그레이션**: `supabase/migrations/078_fix_marketing_summary_rpc.sql`
