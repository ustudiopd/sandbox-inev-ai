# 체크리스트 추가 항목 패치 2탄 (최종 결정 포인트)

**작성일**: 2026-02-02  
**목적**: 추가 검토에서 발견된 3가지 핵심 결정 포인트 명세  
**상태**: 구현 전 필수 고정

---

## 🔴 결정 포인트 1: 성공 정의의 단계별 정합성 (Phase 1~2 vs Phase 3)

### 문제
현재 성공 정의에 `tracking_snapshot.cid + 캠페인 매칭`이 포함되어 있지만, `tracking_snapshot`은 Phase 3에서 추가됨 (타이밍 충돌).

### 해결 방안

#### Phase 1~2 성공 정의 (현 시점 가능한 증거만)

**성공(Tracking OK)**:
아래 중 **하나 이상**이 "유효"하면 성공:
1. `marketing_campaign_link_id` 저장 성공
2. `utm_source` 저장 성공
3. (Cookie/cid resolve로) 캠페인 매칭 성공

**실패(Untracked)**:
위 조건이 **모두 실패**하면 실패

#### Phase 3 이후 성공 정의 확장

**성공(Tracking OK)**:
아래 중 **하나 이상**이 "유효"하면 성공:
1. `marketing_campaign_link_id` 저장 성공
2. `utm_source` 저장 성공
3. (Cookie/cid resolve로) 캠페인 매칭 성공
4. **`tracking_snapshot.cid` + 캠페인 매칭 검증 성공** (Phase 3 추가)

### 체크리스트 추가

```
## Phase 1.1 (집계 API 보정)에 추가
- [ ] ⚠️ Phase 1~2 성공 정의 명확화
  - 성공: marketing_campaign_link_id OR utm_source OR (cookie/cid resolve로 캠페인 매칭)
  - 실패: 위 조건 모두 실패
  - ⚠️ tracking_snapshot은 Phase 3까지 제외

## Phase 3.1 (추적 스냅샷)에 추가
- [ ] ⚠️ Phase 3 이후 성공 정의 확장
  - tracking_snapshot.cid + 캠페인 매칭을 성공 조건에 추가
  - 기존 성공 정의와 호환되도록 확장
```

---

## 🔴 결정 포인트 2: Cookie TTL vs Trust Window 구분

### 문제
Cookie "30일 유효"와 `COOKIE_TRUST_WINDOW_HOURS`(24시간)가 혼동될 수 있음.

### 해결 방안

#### TTL (보관기간) vs Trust Window (귀속 허용창)

**TTL (Cookie 보관기간)**:
- 목적: 디버깅/편의성
- 값: 길게 (예: 30일)
- 환경변수: `COOKIE_TTL_DAYS` (기본값: 30)

**Trust Window (귀속 허용창)**:
- 목적: 오귀속 방지 (정합성 우선)
- 값: 짧게 (예: 24시간)
- 환경변수: `COOKIE_TRUST_WINDOW_HOURS` (기본값: 24)

**동작 원리**:
```typescript
// Cookie는 30일 동안 보관되지만,
// 복원 시에는 24시간 이내의 것만 신뢰
const cookieAge = Date.now() - new Date(cookieData.captured_at).getTime()
const trustWindow = parseInt(process.env.COOKIE_TRUST_WINDOW_HOURS || '24') * 60 * 60 * 1000

if (cookieAge > trustWindow) {
  // 시간 창 초과 → cookie 무시 (오귀속 방지)
  return null
}
// 시간 창 내 → cookie 사용 가능
```

### 체크리스트 추가

```
## Phase 2.1 (서버 세션 관리)에 추가
- [ ] ⚠️ Cookie TTL 설정 (보관기간)
  - 환경변수: COOKIE_TTL_DAYS (기본값: 30)
  - 목적: 디버깅/편의성
- [ ] ⚠️ Cookie Trust Window 설정 (귀속 허용창)
  - 환경변수: COOKIE_TRUST_WINDOW_HOURS (기본값: 24)
  - 목적: 오귀속 방지 (정합성 우선)
  - ⚠️ TTL과 구분하여 명확히 문서화

## Phase 2.2 (다중 소스 복원)에 추가
- [ ] ⚠️ Cookie 복원 시 Trust Window 검증
  - COOKIE_TRUST_WINDOW_HOURS 환경변수 사용
  - 시간 창 초과 시 cookie 무시 + untracked_reason 기록
```

---

## 🔴 결정 포인트 3: UTM과 cid 충돌 규칙

### 문제
URL에 UTM이 있는데 cid가 다른 캠페인을 가리키는 경우 처리 규칙이 없음.

### 해결 방안

#### 충돌 규칙

**원칙**: UTM이 있으면 UTM을 우선 진실로 두되, cid는 "링크 식별 보조"로만 사용

**충돌 처리 로직**:
```typescript
// 1. UTM과 cid가 모두 있는 경우
if (utm_source && cid) {
  // cid로 링크 조회
  const link = await findLinkByCid(cid, currentCampaignId)
  
  if (link) {
    // cid가 현재 캠페인과 매칭되는 경우
    if (link.target_campaign_id === currentCampaignId) {
      // 정상: UTM 우선, cid는 link_id 저장용으로만 사용
      marketing_campaign_link_id = link.id
      // UTM은 URL에서 온 값 그대로 사용
    } else {
      // 충돌: cid가 다른 캠페인을 가리킴
      // → UTM은 사용하되, link_id는 저장하지 않음
      // → untracked_reason 기록
      untracked_reason = 'cid_campaign_mismatch'
      // UTM은 그대로 저장 (UTM이 진실)
    }
  }
}

// 2. UTM만 있고 cid가 없는 경우
if (utm_source && !cid) {
  // 정상: UTM만 저장
}

// 3. cid만 있고 UTM이 없는 경우
if (!utm_source && cid) {
  // 링크 메타데이터에서 UTM 복원 시도
  const link = await findLinkByCid(cid, currentCampaignId)
  if (link && link.utm_source) {
    // 링크의 UTM 사용
  }
}
```

**집계 처리**:
- UTM이 있으면 → UTM 기반 Source 집계
- cid 충돌 시 → `untracked_reason = 'cid_campaign_mismatch'` 기록
- 집계 시 충돌 항목은 별도 분류 (집계 왜곡 방지)

### 체크리스트 추가

```
## Phase 2.2 (다중 소스 복원)에 추가
- [ ] ⚠️ UTM과 cid 충돌 규칙 구현
  - UTM이 있으면 UTM을 우선 진실로 사용
  - cid는 "링크 식별 보조"로만 사용
  - cid가 다른 캠페인을 가리키면:
    - UTM은 그대로 저장 (UTM이 진실)
    - link_id는 저장하지 않음
    - untracked_reason = 'cid_campaign_mismatch' 기록
- [ ] ⚠️ 충돌 항목 집계 처리
  - 충돌 항목은 별도 분류 (집계 왜곡 방지)
  - tracking_metadata에 충돌 건수 포함
```

---

## 🔴 결정 포인트 4: Visit 추적을 Phase 2 성공조건에서 제외

### 문제
Visit 추적이 Phase 2 성공조건에 포함되면 안 됨 (UTM 집계 정상화와 무관).

### 해결 방안

**명확화**:
- UTM 집계 정상화의 핵심은 **등록 시점에 tracking 저장**
- Visit 추적은 퍼널/CVR 목적일 때만 투자 가치 있음
- Phase 2 성공조건에는 Visit 추적 불포함

**Visit 추적 필요성 결정**:
- 필요: 전환율(CVR), 퍼널 분석, 방문→등록 연결
- 불필요: 단순 Source 집계만 필요

### 체크리스트 추가

```
## Phase 2.4 (Visit 추적)에 추가
- [ ] ⚠️ Visit 추적 필요성 결정 (필요 vs 불필요)
- [ ] ⚠️ Visit 추적을 Phase 2 성공조건에서 제외
  - UTM 집계 정상화는 등록 시점 tracking 저장으로 충분
  - Visit는 퍼널/CVR 목적일 때만 투자
- [ ] ⚠️ Phase 2 DoD에서 Visit 관련 항목 제거
```

---

## 📋 종합 체크리스트 (패치 2탄)

### Phase 1.1 (집계 API 보정)
- [ ] ⚠️ Phase 1~2 성공 정의 명확화 (tracking_snapshot 제외)
- [ ] ⚠️ 성공: marketing_campaign_link_id OR utm_source OR (cookie/cid resolve)
- [ ] ⚠️ 실패: 위 조건 모두 실패

### Phase 2.1 (서버 세션 관리)
- [ ] ⚠️ Cookie TTL 설정 (COOKIE_TTL_DAYS, 기본값: 30일)
- [ ] ⚠️ Cookie Trust Window 설정 (COOKIE_TRUST_WINDOW_HOURS, 기본값: 24시간)
- [ ] ⚠️ TTL과 Trust Window 구분 문서화

### Phase 2.2 (다중 소스 복원)
- [ ] ⚠️ Cookie 복원 시 Trust Window 검증
- [ ] ⚠️ UTM과 cid 충돌 규칙 구현
- [ ] ⚠️ 충돌 항목 집계 처리 (별도 분류)

### Phase 2.4 (Visit 추적)
- [ ] ⚠️ Visit 추적 필요성 결정
- [ ] ⚠️ Visit 추적을 Phase 2 성공조건에서 제외

### Phase 3.1 (추적 스냅샷)
- [ ] ⚠️ Phase 3 이후 성공 정의 확장 (tracking_snapshot 포함)

---

## 🎯 최종 DoD 판정 기준

다음 4가지 시나리오로 "집계 정상" 판정:

### 시나리오 1: UTM 링크로 들어와 등록
- **기대**: `utm_source`가 저장되고 Source 집계에 잡힘
- **판정**: ✅ 성공

### 시나리오 2: cid 짧은 링크로 들어와 등록 (UTM 없음)
- **기대**: `marketing_campaign_link_id` 또는 최소한 추적 근거가 저장 (Direct로만 떨어지지 않음)
- **판정**: ✅ 성공

### 시나리오 3: /s/[code] 경유 후 등록
- **기대**: query 보존 + cookie/session 보존으로 추적 저장 성공
- **판정**: ✅ 성공

### 시나리오 4: 아무 파라미터 없는 진짜 Direct
- **기대**: "Direct (no tracking)"로 분리 표기되고 tracking_success_rate 계산에 반영
- **판정**: ✅ 성공 (정상 동작)

---

**마지막 업데이트**: 2026-02-02  
**검토 상태**: 추가 검토 반영 완료
