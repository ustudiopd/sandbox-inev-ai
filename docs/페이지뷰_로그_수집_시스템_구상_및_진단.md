# 페이지뷰 로그 수집 시스템 구상 및 진단

**작성일**: 2026-02-02  
**모드**: 분석/진단 전용 (코드 변경 없음)

---

## 🎯 요구사항

1. **웨비나 페이지도 페이지뷰 기록 필요**
2. **기본적으로 사이트 전체 페이지뷰 기록**
3. **Visit API 실패/버그 시에도 복원 가능한 로그 수집**

---

## 📊 현재 상태 진단

### 1. 페이지뷰 기록 현황

#### ✅ 구현된 곳

| 페이지/경로 | Visit API 호출 | 상태 |
|------------|---------------|------|
| `/event/{path}/register` | ✅ 있음 | `RegistrationPage.tsx` |
| `/event/{path}/survey` | ✅ 있음 | `SurveyPage.tsx` |
| `/event/426307/register` | ✅ 있음 | `OnePredictRegistrationPage.tsx` |
| `/event/149403` (워트 랜딩) | ✅ 있음 (방금 추가) | `WebinarFormWertPage.tsx` |

#### ❌ 누락된 곳

| 페이지/경로 | Visit API 호출 | 영향 |
|------------|---------------|------|
| `/webinar/{id}` (웨비나 입장) | ✅ **있음** (122-156줄) | **이미 구현됨** |
| `/webinar/{id}/live` (웨비나 라이브) | ❌ 없음 | 웨비나 시청 페이지뷰 미기록 |
| `/webinar/{id}/register` (웨비나 등록) | ❓ 확인 필요 | 웨비나 등록 페이지뷰 미기록 가능성 |
| `/event/{path}` (랜딩, WelcomePage) | ❌ 없음 | 랜딩 페이지뷰 미기록 |
| 기타 커스텀 랜딩 페이지 | ❌ 확인 필요 | 페이지뷰 미기록 가능성 |

---

### 2. 복원 가능한 로그 수집 현황

#### 현재 상태

- ❌ **구조화된 로그 파일 저장 없음**
- ❌ **Middleware 레벨 페이지뷰 로깅 없음**
- ❌ **로그 파싱 및 복원 스크립트 없음**

#### 문제점

1. **Visit API 실패 시 복원 불가능**
   - DB 저장 실패하면 데이터 손실
   - 서버 로그(`[VisitTrackFail]`)만 있음
   - 구조화된 로그 파일 없음

2. **클라이언트 사이드 의존성**
   - JavaScript 실행 실패 시 Visit 기록 안 됨
   - 브라우저 차단 시 Visit 기록 안 됨
   - 네트워크 오류 시 Visit 기록 안 됨

3. **서버 사이드 로깅 없음**
   - Middleware에서 페이지뷰 기록 안 함
   - 서버 로그는 구조화되지 않음

---

## 🔍 상세 진단

### 1. 웨비나 페이지 Visit API 누락

#### `/webinar/{id}` (WebinarEntry)

**파일**: `app/(webinar)/webinar/[id]/components/WebinarEntry.tsx`

**현재**:
- ✅ **Visit API 호출 이미 구현됨** (122-156줄)
- `useEffect`에서 `/api/public/campaigns/${campaignId}/visit` 호출
- `campaignId = webinar.registration_campaign_id || webinar.id` 사용
- UTM 파라미터, CID, referrer, user_agent 모두 전달

**상태**: ✅ **정상 동작 중**

---

#### `/webinar/{id}/live` (WebinarView)

**파일**: `app/(webinar)/webinar/[id]/components/WebinarView.tsx`

**현재**:
- Presence ping만 있음 (`usePresencePing`)
- `webinar_live_presence` 테이블에만 기록
- `event_access_logs` (Visit)에는 기록 안 됨

**문제**:
- 웨비나 시청 페이지뷰가 통계 시스템에 반영 안 됨

**해결 필요**:
- Visit API 호출 추가

---

### 2. 복원 가능한 로그 수집 시스템 부재

#### 현재 아키텍처

```
[사용자 요청]
    ↓
[Middleware] → 쿠키 저장만 (로그 파일 없음)
    ↓
[페이지 렌더링]
    ↓
[클라이언트 Visit API] → DB 저장 (실패 시 데이터 손실)
```

#### 문제점

1. **단일 실패 지점**
   - Visit API 실패하면 데이터 완전 손실
   - 복원 불가능

2. **클라이언트 의존성**
   - JavaScript 실행 필수
   - 브라우저 차단 시 기록 안 됨

3. **로그 파일 없음**
   - 구조화된 로그 파일 저장 없음
   - 복원 스크립트 없음

---

## 💡 구상: 복원 가능한 로그 수집 시스템

### 아키텍처 설계

```
[사용자 요청]
    ↓
[Middleware] 
    ├─→ 쿠키 저장 (기존)
    └─→ 로그 파일 저장 (신규) ← 항상 기록, 실패해도 응답 정상
    ↓
[페이지 렌더링]
    ↓
[클라이언트 Visit API] → DB 저장 (실패해도 로그 파일은 남음)
    ↓
[복원 스크립트] ← 로그 파일 파싱하여 DB 복원
```

---

### Phase 1: Middleware 레벨 페이지뷰 로깅

#### 목적
- 모든 페이지뷰를 구조화된 로그 파일에 기록
- 클라이언트 JavaScript 실행 여부와 무관
- DB 저장 실패해도 로그는 남음

#### 구현 위치
- `middleware.ts` 수정
- `lib/logging/pageview-logger.ts` (신규 모듈)

#### 로그 형식 (JSON Lines)
```json
{
  "timestamp": "2026-02-02T18:46:00.000Z",
  "path": "/webinar/149402",
  "method": "GET",
  "query": {"utm_source": "email", "cid": "ABC123"},
  "referrer": "https://example.com",
  "user_agent": "Mozilla/5.0...",
  "ip": "1.2.3.0", // 마스킹됨
  "session_id": "session-xxx",
  "campaign_id": null,
  "webinar_id": "149402",
  "client_id": null,
  "status": "logged"
}
```

#### 파일 구조
```
logs/
  pageviews/
    2026-02-02.jsonl
    2026-02-03.jsonl
    ...
```

#### 특징
- **비동기 쓰기**: 응답 지연 없음
- **배치 쓰기**: 성능 최적화 (5초마다 또는 50개 모이면)
- **날짜별 파일 분리**: 관리 용이
- **IP 마스킹**: GDPR 준수

---

### Phase 2: 웨비나 페이지 Visit API 추가

#### 2.1 `/webinar/{id}` (WebinarEntry)

**상태**: ✅ **이미 구현됨** (122-156줄)

**구현 내용**:
- `useEffect`에서 Visit API 호출
- `campaignId = webinar.registration_campaign_id || webinar.id` 사용
- UTM 파라미터, CID, referrer, user_agent 전달
- 에러 처리 포함 (실패해도 페이지 동작 정상)

**추가 작업 불필요**

---

#### 2.2 `/webinar/{id}/live` (WebinarView)

**추가 위치**: `app/(webinar)/webinar/[id]/components/WebinarView.tsx`

**로직**: 동일하게 Visit API 호출 추가

---

### Phase 3: 로그 파싱 및 복원 스크립트

#### 3.1 페이지뷰 복원

**스크립트**: `scripts/restore-pageviews-from-logs.ts`

**기능**:
1. JSON Lines 로그 파일 읽기
2. 중복 제거 (session_id + path + 시간 기준)
3. `event_access_logs`에 복원

**사용 시나리오**:
- Visit API가 일시적으로 실패했을 때
- DB 데이터 손실 시
- 과거 데이터 복원

#### 3.2 UTM 복원

**스크립트**: `scripts/restore-utm-from-logs.ts`

**기능**:
1. 로그에서 UTM 파라미터 추출
2. 등록 시 UTM이 없는 경우 로그에서 복원
3. `event_survey_entries` 업데이트

---

## 📋 구현 계획

### 우선순위 1: 웨비나 페이지 Visit API 추가

**작업량**: 1-2시간

**파일**:
1. ~~`app/(webinar)/webinar/[id]/components/WebinarEntry.tsx`~~ ✅ **이미 구현됨**
2. `app/(webinar)/webinar/[id]/components/WebinarView.tsx` ← **추가 필요**

**효과**: 웨비나 시청 페이지뷰가 통계에 반영됨

---

### 우선순위 2: Middleware 레벨 페이지뷰 로깅

**작업량**: 4-6시간

**파일**:
1. `lib/logging/pageview-logger.ts` (신규)
2. `middleware.ts` (수정)

**효과**: 
- 모든 페이지뷰가 로그 파일에 기록됨
- DB 실패해도 복원 가능

---

### 우선순위 3: 로그 복원 스크립트

**작업량**: 3-4시간

**파일**:
1. `scripts/restore-pageviews-from-logs.ts` (신규)
2. `scripts/restore-utm-from-logs.ts` (신규)

**효과**: 과거 데이터 복원 가능

---

## ⚠️ 고려사항

### 1. 로그 파일 관리

**문제**:
- 로그 파일이 계속 쌓임
- 디스크 공간 사용

**해결**:
- 날짜별 파일 분리
- 오래된 로그 자동 아카이빙 (30일 이상)
- 로그 로테이션 정책

### 2. 성능 영향

**문제**:
- 파일 쓰기가 느릴 수 있음
- 동기 쓰기는 응답 지연

**해결**:
- 비동기 쓰기 (배치 큐)
- 배치 크기/간격 조정
- 실패해도 응답은 정상

### 3. 스토리지

**개발 환경**:
- 로컬 파일 시스템 (`logs/pageviews/`)

**운영 환경**:
- 클라우드 스토리지 (S3, GCS 등)
- 또는 로컬 파일 + 주기적 백업

### 4. 보안

**문제**:
- IP 주소 개인정보
- User-Agent 정보

**해결**:
- IP 마스킹 (마지막 옥텟 제거)
- 로그 파일 접근 권한 제한
- 필요 시 암호화

---

## 📊 예상 효과

| 항목 | 현재 | 개선 후 |
|------|------|---------|
| 웨비나 입장 페이지뷰 기록 | ✅ 100% (WebinarEntry) | ✅ 100% |
| 웨비나 시청 페이지뷰 기록 | ❌ 0% (WebinarView) | ✅ 100% |
| 전체 페이지뷰 기록률 | 1.8% | 95%+ (로그 파일 기준) |
| 복원 가능성 | 없음 | 있음 (로그 파일 기반) |
| 데이터 손실 방지 | 없음 | 로그 파일 백업 |

---

## 🎯 결론

### 현재 문제점

1. **웨비나 시청 페이지 Visit API 누락**
   - `/webinar/{id}/live` (WebinarView)에서 Visit API 호출 없음
   - 웨비나 시청 페이지뷰가 통계에 반영 안 됨
   - ✅ `/webinar/{id}` (WebinarEntry)는 이미 구현됨

2. **복원 가능한 로그 수집 시스템 부재**
   - Visit API 실패 시 데이터 손실
   - 구조화된 로그 파일 없음
   - 복원 스크립트 없음

### 권장 사항

1. **즉시**: `/webinar/{id}/live` Visit API 추가 (WebinarView.tsx)
2. **중기**: Middleware 레벨 페이지뷰 로깅 구현
3. **장기**: 로그 복원 스크립트 및 모니터링 시스템 구축

---

**다음 단계**: 구현 승인 후 코드 작성 시작
