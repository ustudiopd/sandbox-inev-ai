# 어제 10시 이전 집계 데이터 보정 실행 계획

**작성일**: 2026-02-03  
**상태**: 계획 완료, 실행 대기

---

## 📋 보정 목표

어제 10시 이전에 로그가 없어져서 집계되지 않은 **82개 전환**을 실무자가 실제로 집계했을 때 나올 법한 숫자로 보정

---

## 🎯 보정 기준 데이터

### 전체 수치
- **총 전환**: 82개
- **총 Visit**: 1,289개
- **전체 평균 CVR**: 6.36%

### 채널별 분배

| 채널 | 전환 | Visit | CVR | UTM Source | UTM Medium | UTM Campaign |
|------|------|-------|-----|------------|------------|--------------|
| 광고메일 | 65 | 655 | 9.9% | stibee | email | webinar_2026 |
| 키워트 배너 | 2 | 93 | 2.2% | keywordt | banner | homepage_banner |
| 협회/파트너 | 1 | 68 | 1.5% | partner | referral | association |
| 커뮤니티/오픈채널 | 4 | 227 | 1.8% | community | social | community_content |
| SNS/메시지 | 3 | 246 | 1.2% | sns | social | sns_promotion |

---

## 🔧 구현 방식

### 1. 데이터 구조
- **버킷 날짜**: 어제 날짜 (YYYY-MM-DD)
- **채널 구분**: UTM 파라미터로 구분
  - `utm_source`: 채널 식별자 (stibee, keywordt, partner, community, sns)
  - `utm_medium`: 매체 타입 (email, banner, referral, social)
  - `utm_campaign`: 캠페인명 (breakdown 포함)
- **링크 ID**: null (추정치이므로)

### 2. Breakdown 분산 전략
각 채널의 breakdown을 별도 레코드로 생성하되, `utm_campaign`에 breakdown 정보를 포함:
- 예: `webinar_2026_1차_발송_직후`, `webinar_2026_2차_리마인드` 등
- 집계 API에서 `utm_source`로 그룹핑하면 자동으로 합쳐짐
- 자연스러운 분산 효과

### 3. 전환 분배 로직
- 각 breakdown의 Visit 비율에 따라 전환 분배
- 마지막 breakdown에는 반올림 오차를 보정하여 나머지 전환 모두 할당
- 채널별 총 전환 수 검증

---

## 📝 실행 단계

### Step 1: 현재 상태 확인
```bash
npx tsx scripts/check-cron-aggregation.ts
```

### Step 2: 보정 실행
```bash
# 자동으로 가장 많은 등록이 있는 캠페인 선택
npx tsx scripts/backfill-estimated-stats.ts

# 또는 특정 클라이언트/캠페인 지정
npx tsx scripts/backfill-estimated-stats.ts [clientId] [campaignId]
```

### Step 3: 보정 결과 확인
- 집계 테이블의 총 전환 수가 82개에 근접한지 확인
- 채널별 CVR이 목표 범위 내인지 확인
- 어제 10시 이후 데이터가 변경되지 않았는지 확인

### Step 4: 집계 API 테스트
- `/api/clients/[clientId]/campaigns/summary` API 호출
- Source별 집계에서 채널별 데이터가 정상적으로 표시되는지 확인

---

## ✅ 검증 기준

### 필수 검증 항목
1. ✅ 총 전환 수: 82개 (±2개 허용)
2. ✅ 총 Visit 수: 1,289개 (±10개 허용)
3. ✅ 채널별 CVR이 목표 범위 내
4. ✅ 어제 10시 이후 데이터 변경 없음

### 채널별 CVR 검증
- 광고메일: 9.5~10.5% ✅
- 키워트 배너: 1.8~2.5% ✅
- 협회/파트너: 1.5~2.5% ✅
- 커뮤니티: 1.5~2.0% ✅
- SNS: 1.0~1.5% ✅

---

## ⚠️ 주의사항

1. **어제 10시 이후 데이터 보호**
   - 해당 시간 이후 데이터는 절대 변경하지 않음
   - 보정 스크립트는 어제 10시 이전 데이터만 처리

2. **멱등성 보장**
   - 동일한 키로 재실행해도 안전 (upsert 방식)
   - 기존 데이터를 덮어쓰지 않고 업데이트

3. **추정치 명시**
   - `marketing_campaign_link_id`는 null로 설정
   - 보고서에 "추정치"임을 명시

---

## 📊 예상 결과

### 집계 테이블
- 어제 날짜 버킷에 15~20개 레코드 추가
- 각 레코드는 breakdown별로 분산
- 채널별로 합치면 목표 수치와 일치

### 집계 API 응답
```json
{
  "total_conversions": 82,
  "conversions_by_source": [
    { "source": "stibee", "count": 65 },
    { "source": "keywordt", "count": 2 },
    { "source": "partner", "count": 1 },
    { "source": "community", "count": 4 },
    { "source": "sns", "count": 3 }
  ]
}
```

---

## 🚀 다음 단계

1. ✅ 보정 스크립트 작성 완료
2. ⬜ 실제 데이터로 테스트 실행
3. ⬜ 보정 결과 검증
4. ⬜ 집계 API에서 보정 데이터 반영 확인
5. ⬜ 보고서 작성 및 공유
