# 온디맨드 이벤트 인증 구조 개선 보고서

## 📋 개요

온디맨드 웨비나의 인증 구조를 전면 개선하여 보안 취약점을 해결하고, 설문조사 제출 시 인증 정보를 기반으로 저장하도록 개선했습니다.

## 🔍 발견된 문제점

### 1. 페이지 접근 보안 취약점
- **문제**: `/ondemand/[id]/watch` 및 `/ondemand/[id]/watch/[sessionKey]` 페이지에 로그인 없이 직접 접근 가능
- **영향**: 등록되지 않은 사용자도 콘텐츠 시청 가능

### 2. 설문조사 인증 부재
- **문제**: 설문 제출 API에 인증 체크 없음
- **영향**: 누구나 설문을 제출할 수 있음

### 3. 설문 응답에 인증 정보 미저장
- **문제**: 설문 응답 저장 시 이메일/이름 정보가 저장되지 않음
- **영향**: 설문 응답과 사용자 연결 불가, 중복 체크 부정확

### 4. 코드 중복
- **문제**: 인증 로직이 여러 페이지에 중복 구현
- **영향**: 유지보수 어려움, 일관성 부족

## ✅ 개선 사항

### 1. 인증 헬퍼 함수 생성 (`lib/utils/ondemand-auth.ts`)

#### 주요 함수
- `getOnDemandAuth(webinarId)`: 인증 쿠키에서 인증 정보 가져오기
- `verifyOnDemandRegistration(webinarId, email, name)`: 등록 여부 확인
- `requireOnDemandAuth(webinarId, webinarSlug)`: 인증 확인 및 자동 리다이렉트

#### 장점
- 코드 재사용성 향상
- 일관된 인증 로직
- 유지보수 용이

### 2. 페이지 인증 보호

#### 보호된 페이지
- `/ondemand/[id]/watch` - 세션 목록 페이지
- `/ondemand/[id]/watch/[sessionKey]` - 개별 세션 시청 페이지

#### 동작 방식
1. 인증 쿠키 확인 (`ondemand_auth_{webinarId}`)
2. 쿠키가 없거나 유효하지 않으면 로그인 페이지로 리다이렉트
3. DB에서 등록 여부 재확인
4. 등록되지 않은 사용자는 로그인 페이지로 리다이렉트

### 3. 설문 제출 API 보안 강화

#### 개선 전
```typescript
// 인증 없이 설문 제출 가능
// 이메일/이름 정보 미저장
// 전화번호로만 중복 체크
```

#### 개선 후
```typescript
// 1. 인증 쿠키 확인
const authData = await getOnDemandAuth(webinarId)

// 2. 등록 여부 재확인
const isRegistered = await verifyOnDemandRegistration(...)

// 3. 이메일 기반 중복 체크 (우선순위)
// 4. 전화번호 기반 중복 체크 (보조)

// 5. 인증 정보 저장
email: userEmail,  // 인증된 사용자의 이메일
name: userName,    // 인증된 사용자의 이름
```

### 4. 데이터베이스 스키마 개선

#### 마이그레이션: `102_add_email_to_ondemand_survey_responses.sql`
- `ondemand_survey_responses` 테이블에 `email` 컬럼 추가
- 이메일 기반 중복 체크를 위한 유니크 인덱스 추가
- 이메일 조회를 위한 인덱스 추가

## 🔐 인증 플로우

### 로그인 플로우
```
1. 사용자가 /ondemand/[id]/login 접근
2. 이름과 이메일 입력
3. POST /api/ondemand/[id]/check-registration 호출
4. 등록 여부 확인 (event_survey_entries 또는 registrations 테이블)
5. 등록된 사용자: 인증 쿠키 설정 (httpOnly, 7일 유효)
6. /ondemand/[id]/watch로 리다이렉트
```

### 페이지 접근 플로우
```
1. 사용자가 /ondemand/[id]/watch 접근
2. requireOnDemandAuth() 호출
3. 인증 쿠키 확인
4. 쿠키 없음 → /ondemand/[id]/login 리다이렉트
5. 쿠키 있음 → 등록 여부 DB 재확인
6. 등록 안 됨 → /ondemand/[id]/login 리다이렉트
7. 등록 됨 → 페이지 렌더링
```

### 설문 제출 플로우
```
1. 사용자가 설문 제출 버튼 클릭
2. POST /api/public/ondemand/[id]/survey/submit 호출
3. 인증 쿠키 확인
4. 쿠키 없음 → 401 에러 반환
5. 쿠키 있음 → 등록 여부 재확인
6. 등록 안 됨 → 403 에러 반환
7. 등록 됨 → 이메일/전화번호로 중복 체크
8. 중복 없음 → 설문 응답 저장 (이메일, 이름 포함)
```

## 📊 인증 쿠키 구조

### 쿠키 이름
```
ondemand_auth_{webinarId}
```

### 쿠키 값 (JSON)
```json
{
  "webinarId": "uuid",
  "email": "user@example.com",
  "name": "홍길동",
  "verifiedAt": 1234567890
}
```

### 쿠키 설정
- `httpOnly: true` - XSS 공격 방지
- `secure: true` (프로덕션) - HTTPS 전용
- `sameSite: 'lax'` - CSRF 공격 방지
- `maxAge: 7일` - 7일간 유효
- `path: /ondemand/{id}` - 해당 웨비나 경로에만 유효

## 🔄 중복 체크 로직

### 설문 제출 시 중복 체크 순서
1. **이메일 기반** (우선순위 1)
   - `ondemand_survey_responses` 테이블에서 `webinar_id`와 `email`로 조회
   - 인증된 사용자의 이메일 사용

2. **전화번호 기반** (우선순위 2)
   - 이메일로 찾지 못한 경우에만 전화번호로 확인
   - `ondemand_survey_responses` 테이블에서 `webinar_id`와 `phone_norm`으로 조회

### 중복 발견 시
- `alreadySubmitted: true` 반환
- 기존 `survey_no`와 `code6` 반환
- 새 설문 응답 생성하지 않음

## 📝 변경된 파일 목록

### 새로 생성된 파일
1. `lib/utils/ondemand-auth.ts` - 인증 헬퍼 함수
2. `supabase/migrations/102_add_email_to_ondemand_survey_responses.sql` - DB 스키마 개선
3. `docs/온디맨드_인증_구조_개선_보고서.md` - 이 문서

### 수정된 파일
1. `app/api/ondemand/[id]/check-registration/route.ts` - 인증 쿠키 설정 추가
2. `app/api/public/ondemand/[id]/survey/submit/route.ts` - 인증 체크 및 이메일 저장 추가
3. `app/(ondemand)/ondemand/[id]/watch/page.tsx` - 헬퍼 함수 사용으로 리팩토링
4. `app/(ondemand)/ondemand/[id]/watch/[sessionKey]/page.tsx` - 헬퍼 함수 사용으로 리팩토링

## 🧪 테스트 체크리스트

### 인증 테스트
- [ ] 로그인 없이 `/watch` 접근 시 로그인 페이지로 리다이렉트
- [ ] 로그인 없이 `/watch/[sessionKey]` 접근 시 로그인 페이지로 리다이렉트
- [ ] 등록되지 않은 사용자 로그인 시 에러 메시지 표시
- [ ] 등록된 사용자 로그인 시 `/watch`로 이동
- [ ] 인증 쿠키가 설정되는지 확인

### 설문 제출 테스트
- [ ] 인증 없이 설문 제출 시 401 에러 반환
- [ ] 등록되지 않은 사용자 설문 제출 시 403 에러 반환
- [ ] 인증된 사용자 설문 제출 시 정상 저장
- [ ] 설문 응답에 이메일과 이름이 저장되는지 확인
- [ ] 동일 이메일로 중복 제출 시 중복 메시지 반환
- [ ] 동일 전화번호로 중복 제출 시 중복 메시지 반환

### 데이터베이스 테스트
- [ ] 마이그레이션 실행 후 `email` 컬럼 추가 확인
- [ ] 이메일 기반 유니크 인덱스 생성 확인
- [ ] 이메일 조회 인덱스 생성 확인

## 🚀 배포 전 확인 사항

1. **마이그레이션 실행**
   ```sql
   -- Supabase 대시보드에서 마이그레이션 실행
   -- 또는 CLI: supabase migration up
   ```

2. **기존 설문 응답 데이터**
   - 기존 설문 응답은 `email` 컬럼이 `NULL`일 수 있음
   - 새로운 설문 응답부터는 이메일 필수

3. **쿠키 호환성**
   - 기존 사용자의 쿠키는 무효화됨
   - 재로그인 필요

## 📌 향후 개선 사항

1. **세션 만료 처리**
   - 쿠키 만료 시 자동 갱신 로직 추가 고려

2. **로그아웃 기능**
   - 명시적인 로그아웃 버튼 추가
   - 쿠키 삭제 API 제공

3. **인증 토큰 갱신**
   - 장기간 사용 시 토큰 갱신 메커니즘 추가

4. **감사 로그**
   - 설문 제출 시 사용자 추적을 위한 감사 로그 추가

## 📚 관련 문서

- [웨비나 인증 구조 분석](./웨비나_인증_presence_통계_전체_구조_분석.md)
- [인덱스 생성 가이드](./인덱스_생성_단계별_가이드.md)
