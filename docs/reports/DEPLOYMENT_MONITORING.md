# P0-PR1~3 배포 모니터링 보고서

**배포 시작 시각**: 2026-02-07 11:46:18 KST (머지 완료)  
**모니터링 기간**: 배포 완료 후 30분

---

## 1. PR 머지 완료

- **PR 번호**: #1
- **머지 시각**: 2026-02-07 11:46:18 KST (2026-02-07T02:46:18Z UTC)
- **머지 커밋 SHA**: `a8719e7a02f879b3b39cdf290c3fbed7311410d5`
- **상태**: MERGED ✅

---

## 2. 프로덕션 배포 확인

**배포 확인 방법**: Vercel 대시보드에서 확인 필요

- [ ] 배포 완료 시각: `[확인 필요]`
- [ ] 배포 ID/URL: `[확인 필요]`
- [ ] 배포 커밋 SHA: `a8719e7` (머지 커밋과 일치 확인)

**참고**: Vercel 자동 배포가 활성화되어 있다면 머지 후 자동으로 배포가 시작됩니다.

---

## 3. 배포 후 30분 DoD 모니터링

### DoD-1: PostgREST 400

**확인 항목**: `registrations.id` 관련 400이 0건인지 확인

**검색 키워드**: 
- `registrations.id`
- `column registrations.id does not exist`
- `400`

**확인 방법**: Supabase 대시보드 → Logs → API Logs

**결과**: 
- [ ] 상태: `[확인 중]`
- [ ] 발견된 400 에러 수: `[확인 중]`
- [ ] 로그 요약: `[확인 중]`

---

### DoD-2: PostgREST 409

**확인 항목**: `duplicate key` / registrations 충돌이 "폭발"하지 않는지 확인

**검색 키워드**:
- `409`
- `duplicate key`
- `registrations`
- `onConflict`

**확인 방법**: Supabase 대시보드 → Logs → Postgres Logs

**결과**:
- [ ] 상태: `[확인 중]`
- [ ] 발견된 409 에러 수: `[확인 중]`
- [ ] 트래픽 증폭 여부: `[확인 중]`
- [ ] 로그 요약: `[확인 중]`

---

### DoD-3: Auth 폭주 여부

**확인 항목**: `/auth/v1/user` 호출이 비정상 증가하지 않는지 확인

**검색 키워드**:
- `/auth/v1/user`
- `refresh_token_already_used`
- `401`
- `auth`

**확인 방법**: Supabase 대시보드 → Logs → Auth Logs

**결과**:
- [ ] 상태: `[확인 중]`
- [ ] `/auth/v1/user` 호출량: `[확인 중]`
- [ ] 비정상 증가 여부: `[확인 중]`
- [ ] 로그 요약: `[확인 중]`

---

### DoD-4: 기능 회귀 테스트

#### 4-1. 등록자 계정 테스트

- [ ] 등록자 계정으로 라이브 진입 → 채팅/Q&A 정상
- [ ] 결과: `[테스트 필요]`

#### 4-2. 관리자 계정 테스트

- [ ] 관리자 계정으로 stats/access 진입 → currentParticipants/타임라인 정상
- [ ] 결과: `[테스트 필요]`

#### 4-3. 체크C: 비등록자 플로우 확인 (중요)

**테스트 시나리오**:
1. 비등록자 상태에서 라이브 진입 시도
2. `access/track` 호출 확인
3. `presence/ping` 호출 확인

**확인 사항**:
- [ ] 라이브 진입이 정책대로 차단/유도되는지
- [ ] `access/track`에서 의도대로 등록 생성이 일어나는지 (또는 정책상 생성하지 않는지)
- [ ] `presence/ping`이 등록을 생성하지 않는지 (403 유지가 정상인지 정책 확인)

**정책 확인** (코드 분석 결과):
- ✅ 현재 제품 정책: **"등록 없이도 입장 가능(자동등록)"** (옵션 B)
  - `access/track`에서 로그인한 사용자에 대해 자동 등록 처리 (upsert 사용)
  - `presence/ping`은 등록이 없으면 403 반환 (등록 생성하지 않음)
  - 정상 플로우: `access/track` 호출 → 자동 등록 생성 → 이후 `presence/ping`은 204 반환

**체크C 판정**:
- ✅ 정책: **"등록 없이도 입장 가능(자동등록)"** (옵션 B)
- ✅ 현재 동작이 정책과 일치하는지: **예** (access/track에서 자동 등록, ping은 등록 생성하지 않음)
- ✅ 결론: **정상 동작** - `access/track`에서 1회 등록 생성 후 `presence/ping`이 204로 바뀌는 것이 정상

---

## 4. 롤백 트리거 확인

아래 중 하나라도 발생하면 즉시 롤백:

- [ ] DoD-1 실패 (400 재발)
- [ ] DoD-2 실패 (409 폭발 + DB 부하 상승)
- [ ] 기능 회귀로 운영 불가

**롤백 상태**: 
- [ ] 롤백 필요 여부: `[확인 중]`
- [ ] 롤백 실행 여부: `[아니오]`

**롤백 절차** (필요 시):
```bash
git revert a8719e7
git push origin main
# Vercel 자동 배포 확인
```

---

## 5. 이상 징후 기록

**발견된 이상 징후**:
- 없음 (현재)

**로그 요약** (PII 제외):
- `[확인 중]`

---

## 6. 모니터링 타임라인

| 시각 | 이벤트 | 상태 |
|------|--------|------|
| 11:46:18 KST | PR 머지 완료 | ✅ |
| [TBD] | 배포 완료 | ⏳ |
| [TBD] | DoD-1 확인 | ⏳ |
| [TBD] | DoD-2 확인 | ⏳ |
| [TBD] | DoD-3 확인 | ⏳ |
| [TBD] | DoD-4 테스트 | ⏳ |
| [TBD] | 체크C 판정 | ⏳ |

---

**작성자**: Cursor Agent  
**최종 업데이트**: 2026-02-07 11:46:18 KST
