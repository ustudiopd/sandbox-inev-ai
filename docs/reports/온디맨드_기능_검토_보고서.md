# 온디맨드(On-Demand) 기능 구현 검토 보고서

**작성일**: 2026-02-03  
**검토 대상**: `온디맨드.md` 명세서  
**현재 시스템 상태**: 라이브 웨비나 시스템 운영 중

---

## 📋 요약

온디맨드 명세서는 **기존 라이브 웨비나 시스템과의 완전 분리**를 핵심 원칙으로 설계되어 있어 **안전하게 구현 가능**합니다. 다만 몇 가지 주의사항과 개선 제안이 있습니다.

---

## ✅ 명세서의 강점

### 1. **완전 분리 설계 (Add-only 원칙)**
- ✅ 라우트 분리: `/ondemand/*` vs `/webinar/*`
- ✅ 데이터 모델 확장: 기존 컬럼 변경 없이 `type` 컬럼 추가
- ✅ 코드 오염 방지: 라이브 관련 import 금지 명시

### 2. **점진적 구현 전략**
- ✅ Phase별 명확한 단계 구분
- ✅ Mock → DB 연결 → 트래킹 → QnA → 알림 순서

### 3. **안전장치 명시**
- ✅ 실시간 기능 금지 (Realtime, 집계, AI 호출)
- ✅ 라이브 기능과의 명확한 구분

---

## ⚠️ 주의사항 및 개선 제안

### 1. **데이터베이스 스키마 변경**

#### 현재 상태
- `webinars` 테이블에 `type` 컬럼이 없음
- `settings` 또는 `config` JSONB 컬럼 존재 여부 확인 필요

#### 필요한 작업
```sql
-- 1. type 컬럼 추가 (nullable, 기본값 null = live)
ALTER TABLE webinars 
ADD COLUMN type TEXT CHECK (type IN ('live', 'ondemand'));

-- 2. settings JSONB 컬럼 확인/추가
-- (기존에 있다면 사용, 없다면 추가)
ALTER TABLE webinars 
ADD COLUMN IF NOT EXISTS settings JSONB DEFAULT '{}'::jsonb;
```

#### 제안
- `type` 컬럼은 **NOT NULL DEFAULT 'live'**로 설정하는 것이 더 안전
- 기존 데이터는 모두 `live`로 간주되므로 마이그레이션 안전

---

### 2. **QnA 시스템 확장**

#### 현재 상태
- `questions` 테이블 존재
- `session_key` 컬럼 없음
- 현재는 `webinar_id` 단위로만 질문 관리

#### 필요한 변경
```sql
-- questions 테이블에 session_key 추가
ALTER TABLE questions 
ADD COLUMN session_key TEXT;

-- 인덱스 추가 (온디맨드 QnA 조회 성능)
CREATE INDEX IF NOT EXISTS idx_questions_session_key 
ON questions(webinar_id, session_key) 
WHERE session_key IS NOT NULL;
```

#### 제안
- `session_key`는 **nullable**로 설정 (라이브 웨비나는 null)
- 온디맨드 전용 필터: `WHERE session_key IS NOT NULL`
- 기존 라이브 QnA는 영향 없음

---

### 3. **트래킹 시스템 설계**

#### 현재 상태
- `webinar_access_logs` 테이블 존재 (접속 기록)
- 영상 재생 진행률(progress) 추적 시스템 없음

#### 필요한 신규 테이블
```sql
-- 온디맨드 영상 세션 트래킹 테이블
CREATE TABLE ondemand_session_events (
  id BIGSERIAL PRIMARY KEY,
  webinar_id UUID NOT NULL REFERENCES webinars(id) ON DELETE CASCADE,
  session_key TEXT NOT NULL,
  participant_id UUID REFERENCES profiles(id),
  visitor_id TEXT, -- 익명 사용자용
  event_type TEXT NOT NULL CHECK (event_type IN (
    'play_start', 'progress_25', 'progress_50', 
    'progress_75', 'progress_90', 'complete'
  )),
  event_data JSONB, -- 추가 메타데이터
  created_at TIMESTAMPTZ DEFAULT NOW(),
  
  -- 중복 방지: 같은 사용자가 같은 이벤트를 여러 번 기록하지 않음
  UNIQUE(webinar_id, session_key, participant_id, visitor_id, event_type)
);

-- 인덱스
CREATE INDEX idx_ondemand_events_webinar_session 
ON ondemand_session_events(webinar_id, session_key);
CREATE INDEX idx_ondemand_events_participant 
ON ondemand_session_events(participant_id) 
WHERE participant_id IS NOT NULL;
```

#### 제안
- **중복 방지**: UNIQUE 제약으로 같은 이벤트 중복 기록 방지
- **익명 사용자 지원**: `visitor_id` (localStorage 기반)
- **이벤트 타입 확장 가능**: CHECK 제약으로 제한하되, 필요시 마이그레이션

---

### 4. **YouTube 플레이어 확장**

#### 현재 상태
- ✅ `YouTubePlayer` 컴포넌트 존재 (`components/webinar/YouTubePlayer.tsx`)
- ✅ 재사용 가능한 구조
- ❌ 재생 진행률 이벤트 추적 기능 없음

#### 필요한 확장
```typescript
// YouTubePlayer에 진행률 추적 기능 추가
interface YouTubePlayerProps {
  // ... 기존 props
  onProgress?: (progress: number) => void; // 0-100
  onPlayStart?: () => void;
  onComplete?: () => void;
}
```

#### 제안
- **YouTube IFrame API 사용**: `enablejsapi=1` 이미 설정됨
- **이벤트 리스너 추가**: `onStateChange`, `onPlaybackQualityChange`
- **진행률 계산**: `getCurrentTime() / getDuration() * 100`

---

### 5. **라우팅 구조**

#### 현재 상태
- `/webinar/[id]` - 입장 페이지
- `/webinar/[id]/live` - 라이브 시청 페이지
- `/ondemand/*` 라우트 없음

#### 필요한 신규 라우트
```
app/
  (ondemand)/          # 새 라우트 그룹
    ondemand/
      [id]/
        page.tsx       # 온디맨드 랜딩 페이지
        watch/
          page.tsx     # 세션 목록 페이지
          [sessionKey]/
            page.tsx   # 영상 시청 페이지
```

#### 제안
- **라우트 그룹 분리**: `(ondemand)` 그룹으로 완전 분리
- **레이아웃 분리**: `(ondemand)/layout.tsx` 생성 (라이브 레이아웃과 분리)
- **공통 컴포넌트**: `YouTubePlayer`는 재사용, 나머지는 분리

---

### 6. **QnA 시스템 개선**

#### 현재 상태
- `questions` 테이블: `status`는 `published`, `answered`, `hidden`, `pinned`
- 명세서 요구: `new`, `answered`, `closed`

#### 제안
- **기존 status 유지**: 라이브 웨비나 영향 방지
- **온디맨드 전용 필터**: `session_key IS NOT NULL` 조건으로 구분
- **상태 매핑**:
  - `published` → `new` (온디맨드에서만)
  - `answered` → `answered` (공통)
  - `hidden` → `closed` (온디맨드에서만)

또는

- **새로운 상태 값 추가**: `new`, `closed`를 CHECK 제약에 추가
- **기존 데이터 영향 없음**: 기존 값들은 그대로 유지

---

### 7. **알림 시스템**

#### 현재 상태
- 이메일 발송 시스템 존재 (`EMAIL_SETUP.md` 참고)
- QnA 생성 시 자동 알림 없음

#### 필요한 작업
- **비동기 이메일 큐**: QnA 생성 후 즉시 발송하지 않고 큐에 추가
- **실패 처리**: 이메일 실패해도 QnA 저장은 성공
- **재시도 전략**: 실패 시 재시도 (최대 3회, 지수 백오프)

#### 제안
- **Vercel Queue** 또는 **Supabase Edge Functions** 활용
- **간단한 구현**: `/api/ondemand/qna/notify` 엔드포인트 생성
- **크론 작업**: 주기적으로 실패한 알림 재시도

---

## 🔍 구현 우선순위 (수정안)

### Phase 1: 프론트 스켈레톤 ✅ (명세서 동일)
- Mock 데이터 기반 UI
- 라우트 구조만 생성

### Phase 2: 데이터 모델 확장 (명세서 Phase 2 수정)
1. **DB 마이그레이션** (우선)
   - `webinars.type` 컬럼 추가
   - `webinars.settings` JSONB 확인/추가
   - `questions.session_key` 추가
   - `ondemand_session_events` 테이블 생성

2. **데이터 읽기**
   - `type='ondemand'` 웨비나 조회
   - 세션 JSON 파싱

### Phase 3: 트래킹 (명세서 Phase 3)
- YouTube 플레이어 진행률 추적 추가
- `ondemand_session_events` 적재
- 중복 방지 로직

### Phase 4: QnA (명세서 Phase 4)
- 세션별 QnA 제출
- 관리자 인박스 (세션 필터 추가)

### Phase 5: 알림 (명세서 Phase 5)
- 비동기 이메일 발송
- 재시도 전략

---

## ⚠️ 위험 요소 및 대응 방안

### 1. **기존 라이브 웨비나 영향**

#### 위험
- `type` 컬럼 추가 시 기존 쿼리 실패 가능
- `questions.session_key` 추가 시 기존 QnA 조회 로직 영향

#### 대응
- ✅ **NULL 허용**: 모든 새 컬럼은 nullable
- ✅ **기본값 설정**: `type` 기본값 `'live'`
- ✅ **조건부 쿼리**: `WHERE type IS NULL OR type = 'live'` (기존 동작 유지)

---

### 2. **YouTube API 제한**

#### 위험
- IFrame API 호출 제한
- 진행률 추적 정확도 문제

#### 대응
- ✅ **폴링 간격 조정**: 5초마다 진행률 체크 (너무 빈번하지 않게)
- ✅ **에러 핸들링**: API 실패 시 조용히 무시
- ✅ **클라이언트 측 캐싱**: 같은 세션에서 중복 이벤트 방지

---

### 3. **성능 이슈**

#### 위험
- 온디맨드 페이지에서 실수로 실시간 구독 활성화
- 트래킹 이벤트 과다 발생

#### 대응
- ✅ **코드 리뷰**: `/ondemand/*` 라우트에서 Realtime import 금지
- ✅ **ESLint 규칙**: `no-restricted-imports` 설정
- ✅ **이벤트 디바운싱**: 진행률 이벤트는 최소 5초 간격

---

## 📝 추가 제안사항

### 1. **테스트 전략**
- ✅ **기존 라이브 웨비나 2건 무변경 동작 확인** (DoD)
- ✅ **온디맨드 라우트에서 라이브 기능 접근 불가 확인**
- ✅ **트래킹 이벤트 중복 방지 확인**

### 2. **모니터링**
- ✅ **온디맨드 페이지 접근 로그**
- ✅ **트래킹 이벤트 적재 실패 알림**
- ✅ **이메일 발송 실패 알림**

### 3. **문서화**
- ✅ **온디맨드 관리자 가이드** (세션 추가 방법)
- ✅ **트래킹 데이터 조회 가이드**
- ✅ **QnA 관리 가이드**

---

## ✅ 최종 결론

**온디맨드 명세서는 구현 가능하며, 기존 시스템과의 분리가 잘 설계되어 있습니다.**

### 구현 가능성: ⭐⭐⭐⭐⭐ (5/5)

### 주요 개선 사항
1. ✅ DB 스키마 변경 계획 명확화
2. ✅ 트래킹 테이블 설계 추가
3. ✅ YouTube 플레이어 확장 계획
4. ✅ QnA 시스템 확장 계획

### 다음 단계
1. **DB 마이그레이션 스크립트 작성**
2. **라우트 구조 생성** (`app/(ondemand)/ondemand/...`)
3. **Mock 데이터 기반 UI 구현**
4. **단계별 테스트**

---

**검토 완료일**: 2026-02-03
