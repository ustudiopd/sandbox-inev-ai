# 최적화 검토 문서 피드백 반영 요약

**작성일**: 2026-02-07  
**피드백 출처**: `docs/검토의견피드백.md`

---

## ✅ 피드백 핵심 내용

### 1. 우선순위 재정렬

**변경사항**:
- 관리자 폴링 감속: **P0 → P1로 조정**
  - 이유: 이번 장애의 "직접 트리거"는 400/409 + 핫패스였으니, P0에서 핫패스부터 얇게 만드는 게 더 효과적
  - 관리자 폴링은 분당 쿼리 수 자체는 크지 않지만, 장애 상황에서는 작은 추가부하도 체감 영향이 큼

### 2. 티켓 1-1 방향 변경 (캐싱 → 구조 변경)

**변경사항**:
- **선택 기준 명확화**: (A) 선택 권장
  - 이유: `access/track`에서 이미 자동 등록을 처리하고 있음
  - 캐싱은 "지금 구조를 유지"한 채로 부하를 줄이는 패치인데, 핫패스에 읽기/쓰기/오류 루프가 섞여 있는 것 자체가 근본 리스크
  - 등록은 입장 시 1회만 처리 (`access/track`에서)

### 3. 서킷 브레이커 강조 (재시도보다)

**변경사항**:
- 티켓 4-1 (Chat/QA 폴백 폴링) 구현 가이드 보완:
  - **4xx 에러(400/401/403/404)는 즉시 중단** (재시도 가치 없음)
  - **429(레이트리밋)는 백오프 증가 + 서킷 브레이커 트리거**
  - **5xx(서버 오류)는 백오프 증가** (서버 오류는 일시적일 수 있음)
  - **서킷 브레이커 패턴**: 연속 실패 시 완전 중단 (CLOSED → OPEN → HALF_OPEN)
  - 최악의 경우 "폴백 비활성화 + UI에 안내"가 DB를 지키는 선택

### 4. Vercel 서버리스 제거 제안 (새 티켓 추가)

**추가사항**:
- **WS-2: 참가자 핫패스에서 Vercel 서버리스 제거 (P1)**
  - 티켓 2-1: 참가자 핫패스에서 Vercel 서버리스를 빼고, 가능하면 Supabase RPC로 직행
  - 목적: `/presence/ping`, `/access/track` 같은 고빈도 요청에서 Vercel 함수 실행 + auth.getUser 호출이 누적되면 Auth/DB 모두에 부담
  - 구현: 클라이언트 → Supabase RPC 직접 호출 (서버리스 hop 제거)
  - DoD: `/auth/v1/user` 호출량이 눈에 띄게 감소, 참가자 1인당 "분당 서버 호출수"가 목표치로 내려감

---

## 📋 업데이트된 우선순위 구조

### P0: 오늘 바로 고쳐야 하는 것 (장애 재발 방지)

1. **WS-0(스키마 불일치/오류 루프)**
   - 티켓 0-1: `registrations.id` 참조 전수 제거 + 에러 시 즉시 종료
   - 티켓 0-2: 409(중복키) 경합을 "정상 흐름"으로 흡수

2. **WS-1(핫패스 경량화) - 티켓 1-1 우선**
   - 티켓 1-1: `presence/ping`에서 "자동 등록 생성" 제거 (선택 A 권장)
   - 티켓 1-2: `access/track` 역할 재정의(세션/접속 로그로 축소)

### P1: 1주 내 구조 안정화 (부하 체질 개선)

3. **WS-2(서버리스 제거) + WS-3(Auth 병목) + WS-4(폴백 폭탄 방지)**
   - 티켓 2-1: 참가자 핫패스에서 Vercel 서버리스 제거, Supabase RPC 직행 ⭐ **신규**
   - 티켓 3-1: 고빈도 API에서 `/auth/v1/user` 의존도 낮추기
   - 티켓 3-2: `refresh_token_already_used` 경합 방지
   - 티켓 4-1: Chat/QA 폴백 폴링에 서킷 브레이커 도입 (4xx 즉시 중단, 5xx 백오프) ⭐ **보완**
   - 티켓 4-2: 중복 로그인 체크 주기 재설계(이벤트 기반 + 저빈도 보정)

4. **WS-5(관리자 폴링 감속)** ⬇️ **P0에서 P1로 조정**
   - 티켓 5-1: `/stats/access` 폴링을 준실시간 + 설정 가능 구조로

### P2: 1달 내 (성능·운영 체계 고도화)

5. 측정 기반으로 **WS-6(RLS)** / **WS-8(부하테스트)** / **WS-9(격리)**

---

## 🔧 주요 변경사항 상세

### 티켓 1-1: 선택 기준 보완

**변경 전**:
- 안정성 우선이면 (A)
- UX 때문에 "어떤 경로로 들어와도 자동 등록"이 꼭 필요하면 (B) + 강한 상한/가드 필요

**변경 후**:
- **권장: (A) 선택** - 안정성 우선
  - 이유: `access/track`에서 이미 자동 등록을 처리하고 있음
  - `presence/ping`은 heartbeat 역할에 집중하는 것이 안정적
  - 등록은 입장 시 1회만 처리 (`access/track`에서)
  - 캐싱은 "지금 구조를 유지"한 채로 부하를 줄이는 패치인데, 핫패스에 읽기/쓰기/오류 루프가 섞여 있는 것 자체가 근본 리스크
- UX 때문에 "어떤 경로로 들어와도 자동 등록"이 꼭 필요하면 (B) + 강한 상한/가드 필요 (비권장)

### 티켓 4-1: 서킷 브레이커 구현 가이드 보완

**추가된 내용**:
- **4xx 에러(400/401/403/404)는 즉시 중단** (재시도 가치 없음, 클라이언트 오류)
- **429(레이트리밋)는 백오프 증가 + 서킷 브레이커 트리거**
- **5xx(서버 오류)는 백오프 증가** (서버 오류는 일시적일 수 있음)
- **서킷 브레이커 패턴**: 연속 실패 시 완전 중단 (CLOSED → OPEN → HALF_OPEN)
- 최악의 경우 "폴백 비활성화 + UI에 안내(현재 실시간이 불안정)"가 DB를 지키는 선택

### 신규 티켓 2-1: Vercel 서버리스 제거

**목적**:
- `/presence/ping`, `/access/track` 같은 고빈도 요청에서 Vercel 함수 실행 + auth.getUser 호출이 누적되면 Auth/DB 모두에 부담
- 서버리스 hop을 제거하여 지연과 비용 감소

**구현 가이드**:
- 참가자 측 heartbeat는 가능한 한 **클라이언트 → Supabase RPC**로 바로 보내서 서버리스 hop 제거
- `usePresencePing.ts`에서:
  ```typescript
  // ❌ 현재: Next.js API Route 경유
  await fetch(`/api/webinars/${webinarId}/presence/ping`)
  
  // ✅ 수정 후: Supabase RPC 직접 호출
  await supabase.rpc('webinar_presence_ping', {
    _webinar_id: webinarId
  })
  ```

**DoD**:
- `/auth/v1/user` 호출량이 눈에 띄게 감소(서버리스에서 매번 인증확인하던 패턴 제거)
- 참가자 1인당 "분당 서버 호출수"가 목표치로 내려감(예: 0.5회/분 수준)
- `presence/ping` 응답 시간이 개선됨 (서버리스 hop 제거)

---

## ✅ 피드백 반영 완료 사항

- [x] 우선순위 재정렬 (관리자 폴링 P0 → P1)
- [x] 티켓 1-1 선택 기준 명확화 (A 선택 권장)
- [x] 티켓 4-1 서킷 브레이커 구현 가이드 보완
- [x] 신규 티켓 2-1 추가 (Vercel 서버리스 제거)
- [x] 워크스트림 번호 재정렬 (WS-2~WS-9)

---

## 📝 다음 단계

1. **최적화검토.md 파일 직접 수정** (위 변경사항 반영)
2. **P0 변경 후 기대 부하 변화 재산정** (피드백 요청사항)
   - 쿼리 수/분, auth 요청/분 등 수치로 개선 효과 제시

---

**작성 완료일**: 2026-02-07
