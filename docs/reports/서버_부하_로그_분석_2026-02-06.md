# 서버 부하 로그 분석 보고서
**날짜**: 2026년 2월 6일  
**시간대**: 14:00 이후 (오후 2시)  
**프로젝트**: EventLive (yqsayphssjznthrxpgfb)

---

## 📊 요약

오후 2시경부터 서버 부하가 발생하여 시스템이 다운되었고, 용량 증가 후 복구되었습니다. 로그 분석 결과 주요 문제점을 확인했습니다.

---

## 🔴 주요 에러 분석

### 1. Postgres 데이터베이스 에러

#### 1.1 컬럼 존재하지 않음 에러
**에러 메시지**: `column registrations.id does not exist`  
**발생 빈도**: 매우 높음 (수백 건)  
**영향**: registrations 테이블 조회 시 실패

**원인 분석**:
- `registrations` 테이블에 `id` 컬럼이 존재하지 않거나
- 쿼리에서 존재하지 않는 컬럼을 참조하고 있음
- 스키마 변경 후 코드가 업데이트되지 않았을 가능성

**영향받는 API**:
- `GET /rest/v1/registrations?select=id&...` → 400 에러 발생

#### 1.2 중복 키 제약 위반
**에러 메시지**: `duplicate key value violates unique constraint "registrations_pkey"`  
**발생 빈도**: 높음  
**영향**: 동시 등록 시도 시 충돌 발생

**원인 분석**:
- 동일한 사용자가 동일한 웨비나에 중복 등록 시도
- Primary Key 제약 조건 위반
- 동시성 제어 부족

**영향받는 API**:
- `POST /rest/v1/registrations` → 409 Conflict 에러 발생

---

### 2. API 요청 패턴 분석

#### 2.1 높은 트래픽 발생
- **시간대**: 2026-02-06 14:57:05 ~ 14:57:09 (UTC)
- **주요 엔드포인트**:
  - `/rest/v1/webinars` - 웨비나 정보 조회
  - `/rest/v1/questions` - 질문 목록 조회
  - `/rest/v1/profiles` - 프로필 정보 조회 (대량)
  - `/rest/v1/registrations` - 등록 확인/생성
  - `/auth/v1/user` - 사용자 인증

#### 2.2 응답 시간 분석
- **정상 응답**: 대부분 200 OK
- **에러 응답**:
  - 400 Bad Request: registrations 조회 시 (id 컬럼 문제)
  - 409 Conflict: 중복 등록 시도

#### 2.3 동시 요청 패턴
- 동일한 웨비나 ID (`f257ce42-723a-4fad-a9a5-1bd8c154d7ce`)에 대한 집중된 요청
- 프로필 조회 시 대량의 사용자 ID를 한 번에 조회 (`id=in.(...)`)
- 짧은 시간 내 수백 건의 요청 발생

---

## 🔍 근본 원인 분석

### 1. 스키마 불일치
- `registrations` 테이블의 실제 스키마와 코드에서 기대하는 스키마가 불일치
- `id` 컬럼이 없거나 다른 이름으로 변경되었을 가능성

### 2. 동시성 문제
- 동일 사용자의 중복 등록 시도
- Race condition으로 인한 중복 키 에러

### 3. 트래픽 급증
- 특정 시간대에 집중된 트래픽
- 웨비나 시작 시간과 맞춰진 사용자 접속

---

## 💡 권장 조치 사항

### 즉시 조치 (긴급)

1. **registrations 테이블 스키마 확인**
   ```sql
   -- registrations 테이블 구조 확인
   SELECT column_name, data_type 
   FROM information_schema.columns 
   WHERE table_name = 'registrations';
   ```

2. **코드에서 registrations.id 사용 부분 수정**
   - `select=id` 제거 또는 실제 존재하는 컬럼으로 변경
   - Primary Key가 다른 컬럼인지 확인

3. **중복 등록 방지 로직 강화**
   - UPSERT 패턴 사용 (`on_conflict` 처리)
   - 클라이언트 측 중복 요청 방지

### 중기 조치

1. **인덱스 최적화**
   - registrations 테이블의 조회 패턴에 맞는 인덱스 추가
   - `(webinar_id, user_id)` 복합 인덱스 확인

2. **쿼리 최적화**
   - 대량 프로필 조회 시 배치 크기 제한
   - 불필요한 컬럼 조회 제거

3. **에러 핸들링 개선**
   - 400/409 에러에 대한 적절한 사용자 피드백
   - 재시도 로직 구현

### 장기 조치

1. **모니터링 강화**
   - 실시간 에러 알림 설정
   - 트래픽 패턴 모니터링
   - 성능 메트릭 추적

2. **부하 테스트**
   - 예상 트래픽에 대한 부하 테스트 수행
   - 용량 계획 수립

3. **캐싱 전략**
   - 자주 조회되는 데이터 캐싱
   - CDN 활용

---

## 📈 성능 메트릭

### API 응답 시간 (샘플)
- 평균: ~3-5초
- 최대: ~32초 (일부 요청)
- 최소: ~2초

### 에러율
- Postgres 에러: 매우 높음 (수백 건)
- API 400 에러: 중간 (registrations 관련)
- API 409 에러: 중간 (중복 등록)

---

## 📝 참고 사항

- 로그 타임스탬프는 마이크로초 단위 (Unix timestamp)
- UTC 시간 기준 (한국 시간: UTC+9)
- 주요 웨비나 ID: `f257ce42-723a-4fad-a9a5-1bd8c154d7ce`

---

## 🔗 관련 파일

- API 로그: `C:\Users\User\.cursor\projects\d-vibecoding-uslab-EventLive\agent-tools\72f5172d-378e-4260-807e-d4b7b747b006.txt`
- Postgres 로그: `C:\Users\User\.cursor\projects\d-vibecoding-uslab-EventLive\agent-tools\829f1876-0b4d-43cf-b2be-0108268064ab.txt`

---

**작성일**: 2026년 2월 6일  
**작성자**: AI Assistant
