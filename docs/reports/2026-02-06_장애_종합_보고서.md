# 2026년 2월 6일 EventLive 장애 종합 보고서

**작성일**: 2026-02-08  
**대상 시스템**: EventLive (Supabase + Next.js)  
**장애 시간대**: 2026-02-06 13:30~15:00 (KST)

---

## 1. 요약

2026년 2월 6일 오후, 주요 웨비나 "AI 특허리서치 실무 활용 웨비나"(웨비나 149402)에서 **동시 접속자가 급증**(최대 311명)하면서 Supabase DB 한도 초과·성능 저하가 발생하였다. 원인은 **코드 오류(registrations.id 참조)**와 **핫패스 과부하**가 결합한 것이었고, 당일 **인프라 확장**으로 서비스는 복구되었으며, 이어서 **원인 제거를 위한 코드 수정(P0)**과 **배포 후 점검·테스트**를 거쳐 조치를 완료하였다.

---

## 2. 장애 원인: 어떤 문제로 터졌는가

### 2.1 직접 트리거(근접 원인)

| 순위 | 원인 | 설명 |
|------|------|------|
| **1위** | **registrations.id 참조로 인한 400 에러 폭발** | `registrations` 테이블은 **복합 기본 키 (webinar_id, user_id)**만 있고 **`id` 컬럼이 없음**. 그런데 `presence/ping`, `access/track` API에서 `.select('id')`를 호출하여 **PostgREST 400** (`column registrations.id does not exist`)이 대량 발생. 1,000명 동시 접속 가정 시 **1분당 약 1,700건**, 웨비나 시작 직후 2분간 **약 2,000건** 수준으로 집중 발생. |
| **2위** | **400 발생 시에도 로직이 계속 진행되는 오류 루프** | 400이 나면 "등록이 없다"로 판단하고 **자동 등록 INSERT**까지 시도. 이로 인해 **409 Conflict**(중복 키 위반)까지 연쇄 발생하고, DB/Auth 부하가 추가로 증폭됨. |
| **3위** | **동시 등록 시도로 인한 409 에러** | 동일 (webinar_id, user_id)로 여러 요청이 동시에 INSERT를 시도하여 `registrations_pkey` 중복 키 에러 다수 발생. |

**관련 코드 위치**

- `app/api/webinars/[webinarId]/presence/ping/route.ts` (69, 117, 148행): `.select('id')` 호출
- `app/api/webinars/[webinarId]/access/track/route.ts` (52행): `.select('id')` 호출

### 2.2 트래픽 증폭 요인

- **Presence Ping (120초 주기)**: 모든 참가자가 2분마다 호출, 요청 1회당 DB 쿼리 4~10회 → 동접 증가 시 쿼리 수 급증.
- **관리자 대시보드 폴링 (5초 주기)**: `/stats/access` 5초마다 호출, 1회당 6~8 쿼리. 인당 부하는 작으나 장애 시 추가 부하로 작용.
- **N+1 쿼리(당시)**: 관리자 대시보드에서 접속자별로 개별 `/api/profiles/{userId}` 호출 → 265명 기준 26.5초 이상 지연 가능.

### 2.3 구조적 요인

- **멀티테넌시**: 모든 웨비나가 동일 DB를 사용해 한 웨비나 트래픽이 전체에 영향.
- **RLS 정책**: `webinar_live_presence`, `messages` 등 EXISTS 서브쿼리 기반 정책이 고빈도 호출에서 병목 가능성.
- **Realtime 불안정**: DB 포화 시 Realtime 끊김 → 채팅/Q&A 폴백 폴링(2초 주기) 활성화 시 추가 DB 부하 가능성.

### 2.4 관측된 증상(로그·보고서 기준)

- **Postgres**: `column registrations.id does not exist` 다수, `duplicate key value violates unique constraint "registrations_pkey"` 다수, `Postgrex.Protocol disconnected` 등 연결 풀 한도 관련 에러.
- **API**: 400 Bad Request(registrations 조회), 409 Conflict(중복 등록).
- **Auth**: `/auth/v1/user` 고빈도 호출, 응답 지연, `refresh_token_already_used` 등 토큰 경합.

---

## 3. 당시 라이브로 취한 조치(복구)

장애 발생 후 **당일(2월 6일)** 에 취한 대응은 **인프라 확장**으로, 코드 배포 없이 서비스 복구를 우선한 조치이다.

| 조치 | 내용 | 상태 |
|------|------|------|
| **Supabase 한도 상향** | 데이터베이스 연결 수·리소스 한도 증가 | ✅ 완료 |
| **컴퓨트 사양 변경** | 더 높은 성능의 컴퓨트 인스턴스로 업그레이드 | ✅ 완료 |
| **서비스 모니터링 강화** | 실시간 모니터링 강화 | ✅ 완료 |

이를 통해 **DB 연결 풀·컴퓨트 리소스 한계**로 인한 성능 저하는 완화되었고, 대부분 사용자는 서비스 이용이 가능한 상태로 복구되었다. 다만 **400/409를 유발하는 코드 원인**은 그대로 남아 있어, 동일 트래픽이 재발하면 다시 부하·에러가 발생할 수 있는 상태였다.

---

## 4. 후속 조치: 테스트·점검·코드 수정

### 4.1 원인 분석(2월 7일)

- **장애 원인 코드 기반 진단 보고서** 작성: 트래픽 증폭 맵, 400/409 발생 위치, N+1·RLS·인덱스·인증 경로 분석.
- **검토의견 피드백** 반영: P0(즉시) / P1(1주) / P2(1달) 우선순위 재정렬, 핫패스 경량화·서킷 브레이커·관리자 폴링 주기 조정 방향 확정.

### 4.2 P0 코드 수정(장애 재발 방지)

**머지·배포**: 2026-02-07 11:46 KST 머지, 11:48 KST 배포 완료 (PR #1, 커밋 `a8719e7`).

| 항목 | 수정 내용 |
|------|-----------|
| **registrations.id 참조 제거** | `presence/ping`, `access/track` 전 구간에서 `.select('id')` 제거. 존재하지 않는 컬럼 참조로 인한 400 제거. |
| **에러 시 즉시 종료** | 등록 조회 등에서 error 발생 시 자동 등록 등 후속 로직 진행하지 않도록 fail-fast 처리. |
| **presence/ping 경량화** | 핫패스에서 "자동 등록 생성" 제거 또는 격리. 등록은 입장 시점(access/track 등)에서만 처리. |
| **409 멱등 처리** | 등록 생성 시 UPSERT/onConflict 등으로 동시 요청 시 409를 정상 흐름으로 흡수. |
| **access/track** | 자동 등록·세션 처리를 upsert 등으로 정리해 409·추가 쿼리 감소. |

### 4.3 배포 후 점검(DoD 모니터링)

**배포 결과 문서(DEPLOYMENT_RESULTS.md)** 에 따른 Definition of Done:

| DoD | 확인 항목 | 방법 |
|-----|-----------|------|
| **DoD-1** | registrations.id 관련 400이 0건 | Supabase API Logs에서 `registrations.id`, `column registrations.id does not exist`, 400 검색 |
| **DoD-2** | duplicate key / registrations 409가 "폭발"하지 않음 | Postgres Logs에서 409, duplicate key, registrations 검색 |
| **DoD-3** | `/auth/v1/user` 비정상 증가 없음 | Auth Logs 확인 |
| **DoD-4** | 기능 회귀 없음 | 등록자·관리자·비등록자(자동등록) 플로우 테스트 |

**롤백 트리거**: DoD-1 실패(400 재발), DoD-2 실패(409 폭발+DB 부하), 기능 회귀로 운영 불가 시 즉시 롤백. (문서 기준 롤백 미실행.)

### 4.4 이미 적용된 성능·안정성 조치(참고)

**성능 최적화 조치 보고서** 및 관련 이슈에서 정리·적용된 사항:

- **N+1 개선**: 대시보드 접속자 목록을 개별 프로필 호출 대신 **배치 API**(`/api/profiles/batch`)로 일괄 조회. (265명 기준 26.5초+ → 200ms 이내 수준.)
- **RLS 정책**: `auth.uid()` → `(select auth.uid())` 등 쿼리당 1회 평가로 변경(마이그레이션 098, 099).
- **인덱스**: `webinar_live_presence`, `webinar_user_sessions` 등 외래 키·조회 패턴에 맞는 인덱스 추가(마이그레이션 100 등).
- **하트비트**: 120초 ± 지터 유지, 문서화 및 throttle 등 정리.

### 4.5 계획된 후속(P1·P2)

- **P1**: 관리자 `/stats/access` 폴링 주기 완화(5초 → 10초 등), Realtime 폴백 폴링에 서킷 브레이커(4xx 즉시 중단, 5xx 백오프), 참가자 핫패스의 Vercel 서버리스 제거·Supabase RPC 직행 검토 등.
- **P2**: RLS·인덱스 측정 기반 추가 최적화, 부하 테스트·격리 시나리오 정비.

---

## 5. 결론 및 정리

| 구분 | 내용 |
|------|------|
| **원인** | (1) 존재하지 않는 `registrations.id` 참조 → 400 폭발 → 에러인데도 자동 등록 시도 → 409·추가 부하. (2) presence/access 핫패스에 인증·등록 확인/생성·다중 테이블 조회가 겹쳐 동시 접속 시 DB/Auth 과부하. |
| **당시 복구** | Supabase 한도 상향 + 컴퓨트 사양 상향 + 모니터링 강화로 당일 서비스 복구. |
| **후속 조치** | (1) 코드 기반 원인 분석 및 P0 수정(registrations.id 제거, 핫패스 경량화, 409 멱등 처리) 배포. (2) 배포 후 DoD(400/409/Auth/기능 회귀) 모니터링 및 테스트. (3) N+1·RLS·인덱스·하트비트 등 기존 최적화와 연계. |

이 문서는 **2월 6일 장애가 무엇 때문에 발생했는지**, **당일 어떤 라이브 조치로 복구했는지**, **이후 어떤 테스트와 점검을 통해 코드·운영 측 조치를 완료했는지**를 한 번에 보기 위한 종합 보고서이다.

---

**참고 문서**

- `docs/2026-02-06_장애_원인_코드_기반_진단_보고서.md`
- `docs/2026-02-06_서버장애_분석보고서.md`
- `docs/서버_부하_로그_분석_2026-02-06.md`
- `docs/검토의견피드백.md`, `docs/최적화검토_피드백반영요약.md`
- `DEPLOYMENT_RESULTS.md`
- `docs/성능_최적화_조치_보고서.md`
