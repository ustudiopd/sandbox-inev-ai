# ì„¤ë¬¸/í€´ì¦ˆ/ì¶”ì²¨ ì‹œìŠ¤í…œ ì•ˆì •ì„± ê²€í†  ë³´ê³ ì„œ

**ì‘ì„±ì¼**: 2026-02-08  
**ê²€í†  ê¸°ì¤€**: ë¼ì´ë¸Œ ì•ˆì •ì„±/ì •í•©ì„±/ê³µì •ì„±/í™•ì¥ì„±  
**ìš°ì„ ìˆœìœ„**: P0 (í•„ìˆ˜ ìˆ˜ì •) / P1 (ê¶Œì¥ ê°œì„ ) / P2 (ì„ íƒ ê°œì„ )

---

## ğŸ“‹ ì‹¤í–‰ ìš”ì•½

ì „ì²´ ì„¤ê³„ ë°©í–¥ì€ **ìš´ì˜ ê°€ëŠ¥í•œ ìˆ˜ì¤€**ì´ë©°, íŠ¹íˆ ì„¤ë¬¸/í€´ì¦ˆ í†µí•© êµ¬ì¡°ì™€ commit-reveal ì¶”ì²¨ ë°©ì‹ì€ ê³µê³µ/ê¸°ì—… í–‰ì‚¬ ìš´ì˜ì— ì í•©í•©ë‹ˆë‹¤. ë‹¤ë§Œ **P0ê¸‰ ì´ìŠˆ 3ê±´**ì´ ë°œê²¬ë˜ì–´ ì¦‰ì‹œ ìˆ˜ì •ì´ í•„ìš”í•©ë‹ˆë‹¤.

### ë°œê²¬ëœ ì´ìŠˆ ìš”ì•½

| ìš°ì„ ìˆœìœ„ | ì´ìŠˆ | ìƒíƒœ | ì˜í–¥ë„ |
|---------|------|------|--------|
| **P0** | ì„¤ë¬¸ 1íšŒ ì œì¶œ ì œí•œì˜ ë™ì‹œì„± ì·¨ì•½ì  | ğŸ”´ **ìœ„í—˜** | ì¤‘ë³µ ì œì¶œ ê°€ëŠ¥ |
| **P0** | í€´ì¦ˆ ì •ë‹µ ë…¸ì¶œ (ì œì¶œ í›„) | ğŸ”´ **ìœ„í—˜** | ë³´ì•ˆ ì·¨ì•½ì  |
| **P0** | ì¶”ì²¨ commit-reveal ê²€ì¦ ëˆ„ë½ | ğŸ”´ **ìœ„í—˜** | ê³µì •ì„± í›¼ì† ê°€ëŠ¥ |
| P1 | í€´ì¦ˆ max_attempts ê²½ìŸ ìƒíƒœ | ğŸŸ¡ **ì£¼ì˜** | ì‹œë„ íšŸìˆ˜ ì´ˆê³¼ ê°€ëŠ¥ |
| P1 | ì¶”ì²¨ ì¬ì¶”ì²¨ ë°©ì§€ ë¯¸í¡ | ğŸŸ¡ **ì£¼ì˜** | ê°ì‚¬ ì¶”ì  ì–´ë ¤ì›€ |

---

## 1. ì„¤ë¬¸(Survey) - 1íšŒ ì œì¶œ ì œí•œ ë™ì‹œì„± ë¬¸ì œ

### ğŸ”´ P0: í˜„ì¬ ìƒíƒœ

**ë¬¸ì œì **:
- `check_survey_submission_once` íŠ¸ë¦¬ê±°ë§Œ ì¡´ì¬, **UNIQUE ì¸ë±ìŠ¤ ì—†ìŒ**
- íŠ¸ë¦¬ê±°ëŠ” BEFORE INSERTì—ì„œ ì‹¤í–‰ë˜ì§€ë§Œ, íŠ¸ëœì­ì…˜ ê²©ë¦¬ ìˆ˜ì¤€ì— ë”°ë¼ ë™ì‹œ ì œì¶œì´ ê°€ëŠ¥í•  ìˆ˜ ìˆìŒ
- ë‘ ê°œì˜ íƒ­ì—ì„œ ë™ì‹œì— ì œì¶œí•˜ë©´ ë‘˜ ë‹¤ ì„±ê³µí•  ìˆ˜ ìˆìŒ

**í˜„ì¬ ì½”ë“œ** (`supabase/migrations/015_create_forms_system.sql`):
```sql
-- íŠ¸ë¦¬ê±°ë§Œ ìˆê³  UNIQUE ì¸ë±ìŠ¤ ì—†ìŒ
create trigger tg_check_survey_submission_once
  before insert on public.form_submissions
  for each row execute function public.check_survey_submission_once();
```

**ì·¨ì•½ ì‹œë‚˜ë¦¬ì˜¤**:
1. ì‚¬ìš©ìê°€ ë‘ ê°œì˜ ë¸Œë¼ìš°ì € íƒ­ì—ì„œ ë™ì‹œì— ì œì¶œ ë²„íŠ¼ í´ë¦­
2. ë‘ ìš”ì²­ì´ ê±°ì˜ ë™ì‹œì— `form_submissions` INSERT ì‹œë„
3. íŠ¸ë¦¬ê±°ê°€ ê°ê° ì‹¤í–‰ë˜ì§€ë§Œ, ì²« ë²ˆì§¸ INSERTê°€ ì™„ë£Œë˜ê¸° ì „ì— ë‘ ë²ˆì§¸ê°€ ì²´í¬í•˜ë©´ ë‘˜ ë‹¤ í†µê³¼ ê°€ëŠ¥
4. ê²°ê³¼: ì¤‘ë³µ ì œì¶œ ë°œìƒ

### âœ… í•´ê²° ë°©ì•ˆ

**ë°©ë²• 1: UNIQUE ì¸ë±ìŠ¤ ì¶”ê°€ (ê¶Œì¥)**
```sql
-- ì„¤ë¬¸ì€ (form_id, participant_id) ì¡°í•©ì´ ìœ ë‹ˆí¬í•´ì•¼ í•¨
CREATE UNIQUE INDEX IF NOT EXISTS uniq_survey_submission_once
ON public.form_submissions(form_id, participant_id)
WHERE EXISTS (
  SELECT 1 FROM public.forms f 
  WHERE f.id = form_submissions.form_id 
  AND f.kind = 'survey'
);
```

**ë°©ë²• 2: íŠ¸ë¦¬ê±° + SELECT FOR UPDATE (ëŒ€ì•ˆ)**
```sql
-- íŠ¸ë¦¬ê±°ì—ì„œ FOR UPDATE ë½ ì‚¬ìš©
CREATE OR REPLACE FUNCTION public.check_survey_submission_once() 
RETURNS TRIGGER AS $$
DECLARE
  form_kind text;
BEGIN
  SELECT kind INTO form_kind 
  FROM public.forms 
  WHERE id = NEW.form_id 
  FOR UPDATE; -- ë½ ì¶”ê°€
  
  IF form_kind = 'survey' THEN
    IF EXISTS (
      SELECT 1 FROM public.form_submissions
      WHERE form_id = NEW.form_id 
      AND participant_id = NEW.participant_id
    ) THEN
      RAISE EXCEPTION 'Survey can only be submitted once';
    END IF;
  END IF;
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;
```

**ê¶Œì¥**: ë°©ë²• 1 (UNIQUE ì¸ë±ìŠ¤)ì´ ê°€ì¥ ì•ˆì „í•˜ê³  ì„±ëŠ¥ë„ ì¢‹ìŠµë‹ˆë‹¤.

### DoD (Definition of Done)

- [ ] ê°™ì€ ì‚¬ìš©ìê°€ 2ê°œ íƒ­ì—ì„œ ë™ì‹œì— ì œì¶œí•´ë„ ì œì¶œ 1ê±´ë§Œ ì €ì¥ë¨
- [ ] ë‚˜ë¨¸ì§€ ìš”ì²­ì€ ëª…í™•í•œ ì—ëŸ¬ ì‘ë‹µ (409 Conflict) ë°˜í™˜
- [ ] í…ŒìŠ¤íŠ¸: ë™ì‹œ ì œì¶œ ì‹œë‚˜ë¦¬ì˜¤ë¡œ ê²€ì¦ ì™„ë£Œ

---

## 2. í€´ì¦ˆ(Quiz) - ì •ë‹µ ë…¸ì¶œ ë¬¸ì œ

### ğŸ”´ P0: í˜„ì¬ ìƒíƒœ

**ë¬¸ì œì **:
- í€´ì¦ˆ ì œì¶œ í›„ **ì •ë‹µ(`answer_key`)ì´ í´ë¼ì´ì–¸íŠ¸ì— ë°˜í™˜ë¨**
- ì œì¶œí•˜ì§€ ì•Šì€ ê²½ìš°ì—ë§Œ ì •ë‹µì„ ìˆ¨ê¸°ì§€ë§Œ, ì œì¶œ í›„ì—ëŠ” ì •ë‹µì´ ë…¸ì¶œë¨

**ì·¨ì•½ ì½”ë“œ ìœ„ì¹˜**:

1. **ì œì¶œ API** (`app/api/webinars/[webinarId]/forms/[formId]/submit/route.ts:179`):
```typescript
questionResults.push({
  questionId: q.id,
  isCorrect,
  pointsAwarded: awarded,
  correctAnswer: q.answer_key, // âš ï¸ ì •ë‹µ ë…¸ì¶œ!
  userAnswer: ans ? { ... } : null,
})
```

2. **ì¡°íšŒ API** (`app/api/webinars/[webinarId]/forms/[formId]/route.ts:222`):
```typescript
questionResults.push({
  questionId: q.id,
  isCorrect: userAnswer?.is_correct ?? null,
  pointsAwarded: userAnswer?.points_awarded ?? 0,
  correctAnswer: q.answer_key, // âš ï¸ ì •ë‹µ ë…¸ì¶œ!
  userAnswer: userAnswer ? { ... } : null,
})
```

**í˜„ì¬ ë³´í˜¸ ë¡œì§** (`route.ts:232-236`):
```typescript
// ì •ë‹µí‚¤ ì œê±° (ê¶Œí•œì´ ì—†ê³  ì•„ì§ ì œì¶œí•˜ì§€ ì•Šì€ ê²½ìš°)
if (form.kind === 'quiz' && form.status !== 'closed' && !canViewAnswers && !isSubmitted) {
  questions?.forEach((q: any) => {
    delete q.answer_key
  })
}
```
â†’ ì œì¶œ **í›„**ì—ëŠ” ì •ë‹µì´ ë…¸ì¶œë¨!

### âœ… í•´ê²° ë°©ì•ˆ

**ì •ë‹µì€ ìš´ì˜ì/ê´€ë¦¬ìë§Œ ë³¼ ìˆ˜ ìˆê²Œ ìˆ˜ì •**:

1. **ì œì¶œ API ìˆ˜ì •** (`submit/route.ts`):
```typescript
questionResults.push({
  questionId: q.id,
  isCorrect,
  pointsAwarded: awarded,
  // correctAnswer ì œê±° (ìš´ì˜ìë§Œ ë³¼ ìˆ˜ ìˆìŒ)
  userAnswer: ans ? {
    choiceIds: ans.choice_ids,
    textAnswer: ans.text_answer,
  } : null,
})
```

2. **ì¡°íšŒ API ìˆ˜ì •** (`route.ts`):
```typescript
// ì œì¶œí•œ ê²½ìš°ì—ë„ ì •ë‹µì€ ìš´ì˜ìë§Œ ë³¼ ìˆ˜ ìˆìŒ
questionResults.push({
  questionId: q.id,
  isCorrect: userAnswer?.is_correct ?? null,
  pointsAwarded: userAnswer?.points_awarded ?? 0,
  // canViewAnswersê°€ trueì¼ ë•Œë§Œ ì •ë‹µ í¬í•¨
  ...(canViewAnswers ? { correctAnswer: q.answer_key } : {}),
  userAnswer: userAnswer ? { ... } : null,
})
```

3. **RLS ì •ì±… í™•ì¸**:
   - `form_questions` í…Œì´ë¸”ì˜ `answer_key` ì»¬ëŸ¼ì€ RLSë¡œ ë³´í˜¸ë˜ì§€ ì•ŠìŒ
   - API ë ˆë²¨ì—ì„œ í•„í„°ë§ í•„ìš” (í˜„ì¬ ë¶€ë¶„ì ìœ¼ë¡œë§Œ êµ¬í˜„ë¨)

### DoD

- [ ] ì°¸ê°€ì APIë¡œëŠ” ì •ë‹µ ë°ì´í„°ê°€ ì ˆëŒ€ ë…¸ì¶œë˜ì§€ ì•ŠìŒ
- [ ] ìš´ì˜ì/ê´€ë¦¬ìë§Œ ì •ë‹µì„ ë³¼ ìˆ˜ ìˆìŒ (ë³„ë„ ì—”ë“œí¬ì¸íŠ¸ ë˜ëŠ” ê¶Œí•œ ì²´í¬)
- [ ] í…ŒìŠ¤íŠ¸: ì œì¶œ í›„ ë„¤íŠ¸ì›Œí¬ íƒ­ì—ì„œ ì •ë‹µ í™•ì¸ ë¶ˆê°€

---

## 3. ê²½í’ˆ ì¶”ì²¨(Giveaway) - Commit-Reveal ê²€ì¦ ëˆ„ë½

### ğŸ”´ P0: í˜„ì¬ ìƒíƒœ

**ë¬¸ì œì **:
- `seed_commit`ì´ ìˆì–´ë„ **ê²€ì¦í•˜ì§€ ì•Šê³ ** ë§¤ë²ˆ ìƒˆë¡œìš´ `seed_reveal` ìƒì„±
- `drawn` ìƒíƒœì—ì„œ ì¬ì¶”ì²¨ ë°©ì§€ ë¡œì§ì´ ë¯¸í¡ (ìƒíƒœ ì²´í¬ë§Œ ìˆìŒ)
- commit-reveal íŒ¨í„´ì´ í˜•ì‹ì ìœ¼ë¡œë§Œ ì¡´ì¬í•˜ê³  ì‹¤ì œ ê³µì •ì„±ì„ ë³´ì¥í•˜ì§€ ì•ŠìŒ

**ì·¨ì•½ ì½”ë“œ** (`app/api/webinars/[webinarId]/giveaways/[giveawayId]/draw/route.ts`):

1. **seed_commit ê²€ì¦ ì—†ìŒ** (134-160ë²ˆ ë¼ì¸):
```typescript
// ëœë¤ ì¶”ì²¨ ë°©ì‹: ê¸°ì¡´ SQL í•¨ìˆ˜ ì‚¬ìš©
const autoSeed = `${giveawayId}-${Date.now()}-${Math.random().toString(36).substring(2, 15)}`
// âš ï¸ seed_commitê³¼ ë¬´ê´€í•˜ê²Œ ìƒˆ seed ìƒì„±!

const { data: drawnWinners, error: drawError } = await admin.rpc('draw_giveaway', {
  p_giveaway_id: giveawayId,
  p_seed: autoSeed, // âš ï¸ commitê³¼ ê²€ì¦ë˜ì§€ ì•Šì€ seed ì‚¬ìš©
})

// ...

// ëœë¤ ì¶”ì²¨ ë°©ì‹ì¼ ë•Œë§Œ seed_reveal ì„¤ì •
if (!isManualDraw) {
  const autoSeed = `${giveawayId}-${Date.now()}-${Math.random().toString(36).substring(2, 15)}`
  updateData.seed_reveal = autoSeed // âš ï¸ commitê³¼ ë¬´ê´€í•œ seed ì €ì¥
}
```

2. **ì¬ì¶”ì²¨ ë°©ì§€ ë¯¸í¡** (37-42ë²ˆ ë¼ì¸):
```typescript
if (giveaway.status !== 'open' && giveaway.status !== 'closed') {
  return NextResponse.json(
    { error: 'Giveaway must be open or closed to draw' },
    { status: 400 }
  )
}
// âš ï¸ drawn ìƒíƒœì—ì„œë„ ì¬ì¶”ì²¨ ê°€ëŠ¥ (ì¡°ê±´ì— drawnì´ ì—†ìŒ)
```

3. **commit APIëŠ” ì¡´ì¬í•˜ì§€ë§Œ ì‚¬ìš©ë˜ì§€ ì•ŠìŒ**:
   - `verify_seed_commit` í•¨ìˆ˜ëŠ” ìˆì§€ë§Œ (`017_create_giveaways.sql:121`)
   - draw APIì—ì„œ í˜¸ì¶œí•˜ì§€ ì•ŠìŒ

### âœ… í•´ê²° ë°©ì•ˆ

**1. seed_commit ê²€ì¦ ë¡œì§ ì¶”ê°€**:

```typescript
// draw API ìˆ˜ì •
if (!isManualDraw) {
  // seed_commitì´ ìˆìœ¼ë©´ ë°˜ë“œì‹œ seed_revealì„ ë°›ì•„ì„œ ê²€ì¦
  if (giveaway.seed_commit) {
    const { seedReveal } = await req.json().catch(() => ({}))
    
    if (!seedReveal) {
      return NextResponse.json(
        { error: 'seed_reveal is required when seed_commit exists' },
        { status: 400 }
      )
    }
    
    // ê²€ì¦
    const { data: verifyResult } = await admin.rpc('verify_seed_commit', {
      seed_commit: giveaway.seed_commit,
      seed_reveal: seedReveal,
    })
    
    if (!verifyResult?.ok) {
      return NextResponse.json(
        { error: 'seed_reveal does not match seed_commit' },
        { status: 400 }
      )
    }
    
    // ê²€ì¦ëœ seed ì‚¬ìš©
    const { data: drawnWinners, error: drawError } = await admin.rpc('draw_giveaway', {
      p_giveaway_id: giveawayId,
      p_seed: seedReveal, // ê²€ì¦ëœ seed ì‚¬ìš©
    })
    
    updateData.seed_reveal = seedReveal
  } else {
    // seed_commitì´ ì—†ìœ¼ë©´ ìë™ ìƒì„± (ê¸°ì¡´ ë¡œì§)
    const autoSeed = `${giveawayId}-${Date.now()}-${Math.random().toString(36).substring(2, 15)}`
    // ...
  }
}
```

**2. ì¬ì¶”ì²¨ ë°©ì§€ ê°•í™”**:

```typescript
// drawn ìƒíƒœì—ì„œëŠ” ì¬ì¶”ì²¨ ë¶ˆê°€
if (giveaway.status === 'drawn') {
  return NextResponse.json(
    { error: 'Giveaway has already been drawn. Re-draw is not allowed.' },
    { status: 400 }
  )
}

// ë˜ëŠ” ì¬ì¶”ì²¨ì„ í—ˆìš©í•˜ë˜ ê°ì‚¬ ë¡œê·¸ ê°•ì œ
if (giveaway.status === 'drawn') {
  // ê°ì‚¬ ë¡œê·¸ì— ì¬ì¶”ì²¨ ì‚¬ìœ  í•„ìˆ˜
  const { reason } = await req.json()
  if (!reason || reason.trim().length < 10) {
    return NextResponse.json(
      { error: 'Re-draw reason is required (min 10 characters)' },
      { status: 400 }
    )
  }
  
  // ê°ì‚¬ ë¡œê·¸ì— ì¬ì¶”ì²¨ ê¸°ë¡
  await admin.from('audit_logs').insert({
    actor_user_id: user.id,
    action: 'GIVEAWAY_RE_DRAW',
    payload: { 
      giveaway_id: giveawayId,
      reason,
      previous_winners: /* ì´ì „ ë‹¹ì²¨ì ì •ë³´ */,
    },
  })
}
```

**3. DB ë ˆë²¨ ì œì•½ ì¶”ê°€** (ì„ íƒ):

```sql
-- drawn ìƒíƒœì—ì„œ ì¬ì¶”ì²¨ ë°©ì§€ (ì• í”Œë¦¬ì¼€ì´ì…˜ ë ˆë²¨ + DB ë ˆë²¨)
CREATE OR REPLACE FUNCTION check_giveaway_draw_once()
RETURNS TRIGGER AS $$
BEGIN
  IF OLD.status = 'drawn' AND NEW.status = 'drawn' THEN
    RAISE EXCEPTION 'Giveaway has already been drawn';
  END IF;
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER tg_check_giveaway_draw_once
BEFORE UPDATE ON public.giveaways
FOR EACH ROW
WHEN (OLD.status = 'drawn')
EXECUTE FUNCTION check_giveaway_draw_once();
```

### DoD

- [ ] `seed_commit`ì´ ìˆìœ¼ë©´ ë°˜ë“œì‹œ `seed_reveal` ê²€ì¦ í†µê³¼ í›„ ì¶”ì²¨ ì‹¤í–‰
- [ ] `drawn` ì´í›„ ì¬ì¶”ì²¨ì´ ì •ì±…ì ìœ¼ë¡œ í†µì œë¨ (ê°ì‚¬ ë¡œê·¸ í¬í•¨)
- [ ] í…ŒìŠ¤íŠ¸: commit-reveal ê²€ì¦ ì‹¤íŒ¨ ì‹œ ì¶”ì²¨ ë¶ˆê°€ í™•ì¸

---

## 4. í€´ì¦ˆ(Quiz) - max_attempts ê²½ìŸ ìƒíƒœ

### ğŸŸ¡ P1: í˜„ì¬ ìƒíƒœ

**ë¬¸ì œì **:
- `attempt_no` ê³„ì‚°ì´ SELECT í›„ INSERT ì‚¬ì´ì— ìˆì–´ ê²½ìŸ ìƒíƒœ ê°€ëŠ¥
- ë‘ íƒ­ì—ì„œ ë™ì‹œì— ì œì¶œí•˜ë©´ `attempt_no`ê°€ ì¤‘ë³µë˜ê±°ë‚˜ ì´ˆê³¼ ê°€ëŠ¥

**ì·¨ì•½ ì½”ë“œ** (`app/api/webinars/[webinarId]/forms/[formId]/submit/route.ts:67-94`):
```typescript
// ì‹œë„ íšŸìˆ˜ í™•ì¸
const { data: prevAttempts } = await supabase
  .from('quiz_attempts')
  .select('attempt_no')
  .eq('form_id', formId)
  .eq('participant_id', user.id)

const nextAttempt = (prevAttempts?.length || 0) + 1 // âš ï¸ ê²½ìŸ ìƒíƒœ!

if (form.max_attempts && nextAttempt > form.max_attempts) {
  return NextResponse.json(
    { error: 'Max attempts reached' },
    { status: 403 }
  )
}

// í€´ì¦ˆ ì‹œë„ ìƒì„±
const { data: attempt, error: attemptError } = await admin
  .from('quiz_attempts')
  .insert({
    form_id: formId,
    participant_id: user.id,
    attempt_no: nextAttempt, // âš ï¸ ë™ì‹œ ì œì¶œ ì‹œ ì¤‘ë³µ ê°€ëŠ¥
  })
```

**UNIQUE ì¸ë±ìŠ¤ëŠ” ìˆì§€ë§Œ** (`015_create_forms_system.sql:96`):
```sql
create unique index uniq_attempt_once
  on public.quiz_attempts(form_id, participant_id, attempt_no);
```
â†’ `attempt_no` ê³„ì‚°ì´ ì›ìì ì´ì§€ ì•Šì•„ì„œ ë¬¸ì œ ë°œìƒ ê°€ëŠ¥

### âœ… í•´ê²° ë°©ì•ˆ

**ë°©ë²• 1: DB í•¨ìˆ˜ë¡œ ì›ìì  ì²˜ë¦¬ (ê¶Œì¥)**:
```sql
CREATE OR REPLACE FUNCTION get_next_attempt_no(
  p_form_id uuid,
  p_participant_id uuid,
  p_max_attempts int
) RETURNS int AS $$
DECLARE
  next_no int;
BEGIN
  -- FOR UPDATEë¡œ ë½
  SELECT COALESCE(MAX(attempt_no), 0) + 1 INTO next_no
  FROM public.quiz_attempts
  WHERE form_id = p_form_id 
    AND participant_id = p_participant_id
  FOR UPDATE;
  
  IF p_max_attempts IS NOT NULL AND next_no > p_max_attempts THEN
    RAISE EXCEPTION 'Max attempts reached';
  END IF;
  
  RETURN next_no;
END;
$$ LANGUAGE plpgsql;
```

**ë°©ë²• 2: íŠ¸ëœì­ì…˜ + SELECT FOR UPDATE**:
```typescript
// íŠ¸ëœì­ì…˜ ë‚´ì—ì„œ ì›ìì  ì²˜ë¦¬
await admin.rpc('begin_transaction') // ê°€ìƒì˜ ì˜ˆì‹œ

const { data: lockedAttempts } = await admin
  .from('quiz_attempts')
  .select('attempt_no')
  .eq('form_id', formId)
  .eq('participant_id', user.id)
  .order('attempt_no', { ascending: false })
  .limit(1)
  .single()
  // FOR UPDATEëŠ” Supabase JSì—ì„œ ì§ì ‘ ì§€ì›í•˜ì§€ ì•Šìœ¼ë¯€ë¡œ
  // RPC í•¨ìˆ˜ ì‚¬ìš© í•„ìš”

const nextAttempt = (lockedAttempts?.attempt_no || 0) + 1
// ...
```

### DoD

- [ ] ë™ì‹œ ì œì¶œì—ë„ `max_attempts`ê°€ í™•ì‹¤íˆ ì§€ì¼œì§
- [ ] `attempt_no` ì¤‘ë³µì´ ë°œìƒí•˜ì§€ ì•ŠìŒ
- [ ] í…ŒìŠ¤íŠ¸: ë™ì‹œ ì œì¶œ ì‹œë‚˜ë¦¬ì˜¤ë¡œ ê²€ì¦ ì™„ë£Œ

---

## 5. ê²½í’ˆ ì¶”ì²¨(Giveaway) - ì¬ì¶”ì²¨ ë°©ì§€ ë¯¸í¡

### ğŸŸ¡ P1: í˜„ì¬ ìƒíƒœ

**ë¬¸ì œì **:
- `drawn` ìƒíƒœì—ì„œë„ ì¬ì¶”ì²¨ ê°€ëŠ¥ (ì¡°ê±´ ì²´í¬ ë¯¸í¡)
- ì¬ì¶”ì²¨ ì‹œ ê°ì‚¬ ë¡œê·¸ê°€ ìˆì§€ë§Œ, ì´ì „ ë‹¹ì²¨ì ì •ë³´ê°€ ë³´ì¡´ë˜ì§€ ì•ŠìŒ

**í˜„ì¬ ì½”ë“œ** (`draw/route.ts:37-42`):
```typescript
if (giveaway.status !== 'open' && giveaway.status !== 'closed') {
  return NextResponse.json(
    { error: 'Giveaway must be open or closed to draw' },
    { status: 400 }
  )
}
// âš ï¸ drawn ìƒíƒœëŠ” ì²´í¬í•˜ì§€ ì•ŠìŒ!
```

### âœ… í•´ê²° ë°©ì•ˆ

**1. ìƒíƒœ ì²´í¬ ê°•í™”**:
```typescript
if (giveaway.status === 'drawn') {
  return NextResponse.json(
    { error: 'Giveaway has already been drawn. Re-draw is not allowed.' },
    { status: 400 }
  )
}
```

**2. ì¬ì¶”ì²¨ í—ˆìš© ì‹œ ê°ì‚¬ ë¡œê·¸ ê°•í™”**:
```typescript
if (giveaway.status === 'drawn') {
  // ì´ì „ ë‹¹ì²¨ì ì •ë³´ ì¡°íšŒ
  const { data: previousWinners } = await admin
    .from('giveaway_winners')
    .select('participant_id, rank, proof_json')
    .eq('giveaway_id', giveawayId)
    .order('rank', { ascending: true })
  
  // ì¬ì¶”ì²¨ ì‚¬ìœ  í•„ìˆ˜
  const { reason } = await req.json()
  if (!reason || reason.trim().length < 10) {
    return NextResponse.json(
      { error: 'Re-draw reason is required (min 10 characters)' },
      { status: 400 }
    )
  }
  
  // ê°ì‚¬ ë¡œê·¸ì— ì´ì „ ë‹¹ì²¨ì ì •ë³´ í¬í•¨
  await admin.from('audit_logs').insert({
    actor_user_id: user.id,
    action: 'GIVEAWAY_RE_DRAW',
    payload: {
      giveaway_id: giveawayId,
      reason,
      previous_winners: previousWinners,
      previous_drawn_at: giveaway.drawn_at,
    },
  })
}
```

---

## ğŸ“Š ì¢…í•© í‰ê°€

### ê°•ì  âœ…

1. **ì„¤ê³„ ë°©í–¥**: ì„¤ë¬¸/í€´ì¦ˆ í†µí•©, commit-reveal ì¶”ì²¨ êµ¬ì¡°ëŠ” ìš´ì˜ ê°€ëŠ¥í•œ ìˆ˜ì¤€
2. **ë°ì´í„° ì •ê·œí™”**: `form_submissions`, `form_answers`, `quiz_attempts` ë¶„ë¦¬ê°€ ì ì ˆ
3. **RLS ì •ì±…**: ê¸°ë³¸ì ì¸ ê¶Œí•œ ê´€ë¦¬ê°€ êµ¬í˜„ë¨
4. **ê°ì‚¬ ë¡œê·¸**: ì£¼ìš” ì‘ì—…ì— ê°ì‚¬ ë¡œê·¸ ê¸°ë¡

### ê°œì„  í•„ìš” ğŸ”´

1. **ë™ì‹œì„± ì²˜ë¦¬**: ì„¤ë¬¸/í€´ì¦ˆ ì œì¶œ, ì¶”ì²¨ ì‹¤í–‰ ì‹œ ì›ìì„± ë³´ì¥ í•„ìš”
2. **ë³´ì•ˆ**: í€´ì¦ˆ ì •ë‹µ ë…¸ì¶œ ë°©ì§€ í•„ìš”
3. **ê³µì •ì„±**: commit-reveal ê²€ì¦ ë¡œì§ êµ¬í˜„ í•„ìš”

---

## ğŸ¯ ìˆ˜ì • ìš°ì„ ìˆœìœ„

### ì¦‰ì‹œ ìˆ˜ì • (P0)

1. âœ… **ì„¤ë¬¸ 1íšŒ ì œì¶œ UNIQUE ì¸ë±ìŠ¤ ì¶”ê°€**
2. âœ… **í€´ì¦ˆ ì •ë‹µ ë…¸ì¶œ ë°©ì§€ (ì œì¶œ í›„ì—ë„)**
3. âœ… **ì¶”ì²¨ commit-reveal ê²€ì¦ ë¡œì§ êµ¬í˜„**

### ê¶Œì¥ ê°œì„  (P1)

4. âœ… **í€´ì¦ˆ max_attempts ì›ìì  ì²˜ë¦¬**
5. âœ… **ì¶”ì²¨ ì¬ì¶”ì²¨ ë°©ì§€ ê°•í™”**

### ì„ íƒ ê°œì„  (P2)

6. âšª **ì„¤ë¬¸ ì œì¶œ ê¸°ì¤€ ëª…í™•í™”** (user_id vs email/phone)
7. âšª **ê°€ì¤‘ì¹˜(weight) ì‚¬ìš© ì‹œ ì•Œê³ ë¦¬ì¦˜ ì¬ì •ì˜**
8. âšª **Realtime ëŒ€ì‹  Broadcast ì´ë²¤íŠ¸ ì‚¬ìš©** (ì„±ëŠ¥ ìµœì í™”)

---

## ğŸ“ ë‹¤ìŒ ë‹¨ê³„

1. **P0 ì´ìŠˆ ìˆ˜ì •** (ì˜ˆìƒ ì†Œìš”: 2-3ì‹œê°„)
   - UNIQUE ì¸ë±ìŠ¤ ì¶”ê°€ ë§ˆì´ê·¸ë ˆì´ì…˜
   - API ì½”ë“œ ìˆ˜ì • (ì •ë‹µ ë…¸ì¶œ ë°©ì§€, commit ê²€ì¦)
   - í…ŒìŠ¤íŠ¸ ì¼€ì´ìŠ¤ ì‘ì„±

2. **P1 ì´ìŠˆ ìˆ˜ì •** (ì˜ˆìƒ ì†Œìš”: 1-2ì‹œê°„)
   - attempt_no ì›ìì  ì²˜ë¦¬
   - ì¬ì¶”ì²¨ ë°©ì§€ ë¡œì§ ê°•í™”

3. **íšŒê·€ í…ŒìŠ¤íŠ¸** (ì˜ˆìƒ ì†Œìš”: 1ì‹œê°„)
   - ê¸°ì¡´ ê¸°ëŠ¥ ë™ì‘ í™•ì¸
   - ë™ì‹œì„± í…ŒìŠ¤íŠ¸

---

**ì‘ì„±ì**: Cursor AI Agent  
**ê²€í†  ì™„ë£Œ**: 2026-02-08
