# 마케팅 통계 집계 시스템 분석 보고서

**작성일**: 2026-02-05  
**분석 대상**: UTM 추적 및 통계 집계 시스템  
**문제점**: 전체 통계와 링크별 통계 불일치, 숫자 불일치

---

## 1. 시스템 아키텍처 개요

### 1.1 데이터 흐름

```
사용자 접속
  ↓
event_access_logs (Visits 기록)
  ↓
사용자 등록/전환
  ↓
event_survey_entries (Conversions 기록)
  ↓
크론 작업 (aggregate-marketing-stats)
  ↓
marketing_stats_daily (집계 테이블)
  ↓
API 조회 (summary/links)
  ↓
프론트엔드 표시
```

### 1.2 주요 테이블

1. **`event_access_logs`**: 방문 로그
   - `campaign_id`: 캠페인 ID
   - `marketing_campaign_link_id`: 링크 ID (nullable)
   - `utm_source`, `utm_medium`, `utm_campaign`: UTM 파라미터 (nullable)
   - `session_id`: 세션 ID (고유 방문 추적)

2. **`event_survey_entries`**: 전환 데이터
   - `campaign_id`: 캠페인 ID
   - `marketing_campaign_link_id`: 링크 ID (nullable)
   - `utm_source`, `utm_medium`, `utm_campaign`: UTM 파라미터 (nullable)
   - `created_at`: 전환 시각

3. **`campaign_link_meta`**: 링크 메타데이터
   - `id`: 링크 ID (marketing_campaign_link_id로 사용)
   - `utm_source`, `utm_medium`, `utm_campaign`: 링크의 기본 UTM 파라미터
   - `name`: 링크 이름

4. **`marketing_stats_daily`**: 일별 집계 테이블
   - `client_id`, `bucket_date`, `campaign_id`: 필수 차원
   - `marketing_campaign_link_id`, `utm_source`, `utm_medium`, `utm_campaign`: 선택 차원
   - `visits`: 방문 수 (COUNT DISTINCT session_id)
   - `conversions`: 전환 수 (COUNT entry_id)
   - `cvr`: 전환율 (자동 계산)

---

## 2. 집계 프로세스 상세 분석

### 2.1 크론 작업: `aggregate-marketing-stats`

**목적**: Raw 데이터를 일별 집계 테이블로 집계

**집계 키 구성**:
```
key = [
  client_id,
  bucket_date (YYYY-MM-DD),
  campaign_id,
  marketing_campaign_link_id || '',
  utm_source || '__null__',
  utm_medium || '__null__',
  utm_campaign || '__null__'
].join('|')
```

**Visits 집계**:
- `event_access_logs`에서 `session_id`를 Set으로 관리
- 같은 키를 가진 방문은 중복 제거
- `visits = Set.size`

**Conversions 집계**:
- `event_survey_entries`에서 각 전환을 카운트
- `conversions = count`

**문제점**:
- UTM이 없으면 `__null__`로 저장됨
- 링크 메타데이터의 UTM 정보를 사용하지 않음
- 같은 UTM 조합을 가진 여러 링크가 분리되어 집계됨

---

### 2.2 전체 통계 API: `/api/clients/[clientId]/campaigns/summary`

#### 2.2.1 데이터 소스 선택 로직

```
1. marketing_stats_daily에서 데이터 조회
   ↓
2. Raw 데이터와 비교
   - 집계 테이블 전환수 < Raw 데이터 전환수 * 0.95
     → Raw 데이터 사용 (Fallback)
   - 어제 10시 이전 데이터 보정 확인
     → 보정 안 됨 → Raw 데이터 사용
   ↓
3. getSummaryFromAggregated() 또는 getSummaryFromRaw() 호출
```

#### 2.2.2 `getSummaryFromAggregated()` 함수

**전체 전환 수**:
- `rawTotalConversions` 사용 (Raw 데이터에서 가져온 값)
- 집계 테이블의 전환 수는 사용하지 않음

**전체 Visits**:
- 집계 테이블에서 합산: `stats.reduce((sum, s) => sum + (s.visits || 0), 0)`
- Raw 데이터로 보완 시도 (더 크면 사용)

**Source별 집계**:
1. 집계 테이블에서 `utm_source` 기준으로 합산
2. 링크 메타데이터에서 UTM 복원 (UTM이 없고 링크가 있으면)
3. Raw 데이터에서 집계 테이블에 없는 조합만 추가

**조합별 집계**:
1. 집계 테이블에서 조합별로 합산
2. Raw 데이터에서 집계 테이블에 없는 조합만 추가 (중복 방지)

**링크별 집계**:
- **Raw 데이터를 기준으로 완전히 재집계**
- 집계 테이블 무시
- `event_survey_entries`와 `event_access_logs`에서 직접 집계

**문제점**:
- 전체 전환 수는 Raw 데이터 사용
- 전체 Visits는 집계 테이블 사용
- 링크별 집계는 Raw 데이터 사용
- → **데이터 소스가 일관되지 않음**

---

### 2.3 링크별 통계 API: `/api/clients/[clientId]/campaigns/links`

**집계 방식**:
1. 집계 테이블에서 링크 ID로 직접 매칭
2. 집계 테이블에서 `marketing_campaign_link_id = null`인 데이터를 UTM으로 매칭
3. 집계 테이블에 없으면 Raw 데이터에서 집계

**문제점**:
- 집계 테이블의 데이터가 부정확할 수 있음
- UTM으로 매칭하는 과정에서 중복 집계 가능성

---

## 3. 발견된 문제점

### 3.1 전체 통계와 링크별 통계 불일치

**원인**:
- 전체 통계: 집계 테이블 + Raw 데이터 보완
- 링크별 통계: Raw 데이터만 사용
- **데이터 소스가 다름**

**예시**:
- 전체 통계: 총 Visits 907, 총 전환 446
- 링크별 통계: 총 Visits 636, 총 전환 562
- 불일치 발생

### 3.2 링크별 통계의 숫자 오류

**문제**:
- "개인화메일": Visits 336, 전환 489 (CVR 145.5%)
- 전환이 Visits보다 많음 (논리적으로 불가능)

**원인 분석**:
1. 링크별 집계에서 Raw 데이터를 사용
2. `event_survey_entries`에서 `marketing_campaign_link_id`로 집계
3. `event_access_logs`에서 `marketing_campaign_link_id`로 집계
4. **하지만 두 테이블의 데이터가 일치하지 않을 수 있음**

**가능한 원인**:
- `event_access_logs`에 `marketing_campaign_link_id`가 저장되지 않은 방문이 많음
- `event_survey_entries`에는 링크 ID가 있지만, `event_access_logs`에는 없음
- → Visits는 적게 집계되고, Conversions는 많이 집계됨

### 3.3 UTM 복원 로직의 문제

**현재 로직**:
- 집계 테이블에서 UTM이 없으면 링크 메타데이터에서 복원
- 하지만 집계 테이블에 이미 `__null__`로 저장된 데이터는 복원되지 않음

**문제**:
- 집계 테이블에 저장된 시점에는 UTM이 없었음
- 나중에 링크 메타데이터를 확인해도 집계 테이블의 데이터는 변경되지 않음

### 3.4 "Direct (no tracking)" 분류 문제

**현재 로직**:
- `marketing_campaign_link_id`가 없고 UTM도 없으면 "Direct (no tracking)"

**문제**:
- 링크를 통해 들어왔지만 `marketing_campaign_link_id`가 저장되지 않은 경우
- 링크 메타데이터에 UTM이 있어도 "Direct (no tracking)"으로 분류됨

---

## 4. 데이터 불일치 원인 분석

### 4.1 Visits와 Conversions 불일치

**시나리오 1: 링크 ID 저장 누락**
```
사용자가 링크를 통해 접속
  → event_access_logs에 marketing_campaign_link_id가 저장되지 않음
  → Visits 집계에서 제외됨
  → 하지만 등록 시 marketing_campaign_link_id가 저장됨
  → Conversions 집계에 포함됨
  → 결과: Visits < Conversions
```

**시나리오 2: UTM 파라미터 유실**
```
사용자가 링크를 통해 접속 (UTM 포함)
  → 리다이렉트 과정에서 UTM 파라미터 유실
  → event_access_logs에 UTM이 없음
  → 등록 시 UTM이 없음
  → 링크 메타데이터에서 복원 가능하지만, 집계 테이블에는 이미 저장됨
```

### 4.2 전체 통계와 링크별 통계 불일치

**원인**:
1. **전체 통계**:
   - Visits: 집계 테이블 합산 (907)
   - Conversions: Raw 데이터 (446)

2. **링크별 통계**:
   - Visits: Raw 데이터에서 링크별 집계 (636)
   - Conversions: Raw 데이터에서 링크별 집계 (562)

3. **불일치 발생**:
   - 전체 Visits (907) ≠ 링크별 Visits 합 (636)
   - 전체 Conversions (446) ≠ 링크별 Conversions 합 (562)

**가능한 원인**:
- 링크별 집계에서 `marketing_campaign_link_id`가 없는 항목 제외
- 전체 통계에는 UTM만 있는 항목 포함
- 날짜 범위 필터링 차이

---

## 5. 해결 방안 제안

### 5.1 즉시 수정 사항

#### 5.1.1 링크별 집계 개선

**현재 문제**:
- Raw 데이터에서 `marketing_campaign_link_id`로만 집계
- 링크가 없으면 집계에서 제외됨

**해결 방안**:
```typescript
// 링크별 집계 시
1. marketing_campaign_link_id로 직접 매칭
2. UTM으로 링크 메타데이터와 매칭 (링크 ID가 없어도)
3. 링크 메타데이터에서 UTM을 가져와서 매칭
```

#### 5.1.2 전체 통계와 링크별 통계 일관성 확보

**해결 방안**:
- 전체 통계도 Raw 데이터를 기준으로 재집계
- 집계 테이블은 참고용으로만 사용
- 또는 집계 테이블을 완전히 신뢰하고 Raw 데이터 보완 제거

#### 5.1.3 Visits 집계 개선

**현재 문제**:
- `event_access_logs`에서 `marketing_campaign_link_id`로만 집계
- 링크를 통해 들어왔지만 링크 ID가 저장되지 않은 방문 제외

**해결 방안**:
- UTM 파라미터로도 링크 매칭
- 링크 메타데이터의 UTM과 일치하면 해당 링크로 집계

### 5.2 장기 개선 사항

#### 5.2.1 집계 테이블 개선

**제안**:
- 집계 시 링크 메타데이터에서 UTM 복원
- `__null__` 대신 실제 UTM 값 저장

#### 5.2.2 데이터 저장 시점 개선

**제안**:
- `event_access_logs` 저장 시 링크 메타데이터에서 UTM 복원
- `event_survey_entries` 저장 시 링크 메타데이터에서 UTM 복원
- → Raw 데이터 자체가 정확해짐

---

## 6. 현재 코드의 집계 로직 상세

### 6.1 전체 통계 요약 (`getSummaryFromAggregated`)

```typescript
// 1. 전체 전환 수
totalConversions = rawTotalConversions (Raw 데이터)

// 2. 전체 Visits
totalVisits = stats.reduce(visits) (집계 테이블)
+ Raw 데이터로 보완 (더 크면)

// 3. Source별 집계
- 집계 테이블에서 utm_source 기준 합산
- 링크 메타데이터에서 UTM 복원
- Raw 데이터에서 집계 테이블에 없는 조합만 추가

// 4. 조합별 집계
- 집계 테이블에서 조합별 합산
- Raw 데이터에서 집계 테이블에 없는 조합만 추가

// 5. 링크별 집계
- Raw 데이터에서 완전히 재집계
- event_survey_entries에서 marketing_campaign_link_id로 집계
- event_access_logs에서 marketing_campaign_link_id로 집계
```

### 6.2 링크별 통계 (`/api/clients/[clientId]/campaigns/links`)

```typescript
// 1. 집계 테이블에서 링크 ID로 직접 매칭
linkStatsMap[linkId] = { visits, conversions }

// 2. 집계 테이블에서 marketing_campaign_link_id = null인 데이터
//    UTM으로 링크와 매칭
backfillStats → UTM 매칭 → linkStatsMap에 추가

// 3. 집계 테이블에 없으면 Raw 데이터에서 집계
- event_survey_entries에서 marketing_campaign_link_id로 집계
- event_access_logs에서 marketing_campaign_link_id로 집계
```

---

## 7. 문제 해결을 위한 수정 계획

### 7.1 단기 수정 (즉시 적용)

1. **링크별 집계에서 UTM 매칭 추가**
   - `marketing_campaign_link_id`가 없어도 UTM으로 링크 매칭
   - 링크 메타데이터의 UTM과 일치하면 해당 링크로 집계

2. **전체 통계와 링크별 통계 일관성 확보**
   - 둘 다 Raw 데이터를 기준으로 집계
   - 또는 둘 다 집계 테이블을 기준으로 집계

3. **Visits 집계 개선**
   - UTM 파라미터로도 링크 매칭
   - 링크 메타데이터의 UTM과 일치하면 해당 링크로 집계

### 7.2 중기 수정 (다음 배포)

1. **집계 테이블 개선**
   - 집계 시 링크 메타데이터에서 UTM 복원
   - `__null__` 대신 실제 UTM 값 저장

2. **데이터 저장 시점 개선**
   - `event_access_logs` 저장 시 링크 메타데이터에서 UTM 복원
   - `event_survey_entries` 저장 시 링크 메타데이터에서 UTM 복원

---

## 8. 결론

현재 시스템의 주요 문제점:

1. **데이터 소스 불일치**: 전체 통계는 집계 테이블 + Raw, 링크별 통계는 Raw만 사용
2. **링크 매칭 불완전**: `marketing_campaign_link_id`만으로 매칭하여 누락 발생
3. **UTM 복원 시점 문제**: 집계 테이블에 이미 저장된 후 복원 불가
4. **Visits 집계 누락**: 링크 ID가 저장되지 않은 방문 제외

**권장 사항**:
- 모든 통계를 Raw 데이터 기준으로 통일
- 링크 매칭 시 UTM 파라미터도 활용
- 데이터 저장 시점에 링크 메타데이터에서 UTM 복원
