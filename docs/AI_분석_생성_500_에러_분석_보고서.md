# AI 분석 생성 API 500 에러 분석 보고서

**작성일**: 2025-01-XX  
**에러 유형**: Internal Server Error (500)  
**에러 위치**: `/api/event-survey/campaigns/[campaignId]/analysis/generate`  
**클라이언트 에러**: `Error: AI 분석 생성에 실패했습니다`

---

## 📋 에러 현황

### 에러 메시지
```
:3000/api/event-survey/campaigns/e80d8760-787e-48e9-85d4-798c4d156a7a/analysis/generate:1
Failed to load resource: the server responded with a status of 500 (Internal Server Error)

보고서 생성 오류: Error: AI 분석 생성에 실패했습니다
    at handleGenerateReport (AnalysisReportSection.tsx:731:15)
```

### 발생 위치
- **API 라우트**: `app/api/event-survey/campaigns/[campaignId]/analysis/generate/route.ts`
- **클라이언트**: `app/(client)/client/[clientId]/surveys/[campaignId]/components/tabs/AnalysisReportSection.tsx`
- **핵심 함수**: `generateActionPackWithRetry()` → `generateActionPack()`

---

## 🔍 가능한 원인 분석

### 1. 환경 변수 미설정 (가장 가능성 높음)

**위치**: `lib/surveys/analysis/gemini.ts:49-53`

```typescript
const apiKey = process.env.GOOGLE_API_KEY

if (!apiKey) {
  throw new Error('GOOGLE_API_KEY가 설정되지 않았습니다.')
}
```

**확인 방법**:
```bash
# 로컬 환경에서 확인
node -e "console.log(process.env.GOOGLE_API_KEY ? '설정됨' : '미설정')"
```

**해결책**:
- `.env.local` 파일에 `GOOGLE_API_KEY=your_api_key` 추가
- Vercel 환경 변수에 `GOOGLE_API_KEY` 추가

---

### 2. Gemini API 호출 실패

**위치**: `lib/surveys/analysis/gemini.ts:117-146`

**가능한 원인**:
- API 키가 유효하지 않음
- API 할당량 초과
- 네트워크 타임아웃
- 모델명 오류 (`gemini-2.0-flash-exp`)

**에러 처리**:
```typescript
if (!response.ok) {
  const errorText = await response.text()
  console.error('Gemini API 오류:', response.status, errorText)
  throw new Error(`AI 생성 실패: ${response.status} - ${errorText.substring(0, 200)}`)
}
```

---

### 3. JSON 파싱 실패

**위치**: `lib/surveys/analysis/gemini.ts:162-173`

**가능한 원인**:
- Gemini API가 JSON이 아닌 텍스트 반환
- 코드 블록(`\`\`\`json`) 포함된 응답
- 불완전한 JSON 응답

**에러 처리**:
```typescript
try {
  let cleanedContent = content.replace(/```json\n?/g, '').replace(/```\n?/g, '').trim()
  jsonContent = JSON.parse(cleanedContent)
} catch (parseError: any) {
  console.error('JSON 파싱 오류:', parseError.message)
  throw new Error(`AI 응답이 유효한 JSON 형식이 아닙니다: ${parseError.message}`)
}
```

---

### 4. 스키마 검증 실패 (Zod)

**위치**: `lib/surveys/analysis/gemini.ts:175-200`

**가능한 원인**:
- 필수 필드 누락 (`insights`, `priorityQueue`, `surveyNextQuestions`)
- 타입 불일치 (문자열 vs 숫자)
- 배열 길이 부족 (최소 3개, 1개 등)
- 잘못된 enum 값

**재시도 로직**:
- 최대 2회 재시도 (`maxRetries = 2`)
- 이전 검증 오류를 프롬프트에 포함하여 재시도

**에러 처리**:
```typescript
const result = ActionPackV09Schema.safeParse(jsonContent)
if (!result.success) {
  const issues = result.error.issues ?? []
  // 재시도를 위해 issues를 에러에 포함
  const error = new Error(`스키마 검증 실패: ${errorMessages}`) as any
  error.issues = issues
  throw error
}
```

---

### 5. API 응답 없음

**위치**: `lib/surveys/analysis/gemini.ts:150-159`

**가능한 원인**:
- Gemini API가 콘텐츠를 차단 (`blockReason`)
- 응답 완료 실패 (`finishReason`)
- API 타임아웃

**에러 처리**:
```typescript
if (!content) {
  const finishReason = data.candidates?.[0]?.finishReason
  const blockReason = data.promptFeedback?.blockReason
  throw new Error(`AI 응답 없음. finishReason: ${finishReason}, blockReason: ${blockReason}`)
}
```

---

### 6. 데이터베이스 저장 실패

**위치**: `app/api/event-survey/campaigns/[campaignId]/analysis/generate/route.ts:332-361`

**가능한 원인**:
- `action_pack` JSON 필드 크기 초과
- 필수 필드 누락
- RLS 정책 위반

---

## 🛠️ 디버깅 방법

### 1. 서버 로그 확인

**로컬 개발**:
```bash
# 터미널에서 Next.js 서버 로그 확인
npm run dev
```

**확인할 로그**:
- `Gemini API 호출 실패:` - API 호출 에러
- `JSON 파싱 오류:` - JSON 파싱 실패
- `스키마 검증 오류 상세:` - Zod 검증 실패
- `보고서 저장 오류:` - DB 저장 실패

### 2. 환경 변수 확인

**로컬**:
```bash
# .env.local 파일 확인
cat .env.local | grep GOOGLE_API_KEY
```

**Vercel**:
1. Vercel Dashboard → 프로젝트 → Settings → Environment Variables
2. `GOOGLE_API_KEY` 존재 여부 확인

### 3. API 라우트 직접 테스트

```bash
# curl로 직접 호출 (인증 필요)
curl -X POST http://localhost:3000/api/event-survey/campaigns/[campaignId]/analysis/generate \
  -H "Content-Type: application/json" \
  -H "Cookie: [your-auth-cookie]" \
  -d '{"lens": "general"}'
```

### 4. Gemini API 직접 테스트

```typescript
// 테스트 스크립트 생성
const apiKey = process.env.GOOGLE_API_KEY
const modelName = 'gemini-2.0-flash-exp'
const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${modelName}:generateContent?key=${apiKey}`

const response = await fetch(apiUrl, {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({
    contents: [{ parts: [{ text: 'Hello' }] }],
    generationConfig: { responseMimeType: 'application/json' },
  }),
})

console.log(await response.json())
```

---

## ✅ 해결 방안

### 즉시 조치사항

1. **환경 변수 확인 및 설정**
   ```bash
   # .env.local 파일에 추가
   GOOGLE_API_KEY=your_google_api_key_here
   ```

2. **서버 재시작**
   ```bash
   # 환경 변수 변경 후 서버 재시작 필수
   npm run dev
   ```

3. **에러 로그 상세화**
   - 현재 에러 메시지가 일반적임 (`AI 분석 생성에 실패했습니다`)
   - 서버 로그에서 실제 원인 확인 필요

### 개선 사항

#### 1. 에러 메시지 개선

**현재** (`route.ts:305-313`):
```typescript
return NextResponse.json(
  {
    error: 'AI 분석 생성에 실패했습니다',
    code: 'AI_GENERATION_FAILED',
    details: error.message || '알 수 없는 오류',
    stack: process.env.NODE_ENV === 'development' ? error.stack : undefined,
  },
  { status: 500 }
)
```

**개선안**:
- 에러 타입별 구체적인 메시지 제공
- 클라이언트에 표시할 사용자 친화적 메시지 분리

#### 2. 로깅 강화

**추가할 로그**:
- API 호출 시작/종료 시간
- 재시도 횟수 및 이유
- 스키마 검증 실패 상세 정보
- Gemini API 응답 샘플 (처음 500자)

#### 3. 타임아웃 설정

**현재**: 타임아웃 없음 (기본 fetch 타임아웃 사용)

**개선안**:
```typescript
const controller = new AbortController()
const timeoutId = setTimeout(() => controller.abort(), 60000) // 60초

const response = await fetch(apiUrl, {
  signal: controller.signal,
  // ...
})

clearTimeout(timeoutId)
```

#### 4. 재시도 로직 개선

**현재**: 스키마 검증 실패 시에만 재시도

**개선안**:
- 네트워크 에러 시 재시도
- API 할당량 초과 시 지수 백오프
- 최대 재시도 횟수 설정 가능하게

#### 5. 사용자 피드백 개선

**현재**: `alert()` 사용

**개선안**:
- 로딩 상태 표시
- 진행률 표시 (재시도 중 등)
- 에러 타입별 구체적인 안내 메시지

---

## 📊 에러 발생 패턴 분석

### 예상 시나리오

1. **환경 변수 미설정** (가장 가능성 높음)
   - 첫 배포 시 흔히 발생
   - 로컬 개발 환경에서 `.env.local` 파일 누락

2. **스키마 검증 실패**
   - Gemini API가 요구사항을 정확히 따르지 않음
   - 재시도 후에도 실패하는 경우

3. **API 할당량 초과**
   - 일일/월간 할당량 초과
   - Rate limit 도달

---

## 🔄 다음 단계

### 우선순위 1: 즉시 확인
- [ ] `.env.local` 파일에 `GOOGLE_API_KEY` 설정 확인
- [ ] 서버 로그에서 실제 에러 메시지 확인
- [ ] Gemini API 키 유효성 확인

### 우선순위 2: 개선 작업
- [ ] 에러 메시지 개선 (구체적인 원인 표시)
- [ ] 로깅 강화 (디버깅 정보 추가)
- [ ] 타임아웃 설정 추가
- [ ] 사용자 피드백 개선

### 우선순위 3: 모니터링
- [ ] 에러 발생 빈도 추적
- [ ] 재시도 성공률 모니터링
- [ ] API 응답 시간 모니터링

---

## 📝 참고 자료

- **API 라우트**: `app/api/event-survey/campaigns/[campaignId]/analysis/generate/route.ts`
- **Gemini API 호출**: `lib/surveys/analysis/gemini.ts`
- **스키마 정의**: `lib/surveys/analysis/actionPackSchema.ts`
- **환경 변수 가이드**: `docs/ENV_SETUP.md`

---

## 💡 권장 사항

1. **환경 변수 검증 추가**
   ```typescript
   // API 라우트 시작 부분에 추가
   if (!process.env.GOOGLE_API_KEY) {
     return NextResponse.json(
       { error: 'GOOGLE_API_KEY가 설정되지 않았습니다.', code: 'MISSING_API_KEY' },
       { status: 500 }
     )
   }
   ```

2. **에러 타입별 처리**
   - 환경 변수 미설정 → 500 + 구체적 메시지
   - API 호출 실패 → 502 + 재시도 안내
   - 스키마 검증 실패 → 422 + 검증 오류 상세
   - DB 저장 실패 → 500 + 저장 오류 상세

3. **모니터링 도구 연동**
   - Sentry, LogRocket 등 에러 추적 도구 연동
   - 에러 발생 시 알림 설정

---

**보고서 작성자**: AI Assistant  
**검토 필요**: 실제 서버 로그 확인 후 원인 보완 필요

