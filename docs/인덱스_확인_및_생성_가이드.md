# 인덱스 확인 및 생성 가이드

## 1. Supabase 대시보드에서 확인

1. **Supabase 대시보드 접속**: https://supabase.com/dashboard
2. **프로젝트 선택**: EventLive (yqsayphssjznthrxpgfb)
3. **SQL Editor** 메뉴로 이동
4. 아래 SQL을 복사하여 실행

---

## 2. 인덱스 확인 SQL

```sql
-- profiles 테이블의 모든 인덱스 확인
SELECT 
  schemaname,
  tablename,
  indexname,
  indexdef
FROM pg_indexes
WHERE tablename = 'profiles'
ORDER BY indexname;

-- email 컬럼에 인덱스가 있는지 확인
SELECT 
  i.indexname,
  i.indexdef,
  CASE 
    WHEN i.indexdef LIKE '%email%' THEN '✓ Email 인덱스 있음'
    ELSE '✗ Email 인덱스 없음'
  END as email_index_status
FROM pg_indexes i
WHERE i.tablename = 'profiles'
ORDER BY i.indexname;

-- agency_members 테이블 인덱스 확인
SELECT 
  'agency_members' as table_name,
  indexname,
  indexdef
FROM pg_indexes
WHERE tablename = 'agency_members'
ORDER BY indexname;

-- client_members 테이블 인덱스 확인
SELECT 
  'client_members' as table_name,
  indexname,
  indexdef
FROM pg_indexes
WHERE tablename = 'client_members'
ORDER BY indexname;
```

---

## 3. 필요한 인덱스 생성

### 3.1 profiles.email 인덱스 (가장 중요!)

**확인 결과 인덱스가 없으면 생성**:

```sql
-- profiles.email에 인덱스 생성
CREATE INDEX IF NOT EXISTS idx_profiles_email 
ON public.profiles(email);

-- 소문자 이메일 검색을 위한 인덱스 (선택적, 더 빠른 검색)
CREATE INDEX IF NOT EXISTS idx_profiles_email_lower 
ON public.profiles(LOWER(email));
```

**확인**:
```sql
-- 생성된 인덱스 확인
SELECT indexname, indexdef 
FROM pg_indexes 
WHERE tablename = 'profiles' 
  AND indexname LIKE '%email%';
```

---

### 3.2 agency_members.user_id 인덱스

```sql
-- user_id에 인덱스가 없으면 생성
CREATE INDEX IF NOT EXISTS idx_agency_members_user_id 
ON public.agency_members(user_id);
```

---

### 3.3 client_members.user_id 인덱스

```sql
-- user_id에 인덱스가 없으면 생성
CREATE INDEX IF NOT EXISTS idx_client_members_user_id 
ON public.client_members(user_id);
```

---

## 4. 성능 테스트

### 4.1 배치 조회 쿼리 성능 확인

```sql
-- 배치 조회 쿼리 실행 계획 확인
EXPLAIN (ANALYZE, BUFFERS, VERBOSE)
SELECT id, display_name, email, nickname
FROM public.profiles
WHERE id IN (
  SELECT id FROM profiles ORDER BY created_at DESC LIMIT 100
);

-- 결과에서 확인할 사항:
-- - "Index Scan" 또는 "Bitmap Index Scan"이 보이면 인덱스 사용 중 ✓
-- - "Seq Scan"이 보이면 전체 테이블 스캔 (느림) ✗
-- - Execution Time이 200ms 이내면 좋음
```

---

### 4.2 개별 조회 vs 배치 조회 비교

```sql
-- 배치 조회 (빠름 - 권장)
EXPLAIN ANALYZE
SELECT id, display_name, email, nickname
FROM public.profiles
WHERE id = ANY(ARRAY(
  SELECT id FROM profiles ORDER BY created_at DESC LIMIT 100
));

-- 개별 조회 (느림 - 비권장)
-- 100번의 개별 쿼리 = 매우 느림
```

---

## 5. 테이블 통계 업데이트

인덱스를 생성한 후 쿼리 플래너가 최적의 계획을 선택하도록 통계를 업데이트:

```sql
-- 테이블 통계 업데이트
ANALYZE public.profiles;
ANALYZE public.agency_members;
ANALYZE public.client_members;

-- 통계 확인
SELECT 
  schemaname,
  tablename,
  n_live_tup as row_count,
  last_analyze
FROM pg_stat_user_tables
WHERE tablename IN ('profiles', 'agency_members', 'client_members')
ORDER BY tablename;
```

---

## 6. 체크리스트

### 인덱스 확인
- [ ] `profiles.email` 인덱스 확인
- [ ] `agency_members.user_id` 인덱스 확인
- [ ] `client_members.user_id` 인덱스 확인

### 인덱스 생성 (없는 경우)
- [ ] `idx_profiles_email` 생성
- [ ] `idx_agency_members_user_id` 생성
- [ ] `idx_client_members_user_id` 생성

### 성능 확인
- [ ] 배치 조회 쿼리가 인덱스를 사용하는지 확인
- [ ] 실행 시간이 200ms 이내인지 확인
- [ ] 테이블 통계 업데이트 완료

---

## 7. 예상 성능 개선 효과

### 인덱스가 있는 경우
- **배치 조회**: 100명 조회 시 **200ms 이내** ⚡
- **이메일 검색**: **10ms 이내** ⚡

### 인덱스가 없는 경우
- **배치 조회**: 100명 조회 시 **1초 이상** ⚠️
- **이메일 검색**: **500ms 이상** ⚠️

---

## 8. 참고 파일

- `scripts/check-indexes.sql` - 인덱스 확인 SQL
- `scripts/check-performance.sql` - 성능 테스트 SQL
- `docs/성능_지연_원인_분석_보고서.md` - 성능 문제 분석
