# UTM νλΌλ―Έν„° λ³µμ› μ¤ν¬λ¦½νΈ λ…μ„Έμ„

**μ‘μ„±μΌ**: 2026-02-02  
**λ€μƒ**: κ°λ°μ, μ΄μμ  
**λ²„μ „**: 1.0

---

## π“‹ λ©μ°¨

1. [κ°μ”](#κ°μ”)
2. [λ¬Έμ  μƒν™©](#λ¬Έμ -μƒν™©)
3. [ν•΄κ²° λ°©λ²•](#ν•΄κ²°-λ°©λ²•)
4. [μ¤ν¬λ¦½νΈ μ‚¬μ©λ²•](#μ¤ν¬λ¦½νΈ-μ‚¬μ©λ²•)
5. [κΈ°μ μ  μƒμ„Έ](#κΈ°μ μ -μƒμ„Έ)
6. [μ£Όμμ‚¬ν•­](#μ£Όμμ‚¬ν•­)
7. [νΈλ¬λΈ”μν…](#νΈλ¬λΈ”μν…)

---

## κ°μ”

### λ©μ 

`marketing_campaign_link_id`κ°€ μμ§€λ§ UTM νλΌλ―Έν„°κ°€ `null`λ΅ μ €μ¥λ λ“±λ΅ λ°μ΄ν„°λ¥Ό λ³µμ›ν•λ” μ¤ν¬λ¦½νΈμ…λ‹λ‹¤. λ§ν¬μ— μ €μ¥λ UTM νλΌλ―Έν„°λ¥Ό μ‚¬μ©ν•μ—¬ λ“±λ΅ λ°μ΄ν„°μ UTM ν•„λ“λ¥Ό μ—…λ°μ΄νΈν•©λ‹λ‹¤.

### λ°°κ²½

μ΄μ „ λ²„μ „μ λ“±λ΅ APIμ—μ„λ” URLμ UTM νλΌλ―Έν„°λ§ μ‚¬μ©ν•κ³ , λ§ν¬μ— μ €μ¥λ UTM νλΌλ―Έν„°λ¥Ό μ‚¬μ©ν•μ§€ μ•μ•μµλ‹λ‹¤. μ΄λ΅ μΈν•΄ URLμ— UTMμ΄ μ—†μΌλ©΄ `null`λ΅ μ €μ¥λμ–΄ "Direct (UTM μ—†μ)"μΌλ΅ μλ» μ§‘κ³„λλ” λ¬Έμ κ°€ λ°μƒν–μµλ‹λ‹¤.

### ν•΄κ²° μ™„λ£ μ‚¬ν•­

- β… λ“±λ΅ API μμ •: λ§ν¬μ UTM νλΌλ―Έν„°λ¥Ό μ‚¬μ©ν•λ„λ΅ κ°μ„ 
- β… λ³µμ› μ¤ν¬λ¦½νΈ: κ³Όκ±° λ°μ΄ν„° λ³µμ›μ© μ¤ν¬λ¦½νΈ μ κ³µ

---

## λ¬Έμ  μƒν™©

### λ°μƒν• λ¬Έμ 

1. **UTM νλΌλ―Έν„° λ„λ½**: λ§ν¬λ¥Ό ν†µν•΄ λ“¤μ–΄μ¨ μ‚¬μ©μλ„ UTMμ΄ `null`λ΅ μ €μ¥λ¨
2. **μλ»λ μ§‘κ³„**: "Direct (UTM μ—†μ)"μΌλ΅ μλ» λ¶„λ¥λ¨
3. **ν†µκ³„ μ™κ³΅**: μ‹¤μ  λ§μΌ€ν… μ„±κ³Όλ¥Ό μ •ν™•ν νμ•…ν•  μ μ—†μ

### μμ‹

```
β λ¬Έμ  μƒν™©:
- λ§ν¬: "26λ…„ 1μ›” λ‰΄μ¤λ ν„°" (utm_source: newsletter, utm_medium: email)
- μ‚¬μ©μκ°€ λ§ν¬λ¥Ό ν†µν•΄ λ“±λ΅
- μ €μ¥λ λ°μ΄ν„°: utm_source = null, utm_medium = null
- μ§‘κ³„ κ²°κ³Ό: "Direct (UTM μ—†μ)"μΌλ΅ ν‘μ‹λ¨

β… λ³µμ› ν›„:
- μ €μ¥λ λ°μ΄ν„°: utm_source = "newsletter", utm_medium = "email"
- μ§‘κ³„ κ²°κ³Ό: "newsletter" / "email"λ΅ μ •ν™•ν ν‘μ‹λ¨
```

---

## ν•΄κ²° λ°©λ²•

### 1. λ“±λ΅ API κ°μ„ 

**νμΌ**: `app/api/public/event-survey/[campaignId]/register/route.ts`

**λ³€κ²½ μ‚¬ν•­**:
- `cid`λ΅ λ§ν¬λ¥Ό μ°Ύμ„ λ• λ§ν¬μ UTM νλΌλ―Έν„°λ„ ν•¨κ» κ°€μ Έμ΄
- UTM νλΌλ―Έν„° μ°μ„ μμ„: URLμ UTM > λ§ν¬μ UTM > null

**μ½”λ“ μμ‹**:
```typescript
// λ§ν¬μ—μ„ UTM νλΌλ―Έν„° κ°€μ Έμ¤κΈ°
const { data: link } = await admin
  .from('campaign_link_meta')
  .select('id, utm_source, utm_medium, utm_campaign, utm_term, utm_content')
  .eq('cid', normalizedCid)
  .single()

// UTM νλΌλ―Έν„° μ°μ„ μμ„ μ μ©
const finalUTMParams = {
  utm_source: utm_source || link?.utm_source || null,
  utm_medium: utm_medium || link?.utm_medium || null,
  // ...
}
```

### 2. λ³µμ› μ¤ν¬λ¦½νΈ μ κ³µ

**νμΌ**: `scripts/restore-utm-from-links.ts`

κ³Όκ±°μ— μ €μ¥λ λ°μ΄ν„°λ¥Ό λ³µμ›ν•λ” μ¤ν¬λ¦½νΈλ¥Ό μ κ³µν•©λ‹λ‹¤.

---

## μ¤ν¬λ¦½νΈ μ‚¬μ©λ²•

### κΈ°λ³Έ μ‚¬μ©λ²•

#### 1. λ“λΌμ΄λ° λ¨λ“ (κ¶μ¥: λ¨Όμ € ν™•μΈ)

μ‹¤μ  μ—…λ°μ΄νΈ μ—†μ΄ λ³µμ› λ€μƒκ³Ό λ‚΄μ©μ„ ν™•μΈν•©λ‹λ‹¤.

```bash
npx tsx scripts/restore-utm-from-links.ts --dry-run
```

**μ¶λ ¥ μμ‹**:
```
=== UTM νλΌλ―Έν„° λ³µμ› μ¤ν¬λ¦½νΈ ===

λ¨λ“: π” λ“λΌμ΄λ° (μ‹¤μ  μ—…λ°μ΄νΈ μ• ν•¨)

π“ λ³µμ› λ€μƒ: 159κ° ν•­λ©

π”— μ΅°νν•  λ§ν¬ μ: 16κ°

π“ ν†µκ³„:
  - λ³µμ› κ°€λ¥: 159κ°
  - κ±΄λ„λ€: 0κ°
  - μ΄ λ€μƒ: 159κ°

π“‹ λ³µμ› μμ‹ (μ²μ 5κ°):

1. Entry ID: abc-123-def-456
   λ§ν¬: 26λ…„ 1μ›” λ‰΄μ¤λ ν„°
   UTM Source: newsletter
   UTM Medium: email
   UTM Campaign: january_2026

...

π” λ“λΌμ΄λ° λ¨λ“: μ‹¤μ  μ—…λ°μ΄νΈλ¥Ό ν•μ§€ μ•μµλ‹λ‹¤.
μ‹¤μ  μ—…λ°μ΄νΈν•λ ¤λ©΄ --dry-run μµμ…μ„ μ κ±°ν•μ„Έμ”.
```

#### 2. μ „μ²΄ λ³µμ›

λ¨λ“  ν΄λΌμ΄μ–ΈνΈ/μΊ νμΈμ λ°μ΄ν„°λ¥Ό λ³µμ›ν•©λ‹λ‹¤.

```bash
npx tsx scripts/restore-utm-from-links.ts
```

#### 3. νΉμ • ν΄λΌμ΄μ–ΈνΈλ§ λ³µμ›

νΉμ • ν΄λΌμ΄μ–ΈνΈμ λ°μ΄ν„°λ§ λ³µμ›ν•©λ‹λ‹¤.

```bash
npx tsx scripts/restore-utm-from-links.ts --clientId <clientId>
```

**μμ‹**:
```bash
npx tsx scripts/restore-utm-from-links.ts --clientId 55317496-d3d6-4e65-81d3-405892de78ab
```

#### 4. νΉμ • μΊ νμΈλ§ λ³µμ›

νΉμ • μΊ νμΈμ λ°μ΄ν„°λ§ λ³µμ›ν•©λ‹λ‹¤.

```bash
npx tsx scripts/restore-utm-from-links.ts --campaignId <campaignId>
```

**μμ‹**:
```bash
npx tsx scripts/restore-utm-from-links.ts --campaignId a3c659-1234-5678-90ab-cdef12345678
```

#### 5. μµμ… μ΅°ν•©

μ—¬λ¬ μµμ…μ„ μ΅°ν•©ν•μ—¬ μ‚¬μ©ν•  μ μμµλ‹λ‹¤.

```bash
# νΉμ • ν΄λΌμ΄μ–ΈνΈ + λ“λΌμ΄λ°
npx tsx scripts/restore-utm-from-links.ts --clientId <clientId> --dry-run

# νΉμ • μΊ νμΈ + λ“λΌμ΄λ°
npx tsx scripts/restore-utm-from-links.ts --campaignId <campaignId> --dry-run
```

### μ‹¤ν–‰ κ²°κ³Ό

#### μ„±κ³µ μ‹ μ¶λ ¥

```
π”„ μ—…λ°μ΄νΈ μ‹μ‘...

λ°°μΉ 1/4 μ²λ¦¬ μ¤‘... (50κ° ν•­λ©)
λ°°μΉ 2/4 μ²λ¦¬ μ¤‘... (50κ° ν•­λ©)
λ°°μΉ 3/4 μ²λ¦¬ μ¤‘... (50κ° ν•­λ©)
λ°°μΉ 4/4 μ²λ¦¬ μ¤‘... (9κ° ν•­λ©)

β… μ—…λ°μ΄νΈ μ™„λ£:
  - μ„±κ³µ: 159κ°
  - μ‹¤ν¨: 0κ°
  - μ΄: 159κ°
```

#### μ‹¤ν¨ μ‹ μ¶λ ¥

```
β μ—…λ°μ΄νΈ μ‹¤ν¨: entry abc-123-def-456 Error message here

β… μ—…λ°μ΄νΈ μ™„λ£:
  - μ„±κ³µ: 158κ°
  - μ‹¤ν¨: 1κ°
  - μ΄: 159κ°
```

---

## κΈ°μ μ  μƒμ„Έ

### μ¤ν¬λ¦½νΈ λ™μ‘ νλ¦„

```
1. μ΅°κ±΄μ— λ§λ” λ“±λ΅ λ°μ΄ν„° μ΅°ν
   β†“
2. marketing_campaign_link_idκ°€ μμ§€λ§ utm_sourceκ°€ nullμΈ ν•­λ© μ°ΎκΈ°
   β†“
3. ν•΄λ‹Ή λ§ν¬λ“¤μ UTM νλΌλ―Έν„° μ΅°ν
   β†“
4. UTM νλΌλ―Έν„° μ •κ·ν™” (normalizeUTM)
   β†“
5. μ—…λ°μ΄νΈ λ€μƒ λ©λ΅ μƒμ„±
   β†“
6. λ°°μΉλ΅ μ—…λ°μ΄νΈ μ‹¤ν–‰ (50κ°μ”©)
   β†“
7. κ²°κ³Ό ν†µκ³„ μ¶λ ¥
```

### λ°μ΄ν„°λ² μ΄μ¤ μΏΌλ¦¬

#### 1. λ³µμ› λ€μƒ μ΅°ν

```sql
SELECT 
  id, 
  campaign_id, 
  marketing_campaign_link_id, 
  utm_source, 
  utm_medium, 
  utm_campaign, 
  created_at
FROM event_survey_entries
WHERE marketing_campaign_link_id IS NOT NULL
  AND utm_source IS NULL
```

#### 2. λ§ν¬ UTM νλΌλ―Έν„° μ΅°ν

```sql
SELECT 
  id, 
  name, 
  utm_source, 
  utm_medium, 
  utm_campaign, 
  utm_term, 
  utm_content
FROM campaign_link_meta
WHERE id IN (link_ids...)
```

#### 3. μ—…λ°μ΄νΈ μ‹¤ν–‰

```sql
UPDATE event_survey_entries
SET 
  utm_source = :utm_source,
  utm_medium = :utm_medium,
  utm_campaign = :utm_campaign,
  utm_term = :utm_term,
  utm_content = :utm_content
WHERE id = :entry_id
```

### UTM νλΌλ―Έν„° μ •κ·ν™”

μ¤ν¬λ¦½νΈλ” `normalizeUTM()` ν•¨μλ¥Ό μ‚¬μ©ν•μ—¬ UTM νλΌλ―Έν„°λ¥Ό μ •κ·ν™”ν•©λ‹λ‹¤.

**μ •κ·ν™” κ·μΉ™**:
- `trim()`: μ•λ’¤ κ³µλ°± μ κ±°
- `toLowerCase()`: μ†λ¬Έμ λ³€ν™
- κΈΈμ΄ μ ν•: κ° νλΌλ―Έν„° μµλ€ 200μ

**μμ‹**:
```typescript
// μ…λ ¥
{
  utm_source: "  Newsletter  ",
  utm_medium: "EMAIL"
}

// μ •κ·ν™” ν›„
{
  utm_source: "newsletter",
  utm_medium: "email"
}
```

### λ°°μΉ μ²λ¦¬

μ„±λ¥κ³Ό μ•μ •μ„±μ„ μ„ν•΄ ν• λ²μ— 50κ°μ”© λ°°μΉλ΅ μ²λ¦¬ν•©λ‹λ‹¤.

**μ΄μ **:
- λ€λ‰ μ—…λ°μ΄νΈ μ‹ νƒ€μ„μ•„μ›ƒ λ°©μ§€
- μ—λ¬ λ°μƒ μ‹ μΌλ¶€λ§ μ‹¤ν¨ν•κ³  λ‚λ¨Έμ§€λ” κ³„μ† μ§„ν–‰
- μ§„ν–‰ μƒν™© λ¨λ‹ν„°λ§ κ°€λ¥

---

## μ£Όμμ‚¬ν•­

### β οΈ μ‹¤ν–‰ μ „ ν™•μΈμ‚¬ν•­

1. **λ°±μ—… κ¶μ¥**: λ€λ‰ λ°μ΄ν„° μ—…λ°μ΄νΈ μ „ λ°μ΄ν„°λ² μ΄μ¤ λ°±μ—… κ¶μ¥
2. **λ“λΌμ΄λ° λ¨Όμ €**: λ°λ“μ‹ `--dry-run` μµμ…μΌλ΅ λ¨Όμ € ν™•μΈ
3. **μ΄μ μ‹κ°„**: νΈλν”½μ΄ μ μ€ μ‹κ°„λ€μ— μ‹¤ν–‰ κ¶μ¥
4. **κ¶ν• ν™•μΈ**: Supabase Admin κ¶ν• ν•„μ”

### β οΈ μ ν•μ‚¬ν•­

1. **λ§ν¬κ°€ μ—†λ” κ²½μ°**: `marketing_campaign_link_id`κ°€ μ—†μΌλ©΄ λ³µμ› λ¶κ°€
2. **λ§ν¬μ— UTM μ—†λ” κ²½μ°**: λ§ν¬μ— UTM νλΌλ―Έν„°κ°€ μ—†μΌλ©΄ κ±΄λ„λ€
3. **μ΄λ―Έ UTM μλ” κ²½μ°**: μ΄λ―Έ UTM νλΌλ―Έν„°κ°€ μμΌλ©΄ μ—…λ°μ΄νΈ μ• ν•¨ (λ®μ–΄μ“°κΈ° μ• ν•¨)

### β οΈ μ£Όμν•  μ 

1. **λ®μ–΄μ“°κΈ° μ• ν•¨**: μ΄λ―Έ UTM νλΌλ―Έν„°κ°€ μλ” ν•­λ©μ€ μ—…λ°μ΄νΈν•μ§€ μ•μ
   - μ΄μ : URLμ—μ„ μ§μ ‘ μ „λ‹¬λ UTMμ΄ λ” μ •ν™•ν•  μ μμ
   - λ³µμ› λ€μƒ: `utm_source IS NULL`μΈ ν•­λ©λ§

2. **λ§ν¬ μ‚­μ λ κ²½μ°**: λ§ν¬κ°€ μ‚­μ λμ—κ±°λ‚ μ°Ύμ„ μ μ—†μΌλ©΄ κ±΄λ„λ€
   - λ΅κ·Έμ— κ²½κ³  λ©”μ‹μ§€ μ¶λ ¥
   - κ±΄λ„λ›΄ ν•­λ© μκ°€ ν†µκ³„μ— ν‘μ‹λ¨

3. **μ •κ·ν™” μ μ©**: λ§ν¬μ UTM νλΌλ―Έν„°λ„ μ •κ·ν™”ν•μ—¬ μ €μ¥
   - μΌκ΄€μ„± μ μ§€
   - λ€μ†λ¬Έμ ν†µμΌ

---

## νΈλ¬λΈ”μν…

### λ¬Έμ  1: "λ³µμ›ν•  λ°μ΄ν„°κ°€ μ—†μµλ‹λ‹¤" λ©”μ‹μ§€

**μ›μΈ**:
- λ¨λ“  λ“±λ΅μ— μ΄λ―Έ UTM νλΌλ―Έν„°κ°€ μμ
- λλ” `marketing_campaign_link_id`κ°€ μ—†μ

**ν•΄κ²°**:
- λ‹¤λ¥Έ ν΄λΌμ΄μ–ΈνΈ/μΊ νμΈ ν™•μΈ
- λ°μ΄ν„°λ² μ΄μ¤μ—μ„ μ§μ ‘ ν™•μΈ:
  ```sql
  SELECT COUNT(*) 
  FROM event_survey_entries 
  WHERE marketing_campaign_link_id IS NOT NULL 
    AND utm_source IS NULL
  ```

### λ¬Έμ  2: "λ§ν¬λ¥Ό μ°Ύμ„ μ μ—†μ" κ²½κ³ 

**μ›μΈ**:
- λ§ν¬κ°€ μ‚­μ λ¨
- `marketing_campaign_link_id`κ°€ μλ»λ κ°’

**ν•΄κ²°**:
- λ§ν¬κ°€ μ‹¤μ λ΅ μ΅΄μ¬ν•λ”μ§€ ν™•μΈ:
  ```sql
  SELECT * FROM campaign_link_meta WHERE id = '<linkId>'
  ```
- ν•„μ”μ‹ λ§ν¬ μ¬μƒμ„± λλ” `marketing_campaign_link_id` μμ •

### λ¬Έμ  3: μ—…λ°μ΄νΈ μ‹¤ν¨

**μ›μΈ**:
- λ°μ΄ν„°λ² μ΄μ¤ μ—°κ²° λ¬Έμ 
- κ¶ν• λ¬Έμ 
- μ μ•½ μ΅°κ±΄ μ„λ°

**ν•΄κ²°**:
1. μ—λ¬ λ©”μ‹μ§€ ν™•μΈ
2. Supabase μ—°κ²° μƒνƒ ν™•μΈ
3. Admin κ¶ν• ν™•μΈ
4. μ‹¤ν¨ν• ν•­λ©λ§ μ¬μ‹¤ν–‰ (Entry ID ν™•μΈ)

### λ¬Έμ  4: μΌλ¶€λ§ μ—…λ°μ΄νΈλ¨

**μ›μΈ**:
- λ§ν¬μ— UTM νλΌλ―Έν„°κ°€ μ—†μ
- μΌλ¶€ ν•­λ©λ§ μ΅°κ±΄μ— λ§μ

**ν•΄κ²°**:
- ν†µκ³„ ν™•μΈ: "λ³µμ› κ°€λ¥" vs "κ±΄λ„λ€" μ ν™•μΈ
- λ§ν¬μ UTM νλΌλ―Έν„° ν™•μΈ:
  ```sql
  SELECT id, name, utm_source, utm_medium 
  FROM campaign_link_meta 
  WHERE id IN (link_ids...)
  ```

### λ¬Έμ  5: μ‹¤ν–‰ μ‹κ°„μ΄ μ¤λ κ±Έλ¦Ό

**μ›μΈ**:
- λ€λ‰ λ°μ΄ν„° μ²λ¦¬
- λ„¤νΈμ›ν¬ μ§€μ—°

**ν•΄κ²°**:
- μ •μƒμ μΈ ν„μƒ (λ€λ‰ λ°μ΄ν„° μ²λ¦¬ μ‹)
- λ°°μΉ μ²λ¦¬λ΅ μ§„ν–‰ μƒν™© ν™•μΈ κ°€λ¥
- ν•„μ”μ‹ λ°°μΉ ν¬κΈ° μ΅°μ • (μ¤ν¬λ¦½νΈ λ‚΄ `batchSize` λ³€μ)

---

## κ²€μ¦ λ°©λ²•

### λ³µμ› μ „ ν™•μΈ

```sql
-- λ³µμ› λ€μƒ μ ν™•μΈ
SELECT COUNT(*) 
FROM event_survey_entries 
WHERE marketing_campaign_link_id IS NOT NULL 
  AND utm_source IS NULL;
```

### λ³µμ› ν›„ ν™•μΈ

```sql
-- λ³µμ›λ ν•­λ© ν™•μΈ
SELECT 
  e.id,
  e.utm_source,
  e.utm_medium,
  l.name as link_name,
  l.utm_source as link_utm_source,
  l.utm_medium as link_utm_medium
FROM event_survey_entries e
JOIN campaign_link_meta l ON e.marketing_campaign_link_id = l.id
WHERE e.marketing_campaign_link_id IS NOT NULL
  AND e.utm_source IS NOT NULL
ORDER BY e.created_at DESC
LIMIT 10;
```

### μ§‘κ³„ ν™•μΈ

λ€μ‹λ³΄λ“μ—μ„ UTM ν†µκ³„κ°€ μ •μƒμ μΌλ΅ ν‘μ‹λλ”μ§€ ν™•μΈ:

1. ν΄λΌμ΄μ–ΈνΈ λ€μ‹λ³΄λ“ μ ‘μ†
2. "π“ κ΄‘κ³ /μΊ νμΈ" β†’ "μ „ν™ μ„±κ³Ό" νƒ­
3. Sourceλ³„/Mediumλ³„ μ „ν™ ν™•μΈ
4. "Direct (UTM μ—†μ)" μκ°€ κ°μ†ν–λ”μ§€ ν™•μΈ

---

## κ΄€λ ¨ λ¬Έμ„

- [UTM μ¶”μ  μ‹μ¤ν… μ‚¬μ© κ°€μ΄λ“](./UTM_μ¶”μ _μ‹μ¤ν…_μ‚¬μ©_κ°€μ΄λ“.md)
- [UTM μ¶”μ  μ‹μ¤ν… κµ¬ν„ μ™„λ£ λ³΄κ³ μ„](./UTM_μ¶”μ _μ‹μ¤ν…_κµ¬ν„_μ™„λ£_λ³΄κ³ μ„.md)
- [UTM νλΌλ―Έν„° μ¶”μ  μ μ© λ°©μ• λ³΄κ³ μ„](./UTM_νλΌλ―Έν„°_μ¶”μ _μ μ©_λ°©μ•_λ³΄κ³ μ„.md)

---

## λ³€κ²½ μ΄λ ¥

| λ‚ μ§ | λ²„μ „ | λ³€κ²½ λ‚΄μ© |
|------|------|-----------|
| 2026-02-02 | 1.0 | μ΄κΈ° μ‘μ„± |

---

## λ¬Έμ

λ¬Έμ κ°€ λ°μƒν•κ±°λ‚ μ§λ¬Έμ΄ μμΌλ©΄ κ°λ°ν€μ— λ¬Έμν•μ„Έμ”.
