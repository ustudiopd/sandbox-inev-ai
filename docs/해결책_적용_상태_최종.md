# í•´ê²°ì±….md ì ìš© ìƒíƒœ ìµœì¢… ê²€í† 

## âœ… ì´ë¯¸ ì ìš©ëœ í•­ëª©

### 1. Effect ì˜ì¡´ì„± ë‹¤ì´ì–´íŠ¸ + Supabase í´ë¼ì´ì–¸íŠ¸ ê³ ì • âœ…
- **Supabase í´ë¼ì´ì–¸íŠ¸ ì‹±ê¸€í„´**: `lib/supabase/client.ts`ì—ì„œ ì‹±ê¸€í„´ íŒ¨í„´ ì ìš©
- **useEffect dependency**: `supabase` ì œê±°ë¨ (`[webinarId, currentUser?.id, reconnectKey]`)
- **ê°œì„  í•„ìš”**: `useMemo`ë¡œ ëª…ì‹œì  ê³ ì • (ì„ íƒì‚¬í•­, ì‹±ê¸€í„´ì´ë¯€ë¡œ í˜„ì¬ë„ ì•ˆì „)

### 2. ì±„ë„/íƒ€ì´ë¨¸ Refë¡œ ê´€ë¦¬ & ì² ì €íˆ clear âœ…
- `reconnectTimeoutRef`, `fallbackReconnectTimeoutRef`, `channelRef` ì‚¬ìš©
- cleanupì—ì„œ ëª¨ë“  íƒ€ì´ë¨¸ ì·¨ì†Œ
- `pollingTimeouts` ë°°ì—´ë¡œ í´ë§ íƒ€ì´ë¨¸ ì¶”ì 

### 3. ìˆ˜ë™ ì¬ì—°ê²°ì—ì„œ ì±„ë„ì„ ì§ì ‘ ë‹«ì§€ ë§ê¸° âœ…
- `setTimeout` ì•ˆì—ì„œ `setReconnectKey`ë§Œ í˜¸ì¶œ
- ì±„ë„ ì •ë¦¬ëŠ” cleanupì´ ì²˜ë¦¬
- ì¬ì—°ê²° íƒ€ì´ë¨¸ì—ì„œ ì±„ë„ ì •ë¦¬ ì œê±°

### 4. ê¸°ì¡´ ì±„ë„ ì •ë¦¬ ì‹œ await ë³´ì¥ âœ…
- `await existingChannel.unsubscribe()` ì‚¬ìš©
- ì •ë¦¬ ì™„ë£Œ í›„ 100ms ì§€ì—° ì¶”ê°€

### 5. í´ë°± í´ë§ ìµœì í™” âœ…
- 15ì´ˆ ì£¼ê¸° (ê¸°ë³¸) + Â±5ì´ˆ ì§€í„°
- ê°€ì‹œì„±/ì˜¨ë¼ì¸ ìƒíƒœ í™•ì¸
- ì§€ìˆ˜ ë°±ì˜¤í”„ ì ìš©
- ëª¨ë“  í´ë§ íƒ€ì´ë¨¸ ì¶”ì  ë° cleanup

---

## âš ï¸ ë¶€ë¶„ì ìœ¼ë¡œ ì ìš©ëœ í•­ëª©

### 6. Chat ë‹¨ì¼ ì¸ìŠ¤í„´ìŠ¤ ì›ì¹™ âš ï¸

**í˜„ì¬ ìƒíƒœ**:
- ëª¨ë°”ì¼/ë°ìŠ¤í¬í†±ì—ì„œ ê°ê° ë‹¤ë¥¸ `key` prop ì‚¬ìš© (`chat-mobile-${webinar.id}`, `chat-desktop-${webinar.id}`)
- ì—¬ì „íˆ ë‘ ê°œì˜ Chat ì¸ìŠ¤í„´ìŠ¤ê°€ ë™ì‹œì— ë§ˆìš´íŠ¸ë  ìˆ˜ ìˆìŒ

**ë¬¸ì œì **:
- í™”ë©´ì—ëŠ” í•˜ë‚˜ë§Œ ë³´ì´ì§€ë§Œ DOMì—ëŠ” ë‘ ê°œì˜ Chat ì»´í¬ë„ŒíŠ¸ê°€ ì¡´ì¬
- ë‘ ì¸ìŠ¤í„´ìŠ¤ê°€ ê°ê° Realtime êµ¬ë…ì„ ì‹œë„í•  ìˆ˜ ìˆìŒ
- í•˜ë‚˜ê°€ ì–¸ë§ˆìš´íŠ¸ë˜ë©´ ë‹¤ë¥¸ ìª½ì—ë„ ì˜í–¥

**ê¶Œì¥ í•´ê²°ì±…**:
```typescript
// ì˜µì…˜ 1: Chat ì»´í¬ë„ŒíŠ¸ë¥¼ í•œ ë²ˆë§Œ ë Œë”ë§í•˜ê³  ë ˆì´ì•„ì›ƒë§Œ ë³€ê²½
const chatComponent = useMemo(() => (
  <Chat
    key={`chat-${webinar.id}`}
    webinarId={webinar.id}
    canSend={true}
    maxMessages={50}
    isAdminMode={isAdminMode}
  />
), [webinar.id, isAdminMode])

// ëª¨ë°”ì¼ê³¼ ë°ìŠ¤í¬í†±ì—ì„œ ê°™ì€ ì¸ìŠ¤í„´ìŠ¤ ì‚¬ìš©
{/* ëª¨ë°”ì¼ */}
<div className="lg:hidden">{chatComponent}</div>
{/* ë°ìŠ¤í¬í†± */}
<div className="hidden lg:block">{chatComponent}</div>
```

---

## âŒ ì•„ì§ ì ìš©ë˜ì§€ ì•Šì€ í•­ëª©

### 7. useMemoë¡œ Supabase í´ë¼ì´ì–¸íŠ¸ ëª…ì‹œì  ê³ ì • (ì„ íƒì‚¬í•­)

**í˜„ì¬**:
```typescript
const supabase = createClientSupabase() // ì‹±ê¸€í„´ì´ë¯€ë¡œ ì•ˆì „í•˜ì§€ë§Œ ëª…ì‹œì ì´ì§€ ì•ŠìŒ
```

**ê¶Œì¥**:
```typescript
const supabase = useMemo(() => createClientSupabase(), []) // ëª…ì‹œì  ê³ ì •
```

**ìš°ì„ ìˆœìœ„**: ë‚®ìŒ (ì‹±ê¸€í„´ íŒ¨í„´ìœ¼ë¡œ ì´ë¯¸ í•´ê²°ë¨)

---

## ğŸ”´ í˜„ì¬ ë°œìƒ ì¤‘ì¸ ë¬¸ì œ ë¶„ì„

### ë¬¸ì œ: "êµ¬ë… ì„±ê³µ â†’ ë°”ë¡œ í•´ì œ â†’ CLOSED â†’ ì¬ì‹œë„" ë¬´í•œ ë°˜ë³µ

**ì›ì¸ ë¶„ì„**:

1. **Chat ì»´í¬ë„ŒíŠ¸ ì¤‘ë³µ ë§ˆìš´íŠ¸** (ê°€ì¥ ê°€ëŠ¥ì„± ë†’ìŒ)
   - ëª¨ë°”ì¼/ë°ìŠ¤í¬í†±ì—ì„œ ê°ê° Chat ì»´í¬ë„ŒíŠ¸ê°€ ë Œë”ë§ë¨
   - ë‘ ì¸ìŠ¤í„´ìŠ¤ê°€ ê°ê° Realtime êµ¬ë…ì„ ì‹œë„
   - í•˜ë‚˜ê°€ ì–¸ë§ˆìš´íŠ¸ë˜ë©´ cleanupì´ ì‹¤í–‰ë˜ì–´ ë‹¤ë¥¸ ìª½ì—ë„ ì˜í–¥
   - `reconnectTriesRef.current`ê°€ 3íšŒ ì´ìƒ ê³„ì† ì¦ê°€í•˜ëŠ” ë¬¸ì œ

2. **ì¬ì—°ê²° ë¡œì§ ë¬¸ì œ**
   - 3íšŒ ì‹¤íŒ¨ í›„ì—ë„ ì¬ì—°ê²° ì‹œë„ê°€ ê³„ì† ë°œìƒ
   - `reconnectTriesRef.current >= 3 && fallbackOn` ì²´í¬ê°€ ìˆì§€ë§Œ, `fallbackOn` ìƒíƒœê°€ ì—…ë°ì´íŠ¸ë˜ê¸° ì „ì— ì¬ì—°ê²°ì´ ì‹œë„ë  ìˆ˜ ìˆìŒ

3. **í´ë°± í´ë§ê³¼ Realtime êµ¬ë…ì˜ ì¶©ëŒ**
   - í´ë°± í´ë§ì´ í™œì„±í™”ë˜ë©´ Realtime êµ¬ë…ì„ ì¤‘ë‹¨í•´ì•¼ í•˜ëŠ”ë°, ì¬ì—°ê²° ì‹œë„ê°€ ê³„ì† ë°œìƒ

---

## ğŸ¯ ì¦‰ì‹œ ì ìš©í•´ì•¼ í•  ìˆ˜ì •ì‚¬í•­

### ìš°ì„ ìˆœìœ„ 1: Chat ì»´í¬ë„ŒíŠ¸ ë‹¨ì¼ ì¸ìŠ¤í„´ìŠ¤ ë³´ì¥

**íŒŒì¼**: `app/(webinar)/webinar/[id]/components/WebinarView.tsx`

```typescript
// Chat ì»´í¬ë„ŒíŠ¸ë¥¼ í•œ ë²ˆë§Œ ë Œë”ë§
const chatComponent = useMemo(() => (
  <Chat
    key={`chat-${webinar.id}`}
    webinarId={webinar.id}
    canSend={true}
    maxMessages={50}
    isAdminMode={isAdminMode}
  />
), [webinar.id, isAdminMode])

// ëª¨ë°”ì¼ê³¼ ë°ìŠ¤í¬í†±ì—ì„œ ê°™ì€ ì¸ìŠ¤í„´ìŠ¤ ì‚¬ìš©
{/* ëª¨ë°”ì¼ */}
<div className="lg:hidden">{chatComponent}</div>
{/* ë°ìŠ¤í¬í†± */}
<div className="hidden lg:block">{chatComponent}</div>
```

### ìš°ì„ ìˆœìœ„ 2: ì¬ì—°ê²° ë¡œì§ ê°œì„ 

**íŒŒì¼**: `components/webinar/Chat.tsx`

```typescript
// 3íšŒ ì‹¤íŒ¨ í›„ ì¬ì—°ê²° ì‹œë„ ì™„ì „ ì¤‘ë‹¨
if (reconnectTriesRef.current >= 3) {
  console.warn('ğŸ”´ ì‹¤ì‹œê°„ êµ¬ë… 3íšŒ ì‹¤íŒ¨, í´ë°± í´ë§ í™œì„±í™” (ì¬ì—°ê²° ì¤‘ë‹¨)')
  setFallbackOn(true)
  
  // ì¬ì—°ê²° íƒ€ì´ë¨¸ ì™„ì „ ì¤‘ë‹¨
  if (reconnectTimeoutRef.current) {
    clearTimeout(reconnectTimeoutRef.current)
    reconnectTimeoutRef.current = null
  }
  
  // í´ë°± ëª¨ë“œì—ì„œëŠ” ì¬ì—°ê²°ì„ ë” ì´ìƒ ì‹œë„í•˜ì§€ ì•ŠìŒ
  // 60ì´ˆ í›„ì—ë§Œ í•œ ë²ˆ ì¬ì‹œë„
  if (!fallbackReconnectTimeoutRef.current) {
    fallbackReconnectTimeoutRef.current = setTimeout(() => {
      console.log('ğŸ”„ í´ë°± ëª¨ë“œì—ì„œ ì¬ì—°ê²° ì‹œë„ (60ì´ˆ í›„)')
      reconnectTriesRef.current = 0
      setFallbackOn(false)
      setReconnectKey(prev => prev + 1)
      fallbackReconnectTimeoutRef.current = null
    }, 60000)
  }
  return // ì¬ì—°ê²° ì‹œë„ ì™„ì „ ì¤‘ë‹¨
}
```

### ìš°ì„ ìˆœìœ„ 3: useMemoë¡œ Supabase í´ë¼ì´ì–¸íŠ¸ ëª…ì‹œì  ê³ ì • (ì„ íƒì‚¬í•­)

**íŒŒì¼**: `components/webinar/Chat.tsx`

```typescript
const supabase = useMemo(() => createClientSupabase(), [])
```

---

## ğŸ“‹ ì ìš© ì²´í¬ë¦¬ìŠ¤íŠ¸

- [x] Supabase í´ë¼ì´ì–¸íŠ¸ ì‹±ê¸€í„´ ë³´ì¥ (`lib/supabase/client.ts`)
- [x] useEffect dependencyì—ì„œ `supabase` ì œê±° (`components/webinar/Chat.tsx`)
- [x] ì¬ì—°ê²° íƒ€ì´ë¨¸/í´ë°± íƒ€ì´ë¨¸ refë¡œ ê´€ë¦¬ ë° cleanup
- [x] ê¸°ì¡´ ì±„ë„ ì •ë¦¬ await ë³´ì¥
- [x] ì¬ì—°ê²° ì‹œ ì±„ë„ ì •ë¦¬í•˜ì§€ ì•Šê³  ìƒíƒœë§Œ ë³€ê²½
- [x] í´ë°± í´ë§ íƒ€ì´ë¨¸ ì¶”ì  ë° cleanup
- [ ] **Chat ì»´í¬ë„ŒíŠ¸ ë‹¨ì¼ ì¸ìŠ¤í„´ìŠ¤ ë³´ì¥** (ìµœìš°ì„ )
- [ ] **ì¬ì—°ê²° ë¡œì§ ê°œì„ ** (3íšŒ ì‹¤íŒ¨ í›„ ì™„ì „ ì¤‘ë‹¨)
- [ ] useMemoë¡œ Supabase í´ë¼ì´ì–¸íŠ¸ ëª…ì‹œì  ê³ ì • (ì„ íƒì‚¬í•­)

---

## ğŸ¯ ì˜ˆìƒ íš¨ê³¼

1. **Chat ì»´í¬ë„ŒíŠ¸ ë‹¨ì¼ ì¸ìŠ¤í„´ìŠ¤**:
   - ì¤‘ë³µ êµ¬ë… ë°©ì§€
   - cleanup ì¶©ëŒ ë°©ì§€
   - "êµ¬ë… ì„±ê³µ â†’ ë°”ë¡œ í•´ì œ" ë£¨í”„ í•´ê²°

2. **ì¬ì—°ê²° ë¡œì§ ê°œì„ **:
   - 3íšŒ ì‹¤íŒ¨ í›„ ì¬ì—°ê²° ì‹œë„ ì™„ì „ ì¤‘ë‹¨
   - í´ë°± ëª¨ë“œì—ì„œ ì•ˆì •ì ì¸ í´ë§ ìœ ì§€
   - ë¶ˆí•„ìš”í•œ ì¬ì—°ê²° ì‹œë„ ë°©ì§€

---

## ğŸ“ ì°¸ê³ 

- `í•´ê²°ì±….md`: ì›ë³¸ í•´ê²°ì±… ë¬¸ì„œ
- `Realtime_ì—°ê²°_ëŠê¹€_ë¬¸ì œ_ë¶„ì„_ë³´ê³ ì„œ.md`: ìƒì„¸ ë¶„ì„ ë³´ê³ ì„œ
- `components/webinar/Chat.tsx`: í˜„ì¬ êµ¬í˜„ ì½”ë“œ
- `app/(webinar)/webinar/[id]/components/WebinarView.tsx`: Chat ì»´í¬ë„ŒíŠ¸ ì‚¬ìš© ìœ„ì¹˜

