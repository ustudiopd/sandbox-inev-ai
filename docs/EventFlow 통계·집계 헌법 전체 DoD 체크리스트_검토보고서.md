# EventFlow 통계·집계 헌법 전체 DoD 체크리스트 검토 보고서

**작성일**: 2026-02-03  
**검토 기준**: 실제 코드베이스 검증  
**상태**: ⚠️ **부분 완료 / 운영 리스크 있음**

---

## 📋 검토 방법론

1. **코드베이스 실제 구현 확인**
   - Visit 추적 구현 위치 확인
   - 집계 엔진 구현 확인
   - API 구조 확인
   - 로깅/모니터링 구현 확인

2. **DoD 항목별 실제 상태 판정**
   - ✅ YES: 구현 완료, 검증 가능
   - ⚠️ 부분: 구현은 되었으나 완전성/안정성 검증 필요
   - ❌ NO: 미구현 또는 구조적 문제

---

## 1️⃣ Fact 수집 계층 DoD 검토 결과

### 1-1. 핵심 경로 Visit 커버리지

| 항목 | 판정 | 검증 근거 | 비고 |
|------|------|----------|------|
| `/event/{path}` (Welcome/Landing) 진입 시 Visit가 **항상** 기록된다 | ✅ | `WelcomePage.tsx` (49-87줄)에서 Visit API 호출 구현됨 | |
| `/webinar/{id}` (정보 페이지) Visit가 기록된다 | ✅ | `WebinarEntry.tsx` (122-156줄), `WebinarView.tsx` (165-203줄)에서 Visit API 호출 구현됨 | |
| `/webinar/{id}/live` (라이브 시청) Visit가 기록된다 | ⚠️ | `WebinarView` 컴포넌트를 사용하므로 Visit 추적 가능하나, 라이브 페이지 자체에서 별도 Visit 기록이 필요한지 명확하지 않음 | 라이브 페이지는 `WebinarView`를 렌더링하므로 Visit 추적은 가능하지만, 라이브 시청을 별도 이벤트로 기록할지 결정 필요 |
| 등록/라이브 UX는 Visit 실패와 **완전히 분리**되어 있다 (non-blocking) | ✅ | 모든 Visit API 호출이 `.catch()`로 처리되어 graceful failure 구현됨 | |

**1-1 판정**: ⚠️ **부분 완료** (라이브 페이지 Visit 기록 정책 명확화 필요)

---

### 1-2. Dimension(차원) 의존성 방어

| 항목 | 판정 | 검증 근거 | 비고 |
|------|------|----------|------|
| CID/링크/UTM 메타가 없어도 Visit Fact는 저장된다 | ✅ | `visit/route.ts` (156-184줄)에서 cid lookup 실패 시에도 Visit 저장 계속 진행 | `cidLookupFailed` 플래그로 추적하되 저장은 계속 |
| 차원 부재 시 `unknown / unresolved`로 흡수된다 | ✅ | UTM은 `normalizeUTM`으로 정규화, cid는 null로 저장, 집계 시 `__null__`로 그룹핑 | |
| 차원 테이블 누락으로 Visit가 0이 되는 구조가 아니다 | ✅ | `visit/route.ts`에서 차원 lookup 실패해도 Visit 저장은 성공 | |
| Fact 저장 실패가 UX/등록 흐름으로 전파되지 않는다 | ✅ | 모든 Visit API 호출이 fire-and-forget 방식, `.catch()`로 처리 | |

**1-2 판정**: ✅ **완료**

---

### 1-3. 장애 가시성

| 항목 | 판정 | 검증 근거 | 비고 |
|------|------|----------|------|
| Visit 실패 시 **구조화 로그(JSON)** 가 남는다 | ✅ | `visit/route.ts`에서 `[VisitTrackFail]` JSON 로그 구현됨 (41, 77, 254, 289, 303줄) | |
| 성공 로그는 운영 환경에서 폭주하지 않는다 | ✅ | 성공 시 일반 로그 없음, `[VisitTrackDimension]` 로그만 차원 부재 시 기록 (274-284줄) | |
| "오늘 Visit 0" 같은 상태를 **로그로 사후 추적 가능** | ⚠️ | `[VisitTrackFail]` 로그는 있으나, "Visit 0" 상태를 자동으로 감지하는 모니터링 시스템은 없음 | 로그는 있지만 집계/알림 시스템 없음 |

**1-3 판정**: ⚠️ **부분 완료** (모니터링/알림 시스템 미구현)

---

## 2️⃣ 데이터 품질 DoD 검토 결과

### 2-1. session_id 연결 규칙

| 항목 | 판정 | 검증 근거 | 비고 |
|------|------|----------|------|
| 모든 Visit에 session_id가 저장된다 | ✅ | `visit/route.ts` (67-89줄)에서 session_id 필수 검증, 쿠키 fallback 구현 | |
| 모든 등록(entry)에 session_id가 저장된다 | ⚠️ | 등록 API에서 session_id 전달은 가능하나, 필수 여부 확인 필요 | 코드 확인 필요 |
| session_id는 서버 기준으로 보강된다 (쿠키 fallback) | ✅ | `visit/route.ts` (70-88줄)에서 쿠키에서 session_id 읽기 구현 | |
| Visit ↔ Entry 연결률을 계산할 수 있다 | ⚠️ | session_id로 연결 가능하나, 실제 연결률 계산 쿼리/지표는 확인 필요 | |

**2-1 판정**: ⚠️ **부분 완료** (등록 시 session_id 저장 필수 여부 및 연결률 지표 확인 필요)

---

### 2-2. UTM / 유입 정보 보존

| 항목 | 판정 | 검증 근거 | 비고 |
|------|------|----------|------|
| first-touch UTM 규칙이 정의되어 있다 | ✅ | `event_survey_entries` 테이블에 `utm_first_visit_at`, `utm_referrer` 필드 존재 (마이그레이션 063) | |
| last-touch UTM 규칙이 정의되어 있다 | ✅ | `RegistrationPage.tsx` (66줄)에서 localStorage에 last-touch 정책으로 저장, 등록 시 전달 | |
| 리다이렉트/CSR에서도 UTM이 유실되지 않는다 | ⚠️ | localStorage로 보존하나, 리다이렉트 시 UTM 유실 가능성 있음 (쿠키/서버 세션 미사용) | |
| UTM 누락 비율을 지표로 확인할 수 있다 | ⚠️ | UTM null 비율 계산은 가능하나, 별도 지표/대시보드는 확인 필요 | |

**2-2 판정**: ⚠️ **부분 완료** (리다이렉트 시 UTM 보존 및 누락 비율 지표 확인 필요)

---

## 3️⃣ Aggregation Engine DoD 검토 결과

### 3-1. 집계 실행 위치

| 항목 | 판정 | 검증 근거 | 비고 |
|------|------|----------|------|
| 참가자/라이브 페이지에서 집계 쿼리를 실행하지 않는다 | ✅ | 집계는 모두 `aggregate-marketing-stats` cron job에서 실행 | |
| 집계는 cron/백그라운드에서만 수행된다 | ✅ | `vercel.json`에서 5분마다 cron 실행 설정, `aggregate-marketing-stats/route.ts` 구현 | |
| 집계 job은 **멱등(idempotent)** 이다 | ✅ | `marketing_stats_daily` 테이블에 유니크 제약조건 기반 upsert 구현 | |
| 동일 기간 재실행(backfill)이 가능하다 | ✅ | `aggregate-marketing-stats/route.ts` (21-25줄)에서 `fromDate`, `toDate` 파라미터 지원, `run-aggregation.ts` 스크립트 존재 | |

**3-1 판정**: ✅ **완료**

---

### 3-2. 집계 구조

| 항목 | 판정 | 검증 근거 | 비고 |
|------|------|----------|------|
| 웨비나 접속 통계는 v2 패턴(핑 + 크론 + 버킷)을 따른다 | ✅ | `webinar-access-snapshot` cron (1분마다), `webinar_stats_v2` 테이블 존재 | |
| 마케팅/캠페인 통계도 동일한 패턴을 따른다 | ✅ | `aggregate-marketing-stats` cron (5분마다), `marketing_stats_daily` 테이블 존재 | |
| raw vs aggregate 값이 샘플 기간에서 일치한다 | ⚠️ | 검증 스크립트/테스트는 확인 필요 | `check-aggregation-status.ts` 스크립트는 있으나 자동 검증은 불명확 |
| aggregate가 없을 경우 raw fallback이 동작한다 | ✅ | `overview/route.ts` (137-183줄)에서 aggregate 없을 시 raw 데이터 fallback 구현 | |

**3-2 판정**: ⚠️ **부분 완료** (raw vs aggregate 일치 검증 자동화 필요)

---

### 3-3. Materialized View 사용 판단

| 항목 | 판정 | 검증 근거 | 비고 |
|------|------|----------|------|
| MV 사용 여부가 "선택 기준 문서"로 고정되어 있다 | ❌ | MV 사용 여부에 대한 명시적 문서/기준 확인 불가 | |
| refresh 실패/지연이 운영에서 감지 가능하다 | ❌ | MV 사용 여부가 불명확하므로 refresh 감지도 불명확 | |
| staleness(지연 허용 범위)가 합의되어 있다 | ❌ | MV 사용 여부가 불명확하므로 staleness 정책도 불명확 | |
| 기본값은 증분 집계 테이블이다 | ✅ | `marketing_stats_daily`, `webinar_stats_v2` 등 증분 집계 테이블 사용 | |

**3-3 판정**: ❌ **미완** (MV 사용 여부 및 기준 문서화 필요)

---

## 4️⃣ Admin / Overview API DoD 검토 결과

### 4-1. API 구조

| 항목 | 판정 | 검증 근거 | 비고 |
|------|------|----------|------|
| 통합 Overview API가 존재한다 | ✅ | `clients/[clientId]/statistics/overview/route.ts` 구현됨 | |
| aggregate 우선 + raw fallback 구조다 | ✅ | `overview/route.ts` (109-183줄)에서 aggregate 조회 후 fallback 구현 | |
| 부분 실패 시에도 전체 응답이 깨지지 않는다 | ✅ | `Promise.all` 사용하나 각 함수에서 에러 처리하여 부분 실패 시에도 응답 반환 | |
| response에 메타데이터(response_time, source 등)가 포함된다 | ✅ | `overview/route.ts` (51-89줄)에서 `response_time_ms`, `data_sources` 등 메타데이터 포함 | |

**4-1 판정**: ✅ **완료**

---

### 4-2. 성능/운영

| 항목 | 판정 | 검증 근거 | 비고 |
|------|------|----------|------|
| 기본 기간(7/30일) 조회가 목표 응답시간 내다 | ⚠️ | 응답 시간 측정은 있으나, 목표 시간 기준/모니터링은 확인 필요 | |
| aggregate 미존재 시 fallback 빈도를 파악할 수 있다 | ✅ | `data_sources` 메타데이터에 'aggregated'/'raw'/'error' 포함 | |
| 대시보드 조회가 raw full-scan에 의존하지 않는다 | ✅ | aggregate 테이블 우선 사용, fallback 시에도 인덱스 활용 가능 | |

**4-2 판정**: ⚠️ **부분 완료** (목표 응답시간 기준 및 모니터링 필요)

---

## 5️⃣ 운영 안정성 DoD 검토 결과

| 항목 | 판정 | 검증 근거 | 비고 |
|------|------|----------|------|
| "오늘 Visit 0" 상태를 **자동 또는 즉시 인지**할 수 있다 | ❌ | 자동 감지/알림 시스템 없음, 로그만 존재 | |
| 집계 실패/지연을 알 수 있는 로그 또는 알림이 있다 | ⚠️ | 집계 로그는 있으나 (`[AggregateMarketingStats]`), 알림 시스템은 없음 | |
| 특정 날짜/캠페인 재집계(backfill) 절차가 문서화돼 있다 | ⚠️ | `run-aggregation.ts` 스크립트는 있으나, 절차 문서화는 불명확 | |
| 운영자가 "숫자가 이상할 때" 확인할 진단 루트가 있다 | ⚠️ | `check-aggregation-status.ts` 스크립트는 있으나, 체계적인 진단 가이드는 불명확 | |

**5️⃣ 판정**: ❌ **미완** (모니터링/알림 시스템 및 운영 절차 문서화 필요)

---

## 📊 최종 판정 요약

### 섹션별 완료도

| 섹션 | 완료 항목 | 부분 항목 | 미완 항목 | 완료도 |
|------|----------|----------|----------|--------|
| 1️⃣ Fact 수집 계층 | 4 | 2 | 0 | 67% |
| 2️⃣ 데이터 품질 | 1 | 3 | 0 | 25% |
| 3️⃣ Aggregation Engine | 4 | 2 | 3 | 44% |
| 4️⃣ Admin / Overview API | 4 | 1 | 0 | 80% |
| 5️⃣ 운영 안정성 | 0 | 2 | 2 | 0% |
| **전체** | **13** | **10** | **5** | **46%** |

### 최종 판정: ⚠️ **Phase2 완료 / 시스템 전체 미완**

**근거**:
- ✅ **4️⃣ Admin / Overview API**: 대부분 완료 (80%)
- ⚠️ **1️⃣ Fact 수집 계층**: 대부분 완료이나 일부 검증 필요 (67%)
- ⚠️ **3️⃣ Aggregation Engine**: 핵심 기능은 완료이나 MV 정책 및 검증 필요 (44%)
- ⚠️ **2️⃣ 데이터 품질**: 구현은 되었으나 완전성 검증 필요 (25%)
- ❌ **5️⃣ 운영 안정성**: 모니터링/알림 시스템 미구현 (0%)

---

## 🎯 완료 선언까지 남은 최소 작업 (P0/P1)

### P0 (운영 리스크 해결 - 필수)

1. **라이브 페이지 Visit 추적 정책 명확화**
   - `/webinar/{id}/live`에서 Visit 기록 여부 결정
   - 현재는 `WebinarView`를 통해 간접 추적되나, 라이브 시청을 별도 이벤트로 기록할지 결정 필요

2. **등록 시 session_id 저장 필수화**
   - 등록 API에서 session_id 필수 여부 확인 및 강제
   - Visit ↔ Entry 연결률 계산 쿼리/지표 구현

3. **모니터링/알림 시스템 구축**
   - "오늘 Visit 0" 자동 감지 및 알림
   - 집계 실패/지연 알림
   - 목표: 운영자가 수동 확인 없이 문제 인지 가능

### P1 (안정성 강화 - 권장)

4. **Materialized View 사용 정책 문서화**
   - MV 사용 여부 결정 기준 문서화
   - 사용 시 refresh 실패/지연 감지 방법 정의

5. **Raw vs Aggregate 일치 검증 자동화**
   - 정기적으로 raw 데이터와 aggregate 데이터 일치 여부 검증
   - 불일치 시 알림

6. **운영 절차 문서화**
   - Backfill 절차 상세 문서화
   - 진단 루트 체계화 (문제 발생 시 확인 순서)

7. **UTM 보존 강화**
   - 리다이렉트 시 UTM 유실 방지 (쿠키/서버 세션 고려)
   - UTM 누락 비율 모니터링 지표 추가

---

## 📝 개선 제안

### 문서 개선

1. **체크리스트 항목 구체화**
   - 각 항목에 "검증 방법" 추가
   - 예: "Visit 실패 시 구조화 로그가 남는다" → "Vercel Logs에서 `[VisitTrackFail]` 검색 가능"

2. **판정 기준 명확화**
   - "부분 완료"와 "완료"의 경계 명확화
   - 예: "구현은 되었으나 검증 필요" vs "구현 및 검증 완료"

3. **운영 가이드 추가**
   - 각 DoD 항목이 운영에 미치는 영향 설명
   - 문제 발생 시 대응 방법 추가

### 코드 개선

1. **라이브 페이지 Visit 추적 명확화**
   - 라이브 페이지에서 별도 Visit 기록 여부 결정
   - 필요 시 `WebinarView`에 라이브 모드 플래그 추가

2. **모니터링 시스템 구축**
   - Vercel Cron으로 일일 Visit 수 체크
   - 집계 실패 감지 및 알림 (Sentry 등)

3. **검증 자동화**
   - CI/CD에 raw vs aggregate 일치 검증 추가
   - 정기적으로 실행되는 검증 스크립트

---

## ✅ 결론

현재 상태는 **"아키텍처는 완성됐고, 구현은 Phase2까지 끝났지만, 운영 기준으로 '완료 선언'은 아직이다"**는 원래 판단이 정확합니다.

**핵심 이슈**:
- 운영 안정성 (5️⃣)이 0%로 가장 취약
- 데이터 품질 (2️⃣) 검증 필요
- 모니터링/알림 시스템 부재

**권장 조치**:
1. P0 작업 3개 우선 완료 (운영 리스크 해결)
2. P1 작업 4개 단계적 완료 (안정성 강화)
3. 완료 후 이 체크리스트로 재검증
