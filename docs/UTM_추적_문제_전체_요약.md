# UTM 추적 문제 전체 요약

**작성일**: 2026-02-02  
**상태**: 원인 규명 완료, 구조적 개선 필요

---

## 📌 핵심 결론 (한 줄)

> **"Direct 159 / keywert 1"은 UTM 저장 문제가 아니라,
> `marketing_campaign_link_id` 자체가 저장되지 않은 유입이 대량 존재해서 발생한 집계 오류다.**
> → 복원은 불가능, **원인 규명 + 집계 로직 보정**이 필요하다.

---

## 🔍 문제 현황

### 팩트 확인 결과

- **전체 등록**: 529개
- **Direct (추적 없음)**: 528개 (99.8%)
- **링크+UTM 있음**: 1개 (0.2%)
- **UTM Source**: "keywert" 1개만

### 의미

- 링크를 통해 들어온 유입의 **99.8%가 추적 실패**
- `marketing_campaign_link_id`가 저장되지 않은 경우가 대부분
- 복원 스크립트로는 해결 불가 (복원 대상이 없음)

---

## 🎯 원인 분석

### 원인 A: 링크 인식 실패 (가장 유력) ✅

**문제**: 링크를 통해 들어왔지만 `marketing_campaign_link_id`가 저장되지 않음

**발생 경로**:
```
사용자 클릭 → Short-link → 리다이렉트 → 등록 페이지 → API 호출
                                    ↓
                            cid/utm 파라미터 유실
                                    ↓
                        marketing_campaign_link_id = null
```

**원인**:
- 리다이렉트 과정에서 쿼리 파라미터 유실
- 서버 세션 부재로 정보 보존 실패
- URL 파라미터에만 의존하는 구조적 한계

### 원인 B: Short-link 리다이렉트 파라미터 유실

Next.js `redirect()` 사용 시 쿼리 파라미터 전달 누락 가능

### 원인 C: 실제 Direct 유입 (가능성 낮음)

북마크, 직접 입력 등 (비율상 거의 배제)

---

## ✅ 해결 방안

### 1. 즉시 조치: 집계 보정

**목적**: 현재 데이터를 올바르게 표시

**방법**:
- DB 수정 없이 집계 시점에만 보정
- "Direct (no tracking)" 라벨로 구분
- 추적 성공률 메타데이터 추가

**문서**: [집계 API 보정 로직 명세](./집계_API_보정_로직_명세.md)

### 2. 구조적 개선: 추적 시스템 강화

**목적**: 재발 방지

**방법**:
1. **서버 세션 고정**: Middleware에서 추적 정보 저장
2. **다중 소스 복원**: URL > Cookie > Link 순서로 복원
3. **추적 스냅샷 저장**: 원본 정보 보존 (향후 복원/디버깅용)

**문서**: [링크 추적 구조 개선 방안](./링크_추적_구조_개선_방안.md)

---

## 📋 실행 계획

### Phase 1: 집계 보정 (즉시)

- [ ] 집계 API에 추적 상태 메타데이터 추가
- [ ] UI에 "Direct (no tracking)" 라벨 표시
- [ ] 추적 성공률 표시 추가

**예상 소요**: 1-2일

### Phase 2: 구조적 개선 (1주 내)

- [ ] `tracking_snapshot` 컬럼 추가
- [ ] Middleware에서 서버 세션 관리 구현
- [ ] 등록 API에서 다중 소스 복원 로직 구현
- [ ] Short-link 리다이렉트 개선

**예상 소요**: 1주

### Phase 3: 모니터링 및 검증 (2주 내)

- [ ] 추적 성공률 모니터링 대시보드
- [ ] `tracking_snapshot` 데이터 검증
- [ ] 실제 추적 성공률 확인 (목표: 95%+)

**예상 소요**: 1주

---

## 📊 예상 효과

### Before (현재)

- 추적 성공률: **0.2%** (1/529)
- Direct 오분류: **99.8%**

### After (개선 후)

- 추적 성공률: **95%+** (예상)
- Direct 오분류: **5% 미만** (예상)

---

## 📚 관련 문서

1. [UTM 추적 문제 원인 규명 및 해결방안](./UTM_추적_문제_원인_규명_및_해결방안.md)
   - 문제 원인 상세 분석
   - 팩트 확인 쿼리
   - 복원 가능성 검토

2. [링크 추적 구조 개선 방안](./링크_추적_구조_개선_방안.md)
   - 구조적 개선 명세
   - 구현 코드 예시
   - 마이그레이션 계획

3. [집계 API 보정 로직 명세](./집계_API_보정_로직_명세.md)
   - 집계 보정 방법
   - UI 표시 방법
   - 구현 코드 예시

4. [UTM 파라미터 복원 스크립트 명세서](./UTM_파라미터_복원_스크립트_명세서.md)
   - 복원 스크립트 사용법
   - 기술적 상세
   - 트러블슈팅

---

## 🎯 다음 단계

1. ✅ **원인 규명 완료**: 팩트 확인 쿼리 실행 완료
2. ⏳ **집계 보정 구현**: 즉시 시작 가능
3. ⏳ **구조적 개선**: 1주 내 시작
4. ⏳ **모니터링**: 2주 내 완료

---

## 💡 핵심 메시지

> **이건 데이터 복원 문제가 아니라 "링크 추적이 중간에서 끊긴 사건"이다.**
> 
> 지금 데이터는 **분리해서 설명하고**,
> 구조를 고치지 않으면 **다음 캠페인도 100% 다시 터진다.**
