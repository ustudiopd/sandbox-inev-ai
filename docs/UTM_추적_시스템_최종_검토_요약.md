# UTM 추적 시스템 최종 검토 요약

**작성일**: 2026-02-02  
**검토 상태**: 추가 검토 완료, 구현 준비 완료  
**우선순위**: 🔴 긴급

---

## 📌 검토 결과 요약

### ✅ 검토 완료 사항

1. **사건 정의 정확성**: "UTM이 없어서가 아니라 링크 추적이 리다이렉트/세션 부재로 중간에서 끊긴 구조적 결함"으로 정확히 정의됨
2. **숫자 뒷받침**: 추적 성공률 0.2%, 링크 생성 이후 등록 122개 중 추적 성공 1개(0.8%)로 가설 확정
3. **개선 로드맵**: Phase 1~3 구성이 방향적으로 올바름
4. **패치 반영**: 핵심 리스크(쿠키 오귀속, 서명 방식, 성공률 정의) 보강 완료

---

## 🔴 추가 결정 포인트 (패치 2탄)

### 1. 성공 정의의 단계별 정합성

**문제**: Phase 1~2 성공 정의에 `tracking_snapshot` 포함 시 타이밍 충돌

**해결**:
- **Phase 1~2**: `marketing_campaign_link_id` OR `utm_source` OR (cookie/cid resolve)
- **Phase 3 이후**: 위 조건 + `tracking_snapshot.cid` + 캠페인 매칭

### 2. Cookie TTL vs Trust Window 구분

**문제**: Cookie "30일 유효"와 `COOKIE_TRUST_WINDOW_HOURS`(24시간) 혼동 가능

**해결**:
- **TTL (보관기간)**: `COOKIE_TTL_DAYS` (기본값: 30일) - 디버깅/편의성
- **Trust Window (귀속 허용창)**: `COOKIE_TRUST_WINDOW_HOURS` (기본값: 24시간) - 오귀속 방지

### 3. UTM과 cid 충돌 규칙

**문제**: URL에 UTM이 있는데 cid가 다른 캠페인을 가리키는 경우 처리 규칙 없음

**해결**:
- UTM이 있으면 UTM을 우선 진실로 사용
- cid는 "링크 식별 보조"로만 사용
- cid가 다른 캠페인을 가리키면: UTM은 저장, link_id는 저장하지 않음, `untracked_reason = 'cid_campaign_mismatch'` 기록

### 4. Visit 추적을 Phase 2 성공조건에서 제외

**문제**: Visit 추적이 Phase 2 성공조건에 포함되면 안 됨

**해결**:
- UTM 집계 정상화의 핵심은 **등록 시점에 tracking 저장**
- Visit 추적은 퍼널/CVR 목적일 때만 투자 가치 있음

---

## 📊 사건 재구성 (2026-02-02)

### 시간대별 등록 패턴

- **오전 9시**: 약 92개 등록
- **오전 9시 이후**: 160개로 폭증 (약 68개 추가)
- **폭증 시간대**: 오전 10시대 집중

### 링크 생성 시점

- 링크 생성: 2026-01-29 ~ 2026-01-30 (16개 활성 링크)
- "광고메일" 링크 포함 추정

### 추정 근거

1. **시간 집중**: 오전 10시대 급격한 증가 (이메일 발송 타이밍과 일치)
2. **링크 생성 시점 일치**: 링크 생성 이후 등록 폭증
3. **추적 실패 패턴**: 링크는 사용되었지만 추적 정보 미저장

### 결론

이메일 캠페인(stibee 광고메일 링크) 발송 후 유입이 발생했으나, 리다이렉트/세션 부재로 추적 정보가 저장되지 않음

---

## 🎯 우선순위 재정렬 (실행 순서)

### 크리티컬 패스 (성패 좌우)

1. **Phase 2.3 Short-link 리다이렉트에서 query 보존** (최우선)
2. **Phase 2.1 서버 세션/쿠키 저장** (혹은 proxy)
3. **Phase 2.2 register에서 다중 복원 + cookie 가드**
4. **Phase 1 집계 UI 보정** (병행 가능하지만, 근본 해결은 2번~3번)

**이유**: 지금은 "표시를 예쁘게" 하기 전에 **저장 자체가 안 되는 상태**라서

---

## 🎯 최종 DoD 판정 기준

다음 4가지 시나리오로 "집계 정상" 판정:

### 시나리오 1: UTM 링크로 들어와 등록
- **기대**: `utm_source`가 저장되고 Source 집계에 잡힘
- **판정**: ✅ 성공

### 시나리오 2: cid 짧은 링크로 들어와 등록 (UTM 없음)
- **기대**: `marketing_campaign_link_id` 또는 최소한 추적 근거가 저장 (Direct로만 떨어지지 않음)
- **판정**: ✅ 성공

### 시나리오 3: /s/[code] 경유 후 등록
- **기대**: query 보존 + cookie/session 보존으로 추적 저장 성공
- **판정**: ✅ 성공

### 시나리오 4: 아무 파라미터 없는 진짜 Direct
- **기대**: "Direct (no tracking)"로 분리 표기되고 tracking_success_rate 계산에 반영
- **판정**: ✅ 성공 (정상 동작)

---

## 📋 구현 전 필수 확인사항

### 기본 결정 포인트
1. [ ] Cookie 복원 적용 조건 (캠페인 매칭 + 시간 창 검증)
2. [ ] Cookie 서명 방식 (서명 vs DB 검증)
3. [ ] Middleware/Proxy 선택 (Next.js 버전 확인)
4. [ ] Visit 추적 필요성 결정
5. [ ] 추적 성공률 정의 명확화 (Phase 1~2 vs Phase 3)
6. [ ] Referer/UA 처리 정책

### 추가 결정 포인트 (패치 2탄)
7. [ ] **성공 정의의 단계별 정합성**: Phase 1~2는 tracking_snapshot 제외
8. [ ] **Cookie TTL vs Trust Window 구분**: TTL(30일) vs Trust Window(24시간)
9. [ ] **UTM과 cid 충돌 규칙**: UTM 우선, cid는 보조 식별자로만
10. [ ] **Visit 추적을 Phase 2 성공조건에서 제외**: 등록 시점 tracking만으로 충분
11. [x] **웨비나 등록과 Visit 추적 분리 확인**: 현재 구현 안전 확인 완료 (추가 작업 불필요)

---

## 📚 관련 문서

### 필수 확인 문서 (구현 전)
1. [UTM 추적 시스템 개선 위험요소 및 결정사항](./UTM_추적_시스템_개선_위험요소_및_결정사항.md)
2. [체크리스트 추가 항목 패치 2탄](./체크리스트_추가_항목_패치_2탄.md)
3. [웨비나 등록 Visit 추적 안전장치](./웨비나_등록_Visit_추적_안전장치.md) - ⚠️ 웨비나 등록 관련 우려 해소

### 참고 문서
4. [UTM 추적 시스템 문제점 및 개선사항 종합보고서](./UTM_추적_시스템_문제점_및_개선사항_종합보고서.md)
5. [UTM 추적 시스템 개선 작업 체크리스트](./UTM_추적_시스템_개선_작업_체크리스트.md)
6. [체크리스트 추가 항목 패치](./체크리스트_추가_항목_패치.md)
7. [Visit 추적 회귀 방지 장치](./Visit_추적_회귀_방지_장치.md)

---

## ✅ 종합 판정

### 방향/구성/리스크 인식
- ✅ **방향/구성/리스크 인식까지 다 맞다**
- ✅ **패치(추가 항목)가 "재발 방지에 필요한 최소 조건"을 정확히 넣었다**

### 추가 고정 필요 사항
- ⚠️ **(1) 성공 정의의 단계별 정합성(Phase1 vs Phase3)**
- ⚠️ **(2) TTL vs Trust window**
- ⚠️ **(3) UTM+cid 충돌 규칙**

**결론**: 이 3개만 고정하면 "실무에서 흔들리지 않는 설계"가 됨

---

## 🚀 다음 단계

1. ✅ **원인 규명 완료**: 팩트 확인 및 분석 완료
2. ✅ **사건 재구성 완료**: 10시 폭증 + stibee 광고메일 링크 추정
3. ✅ **위험 요소 검토 완료**: 핵심 리스크 보강 완료
4. ✅ **추가 결정 포인트 명세 완료**: 패치 2탄 작성 완료
5. ⏳ **구현 시작**: 위 10가지 결정 포인트 확인 후 진행

---

**마지막 업데이트**: 2026-02-02  
**검토 상태**: 추가 검토 반영 완료, 구현 준비 완료
