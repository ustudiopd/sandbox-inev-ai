# 서버 장애 분석 보고서

**일시**: 2026년 2월 6일 14:00-15:00 (KST)  
**분석 일시**: 2026년 2월 6일  
**프로젝트**: EventLive (Supabase Project: yqsayphssjznthrxpgfb)

---

## 📋 요약

2026년 2월 6일 오후 2시부터 3시 사이에 서버 접속이 폭주하여 Supabase 데이터베이스 한도 초과 및 성능 저하가 발생했습니다. 주요 웨비나 "AI 특허리서치 실무 활용 웨비나"에서 최대 **311명의 동시 접속자**가 발생하여 시스템 리소스 한계에 도달했습니다.

**대응 조치**: Supabase 한도 상향 및 컴퓨트 사양 변경 완료

---

## 📊 접속자 통계

### 1. 주요 웨비나별 접속 현황

#### 웨비나 1: "AI 특허리서치 실무 활용 웨비나"
- **웨비나 ID**: `f257ce42-723a-4fad-a9a5-1bd8c154d7ce`
- **최대 동시 접속자**: **311명** (14:40 KST / 05:40 UTC)
- **평균 최대 동시 접속자**: 약 181명
- **총 고유 사용자**: 141명
- **등록 건수**: 176건
- **시간대별 접속자 추이**:

| 시간대 (KST) | 최대 접속자 | 최소 접속자 | 샘플 수 |
|------------|-----------|-----------|---------|
| 14:00-14:05 | 244명 | 214명 | 19 |
| 14:05-14:10 | **299명** | 226명 | 33 |
| 14:10-14:15 | 264명 | 147명 | 18 |
| 14:15-14:20 | 47명 | 47명 | 1 |
| 14:20-14:25 | 27명 | 27명 | 1 |
| 14:25-14:30 | 36명 | 36명 | 1 |
| 14:30-14:35 | 82명 | 2명 | 3 |
| 14:35-14:40 | 135명 | 135명 | 1 |
| 14:40-14:45 | **311명** | 88명 | 12 |
| 14:45-14:50 | 253명 | 209명 | 20 |
| 14:50-14:55 | 235명 | 198명 | 22 |
| 14:55-15:00 | 235명 | 199명 | 23 |

#### 웨비나 2: "[테스트] 149400 웨비나"
- **웨비나 ID**: `c9c7d93a-d775-4f8e-9243-8fdbb3618e2a`
- **최대 동시 접속자**: 2명
- **총 고유 사용자**: 2명
- **등록 건수**: 1건

### 2. 전체 통계 요약

- **총 동시 접속 피크**: 311명 (14:40 KST)
- **총 고유 접속자**: 143명
- **총 등록 건수**: 177건
- **주요 접속 시간대**: 14:05-14:10, 14:40-14:45

---

## 🔍 장애 원인 분석

### 1. 데이터베이스 에러

#### 1.1 중복 키 위반 (Duplicate Key Violations)
- **에러 유형**: `duplicate key value violates unique constraint "registrations_pkey"`
- **발생 빈도**: 매우 높음 (수십 건)
- **원인**: 동시에 많은 사용자가 동일한 웨비나에 등록을 시도하면서 중복 등록 방지 로직이 충돌
- **영향**: 일부 사용자의 등록 실패

#### 1.2 컬럼 조회 에러
- **에러 유형**: `column registrations.id does not exist`
- **발생 빈도**: 높음
- **원인**: 잘못된 쿼리 또는 스키마 불일치 가능성
- **영향**: API 요청 실패 (400 에러)

#### 1.3 마케팅 통계 중복 키 에러
- **에러 유형**: `duplicate key value violates unique constraint "uq_marketing_stats_daily_key"`
- **발생 빈도**: 높음
- **원인**: 동시에 여러 요청이 동일한 일별 통계 레코드를 생성하려고 시도
- **영향**: 통계 집계 실패

#### 1.4 UUID 형식 에러
- **에러 유형**: `invalid input syntax for type uuid: "null"`
- **발생 빈도**: 중간
- **원인**: NULL 값이 UUID 타입 컬럼에 전달됨
- **영향**: 데이터 삽입 실패

### 2. Realtime 연결 불안정

- **증상**: 다수의 `Postgrex.Protocol disconnected` 에러 발생
- **에러 메시지**: `DBConnection.ConnectionError) client #PID<...> exited`
- **발생 빈도**: 매우 높음 (수십 건)
- **원인**: 
  - 데이터베이스 연결 풀 한도 초과
  - 과도한 동시 연결 요청
  - 서버 리소스 부족
- **영향**: 실시간 기능(채팅, 질문 등) 일시적 중단

### 3. API 요청 폭주

- **주요 요청 유형**:
  - `/rest/v1/profiles` - 사용자 프로필 조회 (매우 빈번)
  - `/rest/v1/questions` - 질문 목록 조회
  - `/rest/v1/webinars` - 웨비나 정보 조회
  - `/rest/v1/auth/v1/user` - 인증 확인
  - `/rest/v1/registrations` - 등록 처리
  - `/rest/v1/webinar_live_presence` - 실시간 접속 상태 업데이트

- **에러 응답**:
  - **409 Conflict**: 중복 등록 시도
  - **400 Bad Request**: 잘못된 쿼리 파라미터

### 4. 시스템 리소스 한계

- **데이터베이스 연결 풀**: 한도 초과
- **컴퓨트 리소스**: CPU/메모리 부족으로 인한 성능 저하
- **네트워크 대역폭**: 과도한 요청으로 인한 병목

---

## ⚠️ 장애 영향도

### 사용자 영향
- ✅ **대부분의 사용자**: 정상 서비스 이용 가능
- ⚠️ **일부 사용자**: 등록 실패, 실시간 기능 일시적 중단 경험
- ⚠️ **피크 시간대**: 응답 지연 및 일시적 접속 불가

### 기능별 영향
- ✅ **웨비나 시청**: 정상 작동
- ⚠️ **등록 기능**: 일부 중복 등록 시도 실패
- ⚠️ **실시간 채팅**: 일시적 연결 끊김
- ⚠️ **통계 집계**: 일부 데이터 누락 가능성

---

## 🛠️ 대응 조치

### 즉시 조치 (완료)
1. ✅ **Supabase 한도 상향**: 데이터베이스 연결 수 및 리소스 한도 증가
2. ✅ **컴퓨트 사양 변경**: 더 높은 성능의 컴퓨트 인스턴스로 업그레이드
3. ✅ **서비스 모니터링**: 실시간 모니터링 강화

### 장기 개선 사항 (권장)

#### 1. 데이터베이스 최적화
- [ ] **인덱스 최적화**: `registrations` 테이블 인덱스 재검토
- [ ] **연결 풀 설정**: PgBouncer 연결 풀 크기 조정
- [ ] **쿼리 최적화**: N+1 쿼리 문제 해결
- [ ] **트랜잭션 처리**: 등록 로직의 트랜잭션 격리 수준 검토

#### 2. 애플리케이션 레벨 개선
- [ ] **중복 등록 방지**: 클라이언트 사이드 중복 요청 방지 로직 강화
- [ ] **재시도 로직**: 실패한 요청에 대한 지수 백오프 재시도 구현
- [ ] **캐싱 전략**: 자주 조회되는 데이터(프로필, 웨비나 정보) 캐싱
- [ ] **요청 배치 처리**: 여러 프로필 조회를 단일 배치 요청으로 통합

#### 3. 모니터링 및 알림
- [ ] **알림 설정**: 동시 접속자 수 임계값 초과 시 알림
- [ ] **성능 메트릭**: API 응답 시간, 에러율 모니터링
- [ ] **용량 계획**: 예상 접속자 수 기반 리소스 계획 수립

#### 4. 코드 개선
- [ ] **에러 핸들링**: 409, 400 에러에 대한 사용자 친화적 메시지
- [ ] **로딩 상태**: 대량 데이터 조회 시 로딩 인디케이터 표시
- [ ] **폴링 최적화**: 실시간 업데이트 폴링 주기 조정

---

## 📈 성능 메트릭

### 접속자 수 추이
- **14:00-14:05**: 214-244명 (안정적)
- **14:05-14:10**: 226-299명 (급증)
- **14:10-14:15**: 147-264명 (변동)
- **14:15-14:20**: 47명 (급감)
- **14:40-14:45**: 88-311명 (최대 피크)

### 에러 발생 패턴
- **Postgres 에러**: 약 100건 이상
- **API 409 에러**: 중복 등록 시도 다수
- **API 400 에러**: 잘못된 쿼리 파라미터
- **Realtime 연결 끊김**: 수십 건

---

## 💡 결론 및 권장사항

### 결론
이번 장애는 **예상치 못한 높은 동시 접속자 수**(최대 311명)로 인해 발생한 **용량 초과 문제**였습니다. 특히 14:40-14:45 시간대에 접속자가 급증하면서 데이터베이스 연결 풀과 컴퓨트 리소스가 한계에 도달했습니다.

### 즉시 조치 완료
- ✅ Supabase 한도 상향
- ✅ 컴퓨트 사양 업그레이드

### 향후 예방 조치
1. **용량 모니터링**: 동시 접속자 수 실시간 모니터링 및 알림 설정
2. **성능 테스트**: 부하 테스트를 통한 한계점 사전 파악
3. **자동 스케일링**: 트래픽 증가 시 자동으로 리소스 확장
4. **코드 최적화**: 중복 요청 방지, 캐싱, 배치 처리 등 성능 개선

### 예상 비용 영향
- 컴퓨트 업그레이드로 인한 월간 비용 증가 예상
- 하지만 서비스 안정성 확보로 인한 비즈니스 가치 향상

---

**보고서 작성일**: 2026년 2월 6일  
**작성자**: AI Assistant (로그 분석 기반)
