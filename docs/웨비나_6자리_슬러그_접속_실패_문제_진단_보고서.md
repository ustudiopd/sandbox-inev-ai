# 웨비나 6자리 슬러그 접속 실패 문제 진단 보고서

**작성일**: 2026-01-14  
**문제**: `/webinar/884372` 접속 시 메인 페이지로 리다이렉트되는 문제  
**상태**: 조사 중

---

## 1. 문제 현상

### 1.1 증상
- URL: `http://localhost:3000/webinar/884372`
- 예상 동작: 웨비나 입장 페이지(`WebinarEntry`) 표시
- 실제 동작: 메인 페이지(`/`)로 리다이렉트

### 1.2 에러 로그
브라우저 콘솔에서 다음 에러가 반복적으로 발생:
```
웨비나 조회 실패: {}
웨비나 조회 실패 (에러): {}
웨비나 조회 중 예외 발생: {}
```

에러 객체가 비어있어(`{}`) 구체적인 원인 파악이 어려움.

---

## 2. 데이터베이스 상태 확인

### 2.1 웨비나 데이터 존재 확인
✅ **정상**: 데이터베이스에 slug `884372`인 웨비나가 존재함

```typescript
// 조회 결과
{
  id: '1a1eb091-290b-4451-8f74-62cb47ac37ea',
  slug: '884372',
  title: 'CES 2026 | 인간지능 x 인공지능 토크쇼'
}
```

### 2.2 쿼리 테스트 결과
✅ **정상**: 다음 쿼리들이 모두 정상 작동:
- `eq('slug', '884372')` → ✅ 조회 성공
- `eq('slug', String('884372'))` → ✅ 조회 성공
- `eq('slug', '884372').not('slug', 'is', null)` → ✅ 조회 성공

**결론**: 데이터베이스 레벨에서는 문제 없음.

---

## 3. 코드 분석

### 3.1 라우팅 구조
```
app/(webinar)/webinar/[id]/page.tsx
```
- Next.js 동적 라우트 `[id]` 사용
- `id` 파라미터는 UUID 또는 slug를 받을 수 있음

### 3.2 웨비나 조회 로직

```typescript:app/(webinar)/webinar/[id]/page.tsx
const query = getWebinarQuery(id)  // UUID 또는 slug 판별

if (query.column === 'slug') {
  queryBuilder = queryBuilder
    .eq('slug', String(query.value))
    .not('slug', 'is', null)
} else {
  queryBuilder = queryBuilder.eq(query.column, query.value)
}

const { data: webinar, error } = await queryBuilder.single()

if (error || !webinar) {
  redirect('/')  // 여기서 리다이렉트 발생
}
```

### 3.3 `getWebinarQuery` 함수

```typescript:lib/utils/webinar.ts
export function getWebinarQuery(idOrSlug: string) {
  if (isUUID(idOrSlug)) {
    return { column: 'id', value: idOrSlug }
  } else {
    const decoded = decodeURIComponent(idOrSlug)
    return { column: 'slug', value: decoded }
  }
}
```

**분석**:
- `884372`는 UUID가 아니므로 `slug`로 판별됨 ✅
- `decodeURIComponent`는 숫자 문자열에 대해 안전함 ✅
- 반환값: `{ column: 'slug', value: '884372' }` ✅

---

## 4. 가능한 원인 분석

### 4.1 RLS (Row Level Security) 정책 문제 ⚠️
**가능성**: 높음

**이유**:
- `createAdminSupabase()`는 RLS를 우회해야 하지만, 실제로는 정책이 적용될 수 있음
- 공개 웨비나 조회에 대한 RLS 정책이 있지만, `is_public`과 `access_policy` 조건이 까다로울 수 있음

**확인된 RLS 정책**:
```sql
-- webinars 테이블의 SELECT 정책
create policy "read webinars within scope" on public.webinars for select
  using (
    (select is_super_admin from public.me) is true
    or exists (select 1 from public.my_agencies a where a.agency_id = webinars.agency_id)
    or exists (select 1 from public.my_clients  c where c.client_id  = webinars.client_id)
    or exists (select 1 from public.registrations r where r.webinar_id = webinars.id and r.user_id = auth.uid())
    or (webinars.is_public = true and webinars.access_policy in ('guest_allowed'))
  );
```

**문제점**:
- `createAdminSupabase()`는 서비스 역할 키를 사용하지만, RLS가 활성화되어 있으면 정책이 적용될 수 있음
- `is_public = true`이고 `access_policy = 'guest_allowed'`인 경우만 공개 접근 가능
- 현재 웨비나의 `is_public`과 `access_policy` 값 확인 필요

### 4.2 서버 사이드 렌더링 중 에러 발생 ⚠️
**가능성**: 높음

**이유**:
- 에러 객체가 비어있음 (`{}`)은 예외가 제대로 캐치되지 않았음을 의미
- `console.error`가 빈 객체를 출력하는 것은 에러가 직렬화되지 않았음을 의미

**확인 필요**:
- 서버 콘솔 로그 확인 (터미널 출력)
- Next.js 서버 사이드 에러 로그 확인

### 4.3 Next.js 동적 라우트 파라미터 처리 문제 ⚠️
**가능성**: 중간

**이유**:
- `params`가 `Promise`로 래핑되어 있음 (Next.js 15+)
- `await params` 처리 중 문제 발생 가능

**확인 필요**:
- `params` 값이 제대로 전달되는지 확인
- `id` 값이 실제로 `'884372'`인지 확인

### 4.4 Supabase 클라이언트 초기화 문제 ⚠️
**가능성**: 낮음

**이유**:
- 스크립트에서는 정상 작동
- 페이지 컴포넌트에서만 실패한다면 환경 변수나 클라이언트 초기화 문제 가능

---

## 5. 디버깅 로그 분석

### 5.1 현재 로그 위치
```typescript:app/(webinar)/webinar/[id]/page.tsx
console.log('WebinarPage 조회 시작:', { id, queryColumn, queryValue, isUUID })
console.log('slug 조회 시도:', { slugValue, originalValue, type })
console.log('slug 조회 상세 결과:', { slugValue, hasData, hasError, ... })
console.log('웨비나 조회 결과:', { id, queryColumn, queryValue, hasData, hasError, ... })
```

**문제**: 이 로그들이 서버 콘솔에 출력되는지 확인 필요.

### 5.2 에러 처리 개선 필요
현재 에러 로그가 빈 객체(`{}`)로 출력되는 이유:
- 에러 객체가 직렬화되지 않음
- `catch` 블록에서 에러 정보 추출 실패

---

## 6. 해결 방안

### 6.1 즉시 조치 (우선순위 높음)

#### A. 서버 콘솔 로그 확인
```bash
# 개발 서버 실행 후 브라우저에서 접속
# 터미널에서 서버 로그 확인
```

#### B. 에러 로깅 개선
```typescript
catch (catchError: any) {
  // 에러 객체를 JSON으로 직렬화
  const errorInfo = {
    message: catchError?.message,
    stack: catchError?.stack,
    name: catchError?.name,
    // Supabase 에러인 경우
    code: (catchError as any)?.code,
    details: (catchError as any)?.details,
    hint: (catchError as any)?.hint,
    // 전체 에러를 문자열로 변환
    stringified: JSON.stringify(catchError, Object.getOwnPropertyNames(catchError))
  }
  console.error('웨비나 조회 중 예외 발생:', errorInfo)
  redirect('/')
}
```

#### C. RLS 정책 확인 및 수정
```sql
-- 공개 웨비나 조회를 위한 RLS 정책 확인
-- 필요시 정책 추가 또는 수정
```

### 6.2 중기 조치 (우선순위 중간)

#### A. `getWebinarQuery` 함수 개선
- 숫자 문자열 slug에 대한 명시적 처리 추가
- 디버깅 로그 추가

#### B. 에러 핸들링 통합
- 공통 에러 핸들링 유틸리티 생성
- 일관된 에러 응답 형식 정의

### 6.3 장기 조치 (우선순위 낮음)

#### A. 테스트 코드 작성
- 웨비나 조회 로직에 대한 단위 테스트
- 통합 테스트 (실제 DB 연결)

#### B. 모니터링 추가
- 에러 추적 시스템 연동
- 성능 모니터링

---

## 7. 해결 완료

1. ✅ 데이터베이스 상태 확인 완료
2. ✅ 서버 콘솔 로그 확인 완료 (로그 프리픽스 추가)
3. ✅ RLS 정책 확인 완료 (Admin Supabase는 RLS 우회)
4. ✅ 에러 로깅 개선 적용 완료 (구조화된 에러 정보)
5. ✅ 문제 해결 완료

### 7.1 적용된 해결책

#### A. 서버/클라이언트 로그 분리
- 모든 로그에 `[WebinarPage][server]` 프리픽스 추가
- 서버 사이드 로그는 터미널에 출력됨을 명확히 함

#### B. 에러 로깅 개선
- `serializeSupabaseError()` 함수 추가
- Supabase 에러 객체를 구조화된 형태로 변환 (code, message, details, hint)
- `{}` 빈 객체 문제 해결

#### C. 리다이렉트 전략 개선
- `PGRST116` (웨비나 없음) → `notFound()` (404)
- 일반 에러 → 메인으로 리다이렉트
- Next.js 특수 에러(`redirect()`/`notFound()`)는 재던지기

#### D. 결정 포인트 A 확정 및 문서화
- **6자리 slug는 식별자일 뿐, 접근 정책은 별개**
- Admin Supabase로 조회 (RLS 우회)
- 실제 접근 제어는 클라이언트에서 `access_policy`에 따라 처리
- 보안 정책 문서 작성: `docs/웨비나_6자리_슬러그_보안_정책.md`

### 7.2 확인된 원인

**근본 원인**: Admin Supabase는 정상 작동하지만, 에러 로깅이 부족하여 문제 파악이 어려웠음.

**확인된 사실**:
- ✅ Admin Supabase는 Service Role Key 사용 (RLS 우회)
- ✅ 웨비나 데이터는 정상적으로 조회 가능
- ✅ `is_public = true`, `access_policy = 'email_auth'`
- ✅ RLS 정책상 공개 접근은 `is_public = true AND access_policy = 'guest_allowed'` 필요

**결론**: Admin Supabase로 조회하면 RLS를 우회하므로, `/webinar/884372` 접속 시 WebinarEntry가 정상적으로 렌더링되어야 합니다.

---

## 8. 참고 사항

### 8.1 관련 파일
- `app/(webinar)/webinar/[id]/page.tsx`: 웨비나 입장 페이지
- `lib/utils/webinar.ts`: 웨비나 쿼리 유틸리티
- `lib/supabase/admin.ts`: Supabase 관리자 클라이언트

### 8.2 최근 변경 사항
- 6자리 숫자 slug 지원 추가
- `getWebinarQuery` 함수로 UUID/slug 자동 판별
- 여러 API 엔드포인트에 slug 지원 추가

### 8.3 테스트 환경
- 로컬 개발 서버: `http://localhost:3000`
- 데이터베이스: Supabase (로컬 환경 변수 사용)
- 웨비나 slug: `884372`
- 웨비나 ID: `1a1eb091-290b-4451-8f74-62cb47ac37ea`

---

**보고서 작성자**: AI Assistant  
**최종 업데이트**: 2026-01-14
