# ìŠˆí¼ì–´ë“œë¯¼ ì‹œìŠ¤í…œ ê²€í†  - EventLive í”„ë¡œì íŠ¸ ë§ì¶¤

## í•œ ì¤„ ìš”ì•½ (ê²°ë¡ )

* **ëŒ€ì‹œë³´ë“œ/í˜ì´ì§€ êµ¬ì„±ì€ ê·¸ëŒ€ë¡œ ì§„í–‰**í•˜ë˜,
  1. **ìŠˆí¼ì–´ë“œë¯¼ ê³„ì • ìƒì„±ì€ HTTP APIê°€ ì•„ë‹ˆë¼ "ì‹œë“œ ìŠ¤í¬ë¦½íŠ¸"**ë¡œ ì²˜ë¦¬,
  2. **í˜„ì¬ êµ¬ì¡°(`is_super_admin` í”Œë˜ê·¸) ìœ ì§€ + ë¯¸ë“¤ì›¨ì–´ ë³´í˜¸ ì¶”ê°€**,
  3. ëŒ€ì‹œë³´ë“œ **ë²ˆë“¤í˜• ì¡°íšŒ + ìºì‹œ ìµœì í™”**
     ë¡œ ë³€ê²½í•˜ëŠ” ê²ƒì„ ê¶Œì¥í•©ë‹ˆë‹¤.
* "admin / uslab3300" ê°™ì€ **ê³ ì • ìê²© ì¦ëª…ì€ ê¸ˆì§€**(ì„ì‹œ ë¹„ë°€ë²ˆí˜¸ + ìµœì´ˆ ë¡œê·¸ì¸ ì‹œ ê°•ì œ ë³€ê²½).

---

## í˜„ì¬ í”„ë¡œì íŠ¸ êµ¬ì¡° ë¶„ì„

### âœ… ì´ë¯¸ êµ¬í˜„ëœ ê²ƒë“¤
- **ê¶Œí•œ êµ¬ì¡°**: `profiles.is_super_admin` í”Œë˜ê·¸ ê¸°ë°˜ (ê°„ë‹¨í•˜ê³  íš¨ê³¼ì )
- **RLS ì •ì±…**: `(select is_super_admin from public.me) is true` íŒ¨í„´ ì‚¬ìš©
- **ê°€ë“œ í•¨ìˆ˜**: `lib/auth/guards.ts`ì— `requireSuperAdmin()` ë“± êµ¬í˜„
- **ì„œë²„ ì»´í¬ë„ŒíŠ¸**: Next.js App Router ê¸°ë°˜
- **Admin Supabase**: `lib/supabase/admin.ts`ë¡œ ì„œë¹„ìŠ¤ ë¡¤ í‚¤ ì‚¬ìš©

### âš ï¸ ë³´ì™„ì´ í•„ìš”í•œ ê²ƒë“¤
- **ë¯¸ë“¤ì›¨ì–´**: `/super/**` ê²½ë¡œ ë³´í˜¸ ì—†ìŒ
- **ìŠˆí¼ì–´ë“œë¯¼ ìƒì„±**: HTTP API ì—†ìŒ (ì¢‹ìŒ), í•˜ì§€ë§Œ ì‹œë“œ ìŠ¤í¬ë¦½íŠ¸ë„ ì—†ìŒ
- **ë ˆì´ì•„ì›ƒ ë³´í˜¸**: `app/(super)/super/layout.tsx` ì—†ìŒ
- **ëŒ€ì‹œë³´ë“œ ìµœì í™”**: ë‹¤ì¤‘ ì¿¼ë¦¬ë¡œ ì¸í•œ ì„±ëŠ¥ ì´ìŠˆ ê°€ëŠ¥ì„±

---

## ì£¼ìš” ìœ„í—˜ í¬ì¸íŠ¸ (Blockers) & ê°œì„ 

### 1. ê³ ì • ìê²© ì •ë³´(ì´ë©”ì¼/ë¹„ë°€ë²ˆí˜¸) ë…¸ì¶œ ìœ„í—˜

* **ë¬¸ì œ**: `admin / uslab3300`ëŠ” ì¦‰ì‹œ ìœ ì¶œÂ·ë¸Œë£¨íŠ¸í¬ìŠ¤ í‘œì .
* **ê°œì„ **: 
  - **CLI/ì‹œë“œ ìŠ¤í¬ë¦½íŠ¸**ë¡œ ê³„ì •ì„ ë§Œë“¤ê³ , 
  - **ì„ì‹œ íŒ¨ìŠ¤ì›Œë“œ + ìµœì´ˆ ë¡œê·¸ì¸ ì‹œ ê°•ì œ ë³€ê²½** ë˜ëŠ” 
  - **Magic Link/SSO(êµ¬ê¸€/OIDC)** ì‚¬ìš©.

### 2. ê³µê°œ HTTPë¡œ "ìŠˆí¼ì–´ë“œë¯¼ ìƒì„± API" ì œê³µ

* **í˜„ì¬ ìƒíƒœ**: âœ… HTTP API ì—†ìŒ (ì¢‹ìŒ)
* **ê¶Œì¥**: ì‹œë“œ ìŠ¤í¬ë¦½íŠ¸ë¡œë§Œ ìƒì„± (`scripts/seed-super-admin.ts`)

### 3. ê¶Œí•œ ì²´í¬ ìœ„ì¹˜ ë¶ˆë¶„ëª…

* **í˜„ì¬**: ì„œë²„ ì»´í¬ë„ŒíŠ¸/Route Handlerì—ì„œë§Œ ì²´í¬
* **ê°œì„ **:
  - **ë¯¸ë“¤ì›¨ì–´**ì—ì„œ `/super/**` ê²½ë¡œ ì ‘ê·¼ì„ **ì„œë²„ ì¸¡**ì—ì„œ ê°€ë¡œì±„ê¸°
  - **ë ˆì´ì•„ì›ƒ**ì—ì„œ **2ì°¨ ê²€ì¦**(defense-in-depth)
  - í˜„ì¬ êµ¬ì¡°(`is_super_admin` í”Œë˜ê·¸) ìœ ì§€

### 4. ì§‘ê³„ ì¿¼ë¦¬ ë‹¤ì¤‘ í˜¸ì¶œë¡œ ì¸í•œ ì§€ì—°

* **ê°œì„ **: ëŒ€ì‹œë³´ë“œ ìƒë‹¨ ì¹´ë“œ(ì—ì´ì „ì‹œ/í´ë¼ì´ì–¸íŠ¸/ì›¨ë¹„ë‚˜ ìˆ˜), ìµœê·¼ ëª©ë¡ë“¤ì„ **ë‹¨ì¼ RPC/ë·°**ë¡œ **í•œ ë²ˆì— ë°˜í™˜** ë˜ëŠ” **Promise.all**ë¡œ ë³‘ë ¬ ì²˜ë¦¬.

---

## ìˆ˜ì •ëœ ì‘ì—… ê³„íš (í”„ë¡œì íŠ¸ ë§ì¶¤)

### A. ìŠˆí¼ì–´ë“œë¯¼ ìƒì„± (ì‹œë“œ ìŠ¤í¬ë¦½íŠ¸)

* **ì‹ ê·œ**: `scripts/seed-super-admin.ts` (Node ìŠ¤í¬ë¦½íŠ¸)
  * ì„œë¹„ìŠ¤ ë¡¤ í‚¤ ì‚¬ìš©(ì„œë²„ì—ì„œë§Œ)
  * ì´ë©”ì¼ì€ í™˜ê²½ë³€ìˆ˜ë¡œ (`SUPER_ADMIN_EMAIL`)
  * ë¹„ë°€ë²ˆí˜¸ëŠ” **ì„ì‹œ** + **ì´ˆê¸° ë¡œê·¸ì¸ ì‹œ ê°•ì œ ë³€ê²½** (Supabase Auth ì„¤ì •)
  * ì‹¤í–‰ í›„ **ê°ì‚¬ ë¡œê·¸**ì— ê¸°ë¡

### B. í˜„ì¬ êµ¬ì¡° ìœ ì§€ + ë³´ì•ˆ ê°•í™”

* **í˜„ì¬ êµ¬ì¡° ìœ ì§€**:
  * `profiles.is_super_admin` í”Œë˜ê·¸ ê³„ì† ì‚¬ìš©
  * `public.me` ë·°ê°€ ì—†ë‹¤ë©´ ë§ˆì´ê·¸ë ˆì´ì…˜ìœ¼ë¡œ ìƒì„± (RLS ì •ì±…ì—ì„œ ì‚¬ìš© ì¤‘)
  * RLS ì •ì±…ì€ í˜„ì¬ íŒ¨í„´ ìœ ì§€

* **ë³´ì•ˆ ê°•í™”**:
  * ë¯¸ë“¤ì›¨ì–´ ì¶”ê°€ (`middleware.ts`)
  * ë ˆì´ì•„ì›ƒ ë³´í˜¸ (`app/(super)/super/layout.tsx`)

### C. ë¼ìš°íŒ…/ë ˆì´ì•„ì›ƒ/ë³´ì•ˆ

* **ë ˆì´ì•„ì›ƒ**: `app/(super)/super/layout.tsx`(ì„œë²„ ì»´í¬ë„ŒíŠ¸)ì—ì„œ **ì„œë²„ ì¸¡ ê¶Œí•œ ê²€ì‚¬**
* **ë¯¸ë“¤ì›¨ì–´**: `/super/:path*` ì ‘ê·¼ ì‹œ **ì„¸ì…˜ í™•ì¸ + ìŠˆí¼ ê¶Œí•œ ì²´í¬**
* **í˜ì´ì§€**: ëŒ€ì‹œë³´ë“œ/í´ë¼ì´ì–¸íŠ¸/ì—ì´ì „ì‹œ í˜ì´ì§€ëŠ” **Server Components**ë¡œ ë°ì´í„° íŒ¨ì¹­(ë³‘ë ¬ ì²˜ë¦¬), ëª©ë¡ì€ **í‚¤ì…‹ í˜ì´ì§€ë„¤ì´ì…˜**

### D. ë°ì´í„° ì¡°íšŒ ìµœì í™”(ëŒ€ì‹œë³´ë“œ)

* **ë³‘ë ¬ ì²˜ë¦¬**: `Promise.all`ë¡œ ì—¬ëŸ¬ ì¿¼ë¦¬ ë™ì‹œ ì‹¤í–‰
* **ì„ íƒì  RPC**: í•„ìš”ì‹œ `admin_overview()` í•¨ìˆ˜ ìƒì„± (SQL í•¨ìˆ˜)
* **ì¸ë±ìŠ¤**: `(created_at DESC)` + `(agency_id)` ì»¤ë²„ë§ ì¸ë±ìŠ¤ í™•ì¸
* **ìºì‹œ**: ê³µê°œ ë©”íƒ€ëŠ” **Edge ìºì‹œ** + `revalidateTag('admin_overview')` íŒ¨í„´. ê¶Œí•œ ë°ì´í„°ëŠ” **no-store**

---

## ì½”ë“œ ìŠ¤ë‹ˆí« (í”„ë¡œì íŠ¸ ë§ì¶¤)

### 1) ìŠˆí¼ì–´ë“œë¯¼ ì‹œë“œ ìŠ¤í¬ë¦½íŠ¸ â€“ `scripts/seed-super-admin.ts`

```typescript
/**
 * ìŠˆí¼ì–´ë“œë¯¼ ê³„ì • ìƒì„± ìŠ¤í¬ë¦½íŠ¸
 * 
 * ì‚¬ìš©ë²•: 
 *   npx tsx scripts/seed-super-admin.ts
 * 
 * í™˜ê²½ ë³€ìˆ˜:
 *   SUPER_ADMIN_EMAIL=admin@example.com (í•„ìˆ˜)
 *   NEXT_PUBLIC_SUPABASE_URL (í•„ìˆ˜)
 *   SUPABASE_SERVICE_ROLE_KEY (í•„ìˆ˜)
 */

import { createClient } from '@supabase/supabase-js'
import { randomBytes } from 'crypto'

const url = process.env.NEXT_PUBLIC_SUPABASE_URL!
const serviceKey = process.env.SUPABASE_SERVICE_ROLE_KEY!
const email = process.env.SUPER_ADMIN_EMAIL || 'admin@eventlive.ai'

if (!url || !serviceKey) {
  console.error('âŒ í™˜ê²½ ë³€ìˆ˜ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.')
  console.error('NEXT_PUBLIC_SUPABASE_URL:', url ? 'âœ“' : 'âœ—')
  console.error('SUPABASE_SERVICE_ROLE_KEY:', serviceKey ? 'âœ“' : 'âœ—')
  process.exit(1)
}

// ì„ì‹œ ë¹„ë°€ë²ˆí˜¸ ìƒì„± (ìµœì´ˆ ë¡œê·¸ì¸ ì‹œ ë³€ê²½ í•„ìš”)
const tempPassword = randomBytes(16).toString('hex')

;(async () => {
  const admin = createClient(url, serviceKey)

  try {
    // 1) ìœ ì € ì¡°íšŒ/ìƒì„±
    const { data: { users }, error: listError } = await admin.auth.admin.listUsers()
    
    if (listError) {
      throw new Error(`ì‚¬ìš©ì ëª©ë¡ ì¡°íšŒ ì‹¤íŒ¨: ${listError.message}`)
    }

    const existingUser = users?.find(u => u.email === email)
    let userId: string | undefined = existingUser?.id

    if (!userId) {
      // ìƒˆ ì‚¬ìš©ì ìƒì„±
      const { data: authData, error: authError } = await admin.auth.admin.createUser({
        email,
        password: tempPassword,
        email_confirm: true, // ì´ë©”ì¼ í™•ì¸ ì—†ì´ ë°”ë¡œ í™œì„±í™”
        user_metadata: {
          force_password_reset: true, // ìµœì´ˆ ë¡œê·¸ì¸ ì‹œ ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ ê°•ì œ
          display_name: 'Super Admin'
        }
      })

      if (authError) {
        throw new Error(`ì‚¬ìš©ì ìƒì„± ì‹¤íŒ¨: ${authError.message}`)
      }

      if (!authData.user) {
        throw new Error('ì‚¬ìš©ì ìƒì„± ì‹¤íŒ¨: user ë°ì´í„° ì—†ìŒ')
      }

      userId = authData.user.id
      console.log('âœ… ìŠˆí¼ì–´ë“œë¯¼ ê³„ì • ìƒì„±:', email)
      console.log('âš ï¸  ì„ì‹œ ë¹„ë°€ë²ˆí˜¸:', tempPassword)
      console.log('âš ï¸  ìµœì´ˆ ë¡œê·¸ì¸ ì‹œ ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ì´ í•„ìš”í•©ë‹ˆë‹¤!')
    } else {
      console.log('â„¹ï¸  ìŠˆí¼ì–´ë“œë¯¼ ê³„ì •ì´ ì´ë¯¸ ì¡´ì¬í•©ë‹ˆë‹¤:', email)
    }

    // 2) í”„ë¡œí•„ í™•ì¸ ë° is_super_admin ì„¤ì •
    const { data: profile, error: profileError } = await admin
      .from('profiles')
      .select('id, is_super_admin')
      .eq('id', userId)
      .maybeSingle()

    if (profileError) {
      throw new Error(`í”„ë¡œí•„ ì¡°íšŒ ì‹¤íŒ¨: ${profileError.message}`)
    }

    if (!profile) {
      // í”„ë¡œí•„ì´ ì—†ìœ¼ë©´ ìƒì„± (íŠ¸ë¦¬ê±°ê°€ ëŠ¦ê²Œ ì‹¤í–‰ë  ìˆ˜ ìˆìŒ)
      const { error: createProfileError } = await admin
        .from('profiles')
        .insert({
          id: userId,
          email: email,
          is_super_admin: true
        })

      if (createProfileError) {
        throw new Error(`í”„ë¡œí•„ ìƒì„± ì‹¤íŒ¨: ${createProfileError.message}`)
      }
      console.log('âœ… í”„ë¡œí•„ ìƒì„± ë° ìŠˆí¼ì–´ë“œë¯¼ ê¶Œí•œ ë¶€ì—¬')
    } else if (!profile.is_super_admin) {
      // í”„ë¡œí•„ì´ ìˆì§€ë§Œ ìŠˆí¼ì–´ë“œë¯¼ì´ ì•„ë‹ˆë©´ ì—…ë°ì´íŠ¸
      const { error: updateError } = await admin
        .from('profiles')
        .update({ is_super_admin: true })
        .eq('id', userId)

      if (updateError) {
        throw new Error(`í”„ë¡œí•„ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨: ${updateError.message}`)
      }
      console.log('âœ… ìŠˆí¼ì–´ë“œë¯¼ ê¶Œí•œ ë¶€ì—¬')
    } else {
      console.log('â„¹ï¸  ì´ë¯¸ ìŠˆí¼ì–´ë“œë¯¼ ê¶Œí•œì´ ì„¤ì •ë˜ì–´ ìˆìŠµë‹ˆë‹¤')
    }

    // 3) ê°ì‚¬ ë¡œê·¸ (ì„ íƒì , audit_logs í…Œì´ë¸”ì´ ìˆë‹¤ë©´)
    try {
      await admin.from('audit_logs').insert({
        actor_user_id: userId,
        action: 'SEED_SUPER_ADMIN',
        payload: { email, created: !existingUser }
      })
    } catch (auditError) {
      // ê°ì‚¬ ë¡œê·¸ ì‹¤íŒ¨ëŠ” ë¬´ì‹œ (í…Œì´ë¸”ì´ ì—†ì„ ìˆ˜ ìˆìŒ)
      console.warn('âš ï¸  ê°ì‚¬ ë¡œê·¸ ê¸°ë¡ ì‹¤íŒ¨ (ë¬´ì‹œë¨):', auditError)
    }

    console.log('\nâœ… ì™„ë£Œ!')
    if (!existingUser) {
      console.log('\nğŸ“‹ ë‹¤ìŒ ë‹¨ê³„:')
      console.log('1. ì´ë©”ì¼:', email)
      console.log('2. ì„ì‹œ ë¹„ë°€ë²ˆí˜¸:', tempPassword)
      console.log('3. ë¡œê·¸ì¸ í›„ ë¹„ë°€ë²ˆí˜¸ë¥¼ ë³€ê²½í•˜ì„¸ìš”')
    }
  } catch (error: any) {
    console.error('âŒ ì˜¤ë¥˜:', error.message)
    process.exit(1)
  }
})()
```

### 2) ë¯¸ë“¤ì›¨ì–´ ë³´í˜¸ â€“ `middleware.ts` (í”„ë¡œì íŠ¸ ë£¨íŠ¸)

```typescript
import { NextResponse } from 'next/server'
import type { NextRequest } from 'next/server'
import { createServerClient } from '@supabase/ssr'
import { cookies } from 'next/headers'

export async function middleware(req: NextRequest) {
  const path = req.nextUrl.pathname

  // /super/** ê²½ë¡œ ë³´í˜¸
  if (path.startsWith('/super')) {
    const cookieStore = await cookies()
    
    // Supabase í´ë¼ì´ì–¸íŠ¸ ìƒì„± (ì„œë²„ ì‚¬ì´ë“œ)
    const supabase = createServerClient(
      process.env.NEXT_PUBLIC_SUPABASE_URL!,
      process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,
      {
        cookies: {
          get: (name: string) => cookieStore.get(name)?.value,
          set: (name: string, value: string, options?: any) => {
            cookieStore.set({ name, value, ...options })
          },
          remove: (name: string, options?: any) => {
            cookieStore.set({ name, value: '', ...options })
          },
        } as any,
      }
    )

    // ì¸ì¦ í™•ì¸
    const { data: { user } } = await supabase.auth.getUser()
    
    if (!user) {
      return NextResponse.redirect(new URL('/login', req.url))
    }

    // ìŠˆí¼ì–´ë“œë¯¼ ê¶Œí•œ í™•ì¸
    const { data: profile } = await supabase
      .from('profiles')
      .select('is_super_admin')
      .eq('id', user.id)
      .single()

    if (!profile?.is_super_admin) {
      return NextResponse.json(
        { error: 'Forbidden: Super admin access required' },
        { status: 403 }
      )
    }
  }

  return NextResponse.next()
}

export const config = {
  matcher: ['/super/:path*']
}
```

### 3) ë ˆì´ì•„ì›ƒì—ì„œ 2ì°¨ ë°©ì–´ â€“ `app/(super)/super/layout.tsx`

```typescript
import { requireSuperAdmin } from '@/lib/auth/guards'
import Sidebar from './_components/Sidebar'

export default async function SuperLayout({
  children,
}: {
  children: React.ReactNode
}) {
  // ì„œë²„ì—ì„œ í™•ì •ì ìœ¼ë¡œ ê¶Œí•œ í™•ì¸
  await requireSuperAdmin()

  return (
    <div className="flex min-h-screen">
      <Sidebar />
      <main className="flex-1 p-6">{children}</main>
    </div>
  )
}
```

### 4) ëŒ€ì‹œë³´ë“œ ë°ì´í„° ë³‘ë ¬ ì²˜ë¦¬ â€“ `app/(super)/super/dashboard/page.tsx`

```typescript
import { requireSuperAdmin } from '@/lib/auth/guards'
import { createServerSupabase } from '@/lib/supabase/server'
import Link from 'next/link'

export default async function SuperDashboard() {
  const { user } = await requireSuperAdmin()
  const supabase = await createServerSupabase()

  // ë³‘ë ¬ë¡œ ëª¨ë“  ë°ì´í„° ì¡°íšŒ
  const [
    { data: profile },
    { data: agencies, count: agenciesCount },
    { data: clients, count: clientsCount },
    { data: webinars, count: webinarsCount },
    { data: recentAgencies },
    { data: recentClients },
  ] = await Promise.all([
    supabase
      .from('profiles')
      .select('display_name, email')
      .eq('id', user.id)
      .single(),
    supabase
      .from('agencies')
      .select('id', { count: 'exact', head: true }),
    supabase
      .from('clients')
      .select('id', { count: 'exact', head: true }),
    supabase
      .from('webinars')
      .select('id', { count: 'exact', head: true }),
    supabase
      .from('agencies')
      .select('id, name, created_at')
      .order('created_at', { ascending: false })
      .limit(5),
    supabase
      .from('clients')
      .select('id, name, agency_id, created_at')
      .order('created_at', { ascending: false })
      .limit(5),
  ])

  return (
    <div className="container mx-auto p-8">
      {/* í—¤ë” */}
      <div className="mb-6 flex justify-between items-center">
        <h1 className="text-3xl font-bold">ìŠˆí¼ ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ</h1>
        <div className="bg-white px-4 py-2 rounded-lg shadow border border-gray-200">
          <div className="text-sm text-gray-600">ì ‘ì† ê³„ì •</div>
          <div className="font-semibold text-gray-900">
            {profile?.display_name || profile?.email || user.email}
          </div>
          <div className="text-xs text-blue-600 mt-1">ìŠˆí¼ ê´€ë¦¬ì</div>
        </div>
      </div>

      {/* í†µê³„ ì¹´ë“œ */}
      <div className="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
        <div className="bg-white p-6 rounded-lg shadow">
          <h2 className="text-xl font-semibold mb-2">ì—ì´ì „ì‹œ ìˆ˜</h2>
          <p className="text-3xl font-bold">{agenciesCount || 0}</p>
        </div>
        <div className="bg-white p-6 rounded-lg shadow">
          <h2 className="text-xl font-semibold mb-2">í´ë¼ì´ì–¸íŠ¸ ìˆ˜</h2>
          <p className="text-3xl font-bold">{clientsCount || 0}</p>
        </div>
        <div className="bg-white p-6 rounded-lg shadow">
          <h2 className="text-xl font-semibold mb-2">ì›¨ë¹„ë‚˜ ìˆ˜</h2>
          <p className="text-3xl font-bold">{webinarsCount || 0}</p>
        </div>
      </div>

      {/* ìµœê·¼ ëª©ë¡ */}
      <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
        {/* ìµœê·¼ ì—ì´ì „ì‹œ */}
        <div className="bg-white rounded-lg shadow overflow-hidden">
          <div className="bg-gradient-to-r from-blue-600 to-purple-600 p-4">
            <h2 className="text-xl font-semibold text-white">ìµœê·¼ ì—ì´ì „ì‹œ</h2>
          </div>
          <div className="p-4">
            {recentAgencies && recentAgencies.length > 0 ? (
              <ul className="space-y-2">
                {recentAgencies.map((agency) => (
                  <li key={agency.id} className="flex justify-between items-center">
                    <span className="font-medium">{agency.name}</span>
                    <Link
                      href={`/super/agencies`}
                      className="text-blue-600 hover:underline text-sm"
                    >
                      ë³´ê¸° â†’
                    </Link>
                  </li>
                ))}
              </ul>
            ) : (
              <p className="text-gray-500">ì—ì´ì „ì‹œê°€ ì—†ìŠµë‹ˆë‹¤</p>
            )}
          </div>
        </div>

        {/* ìµœê·¼ í´ë¼ì´ì–¸íŠ¸ */}
        <div className="bg-white rounded-lg shadow overflow-hidden">
          <div className="bg-gradient-to-r from-blue-600 to-purple-600 p-4">
            <h2 className="text-xl font-semibold text-white">ìµœê·¼ í´ë¼ì´ì–¸íŠ¸</h2>
          </div>
          <div className="p-4">
            {recentClients && recentClients.length > 0 ? (
              <ul className="space-y-2">
                {recentClients.map((client) => (
                  <li key={client.id} className="flex justify-between items-center">
                    <span className="font-medium">{client.name}</span>
                    <Link
                      href={`/super/clients`}
                      className="text-blue-600 hover:underline text-sm"
                    >
                      ë³´ê¸° â†’
                    </Link>
                  </li>
                ))}
              </ul>
            ) : (
              <p className="text-gray-500">í´ë¼ì´ì–¸íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤</p>
            )}
          </div>
        </div>
      </div>
    </div>
  )
}
```

### 5) public.me ë·° ìƒì„± (ë§ˆì´ê·¸ë ˆì´ì…˜)

```sql
-- public.me ë·° ìƒì„± (RLS ì •ì±…ì—ì„œ ì‚¬ìš© ì¤‘ì´ë¯€ë¡œ í•„ìš”)
-- ë§ˆì´ê·¸ë ˆì´ì…˜ íŒŒì¼: supabase/migrations/022_create_me_view.sql

create or replace view public.me as
select 
  p.id as user_id, 
  p.is_super_admin 
from public.profiles p 
where p.id = auth.uid();

-- RLS ì •ì±…ì—ì„œ ì‚¬ìš© ì¤‘ì´ë¯€ë¡œ ë°˜ë“œì‹œ í•„ìš”
```

---

## ë„¤ë¹„ê²Œì´ì…˜/UI (ìš”êµ¬ì‚¬í•­ ë°˜ì˜)

* **ì‚¬ì´ë“œë°” í•­ëª©**: ëŒ€ì‹œë³´ë“œ / ì—ì´ì „ì‹œ ê´€ë¦¬ / í´ë¼ì´ì–¸íŠ¸ ê´€ë¦¬ / ê°ì‚¬ ë¡œê·¸
* **ëŒ€ì‹œë³´ë“œ ì¹´ë“œ**: ì´ ì—ì´ì „ì‹œ / ì´ í´ë¼ì´ì–¸íŠ¸ / ì´ ì›¨ë¹„ë‚˜
* **ìµœê·¼ ëª©ë¡**: ì—ì´ì „ì‹œ 5ê°œ, í´ë¼ì´ì–¸íŠ¸ 5ê°œ(ê° ì´ë¦„/ìƒì„±ì¼/ë°”ë¡œê°€ê¸°)
* **ë¹ ë¥¸ ì•¡ì…˜**: ì—ì´ì „ì‹œ ìƒì„±, í´ë¼ì´ì–¸íŠ¸ ê´€ë¦¬, ê°ì‚¬ ë¡œê·¸ ì—´ëŒ
* **í‘œì¤€ UX**: ìŠ¤ì¼ˆë ˆí†¤, ë¹„ë™ê¸° ì „í™˜ ì‹œ í† ìŠ¤íŠ¸, ì‹¤íŒ¨ì‹œ ì¬ì‹œë„ ë²„íŠ¼

---

## ê°ì‚¬ ë¡œê·¸ & ìš´ì˜

* `audit_logs` í…Œì´ë¸”ì´ ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ê²ƒìœ¼ë¡œ ë³´ì„
* ëª¨ë“  **ìƒì„±/ìˆ˜ì •/ì‚­ì œ**ëŠ” **ì„œë²„ì—ì„œ** ê°ì‚¬ ë¡œê·¸ì— ê¸°ë¡(íŠ¸ëœì­ì…˜ ë‚´)
* `/super/audit-logs`ì—ì„œ í•„í„°/ê²€ìƒ‰ ì œê³µ (ì„ íƒì )

---

## ë³´ì•ˆ ì²´í¬ë¦¬ìŠ¤íŠ¸ (í•„ìˆ˜)

* [ ] **ìŠˆí¼ì–´ë“œë¯¼ ìƒì„±ì€ ì‹œë“œ ìŠ¤í¬ë¦½íŠ¸**, HTTP API ë¼ìš°íŠ¸ ì—†ìŒ (âœ… ì´ë¯¸ ì—†ìŒ)
* [ ] **ê³ ì • ë¹„ë°€ë²ˆí˜¸ ê¸ˆì§€**, ìµœì´ˆ ë¡œê·¸ì¸ ë¹„ë²ˆ ë³€ê²½ ë˜ëŠ” SSO/Magic Link
* [ ] `/super/**` **ë¯¸ë“¤ì›¨ì–´ + ì„œë²„ ë ˆì´ì•„ì›ƒ** ì´ì¤‘ ë³´í˜¸
* [ ] **RLS ì •ì±…**: `is_super_admin` ì „ì—­ í—ˆìš© + í•˜ìœ„ ë¡¤ ì„¸ë¶„ ê¶Œí•œ (âœ… ì´ë¯¸ êµ¬í˜„ë¨)
* [ ] **ë ˆì´íŠ¸ë¦¬ë°‹/CSRF**(POST/ë³€ê²½ API), **ë¡œê·¸ì¸ ì‹œ 2FA**(TOTP/SMS) - ì„ íƒì 
* [ ] **ê°ì‚¬ ë¡œê·¸** ì „ ê²½ë¡œì— ì‚½ì…, ê´€ë¦¬ì ì•¡ì…˜ ì•Œë¦¼(ì˜µì…˜)

---

## ì„±ëŠ¥ ì²´í¬ë¦¬ìŠ¤íŠ¸ (ê¶Œì¥)

* [ ] ëŒ€ì‹œë³´ë“œ **Promise.allë¡œ ë³‘ë ¬ ì²˜ë¦¬** ë˜ëŠ” **ë²ˆë“¤í˜• RPC** 1~2íšŒë¡œ ë°ì´í„° ìˆ˜ì§‘
* [ ] **í‚¤ì…‹ í˜ì´ì§€ë„¤ì´ì…˜** ì „ë©´ ë„ì… + ì»¤ë²„ë§ ì¸ë±ìŠ¤
* [ ] **ë¦¬ì „ ë§ì¶¤**(DBì™€ í•¨ìˆ˜ ë¦¬ì „ ì¼ì¹˜), ê³µê°œ ë©”íƒ€ **Edge ìºì‹œ**
* [ ] ëª©ë¡ **ê°€ìƒ ìŠ¤í¬ë¡¤**(ê·œëª¨ ì»¤ì§ˆ ë•Œ)

---

## í”„ë¡œì íŠ¸ë³„ ì£¼ì˜ì‚¬í•­

### í˜„ì¬ êµ¬ì¡° ìœ ì§€
- âœ… `profiles.is_super_admin` í”Œë˜ê·¸ ê³„ì† ì‚¬ìš© (ê°„ë‹¨í•˜ê³  íš¨ê³¼ì )
- âœ… RLS ì •ì±… íŒ¨í„´ ìœ ì§€: `(select is_super_admin from public.me) is true`
- âœ… `public.me` ë·°ê°€ ì—†ë‹¤ë©´ ë§ˆì´ê·¸ë ˆì´ì…˜ìœ¼ë¡œ ìƒì„± í•„ìš”

### ì¶”ê°€ êµ¬í˜„ í•„ìš”
- âš ï¸ ë¯¸ë“¤ì›¨ì–´ (`middleware.ts`) - ìƒˆë¡œ ìƒì„±
- âš ï¸ ìŠˆí¼ ë ˆì´ì•„ì›ƒ (`app/(super)/super/layout.tsx`) - ìƒˆë¡œ ìƒì„±
- âš ï¸ ì‹œë“œ ìŠ¤í¬ë¦½íŠ¸ (`scripts/seed-super-admin.ts`) - ìƒˆë¡œ ìƒì„±
- âš ï¸ `public.me` ë·° ë§ˆì´ê·¸ë ˆì´ì…˜ - í™•ì¸ í›„ í•„ìš”ì‹œ ìƒì„±

### ì„ íƒì  ê°œì„ 
- ğŸ”„ RBAC í…Œì´ë¸” ë„ì… (`roles`/`user_roles`) - í˜„ì¬ êµ¬ì¡°ë¡œë„ ì¶©ë¶„í•˜ì§€ë§Œ, í™•ì¥ì„±ì„ ìœ„í•´ ê³ ë ¤ ê°€ëŠ¥
- ğŸ”„ ëŒ€ì‹œë³´ë“œ RPC í•¨ìˆ˜ - ì„±ëŠ¥ ìµœì í™”ë¥¼ ìœ„í•´ ê³ ë ¤

---

## ìµœì¢… íŒë‹¨

* **ì§„í–‰ ìŠ¹ì¸ (ë‹¨, ìœ„ ìˆ˜ì • ì ìš© ì „ì œ)**: í˜ì´ì§€ êµ¬ì¡°Â·ë„¤ë¹„ê²Œì´ì…˜Â·ê¸°ëŠ¥ ëª©ë¡ì€ ë§¤ìš° ì ì ˆí•©ë‹ˆë‹¤.
* ê°€ì¥ ì¤‘ìš”í•œ ë³€ê²½ì€ **"ìŠˆí¼ì–´ë“œë¯¼ ìƒì„± ê²½ë¡œì˜ ë³´ì•ˆ ê°•ë„"**ì…ë‹ˆë‹¤. 
* í˜„ì¬ í”„ë¡œì íŠ¸ëŠ” ì´ë¯¸ ì¢‹ì€ êµ¬ì¡°ë¥¼ ê°€ì§€ê³  ìˆìœ¼ë¯€ë¡œ, **ë¯¸ë“¤ì›¨ì–´ + ë ˆì´ì•„ì›ƒ ë³´í˜¸ + ì‹œë“œ ìŠ¤í¬ë¦½íŠ¸**ë§Œ ì¶”ê°€í•˜ë©´ ì•ˆì „í•˜ê³  ë¹ ë¥¸ ìŠˆí¼ì–´ë“œë¯¼ ëŒ€ì‹œë³´ë“œê°€ ë©ë‹ˆë‹¤.
* **í˜„ì¬ êµ¬ì¡°(`is_super_admin` í”Œë˜ê·¸)ë¥¼ ìœ ì§€**í•˜ëŠ” ê²ƒì´ í”„ë¡œì íŠ¸ì— ê°€ì¥ ì í•©í•©ë‹ˆë‹¤.

---

## ë‹¤ìŒ ë‹¨ê³„

1. âœ… ì‹œë“œ ìŠ¤í¬ë¦½íŠ¸ ìƒì„± (`scripts/seed-super-admin.ts`)
2. âœ… ë¯¸ë“¤ì›¨ì–´ ìƒì„± (`middleware.ts`)
3. âœ… ìŠˆí¼ ë ˆì´ì•„ì›ƒ ìƒì„± (`app/(super)/super/layout.tsx`)
4. âœ… `public.me` ë·° í™•ì¸ ë° ìƒì„± (ë§ˆì´ê·¸ë ˆì´ì…˜)
5. âœ… ëŒ€ì‹œë³´ë“œ ê°œì„  (ë³‘ë ¬ ì²˜ë¦¬)
6. âœ… í´ë¼ì´ì–¸íŠ¸ ê´€ë¦¬ í˜ì´ì§€ ìƒì„±
7. âœ… ì—ì´ì „ì‹œ ê´€ë¦¬ í˜ì´ì§€ ê°œì„ 

