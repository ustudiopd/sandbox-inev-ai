# eventflow.kr 핫패스 엔드포인트 목록 및 테이블 구분 키 정리

**기준**: 2026-02-08 코드/마이그레이션 기준  
**베이스 URL**: `https://eventflow.kr`

---

## 1. 핫패스 엔드포인트 목록

고빈도로 호출되는 엔드포인트만 정리합니다. (presence/ping, access/track, stats 폴링 등)

| 구분 | Method | URL 패턴 | 호출 주체 | 호출 시점 / 주기 | 비고 |
|------|--------|-----------|-----------|------------------|------|
| **Presence Ping** | POST | `/api/webinars/[webinarId]/presence/ping` | 참가자 | 시청 중 **120초 ± 10초** | 하트비트 + presence RPC, session_id 있으면 세션 heartbeat |
| **Access Track** | POST | `/api/webinars/[webinarId]/access/track` | 참가자 | **입장 시 1회**, 이후 **5분마다** | 세션/접속 로그, 자동 등록(upsert) |
| **Stats Access** | GET | `/api/webinars/[webinarId]/stats/access` | 관리자·참가자 | **5초마다** | 관리자 대시보드 + 참가자 화면 접속자 목록 |
| **Access Exit** | POST | `/api/webinars/[webinarId]/access/exit` | 참가자 | **퇴장 시 1회** | 세션 exited_at 기록 |
| **Register** | POST | `/api/webinars/[webinarId]/register` | 참가자 | 입장 시 1회 (자동 등록) | 등록 없을 때만 |
| **Messages (폴백)** | GET | `/api/webinars/[webinarId]/messages?after=...` | 참가자 | Realtime 실패 시 **약 2초±** 폴링 | 채팅 폴백, 서킷 브레이커 있음 |
| **Questions (폴백)** | GET | `/api/webinars/[webinarId]/questions?...)` | 참가자·관리자 | Realtime 실패 시 **5초** 폴링 | Q&A 폴백 |
| **Stats 통합** | GET | `/api/webinars/[webinarId]/stats?sections=...` | 관리자 | 대시보드 로딩/주기 | chat, qa, forms, giveaways, files, registrants, access, survey, sessions |
| **중복 로그인 체크** | - | Realtime Presence | 참가자 | **5초마다** | DB 직접 호출 없음, Realtime 채널만 |

### 1.1 호출 주기 요약

- **참가자 핫패스**: `presence/ping`(120초), `access/track`(입장+5분), `stats/access`(참가자 화면 5초)
- **관리자 핫패스**: `stats/access`(5초), `stats?...`(대시보드)
- **폴백 폴링**: `messages`(2초±), `questions`(5초) — Realtime 끊김 시만

---

## 2. 테이블 구분 키 (event_id / client_id 등)

### 2.1 event_id

- **현재 스키마에 `event_id` 컬럼은 없습니다.**  
- 이벤트 단위 구분은 **`webinar_id`**(웨비나), **`campaign_id`**(캠페인) 등으로 이루어집니다.

### 2.2 client_id / agency_id 가 있는 테이블

마이그레이션 기준으로 **client_id** 또는 **agency_id**가 있는 주요 테이블입니다.

| 테이블 | client_id | agency_id | 비고 |
|--------|-----------|-----------|------|
| `webinars` | ✅ (RLS/참조에서 사용) | ✅ | 웨비나 소속 클라이언트/에이전시 |
| `webinar_live_presence` | ✅ | ✅ | org 필드 |
| `webinar_access_logs` | ✅ | ✅ | org 필드 |
| `webinar_downloads` | ✅ | ✅ | org 필드 |
| `webinar_user_sessions` | ✅ | ✅ | org 필드 |
| `webinar_files` | ✅ | ✅ | not null |
| `registrations` | - | - | webinar_id, user_id만 (복합 PK) |
| `forms` | ✅ | ✅ | |
| `form_submissions` | ✅ | ✅ | |
| `form_answers` | ✅ | ✅ | |
| `quiz_attempts` | ✅ | ✅ | |
| `event_survey_campaigns` | ✅ | ✅ | |
| `event_survey_entries` | ✅ | ✅ | |
| `email_campaigns` | ✅ | ✅ | |
| `client_email_policies` | ✅ | - | |
| `campaign_link_meta` | ✅ | - | target_webinar_id 등 |
| `marketing_stats_daily` | ✅ | - | |
| `notes` | ✅ | - | |
| `note_comments` | (notes 경유) | - | |
| `client_invitations` | ✅ | - | |
| `questions` | ✅ (RLS) | ✅ | |
| `quizzes` / `quiz_responses` / `draws` / `reactions` | ✅ (RLS) | ✅ | |

### 2.3 웨비나/접속 관련 핵심 테이블 구분 키

| 테이블 | 구분 키 | 설명 |
|--------|---------|------|
| `webinars` | `id`, `slug`, `client_id`, `agency_id` | 웨비나 단위. event_id 없음 |
| `webinar_live_presence` | `webinar_id`, `user_id` (PK), `client_id`, `agency_id` | 현재 접속 presence |
| `webinar_user_sessions` | `webinar_id`, `session_id`, `client_id`, `agency_id` | 입장/퇴장/하트비트 |
| `webinar_access_logs` | `webinar_id`, `time_bucket`, `client_id`, `agency_id` | 5분 버킷 접속 통계 |
| `registrations` | `webinar_id`, `user_id` (복합 PK) | event_id, client_id 없음 |

---

## 3. 요약

1. **핫패스 엔드포인트**: `presence/ping`, `access/track`, `stats/access`가 고빈도. 참가자 5초 폴링(`stats/access`), 관리자 5초 폴링, Realtime 폴백 시 `messages`(2초±), `questions`(5초).
2. **event_id**: DB 테이블에 **없음**. 웨비나 단위는 `webinar_id`, 캠페인 단위는 `campaign_id` 사용.
3. **client_id / agency_id**: 웨비나·통계·폼·캠페인·마케팅·노트 등 대부분의 비즈니스 테이블에 **org 필드**로 존재.
