# 이메일 발송 시스템 - `>` 기호 제거 실패 오류 보고서

**작성일**: 2026년 2월 5일  
**버전**: 1.0  
**심각도**: 높음 (High)  
**상태**: 미해결 (Open)

---

## 1. 문제 요약

이메일 발송 시스템에서 마크다운을 HTML로 변환하는 과정에서 `>` 기호가 완전히 제거되지 않고 이메일 본문과 푸터에 계속 나타나는 문제가 발생하고 있습니다.

### 증상
- 이메일 본문의 거의 모든 문단 앞에 `>` 기호가 나타남
- 빈 줄에도 `>` 기호가 단독으로 나타남
- 불릿 리스트 항목에는 `>` 기호가 나타나지 않음 (정상)
- 푸터 섹션에도 동일한 문제 발생

---

## 2. 기술적 배경

### 사용 중인 기술 스택
- **마크다운 파서**: `marked` 라이브러리 (v4.x 이상 추정)
- **HTML Sanitization**: `sanitize-html` 라이브러리
- **파일 위치**: `lib/email/markdown-to-html.ts`

### 마크다운 처리 파이프라인
1. `protectDashText()`: 특정 패턴 보호/제거
2. `convertUnderline()`: 밑줄 문법 변환
3. `marked()`: 마크다운 → HTML 변환
4. `sanitizeHtml()`: XSS 방지 및 HTML 정제
5. `restoreDashText()`: 보호된 텍스트 복원
6. `addListStyles()`: 불릿 리스트 스타일 추가
7. 기타 후처리 함수들

---

## 3. 문제 분석

### 3.1 현재 구현된 제거 로직

#### 위치 1: `protectDashText()` 함수 (117-120번 줄)
```typescript
protectedMarkdown = protectedMarkdown.replace(/^>(.*)$/gm, (match, content) => {
  // > 기호와 그 뒤의 내용을 모두 제거 (빈 줄로 대체)
  return ''
})
```
**문제점**: 코드 블록 복원 전에 처리되어, 코드 블록 내부의 `>` 기호가 다시 나타날 수 있음

#### 위치 2: `markdownToHtml()` 함수 (415-420번 줄)
```typescript
htmlWithRestoredDash = htmlWithRestoredDash
  .replace(/&gt;\s+/g, '') // &gt; 뒤에 공백이 있는 경우
  .replace(/\s+&gt;/g, '') // &gt; 앞에 공백이 있는 경우
  .replace(/^&gt;/gm, '') // 줄 시작의 &gt;
  .replace(/&gt;$/gm, '') // 줄 끝의 &gt;
  .replace(/&gt;/g, '') // 모든 남은 &gt; 제거
```
**문제점**: 
- 정규식이 줄 단위(`/gm`)로 작동하지만, HTML 태그 내부의 `>` 기호를 제거하지 않도록 설계되어 있음
- 실제로는 HTML 태그 내부가 아닌 텍스트 노드의 `&gt;`를 제거해야 하는데, 현재 로직으로는 정확히 구분하지 못함

#### 위치 3: `convertLinksToButtons()` 함수 (319번 줄)
```typescript
const escapedText = textOnly.replace(/</g, '&lt;').replace(/>/g, '&gt;')
```
**문제점**: 링크 텍스트를 이스케이프할 때 `>` 기호를 `&gt;`로 변환하고 있어, 이후 제거 로직과 충돌 가능

### 3.2 근본 원인 추정

1. **`marked` 라이브러리의 blockquote 변환**
   - `marked`는 마크다운의 `>` 기호를 `<blockquote>` 태그로 변환
   - `protectDashText()`에서 `>` 기호를 제거했지만, `marked`가 변환하는 시점에 이미 blockquote가 생성되었을 수 있음
   - 또는 `marked`가 다른 방식으로 blockquote를 생성할 수 있음

2. **`sanitizeHtml`의 blockquote 허용**
   - `sanitizeHtml` 설정에서 `blockquote` 태그를 허용하고 있음 (378번 줄)
   - `marked`가 생성한 blockquote가 sanitization 과정을 통과하여 남아있을 수 있음

3. **제거 로직의 타이밍 문제**
   - `>` 기호 제거가 `protectDashText()`에서 이루어지지만, 이후 `marked` 변환 과정에서 다시 생성될 수 있음
   - blockquote 제거 로직이 있지만, 완전히 제거되지 않을 수 있음

4. **정규식의 한계**
   - 현재 `&gt;` 제거 정규식이 HTML 구조를 고려하지 않고 단순 문자열 치환만 수행
   - HTML 태그 내부와 텍스트 노드를 구분하지 못함

---

## 4. 재현 단계

1. 이메일 캠페인 편집 페이지에서 본문 텍스트 입력
2. 일반 텍스트 문단 작성 (예: "안녕하세요, 홍길동님!")
3. 불릿 리스트 추가 (예: "- 웨비나명 : ...")
4. 이메일 미리보기 또는 발송
5. 결과: 모든 문단 앞에 `>` 기호가 나타남

---

## 5. 시도한 해결 방법

### 시도 1: `protectDashText()`에서 `>` 기호를 placeholder로 교체
- **결과**: 실패 - placeholder가 복원되면서 `>` 기호가 다시 나타남

### 시도 2: `protectDashText()`에서 `>` 기호를 빈 문자열로 제거
- **결과**: 실패 - 여전히 `>` 기호가 나타남

### 시도 3: HTML 변환 후 `&gt;` 제거
- **결과**: 부분적 성공 - 일부 `&gt;`는 제거되지만 여전히 남아있음

### 시도 4: blockquote 태그 재귀적 제거
- **결과**: 부분적 성공 - blockquote는 제거되지만 `>` 기호는 여전히 나타남

---

## 6. 제안하는 해결 방안

### 방안 1: `marked` 라이브러리 설정 변경 (권장)

`marked` 라이브러리의 blockquote 렌더러를 비활성화하거나 커스텀 렌더러를 사용:

```typescript
import { marked } from 'marked'

// blockquote 렌더러 비활성화
const renderer = new marked.Renderer()
renderer.blockquote = (quote: string) => {
  // blockquote를 생성하지 않고 내용만 반환
  return quote
}

const htmlBody = marked(markdownWithUnderline, {
  breaks: true,
  gfm: true,
  renderer: renderer
}) as string
```

### 방안 2: `sanitizeHtml`에서 blockquote 태그 제거

`sanitizeHtml` 설정에서 `blockquote` 태그를 허용하지 않도록 변경:

```typescript
const sanitizedHtml = sanitizeHtml(htmlBody, {
  allowedTags: [
    'p', 'br', 'strong', 'em', 'u', 'a', 'ul', 'ol', 'li',
    'h1', 'h2', 'h3', 'h4', 'h5', 'h6',
    'img', 'code', 'pre'  // 'blockquote' 제거
  ],
  // ...
})
```

### 방안 3: HTML 파싱 후 텍스트 노드에서만 `>` 제거

DOM 파서를 사용하여 텍스트 노드에서만 `>` 기호를 제거:

```typescript
// 간단한 HTML 파서 사용 (jsdom 또는 cheerio)
// 텍스트 노드에서만 > 기호 제거
```

### 방안 4: 마크다운 전처리 강화

`protectDashText()` 함수를 개선하여 더 강력하게 `>` 기호 제거:

```typescript
// 코드 블록 마스킹
// > 기호 제거 (코드 블록 제외)
// 코드 블록 복원
// 다시 한 번 > 기호 제거 (코드 블록 내부 제외)
```

---

## 7. 우선순위 및 권장 사항

1. **즉시 적용 (High Priority)**
   - `sanitizeHtml` 설정에서 `blockquote` 태그 제거
   - `marked` 렌더러에서 blockquote 비활성화

2. **단기 개선 (Medium Priority)**
   - `protectDashText()` 함수 개선
   - HTML 변환 후 `>` 기호 제거 로직 강화

3. **장기 개선 (Low Priority)**
   - DOM 파서를 사용한 정확한 텍스트 노드 처리
   - 테스트 케이스 추가

---

## 8. 테스트 케이스

다음 테스트 케이스로 문제 해결 여부를 확인해야 합니다:

1. **일반 텍스트 문단**
   ```
   안녕하세요, 홍길동님!
   ```
   **기대 결과**: `>` 기호 없이 표시

2. **불릿 리스트**
   ```
   - 웨비나명 : 고객사례로 알아보는 AI 특허리서치 실무 활용 웨비나
   - 일시 : 2월 6일(금) 오후 2시 - 3시 30분
   ```
   **기대 결과**: `>` 기호 없이 표시, `-` 기호만 표시

3. **보호된 패턴**
   ```
   - 텍스트 - 
   ```
   **기대 결과**: 불릿 리스트로 변환되지 않고 그대로 표시

4. **푸터 텍스트**
   ```
   [문의처]
   메일문의: crm@wert.co.kr
   ```
   **기대 결과**: `>` 기호 없이 표시, 왼쪽 정렬

---

## 9. 참고 자료

- `marked` 라이브러리 문서: https://marked.js.org/
- `sanitize-html` 문서: https://www.npmjs.com/package/sanitize-html
- 관련 파일: `lib/email/markdown-to-html.ts`

---

## 10. 결론

현재 `>` 기호 제거 로직이 여러 단계에서 시도되고 있지만, `marked` 라이브러리의 blockquote 변환과 `sanitizeHtml`의 blockquote 허용으로 인해 완전히 제거되지 않고 있습니다. 

**권장 해결책**: `marked` 렌더러에서 blockquote를 비활성화하고, `sanitizeHtml` 설정에서 `blockquote` 태그를 제거하는 것이 가장 효과적일 것으로 예상됩니다.

---

**작성자**: AI Assistant  
**검토 필요**: 개발팀 리뷰 필요
