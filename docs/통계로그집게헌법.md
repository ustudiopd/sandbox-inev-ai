ì•„ë˜ëŠ” **â€œë°©ê¸ˆ ë‹µë³€(ì „ì²´ ì§‘ê³„ ë°©í–¥ì„±)â€ + ìš”ì²­í•˜ì‹  3ê°œ ì‚°ì¶œë¬¼(â‘ ë²„í‚· ìŠ¤í‚¤ë§ˆ/í‚¤ ì²´í¬ë¦¬ìŠ¤íŠ¸, â‘¡MV vs ì¦ë¶„ì§‘ê³„ ì„ íƒí‘œ, â‘¢session_id/UTM ì„œë²„ ì¤‘ì‹¬ ë³´ì¡´ ê·œì¹™)**ì„ **í•œ ë¬¸ì„œë¡œ í†µí•©**í•œ â€œì§‘ê³„ í—Œë²• ë¬¸ì„œâ€ì…ë‹ˆë‹¤.
Cursor Agentê°€ **ë°”ì´ë¸Œì½”ë”©ì„ í•´ë„ êµ¬ì¡°ê°€ í”ë“¤ë¦¬ì§€ ì•Šê²Œ** â€œê¸°ì¤€/ìˆœì„œ/ë¦¬ìŠ¤í¬/DoDâ€ ì¤‘ì‹¬ìœ¼ë¡œ ì‘ì„±í–ˆìŠµë‹ˆë‹¤.

> ì°¸ê³ : ì´ ë¬¸ì„œëŠ” í˜„ì¬ ì‹œìŠ¤í…œ í˜„í™©/ë¬¸ì œ/ê°œì„ ì•ˆì˜ ê·¼ê±°ë¥¼ â€œì¢…í•© ê²€í†  ë³´ê³ ì„œ(2026-02-02)â€ì™€ â€œì›ŒíŠ¸ Visit ì¥ì•  ëª…ì„¸ì„œ(2026-02-02)â€ ë° â€œí†µê³„ ëª…ì„¸ v2â€ì— ê¸°ë°˜í•´ ê³ ì •í•©ë‹ˆë‹¤.   

---

# EventFlow í†µê³„Â·ë¡œê·¸Â·ì§‘ê³„ ì‹œìŠ¤í…œ í—Œë²• v1

(ì¢…í•© ê²€í†  + ì‹¤í–‰ ì§€ì¹¨ + ì„ íƒí‘œ + ì²´í¬ë¦¬ìŠ¤íŠ¸)

## 1) ëª©ì 

### ëª©ì 

* **ì‹œìŠ¤í…œ ì „ì²´ â€œì§‘ê³„(Product Stats)â€ë¥¼ ì•ˆì •í™”**í•´ì„œ, ìš´ì˜/ì •ì‚°/ë¦¬í¬íŠ¸ì—ì„œ **ì¼ê´€ëœ ìˆ«ì**ë¥¼ ì œê³µí•œë‹¤.
* **Serverless + B2B2C + ë¼ì´ë¸Œ ì•ˆì •ì„±** ì œì•½ í•˜ì—ì„œ, ì§‘ê³„ê°€ **ëŠë¦¬ê±°ë‚˜ í‹€ë¦¬ê±°ë‚˜ ë©ˆì¶”ëŠ” ì‚¬ê³ **ë¥¼ êµ¬ì¡°ì ìœ¼ë¡œ ë°©ì§€í•œë‹¤.
* ë°”ì´ë¸Œì½”ë”©(ë¶„ì‚° êµ¬í˜„)ì—ë„ **íŒŒí¸í™”ê°€ ì¬ë°œí•˜ì§€ ì•Šë„ë¡** â€œí—Œë²• ê·œì¹™â€ì„ ë¬¸ì„œë¡œ ê³ ì •í•œë‹¤.

### ì™œ í•„ìš”í•œê°€ (í˜„í™© ê·¼ê±°)

* Visit ì»¤ë²„ë¦¬ì§€ ëˆ„ë½(WelcomePage, WebinarView ë“±) ë° êµ¬ì¡°í™” ë¡œê·¸/ë³µì› ê²½ë¡œ ë¶€ì¬ê°€ ë³´ê³ ì„œì— ëª…ì‹œë¨. 
* ë§ˆì¼€íŒ… ìš”ì•½/ë§í¬ í†µê³„ëŠ” ìƒë‹¹ ë¶€ë¶„ â€œì¿¼ë¦¬ ì‹œì  ì§‘ê³„â€ë¡œ ë‚¨ì•„ìˆê³ , ë°ì´í„°ê°€ ì»¤ì§€ë©´ ì„±ëŠ¥Â·ë¹„ìš© ë¬¸ì œê°€ ì»¤ì§. 
* Visitâ†”ë“±ë¡ ì—°ê²°ë¥ (session_id ë¶ˆì¼ì¹˜)ê³¼ UTM ì¶”ì ë¥  ì €í•˜ê°€ â€œğŸ”´ ë†’ìŒâ€ ë¬¸ì œë¡œ ì •ë¦¬ë¨. 
* ì‹¤ì œë¡œ ì›ŒíŠ¸ì—ì„œ â€œì˜¤ëŠ˜ ë“±ë¡ ì •ìƒì¸ë° ì˜¤ëŠ˜ Visit 0â€ ìƒíƒœê°€ ë°œìƒí–ˆê³ (ì›ì¸: cid ê´€ë ¨), ì´ëŠ” **íŒ©íŠ¸ ìˆ˜ì§‘ì´ â€˜ì°¨ì›/ë©”íƒ€â€™ì— ì˜í•´ ê¹¨ì§ˆ ìˆ˜ ìˆìŒì„ ì¦ëª…**í–ˆë‹¤. 

---

## 2) ì „ì œ ì¡°ê±´ (ë°”ê¾¸ë©´ ì•ˆ ë˜ëŠ” ê²ƒ)

### ë¶ˆë³€ ì „ì œ

1. **í™˜ê²½**: Next.js App Router + Supabase + Vercel Serverless

   * ìš´ì˜ì—ì„œ **ì§€ì† íŒŒì¼ ì“°ê¸°**ëŠ” ì‹ ë¢° ë¶ˆê°€ (ë¡œê·¸ íŒŒì¼ ê¸°ë°˜ ì„¤ê³„ëŠ” ì›ì¹™ì ìœ¼ë¡œ ê¸ˆì§€).
2. **ë©€í‹°í…Œë„Œì‹œ**: Agency â†’ Client â†’ Participant êµ¬ì¡°ëŠ” ë¶ˆë³€

   * ì§‘ê³„/ì¡°íšŒëŠ” í•­ìƒ â€œëˆ„ê°€, ì–´ëŠ ì´ë²¤íŠ¸/í´ë¼ì´ì–¸íŠ¸ì— ëŒ€í•´, ì–´ë””ê¹Œì§€ ë³´ëŠ”ì§€â€ë¥¼ ì„¤ëª…í•  ìˆ˜ ìˆì–´ì•¼ í•¨.
3. **ë¼ì´ë¸Œ ì•ˆì •ì„±**: ì°¸ê°€ì ë¼ì´ë¸Œ í˜ì´ì§€ì—ì„œëŠ” **ì§‘ê³„/ë¬´ê±°ìš´ ì¿¼ë¦¬/AI í˜¸ì¶œ ê¸ˆì§€**

   * í†µê³„ ëª…ì„¸ v2ì˜ ì›ì¹™(ë¼ì´ë¸ŒëŠ” í•‘/ì—…ì„œíŠ¸ 1í–‰, ì§‘ê³„ëŠ” í¬ë¡ +ë²„í‚·) ì¤€ìˆ˜. 
4. **ì œí’ˆ í†µê³„(Source of Truth)**ëŠ” PostHog/GA/Vercel Analyticsë¡œ ëŒ€ì²´ ë¶ˆê°€

   * ê³ ê° ë¦¬í¬íŠ¸/ì •ì‚°/ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ ìˆ«ìëŠ” **DB ê¸°ë°˜ ì œí’ˆ í†µê³„**ê°€ ìµœì¢… ì§„ì‹¤.

### ë³€ê²½ì´ í•„ìš”í•  ë•Œ(ì˜ˆì™¸ ì ˆì°¨)

* í…Œì´ë¸”/ì •ì±…/ê¶Œí•œ/ëª…ì„¸ë¥¼ ë°”ê¿”ì•¼ í•œë‹¤ë©´, ë°˜ë“œì‹œ ì•„ë˜ 3ê°€ì§€ë¥¼ ë¨¼ì € ë¬¸ì„œë¡œ ë‚¨ê¸´ë‹¤:

  * ë³€ê²½ í•„ìš” ì‚¬ìœ 
  * ì˜í–¥ ë²”ìœ„(ì–´ë–¤ í™”ë©´/ë¦¬í¬íŠ¸/ì •ì‚°ì— ì˜í–¥?)
  * ë¡¤ë°± ê°€ëŠ¥ì„±(ë˜ëŒë¦¬ëŠ” ì „ëµ)

---

## 3) í•µì‹¬ ì•„í‚¤í…ì²˜ ì›ì¹™ (í—Œë²•)

### ì›ì¹™ 1 â€” Fact(ì‚¬ì‹¤)ì™€ Analysis(í•´ì„)ì„ ë¶„ë¦¬í•œë‹¤

* Fact: `event_access_logs`, `event_survey_entries`, `webinar_live_presence`, `webinar_access_logs` ë“± **ì›ì²œ ë¡œê·¸/ì‹ í˜¸**
* Analysis: ì¼/ì‹œê°„ ë²„í‚· ì§‘ê³„, í¼ë„ ìš”ì•½, ë§í¬ë³„ ìš”ì•½ ë“± **ì‚¬ì „ ì§‘ê³„/ìš”ì•½ í…Œì´ë¸” ë˜ëŠ” ìºì‹œ**

> ì§‘ê³„ëŠ” Factê°€ ì•ˆì •ì ìœ¼ë¡œ ìŒ“ì¸ ë’¤ì—ë§Œ ì˜ë¯¸ê°€ ìˆë‹¤. (ë³´ê³ ì„œì˜ â€œì¿¼ë¦¬ ì‹œì  ì§‘ê³„ê°€ ë§ë‹¤â€ ë¬¸ì œë¥¼ êµ¬ì¡°ì ìœ¼ë¡œ í•´ê²°) 

### ì›ì¹™ 2 â€” â€œì°¨ì›(dimension) ë¶€ì¬â€ê°€ Fact ìˆ˜ì§‘ì„ ê¹¨ë©´ ì•ˆ ëœë‹¤

* ë„ˆê°€ ë°©ê¸ˆ ê³ ì¹œ â€œcid DB ì—†ì–´ì„œ Visitì´ ê¹¨ì§â€ì€ **í—Œë²•ìœ¼ë¡œ ìŠ¹ê²©**í•´ì•¼ í•˜ëŠ” êµí›ˆì´ë‹¤.
* ê·œì¹™:

  * Fact ì €ì¥ì€ ì–´ë–¤ ê²½ìš°ì—ë„ ì„±ê³µí•´ì•¼ í•œë‹¤(ìµœì†Œ í•„ë“œë§Œìœ¼ë¡œ).
  * CID/ë§í¬/UTM ë©”íƒ€ëŠ” â€œë‚˜ì¤‘ì— ë³´ê°•(enrichment)â€í•œë‹¤(LEFT JOIN, ë°°ì¹˜ ë³´ê°•).
  * ë©”íƒ€ê°€ ì—†ìœ¼ë©´ `unknown/unresolved`ë¡œ ë¶„ë¦¬ í‘œê¸°í•˜ê³ , ì§‘ê³„ì—ì„œ ë”°ë¡œ ì¹´ìš´íŠ¸í•œë‹¤.

> ì›ŒíŠ¸ ì¥ì•  ë¬¸ì„œì—ì„œ â€œì‹¤íŒ¨ê°€ ì™„ì „íˆ ë¬´ì‹œë˜ì–´ ë””ë²„ê¹…ì´ ë¶ˆê°€ëŠ¥â€í–ˆë˜ ì ë„ í•¨ê»˜ ë°©ì§€í•´ì•¼ í•œë‹¤. 

### ì›ì¹™ 3 â€” â€œì›¨ë¹„ë‚˜ ì ‘ì† í†µê³„ v2 íŒ¨í„´â€ì„ í‘œì¤€ìœ¼ë¡œ í™•ì¥í•œë‹¤

* Live page: presence ping(ê°€ë²¼ìš´ upsert)
* Cron: 1ë¶„ë§ˆë‹¤ ì§‘ê³„
* Storage: 5ë¶„ ë²„í‚· upsert ëˆ„ì 
* Read: ê´€ë¦¬ì APIëŠ” ë²„í‚· í…Œì´ë¸” ì¤‘ì‹¬ ì¡°íšŒ


> ë§ˆì¼€íŒ… í†µê³„ë„ ê²°êµ­ ì´ íŒ¨í„´ì´ Serverless + ë¼ì´ë¸Œ ì•ˆì •ì„±ì—ì„œ ê°€ì¥ ìš´ì˜ ì¹œí™”ì ì´ë‹¤.

### ì›ì¹™ 4 â€” ì§‘ê³„ëŠ” ì™¸ë¶€ ë¼ì´ë¸ŒëŸ¬ë¦¬ì— â€œìœ„ì„â€í•˜ì§€ ì•ŠëŠ”ë‹¤ (í‘œí˜„/ê²€ì¦/ìºì‹±ë§Œ í—ˆìš©)

* ì§‘ê³„ëŠ” ì •ì‚°/ë¦¬í¬íŠ¸/ì‹ ë¢°ì™€ ì§ê²°ë˜ëŠ” ë„ë©”ì¸ ë¡œì§ì´ë‹¤.
* ì™¸ë¶€ ë¼ì´ë¸ŒëŸ¬ë¦¬ëŠ”:

  * ê´€ë¦¬ì ë·° ìºì‹±(SWR/TanStack Query)
  * API ì‘ë‹µ ìŠ¤í‚¤ë§ˆ ê³ ì •(zod)
  * ì°¨íŠ¸ ë Œë”ë§(Recharts ë“±)
  * í–‰ë™ ë¶„ì„(PostHog, ë‹¨ DB í†µê³„ ëŒ€ì²´ ë¶ˆê°€)
    ê°™ì€ **ë³´ì¡° ì—­í• **ì—ë§Œ ì‚¬ìš©í•œë‹¤.

---

## 4) ëª©í‘œ ì•„í‚¤í…ì²˜ (3ê³„ì¸µ + 1ë³´ì¡°)

### 4.1 3ê³„ì¸µ(ì œí’ˆ í†µê³„)

1. **Fact ingestion**: ì›ì²œ ë¡œê·¸/ì‹ í˜¸ë¥¼ DBì— ì €ì¥ (ì ˆëŒ€ ì°¨ë‹¨ ê¸ˆì§€)
2. **Aggregation engine**: í¬ë¡ /ë°°ì¹˜ë¡œ ì¦ë¶„ ì§‘ê³„(upsert) â†’ ë²„í‚·/ìš”ì•½ ì €ì¥
3. **Admin API/Views**: ê¸°ë³¸ì€ ì§‘ê³„ í…Œì´ë¸”ë¡œ ì‘ë‹µ, ë“œë¦´ë‹¤ìš´ë§Œ raw ì¡°íšŒ

### 4.2 1ë³´ì¡°(í–‰ë™ ë¶„ì„)

* PostHog ë“±ì€ â€œí¼ë„/ê²½ë¡œ/ì´íƒˆâ€ ë¶„ì„ ë³´ì¡°
* ì œí’ˆ í†µê³„ DBë¥¼ ëŒ€ì²´í•˜ì§€ ì•ŠìŒ

---

## 5) êµ¬í˜„ ìš°ì„ ìˆœìœ„ (ë¡œë“œë§µ)

### Phase 0 â€” ìˆ˜ì§‘ ì•ˆì •ì„±/í’ˆì§ˆ(ì§‘ê³„ì˜ ì „ì œ)

* Visit/ë“±ë¡ ì—°ê²°(session_id) ê·œì¹™ì„ ì„œë²„ ì¤‘ì‹¬ìœ¼ë¡œ í†µì¼
* UTM ë³´ì¡´ ê·œì¹™ í™•ë¦½ (ë¦¬ë‹¤ì´ë ‰íŠ¸/CSR/SSR í”ë“¤ë¦¼ ë°©ì§€)
* Fact ì €ì¥ì´ dimensionì— ì˜í•´ ê¹¨ì§€ì§€ ì•Šê²Œ ë°©ì–´(ì´ë²ˆ cid ì‚¬ê³  ì¬ë°œ ë°©ì§€)
* ì‹¤íŒ¨ëŠ” ì‚¬ìš©ì UXì— ì „íŒŒí•˜ì§€ ì•Šë˜, **ì‹¤íŒ¨ ì‹œ êµ¬ì¡°í™” ë¡œê·¸**ë¡œ ì›ì¸ ì¶”ì  ê°€ëŠ¥í•´ì•¼ í•¨ 

### Phase 1 â€” â€œì¦ë¶„ ì§‘ê³„ í…Œì´ë¸”â€ ë„ì… (ë§ˆì¼€íŒ… ìš”ì•½/ë§í¬ í†µê³„)

* ì¿¼ë¦¬ ì‹œì  ì§‘ê³„ë¥¼ ì ì§„ì ìœ¼ë¡œ ë²„í‚· ì§‘ê³„ë¡œ ëŒ€ì²´ (ë³´ê³ ì„œì˜ ê°œì„  ë°©í–¥ì„ Serverless ì¹œí™”ì ìœ¼ë¡œ ì‹¤í˜„) 

### Phase 2 â€” í†µí•© Overview APIëŠ” ë§ˆì§€ë§‰ì—

* ì§‘ê³„ í…Œì´ë¸”ì´ ì¤€ë¹„ëœ ë‹¤ìŒì—, â€œì¡°ë¦½â€ë§Œ í•˜ëŠ” ì–‡ì€ APIë¡œ ë§Œë“ ë‹¤
* ì§‘ê³„ê°€ ì—†ëŠ” ìƒíƒœì—ì„œ overviewë¶€í„° ë§Œë“¤ë©´, ê²°êµ­ ê°€ì¥ ë¬´ê±°ìš´ ì—”ë“œí¬ì¸íŠ¸ê°€ ëœë‹¤

---

# [ì‚°ì¶œë¬¼ 1] ë§ˆì¼€íŒ… ì§‘ê³„ ë²„í‚· ìŠ¤í‚¤ë§ˆ/í‚¤ ì„¤ê³„ ì²´í¬ë¦¬ìŠ¤íŠ¸

> ëŒ€ìƒ: ìº í˜ì¸ ìš”ì•½(get_marketing_summary), ë§í¬ë³„ í†µê³„(Visits/Conversions/CVR) ì„±ëŠ¥Â·ì •í•©ì„± ê°œì„  

## 1) ëª©ì 

* ìì£¼ ì¡°íšŒë˜ëŠ” ê¸°ê°„(ìµœê·¼ 7/30ì¼, ì›”ê°„ ë“±)ì„ **1ì´ˆ ë‚´**ë¡œ ì‘ë‹µí•˜ê¸° ìœ„í•œ â€œì‚¬ì „ ì§‘ê³„ ì €ì¥ì†Œâ€ ì„¤ê³„
* ì¬ì‹¤í–‰/ë°±í•„(backfill)/ì •ì •ì´ ê°€ëŠ¥í•œ **ë©±ë“±(upsert) ì§‘ê³„** êµ¬ì¡° í™•ë³´

## 2) ì „ì œ

* Fact ì†ŒìŠ¤ëŠ” ê¸°ì¡´ í…Œì´ë¸”ì„ ë³€ê²½í•˜ì§€ ì•Šê³  ì‚¬ìš©í•œë‹¤:

  * Visit: `event_access_logs`
  * Conversion: `event_survey_entries` 
* CID/ë§í¬ ë©”íƒ€ëŠ” optionalì´ë‹¤(ì—†ì–´ë„ FactëŠ” ì €ì¥ë˜ì–´ì•¼ í•¨).

## 3) ê²°ì • í¬ì¸íŠ¸

### (A) ë²„í‚· ë‹¨ìœ„(granularity)

* **ê¸°ë³¸**: â€œì¼ ë‹¨ìœ„ ë²„í‚·â€ì„ í‘œì¤€ìœ¼ë¡œ
* **í•„ìš” ì‹œ**: â€œì‹œê°„ ë‹¨ìœ„ ë²„í‚·â€ì€ íŠ¸ë˜í”½ì´ ë§ì€ ê³ ê°/ìº í˜ì¸ì—ë§Œ ì„ íƒì ìœ¼ë¡œ

**ì„ íƒ ê¸°ì¤€**

* ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œê°€ â€œì‹œê°„ëŒ€ë³„â€ì„ ìš”êµ¬í•˜ê³ , raw ì¡°íšŒê°€ ëŠë¦¬ë©´ â†’ ì‹œê°„ ë²„í‚· ê³ ë ¤
* ê·¸ ì™¸ëŠ” ì¼ ë²„í‚·ìœ¼ë¡œ ì¶©ë¶„(ìš´ì˜ ë³µì¡ë„â†“)

### (B) ì§‘ê³„ ì°¨ì›(dimension) ì„¸íŠ¸

* ìµœì†Œ ì°¨ì›(í•„ìˆ˜): `client_id`, `bucket_date`, `campaign_id(ë˜ëŠ” webinar_id ê³„ì—´)`, `link_id(ìˆìœ¼ë©´)`
* ì„ íƒ ì°¨ì›(ì˜µì…˜): `utm_source`, `utm_medium`, `utm_campaign`, `cid` ë“±

**ì„ íƒ ê¸°ì¤€**

* â€œëŒ€ì‹œë³´ë“œì—ì„œ ì‹¤ì œë¡œ í•„í„°/ê·¸ë£¹í•‘ í•˜ëŠ” ì°¨ì›ë§Œâ€ ì§‘ê³„ í…Œì´ë¸”ì— ë„£ëŠ”ë‹¤.
* ì°¨ì›ì´ ë§ì•„ì§ˆìˆ˜ë¡ row ìˆ˜ê°€ í­ì¦í•œë‹¤ â†’ **ì°¨ì› í­ë°œì„ ë§‰ëŠ” ê²Œ í•µì‹¬**

## 4) â€œí‚¤(Primary/Unique key)â€ ì„¤ê³„ ì²´í¬ë¦¬ìŠ¤íŠ¸ (ë©±ë“± upsertì˜ í•µì‹¬)

### í‚¤ ì„¤ê³„ ì›ì¹™

* **í•œ ë²„í‚·ì˜ í•œ ì§‘ê³„ ë‹¨ìœ„ëŠ” í•­ìƒ ë™ì¼ í‚¤ë¡œ ì¬ê³„ì‚°/ì¬ì—…ì„œíŠ¸ ê°€ëŠ¥**í•´ì•¼ í•¨
* í‚¤ëŠ” â€œì‹ë³„ì + ì‹œê°„ ë²„í‚· + ì°¨ì›â€ì˜ ì¡°í•©

### í‚¤ ì²´í¬ë¦¬ìŠ¤íŠ¸

* [ ] í‚¤ì— `client_id`ê°€ í¬í•¨ë˜ëŠ”ê°€? (ë©€í‹°í…Œë„Œì‹œ ê²©ë¦¬)
* [ ] í‚¤ì— `bucket_date`(ë˜ëŠ” bucket_start)ê°€ í¬í•¨ë˜ëŠ”ê°€?
* [ ] ìº í˜ì¸/ë§í¬ ì‹ë³„ì(`campaign_id` ë˜ëŠ” `marketing_campaign_link_id`)ê°€ í¬í•¨ë˜ëŠ”ê°€? 
* [ ] `utm_*`, `cid` ê°™ì€ optional ì°¨ì›ì€ NULLì„ í—ˆìš©í•˜ëŠ”ê°€? (ì—†ìœ¼ë©´ `unknown` ê·¸ë£¹ìœ¼ë¡œ ë¶„ë¦¬)
* [ ] ë™ì¼ Factë¥¼ ì¤‘ë³µ ì§‘ê³„í•˜ì§€ ì•Šë„ë¡ â€œì§‘ê³„ ê¸°ì¤€(ì˜ˆ: distinct session_id)â€ê°€ ì •ì˜ë¼ ìˆëŠ”ê°€?

> ì¤‘ë³µ ë°©ì§€(íŠ¹íˆ StrictMode/ì´ì¤‘ í˜¸ì¶œ)ëŠ” â€œì§‘ê³„ ì •ì˜â€ì—ì„œ í¡ìˆ˜í•´ì•¼ í•œë‹¤. (ìˆ˜ì§‘ì—ì„œ ì™„ì „ ì°¨ë‹¨ì€ í˜„ì‹¤ì ìœ¼ë¡œ ì–´ë µë‹¤)

## 5) ì§‘ê³„ ì§€í‘œ(measure) ì •ì˜ ì²´í¬ë¦¬ìŠ¤íŠ¸ (ìˆ«ì ë¶„ìŸ ë°©ì§€)

### Visits ì •ì˜

* ê¶Œì¥: `visits = COUNT(DISTINCT session_id)`

  * ê°™ì€ ì‚¬ëŒì´ ê°™ì€ ë‚  ì—¬ëŸ¬ ë²ˆ ì™€ë„ â€œì„¸ì…˜ ê¸°ì¤€â€ìœ¼ë¡œ í†µì¼

### Conversions ì •ì˜

* ê¶Œì¥: `conversions = COUNT(entries)` ë˜ëŠ” `COUNT(DISTINCT entry_id)`

  * ì–´ë–¤ ê²ƒì´ â€œì „í™˜ 1íšŒâ€ì¸ì§€ ê¸°ì¤€ì„ ë¬¸ì„œë¡œ ê³ ì •í•´ì•¼ í•¨

### CVR ì •ì˜

* `cvr = conversions / visits`
* 0 division(ë°©ë¬¸ 0) ì²˜ë¦¬ ê·œì¹™ ê³ ì •

### í•„ìˆ˜ ì²´í¬

* [ ] Visit/Conversion ì •ì˜ê°€ â€œëŒ€ì‹œë³´ë“œ/ì •ì‚°â€ì—ì„œ ë™ì¼í•˜ê²Œ ì“°ì´ëŠ”ê°€?
* [ ] ë™ì¼ ê¸°ê°„ì— raw ì¬ê²€ì‚° í–ˆì„ ë•Œ ìˆ˜ì¹˜ê°€ ë§ëŠ”ê°€(ìƒ˜í”Œë§ ê²€ì¦)?

## 6) Dimension ë¶€ì¬/ë¶ˆì¼ì¹˜ ë°©ì–´ ì²´í¬ë¦¬ìŠ¤íŠ¸ (ë„ˆê°€ ê²ªì€ cid ì‚¬ê³  ì¬ë°œ ë°©ì§€)

* [ ] CID ë©”íƒ€ í…Œì´ë¸”ì´ ì—†ì–´ë„ Fact insertê°€ ì„±ê³µí•˜ëŠ”ê°€? (LEFT JOIN/nullable)
* [ ] ë§í¬ ë©”íƒ€ê°€ ì—†ì–´ë„ `marketing_campaign_link_id` ìì²´ëŠ” ì €ì¥/ì§‘ê³„ ê°€ëŠ¥í•œê°€? 
* [ ] â€œunknown/unresolvedâ€ ë²„í‚·ì„ ë³„ë„ ì¹´ìš´íŠ¸í•´ì„œ ìš´ì˜ìê°€ ë°ì´í„° í’ˆì§ˆì„ ë³¼ ìˆ˜ ìˆëŠ”ê°€?

## 7) ì„±ëŠ¥/ì¸ë±ìŠ¤ ì²´í¬ë¦¬ìŠ¤íŠ¸ (Serverless ë¹„ìš© ë°©ì§€)

* [ ] ì§‘ê³„ jobì´ â€œì „ ê¸°ê°„ í’€ìŠ¤ìº”â€ì„ í•˜ì§€ ì•Šë„ë¡ ìœˆë„ìš° ê¸°ë°˜(ìµœê·¼ Nì¼, ë˜ëŠ” watermark ê¸°ë°˜)ìœ¼ë¡œ ë™ì‘í•˜ëŠ”ê°€?
* [ ] Fact í…Œì´ë¸”ì— ì‹œê°„ í•„í„°(accessed_at/created_at)ë¡œ ë²”ìœ„ ìŠ¤ìº” ê°€ëŠ¥í•œ ì¸ë±ìŠ¤ê°€ ìˆëŠ”ê°€?
* [ ] ì§‘ê³„ í…Œì´ë¸”ì€ í‚¤ ê¸°ë°˜ upsertê°€ íš¨ìœ¨ì ì¸ê°€(ìœ ë‹ˆí¬ ì¸ë±ìŠ¤)?

## 8) ìš´ì˜/ë°±í•„ ì²´í¬ë¦¬ìŠ¤íŠ¸

* [ ] ì§‘ê³„ jobì€ ë©±ë“±ì¸ê°€? (ê°™ì€ êµ¬ê°„ ì¬ì‹¤í–‰í•´ë„ ê²°ê³¼ ë™ì¼)
* [ ] ë°±í•„(backfill) ëª¨ë“œê°€ ì¡´ì¬í•˜ëŠ”ê°€? (íŠ¹ì • ë‚ ì§œ êµ¬ê°„ ì¬ì§‘ê³„)
* [ ] ì‹¤íŒ¨ ì‹œ ì•Œë¦¼/ì¬ì‹œë„ ì •ì±…ì´ ìˆëŠ”ê°€? (ìµœì†Œ êµ¬ì¡°í™” ë¡œê·¸)

## DoD (ì™„ë£Œ ì¡°ê±´)

* [ ] ìµœê·¼ 7/30ì¼ ê¸°ë³¸ ëŒ€ì‹œë³´ë“œê°€ ì§‘ê³„ í…Œì´ë¸”ë§Œìœ¼ë¡œ ì‘ë‹µ ê°€ëŠ¥
* [ ] ìƒ˜í”Œ ê¸°ê°„ì—ì„œ raw vs aggregate ê°’ì´ ì¼ì¹˜
* [ ] CID/ë§í¬ ë©”íƒ€ ë¶€ì¬ì—ë„ ë°©ë¬¸/ì „í™˜ì´ 0ìœ¼ë¡œ ë–¨ì–´ì§€ì§€ ì•ŠìŒ(unknown ê·¸ë£¹ìœ¼ë¡œ í¡ìˆ˜)
* [ ] ì§‘ê³„ jobì€ ì¬ì‹¤í–‰/ë°±í•„ ê°€ëŠ¥(ë©±ë“±)

---

# [ì‚°ì¶œë¬¼ 2] Materialized View vs ì¦ë¶„ ì§‘ê³„ í…Œì´ë¸” ì„ íƒí‘œ (ìš´ì˜/ë¹„ìš©/ì •í•©ì„±)

ë³´ê³ ì„œëŠ” MV(ì˜ˆ: ìº í˜ì¸ daily MV)ë¥¼ ì œì•ˆí•˜ì§€ë§Œ, ìš´ì˜ í™˜ê²½(Serverless)ì—ì„œëŠ” â€œìš´ì˜ ë‚œì´ë„/ë³µì›/ì•Œë¦¼â€ê¹Œì§€ í¬í•¨í•´ì„œ ì„ íƒí•´ì•¼ í•©ë‹ˆë‹¤. 

## ë¹„êµí‘œ

| í•­ëª©             | Materialized View (MV)       | ì¦ë¶„ ì§‘ê³„ í…Œì´ë¸”(ë²„í‚· upsert)       |
| -------------- | ---------------------------- | -------------------------- |
| ê³„ì‚° ì‹œì           | Refresh ì‹œ ì¼ê´„ ì¬ê³„ì‚°             | í¬ë¡ /ì¡ì´ ìœˆë„ìš° ë‹¨ìœ„ë¡œ ì¦ë¶„ ê³„ì‚°        |
| ì‹ ì„ ë„            | Refresh ì£¼ê¸° ì˜ì¡´(ì§€ì—° í—ˆìš© í•„ìš”)      | ì£¼ê¸°/ìœˆë„ìš°ë¡œ ì¡°ì ˆ ê°€ëŠ¥(ê°€ê¹Œìš´ ì‹¤ì‹œê°„ ê°€ëŠ¥)  |
| ìš´ì˜ ë‚œì´ë„         | Refresh ìŠ¤ì¼€ì¤„/ë½/ê¶Œí•œ/ì‹¤íŒ¨ ê°ì§€ í•„ìš”    | ì¡(í¬ë¡ ) ìš´ì˜ì´ í•„ìš”í•˜ì§€ë§Œ ì œì–´ ë²”ìœ„ê°€ ëª…í™•  |
| ì¥ì•  ì‹œ ì˜í–¥        | MV refresh ì‹¤íŒ¨ ì‹œ â€œì „ë¶€ ì˜¤ë˜ëœ ê°’â€   | ì¼ë¶€ ë²„í‚·ë§Œ ëˆ„ë½ â†’ ì˜í–¥ ë²”ìœ„ ì¢ìŒ       |
| ë°±í•„/ì •ì •          | íŠ¹ì • ê¸°ê°„ë§Œ ë¶€ë¶„ refreshê°€ ê¹Œë‹¤ë¡œìš¸ ìˆ˜ ìˆìŒ | ê¸°ê°„ ì§€ì • ì¬ì§‘ê³„(ë©±ë“± upsert) ì‰¬ì›€    |
| ë©€í‹°í…Œë„Œì‹œ          | MVëŠ” ì „ í…Œë„ŒíŠ¸ ë°ì´í„°ê°€ ë­‰ì¹¨(í•„í„°ë§/ê¶Œí•œ ì£¼ì˜) | client_id ê¸°ì¤€ ë¶„ë¦¬ ì„¤ê³„ ê°€ëŠ¥      |
| ë¹„ìš©/ì„±ëŠ¥          | ë°ì´í„° ì»¤ì§€ë©´ refresh ë¹„ìš© ê¸‰ì¦        | ìœˆë„ìš°/ì›Œí„°ë§ˆí¬ë¡œ ë¹„ìš© í†µì œ ìš©ì´         |
| ë””ë²„ê¹…            | ë‚´ë¶€ ê²°ê³¼ê°€ â€œë¸”ë™ë°•ìŠ¤â€ì— ê°€ê¹Œì›€           | ë²„í‚· ë‹¨ìœ„ë¡œ ì›ì¸ ì¶”ì  ì‰¬ì›€            |
| Serverless ì í•©ì„± | refresh íŠ¸ë¦¬ê±°/ìŠ¤ì¼€ì¤„ ìš´ì˜ì´ ê´€ê±´       | HTTP cron + upsert íŒ¨í„´ìœ¼ë¡œ ì í•© |

## ì„ íƒ ê¸°ì¤€(í—Œë²• ê·œì¹™)

### MVë¥¼ ì„ íƒí•  ìˆ˜ ìˆëŠ” ì¡°ê±´(ëª¨ë‘ ë§Œì¡±í•´ì•¼ í•¨)

* [ ] Refresh ìŠ¤ì¼€ì¤„/ì‹¤íŒ¨ ì•Œë¦¼/ì¬ì‹œë„ë¥¼ ìš´ì˜í•  ì¤€ë¹„ê°€ ìˆë‹¤
* [ ] staleness(ì˜ˆ: 1ì‹œê°„ ì§€ì—° ë“±)ë¥¼ ì œí’ˆì´ í—ˆìš©í•œë‹¤
* [ ] ë°ì´í„° ê·œëª¨ê°€ ì»¤ì ¸ë„ refresh ë¹„ìš©ì´ í—ˆìš© ë²”ìœ„ë‹¤
* [ ] ë©€í‹°í…Œë„Œì‹œ í•„í„°/ê¶Œí•œì´ MVì—ì„œ ì•ˆì „í•˜ê²Œ ë³´ì¥ëœë‹¤

### ê·¸ ì™¸(ê¸°ë³¸ê°’)

* **ì¦ë¶„ ì§‘ê³„ í…Œì´ë¸”(ë²„í‚· upsert)**ì„ ê¸°ë³¸ìœ¼ë¡œ í•œë‹¤
* ì´ìœ : ì›¨ë¹„ë‚˜ ì ‘ì† í†µê³„ v2 íŒ¨í„´(í¬ë¡  + ë²„í‚·)ì´ ì´ë¯¸ ê²€ì¦ëœ ìš´ì˜ ëª¨ë¸ì´ê¸° ë•Œë¬¸ 

## ë¦¬ìŠ¤í¬ ì²´í¬(ë‘˜ ë‹¤ ê³µí†µ)

* ì„±ëŠ¥: í’€ìŠ¤ìº” ê¸ˆì§€, ë°˜ë“œì‹œ ìœˆë„ìš° ê¸°ë°˜
* ì •í•©ì„±: raw vs aggregate ê²€ì¦ ë£¨í‹´(ìƒ˜í”Œë§) í•„ìš”
* í…Œë„Œì‹œ: client_id ìŠ¤ì½”í”„ê°€ ì „ ê³„ì¸µì—ì„œ ìœ ì§€ë¼ì•¼ í•¨

## DoD

* [ ] â€œê¸°ë³¸ ëŒ€ì‹œë³´ë“œâ€ëŠ” aggregate ê¸°ë°˜ìœ¼ë¡œ ì¼ì • ì‘ë‹µì‹œê°„ì„ ë§Œì¡±
* [ ] ì§‘ê³„ ì‹¤íŒ¨ê°€ íƒì§€ ê°€ëŠ¥(êµ¬ì¡°í™” ë¡œê·¸/ì•Œë¦¼)
* [ ] íŠ¹ì • ê¸°ê°„ ì¬ì§‘ê³„(ë°±í•„)ê°€ ê°€ëŠ¥

---

# [ì‚°ì¶œë¬¼ 3] session_id / UTM ë³´ì¡´ ê·œì¹™ (ì„œë²„ ì¤‘ì‹¬ â€œìŠ¤í‚¤ë§ˆ v1â€)

ë³´ê³ ì„œì˜ ìµœìƒìœ„ ë°ì´í„° í’ˆì§ˆ ì´ìŠˆê°€ ë°”ë¡œ ì´ ë‘ ê°€ì§€ì…ë‹ˆë‹¤:

* Visitâ†”ë“±ë¡ ì—°ê²°ë¥  ë‚®ìŒ(session_id ë¶ˆì¼ì¹˜)
* UTM ì¶”ì ë¥  ë‚®ìŒ(ìœ ì‹¤) 

ë”°ë¼ì„œ â€œì§‘ê³„â€ ì „ì— **ì„œë²„ ì¤‘ì‹¬ ê·œì¹™ì„ í—Œë²•ìœ¼ë¡œ ê³ ì •**í•´ì•¼ í•©ë‹ˆë‹¤.

## 1) ëª©ì 

* ì–´ë–¤ í˜ì´ì§€/ë Œë” ë°©ì‹(SSR/CSR/ë¦¬ë‹¤ì´ë ‰íŠ¸)ì—ì„œë„

  * `session_id`ê°€ ì•ˆì •ì ìœ¼ë¡œ ìœ ì§€ë˜ê³ 
  * UTMì´ ìœ ì‹¤ë˜ì§€ ì•Šìœ¼ë©°
  * Visitê³¼ ë“±ë¡ì´ ì—°ê²°ëœë‹¤

## 2) ìš©ì–´ ì •ì˜(ê³ ì •)

* **session_id**: â€œí•œ ë°©ë¬¸ íë¦„ì„ ì‹ë³„í•˜ëŠ” IDâ€

  * ì¿ í‚¤ì— ì €ì¥ë˜ë©°, Visit/ë“±ë¡/ë§í¬ í†µê³„ì˜ ì—°ê²° í‚¤ë¡œ ì‚¬ìš©
* **first-touch UTM**: ìµœì´ˆ ìœ ì…ì˜ UTM (ë³€í•˜ì§€ ì•ŠìŒ)
* **last-touch UTM**: ìµœì¢… ìœ ì…/ì§ì „ ìœ ì…ì˜ UTM (ì—…ë°ì´íŠ¸ ê°€ëŠ¥)
* **cid**: ìº í˜ì¸ ì‹ë³„ ê°’(ì°¨ì›). ì—†ì–´ë„ Fact ì €ì¥ì€ ì„±ê³µí•´ì•¼ í•¨(unknown í—ˆìš©)
* **marketing_campaign_link_id**: ë§í¬ ì¶”ì ìš© ì‹ë³„ì(ì°¨ì›). ì—†ì–´ë„ Fact ì €ì¥ì€ ì„±ê³µí•´ì•¼ í•¨(unknown í—ˆìš©) 

## 3) ìˆ˜ì§‘ ì§€ì  ì„¤ê³„(ì„œë²„ ì¤‘ì‹¬)

> í•µì‹¬: **í´ë¼ì´ì–¸íŠ¸ JS ì‹¤í–‰ ì—¬ë¶€ì— ì˜ì¡´í•˜ì§€ ì•ŠëŠ” ì§€ì **ì„ â€œì •ë‹µ ê²½ë¡œâ€ë¡œ ë§Œë“ ë‹¤.

### (A) ìš”ì²­ ì§„ì… ì‹œ(ê°€ëŠ¥í•˜ë©´ middleware/ì„œë²„ ë¼ìš°íŠ¸)

* session_id ì¿ í‚¤ê°€ ì—†ìœ¼ë©´ ìƒì„±(ë‹¨, ê°’/TTLì€ í•˜ë“œì½”ë”© ê¸ˆì§€ â†’ configë¡œ)
* URLì— UTM/cid/link_idê°€ ìˆìœ¼ë©´:

  * first-touchê°€ ë¹„ì–´ ìˆìœ¼ë©´ first-touchì— ì €ì¥
  * last-touchëŠ” ê°±ì‹  ì €ì¥
* ì´ ë‹¨ê³„ëŠ” â€œì €ì¥â€ì´ ì•„ë‹ˆë¼ **ì¿ í‚¤/í—¤ë”ë¡œ ë³´ì¡´**ì´ ëª©ì 

  * DB ì“°ê¸°/ì§‘ê³„ëŠ” ì—¬ê¸°ì„œ í•˜ì§€ ì•ŠëŠ”ë‹¤(ë¼ì´ë¸Œ ì•ˆì •ì„±)

### (B) Visit API í˜¸ì¶œ ì‹œ

* í´ë¼ì´ì–¸íŠ¸ê°€ ë³´ë‚´ëŠ” session_idë¥¼ ì‹ ë¢°í•˜ë˜,

  * ì—†ìœ¼ë©´ ì„œë²„ì—ì„œ ì¿ í‚¤ ê¸°ë°˜ session_idë¡œ ë³´ì™„
* UTMë„ â€œí´ë¼ì´ì–¸íŠ¸ payloadâ€ + â€œì¿ í‚¤â€ë¥¼ í•©ì³ì„œ:

  * ë¹„ì–´ ìˆëŠ” í•„ë“œëŠ” ì¿ í‚¤ë¡œ ë³´ê°•
* ì°¨ì›(cID/link meta)ì€ ì—†ì–´ë„ Fact insertëŠ” ì„±ê³µí•´ì•¼ í•¨(LEFT JOIN/nullable)

> ì›ŒíŠ¸ ì‚¬ê³ ì²˜ëŸ¼ â€œì°¨ì› ë¶€ì¬ë¡œ ìˆ˜ì§‘ì´ 0ì´ ë˜ëŠ”â€ êµ¬ì¡°ëŠ” ê¸ˆì§€(í—Œë²•). 

### (C) ë“±ë¡/ì „í™˜ API(Submit) ì‹œ

* ë“±ë¡ payloadì— session_idê°€ ì˜¤ë©´ ìš°ì„  ì‚¬ìš©
* ì—†ìœ¼ë©´ ì„œë²„ ì¿ í‚¤ì—ì„œ ë³´ì™„í•´ì„œ `event_survey_entries.session_id`ì— ì €ì¥ 
* UTMì€:

  1. payload
  2. ì¿ í‚¤
  3. (ì„ íƒ) ê°€ì¥ ìµœê·¼ Visit ë¡œê·¸
     ìˆœìœ¼ë¡œ ë³´ê°•(ë‹¨, ì´ ë³´ê°• ë¡œì§ì€ **ë™ê¸°/ì°¨ë‹¨ ê¸ˆì§€**)

## 4) ë¦¬ë‹¤ì´ë ‰íŠ¸/CSR/SSR ì „í™˜ì—ì„œì˜ ê·œì¹™

* ë¦¬ë‹¤ì´ë ‰íŠ¸ê°€ ìˆì–´ë„ UTMì´ ì‚¬ë¼ì§€ì§€ ì•Šê²Œ:

  * â€œUTMì€ ì¿ í‚¤ì— ì €ì¥ëœ ê°’ì´ ì •ë‹µâ€
  * URLì—ì„œ ì‚¬ë¼ì ¸ë„ ì¿ í‚¤ë¡œ ìœ ì§€
* SPA ë‚´ ë¼ìš°íŒ…ì—ì„œë„:

  * session_idëŠ” ì¿ í‚¤ ê¸°ë°˜ìœ¼ë¡œ ìœ ì§€(ë©”ëª¨ë¦¬ ê¸°ë°˜ ê¸ˆì§€)

## 5) ê°œì¸ì •ë³´/ë³´ì•ˆ(PII) ê·œì¹™

* ì›ë¬¸ ì´ë©”ì¼/ì „í™”ë²ˆí˜¸/ì´ë¦„/í¼ ì…ë ¥ê°’ì€ UTM/ë¡œê·¸/ì§‘ê³„ë¡œ ì ˆëŒ€ í˜ë¦¬ì§€ ì•ŠìŒ
* referrer/user_agentëŠ” í•„ìš” ìµœì†Œë¡œ, ì €ì¥ ì‹œì—” ìœ„í—˜ í‰ê°€ í›„(ê°€ëŠ¥í•˜ë©´ í•´ì‹œ/ìš”ì•½)

## 6) í’ˆì§ˆ ëª¨ë‹ˆí„°ë§(ì§‘ê³„ ì‹ ë¢°ë„ ì§€í‘œ)

ë³´ê³ ì„œê°€ ëª¨ë‹ˆí„°ë§ í•„ìš”ì„±ì„ ì œì‹œí•œ ë°©í–¥ì„ â€œì§‘ê³„ í—Œë²• KPIâ€ë¡œ ê³ ì •í•©ë‹ˆë‹¤. 

* visit count/day, entry count/day
* **visit-entry linkage rate**: entry ì¤‘ session_idë¡œ visitì— ì—°ê²°ë˜ëŠ” ë¹„ìœ¨
* **utm fill rate**: entry/visitì—ì„œ utm_source ë“± ì±„ì›Œì§„ ë¹„ìœ¨
* cid/link attribution rate: cid ë˜ëŠ” link_idê°€ ì±„ì›Œì§„ ë¹„ìœ¨
* â€œunknown/unresolvedâ€ ë¹„ìœ¨(ì°¨ì› ë¶€ì¬ë¥¼ ìˆ«ìë¡œ ë“œëŸ¬ë‚´ì•¼ ìš´ì˜ì´ ê°€ëŠ¥)

## DoD

* [ ] ë“±ë¡ ìš”ì²­ì—ì„œ session_idê°€ â€œí•­ìƒâ€ ì €ì¥ëœë‹¤(ì¿ í‚¤ ë³´ê°• í¬í•¨)
* [ ] UTM first/last-touchê°€ ìœ ì‹¤ë˜ì§€ ì•ŠëŠ”ë‹¤(ë¦¬ë‹¤ì´ë ‰íŠ¸/CSRì—ì„œë„)
* [ ] visit-entry linkage rateê°€ ëª©í‘œ ìˆ˜ì¤€ê¹Œì§€ ìƒìŠ¹(ëª©í‘œê°’ ìì²´ëŠ” config/ìš´ì˜ í•©ì˜ë¡œ)
* [ ] cid/link metaê°€ ì—†ì–´ë„ Fact ìˆ˜ì§‘ì´ 0ìœ¼ë¡œ ë–¨ì–´ì§€ì§€ ì•ŠëŠ”ë‹¤

---

# (ë³´ê°•) ë³´ê³ ì„œ ì œì•ˆ â€œMiddleware JSONL íŒŒì¼ ë¡œê¹…â€ì— ëŒ€í•œ Serverless êµì •

ë³´ê³ ì„œëŠ” middlewareì—ì„œ JSONL íŒŒì¼ë¡œ í˜ì´ì§€ë·° ë¡œê·¸ë¥¼ ì €ì¥í•´ ë³µì› ê²½ë¡œë¥¼ ë§Œë“¤ìëŠ” ì œì•ˆì„ í¬í•¨í•©ë‹ˆë‹¤. 
í•˜ì§€ë§Œ Vercel Serverless í™˜ê²½ì—ì„œ **ë¡œì»¬ íŒŒì¼ ì €ì¥ì€ ì‹ ë¢°í•˜ê¸° ì–´ë µê¸° ë•Œë¬¸ì—**, ë™ì¼ ëª©ì ì„ ì•„ë˜ì²˜ëŸ¼ êµì •í•©ë‹ˆë‹¤.

## êµì • ê·œì¹™

* â€œíŒŒì¼ ì €ì¥â€ ëŒ€ì‹  **stdout êµ¬ì¡°í™” ë¡œê·¸(JSON 1ë¼ì¸)**ë¥¼ ë‚¨ê¸´ë‹¤
* í•„ìš”í•˜ë©´ Vercel Log Drain ë“±ìœ¼ë¡œ ì™¸ë¶€ ì €ì¥ì†Œì— ì ì¬í•´ ë³µì›ì— ì‚¬ìš©í•œë‹¤
* ì›ì¹™: ì‘ë‹µ ì§€ì—°/UX ì˜í–¥ 0, ì‹¤íŒ¨ ì‹œì—ë„ ë©”ì¸ í”Œë¡œìš° ë¶ˆê°„ì„­

---

# ë¶€ë¡ A) Cursor Agentìš© â€œì „ì²´ ì§‘ê³„ ì‹œìŠ¤í…œâ€ ìµœì¢… ì‘ì—… ì§€ì‹œì„œ (í†µí•©ë³¸)

ì•„ë˜ëŠ” ìœ„ í—Œë²•ì„ ê·¸ëŒ€ë¡œ ì‹¤í–‰ìœ¼ë¡œ ì˜®ê¸°ê¸° ìœ„í•œ **Cursor Agent í”„ë¡¬í”„íŠ¸**ì…ë‹ˆë‹¤.

```markdown
# Role
You are EventFlowâ€™s Senior Backend/Platform Architect.

# Goal
Design and implement a system-wide aggregation strategy for Product Stats (source of truth),
under Serverless + B2B2C multi-tenancy + live stability constraints.

# Must-follow context
- Current system status and gaps are described in the system-wide review report (2026-02-02).
- Past incident: Visit tracking stopped due to CID/dimension dependency. Fact ingestion must never fail due to missing dimension/meta.
- Webinar access stats v2 pattern is the reference: live page = presence ping only, cron = 1 min, storage = 5 min buckets.

# Non-negotiable rules
1) No heavy aggregation on participant/live pages. Live pages only emit lightweight signals (ping/upsert).
2) Separate Fact vs Analysis:
   - Fact tables remain as-is (do not break existing stats).
   - Aggregations are stored in bucketed/summary storage, updated by scheduled jobs.
3) Dimension dependency rule:
   - Fact ingestion must NEVER fail due to missing CID/link meta rows.
   - Treat CID/UTM/link meta as optional; enrich later.
4) No persistent filesystem logging in prod. Use structured JSON stdout logs.

# Deliverables
A) Marketing aggregation bucket schema/key checklist
- Decide bucket granularity (daily default, hourly only when needed)
- Define idempotent unique keys: client_id + bucket + entity_id + dimensions
- Define measures: visits (distinct session_id), conversions (entries), cvr
- Ensure unknown/unresolved dimension buckets are supported and visible
- Ensure indexes and windowed aggregation (no full scans)

B) MV vs Incremental aggregate decision matrix
- Provide the selection criteria and default choice for EventFlow
- If MV is used, specify operational requirements (refresh schedule, alerting, staleness policy)

C) Server-first session_id/UTM persistence rules
- Standardize how session_id and UTM are set/preserved across SSR/CSR/redirects
- Ensure registration API always stores session_id (cookie fallback)
- Define first-touch and last-touch UTM behaviors
- Add monitoring KPIs: visit-entry linkage rate, utm fill rate, cid/link attribution rate

# Implementation guide (criteria, not code)
1) P0 Data Quality:
   - Fix/verify visit coverage on key routes (WelcomePage, WebinarView if still missing)
   - Implement server-first session_id and UTM persistence as constitution rules
2) P1 Aggregation Engine:
   - Implement scheduled incremental aggregation jobs (idempotent upsert, windowed, backfillable)
   - Store results in aggregate/bucket storage aligned with existing naming conventions
3) P2 Admin API:
   - Overview endpoints should read from aggregates by default; raw only for drill-down
4) Ops/Safety:
   - Cron routes must be protected, observable (structured logs), and safe to re-run
   - No PII in logs/events

# Risks checklist
- Performance: avoid full scans; verify with EXPLAIN and index strategy
- Multi-tenant: no cross-client leakage
- Correctness: raw vs aggregate parity checks for sample ranges
- Recoverability: failures detectable and replayable (backfill)

# Definition of Done
- Standard dashboard periods load under target latency using aggregates
- Aggregation jobs are idempotent, monitored, and safe to re-run/backfill
- Fact ingestion never fails due to missing dimension rows (CID/link meta)
- Live pages still run no aggregation queries
- Data quality KPIs are measurable (linkage rate, utm fill rate, unknown rate)
```

---

# ë¶€ë¡ B) â€œì´ë²ˆì— ê³ ì¹œ Visit ì‚¬ê³ (cID DB ë¶€ì¬)â€ë¥¼ ì œë„í™”í•˜ëŠ” ê·œì¹™(ì¬ë°œ ë°©ì§€)

ì›ŒíŠ¸ Visit ì¥ì•  ë¬¸ì„œê°€ ë³´ì—¬ì¤€ í•µì‹¬ì€ **ì‹¤íŒ¨ê°€ ì¡°ìš©íˆ ë¬»íˆë©´(try/catch + empty catch)** ìš´ì˜ì´ â€œ0ê±´â€ì´ ë  ë•Œê¹Œì§€ ëª¨ë¥¸ë‹¤ëŠ” ì ì…ë‹ˆë‹¤. 

## ì¬ë°œ ë°©ì§€ ê·œì¹™

* UXëŠ” ë³´í˜¸(ì‹¤íŒ¨ëŠ” ì‚¼í‚¤ê¸°)í•˜ë˜,
* **ì‹¤íŒ¨í–ˆì„ ë•Œë§Œ** êµ¬ì¡°í™” ë¡œê·¸(JSON)ë¥¼ ë‚¨ê²¨ì„œ â€œì›ì¸ ì¶”ì /ì•Œë¦¼â€ì´ ê°€ëŠ¥í•´ì•¼ í•œë‹¤
* dimension ë¶€ì¬ëŠ” ì‹¤íŒ¨ê°€ ì•„ë‹ˆë¼ **unknown ê·¸ë£¹ìœ¼ë¡œ í¡ìˆ˜**í•´ì•¼ í•œë‹¤

---

ì›í•˜ì‹œë©´ ë‹¤ìŒ ë‹¨ê³„ë¡œ, ìœ„ ë¬¸ì„œ ê·¸ëŒ€ë¡œ **â€œìš´ì˜ìê°€ ë³´ëŠ” 1í˜ì´ì§€ ëŸ°ë¶(ì§‘ê³„ ì¥ì• /ë°ì´í„° í’ˆì§ˆ ì¥ì•  ì§„ë‹¨ íŠ¸ë¦¬)â€**ë„ ì¶”ê°€ë¡œ ë§Œë“¤ì–´ë“œë¦´ê²Œìš”.
(í¬ë¡  ì‹¤íŒ¨/ì§‘ê³„ ì§€ì—°/UTM ìœ ì‹¤/ì—°ê²°ë¥  ê¸‰ë½ì„ â€œì–´ë””ë¶€í„° í™•ì¸í•˜ë©´ ë˜ëŠ”ì§€â€ê¹Œì§€ ê³ ì •í•˜ëŠ” ë¬¸ì„œ)
