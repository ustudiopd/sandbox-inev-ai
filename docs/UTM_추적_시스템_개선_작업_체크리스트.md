# UTM 추적 시스템 개선 작업 체크리스트

**작성일**: 2026-02-02  
**상태**: 진행 중

---

## ✅ 최종 결정안 반영 완료

**확정 사항**:
- ✅ Middleware로 진행 (모듈 분리)
- ✅ Cookie 서명: 미신뢰 + DB 검증
- ✅ Cookie TTL 30일 / Trust Window 24시간
- ✅ UTM 우선, cid는 보조 식별자
- ✅ Phase 1~2 성공 정의에서 tracking_snapshot 제외
- ✅ Visit 추적은 Phase 2 성공조건에서 제외

**참고**: [UTM 추적 개선 최종 결정안](./UTM_추적_개선_최종_결정안.md)

---

## 🔴 Phase 1: 즉시 조치 (1-2일)

### 1.1 집계 API 보정

- [ ] 추적 성공/실패 정의 명확화 (Phase 1~2 기준)
  - [ ] ⚠️ 성공: `marketing_campaign_link_id` 저장 OR `utm_source` 저장 OR (cookie/cid resolve로 캠페인 매칭)
  - [ ] ⚠️ 실패: 위 조건 모두 실패
  - [ ] ⚠️ `tracking_snapshot`은 Phase 3까지 제외 (타이밍 충돌 방지)

- [ ] `app/api/clients/[clientId]/campaigns/summary/route.ts` 수정
  - [ ] 추적 상태 메타데이터 추가 (`tracking_metadata`)
    - [ ] `tracked_count`: 추적 성공 수
    - [ ] `untracked_count`: 추적 실패 수
    - [ ] `tracking_success_rate`: 성공률 (%)
    - [ ] `untracked_reason_top`: 실패 이유 상위 (선택)
  - [ ] Source별 집계 시 "Direct (no tracking)" 라벨 추가
  - [ ] 추적 실패 항목 플래그 추가 (`is_untracked`)
  - [ ] 정의에 따른 성공/실패 판단 로직 구현

- [ ] `app/(client)/client/[clientId]/campaigns/components/CampaignsPageClient.tsx` 수정
  - [ ] 추적 성공률 표시 추가
  - [ ] "Direct (no tracking)" 라벨 및 설명 추가
  - [ ] 추적 실패 항목 시각적 표시 추가
  - [ ] 추적 품질 메타데이터 표시

**예상 소요**: 4-6시간  
**우선순위**: 🔴 긴급

---

## 🟡 Phase 2: 구조적 개선 (1주)

### 2.1 서버 세션 관리 (Middleware)

**✅ 결정 완료**: Middleware로 진행, 모듈 분리

- [ ] `lib/tracking/middleware-tracking.ts` 모듈 생성
  - [ ] UTM 파라미터 추출 로직
  - [ ] Cookie 저장 로직 (미신뢰 방식, DB 검증)
  - [ ] 환경변수: `COOKIE_TTL_DAYS` (기본값: 30일)
- [ ] `middleware.ts` 파일 생성
  - [ ] `lib/tracking/middleware-tracking.ts` 모듈 사용
  - [ ] Matcher 설정 (`/event/*`, `/webinar/*`, `/s/*`)

- [ ] ✅ Cookie 서명 방식: 미신뢰 + DB 검증 (확정)

- [ ] 테스트
  - [ ] 쿠키 저장 확인
  - [ ] 리다이렉트 후 쿠키 유지 확인
  - [ ] 등록 API에서 쿠키 읽기 확인
  - [ ] 추후 마이그레이션 계획 문서화

**예상 소요**: 1-2일  
**우선순위**: 🔴 긴급  
**위험도**: 🟡 중간 (Next.js 버전/마이그레이션 이슈)

---

### 2.2 등록 API 다중 소스 복원

**⚠️ 위험**: Cookie 복원 시 멀티테넌시 오염 가능 → 검증 조건 필수

- [ ] `app/api/public/event-survey/[campaignId]/register/route.ts` 수정
  - [ ] `restoreTrackingInfo()` 함수 구현
  - [ ] URL 쿼리 파라미터 읽기 (1순위)
  - [ ] ✅ UTM과 cid 충돌 규칙 구현 (확정)
    - [ ] UTM이 있으면 UTM을 우선 진실로 사용
    - [ ] cid는 "링크 식별 보조"로만 사용
    - [ ] cid가 다른 캠페인을 가리키면: UTM은 저장, link_id는 저장하지 않음, `untracked_reason = 'cid_campaign_mismatch'` 기록
  - [ ] Cookie에서 추적 정보 읽기 (2순위)
    - [ ] **Cookie의 cid가 현재 campaignId에 매칭되는지 검증** (필수)
    - [ ] **captured_at이 Trust Window 내인지 검증** (필수)
    - [ ] 환경변수: `COOKIE_TRUST_WINDOW_HOURS` (기본값: 24시간)
    - [ ] 검증 실패 시 cookie 무시 + `untracked_reason` 기록
  - [ ] 링크 메타데이터에서 추적 정보 읽기 (3순위)
  - [ ] 우선순위 적용 (URL > Cookie > Link)

- [ ] 테스트
  - [ ] URL만 있는 경우
  - [ ] Cookie만 있는 경우 (캠페인 매칭 성공)
  - [ ] Cookie만 있는 경우 (캠페인 불일치 → 무시)
  - [ ] Cookie만 있는 경우 (시간 창 초과 → 무시)
  - [ ] 링크 메타데이터만 있는 경우
  - [ ] 여러 소스 조합
  - [ ] 멀티테넌시 오염 방지 확인

**예상 소요**: 1-2일  
**우선순위**: 🔴 긴급  
**위험도**: 🔴 높음 (멀티테넌시 오염)

---

### 2.3 Short-link 리다이렉트 개선 (최우선)

- [ ] `app/s/[code]/page.tsx` 수정
  - [ ] Short-link의 UTM 파라미터를 타겟 URL에 추가
  - [ ] 기존 URL의 쿼리 파라미터 유지
  - [ ] `cid` 파라미터 추가

- [ ] 캠페인 링크 리다이렉트 확인
  - [ ] 캠페인 링크가 사용하는 경로 확인
  - [ ] 해당 경로에서도 쿼리 파라미터 유지 확인

- [ ] 리다이렉트 체인 테스트
  - [ ] `/s/[code]` → event page → register API까지 query 보존 확인

- [ ] 테스트
  - [ ] Short-link → 등록 페이지 (UTM 유지 확인)
  - [ ] 리다이렉트 체인 테스트

**예상 소요**: 0.5-1일  
**우선순위**: 🔴 최우선 (크리티컬 패스)

---

### 2.4 Visit 추적 문제 해결

**⚠️ 결정 필요**: Visit 추적이 정말 필요한지 정의부터 필요

**⚠️ 중요**: Visit 추적은 Phase 2 성공조건에서 제외
- UTM 집계 정상화의 핵심은 **등록 시점에 tracking 저장**
- Visit 추적은 퍼널/CVR 목적일 때만 투자 가치 있음

- [ ] Visit 추적 필요성 결정
  - [ ] 필요: 전환율(CVR), 퍼널 분석, 방문→등록 연결
  - [ ] 불필요: 단순 Source 집계만 필요
- [ ] ⚠️ Visit 추적을 Phase 2 성공조건에서 제외
- [ ] ⚠️ Phase 2 DoD에서 Visit 관련 항목 제거

- [ ] 필요 시 Visit API 호출 확인
  - [ ] 등록 페이지에서 실제로 호출되는지 확인
  - [ ] 브라우저 콘솔에서 에러 확인
  - [ ] 네트워크 탭에서 요청 확인

- [ ] 문제 원인 파악
  - [ ] API 엔드포인트 확인
  - [ ] CORS 문제 확인
  - [ ] 인증 문제 확인
  - [ ] 서버 로그 확인

- [ ] 수정 및 테스트
  - [ ] 문제 해결
  - [ ] 조건부 로깅 구현 (cid/utm이 있을 때만)
  - [ ] Visit 로그 저장 확인
  - [ ] 등록과 Visit 연결 확인
  - [ ] 등록 API에서 "visit 없음"이어도 추적 스냅샷 저장 확인

**예상 소요**: 1-2일  
**우선순위**: 🟡 중요

---

## 🟢 Phase 3: 장기 개선 (2주)

### 3.1 추적 스냅샷 저장

- [ ] 데이터베이스 마이그레이션
  - [ ] `tracking_snapshot` 컬럼 추가
  - [ ] 인덱스 생성
  - [ ] 코멘트 추가
  - [ ] 영향 범위 문서화 (event_survey_entries 쓰기/조회, 리포트 쿼리)
  - [ ] 롤백 계획 문서화 (컬럼 미사용 상태로 유지 가능, null-safe)

- [ ] 등록 API 수정
  - [ ] 추적 스냅샷 생성 로직
  - [ ] 스냅샷 저장 로직
  - [ ] 소스 정보 포함 (`url`, `cookie`, `link_meta`)
  - [ ] Referer 정제 로직 (도메인/경로만, query 제거)
  - [ ] User-Agent 저장 방식 결정 (full vs hash)

- [ ] ⚠️ Phase 3 이후 성공 정의 확장
  - [ ] `tracking_snapshot.cid` + 캠페인 매칭을 성공 조건에 추가
  - [ ] 기존 성공 정의와 호환되도록 확장

- [ ] 개인정보/보안 정책
  - [ ] Referer query 제거 로직 구현
  - [ ] User-Agent 저장 방식 결정 및 구현
  - [ ] 보관기간 정책 문서화

- [ ] 테스트
  - [ ] 스냅샷 저장 확인
  - [ ] 스냅샷 조회 확인
  - [ ] 인덱스 성능 확인
  - [ ] Null-safe 처리 확인

**예상 소요**: 2-3일  
**우선순위**: 🟢 중간

---

### 3.2 모니터링 대시보드

**⚠️ 중요**: 알람 조건을 대시보드보다 먼저 정의

- [ ] 알람 조건 정의 (우선)
  - [ ] `tracking_success_rate`가 N% 미만이면 알림
  - [ ] `untracked_count`가 갑자기 급증하면 알림
  - [ ] 특정 캠페인에서만 0%면 알림
  - [ ] 알람 임계값 설정 (환경변수)
  - [ ] 알람 채널 결정 (이메일/Slack 등)

- [ ] 추적 성공률 대시보드
  - [ ] 실시간 추적 성공률 표시
  - [ ] 시간대별 추적 성공률 그래프
  - [ ] 채널별 추적 성공률 비교

- [ ] 알림 시스템 구현
  - [ ] 알람 조건에 따른 알림 발송
  - [ ] 일일 리포트 자동 생성
  - [ ] 이메일/Slack 알림 (선택)

- [ ] 테스트
  - [ ] 알람 조건 작동 확인
  - [ ] 대시보드 정확도 확인
  - [ ] 알림 작동 확인

**예상 소요**: 2-3일  
**우선순위**: 🟢 중간

---

## 📊 진행 상황 추적

### 완료된 작업

- [x] 등록 API 개선 (링크 UTM 사용)
- [x] 문제 원인 규명
- [x] 팩트 확인 쿼리 실행
- [x] 분석 문서 작성

### 진행 중인 작업

- [ ] 집계 API 보정

### 대기 중인 작업

- [ ] 서버 세션 관리
- [ ] 다중 소스 복원
- [ ] Short-link 개선
- [ ] Visit 추적 해결
- [ ] 추적 스냅샷 저장
- [ ] 모니터링 대시보드

---

## 🎯 성공 기준

### Phase 1 완료 기준

- [ ] 집계 API에 추적 상태 메타데이터 포함
- [ ] UI에 "Direct (no tracking)" 라벨 표시
- [ ] 사용자에게 명확한 설명 제공

### Phase 2 완료 기준

- [ ] 추적 성공률 80%+ 달성 (Phase 1~2 성공 정의 기준)
- [ ] 모든 리다이렉트에서 추적 정보 유지
- [ ] Cookie 복원 검증 작동 확인 (캠페인 매칭 + Trust Window)
- [ ] UTM과 cid 충돌 규칙 작동 확인
- [ ] DoD 4가지 시나리오 모두 통과
- [ ] Visit 로그는 성공조건에서 제외 (필요 시 별도 작업)

### Phase 3 완료 기준

- [ ] 추적 성공률 95%+ 달성
- [ ] 추적 스냅샷 저장 작동
- [ ] 모니터링 대시보드 작동

---

## 📝 참고 사항

- 모든 작업은 기존 기능에 영향을 주지 않도록 주의
- 각 단계마다 테스트 필수
- 프로덕션 배포 전 스테이징 환경에서 검증
- 롤백 계획 준비

---

## 🚨 위험 요소 체크리스트

구현 전 반드시 확인:

- [ ] Cookie 복원 시 캠페인 매칭 검증 구현
- [ ] Cookie 복원 시 시간 창 검증 구현
- [ ] Cookie 서명 방식 결정 및 구현
- [ ] Next.js 버전 확인 및 Middleware/Proxy 선택
- [ ] Visit 추적 필요성 결정
- [ ] 추적 성공/실패 정의 명확화
- [ ] Referer/UA 개인정보 처리 정책 수립

---

## 🎯 최종 DoD 판정 기준 (확정)

**이거 통과하면 "이제부터 집계 된다"**

### 시나리오 1: UTM 링크 등록
- **기대**: `utm_source` 저장 & 집계 반영
- **판정**: ✅ 성공

### 시나리오 2: cid 링크 등록 (UTM 없음)
- **기대**: link_id 또는 캠페인 매칭 성공 (Direct만으로 안 떨어짐)
- **판정**: ✅ 성공

### 시나리오 3: `/s/[code]` 경유 등록
- **기대**: query+cookie 보존으로 추적 저장
- **판정**: ✅ 성공

### 시나리오 4: 진짜 Direct
- **기대**: "Direct (no tracking)"로 분리 표기
- **판정**: ✅ 성공 (정상 동작)

---

## 📚 관련 문서

### 필수 확인 문서 (구현 전)
- [UTM 추적 개선 최종 결정안](./UTM_추적_개선_최종_결정안.md) - ⚠️ **확정 완료, 구현 준비 완료**
- [UTM 추적 시스템 개선 위험요소 및 결정사항](./UTM_추적_시스템_개선_위험요소_및_결정사항.md)
- [체크리스트 추가 항목 패치 2탄](./체크리스트_추가_항목_패치_2탄.md)

### 참고 문서
- [체크리스트 추가 항목 패치](./체크리스트_추가_항목_패치.md)

---

**마지막 업데이트**: 2026-02-02  
**검토 상태**: 리뷰 반영 완료
