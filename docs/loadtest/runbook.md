# 부하 테스트 실행 가이드 (Runbook)

## 개요

Realtime 채팅/Q&A 부하 테스트를 체계적으로 실행하기 위한 단계별 체크리스트와 실행 순서를 정의합니다.

---

## 테스트 전 준비사항

### 1. 환경 확인

- [ ] 테스트 대상 웨비나 ID/Slug 확인
- [ ] 등록된 사용자 수 확인 (445명)
- [ ] 테스트 환경 (프로덕션/스테이징) 확인
- [ ] Supabase 대시보드 접속 가능 확인
- [ ] Vercel 대시보드 접속 가능 확인 (프로덕션인 경우)

### 2. 도구 설치 및 설정

- [ ] Node.js 설치 확인 (`node --version`)
- [ ] Playwright 설치 확인 (`npx playwright --version`)
- [ ] k6 설치 확인 (`k6 version`) - 선택사항
- [ ] Artillery 설치 확인 (`npx artillery --version`) - 선택사항

### 3. 테스트 스크립트 확인

- [ ] `scripts/load-test-149400-real-users.ts` 존재 확인
- [ ] 환경 변수 설정 확인 (`.env.local`)
- [ ] 스크립트 실행 권한 확인

### 4. 모니터링 준비

- [ ] Supabase 대시보드 열기 (별도 탭)
- [ ] Vercel 대시보드 열기 (별도 탭, 프로덕션인 경우)
- [ ] 로그 저장 디렉토리 생성 (`logs/loadtest/YYYY-MM-DD/`)

---

## 테스트 실행 순서

### Phase 1: 기본 검증 (S1 - 50명)

#### 1.1 시나리오 A: Realtime 연결/구독 내구성

**목적**: 기본적인 Realtime 구독이 정상 작동하는지 확인

**실행 단계**:
1. [ ] 테스트 스크립트 수정: `CONCURRENT_USERS = 50`
2. [ ] Playwright 테스트 실행 (또는 수동 브라우저 테스트)
3. [ ] 구독 성공률 확인 (목표: 99%+)
4. [ ] 재연결 루프 확인 (목표: 0)
5. [ ] 결과 기록

**실행 명령** (예시):
```bash
# Playwright 테스트가 있다면
npx playwright test tests/loadtest/realtime-subscribe.spec.ts --workers=10

# 또는 수동으로 브라우저 50개 열어서 확인
```

**예상 시간**: 5분

**DoD 확인**:
- [ ] subscribe 성공률 99%+
- [ ] 재연결 루프 없음
- [ ] CHANNEL_ERROR 0

**실패 시 조치**:
- [ ] 로그 수집
- [ ] Supabase Realtime 상태 확인
- [ ] 문제 해결 후 재시도 또는 다음 단계 중단

---

#### 1.2 시나리오 B: 채팅 브로드캐스트 fan-out 테스트

**목적**: 메시지 브로드캐스트가 정상 작동하는지 확인

**실행 단계**:
1. [ ] 50명 모두 채널 구독 상태 유지
2. [ ] 10명이 10초 동안 초당 1개씩 메시지 전송 (= 총 100 msg)
3. [ ] 나머지 40명이 수신한 메시지 수 기록
4. [ ] 누락률 계산 (목표: < 0.1%)
5. [ ] 지연 시간 계산 (목표: p95 < 2초)
6. [ ] 결과 기록

**예상 시간**: 2분

**DoD 확인**:
- [ ] 전송 API 성공률 99.9%+
- [ ] 누락률 < 0.1%
- [ ] 지연 p95 < 2초

**실패 시 조치**:
- [ ] 로그 수집
- [ ] 브로드캐스트 이벤트 로그 확인
- [ ] Supabase Realtime 상태 확인

---

#### 1.3 시나리오 C: Q&A 생성/모더레이션 브로드캐스트 테스트

**목적**: Q&A 상태 변경이 실시간으로 동기화되는지 확인

**실행 단계**:
1. [ ] 50명이 질문 등록 (짧은 텍스트)
2. [ ] 관리자 1명이 10개 답변, 10개 고정, 10개 숨김 처리
3. [ ] 모든 클라이언트가 상태 변경 수신 확인
4. [ ] 상태 불일치 확인 (목표: 0)
5. [ ] 결과 기록

**예상 시간**: 3분

**DoD 확인**:
- [ ] 질문 생성 API 성공률 99.9%+
- [ ] 관리자 PATCH 성공률 99.9%+
- [ ] 클라이언트 상태 변경 수신률 99%+
- [ ] 상태 불일치 0

**실패 시 조치**:
- [ ] 로그 수집
- [ ] Postgres Changes 이벤트 로그 확인
- [ ] 상태 불일치 원인 분석

---

#### 1.4 시나리오 D: Presence/ping + 통계 크론 동시 테스트

**목적**: ping과 통계 집계가 동시에 돌 때 DB가 버티는지 확인

**실행 단계**:
1. [ ] 50명이 라이브 상태 유지 (탭 visible)
2. [ ] 5분 동안 유지 (ping 주기 120초 ± 10초)
3. [ ] 크론 정상 실행 확인 (1분 주기)
4. [ ] 관리자가 stats/access API 호출 (60초 주기)
5. [ ] DB 연결 수/CPU 사용률 모니터링
6. [ ] 결과 기록

**예상 시간**: 5분

**DoD 확인**:
- [ ] ping API 성공률 99%+
- [ ] 크론 누락 없음
- [ ] stats/access 응답 시간 p95 < 1초
- [ ] DB 연결 수 안정
- [ ] DB CPU 사용률 < 80%

**실패 시 조치**:
- [ ] 로그 수집
- [ ] Supabase DB 성능 그래프 확인
- [ ] 크론 로그 확인

---

### Phase 2: 중간 규모 검증 (S2 - 200명)

**전제 조건**: Phase 1 (S1) 모든 시나리오 통과

#### 2.1 전체 시나리오 순차 실행

**실행 단계**:
1. [ ] 테스트 스크립트 수정: `CONCURRENT_USERS = 200`
2. [ ] 시나리오 A 실행 (예상 시간: 5분)
3. [ ] 시나리오 B 실행 (예상 시간: 2분)
4. [ ] 시나리오 C 실행 (예상 시간: 3분)
5. [ ] 시나리오 D 실행 (예상 시간: 10분)
6. [ ] 각 시나리오별 DoD 확인
7. [ ] 결과 기록

**총 예상 시간**: 20분

**DoD 확인**:
- [ ] 모든 시나리오 DoD 통과
- [ ] 실패한 시나리오 없음

**실패 시 조치**:
- [ ] 실패한 시나리오 로그 수집
- [ ] 문제 원인 분석
- [ ] 해결 후 재시도 또는 S3 중단

---

### Phase 3: 대규모 검증 (S3 - 500명)

**전제 조건**: Phase 2 (S2) 모든 시나리오 통과

#### 3.1 전체 시나리오 순차 실행

**실행 단계**:
1. [ ] 테스트 스크립트 수정: `CONCURRENT_USERS = 500`
2. [ ] 시나리오 A 실행 (예상 시간: 10분)
3. [ ] 시나리오 B 실행 (예상 시간: 3분)
4. [ ] 시나리오 C 실행 (예상 시간: 5분)
5. [ ] 시나리오 D 실행 (예상 시간: 15분)
6. [ ] 각 시나리오별 DoD 확인
7. [ ] 결과 기록

**총 예상 시간**: 33분

**DoD 확인**:
- [ ] 모든 시나리오 DoD 통과
- [ ] 실패한 시나리오 없음

**실패 시 조치**:
- [ ] 실패한 시나리오 로그 수집
- [ ] 문제 원인 분석
- [ ] 해결 후 재시도 또는 S4 중단

---

### Phase 4: 최대 부하 검증 (S4 - 1,000명)

**전제 조건**: Phase 3 (S3) 모든 시나리오 통과

#### 4.1 전체 시나리오 순차 실행

**실행 단계**:
1. [ ] 테스트 스크립트 수정: `CONCURRENT_USERS = 1000`
2. [ ] 시나리오 A 실행 (예상 시간: 15분)
3. [ ] 시나리오 B 실행 (예상 시간: 5분)
4. [ ] 시나리오 C 실행 (예상 시간: 10분)
5. [ ] 시나리오 D 실행 (예상 시간: 20분)
6. [ ] 각 시나리오별 DoD 확인
7. [ ] 결과 기록

**총 예상 시간**: 50분

**DoD 확인**:
- [ ] 모든 시나리오 DoD 통과
- [ ] 실패한 시나리오 없음

**실패 시 조치**:
- [ ] 실패한 시나리오 로그 수집
- [ ] 문제 원인 분석
- [ ] 최종 리포트 작성

---

### Phase 5: 장애 상황 테스트 (시나리오 E)

**전제 조건**: Phase 2 이상 통과 (S2~S4 중 하나)

#### 5.1 Realtime 흔들림 폴백 테스트

**목적**: 네트워크 불안정 시 폴백이 서버를 죽이지 않는지 확인

**실행 단계**:
1. [ ] 200명이 정상 구독 상태 유지
2. [ ] 20명(10%)에서 네트워크 끊었다 붙였다 (오프라인/온라인 토글)
3. [ ] 10명(5%)에서 채널 unsubscribe/subscribe 반복
4. [ ] 폴백 폴링 활성화 횟수 확인
5. [ ] 폴백 폴링 API 호출 수 확인
6. [ ] DB 쿼리 수 확인
7. [ ] 결과 기록

**예상 시간**: 10분

**DoD 확인**:
- [ ] 폴백 폴링 활성화 < 전체의 10%
- [ ] 폴백 폴링 API 호출 수 < 정상 폴링의 2배
- [ ] DB 쿼리 수 폭증 없음 (정상 대비 1.5배 이하)

**실패 시 조치**:
- [ ] **P1 이슈 확정**: 폭증 발생 시 "서킷브레이커" 티켓 생성
- [ ] 로그 수집
- [ ] 폴백 폴링 로직 검토

---

## 실패 시 중단/롤백 기준

### 즉시 중단 조건

다음 중 하나라도 발생하면 **즉시 테스트 중단**:

1. **재연결 루프 발생**: SUBSCRIBED → CLOSED → SUBSCRIBED 반복 3회 이상
2. **DB 연결 수 폭증**: 정상 대비 3배 이상
3. **DB CPU 사용률**: 95% 이상 지속 (5분 이상)
4. **서버 오류**: 500 에러 다수 발생 (전체의 5% 이상)
5. **메시지 누락률**: > 5% (시나리오 B)

### 롤백 필요 조건

다음 중 하나라도 발생하면 **롤백 검토**:

1. **API 성공률**: < 95%
2. **Realtime 구독 성공률**: < 90%
3. **DB CPU 사용률**: 90% 이상 지속 (10분 이상)
4. **폴백 폴링 폭증**: 정상 대비 10배 이상

### 재시도 기준

다음 조건에서만 **재시도 허용**:

1. **일시적 네트워크 오류**: 5분 이내 해결 시
2. **Supabase 일시적 장애**: 10분 이내 해결 시
3. **테스트 환경 문제**: 환경 수정 후 재시도

---

## 결과 보고 템플릿

### 테스트 결과 리포트

```markdown
# 부하 테스트 결과 리포트

**테스트 일시**: YYYY-MM-DD HH:MM
**테스트 환경**: 프로덕션/스테이징
**웨비나 ID/Slug**: 149400
**테스트 규모**: S2 (200명)

## 시나리오별 결과

### 시나리오 A: Realtime 연결/구독 내구성
- **구독 성공률**: 99.5% ✅
- **구독 시간 p95**: 3.2초 ✅
- **재연결 루프**: 0 ✅
- **CHANNEL_ERROR**: 0 ✅
- **결과**: PASS

### 시나리오 B: 채팅 브로드캐스트 fan-out 테스트
- **전송 API 성공률**: 100% ✅
- **누락률**: 0.05% ✅
- **지연 p95**: 1.8초 ✅
- **중복 수신**: 0 ✅
- **결과**: PASS

### 시나리오 C: Q&A 생성/모더레이션 브로드캐스트 테스트
- **질문 생성 API 성공률**: 100% ✅
- **관리자 PATCH 성공률**: 100% ✅
- **상태 변경 수신률**: 99.2% ✅
- **상태 불일치**: 0 ✅
- **결과**: PASS

### 시나리오 D: Presence/ping + 통계 크론 동시 테스트
- **ping API 성공률**: 99.8% ✅
- **크론 성공률**: 100% ✅
- **stats/access 응답 시간 p95**: 0.8초 ✅
- **DB 연결 수**: 안정 (최대 45/100) ✅
- **DB CPU 사용률**: 평균 65% ✅
- **결과**: PASS

### 시나리오 E: 장애 상황 폴백 테스트
- **폴백 활성화**: 8% (20명/200명) ✅
- **폴백 API 호출 수**: 정상의 1.8배 ✅
- **DB 쿼리 수**: 정상의 1.3배 ✅
- **결과**: PASS

## 종합 결과

- **전체 시나리오 통과**: ✅ PASS
- **다음 단계 권장**: S3 (500명) 진행 가능

## 발견된 이슈

없음

## 다음 단계

1. S3 (500명) 테스트 진행
2. 결과 모니터링 강화
```

---

## 로그 수집 체크리스트

### 테스트 전
- [ ] Supabase 대시보드 접속 확인
- [ ] Vercel 대시보드 접속 확인 (프로덕션인 경우)
- [ ] 로그 저장 디렉토리 생성
- [ ] 테스트 스크립트 백업

### 테스트 중
- [ ] Supabase DB 연결 수 스크린샷 (1분마다)
- [ ] Supabase DB CPU 사용률 스크린샷 (1분마다)
- [ ] Playwright 브라우저 콘솔 로그 저장
- [ ] k6/Artillery 결과 저장
- [ ] 서버 로그 확인 (에러 발생 시)

### 테스트 후
- [ ] 모든 로그 파일 수집
- [ ] Supabase 대시보드 최종 스크린샷 저장
- [ ] 지표 요약표 작성
- [ ] 실패한 지표의 근거 로그 추출
- [ ] 결과 리포트 작성

---

## 문제 해결 가이드

### Realtime 구독 실패 시

1. **Supabase Realtime 상태 확인**
   - 대시보드 → Realtime → Status
   - 연결 수 확인

2. **브라우저 콘솔 로그 확인**
   - `CHANNEL_ERROR` 또는 `TIMED_OUT` 로그
   - 에러 메시지 확인

3. **서버 로그 확인**
   - 관련 에러 메시지 확인

4. **해결 방법**
   - Supabase Realtime 재시작 (필요 시)
   - 네트워크 문제 확인
   - 재시도

### 메시지 누락 시

1. **브로드캐스트 이벤트 로그 확인**
   - 브라우저 콘솔: `실시간 Broadcast 이벤트:` 로그
   - 수신한 메시지 수 카운트

2. **서버 로그 확인**
   - 메시지 생성 API 호출 로그
   - 브로드캐스트 전송 로그

3. **Supabase 대시보드 확인**
   - `messages` 테이블 INSERT 로그
   - Realtime 브로드캐스트 전송 로그

4. **해결 방법**
   - 브로드캐스트 로직 검토
   - 중복 제거 로직 확인
   - 재시도

### DB 부하 발생 시

1. **Supabase 대시보드 확인**
   - DB CPU/연결 수 그래프
   - Query Performance 확인

2. **서버 로그 확인**
   - 느린 쿼리 로그
   - 과도한 쿼리 패턴 확인

3. **해결 방법**
   - 인덱스 추가 검토
   - 쿼리 최적화
   - 연결 풀 설정 조정

### 폴백 폴링 폭증 시

1. **폴백 활성화 로그 확인**
   - 브라우저 콘솔: `폴백 폴링 활성화` 로그 카운트
   - 활성화된 클라이언트 수 확인

2. **API 호출 수 확인**
   - k6/Artillery: `/api/webinars/{id}/messages` 호출 수
   - 정상 폴링 대비 비율 계산

3. **해결 방법**
   - **P1 이슈 확정**: 서킷브레이커 티켓 생성
   - 폴백 폴링 로직 검토
   - 상한 설정 추가

---

## 다음 단계 권장사항

### S2 (200명) 통과 시
- [ ] S3 (500명) 진행 가능
- [ ] 결과 모니터링 강화
- [ ] 장기간 테스트 고려 (30분 이상)

### S3 (500명) 통과 시
- [ ] S4 (1,000명) 진행 가능
- [ ] 프로덕션 배포 검토
- [ ] 모니터링 대시보드 구축 고려

### S4 (1,000명) 통과 시
- [ ] 프로덕션 배포 승인
- [ ] 모니터링 알림 설정
- [ ] 정기 부하 테스트 스케줄 수립

---

## 참고 자료

- [Realtime 테스트 계획](./realtime-test-plan.md)
- [지표 및 로그 가이드](./metrics-and-logs.md)
- [부하 테스트 스크립트](../scripts/load-test-149400-real-users.ts)
