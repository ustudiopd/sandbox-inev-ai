# 롤백 후 현재 상황 및 문제점 분석 보고서

**작성일**: 2026-01-28  
**상태**: 🔴 **심각한 스키마-코드 불일치 발견**

---

## 📋 요약

코드 롤백 후 **데이터베이스 스키마와 API 코드 간의 불일치**가 발견되었습니다. 데이터베이스는 웨비나 지원을 포함하고 있으나, API 코드는 웨비나 기능이 제거된 상태입니다. 이로 인해 **캠페인 링크 생성 시 예상치 못한 제약 조건 위반**이 발생할 수 있습니다.

---

## 🔍 현재 상황

### 1. 데이터베이스 스키마 상태

#### 1.1 적용된 마이그레이션
- ✅ `065_create_campaign_link_meta.sql` - 초기 테이블 생성
- ✅ `067_add_cid_to_campaign_link_meta.sql` - cid 필드 추가
- ✅ `066_add_start_date_to_campaign_link_meta.sql` - start_date 필드 추가
- ✅ **`072_add_webinar_support_to_campaign_link_meta.sql`** - **웨비나 지원 추가** ⚠️

#### 1.2 `campaign_link_meta` 테이블 스키마

```sql
-- 현재 데이터베이스 상태
CREATE TABLE public.campaign_link_meta (
  id UUID PRIMARY KEY,
  client_id UUID NOT NULL,
  name TEXT NOT NULL,
  target_type TEXT DEFAULT 'campaign',  -- ⚠️ 웨비나 지원 포함
  target_campaign_id UUID REFERENCES event_survey_campaigns(id),  -- nullable
  target_webinar_id UUID REFERENCES webinars(id),  -- ⚠️ 웨비나 지원 포함
  landing_variant TEXT,
  cid TEXT NOT NULL,
  utm_source TEXT,
  utm_medium TEXT,
  utm_campaign TEXT,
  utm_term TEXT,
  utm_content TEXT,
  start_date TIMESTAMPTZ,
  status TEXT DEFAULT 'active',
  created_by UUID,
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  
  -- 제약 조건
  CONSTRAINT check_target_type_campaign CHECK (
    (target_type = 'campaign' AND target_campaign_id IS NOT NULL AND target_webinar_id IS NULL) OR
    (target_type = 'webinar' AND target_webinar_id IS NOT NULL AND target_campaign_id IS NULL) OR
    (target_type IS NULL AND target_campaign_id IS NOT NULL AND target_webinar_id IS NULL)
  )
);
```

**주요 특징**:
- `target_type` 컬럼 존재 (default: 'campaign')
- `target_campaign_id`는 **nullable**
- `target_webinar_id` 컬럼 존재
- 제약 조건: `target_type`에 따라 적절한 ID 필드가 필수

### 2. API 코드 상태

#### 2.1 롤백된 파일들
- ✅ `app/api/clients/[clientId]/campaigns/links/route.ts` - 웨비나 지원 제거
- ✅ `app/(client)/client/[clientId]/campaigns/components/CampaignLinksTab.tsx` - 웨비나 UI 제거
- ✅ `app/api/event-survey/campaigns/list/route.ts` - 웨비나 목록 제거

#### 2.2 현재 API 코드 동작

**POST `/api/clients/[clientId]/campaigns/links`**:

```typescript
// 현재 코드 (롤백 후)
const { data: link, error: linkError } = await admin
  .from('campaign_link_meta')
  .insert({
    client_id: clientId,
    name: name.trim(),
    target_campaign_id,  // ⚠️ target_type 명시 안 함
    landing_variant: landing_variant || 'register',
    cid: cid!,
    // ... UTM 파라미터들
    status: 'active',
    created_by: user.id,
  })
```

**문제점**:
- `target_type`을 명시적으로 설정하지 않음
- 데이터베이스 default 'campaign'이 적용됨
- `target_webinar_id`는 처리하지 않음 (null로 설정됨)

---

## ⚠️ 발견된 문제점

### 문제 1: 스키마-코드 불일치 (가장 심각)

**현상**:
- 데이터베이스는 웨비나 지원을 포함하고 있음
- API 코드는 웨비나 기능이 제거된 상태
- `target_type`을 명시하지 않아 데이터베이스 default에 의존

**영향**:
- 현재는 작동하지만, 데이터베이스 제약 조건과 코드 로직이 불일치
- 향후 웨비나 링크가 데이터베이스에 존재할 경우, API가 이를 처리하지 못함

**위험도**: 🟡 **중간** (현재는 작동하지만 구조적 문제)

### 문제 2: 제약 조건 위반 가능성

**현상**:
- API에서 `target_type`을 명시하지 않음
- 데이터베이스 default 'campaign'이 적용됨
- 제약 조건: `target_type = 'campaign'`이면 `target_campaign_id IS NOT NULL` 필수

**영향**:
- 현재 코드는 `target_campaign_id`를 필수로 체크하므로 문제 없음
- 하지만 명시적으로 `target_type = 'campaign'`을 설정하지 않아 혼란 가능

**위험도**: 🟢 **낮음** (현재는 작동함)

### 문제 3: 웨비나 링크 조회 실패

**현상**:
- GET API에서 `target_campaign_id`로만 조회
- 웨비나 링크(`target_type = 'webinar'`)는 `target_campaign_id`가 NULL
- `.single()` 사용 시 에러 발생 가능

**현재 코드**:
```typescript
// GET API의 문제점
const { data: targetCampaign } = await admin
  .from('event_survey_campaigns')
  .select('public_path')
  .eq('id', link.target_campaign_id)  // ⚠️ 웨비나 링크는 NULL
  .single()  // ⚠️ 에러 발생 가능
```

**영향**:
- 웨비나 링크가 데이터베이스에 존재하면 링크 목록 조회 시 에러 발생
- `PGRST204` 또는 `PGRST116` 에러 발생 가능

**위험도**: 🔴 **높음** (웨비나 링크가 있으면 즉시 실패)

### 문제 4: 전환 집계 오류

**현상**:
- GET API에서 `event_survey_entries`만 조회
- 웨비나 링크의 전환은 `registrations` 테이블에 저장됨
- 웨비나 링크의 전환 수가 항상 0으로 표시됨

**현재 코드**:
```typescript
// GET API의 전환 집계
const { count } = await admin
  .from('event_survey_entries')  // ⚠️ 웨비나 전환은 registrations에 있음
  .select('*', { count: 'exact', head: true })
  .eq('marketing_campaign_link_id', link.id)
```

**영향**:
- 웨비나 링크의 전환 수가 잘못 표시됨
- 마케팅 성과 분석이 부정확함

**위험도**: 🟡 **중간** (데이터 표시 오류)

---

## 🎯 핵심 문제: "웨비나로 된 건 꼬여서 캠페인을 못 만드는 거네"

### 사용자 보고 내용 분석

> "결국 설문, 등록으로 저장된 건 캠페인이 되는데  
> 웨비나로 된 건 꼬여서 캠페인을 못 만드는 거네"

**의미**:
1. **설문/등록으로 저장된 건 캠페인**: `event_survey_entries`에 저장되는 전환은 정상 작동
2. **웨비나로 된 건 꼬여서 캠페인을 못 만드는 거네**: 웨비나 관련 데이터가 있으면 캠페인 링크 생성/조회가 실패

### 근본 원인

1. **데이터베이스 스키마는 웨비나 지원 포함**
   - `target_type`, `target_webinar_id` 컬럼 존재
   - 웨비나 링크가 데이터베이스에 존재할 수 있음

2. **API 코드는 웨비나 미지원**
   - 웨비나 링크를 처리하지 않음
   - `target_campaign_id`가 NULL인 경우를 고려하지 않음

3. **제약 조건 충돌**
   - 웨비나 링크: `target_type = 'webinar'`, `target_campaign_id = NULL`
   - API 코드: `target_campaign_id`로 조회 시도 → 실패

---

## 🔧 해결 방안

### 방안 1: 데이터베이스 마이그레이션 롤백 (권장)

**목적**: 데이터베이스 스키마를 코드와 일치시킴

**작업**:
1. `072_add_webinar_support_to_campaign_link_meta.sql` 마이그레이션 롤백
2. `target_type`, `target_webinar_id` 컬럼 제거
3. `target_campaign_id`를 NOT NULL로 복원

**장점**:
- 스키마와 코드가 완전히 일치
- 웨비나 관련 혼란 제거
- 가장 깔끔한 해결책

**단점**:
- 기존 웨비나 링크 데이터가 있다면 손실
- 마이그레이션 롤백 필요

**마이그레이션 예시**:
```sql
-- 롤백 마이그레이션: 078_rollback_webinar_support_from_campaign_link_meta.sql
BEGIN;

-- 웨비나 링크 데이터 확인 및 경고
DO $$
DECLARE
  webinar_link_count INTEGER;
BEGIN
  SELECT COUNT(*) INTO webinar_link_count
  FROM public.campaign_link_meta
  WHERE target_type = 'webinar' OR target_webinar_id IS NOT NULL;
  
  IF webinar_link_count > 0 THEN
    RAISE WARNING '웨비나 링크 %개가 존재합니다. 삭제됩니다.', webinar_link_count;
  END IF;
END $$;

-- 웨비나 링크 삭제 (또는 마이그레이션)
DELETE FROM public.campaign_link_meta
WHERE target_type = 'webinar' OR target_webinar_id IS NOT NULL;

-- 제약 조건 제거
ALTER TABLE public.campaign_link_meta
  DROP CONSTRAINT IF EXISTS check_target_type_campaign;

-- 컬럼 제거
ALTER TABLE public.campaign_link_meta
  DROP COLUMN IF EXISTS target_webinar_id;

ALTER TABLE public.campaign_link_meta
  DROP COLUMN IF EXISTS target_type;

-- target_campaign_id를 NOT NULL로 복원
ALTER TABLE public.campaign_link_meta
  ALTER COLUMN target_campaign_id SET NOT NULL;

-- 인덱스 제거
DROP INDEX IF EXISTS idx_campaign_link_meta_client_webinar;
DROP INDEX IF EXISTS idx_campaign_link_meta_target_type;

COMMIT;
```

### 방안 2: API 코드에 웨비나 처리 추가 (임시)

**목적**: 현재 스키마를 유지하면서 API가 웨비나 링크를 처리하도록 수정

**작업**:
1. GET API에서 `target_type` 확인
2. 웨비나 링크는 `target_webinar_id`로 조회
3. 전환 집계도 `target_type`에 따라 분기

**장점**:
- 데이터베이스 스키마 변경 불필요
- 기존 웨비나 링크 데이터 보존

**단점**:
- 코드 복잡도 증가
- 웨비나 기능이 완전히 구현되지 않음
- 임시 방편에 불과

**코드 예시**:
```typescript
// GET API 수정 예시
const linksWithStats = await Promise.all(
  (links || []).map(async (link) => {
    // target_type 확인
    const targetType = link.target_type || 'campaign';
    
    if (targetType === 'webinar') {
      // 웨비나 링크 처리
      const { count } = await admin
        .from('registrations')
        .select('*', { count: 'exact', head: true })
        .eq('marketing_campaign_link_id', link.id);
      
      const { data: targetWebinar } = await admin
        .from('webinars')
        .select('slug')
        .eq('id', link.target_webinar_id)
        .maybeSingle();
      
      // 웨비나 URL 생성
      const landingPath = link.landing_variant === 'welcome'
        ? `/webinar/${targetWebinar?.slug || ''}`
        : `/webinar/${targetWebinar?.slug || ''}/register`;
      
      // ... URL 생성 로직
    } else {
      // 캠페인 링크 처리 (기존 로직)
      // ...
    }
  })
);
```

### 방안 3: 하이브리드 접근 (권장하지 않음)

**목적**: 데이터베이스 스키마는 유지하되, API는 캠페인만 지원

**작업**:
1. GET API에서 웨비나 링크 필터링
2. POST API에서 `target_type = 'campaign'` 명시적 설정
3. 웨비나 링크는 조회/생성 불가

**장점**:
- 최소한의 코드 변경

**단점**:
- 데이터베이스에 사용하지 않는 컬럼 존재
- 혼란스러운 구조
- 장기적으로 유지보수 어려움

---

## 📊 영향도 분석

### 즉시 영향

| 항목 | 영향도 | 설명 |
|------|--------|------|
| 캠페인 링크 생성 | 🟢 정상 | 현재는 정상 작동 |
| 캠페인 링크 조회 | 🟡 주의 | 웨비나 링크가 있으면 실패 가능 |
| 웨비나 링크 생성 | 🔴 불가능 | API에서 지원하지 않음 |
| 웨비나 링크 조회 | 🔴 실패 | API에서 처리하지 않음 |

### 잠재적 영향

| 시나리오 | 발생 가능성 | 영향 |
|----------|------------|------|
| 웨비나 링크가 DB에 존재 | 중간 | 링크 목록 조회 실패 |
| 웨비나 링크 전환 집계 | 높음 | 전환 수가 0으로 표시 |
| 향후 웨비나 기능 재구현 | 높음 | 스키마-코드 불일치로 혼란 |

---

## ✅ 권장 조치 사항

### 즉시 조치 (필수)

1. **데이터베이스 상태 확인**
   ```sql
   -- 웨비나 링크 존재 여부 확인
   SELECT COUNT(*) 
   FROM campaign_link_meta 
   WHERE target_type = 'webinar' OR target_webinar_id IS NOT NULL;
   ```

2. **마이그레이션 롤백 결정**
   - 웨비나 링크가 없으면: **방안 1 (마이그레이션 롤백)** 권장
   - 웨비나 링크가 있으면: **방안 2 (API 수정)** 고려

### 단기 조치 (1주일 이내)

1. **API 코드에 방어 로직 추가**
   - GET API에서 웨비나 링크 필터링 또는 에러 처리
   - POST API에서 `target_type = 'campaign'` 명시적 설정

2. **데이터베이스 제약 조건 확인**
   - 현재 제약 조건이 올바르게 작동하는지 확인
   - 필요시 제약 조건 수정

### 장기 조치 (향후 계획)

1. **웨비나 지원 재구현**
   - 완전한 웨비나 지원이 필요하면 재구현
   - 스키마와 코드를 동시에 개발

2. **문서화**
   - 현재 상태를 명확히 문서화
   - 향후 개발자 혼란 방지

---

## 📝 결론

현재 상황은 **데이터베이스 스키마와 API 코드 간의 불일치**로 인한 구조적 문제입니다. 

**핵심 문제**:
- 데이터베이스는 웨비나 지원을 포함
- API 코드는 웨비나 기능이 제거됨
- 웨비나 링크가 있으면 캠페인 링크 조회/생성이 실패할 수 있음

**권장 해결책**:
1. **웨비나 링크가 없는 경우**: 마이그레이션 롤백 (방안 1)
2. **웨비나 링크가 있는 경우**: API 코드 수정 (방안 2)

**다음 단계**:
1. 데이터베이스에서 웨비나 링크 존재 여부 확인
2. 위 결과에 따라 해결 방안 선택
3. 선택한 방안으로 즉시 조치

---

**작성자**: AI Assistant  
**검토 필요**: 데이터베이스 상태 확인 후 최종 결정
