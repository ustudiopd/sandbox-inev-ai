# UTM 추적 테스트 가이드

**테스트 계정**: 모두의특강  
**Client ID**: `a556c562-03c3-4988-8b88-ae0a96648514`  
**캠페인 링크 페이지**: https://eventflow.kr/client/a556c562-03c3-4988-8b88-ae0a96648514/campaigns

---

## 🎯 테스트 목표

DoD 4가지 시나리오를 모두 통과하여 "이제부터 집계 된다"를 확인

---

## 📋 테스트 시나리오

### 시나리오 1: UTM 링크 등록

**목표**: `utm_source` 저장 & 집계 반영

**절차**:
1. 캠페인 링크 페이지 접속
2. 새 링크 생성
   - 링크 이름: "테스트-UTM-링크"
   - 전환 타겟: 등록 페이지 선택
   - 템플릿: 원하는 채널 선택 (예: 이메일)
   - UTM 파라미터 확인 (자동 채워짐)
3. 생성된 **광고용 UTM 링크** 복사
4. 새 브라우저 창(시크릿 모드)에서 링크 접속
5. 등록 페이지에서 등록 완료
6. 집계 페이지에서 확인
   - Source별 전환에 해당 UTM source가 표시되는지 확인
   - 추적 성공률이 증가하는지 확인

**예상 결과**:
- ✅ `utm_source`가 저장됨
- ✅ Source 집계에 잡힘
- ✅ 추적 성공률 증가

---

### 시나리오 2: cid 링크 등록 (UTM 없음)

**목표**: link_id 또는 캠페인 매칭 성공 (Direct만으로 안 떨어짐)

**절차**:
1. 캠페인 링크 페이지 접속
2. 새 링크 생성
   - 링크 이름: "테스트-cid-링크"
   - 전환 타겟: 등록 페이지 선택
   - 템플릿: 선택하지 않음 (UTM 없음)
3. 생성된 **공유용 링크** (cid만 포함) 복사
4. 새 브라우저 창(시크릿 모드)에서 링크 접속
5. 등록 페이지에서 등록 완료
6. 집계 페이지에서 확인
   - 링크별 전환에 해당 링크가 표시되는지 확인
   - Source별 전환에 "Direct (no tracking)"이 아닌 다른 값이 표시되는지 확인

**예상 결과**:
- ✅ `marketing_campaign_link_id`가 저장됨
- ✅ 링크별 전환에 표시됨
- ✅ "Direct (no tracking)"으로 분류되지 않음

---

### 시나리오 3: `/s/[code]` 경유 등록

**목표**: query+cookie 보존으로 추적 저장

**절차**:
1. 웨비나 short-link 생성 (또는 기존 short-link 사용)
2. Short-link에 UTM 파라미터 추가
   - 예: `/s/123456?cid=ABC123&utm_source=test&utm_medium=email`
3. 새 브라우저 창(시크릿 모드)에서 링크 접속
4. 리다이렉트 후 등록 페이지에서 UTM 파라미터 확인
5. 등록 완료
6. 집계 페이지에서 확인
   - UTM 파라미터가 저장되었는지 확인
   - Cookie가 저장되었는지 확인 (브라우저 개발자 도구)

**예상 결과**:
- ✅ 리다이렉트 후에도 UTM 파라미터 유지
- ✅ Cookie에 추적 정보 저장
- ✅ 등록 시 추적 정보 복원 성공

---

### 시나리오 4: 진짜 Direct

**목표**: "Direct (no tracking)"로 분리 표기

**절차**:
1. 등록 페이지 URL 직접 접속 (UTM/cid 없음)
   - 예: `/event/149403/register` (파라미터 없음)
2. 등록 완료
3. 집계 페이지에서 확인
   - Source별 전환에 "Direct (no tracking)"이 표시되는지 확인
   - 추적 실패 항목으로 표시되는지 확인

**예상 결과**:
- ✅ "Direct (no tracking)"으로 분리 표기
- ✅ 추적 실패 항목으로 시각적 표시
- ✅ 추적 성공률 계산에 반영

---

## 🔍 확인 사항

### 1. 브라우저 개발자 도구 확인

**Network 탭**:
- 등록 API 호출 확인
- Visit API 호출 확인 (선택적)

**Application 탭 → Cookies**:
- `ef_tracking` cookie 확인
- Cookie 값 확인 (JSON 형태)

**Console 탭**:
- `[Middleware Tracking] Cookie 저장` 로그 확인
- `[Restore Tracking]` 로그 확인
- `[register] 복원된 추적 정보` 로그 확인

---

### 2. 집계 페이지 확인

**URL**: https://eventflow.kr/client/a556c562-03c3-4988-8b88-ae0a96648514/campaigns

**확인 항목**:
1. **추적 성공률 표시**
   - 전체 전환 수 아래에 추적 성공률 표시
   - 색상: 80% 이상 (녹색), 50-80% (노란색), 50% 미만 (빨간색)

2. **Source별 전환**
   - "Direct (no tracking)" 라벨 확인
   - 추적 실패 항목은 배경색으로 표시

3. **링크별 전환**
   - 생성한 링크가 표시되는지 확인
   - 전환 수가 정확한지 확인

---

## 🐛 문제 발생 시 확인

### 문제 1: UTM이 저장되지 않음

**확인**:
1. 등록 페이지 URL에 UTM 파라미터가 있는지 확인
2. 브라우저 개발자 도구 → Network 탭에서 등록 API 요청 확인
3. 서버 로그에서 `[register] 복원된 추적 정보` 확인

**해결**:
- URL에 UTM 파라미터가 있는지 확인
- Cookie가 저장되었는지 확인
- 등록 API 로그 확인

---

### 문제 2: Cookie가 저장되지 않음

**확인**:
1. 브라우저 개발자 도구 → Application 탭 → Cookies 확인
2. 서버 로그에서 `[Middleware Tracking] Cookie 저장` 확인
3. Middleware matcher가 올바른지 확인

**해결**:
- Middleware matcher 확인 (`/event/*`, `/webinar/*`, `/s/*`)
- Cookie 설정 확인 (httpOnly, secure, sameSite)

---

### 문제 3: Cookie에서 복원되지 않음

**확인**:
1. Cookie가 있는지 확인
2. 서버 로그에서 `[Restore Tracking] Cookie 검증` 확인
3. Trust Window 확인 (24시간 이내인지)

**해결**:
- Cookie의 `captured_at` 확인
- Trust Window 확인 (24시간)
- 캠페인 매칭 확인

---

## 📊 테스트 체크리스트

### 시나리오 1: UTM 링크 등록
- [ ] 링크 생성 성공
- [ ] UTM 링크로 접속
- [ ] 등록 완료
- [ ] 집계에 표시됨
- [ ] 추적 성공률 증가

### 시나리오 2: cid 링크 등록
- [ ] 링크 생성 성공 (UTM 없음)
- [ ] cid 링크로 접속
- [ ] 등록 완료
- [ ] 링크별 전환에 표시됨
- [ ] "Direct (no tracking)"이 아님

### 시나리오 3: `/s/[code]` 경유
- [ ] Short-link에 UTM 추가
- [ ] 리다이렉트 후 UTM 유지 확인
- [ ] Cookie 저장 확인
- [ ] 등록 완료
- [ ] 추적 정보 복원 확인

### 시나리오 4: 진짜 Direct
- [ ] 파라미터 없이 접속
- [ ] 등록 완료
- [ ] "Direct (no tracking)" 표시 확인
- [ ] 추적 실패 항목으로 표시 확인

---

## 🎯 성공 기준

모든 시나리오에서:
- ✅ 등록이 성공적으로 완료됨
- ✅ 추적 정보가 올바르게 저장됨
- ✅ 집계에 정확히 반영됨
- ✅ 추적 성공률이 표시됨

---

**마지막 업데이트**: 2026-02-02  
**테스트 계정**: 모두의특강 (a556c562-03c3-4988-8b88-ae0a96648514)
