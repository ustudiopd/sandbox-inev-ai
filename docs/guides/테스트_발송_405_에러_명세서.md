# 테스트 발송 405 에러 문제 분석 및 해결 명세서

## 📋 문제 상황

### 증상
- **로컬 환경**: 테스트 발송 기능 정상 작동 ✅
- **배포 환경 (Vercel)**: 테스트 발송 시 405 (Method Not Allowed) 에러 발생 ❌

### 에러 메시지
```
/api/client/emails/c096b593-14e8-4929-a331-46927beca76f/test-send:1 
Failed to load resource: the server responded with a status of 405 ()
```

### 발생 시점
- 2026년 2월 4일
- 배포 환경에서 테스트 발송 기능 사용 시

---

## 🔍 현재 구현 상태

### 1. API 라우트 핸들러

**파일 위치**: `app/api/client/emails/[id]/test-send/route.ts`

**구현 내용**:
```typescript
export const runtime = 'nodejs'
export const dynamic = 'force-dynamic'

/**
 * POST /api/client/emails/[id]/test-send
 * 테스트 이메일 발송
 */
export async function POST(
  req: Request,
  { params }: { params: Promise<{ id: string }> }
) {
  // ... 구현 내용
}
```

**주요 기능**:
1. 캠페인 조회 및 권한 확인
2. `ready` 상태 검증
3. 테스트 이메일 발송 (최대 10개)
4. 개인화 변수 처리
5. `email_runs` 및 `audit_logs` 기록

### 2. 프론트엔드 호출 코드

**파일 위치**: `components/email/EmailCampaignTab.tsx`

**호출 코드**:
```typescript
const response = await fetch(`/api/client/emails/${selectedCampaign.id}/test-send`, {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ testEmails: emails }),
})
```

### 3. 라우트 구조

```
app/
  api/
    client/
      emails/
        [id]/
          test-send/
            route.ts  ✅ POST 핸들러만 export
          send/
            route.ts  ✅ 정상 작동
          approve/
            route.ts  ✅ 정상 작동
```

---

## 🔎 문제 원인 분석

### 가능한 원인들

#### 1. **Next.js 라우트 핸들러 인식 문제**
- Next.js App Router에서 동적 라우트(`[id]`)와 중첩된 라우트(`test-send`)가 제대로 빌드되지 않았을 가능성
- 배포 환경에서 라우트 매칭이 실패하여 405 에러 발생

#### 2. **빌드 캐시 문제**
- 이전 빌드 캐시가 남아있어 새로운 라우트가 인식되지 않음
- Vercel의 빌드 캐시가 최신 코드를 반영하지 못함

#### 3. **라우트 핸들러 export 문제**
- GET 핸들러를 추가했다가 제거하는 과정에서 빌드가 꼬였을 가능성
- Next.js가 라우트를 제대로 인식하지 못함

#### 4. **배포 환경 차이**
- 로컬 개발 서버와 프로덕션 빌드의 차이
- Next.js Turbopack vs Webpack 빌드 차이

---

## 📝 수정 내역

### 커밋 히스토리

#### 1. **커밋: `34b1147` - 테스트 발송 405 에러 및 surveys 페이지 JSON 파싱 오류 수정**
- **변경 파일**: 
  - `app/api/client/emails/[id]/test-send/route.ts`
  - `app/(client)/client/[clientId]/surveys/[campaignId]/page.tsx`
- **변경 내용**:
  - GET 핸들러 추가 시도 (405 에러 해결 시도)
  - surveys 페이지 JSON 파싱 에러 처리 추가

#### 2. **커밋: `dfc3588` - test-send 라우트 GET 핸들러 제거 (Next.js 자동 405 처리)**
- **변경 파일**: `app/api/client/emails/[id]/test-send/route.ts`
- **변경 내용**:
  - GET 핸들러 제거
  - Next.js가 자동으로 지원하지 않는 메서드에 대해 405를 반환하도록 함

#### 3. **커밋: `1d66bb1` - Node.js 버전 명시 (engines 필드 추가)**
- **변경 파일**: `package.json`
- **변경 내용**:
  ```json
  "engines": {
    "node": ">=18.0.0"
  }
  ```

### 수정 과정

1. **초기 시도**: GET 핸들러 추가로 405 에러 해결 시도
   - 결과: 실패 (여전히 405 에러)

2. **두 번째 시도**: GET 핸들러 제거, Next.js 기본 동작에 의존
   - 결과: 로컬에서는 작동하지만 배포 환경에서 여전히 405 에러

3. **세 번째 시도**: 빌드 캐시 정리 및 재빌드
   - 결과: 로컬 빌드는 성공하지만 배포 환경 문제 지속

---

## 🛠️ 해결 방법

### 즉시 조치 사항

#### 1. **Vercel 배포 로그 확인**
```bash
# Vercel 대시보드에서 확인
1. 프로젝트 → Deployments
2. 최신 배포 클릭
3. Build Logs 확인
4. Function Logs 확인
```

#### 2. **빌드 캐시 강제 정리**
- Vercel 대시보드 → Settings → General
- "Clear Build Cache" 클릭
- 재배포 실행

#### 3. **환경 변수 확인**
- 필수 환경 변수가 모두 설정되어 있는지 확인:
  - `NEXT_PUBLIC_SUPABASE_URL`
  - `NEXT_PUBLIC_SUPABASE_ANON_KEY`
  - `SUPABASE_SERVICE_ROLE_KEY`

### 근본 원인 해결 방안

#### 방안 1: 라우트 파일 재생성
```bash
# 1. 기존 파일 삭제
rm -rf app/api/client/emails/[id]/test-send

# 2. 새로 생성
mkdir -p app/api/client/emails/[id]/test-send
# route.ts 파일 재작성
```

#### 방안 2: 명시적 라우트 핸들러 추가
```typescript
// route.ts에 모든 HTTP 메서드 명시적 처리
export async function GET() {
  return NextResponse.json(
    { error: 'Method not allowed' },
    { status: 405 }
  )
}

export async function POST(...) {
  // 기존 구현
}
```

#### 방안 3: 라우트 경로 변경 검토
- 현재: `/api/client/emails/[id]/test-send`
- 대안: `/api/client/emails/[id]/test-send` (유지)
- 또는: `/api/client/emails/test-send/[id]` (경로 변경)

### 권장 해결 순서

1. ✅ **Vercel 배포 로그 확인** (가장 중요)
   - 빌드 에러가 있는지 확인
   - 라우트가 제대로 빌드되었는지 확인

2. ✅ **빌드 캐시 정리 후 재배포**
   - Vercel 대시보드에서 캐시 정리
   - 강제 재배포 실행

3. ✅ **로컬 프로덕션 빌드 테스트**
   ```bash
   npm run build
   npm run start
   # 브라우저에서 테스트 발송 시도
   ```

4. ✅ **라우트 파일 재생성** (위 방법 실패 시)
   - 기존 파일 삭제 후 재생성
   - 커밋 및 푸시

---

## 📊 현재 상태

### ✅ 정상 작동하는 부분
- 로컬 개발 환경에서 테스트 발송 정상 작동
- 코드 구현은 정상 (타입스크립트 에러 없음)
- 다른 라우트 핸들러들 (`send`, `approve` 등) 정상 작동

### ❌ 문제가 있는 부분
- 배포 환경에서 405 에러 발생
- 배포 서버가 라우트를 인식하지 못함

### 🔄 진행 중인 작업
- 배포 로그 분석
- 빌드 캐시 정리
- 재배포 대기 중

---

## 📚 참고 자료

### 관련 문서
- `이메일발송시스템_확정명세서.md` - 8.6절 테스트 발송 API 명세
- `docs/ENV_SETUP.md` - 환경 변수 설정 가이드

### 관련 파일
- `app/api/client/emails/[id]/test-send/route.ts` - API 라우트 핸들러
- `components/email/EmailCampaignTab.tsx` - 프론트엔드 호출 코드
- `package.json` - Node.js 버전 명시

### Next.js 문서
- [Route Handlers](https://nextjs.org/docs/app/building-your-application/routing/route-handlers)
- [Dynamic Routes](https://nextjs.org/docs/app/building-your-application/routing/dynamic-routes)

---

## 🎯 다음 단계

1. **Vercel 배포 로그 확인** (최우선)
2. **빌드 캐시 정리 후 재배포**
3. **로컬 프로덕션 빌드로 재현 시도**
4. **문제 지속 시 라우트 파일 재생성**

---

**작성일**: 2026년 2월 4일  
**작성자**: AI Assistant  
**상태**: 조사 중
