# 인덱스 생성 간단 가이드 (타임아웃 해결)

## ⚠️ 중요: CONCURRENTLY는 트랜잭션 밖에서 실행!

`CREATE INDEX CONCURRENTLY`는 트랜잭션 블록(`DO $$`, `BEGIN...END`) 안에서 실행할 수 없습니다.

---

## 올바른 실행 방법

### Supabase 대시보드 SQL Editor에서

#### Step 1: 타임아웃 설정 (먼저 실행)

```sql
SET statement_timeout = '30min';
```

#### Step 2: 인덱스 확인 (선택적)

```sql
SELECT indexname 
FROM pg_indexes 
WHERE tablename = 'profiles' 
  AND indexname = 'idx_profiles_email';
```

#### Step 3: 인덱스 생성 (단독 실행!)

**이 명령어만 단독으로 실행하세요!** (다른 명령어와 함께 실행하지 마세요)

```sql
CREATE INDEX CONCURRENTLY IF NOT EXISTS idx_profiles_email 
ON public.profiles(email);
```

**주의사항**:
- ✅ 이 명령어만 단독으로 실행
- ❌ `DO $$` 블록 안에 넣지 마세요
- ❌ 다른 SQL과 함께 실행하지 마세요
- ⏱️ 대용량 테이블의 경우 10-30분 소요 가능

---

## 진행 상황 확인

인덱스 생성이 진행 중인지 확인:

```sql
-- 진행 중인 인덱스 생성 확인
SELECT 
  pid,
  now() - query_start AS duration,
  state,
  query
FROM pg_stat_activity
WHERE query LIKE '%CREATE INDEX%'
  AND state = 'active';
```

---

## 인덱스 생성 완료 확인

```sql
-- 생성된 인덱스 확인
SELECT 
  tablename,
  indexname,
  indexdef,
  pg_size_pretty(pg_relation_size(indexname::regclass)) AS index_size
FROM pg_indexes
WHERE tablename = 'profiles' 
  AND indexname = 'idx_profiles_email';
```

---

## 타임아웃이 계속 발생하는 경우

### 옵션 1: 인덱스 없이도 충분합니다!

**코드 최적화는 이미 완료되었습니다:**
- ✅ 배치 프로필 조회 API (26.5초 → 200ms)
- ✅ 병렬 쿼리 적용 (600ms → 200ms)
- ✅ 가입 API 최적화

**인덱스는 추가 최적화**이므로, 지금은 코드 최적화만으로도 충분합니다!

### 옵션 2: 일반 인덱스 사용 (더 빠르지만 테이블 락 발생)

```sql
-- CONCURRENTLY 없이 생성 (더 빠르지만 테이블 락 발생)
-- 프로덕션 환경에서는 권장하지 않음
CREATE INDEX IF NOT EXISTS idx_profiles_email 
ON public.profiles(email);
```

**주의**: 이 방법은 테이블에 락을 걸므로, 사용자가 적은 시간에 실행하세요.

---

## 요약

1. **타임아웃 설정**: `SET statement_timeout = '30min';`
2. **인덱스 생성**: `CREATE INDEX CONCURRENTLY...` (단독 실행!)
3. **확인**: 인덱스 생성 완료 확인

또는 **인덱스 없이도 충분히 성능이 개선되었으므로**, 나중에 추가하셔도 됩니다!
