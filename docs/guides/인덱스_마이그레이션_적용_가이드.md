# 인덱스 마이그레이션 적용 가이드

## 생성된 마이그레이션 파일

`supabase/migrations/095_add_performance_indexes.sql`

이 파일에는 성능 개선을 위한 다음 인덱스들이 포함되어 있습니다:

1. **idx_profiles_email** - profiles.email 컬럼 인덱스 (가장 중요!)
2. **idx_profiles_email_lower** - 소문자 이메일 검색 인덱스
3. **idx_agency_members_user_id** - agency_members.user_id 인덱스
4. **idx_client_members_user_id** - client_members.user_id 인덱스

---

## 적용 방법

### 방법 1: Supabase 대시보드에서 직접 실행 (권장)

1. **Supabase 대시보드 접속**: https://supabase.com/dashboard
2. **프로젝트 선택**: EventLive (yqsayphssjznthrxpgfb)
3. **SQL Editor** 메뉴로 이동
4. `supabase/migrations/095_add_performance_indexes.sql` 파일 내용을 복사하여 실행

---

### 방법 2: MCP 도구로 적용 (연결 문제 해결 후)

```typescript
// MCP Supabase 도구 사용
mcp_supabase_apply_migration(
  project_id: "yqsayphssjznthrxpgfb",
  name: "add_performance_indexes",
  query: "마이그레이션 SQL 내용"
)
```

---

### 방법 3: Supabase CLI로 적용 (연결 문제 해결 후)

```bash
# 마이그레이션 적용
npx supabase db push

# 또는 특정 마이그레이션만 적용
npx supabase migration up
```

---

## 인덱스 적용 확인

마이그레이션 적용 후 다음 SQL로 확인:

```sql
-- 생성된 인덱스 확인
SELECT 
  tablename,
  indexname,
  indexdef
FROM pg_indexes
WHERE tablename IN ('profiles', 'agency_members', 'client_members')
  AND indexname LIKE 'idx_%'
ORDER BY tablename, indexname;

-- 예상 결과:
-- profiles | idx_profiles_email | CREATE INDEX idx_profiles_email ON public.profiles(email)
-- profiles | idx_profiles_email_lower | CREATE INDEX idx_profiles_email_lower ON public.profiles(LOWER(email))
-- agency_members | idx_agency_members_user_id | CREATE INDEX idx_agency_members_user_id ON public.agency_members(user_id)
-- client_members | idx_client_members_user_id | CREATE INDEX idx_client_members_user_id ON public.client_members(user_id)
```

---

## 성능 개선 효과

### 인덱스 적용 전
- **배치 프로필 조회**: 265명 조회 시 **26.5초+**
- **이메일 검색**: **500ms+**
- **대시보드 API**: **600ms+**

### 인덱스 적용 후 (예상)
- **배치 프로필 조회**: 265명 조회 시 **200ms 이내** ⚡ (130배 개선)
- **이메일 검색**: **10ms 이내** ⚡ (50배 개선)
- **대시보드 API**: **200ms 이내** ⚡ (3배 개선)

---

## 주의사항

1. **인덱스 생성 시간**: 대용량 테이블의 경우 인덱스 생성에 시간이 걸릴 수 있습니다.
2. **디스크 공간**: 인덱스는 추가 디스크 공간을 사용합니다 (보통 테이블 크기의 10-20%).
3. **INSERT/UPDATE 성능**: 인덱스가 많을수록 INSERT/UPDATE가 약간 느려질 수 있지만, SELECT 성능 향상이 훨씬 큽니다.

---

## 롤백 방법 (필요한 경우)

```sql
-- 인덱스 삭제
DROP INDEX IF EXISTS public.idx_profiles_email;
DROP INDEX IF EXISTS public.idx_profiles_email_lower;
DROP INDEX IF EXISTS public.idx_agency_members_user_id;
DROP INDEX IF EXISTS public.idx_client_members_user_id;
```

---

## 참고 자료

- `docs/성능_지연_원인_분석_보고서.md` - 성능 문제 분석
- `docs/인덱스_확인_및_생성_가이드.md` - 인덱스 확인 방법
- `supabase/migrations/095_add_performance_indexes.sql` - 마이그레이션 파일
