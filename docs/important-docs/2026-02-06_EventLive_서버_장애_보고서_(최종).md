According to a document from **2026-02-08**, 아래는 **2026-02-06 EventLive 서버 장애(웨비나 운영 영향) 전체 장애 보고서(최종본)** 입니다.
(근거 문서: 2026-02-08 종합보고서 + 2026-02-07 코드 기반 진단보고서 v2 + 2026-02-07 채팅 자동화 테스트 요약 + Realtime Broadcast 권한 점검 문서)

---

# 2026-02-06 EventLive 서버 장애 보고서 (최종)

## 문서 메타

* **작성일**: 2026-02-08
* **대상 시스템**: EventLive (Supabase + Next.js)
* **장애 시간대(잔류 영향 포함)**: 2026-02-06 13:30~15:00 (KST)
* **핵심 장애 구간(코드 기반 진단 기준)**: 2026-02-06 13:30~14:30 (KST)
* **대표 영향 웨비나**: 149402 “AI 특허리서치 실무 활용 웨비나” (문서상 최대 동시 접속 311명)
* **심각도(권장)**: Major / 웨비나 운영 영향(입장·인증·실시간 기능에 체감 지연/실패 가능)

---

## 1) Executive Summary (요약)

2026-02-06 오후, 웨비나 149402에서 동시 접속이 급증하면서 **Supabase DB 한도/성능 저하**가 발생했고, 그 결과 웨비나 운영에 영향을 주는 장애가 발생했습니다.
핵심 원인은 **(1) 존재하지 않는 `registrations.id` 컬럼을 조회하는 코드 오류로 400이 대량 발생**했고, **(2) 400 오류 이후에도 로직이 진행되며 자동 등록 INSERT를 시도**해 **409(중복키) 경합**과 추가 부하가 연쇄 발생한 것입니다. 또한 참가자 핫패스(`/presence/ping`, `/access/track`)가 인증/등록 확인·생성/다중 조회를 포함해 동접에서 DB/Auth 과부하를 유발하기 쉬운 구조였습니다.

당일에는 **코드 배포 없이** Supabase 리소스 확장(한도 상향/컴퓨트 상향/모니터링 강화)으로 우선 복구했고, 이후 **P0 코드 수정(재발 방지)**을 2/7에 배포 완료했습니다.

---

## 2) 영향(Impact)

### 참가자(시청자) 영향

* 입장/인증/세션 갱신 경로에서 **실패 또는 지연**이 발생할 수 있는 조건이 형성됨
* 특히 장애 초반에 400/409가 집중되면 “재시도 → 추가 부하 → 더 지연”의 악순환이 만들어질 수 있는 구조였음

### 관리자(운영 콘솔) 영향

* 운영 대시보드(Presence/접속자 관련 UI) 로딩 지연
* 관리자 대시보드가 5초 폴링 형태일 경우, 장애 상황에서 모니터링 자체가 추가 부하로 작동할 여지가 있음(증폭기 후보)

---

## 3) 시스템/트래픽 전제(사건을 키운 구조)

이번 장애는 “동접 증가” 자체보다, **동접 증가가 바로 DB/Auth 과부하로 연결되는 핫패스 구조**가 중요했습니다.

### 3.1 참가자 핫패스 엔드포인트 구조(진단 문서 기준)

* `POST /api/webinars/[webinarId]/access/track`

  * 입장 시 1회 + 이후 5분마다
  * 1회 호출당 DB 쿼리 3~7회

* `POST /api/webinars/[webinarId]/presence/ping`

  * 120초 ± 10초 주기
  * 1회 호출당 DB 쿼리 4~10회(400 에러 시 1회에서 종료)

### 3.2 트래픽 증폭 계산(참고 시나리오)

진단 문서의 1,000명 동접 가정 계산에서는 분당/시간당 DB 쿼리 수가 큰 폭으로 증가할 수 있음을 보여줍니다(“구조적 위험” 설명에 사용).

---

## 4) 장애 원인(Root Cause)

### 4.1 직접 트리거: 스키마 불일치(`registrations.id`) → 400 폭발

* `registrations` 테이블은 **복합 키(webinar_id, user_id)** 구조인데, API에서 `.select('id')`를 호출해 **PostgREST 400** (`column registrations.id does not exist`)이 대량 발생했습니다.
* 진단 문서에서도 `/rest/v1/registrations?select=id`가 400으로 “호출 빈도 높음”으로 기록되어 있습니다.

### 4.2 2차 증폭: 400 후에도 로직 진행 → 자동 등록 INSERT → 409 연쇄

* 더 큰 문제는 “400이 났는데도 로직이 계속 진행”되는 오류 루프였습니다.
* 등록 조회가 실패하면 “등록 없음”으로 오판 → 자동 등록 INSERT 시도 → 동시에 여러 요청이 들어오면 **registrations_pkey 중복키 위반(409)**이 연쇄 발생합니다.

### 4.3 동반/기여 요인(Contributing Factors)

* **Auth 지연/경합**: `/auth/v1/user` 평균 ~2초, `/auth/v1/token` refresh 평균 ~7초, `refresh_token_already_used` 관측(토큰 경합 가능)
* **멀티테넌시**(한 웨비나 폭주가 전체에 영향) 및 **RLS/Realtime 불안정 시 폴백 폴링**이 위험 요인으로 문서화되어 있음
* **운영 대시보드 5초 폴링(무한 반복, 재시도/중단 로직 없음)**은 장애 상황에서 증폭기로 작동할 수 있음
* **채팅 폴백 폴링**은 Realtime 불안정 시 켜질 수 있고, 지수 백오프로 완화는 있지만 “복구될 때까지 무한 반복”이어서 장애 구간에서는 추가 부하 후보로 관리 필요

---

## 5) 타임라인(사실 기반 + 보강 필요 항목 분리)

> 문서에 “정확한 분 단위 시각”이 모두 기록되어 있지 않아, 아래는 **확정 가능(문서 명시)**과 **추가 수집 필요**로 구분했습니다.

### 5.1 확정 타임라인(문서 명시)

* **2026-02-06 13:30~15:00** 장애/잔류 영향(종합보고서)
* **2026-02-06 13:30~14:30** 핵심 장애 구간(진단보고서 v2)
* **2026-02-06 당일**: Supabase 한도 상향/컴퓨트 상향/모니터링 강화로 우선 복구
* **2026-02-07**: 원인 분석(코드 기반 진단/우선순위 재정렬) 수행
* **2026-02-07 11:46 머지 / 11:48 배포 완료**: P0 재발 방지 패치(PR #1, 커밋 a8719e7)
* **2026-02-07**: 채팅 인사 버튼 자동화 400명 테스트 수행

### 5.2 추가 수집 필요(진단 문서가 “확인 필요”로 명시)

* 장애 시간대 **엔드포인트별 요청 수(Vercel/서버 로그)**
* Supabase 지표 스냅샷(DB/Auth/Realtime, 400/409 비율)
* Realtime disconnect 및 채팅 폴백 활성화 여부(프론트 fallbackOn)

---

## 6) 장애 당시 라이브 조치(즉시 대응 / 복구)

장애 당일(2/6)에는 “원인 코드 수정 배포” 이전에 **가용성 확보가 우선**이었고, 다음 조치로 우선 복구했습니다.

* **Supabase 한도 상향**(DB 연결 수·리소스 한도 증가)
* **컴퓨트 사양 변경**(더 높은 성능 인스턴스로 업그레이드)
* **서비스 모니터링 강화**

> 이 조치로 대부분 사용자는 이용 가능 상태로 복구되었으나, 400/409의 코드 원인은 남아 있어 “동일 트래픽 재발 시 재발 가능” 상태였다고 문서에 명시되어 있습니다.

---

## 7) 후속조치(재발 방지 수정) 및 배포 완료 내용

### 7.1 P0 코드 수정(장애 트리거 제거 + 증폭 루프 차단)

**머지·배포**: 2026-02-07 11:46 머지, 11:48 배포 완료(PR #1, 커밋 a8719e7)

핵심 변경사항(요약):

1. **registrations.id 참조 제거**: `presence/ping`, `access/track`에서 `.select('id')` 전수 제거 → 400 트리거 제거
2. **Fail-fast**: 등록 조회 등에서 error 발생 시 후속 로직(자동등록 등) 진행 금지
3. **presence/ping 경량화**: 핫패스에서 자동 등록 생성 제거/격리, 등록은 입장 시점 책임으로 이동
4. **409 멱등 처리**: UPSERT/onConflict로 동시 요청 시 409를 정상 흐름으로 흡수

---

## 8) 배포 후 점검/테스트(조치 완료 확인)

### 8.1 DoD(Definition of Done) 모니터링

배포 후 확인 기준(DEPLOYMENT_RESULTS.md 기준)이 문서에 정리되어 있습니다.

* **DoD-1**: `registrations.id` 관련 400 0건
* **DoD-2**: registrations 409(중복키)가 “폭발”하지 않음
* **DoD-3**: `/auth/v1/user` 비정상 증가 없음
* **DoD-4**: 기능 회귀 없음(등록자/관리자/비등록자 플로우)

또한 DoD 실패 시 **즉시 롤백 트리거**를 두도록 문서화되어 있습니다.

### 8.2 채팅(Realtime 기능) 자동화 테스트 – 400명

* 로그인 성공: 400/400 (100%)
* 인사 버튼 클릭: 400/400 (100%)
* 메시지 전송: 396/400 (99%)
* 메시지 수신 확인: 0/400 (DOM 검증 로직 개선 필요)
* 평균 13.98초/사용자, p95 18.83초

> 해석: “채팅이 안 됐다”라기보다, 테스트가 **DOM 기반 수신 검증에 실패**한 상태로 기록되어 있어, **검증 방식(네트워크/DB 기반) 보강**이 필요합니다.

---

## 9) 병행/누적 최적화(참고: 장애 재발 방지에 간접 기여)

종합보고서는 P0와 별개로 이미 적용/정리된 최적화 항목을 함께 정리하고 있습니다.

* **N+1 개선**: 대시보드 접속자 목록을 개별 호출 → 배치 API(`/api/profiles/batch`)로 전환(265명 기준 26.5초+ → 200ms 내 수준)
* **RLS 최적화**: `auth.uid()`를 `(select auth.uid())`로 변경해 쿼리당 1회 평가로 비용 절감(마이그레이션 098/099)
* **인덱스 보강**: `webinar_live_presence`, `webinar_user_sessions` 등 패턴 기반 인덱스 추가(마이그레이션 100 등)
* **하트비트(핑) 운영 규칙**: 120초 ± 지터 유지 및 문서화/throttle 정리

---

## 10) 재발 방지 관점의 “남은 리스크”와 다음 단계(P1/P2)

### 10.1 P1(단기: 운영 안정화)

종합보고서의 계획된 후속(P1)에는 다음이 포함됩니다.

* 관리자 `/stats/access` 폴링 주기 완화(예: 5초 → 10초)
* Realtime 폴백 폴링에 **서킷 브레이커**(4xx 즉시 중단, 5xx 백오프)
* 참가자 핫패스의 Vercel 서버리스 hop 제거 및 Supabase RPC 직행 검토

### 10.2 P2(중기: 측정 기반 최적화/격리)

* RLS·인덱스의 측정 기반 추가 최적화, 부하 테스트/격리 시나리오 정비

---

## 11) 보안/권한 관련 참고(Realtime Broadcast)

이번 장애의 직접 원인은 아니지만, “악의적 publish 가능성” 관점에서 문서화된 사항입니다.

* 현재는 **마이그레이션(104)만 적용된 상태**로, 채널이 public이고 Allow public access가 켜져 있으면 Realtime이 RLS를 적용하지 않음
* RLS 기반 Realtime 권한을 실제로 적용하려면

  1. 채널을 `private: true`로 구독
  2. 대시보드에서 **Allow public access OFF**가 필요
* 다만 현재 앱은 “관리자 이벤트는 서버에서만 전송” 구조라 기능적으로는 정상 동작하며, **강화 옵션 적용 전에는 session_conflict 이벤트의 API 경유 전환이 필요**할 수 있음

---

## 12) 결론(최종 정리)

* **무엇 때문에 터졌나**

  * `registrations.id`라는 **존재하지 않는 컬럼 참조**가 참가자 핫패스에서 발생 → 400 폭발
  * 400에도 로직 진행 → 자동 등록 INSERT → 409 연쇄 → DB/Auth 지연으로 확산

* **당시에 라이브로 무엇을 해서 해결했나**

  * Supabase 한도 상향 + 컴퓨트 상향 + 모니터링 강화로 우선 복구(코드 배포 없이 Availability 확보)

* **후속조치로 무엇을 했고, 어떻게 “완료”를 확인했나**

  * 2/7에 P0 패치 배포 완료(400 트리거 제거, fail-fast, ping 경량화, 409 멱등 처리)
  * 배포 후 DoD(400/409/Auth/회귀) 기준 모니터링 체계로 점검
  * 채팅 400명 자동화 테스트로 로그인/전송의 대규모 동작 확인(수신 검증 로직은 개선 필요)

---

## 부록 A) “보고서 완성도”를 더 올리기 위한 추가 첨부(추천)

진단 문서에서 **추가로 확보하면 좋다고 명시한 3가지**(로그/지표/폴백 여부)를 이번 보고서의 부록으로 붙이면, 외부 공유 시 신뢰도가 크게 올라갑니다.

* (A1) 장애 시간대 엔드포인트별 요청 수(Vercel 로그)
* (A2) Supabase 지표 스냅샷(DB requests/time, Auth requests/time, Realtime 연결/이벤트 수, 400/409 비율)
* (A3) Realtime disconnect 및 채팅 폴백 활성화 여부(프론트 fallbackOn)

---

원하면, 위 보고서를 **(1) 고객/클라이언트 공유용 1페이지 버전**과 **(2) 내부 엔지니어링용(티켓/DoD/롤백 포함) 버전**으로 **두 문서로 재구성**해줄게요.
