# EventFlow 운영 로그 수집 전략

**작성일**: 2026-02-05  
**목적**: 운영 전반적인 로그를 외부 툴로 집계하여 문제 발생 시 분석 가능한 기본 자료 확보

---

## 1. 현재 시스템 분석

### 1.1 아키텍처
- **프레임워크**: Next.js 16.0.10 (App Router, Serverless Functions)
- **호스팅**: Vercel (Serverless Functions)
- **데이터베이스**: Supabase PostgreSQL
- **실시간**: Supabase Realtime (Broadcast, Presence)
- **이메일**: Resend API
- **AI**: Google Gemini API

### 1.2 주요 서비스 영역

#### API 엔드포인트 (약 100+ 개)
- **인증/권한**: `/api/auth/*`, `/api/user/*`
- **웨비나 관리**: `/api/webinars/*` (생성, 수정, 삭제, 통계, 등록자 관리)
- **설문조사**: `/api/event-survey/*` (캠페인, 등록, 제출, 분석)
- **이메일 발송**: `/api/client/emails/*` (생성, 발송, 테스트)
- **공개 API**: `/api/public/*` (방문 추적, 등록, 제출)
- **크론 작업**: `/api/cron/*` (웨비나 접속 스냅샷, 마케팅 통계 집계)

#### 실시간 기능
- **채팅**: Broadcast 기반 메시지 전파
- **Q&A**: 질문/답변 실시간 업데이트
- **Presence**: 참여자 실시간 추적
- **Realtime 구독**: 채널 기반 이벤트 구독

#### 배치 작업
- **웨비나 접속 스냅샷**: 1분마다 실행
- **마케팅 통계 집계**: 5분마다 실행

### 1.3 현재 로깅 상태

**문제점:**
- `console.log/error/warn`만 사용 (Vercel 로그에만 기록)
- 구조화된 로그가 일부만 존재 (JSON.stringify)
- 에러 추적이 체계적이지 않음
- 성능 메트릭 수집 없음
- 비즈니스 이벤트 로그가 분산됨

**현재 구조화 로그 예시:**
```typescript
// Visit 추적 실패 로그
console.error('[VisitTrackFail]', JSON.stringify({
  campaignId,
  sessionId,
  reason: 'DB_INSERT_FAILED',
  error: insertError.message,
  timestamp: new Date().toISOString()
}))

// Entry 추적 실패 로그
console.error('[EntryTrackFail]', JSON.stringify({
  campaignId: 'N/A',
  sessionId: 'N/A',
  reason: 'API_ERROR',
  error: error.message,
  timestamp: new Date().toISOString()
}))
```

---

## 2. 수집해야 할 로그 카테고리

### 2.1 API 요청/응답 로그 (P0 - 최우선)

**목적**: 모든 API 호출 추적, 성능 모니터링, 에러 패턴 분석

**수집 항목:**
- **요청 정보**
  - HTTP 메서드, 경로, 쿼리 파라미터
  - 요청 헤더 (User-Agent, Referer, Authorization)
  - 요청 본문 크기
  - 요청 시간 (timestamp)
- **응답 정보**
  - HTTP 상태 코드
  - 응답 시간 (latency)
  - 응답 본문 크기
  - 에러 메시지 (실패 시)
- **컨텍스트**
  - 사용자 ID (인증된 경우)
  - 클라이언트 ID / 에이전시 ID
  - 세션 ID
  - 요청 ID (추적용)

**예시:**
```typescript
{
  "type": "api_request",
  "method": "POST",
  "path": "/api/public/event-survey/3a88682e-6fab-463c-8328-6b403c8c5c7a/register",
  "status": 200,
  "latency_ms": 245,
  "user_id": "3773658c-c849-472e-bfa8-e6bb360f074d",
  "client_id": "55317496-d3d6-4e65-81d3-405892de78ab",
  "session_id": "abc123",
  "request_id": "req_xyz",
  "timestamp": "2026-02-04T11:17:16.000Z"
}
```

### 2.2 에러 로그 (P0 - 최우선)

**목적**: 예외 상황 추적, 에러 패턴 분석, 알림

**수집 항목:**
- **에러 정보**
  - 에러 타입 (Error, TypeError, DatabaseError 등)
  - 에러 메시지
  - 스택 트레이스
  - 에러 코드 (DB 에러 코드 등)
- **컨텍스트**
  - 발생 위치 (파일명, 라인 번호, 함수명)
  - 요청 정보 (API 경로, 사용자 ID)
  - 환경 정보 (NODE_ENV, 배포 환경)
- **심각도**
  - 레벨: error, warning, critical
  - 사용자 영향도 (high, medium, low)

**예시:**
```typescript
{
  "type": "error",
  "level": "error",
  "message": "Failed to allocate survey number",
  "error_code": "SURVEY_NO_ALLOCATION_FAILED",
  "stack": "Error: Failed to allocate...\n  at route.ts:825",
  "context": {
    "api_path": "/api/public/event-survey/.../register",
    "campaign_id": "3a88682e-6fab-463c-8328-6b403c8c5c7a",
    "user_id": "3773658c-c849-472e-bfa8-e6bb360f074d"
  },
  "timestamp": "2026-02-04T11:17:16.000Z"
}
```

### 2.3 비즈니스 이벤트 로그 (P0 - 최우선)

**목적**: 핵심 비즈니스 로직 추적, 사용자 행동 분석

**수집 항목:**
- **등록/참여 이벤트**
  - 설문 등록 (`survey_registered`)
  - 설문 제출 (`survey_submitted`)
  - 웨비나 등록 (`webinar_registered`)
  - 웨비나 입장 (`webinar_entered`)
- **이메일 이벤트**
  - 이메일 발송 (`email_sent`)
  - 이메일 발송 실패 (`email_failed`)
  - 이메일 캠페인 생성 (`email_campaign_created`)
- **실시간 상호작용**
  - 메시지 전송 (`message_sent`)
  - 질문 등록 (`question_asked`)
  - 폼 제출 (`form_submitted`)
- **관리자 액션**
  - 웨비나 생성 (`webinar_created`)
  - 캠페인 생성 (`campaign_created`)
  - 권한 변경 (`permission_changed`)

**예시:**
```typescript
{
  "type": "business_event",
  "event": "survey_registered",
  "campaign_id": "3a88682e-6fab-463c-8328-6b403c8c5c7a",
  "survey_no": 194,
  "user_email": "user@example.com",
  "utm_source": "email",
  "utm_campaign": "reminder_d1",
  "timestamp": "2026-02-04T11:17:16.000Z"
}
```

### 2.4 데이터베이스 작업 로그 (P1 - 높음)

**목적**: DB 쿼리 성능 추적, 실패 원인 분석

**수집 항목:**
- **쿼리 정보**
  - 쿼리 타입 (SELECT, INSERT, UPDATE, DELETE)
  - 테이블명
  - 실행 시간 (duration)
  - 영향받은 행 수
- **에러 정보**
  - DB 에러 코드 (PostgreSQL 에러 코드)
  - 에러 메시지
  - 쿼리 파라미터 (민감 정보 제외)
- **컨텍스트**
  - API 경로
  - 사용자 ID

**예시:**
```typescript
{
  "type": "db_query",
  "operation": "INSERT",
  "table": "event_survey_entries",
  "duration_ms": 12,
  "rows_affected": 1,
  "api_path": "/api/public/event-survey/.../register",
  "timestamp": "2026-02-04T11:17:16.000Z"
}
```

### 2.5 실시간 연결 상태 로그 (P1 - 높음)

**목적**: Realtime 연결 안정성 모니터링, 재연결 패턴 분석

**수집 항목:**
- **연결 이벤트**
  - 채널 구독 성공 (`realtime_subscribed`)
  - 채널 구독 실패 (`realtime_subscribe_failed`)
  - 채널 연결 종료 (`realtime_closed`)
  - 재연결 시도 (`realtime_reconnect`)
- **상태 정보**
  - 채널명
  - 웨비나 ID
  - 연결 상태 (SUBSCRIBED, CLOSED, TIMED_OUT, CHANNEL_ERROR)
  - 재연결 시도 횟수
- **에러 정보**
  - 에러 메시지
  - 에러 코드

**예시:**
```typescript
{
  "type": "realtime_event",
  "event": "realtime_subscribe_failed",
  "channel": "webinar:abc123:messages",
  "webinar_id": "abc123",
  "status": "CHANNEL_ERROR",
  "reconnect_tries": 2,
  "error": "Connection timeout",
  "timestamp": "2026-02-04T11:17:16.000Z"
}
```

### 2.6 이메일 발송 로그 (P1 - 높음)

**목적**: 이메일 발송 성공/실패 추적, 발송 품질 모니터링

**수집 항목:**
- **발송 정보**
  - 캠페인 ID
  - 수신자 이메일 (해시화 또는 마스킹)
  - 발송 상태 (sent, failed, bounced)
  - Resend 메시지 ID
- **에러 정보**
  - 실패 사유
  - 에러 코드
- **성능 정보**
  - 발송 소요 시간
  - 배치 크기

**예시:**
```typescript
{
  "type": "email_event",
  "event": "email_sent",
  "campaign_id": "campaign_123",
  "recipient_email_hash": "sha256_hash",
  "status": "sent",
  "resend_message_id": "re_abc123",
  "latency_ms": 150,
  "timestamp": "2026-02-04T11:17:16.000Z"
}
```

### 2.7 크론 작업 실행 로그 (P1 - 높음)

**목적**: 배치 작업 성공/실패 추적, 실행 시간 모니터링

**수집 항목:**
- **실행 정보**
  - 작업명 (`webinar-access-snapshot`, `aggregate-marketing-stats`)
  - 실행 시간 (duration)
  - 처리된 레코드 수
  - 성공/실패 상태
- **에러 정보**
  - 에러 메시지
  - 실패한 단계

**예시:**
```typescript
{
  "type": "cron_job",
  "job_name": "aggregate-marketing-stats",
  "status": "success",
  "duration_ms": 1234,
  "records_processed": 150,
  "timestamp": "2026-02-04T11:17:16.000Z"
}
```

### 2.8 AI API 호출 로그 (P2 - 중간)

**목적**: Gemini API 사용량 추적, 비용 모니터링, 에러 분석

**수집 항목:**
- **호출 정보**
  - API 엔드포인트
  - 요청 토큰 수 (input tokens)
  - 응답 토큰 수 (output tokens)
  - 실행 시간
- **에러 정보**
  - 에러 타입 (rate_limit, api_error 등)
  - 에러 메시지
  - 재시도 횟수

**예시:**
```typescript
{
  "type": "ai_api_call",
  "provider": "gemini",
  "model": "gemini-1.5-pro",
  "input_tokens": 1500,
  "output_tokens": 800,
  "duration_ms": 2340,
  "cost_estimate": 0.015,
  "timestamp": "2026-02-04T11:17:16.000Z"
}
```

### 2.9 성능 메트릭 (P2 - 중간)

**목적**: 시스템 성능 모니터링, 병목 지점 식별

**수집 항목:**
- **API 성능**
  - 응답 시간 분포 (p50, p95, p99)
  - 처리량 (requests per second)
- **데이터베이스 성능**
  - 쿼리 실행 시간
  - 연결 풀 사용률
- **외부 API 성능**
  - Resend API 응답 시간
  - Supabase API 응답 시간
  - Gemini API 응답 시간

---

## 3. 추천 외부 로깅 도구

### 3.1 Sentry (에러 추적) ⭐ 추천

**용도**: 에러 추적 및 알림

**장점:**
- Next.js 공식 통합 지원
- 자동 스택 트레이스 수집
- 에러 그룹핑 및 알림
- 소스맵 지원 (프로덕션 디버깅)
- 무료 플랜 제공 (5,000 이벤트/월)

**수집 항목:**
- 모든 예외 (try-catch, unhandled errors)
- API 에러 (4xx, 5xx)
- 클라이언트 사이드 에러 (React Error Boundary)

**통합 방법:**
```typescript
// lib/logging/sentry.ts
import * as Sentry from "@sentry/nextjs"

Sentry.init({
  dsn: process.env.NEXT_PUBLIC_SENTRY_DSN,
  environment: process.env.NODE_ENV,
  tracesSampleRate: 0.1, // 10% 샘플링
})
```

### 3.2 Logtail (구조화 로그) ⭐ 추천

**용도**: 구조화된 로그 집계 및 검색

**장점:**
- Vercel 공식 통합
- 구조화된 로그 검색 (JSON 기반)
- 실시간 로그 스트리밍
- 로그 보관 기간 설정 가능
- 무료 플랜 제공 (1GB/월)

**수집 항목:**
- API 요청/응답 로그
- 비즈니스 이벤트 로그
- 데이터베이스 쿼리 로그
- 크론 작업 로그

**통합 방법:**
```typescript
// lib/logging/logtail.ts
import { Logger } from '@logtail/node'

const logtail = new Logger(process.env.LOGTAIL_SOURCE_TOKEN)

export function logEvent(type: string, data: Record<string, any>) {
  logtail.log(type, {
    ...data,
    timestamp: new Date().toISOString(),
    environment: process.env.NODE_ENV,
  })
}
```

### 3.3 Vercel Analytics (성능 모니터링)

**용도**: 웹 성능 및 사용자 행동 추적

**장점:**
- Vercel 네이티브 통합
- Web Vitals 자동 수집
- 페이지뷰 추적
- 무료 제공

**수집 항목:**
- 페이지 로드 시간
- Core Web Vitals (LCP, FID, CLS)
- 사용자 세션 정보

### 3.4 Axiom (로그 분석) - 대안

**용도**: 대용량 로그 분석 및 쿼리

**장점:**
- 빠른 로그 검색 및 분석
- SQL 쿼리 지원
- 대시보드 생성 가능
- 무료 플랜 제공 (500MB/월)

---

## 4. 구현 우선순위

### Phase 1: 핵심 로그 수집 (즉시 구현)

1. **Sentry 통합** (에러 추적)
   - Next.js Sentry SDK 설치
   - 자동 에러 캡처 설정
   - 알림 설정 (Slack/이메일)

2. **Logtail 통합** (구조화 로그)
   - Logtail SDK 설치
   - API 미들웨어에서 요청/응답 로깅
   - 비즈니스 이벤트 로깅

3. **핵심 비즈니스 이벤트 로깅**
   - 설문 등록/제출
   - 웨비나 등록/입장
   - 이메일 발송 성공/실패
   - 크론 작업 실행

### Phase 2: 확장 로그 수집 (1-2주 내)

4. **데이터베이스 쿼리 로깅**
   - 느린 쿼리 추적 (100ms 이상)
   - 에러 쿼리 로깅

5. **실시간 연결 상태 로깅**
   - Realtime 구독 성공/실패
   - 재연결 패턴 추적

6. **성능 메트릭 수집**
   - API 응답 시간 분포
   - 외부 API 호출 시간

### Phase 3: 고급 분석 (필요 시)

7. **AI API 호출 로깅**
   - 토큰 사용량 추적
   - 비용 모니터링

8. **사용자 행동 추적**
   - 페이지뷰
   - 클릭 이벤트
   - 전환 퍼널 분석

---

## 5. 로깅 미들웨어 설계

### 5.1 API 요청 로깅 미들웨어

```typescript
// lib/logging/api-logger.ts
import { NextRequest, NextResponse } from 'next/server'
import { logtail } from './logtail'
import * as Sentry from '@sentry/nextjs'

export async function logApiRequest(
  req: NextRequest,
  res: NextResponse,
  duration: number
) {
  const logData = {
    type: 'api_request',
    method: req.method,
    path: req.nextUrl.pathname,
    status: res.status,
    latency_ms: duration,
    user_id: req.headers.get('x-user-id'),
    session_id: req.headers.get('x-session-id'),
    user_agent: req.headers.get('user-agent'),
    timestamp: new Date().toISOString(),
  }

  // Logtail에 로그 전송
  await logtail.log('api_request', logData)

  // 에러인 경우 Sentry에도 전송
  if (res.status >= 400) {
    Sentry.captureMessage(`API Error: ${req.method} ${req.nextUrl.pathname}`, {
      level: res.status >= 500 ? 'error' : 'warning',
      extra: logData,
    })
  }
}
```

### 5.2 비즈니스 이벤트 로깅 유틸리티

```typescript
// lib/logging/business-logger.ts
import { logtail } from './logtail'

export async function logBusinessEvent(
  event: string,
  data: Record<string, any>
) {
  await logtail.log('business_event', {
    type: 'business_event',
    event,
    ...data,
    timestamp: new Date().toISOString(),
  })
}

// 사용 예시
await logBusinessEvent('survey_registered', {
  campaign_id: campaignId,
  survey_no: surveyNo,
  user_email_hash: hashEmail(email),
  utm_source: utmSource,
})
```

### 5.3 에러 로깅 유틸리티

```typescript
// lib/logging/error-logger.ts
import * as Sentry from '@sentry/nextjs'
import { logtail } from './logtail'

export function logError(
  error: Error,
  context: Record<string, any> = {}
) {
  // Sentry에 에러 전송
  Sentry.captureException(error, {
    extra: context,
  })

  // Logtail에도 로그 전송
  logtail.error('error_occurred', {
    type: 'error',
    message: error.message,
    stack: error.stack,
    ...context,
    timestamp: new Date().toISOString(),
  })
}
```

---

## 6. 로그 보관 정책

### 6.1 보관 기간
- **에러 로그**: 90일
- **API 요청 로그**: 30일
- **비즈니스 이벤트 로그**: 90일
- **성능 메트릭**: 30일

### 6.2 민감 정보 처리
- **이메일**: 해시화 또는 마스킹 (`user@example.com` → `u***@example.com`)
- **전화번호**: 마지막 4자리만 표시
- **비밀번호**: 절대 로깅하지 않음
- **토큰/키**: 마스킹 처리

---

## 7. 알림 설정

### 7.1 Sentry 알림
- **Critical 에러**: 즉시 Slack 알림
- **에러 빈도 증가**: 10분 내 10건 이상 발생 시 알림
- **새로운 에러 타입**: 첫 발생 시 알림

### 7.2 Logtail 알림
- **크론 작업 실패**: 즉시 알림
- **이메일 발송 실패율 증가**: 5분 내 실패율 10% 이상 시 알림
- **API 에러율 증가**: 5분 내 에러율 5% 이상 시 알림

---

## 8. 대시보드 구성

### 8.1 에러 대시보드 (Sentry)
- 에러 발생 추이
- 에러 타입별 분포
- 영향받은 사용자 수
- 최근 에러 목록

### 8.2 운영 대시보드 (Logtail)
- API 요청량 추이
- 평균 응답 시간
- 비즈니스 이벤트 통계
- 크론 작업 실행 상태
- 이메일 발송 통계

### 8.3 성능 대시보드 (Vercel Analytics)
- 페이지 로드 시간
- Core Web Vitals
- 사용자 세션 통계

---

## 9. 구현 체크리스트

### Phase 1 (즉시)
- [ ] Sentry SDK 설치 및 설정
- [ ] Logtail SDK 설치 및 설정
- [ ] API 미들웨어에서 요청/응답 로깅
- [ ] 핵심 비즈니스 이벤트 로깅 함수 생성
- [ ] 에러 로깅 유틸리티 생성
- [ ] 설문 등록/제출 로깅 추가
- [ ] 이메일 발송 로깅 추가
- [ ] 크론 작업 로깅 추가

### Phase 2 (1-2주 내)
- [ ] 데이터베이스 쿼리 로깅 추가
- [ ] 실시간 연결 상태 로깅 추가
- [ ] 성능 메트릭 수집 추가
- [ ] 알림 설정 (Slack/이메일)

### Phase 3 (필요 시)
- [ ] AI API 호출 로깅 추가
- [ ] 사용자 행동 추적 추가
- [ ] 대시보드 구성

---

## 10. 예상 비용

### 무료 플랜 기준
- **Sentry**: 5,000 이벤트/월 (무료)
- **Logtail**: 1GB/월 (무료)
- **Vercel Analytics**: 무제한 (무료)

### 예상 사용량
- API 요청: 약 100,000건/월 → Logtail 500MB
- 에러: 약 1,000건/월 → Sentry 1,000 이벤트
- 비즈니스 이벤트: 약 50,000건/월 → Logtail 250MB

**총 예상 비용**: 무료 플랜으로 충분

---

## 11. 다음 단계

1. **Sentry 통합부터 시작** (에러 추적이 가장 중요)
2. **Logtail 통합** (구조화 로그 수집)
3. **핵심 비즈니스 이벤트 로깅 추가** (설문 등록, 이메일 발송 등)
4. **알림 설정** (Slack/이메일)
5. **대시보드 구성** (에러, 운영 통계)

이 계획으로 진행하면 문제 발생 시 빠르게 원인을 파악하고 분석할 수 있습니다.
