아래는 **`사이드바_제거_및_상단메뉴_전환_명세서.md` 기준**으로, "사이드바 제거"를 실제로 안전하게 끝내기 위해 **Cursor Agent에게 그대로 던질 수 있는 검토/지침**이야. (코드 지시가 아니라 **판단 기준 + 리스크 차단 + DoD** 중심)

참고 명세서: 

---

## 목적

* 관리자 영역에서 **복잡한 트리형 사이드바(Super→Agency→Client→Webinar)** 때문에 탐색이 어려운 문제를 해결하고, **사이드바를 완전 제거 + 상단 네비게이션으로 전환**한다. 
* 데스크톱(좌측 고정) / 모바일(하단 고정) **이중 네비게이션 구조를 제거**하고, **관리자 UI와 방문자 UI의 혼재로 인한 혼란을 줄이는 것**이 목표다. 

---

## 전제 조건

### 이미 존재하는 것 (건드리기 전 "현황")

* 사이드바 관련 주요 컴포넌트/결정 지점:

  * `components/layout/Sidebar.tsx` (데스크톱 좌측 + 모바일 하단 고정)
  * `components/layout/SidebarTree.tsx` (트리 네비게이션)
  * `components/layout/LayoutWrapper.tsx` (공개/관리 페이지에 따라 사이드바 표시 여부 결정)
  * `app/(super)/super/_components/SuperSidebar.tsx` (슈퍼 전용 사이드바) 
* 레이아웃은 현재 "사이드바 폭만큼 main 마진" 구조를 기반으로 동작하고 있음. 

**실제 코드 확인 결과**:
```typescript
// LayoutWrapper.tsx (현재)
<main 
  className="ml-0 lg:ml-64 w-full lg:w-[calc(100vw-16rem)] lg:max-w-[calc(100vw-16rem)]"
>
```
* 위의 `lg:ml-64` (사이드바 너비만큼 왼쪽 마진)와 `lg:w-[calc(100vw-16rem)]` (사이드바 너비 제외한 폭 계산)을 **반드시 제거**해야 함.

### 바꾸면 안 되는 것 (프로젝트 절대 원칙)

* **URL 구조 변경 없음 / 기존 링크(북마크·외부 링크) 호환 유지**가 명세에 명시되어 있음. 
* 권한/역할 체계(슈퍼/에이전시/클라이언트/참여자) 자체를 바꾸지 말고, 메뉴는 **기존 권한 시스템과 RLS 정책과 일치**해야 함. 

### 특히 주의: 최근 레이아웃 수정 이력과 충돌 가능

* 이미 LayoutWrapper는 "사이드바 폭 고려(main 폭 calc)" 같은 형태로 개선된 이력이 있음 → **사이드바 제거 시 이 계산/마진 로직을 반드시 제거/재정렬**해야 함. 

---

## 결정 포인트

### 1) "어디에 TopNav를 띄우고, 어디에는 절대 띄우지 않을 것인가"

* 명세가 정의한 "사이드바 숨김(=공개 페이지)" 범위:

  * `/`, `/login`, `/signup`, `/privacy`, `/unsubscribe`
  * `/webinar/[id]`, `/webinar/[id]/live`
  * `/event/[.path]` (설문조사 공개) 
* 그런데 예시 코드의 isPublicPage 조건은 `/`, `/login`, `/signup`, `/webinar/*(console/registrants/stats 제외)` 정도만 포함되어 있음 → **`/privacy`, `/unsubscribe`, `/event/*` 누락 가능성**이 큼. 

**실제 코드 확인 결과**:
```typescript
// LayoutWrapper.tsx (현재 코드)
const isPublicPage = pathname === '/' || 
  pathname.startsWith('/login') || 
  pathname.startsWith('/signup') || 
  pathname.startsWith('/privacy')

const isSurveyPublicPage = pathname.startsWith('/event/')
const isUnsubscribePage = pathname.startsWith('/unsubscribe')
```
* 실제 코드는 이미 `/privacy`, `/unsubscribe`, `/event/*`를 처리하고 있으나, 명세서 예시 코드는 간소화 버전임.
* TopNav 구현 시 **명세서의 전체 목록을 반영**해야 함.

✅ 결정: **"공개 페이지 판별"을 명세의 목록과 1:1로 일치**시키는 기준을 먼저 확정해야 함. (누락되면 방문자 화면에 관리자 TopNav가 뜨는 사고 가능)

**권장 구현**:
```typescript
const isPublicPage = 
  pathname === '/' || 
  pathname.startsWith('/login') || 
  pathname.startsWith('/signup') || 
  pathname.startsWith('/privacy') ||
  pathname.startsWith('/unsubscribe') ||
  pathname.startsWith('/event/') ||
  (pathname.startsWith('/webinar/') && 
   !pathname.includes('/console') && 
   !pathname.includes('/registrants') && 
   !pathname.includes('/stats'))
```

---

### 2) TopNav에서 "역할 + 현재 컨텍스트(agencyId/clientId/webinarId)"를 어떻게 얻을 것인가

* 역할별 메뉴가 각각 **`/agency/[agencyId]/*`, `/client/[clientId]/*`**처럼 파라미터 의존적이다. 
* 웨비나 관리 페이지는 `/webinar/[id]/console|registrants|stats`로 **clientId가 URL에 직접 없음** → "← 클라이언트로 돌아가기" 링크를 만들려면 **webinar→client 매핑 데이터가 필요**하다. 

**실제 코드 확인 결과**:
* 현재 `ConsoleView.tsx`에서도 하드코딩된 링크 사용:
  ```typescript
  <Link href={`/client/${webinar.client_id}/dashboard`}>
    ← 메인 대시보드로
  </Link>
  ```
* 웨비나 관리 페이지 판별 로직은 URL 인코딩까지 고려한 안전한 방식 사용:
  ```typescript
  const isConsolePage = pathname.endsWith('/console') || decodedPathname.endsWith('/console')
  const isRegistrantsPage = pathname.endsWith('/registrants') || decodedPathname.endsWith('/registrants')
  const isStatsPage = pathname.endsWith('/stats') || decodedPathname.endsWith('/stats')
  ```

✅ 결정:

* 컨텍스트를 "클라이언트 렌더(useEffect)에서 매번 조회"로 갈지 vs "서버에서 1회 주입 + 클라이언트는 표시만"으로 갈지.
* 운영콘솔(라이브 운영 화면) 안정성 관점에서는 **상단 메뉴 때문에 추가 네트워크 호출/깜빡임/지연이 발생하지 않도록** "서버 주입 + 캐시/공유" 쪽이 안전함(원칙상).

**권장 구현**:
* TopNav/WebinarHeader 컴포넌트에서 webinar 데이터를 props로 받아 `client_id` 활용
* 또는 레이아웃 레벨에서 서버 컴포넌트로 webinar 정보 조회 후 클라이언트 컴포넌트에 전달

---

### 3) 마이그레이션 방식 (점진 vs 일괄)

* 명세는 **점진적 전환(토글 가능하게 병행 운영) 권장**을 명시하고 있음. 

✅ 결정:

* 운영 중(실제 고객/라이브)이 있다면 **점진적(Feature Flag) 전환을 기본**으로 잡는 게 리스크가 낮다.
* 단, "하드코딩 금지" 원칙상 토글도 "임시 상수 박기"가 아니라 **구성 가능한 플래그**로 설계할 것.

**Feature Flag 구현 방식**:
```typescript
// 환경 변수 기반 플래그 (권장)
const USE_TOP_NAV = process.env.NEXT_PUBLIC_USE_TOP_NAV === 'true'

// LayoutWrapper.tsx에서 사용
if (USE_TOP_NAV) {
  return <TopNav /> + <main>...</main>
} else {
  return <Sidebar /> + <main>...</main>
}
```

**전환 단계**:
1. 초기: 사이드바와 TopNav 병행 표시 (토글 가능)
2. 안정화: 사용자 피드백 수집 및 버그 수정
3. 완전 전환: 사이드바 완전 제거

---

### 4) 모바일 네비게이션 패턴

* 명세는 모바일에서 햄버거 + 드로어 구조를 제안. 

✅ 결정:

* 드로어가 기존 콘솔 UI(예: 모달, 바텀시트, 채팅 입력 등)와 **z-index/포커스 충돌**이 없는지 기준 수립 필요.
* 접근성(ESC 닫기, 포커스 트랩, aria)까지 포함할지 범위를 확정.

**z-index 충돌 방지 전략**:
* 실제 코드에서 사이드바는 `z-50` 사용, 모바일 하단 메뉴도 `z-50` 사용
* 권장 z-index 계층:
  * TopNav: `z-50` (현재 사이드바와 동일)
  * 모바일 드로어: `z-40` (TopNav보다 낮게)
  * 콘솔 모달/채팅: `z-30` 이하로 유지

**접근성 구현 가이드**:
```typescript
// 모바일 드로어 접근성 예시
<nav 
  aria-label="메인 네비게이션"
  aria-hidden={!mobileMenuOpen}
  role="dialog"
  aria-modal="true"
>
  <button 
    aria-label="메뉴 닫기"
    aria-expanded={mobileMenuOpen}
    onClick={() => setMobileMenuOpen(false)}
  >
    닫기
  </button>
  {/* ESC 키로 닫기 */}
  {/* 포커스 트랩 구현 */}
</nav>
```

---

## 선택 기준

Cursor Agent가 선택할 때 아래 기준을 "통과"해야 함:

1. **링크 호환성**: URL 구조/기존 링크는 그대로 살아야 한다. 

2. **권한/멀티테넌시**:

   * 메뉴 표시/숨김이 기존 권한/RLS와 충돌하면 안 된다. 
   * "UI에서 숨김"은 보조일 뿐, 실제 접근 통제는 기존 가드/정책을 그대로 둬야 함.

3. **라이브 안정성**:

   * 운영콘솔/통계 등 "현장 운영 화면"에서 TopNav 때문에 추가 지연/재집계/불필요 fetch가 발생하면 안 됨.

4. **일관성**: 데스크톱/모바일에서 네비게이션이 하나의 정신 모델(상단 중심)로 동작해야 함. 

5. **접근성**: 키보드 네비게이션, 스크린리더, ARIA 고려. 

---

## 구현 가이드 (기준 충족 방식)

### Phase 0: "노출 범위(공개/관리)" 판별 기준 확정

* 명세의 "사이드바 숨김 페이지 목록"을 그대로 "TopNav 숨김 목록"으로 가져가야 함. 
* 예시 코드 기반으로 진행한다면 **누락(/privacy, /unsubscribe, /event/*)**이 생기기 쉬우니, 최소한 "명세 목록과의 diff 체크"를 작업 시작 전에 끝내는 것을 완료 조건에 포함.

---

### Phase 1: TopNav 골격 생성 (명세 범위 준수)

* 명세가 제안하는 컴포넌트 분리는 타당:

  * `components/layout/TopNav.tsx`
  * `TopNavMenu.tsx`, `UserMenu.tsx`, `MobileMenu.tsx` 

**검토 포인트(중요)**

* 메뉴 정의는 "컴포넌트 내부 if/else 난사"가 아니라, **역할/컨텍스트 기반 구성 데이터(설정 가능한 구조)**로 분리할 것.

  * 이유: 향후 메뉴 추가/권한 확장 시 하드코딩 지뢰밭 방지.
* TopNav가 사용자/조직 정보를 "클라이언트에서 매번 가져오는 구조"면 **페이지 전환 때마다 깜빡임/중복 호출** 가능 → 운영콘솔 안정성 측면에서 불리.

  * 기준: **TopNav 렌더에 필수인 최소 정보는 서버에서 1회 주입**(또는 레이아웃 레벨 공유)하고, 클라이언트는 UI 인터랙션(드로어 토글)만 담당하는 형태가 안정적.

---

### Phase 2: LayoutWrapper 수정 (사이드바 레이아웃 잔재 제거)

* 명세는 LayoutWrapper에 TopNav를 붙이고 main에 상단 패딩을 주는 방향을 제시. 

**필수 체크**

* 과거 개선 이력에서 main 폭을 `calc(100vw - sidebarWidth)`로 계산하던 부분이 있었음 → **사이드바 제거 시 100% 폭 기준으로 재정렬** 필요. 
* 기존 `ml-0 lg:ml-64` 같은 "사이드바 전제 마진"이 남으면 레이아웃이 망가짐. 

---

### Phase 3: 역할별 메뉴 구성 (명세 구조는 OK, 단 "컨텍스트"가 핵심)

* 슈퍼/에이전시/클라이언트 메뉴 구조는 명세에 정의됨. 

**필수 기준**

* `agencyId`, `clientId`가 필요한 링크는 "현재 페이지 컨텍스트"에서 안정적으로 추출되어야 함.
* 컨텍스트를 못 얻으면:

  * (1) 메뉴를 숨기거나
  * (2) 리스트 페이지로 보내거나
  * (3) 스위처/브레드크럼을 제공하는
    **명확한 폴백 정책**이 있어야 함. (침묵 실패 금지)

---

### Phase 4: 웨비나 관리 페이지 서브 메뉴(헤더) 적용

* 웨비나 관리 페이지(`/webinar/[id]/console|registrants|stats`)에 서브 메뉴 헤더를 상단에 표시한다는 요구가 있음. 

**중요 리스크**

* 이 헤더는 운영콘솔 UI의 세로 공간을 추가로 먹음 → 콘솔 화면(탭, 채팅/질문 영역) 레이아웃이 깨지지 않게 "높이 계산" 기준을 명확히 해야 함.
* "← 클라이언트로 돌아가기" 링크는 webinar→client 정보가 없으면 만들 수 없음 → **데이터 확보 전략**이 Phase 4 전에 확정돼야 함.

**높이 계산 기준**:
* 현재 콘솔 페이지는 자체 헤더를 가지고 있음 (`ConsoleView.tsx`)
* TopNav(64px) + WebinarHeader(추정 80px) = 총 144px 정도의 상단 공간 필요
* 콘텐츠 영역에 `pt-[144px]` 또는 동적 계산 필요:
  ```typescript
  // 웨비나 관리 페이지 레이아웃
  <main className="pt-[144px] min-h-screen">
    {/* TopNav(64px) + WebinarHeader(80px) = 144px */}
    {children}
  </main>
  ```
* 기존 콘솔 헤더와 WebinarHeader 통합 계획 수립 필요

---

### Phase 5: 기존 사이드바 코드 정리 (삭제/주석 처리의 순서가 중요)

* 명세 체크리스트는 Sidebar 관련 컴포넌트 정리를 포함. 

**가이드**

* "삭제"는 마지막 단계.

  * 먼저: **사이드바 비노출/미사용 상태로 전환** → 전 페이지 QA 통과 → 그 다음 제거.
* `SidebarContext`는 "사용하지 않는 경우"에만 제거라고 되어 있음 → 실제 레퍼런스가 남아있으면 제거 시 연쇄 오류가 나므로, **사용처 0개 확인이 DoD에 포함**되어야 함. 

**슈퍼 관리자 페이지 처리**:
* `app/(super)/super/_components/SuperSidebar.tsx`는 슈퍼 관리자 전용 사이드바
* `app/(super)/super/layout.tsx`에서 SuperSidebar 제거 필요
* TopNav에서 역할 감지 후 슈퍼 관리자 메뉴 표시
* 슈퍼 관리자도 TopNav로 전환하되, 메뉴 구조만 다르게 구성

---

## 리스크 체크

### 성능

* TopNav가 사용자/조직/컨텍스트를 매 페이지 클라이언트 fetch로 해결하면:

  * 네비게이션마다 요청 증가
  * 메뉴 깜빡임
  * 운영콘솔에서 체감 렉 가능
    → **"TopNav 표시가 시스템 부하를 만들지 않는다"**를 통과 기준으로.

### 권한/멀티테넌시

* 메뉴는 "편의상 노출"일 뿐, **권한 밖 링크가 노출되면 운영상 사고**로 이어짐.
* 특히 `/webinar/*`는 고객이 많이 쓰는 경로이므로, "관리자 전용 서브 메뉴"가 방문자 페이지에 노출되지 않는지(공개/관리 판별) 최우선. 

### 데이터 정합성/UX

* 컨텍스트(agencyId/clientId) 미확정 상태에서 링크를 생성하면 "잘못된 테넌트로 이동" 같은 치명적 UX 오류 가능 → 폴백 정책 필수.

### 접근성

* 명세에 접근성 요구가 명시되어 있으므로(키보드/스크린리더/ARIA), 모바일 드로어는 최소한:

  * 열림/닫힘 상태가 스크린리더에 전달 (`aria-expanded`, `aria-hidden`)
  * 키보드 포커스 이동이 합리적 (포커스 트랩, ESC 키 닫기)
  * ARIA 레이블 추가 (`aria-label`, `role` 속성)
    을 만족해야 함.

**구현 체크리스트**:
- [ ] 햄버거 메뉴 버튼에 `aria-label="메뉴 열기"`, `aria-expanded={mobileMenuOpen}` 추가
- [ ] 드로어에 `aria-label="메인 네비게이션"`, `role="dialog"`, `aria-modal="true"` 추가
- [ ] 드로어 열림 시 포커스를 첫 번째 메뉴 항목으로 이동
- [ ] ESC 키로 드로어 닫기 구현
- [ ] 드로어 열림 시 배경 요소에 `aria-hidden="true"` 설정 

---

## 완료 조건 (DoD)

아래가 충족되면 "사이드바 제거 완료"로 판정:

1. **사이드바 컴포넌트가 UI에서 완전히 사라짐**

* 데스크톱 좌측, 모바일 하단 메뉴 포함 "이중 구조" 잔재 0. 

2. **TopNav 노출 범위가 명세와 100% 일치**

* 공개 페이지(/, /login, /signup, /privacy, /unsubscribe, /event/*, /webinar/* 시청 계열)에는 TopNav가 절대 뜨지 않음. 

3. **역할별 메뉴가 정확**

* 슈퍼/에이전시/클라이언트 별로 명세된 메뉴가 노출되며, 권한 밖 항목은 노출되지 않음. 

4. **웨비나 관리 페이지 서브 메뉴 동작**

* `/webinar/[id]/console|registrants|stats`에서 전용 헤더/서브 메뉴가 표시되고 탭 활성화가 정상. 

5. **레이아웃 잔재 0**

* `ml-0 lg:ml-64`, `calc(100vw - sidebarWidth)` 등 사이드바 전제 레이아웃 코드가 남지 않아 "콘텐츠 폭/정렬"이 정상. 

6. **테스트 체크리스트 통과**

* 데스크톱/모바일, 역할별 메뉴, 권한 필터링, 네비게이션 동작 확인 완료. 

7. **슈퍼 관리자 페이지 전환 완료**

* `app/(super)/super/layout.tsx`에서 SuperSidebar 제거
* 슈퍼 관리자 메뉴가 TopNav에서 정상 표시

8. **SidebarContext 사용처 0개 확인**

* `SidebarContext`의 모든 레퍼런스 제거 확인
* 제거 시 연쇄 오류 방지

---

## 구현 전 체크리스트

작업 시작 전 아래 항목을 확인:

- [ ] LayoutWrapper.tsx의 공개 페이지 판별 로직을 명세서 목록과 1:1 대조
- [ ] main 태그의 사이드바 관련 클래스(`ml-64`, `calc(100vw-16rem)`) 제거 확인
- [ ] SuperSidebar 제거 계획 수립
- [ ] 웨비나 관리 페이지의 기존 헤더와 WebinarHeader 통합 계획 수립
- [ ] z-index 충돌 방지 전략 수립
- [ ] Feature Flag 구현 방식 확정
- [ ] 접근성 구현 가이드 확인

---

## 실제 리그레션 체크 시나리오

아래 시나리오를 단계별로 테스트하여 사이드바 제거 후 기능 정상 동작 확인:

### 시나리오 1: 슈퍼 관리자 → 클라이언트 관리 → 웨비나 콘솔
1. 슈퍼 관리자 로그인
2. `/super/dashboard` 접속 → TopNav 표시 확인
3. "클라이언트 관리" 메뉴 클릭 → `/super/clients` 이동 확인
4. 특정 클라이언트 선택 → `/client/[clientId]/dashboard` 이동 확인
5. "이벤트" 메뉴 클릭 → `/client/[clientId]/webinars` 이동 확인
6. 특정 웨비나 선택 → `/webinar/[id]/console` 진입
7. 웨비나 헤더의 "← 클라이언트로 돌아가기" 링크 클릭 → 정상 이동 확인
8. 서브 메뉴(콘솔/등록자/통계) 탭 전환 확인

### 시나리오 2: 모바일 네비게이션
1. 모바일 브라우저에서 관리자 페이지 접속
2. 햄버거 메뉴(☰) 클릭 → 드로어 열림 확인
3. 드로어에서 메뉴 항목 클릭 → 페이지 전환 및 드로어 자동 닫힘 확인
4. ESC 키로 드로어 닫기 확인
5. 드로어 열림 시 포커스가 첫 번째 메뉴 항목으로 이동하는지 확인

### 시나리오 3: 공개 페이지 TopNav 미표시 확인
1. `/` (홈) 접속 → TopNav 미표시 확인
2. `/login` 접속 → TopNav 미표시 확인
3. `/webinar/[id]` (웨비나 시청 페이지) 접속 → TopNav 미표시 확인
4. `/webinar/[id]/live` 접속 → TopNav 미표시 확인
5. `/event/[...path]` (설문조사 공개 페이지) 접속 → TopNav 미표시 확인
6. `/privacy` 접속 → TopNav 미표시 확인
7. `/unsubscribe` 접속 → TopNav 미표시 확인

### 시나리오 4: 역할별 메뉴 표시 확인
1. 슈퍼 관리자 로그인 → 슈퍼 관리자 메뉴 표시 확인
2. 에이전시 멤버 로그인 → 에이전시 메뉴 표시 확인
3. 클라이언트 멤버 로그인 → 클라이언트 메뉴 표시 확인
4. 각 역할에서 권한 밖 메뉴가 표시되지 않는지 확인

### 시나리오 5: 레이아웃 잔재 제거 확인
1. 관리자 페이지 접속
2. 개발자 도구로 main 태그 검사
3. `ml-64`, `calc(100vw-16rem)` 같은 사이드바 관련 클래스가 없는지 확인
4. 콘텐츠가 전체 너비를 사용하는지 확인
5. 모바일에서도 레이아웃이 정상인지 확인

### 시나리오 6: 웨비나 관리 페이지 레이아웃
1. `/webinar/[id]/console` 접속
2. TopNav + WebinarHeader 높이 확인 (총 144px)
3. 콘텐츠 영역이 헤더 아래 정상 표시되는지 확인
4. 탭 전환 시 레이아웃 깨짐 없는지 확인
5. 채팅/질문 영역이 정상 동작하는지 확인
