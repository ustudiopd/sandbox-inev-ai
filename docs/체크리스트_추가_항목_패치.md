# 체크리스트 추가 항목 패치

**작성일**: 2026-02-02  
**목적**: 리뷰 반영 후 체크리스트에 추가해야 할 핵심 항목만 정리

---

## 🔴 Phase 2.2 (다중 소스 복원)에 추가

```
- [ ] Cookie에서 추적 정보 읽기
+ [ ] ⚠️ Cookie의 cid가 현재 campaignId에 매칭되는지 확인 (필수)
+ [ ] ⚠️ captured_at이 허용 window 내인지 확인 (필수)
+ [ ] ⚠️ 환경변수로 허용 window 설정 (COOKIE_TRUST_WINDOW_HOURS)
+ [ ] ⚠️ 검증 실패 시 cookie 무시 + untracked_reason 기록
```

---

## 🔴 Phase 2.1 (서버 세션 관리)에 추가

```
- [ ] Signed cookie 저장 로직
+ [ ] ⚠️ Cookie 서명 방식 결정 (JWT 서명 vs 미신뢰+DB 검증)
+ [ ] ⚠️ Next.js 버전 확인
+ [ ] ⚠️ 구현 방식 결정 (Middleware vs Proxy)
+ [ ] ⚠️ Middleware 선택 시: 모듈 분리 구조 설계 (lib/tracking/middleware-tracking.ts)
+ [ ] ⚠️ 추후 마이그레이션 계획 문서화
```

---

## 🔴 Phase 1.1 (집계 API 보정)에 추가

```
- [ ] 추적 상태 메타데이터 추가 (tracking_metadata)
+ [ ] ⚠️ 추적 성공/실패 정의 명확화
+   - 성공: link_id 저장 OR utm_source 저장 OR tracking_snapshot.cid + 캠페인 매칭
+   - 실패: 위 조건 모두 실패
+ [ ] ⚠️ tracking_metadata 구조 명세
+   - tracked_count, untracked_count, tracking_success_rate
+   - untracked_reason_top (선택)
```

---

## 🔴 Phase 2.4 (Visit 추적)에 추가

```
- [ ] Visit API 호출 확인
+ [ ] ⚠️ Visit 추적 필요성 결정 (필요 vs 불필요)
+ [ ] ⚠️ 필요 시: 조건부 로깅 구현 (cid/utm이 있을 때만)
+ [ ] ⚠️ 등록 API에서 "visit 없음"이어도 추적 스냅샷 저장 확인
```

---

## 🔴 Phase 3.1 (추적 스냅샷)에 추가

```
- [ ] 추적 스냅샷 생성 로직
+ [ ] ⚠️ Referer 정제 로직 (도메인/경로만, query 제거)
+ [ ] ⚠️ User-Agent 저장 방식 결정 (full vs hash)
+ [ ] ⚠️ 보관기간 정책 문서화
+ [ ] ⚠️ 영향 범위 문서화 (event_survey_entries 쓰기/조회, 리포트 쿼리)
+ [ ] ⚠️ 롤백 계획 문서화 (컬럼 미사용 상태로 유지 가능, null-safe)
```

---

## 🔴 Phase 3.2 (모니터링)에 추가

```
- [ ] 알림 시스템
+ [ ] ⚠️ 알람 조건 정의 (대시보드보다 먼저)
+   - tracking_success_rate가 N% 미만이면 알림
+   - untracked_count가 급증하면 알림
+   - 특정 캠페인에서만 0%면 알림
+ [ ] ⚠️ 알람 임계값 설정 (환경변수)
+ [ ] ⚠️ 알람 채널 결정 (이메일/Slack 등)
```

---

## 🔴 Phase 2.3 (리다이렉트)에 추가

```
- [ ] 리다이렉트 체인 테스트
+ [ ] ⚠️ 시나리오 1: /s/[code] → event page → register API
+   - cid 보존 확인
+   - utm_* 보존 확인
+   - Cookie가 있더라도 URL이 우선 확인
+ [ ] ⚠️ 시나리오 2: UTM 없이 event page 직접 접근 → register
+   - Cookie가 "현재 캠페인과 매칭될 때만" 복원 확인
+   - 매칭 실패 시 cookie 무시 확인
```

---

## 📋 최종 결정 포인트 체크리스트 (새로 추가)

```
## 🎯 최종 결정 포인트 체크리스트

구현 전 반드시 결정해야 할 사항:

- [ ] Cookie 복원 적용 조건: 캠페인 매칭 + 시간 창 검증
- [ ] Cookie 서명 방식: 서명(JWT) vs 미신뢰+DB검증
- [ ] Middleware/Proxy: Middleware(모듈 분리) vs Proxy(처음부터)
- [ ] Visit 추적 필요성: 필요 vs 불필요
- [ ] 추적 성공률 정의: 성공/실패 조건 명확화
- [ ] Referer/UA 처리: 정제 방식 및 보관기간 정책
```

---

**사용법**: 위 항목들을 기존 체크리스트에 추가하세요.
