# 해결책.md 검토 보고서

## 📋 검토 개요

`해결책.md` 문서는 95K 호출 문제 해결을 위한 최적화 전략을 제시하고 있습니다. 현재 프로젝트 상태와 비교하여 **이미 해결된 항목**, **부분적으로 구현된 항목**, **미구현 항목**을 분류하고 우선순위를 제시합니다.

---

## ✅ 이미 해결된 항목

### 1. RLS 순환 참조 문제 해결 (5번 항목)

**현재 상태**: ✅ **완전히 해결됨**

- **구현 완료**:
  - JWT `app_metadata`에 `is_super_admin` 저장 (`scripts/seed-super-admin.ts`)
  - `lib/auth/guards.ts`에서 JWT 기반 권한 확인
  - `middleware.ts`에서 JWT 기반 슈퍼어드민 확인
  - `profiles` 테이블 RLS 정책 단순화 (마이그레이션 `024_fix_profiles_rls_recursion.sql`)
  - 클라이언트에서 `profiles` 직접 조회 제거 (JWT에서 확인)

**검증**:
- RLS 무한 재귀 오류 해결됨
- 500 Internal Server Error 해결됨
- 슈퍼어드민 대시보드 정상 작동

**결론**: 해결책의 5번 항목은 **이미 완전히 구현되어 있으며**, 추가 작업이 필요하지 않습니다.

---

## 🔄 부분적으로 구현된 항목

### 2. 폴링 최소화 (1번 항목)

**현재 상태**: ⚠️ **부분 구현**

**구현된 부분**:
- ✅ Realtime(WebSocket) 구독 구현 (`components/webinar/Chat.tsx`)
- ✅ 폴백 폴링 구현 (Realtime 실패 시)
- ✅ 지터(jitter) 적용 (±400ms)
- ✅ 자동 재연결 로직 (지수 백오프)
- ✅ 증분 폴링 지원 (`after` 파라미터)

**미구현/개선 필요**:
- ❌ 폴링 주기가 **3초**로 너무 짧음 (해결책 권장: 10-20초)
- ❌ **가시성 기반 폴링 중지** 미구현 (탭 비활성/백그라운드 시)
- ❌ **온라인 이벤트 기반 재개** 미구현
- ❌ **지수 백오프**가 폴링 주기에 적용되지 않음 (재연결에만 적용)

**권장 개선사항**:
```typescript
// 현재: 3초 고정
const base = 3000

// 권장: 10-20초 + 가시성 기반
const base = 15000 // 15초 기본
const jitter = 5000 - Math.random() * 10000 // ±5초

// 가시성 기반 중지
if (document.visibilityState === 'hidden' || !navigator.onLine) {
  return // 폴링 중지
}
```

**우선순위**: 🔴 **높음** (호출 수 감소에 직접적 영향)

---

### 3. 메시지 API 최적화 (2번 항목)

**현재 상태**: ⚠️ **부분 구현**

**구현된 부분**:
- ✅ Admin Supabase 사용 (RLS 우회)
- ✅ 필요한 컬럼만 선택 (`id, user_id, content, created_at, hidden, client_msg_id`)
- ✅ 커서 기반 페이지네이션
- ✅ 증분 폴링 지원

**미구현/개선 필요**:
- ❌ **Cache-Control 헤더** 미구현
- ❌ **ETag/304 응답** 미구현
- ❌ **Edge Runtime** 미적용 (현재 `nodejs`)

**권장 개선사항**:
```typescript
// app/api/webinars/[webinarId]/messages/route.ts
export const runtime = 'edge' // Edge Runtime으로 변경

// ETag 계산
const lastId = messages[messages.length - 1]?.id ?? 'none'
const etag = `"${webinarId}:${lastId}:${messages.length}"`

// 304 응답
const ifNoneMatch = req.headers.get('if-none-match')
if (ifNoneMatch === etag) {
  return new NextResponse(null, {
    status: 304,
    headers: {
      'Cache-Control': 'public, s-maxage=1, stale-while-revalidate=9',
      'ETag': etag,
    }
  })
}

// 정상 응답
return NextResponse.json({ messages }, {
  headers: {
    'Cache-Control': 'public, s-maxage=1, stale-while-revalidate=9',
    'ETag': etag,
  }
})
```

**우선순위**: 🔴 **높음** (CDN 캐시로 호출 수 대폭 감소)

---

## ❌ 미구현 항목

### 4. 멀티 탭 중복 제거 (3번 항목)

**현재 상태**: ❌ **미구현**

**문제점**:
- 동일 브라우저에서 여러 탭을 열면 각 탭마다 Realtime 구독 및 폴링이 독립적으로 실행됨
- 호출 수가 탭 수에 비례하여 증가

**권장 구현**:
- `BroadcastChannel` 또는 `SharedWorker` 사용
- 한 탭만 네트워크 연결 유지, 나머지는 로컬 브로드캐스트

**우선순위**: 🟡 **중간** (멀티 탭 사용 빈도에 따라 영향도 상이)

---

### 5. 가상 스크롤 (4번 항목)

**현재 상태**: ❌ **미구현**

**문제점**:
- 수백/수천 개의 메시지를 DOM에 모두 렌더링
- 메모리 및 렌더링 성능 저하

**권장 구현**:
- `react-virtualized` 또는 `@tanstack/react-virtual` 사용
- 화면에 보이는 메시지만 렌더링

**우선순위**: 🟡 **중간** (메시지 수가 많을 때만 영향)

---

### 6. DB 인덱스 검증 (4번 항목)

**현재 상태**: ⚠️ **확인 필요**

**확인 사항**:
- `messages(webinar_id, id)` 복합 인덱스 존재 여부
- `messages(webinar_id, created_at)` 인덱스 존재 여부
- `EXPLAIN ANALYZE`로 쿼리 계획 확인

**권장 작업**:
```sql
-- 인덱스 확인
SELECT indexname, indexdef 
FROM pg_indexes 
WHERE tablename = 'messages';

-- 필요시 인덱스 생성
CREATE INDEX IF NOT EXISTS idx_messages_webinar_id_id 
ON messages(webinar_id, id);

CREATE INDEX IF NOT EXISTS idx_messages_webinar_id_created_at 
ON messages(webinar_id, created_at DESC);
```

**우선순위**: 🟢 **낮음** (쿼리 성능이 문제가 될 때만)

---

## 📊 우선순위별 실행 계획

### 🔴 즉시 적용 (오늘)

1. **메시지 API에 Cache-Control + ETag/304 적용**
   - 예상 효과: 호출 수 **50-80% 감소**
   - 작업 시간: 1-2시간
   - 파일: `app/api/webinars/[webinarId]/messages/route.ts`

2. **폴링 주기 10-20초로 상향 + 가시성 기반 중지**
   - 예상 효과: 호출 수 **70-85% 감소** (폴링만 고려 시)
   - 작업 시간: 1시간
   - 파일: `components/webinar/Chat.tsx`

### 🟡 이번 주 내 적용

3. **Edge Runtime 적용**
   - 예상 효과: 콜드스타트 감소, 메모리 사용량 감소
   - 작업 시간: 30분
   - 파일: `app/api/webinars/[webinarId]/messages/route.ts`

4. **클라이언트 ETag 처리**
   - 예상 효과: 304 응답 시 네트워크/CPU 절감
   - 작업 시간: 1시간
   - 파일: `components/webinar/Chat.tsx`

### 🟢 선택적 적용 (트래픽 증가 시)

5. **BroadcastChannel/SharedWorker로 멀티 탭 중복 제거**
   - 예상 효과: 탭당 호출 수 감소
   - 작업 시간: 3-4시간

6. **가상 스크롤 적용**
   - 예상 효과: 렌더링 성능 향상
   - 작업 시간: 2-3시간

7. **DB 인덱스 검증/튜닝**
   - 예상 효과: 쿼리 성능 향상
   - 작업 시간: 1시간

---

## 🎯 예상 효과

### 즉시 적용 항목 (1-2번) 적용 시

**현재 상태 가정**:
- 사용자 100명, 평균 2개 탭
- 폴링 주기 3초
- Realtime 실패율 20% (폴백 폴링 활성화)

**현재 호출 수**:
- Realtime: 200개 연결 (100명 × 2탭)
- 폴백 폴링: 40개 탭 × (3600초 / 3초) = **48,000회/시간**

**개선 후**:
- Realtime: 200개 연결 (변화 없음)
- 폴백 폴링: 40개 탭 × (3600초 / 15초) = **9,600회/시간** (80% 감소)
- Cache-Control + ETag: **추가 50-70% 감소** (중복 요청 흡수)

**예상 총 감소율**: **85-90%**

---

## 📝 결론

### 강점

1. ✅ **RLS 순환 참조 문제는 완전히 해결됨** (해결책의 5번 항목)
2. ✅ **Realtime 구독 및 폴백 폴링이 이미 구현되어 있음**
3. ✅ **Admin Supabase 사용으로 서버 측 최적화 완료**

### 개선 필요

1. 🔴 **폴링 주기 단축** (3초 → 10-20초)
2. 🔴 **Cache-Control + ETag/304 구현** (가장 큰 효과 예상)
3. 🟡 **가시성 기반 폴링 중지**
4. 🟡 **Edge Runtime 적용**

### 권장 실행 순서

1. **1단계 (오늘)**: Cache-Control + ETag/304 구현
2. **2단계 (오늘)**: 폴링 주기 상향 + 가시성 기반 중지
3. **3단계 (이번 주)**: Edge Runtime + 클라이언트 ETag 처리
4. **4단계 (선택)**: 멀티 탭 중복 제거, 가상 스크롤

---

## 🔍 추가 검토 사항

### 해결책.md의 제안 중 프로젝트에 맞지 않는 부분

1. **Edge Runtime 제한사항**:
   - Supabase Admin API는 Node.js 런타임에서만 사용 가능
   - Edge Runtime으로 변경 시 `createAdminSupabase()` 사용 불가
   - **대안**: 메시지 조회는 Edge로, 프로필 조회는 Node.js로 분리

2. **SSE(Server-Sent Events) 제안**:
   - 해결책에서 SSE를 폴백으로 제안했으나, 현재는 폴링으로 충분
   - Realtime 정상화가 우선, SSE는 나중에 검토

3. **경량 엔드포인트 제안**:
   - "새 메시지 여부만" 확인하는 엔드포인트는 ETag/304로 대체 가능
   - 별도 구현 불필요

---

## ✅ 최종 권고사항

**해결책.md는 전반적으로 타당하며, 특히 다음 항목들이 즉시 적용 가능하고 효과가 큽니다:**

1. ✅ **Cache-Control + ETag/304** (최우선)
2. ✅ **폴링 주기 상향** (최우선)
3. ✅ **가시성 기반 폴링 중지** (높은 우선순위)

**이미 해결된 항목:**
- ✅ RLS 순환 참조 문제 (완전히 해결됨)

**선택적 적용:**
- 🟡 멀티 탭 중복 제거
- 🟡 가상 스크롤
- 🟡 DB 인덱스 검증

**예상 효과**: 즉시 적용 항목만으로도 **85-90% 호출 수 감소** 예상
